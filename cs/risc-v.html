<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>𝑹𝑰𝑺𝑪-𝑽 基础 | suda-morris 个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <meta name="description" content="记录学习生活，探索未知领域">
    
    <link rel="preload" href="/blog/assets/css/0.styles.cf742985.css" as="style"><link rel="preload" href="/blog/assets/js/app.d7405291.js" as="script"><link rel="preload" href="/blog/assets/js/4.2f36c735.js" as="script"><link rel="preload" href="/blog/assets/js/3.33b3326e.js" as="script"><link rel="preload" href="/blog/assets/js/13.76028376.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.3de9bd5c.js"><link rel="prefetch" href="/blog/assets/js/11.34caa9e7.js"><link rel="prefetch" href="/blog/assets/js/12.f4c6c7a7.js"><link rel="prefetch" href="/blog/assets/js/14.eec1b969.js"><link rel="prefetch" href="/blog/assets/js/15.13ae6a22.js"><link rel="prefetch" href="/blog/assets/js/16.bc48b8f4.js"><link rel="prefetch" href="/blog/assets/js/17.3d6cc0d9.js"><link rel="prefetch" href="/blog/assets/js/18.d75fb595.js"><link rel="prefetch" href="/blog/assets/js/19.0b576da5.js"><link rel="prefetch" href="/blog/assets/js/2.695bf985.js"><link rel="prefetch" href="/blog/assets/js/20.96d0ac69.js"><link rel="prefetch" href="/blog/assets/js/21.171a353c.js"><link rel="prefetch" href="/blog/assets/js/22.06c655ee.js"><link rel="prefetch" href="/blog/assets/js/23.ae119573.js"><link rel="prefetch" href="/blog/assets/js/24.dfe8d3bd.js"><link rel="prefetch" href="/blog/assets/js/25.894c4895.js"><link rel="prefetch" href="/blog/assets/js/26.80135f62.js"><link rel="prefetch" href="/blog/assets/js/27.c658e4d1.js"><link rel="prefetch" href="/blog/assets/js/28.bdf811c1.js"><link rel="prefetch" href="/blog/assets/js/29.2ff774e4.js"><link rel="prefetch" href="/blog/assets/js/30.e5c0cf2d.js"><link rel="prefetch" href="/blog/assets/js/31.b4f0ae22.js"><link rel="prefetch" href="/blog/assets/js/32.d13ee5eb.js"><link rel="prefetch" href="/blog/assets/js/33.77005b03.js"><link rel="prefetch" href="/blog/assets/js/34.d50261dd.js"><link rel="prefetch" href="/blog/assets/js/35.d7e1adb2.js"><link rel="prefetch" href="/blog/assets/js/36.cc849002.js"><link rel="prefetch" href="/blog/assets/js/37.37163098.js"><link rel="prefetch" href="/blog/assets/js/38.26881c18.js"><link rel="prefetch" href="/blog/assets/js/39.66a2ad93.js"><link rel="prefetch" href="/blog/assets/js/40.029a1f57.js"><link rel="prefetch" href="/blog/assets/js/41.d548fa63.js"><link rel="prefetch" href="/blog/assets/js/42.ad242d53.js"><link rel="prefetch" href="/blog/assets/js/43.fc08918f.js"><link rel="prefetch" href="/blog/assets/js/44.9f9befdd.js"><link rel="prefetch" href="/blog/assets/js/45.88dfbeb1.js"><link rel="prefetch" href="/blog/assets/js/46.a0fb4727.js"><link rel="prefetch" href="/blog/assets/js/47.561f3da3.js"><link rel="prefetch" href="/blog/assets/js/48.7f298847.js"><link rel="prefetch" href="/blog/assets/js/49.21387529.js"><link rel="prefetch" href="/blog/assets/js/5.6ba77eeb.js"><link rel="prefetch" href="/blog/assets/js/50.32386339.js"><link rel="prefetch" href="/blog/assets/js/51.db8fdb8d.js"><link rel="prefetch" href="/blog/assets/js/52.924becdd.js"><link rel="prefetch" href="/blog/assets/js/53.ff2231ab.js"><link rel="prefetch" href="/blog/assets/js/54.17680303.js"><link rel="prefetch" href="/blog/assets/js/55.d05568f6.js"><link rel="prefetch" href="/blog/assets/js/56.dd278e68.js"><link rel="prefetch" href="/blog/assets/js/57.c809d30e.js"><link rel="prefetch" href="/blog/assets/js/58.2a3f0224.js"><link rel="prefetch" href="/blog/assets/js/59.1a6ff7e6.js"><link rel="prefetch" href="/blog/assets/js/6.b4117370.js"><link rel="prefetch" href="/blog/assets/js/60.6e2aae55.js"><link rel="prefetch" href="/blog/assets/js/61.885ead25.js"><link rel="prefetch" href="/blog/assets/js/62.1e3cd702.js"><link rel="prefetch" href="/blog/assets/js/63.e7d098ca.js"><link rel="prefetch" href="/blog/assets/js/64.11d3d64a.js"><link rel="prefetch" href="/blog/assets/js/65.d2aec3c5.js"><link rel="prefetch" href="/blog/assets/js/66.1a5a24a2.js"><link rel="prefetch" href="/blog/assets/js/67.d83818ea.js"><link rel="prefetch" href="/blog/assets/js/68.c348c996.js"><link rel="prefetch" href="/blog/assets/js/69.c0d13c96.js"><link rel="prefetch" href="/blog/assets/js/7.696ff3b0.js"><link rel="prefetch" href="/blog/assets/js/70.50eb200f.js"><link rel="prefetch" href="/blog/assets/js/71.b0eb799d.js"><link rel="prefetch" href="/blog/assets/js/72.cfecf2f3.js"><link rel="prefetch" href="/blog/assets/js/73.330d84bc.js"><link rel="prefetch" href="/blog/assets/js/74.1e9aa5bb.js"><link rel="prefetch" href="/blog/assets/js/75.c7770487.js"><link rel="prefetch" href="/blog/assets/js/76.3fdcfad9.js"><link rel="prefetch" href="/blog/assets/js/77.80ae42b4.js"><link rel="prefetch" href="/blog/assets/js/78.1dd945b4.js"><link rel="prefetch" href="/blog/assets/js/79.041861bf.js"><link rel="prefetch" href="/blog/assets/js/8.ab5db895.js"><link rel="prefetch" href="/blog/assets/js/80.07514afc.js"><link rel="prefetch" href="/blog/assets/js/81.418fb0ee.js"><link rel="prefetch" href="/blog/assets/js/82.67ca9605.js"><link rel="prefetch" href="/blog/assets/js/83.b602272e.js"><link rel="prefetch" href="/blog/assets/js/84.868dc7dd.js"><link rel="prefetch" href="/blog/assets/js/85.6e3bae9b.js"><link rel="prefetch" href="/blog/assets/js/86.2ad63f07.js"><link rel="prefetch" href="/blog/assets/js/87.b95790e2.js"><link rel="prefetch" href="/blog/assets/js/88.5748468a.js"><link rel="prefetch" href="/blog/assets/js/89.4cdd3327.js"><link rel="prefetch" href="/blog/assets/js/9.cebe12d9.js"><link rel="prefetch" href="/blog/assets/js/90.dc122952.js"><link rel="prefetch" href="/blog/assets/js/91.0d32c11e.js"><link rel="prefetch" href="/blog/assets/js/92.830b6926.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cf742985.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/cs/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/cs/bash.html" class="sidebar-link">𝙗𝙖𝙨𝙝 基础</a></li><li><a href="/blog/cs/bit_ops.html" class="sidebar-link">位运算技巧</a></li><li><a href="/blog/cs/cheat_sheet.html" class="sidebar-link">小抄</a></li><li><a href="/blog/cs/cmake.html" class="sidebar-link">𝘾𝙈𝙖𝙠𝙚 基础</a></li><li><a href="/blog/cs/computer_composition.html" class="sidebar-link">计算机组成原理</a></li><li><a href="/blog/cs/concurrent_programming.html" class="sidebar-link">并发编程</a></li><li><a href="/blog/cs/design_pattern.html" class="sidebar-link">设计模式 𝘾 语言描述</a></li><li><a href="/blog/cs/gcc_toolchains.html" class="sidebar-link">𝙂𝘾𝘾 工具链基础</a></li><li><a href="/blog/cs/git.html" class="sidebar-link">𝙂𝙞𝙩 基础</a></li><li><a href="/blog/cs/iptables.html" class="sidebar-link">防火墙 𝙞𝙥𝙩𝙖𝙗𝙡𝙚𝙨 基础</a></li><li><a href="/blog/cs/keras.html" class="sidebar-link">𝙆𝙚𝙧𝙖𝙨 基础</a></li><li><a href="/blog/cs/knowledge_map.html" class="sidebar-link">知识图谱</a></li><li><a href="/blog/cs/logistic_regression.html" class="sidebar-link">逻辑回归</a></li><li><a href="/blog/cs/lwip.html" class="sidebar-link">𝙇𝙬𝙄𝙋 基础</a></li><li><a href="/blog/cs/mbedtls.html" class="sidebar-link">𝙢𝙗𝙚𝙙𝙏𝙇𝙎 基础</a></li><li><a href="/blog/cs/python.html" class="sidebar-link">𝙋𝙮𝙩𝙝𝙤𝙣 基础</a></li><li><a href="/blog/cs/regular_expression.html" class="sidebar-link">正则表达式</a></li><li><a href="/blog/cs/risc-v.html" aria-current="page" class="active sidebar-link">𝑹𝑰𝑺𝑪-𝑽 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#risc-v-基础" class="sidebar-link">𝑹𝑰𝑺𝑪-𝑽 基础</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#单核-cpu-组成结构" class="sidebar-link">单核 CPU 组成结构</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#指令集划分" class="sidebar-link">指令集划分</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#基本指令集类型" class="sidebar-link">基本指令集类型</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#alu-的设计" class="sidebar-link">ALU 的设计</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#单指令周期-cpu" class="sidebar-link">单指令周期 CPU</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#流水线技术" class="sidebar-link">流水线技术</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#cache" class="sidebar-link">Cache</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#虚拟地址" class="sidebar-link">虚拟地址</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#通用寄存器组" class="sidebar-link">通用寄存器组</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#csr-寄存器组" class="sidebar-link">CSR 寄存器组</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#risc-v-的中断" class="sidebar-link">RISC-V 的中断</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#risc-v-架构的可扩展性" class="sidebar-link">RISC-V 架构的可扩展性</a></li><li class="sidebar-sub-header"><a href="/blog/cs/risc-v.html#常用伪指令" class="sidebar-link">常用伪指令</a></li></ul></li><li><a href="/blog/cs/scala.html" class="sidebar-link">𝙎𝙘𝙖𝙡𝙖 基础</a></li><li><a href="/blog/cs/think_in_code.html" class="sidebar-link">软件设计思想</a></li><li><a href="/blog/cs/xtensa.html" class="sidebar-link">𝙓𝙩𝙚𝙣𝙨𝙖 基础</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="risc-v-基础"><a href="#risc-v-基础" class="header-anchor">#</a> 𝑹𝑰𝑺𝑪-𝑽 基础</h2> <h2 id="单核-cpu-组成结构"><a href="#单核-cpu-组成结构" class="header-anchor">#</a> 单核 CPU 组成结构</h2> <p><img src="/blog/assets/img/riscv_alu.b4571647.png" alt="ALU"></p> <p><strong>数据通路</strong>是处理器中执行处理器所需操作的硬件部分，就像是处理器的四肢。</p> <p><strong>控制器</strong>是对数据通路要做什么操作进行行为调度的硬件结构，就像是处理器的大脑。</p> <p><img src="/blog/assets/img/riscv_data_path.75ca8e0f.png" alt="ALU"></p> <h2 id="指令集划分"><a href="#指令集划分" class="header-anchor">#</a> 指令集划分</h2> <table><thead><tr><th>基本指令集</th> <th>指令数</th> <th>描述</th></tr></thead> <tbody><tr><td>RV32I</td> <td>47</td> <td>32位地址空间与整数指令,支持32个通用整数寄存器</td></tr> <tr><td>RV32E</td> <td>47</td> <td>仅支持16个通用整数寄存器</td></tr> <tr><td>RV64I</td> <td>59</td> <td>64位地址空间与整数指令,以及一部分64位和32位的指令</td></tr> <tr><td>RV128I</td> <td>71</td> <td>128位地址空间与整数指令,以及一部分64位和32位的指令</td></tr></tbody></table> <table><thead><tr><th>扩展指令集</th> <th>指令数</th> <th>描述</th></tr></thead> <tbody><tr><td>M</td> <td>8</td> <td>整数乘法与除法指令</td></tr> <tr><td>A</td> <td>11</td> <td>存储器原子操作和Load-Reserved/Store-Conditional指令</td></tr> <tr><td>F</td> <td>26</td> <td>单精度(32bit)浮点指令</td></tr> <tr><td>D</td> <td>26</td> <td>双精度(32bit)浮点指令,必须支持F扩展指令</td></tr> <tr><td>C</td> <td>46</td> <td>压缩指令,指令长度为16位</td></tr></tbody></table> <h2 id="基本指令集类型"><a href="#基本指令集类型" class="header-anchor">#</a> 基本指令集类型</h2> <p><img src="/blog/assets/img/riscv_instruction_type.6459e601.png" alt="指令编码格式"></p> <h3 id="r-register-型指令"><a href="#r-register-型指令" class="header-anchor">#</a> R(Register)型指令</h3> <p><img src="/blog/assets/img/riscv_R_instruction.4f0a03ae.png" alt="R型指令"></p> <h4 id="指令汇编格式"><a href="#指令汇编格式" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="加法"><a href="#加法" class="header-anchor">#</a> 加法</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>add rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="减法"><a href="#减法" class="header-anchor">#</a> 减法</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sub rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="逻辑与"><a href="#逻辑与" class="header-anchor">#</a> 逻辑与</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>and rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="逻辑或"><a href="#逻辑或" class="header-anchor">#</a> 逻辑或</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>or rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="逻辑异或"><a href="#逻辑异或" class="header-anchor">#</a> 逻辑异或</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>xor rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="有符号小于比较"><a href="#有符号小于比较" class="header-anchor">#</a> 有符号小于比较</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>slt rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="无符号小于比较"><a href="#无符号小于比较" class="header-anchor">#</a> 无符号小于比较</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sltu rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="逻辑左移"><a href="#逻辑左移" class="header-anchor">#</a> 逻辑左移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sll rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="逻辑右移"><a href="#逻辑右移" class="header-anchor">#</a> 逻辑右移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>srl rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="算数右移"><a href="#算数右移" class="header-anchor">#</a> 算数右移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sra rd, rs1, rs2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="i-immediate-型指令"><a href="#i-immediate-型指令" class="header-anchor">#</a> I(Immediate)型指令</h3> <p><img src="/blog/assets/img/riscv_I_instruction.350f3bc5.png" alt="I型指令"></p> <h4 id="指令汇编格式-2"><a href="#指令汇编格式-2" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="立即数加法"><a href="#立即数加法" class="header-anchor">#</a> 立即数加法</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>addi rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数逻辑与"><a href="#立即数逻辑与" class="header-anchor">#</a> 立即数逻辑与</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>andi rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数逻辑或"><a href="#立即数逻辑或" class="header-anchor">#</a> 立即数逻辑或</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>ori rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数逻辑异或"><a href="#立即数逻辑异或" class="header-anchor">#</a> 立即数逻辑异或</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>xori rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数有符号小于比较"><a href="#立即数有符号小于比较" class="header-anchor">#</a> 立即数有符号小于比较</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>slti rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数无符号小于比较"><a href="#立即数无符号小于比较" class="header-anchor">#</a> 立即数无符号小于比较</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sltui rd, rs1, imm[11:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数逻辑左移"><a href="#立即数逻辑左移" class="header-anchor">#</a> 立即数逻辑左移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>slli rd, rs1, shamt[4:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数逻辑右移"><a href="#立即数逻辑右移" class="header-anchor">#</a> 立即数逻辑右移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>srli rd, rs1, shamt[4:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="立即数算数右移"><a href="#立即数算数右移" class="header-anchor">#</a> 立即数算数右移</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>srai rd, rs1, shamt[4:0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="load-store-指令"><a href="#load-store-指令" class="header-anchor">#</a> Load/Store 指令</h3> <p><img src="/blog/assets/img/riscv_load_store_instruction.9677a930.png" alt="Load/Store 指令"></p> <h4 id="指令汇编格式-3"><a href="#指令汇编格式-3" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="字加载"><a href="#字加载" class="header-anchor">#</a> 字加载</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lw rd, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="半字加载"><a href="#半字加载" class="header-anchor">#</a> 半字加载</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lh rd, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="无符号半字加载"><a href="#无符号半字加载" class="header-anchor">#</a> 无符号半字加载</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lhu rd, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="字节加载"><a href="#字节加载" class="header-anchor">#</a> 字节加载</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lb rd, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="无符号字节加载"><a href="#无符号字节加载" class="header-anchor">#</a> 无符号字节加载</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lbu rd, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="字存储"><a href="#字存储" class="header-anchor">#</a> 字存储</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sw rs2, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="半字存储"><a href="#半字存储" class="header-anchor">#</a> 半字存储</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sh rs2, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="字节存储"><a href="#字节存储" class="header-anchor">#</a> 字节存储</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>sb rs2, offset[11:0](rs1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="b-branch-型指令"><a href="#b-branch-型指令" class="header-anchor">#</a> B(Branch)型指令</h3> <p><img src="/blog/assets/img/riscv_B_instruction.768409cf.png" alt="B型指令"></p> <h4 id="指令汇编格式-4"><a href="#指令汇编格式-4" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="相等跳转"><a href="#相等跳转" class="header-anchor">#</a> 相等跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>beq rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="不等跳转"><a href="#不等跳转" class="header-anchor">#</a> 不等跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>bne rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="小于跳转"><a href="#小于跳转" class="header-anchor">#</a> 小于跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>blt rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="无符号小于跳转"><a href="#无符号小于跳转" class="header-anchor">#</a> 无符号小于跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>bltu rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="大于等于跳转"><a href="#大于等于跳转" class="header-anchor">#</a> 大于等于跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>bge rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="无符号大于等于跳转"><a href="#无符号大于等于跳转" class="header-anchor">#</a> 无符号大于等于跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>bgeu rs1, rs2, label
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="j-jump-型指令"><a href="#j-jump-型指令" class="header-anchor">#</a> J(Jump)型指令</h3> <p><img src="/blog/assets/img/riscv_jump_instruction.53be1f36.png" alt="J型指令"></p> <h4 id="指令汇编格式-5"><a href="#指令汇编格式-5" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="无条件跳转"><a href="#无条件跳转" class="header-anchor">#</a> 无条件跳转</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>jal rd, label # 将 PC+4 的值保存到 rd 寄存器中，然后设置 PC = PC + offset
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>伪指令 <code>j</code> 实际上就是jal指令的变体，此时 rd 会被设置为 x0,表示丢弃返回地址</p> <h5 id="无条件相对跳转-i-类型指令"><a href="#无条件相对跳转-i-类型指令" class="header-anchor">#</a> 无条件相对跳转 (I 类型指令)</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>jalr rd, rs1, imm # 将 PC+4 保存到 rd 寄存器中，然后设置 PC = rs1  + imm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>跳转到任意 32 位绝对地址处</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lui x1, &lt;hi20bits&gt;
jalr ra, x1, &lt;lo12bits&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>相对PC地址32位偏移量的相对跳转</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>auipc x1, &lt;hi20bits&gt;
jalr x0, x1, &lt;lo12bits&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="u-upper-immediate-型指令"><a href="#u-upper-immediate-型指令" class="header-anchor">#</a> U(Upper immediate)型指令</h3> <p><img src="/blog/assets/img/riscv_U_instruction.a6d4c422.png" alt="U型指令"></p> <h4 id="指令汇编格式-6"><a href="#指令汇编格式-6" class="header-anchor">#</a> 指令汇编格式</h4> <h5 id="lui-指令-load-upper-immediate"><a href="#lui-指令-load-upper-immediate" class="header-anchor">#</a> lui 指令 (Load Upper Immediate)</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lui rs, imm # 将 20 位的立即数左移12位，低 12 位补零，并写回寄存器 rd 中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>配合 addi 指令（设置低 12 比特）可实现讲寄存器设置为任意 32 比特的立即数，例如：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lui x10, 0x87654     # x10 = 0x87654000
addi x10, x10, 0x321 # x10 = 0x87654321
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是，当这个 12 位的立即数为负数（即最高比特位是1）时，得到的结果是高 20 位减 1 再和低 12 位拼接，比如：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>lui x10, 0xDEADB     # x10 = 0xDEADB000
addi x10, x10, 0xEEF # x10 = 0xDEADBEEF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解决这个问题的一种方法是，如果低 12 位的立即数的符号位是 1 ,那就预先给高 20 位的数加 1。<code>li</code> 伪指令可以替我们处理好这中特殊情况。</p> <h5 id="auipc-指令-add-upper-immediate-to-pc"><a href="#auipc-指令-add-upper-immediate-to-pc" class="header-anchor">#</a> auipc 指令 (Add Upper Immediate to PC)</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>auipc rd, imm # 将 20 位的立即数左移12位，低 12 位补零，将得到的 32 位数与 pc 的值相加，最后写回寄存器 rd 中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>具体应用有：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>Label: auipc x10, 0 # 将 Label 的地址保存在 x10 寄存器中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="alu-的设计"><a href="#alu-的设计" class="header-anchor">#</a> ALU 的设计</h2> <p><img src="/blog/assets/img/riscv_alu_design.d2271fee.png" alt="ALU设计框图"></p> <h3 id="加法运算的实现"><a href="#加法运算的实现" class="header-anchor">#</a> 加法运算的实现</h3> <div class="language-verilog line-numbers-mode"><pre class="language-verilog"><code><span class="token keyword">module</span> adder #<span class="token punctuation">(</span>
<span class="token keyword">parameter</span> N <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>
	<span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span>
	<span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span>
	<span class="token keyword">input</span>			  cin<span class="token punctuation">,</span>

	<span class="token keyword">output</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> sum<span class="token punctuation">,</span>
	<span class="token keyword">output</span> 			   cout
<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">assign</span> <span class="token operator">{</span>cout<span class="token punctuation">,</span> sum<span class="token operator">}</span> <span class="token operator">=</span> a <span class="token operator">+</span> b <span class="token operator">+</span> cin<span class="token punctuation">;</span>
<span class="token keyword">endmodule</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="减法运算的实现"><a href="#减法运算的实现" class="header-anchor">#</a> 减法运算的实现</h3> <div class="language-verilog line-numbers-mode"><pre class="language-verilog"><code><span class="token keyword">module</span> subtractor #<span class="token punctuation">(</span>
<span class="token keyword">parameter</span> N <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span>

    <span class="token keyword">output</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> y
<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> y <span class="token operator">=</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
<span class="token keyword">endmodule</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="比较运算的实现"><a href="#比较运算的实现" class="header-anchor">#</a> 比较运算的实现</h3> <h4 id="相等比较"><a href="#相等比较" class="header-anchor">#</a> 相等比较</h4> <p>用异或门检查 A 和 B 中对应的位是否相等</p> <h4 id="量值比较-减法"><a href="#量值比较-减法" class="header-anchor">#</a> 量值比较（减法）</h4> <p>首先计算A-B的值，然后检查结果的符号位</p> <div class="language-verilog line-numbers-mode"><pre class="language-verilog"><code><span class="token keyword">module</span> comparator #<span class="token punctuation">(</span>
<span class="token keyword">parameter</span> N <span class="token operator">=</span> <span class="token number">8</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">]</span> b

    <span class="token keyword">output</span> eq<span class="token punctuation">,</span>
    <span class="token keyword">output</span> neq<span class="token punctuation">,</span>
    <span class="token keyword">output</span> lt<span class="token punctuation">,</span>
    <span class="token keyword">output</span> lte<span class="token punctuation">,</span>
    <span class="token keyword">output</span> gt<span class="token punctuation">,</span>
    <span class="token keyword">output</span> gte
<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> eq <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> neq <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> lt <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> lte <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> gt <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> gte <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">endmodule</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="单指令周期-cpu"><a href="#单指令周期-cpu" class="header-anchor">#</a> 单指令周期 CPU</h2> <ul><li>指令周期：CPU 取出并执行一条指令所需的全部时间</li> <li>指令执行的的五个步骤
<ol><li>取指（Instruction Fetch）</li> <li>译码（Instruction Decode）</li> <li>执行（Execute）</li> <li>访存（Memory Access）</li> <li>写回（Write Back)</li></ol></li> <li>CPU周期：也称为机器周期，一个机器周期由若干个时钟周期组成</li> <li>CPI (Clock Cycle Per Instruction)：执行每条指令所需的时钟周期数的平均值</li> <li>单指令周期CPU：全部指令选用一个 CPU 周期完成的系统</li></ul> <p><img src="/blog/assets/img/single_instruction_CPU.5011d2a2.png" alt="单指令周期 CPU"></p> <h3 id="寄存器堆的实现"><a href="#寄存器堆的实现" class="header-anchor">#</a> 寄存器堆的实现</h3> <p><img src="/blog/assets/img/register_file.98edccb1.png" alt="寄存器堆"></p> <div class="language-verilog line-numbers-mode"><pre class="language-verilog"><code><span class="token keyword">module</span> <span class="token function">regfile</span><span class="token punctuation">(</span>rna<span class="token punctuation">,</span> rnb<span class="token punctuation">,</span> d<span class="token punctuation">,</span> wn<span class="token punctuation">,</span> we<span class="token punctuation">,</span> clk<span class="token punctuation">,</span> clrn<span class="token punctuation">,</span> qa<span class="token punctuation">,</span> qb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rna<span class="token punctuation">,</span> rnb<span class="token punctuation">,</span> wn<span class="token punctuation">;</span> <span class="token comment">// 读地址，写地址</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> d<span class="token punctuation">;</span> <span class="token comment">// 写数据</span>
    <span class="token keyword">input</span> we<span class="token punctuation">,</span> clk<span class="token punctuation">,</span> clrn<span class="token punctuation">;</span> <span class="token comment">// 写使能，时钟，清除信号</span>
    <span class="token keyword">output</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> qa<span class="token punctuation">,</span> qb<span class="token punctuation">;</span> <span class="token comment">// 读数据</span>

    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> register <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 31x32-bit regs</span>

    <span class="token comment">// 2 read ports</span>
    <span class="token keyword">assign</span> qa <span class="token operator">=</span> <span class="token punctuation">(</span>rna <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> register<span class="token punctuation">[</span>rna<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> qb <span class="token operator">=</span> <span class="token punctuation">(</span>rnb <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> register<span class="token punctuation">[</span>rnb<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 1 write port</span>
    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token keyword">posedge</span> clk <span class="token keyword">or</span> <span class="token keyword">negedge</span> clrn<span class="token punctuation">)</span>
        <span class="token function">if</span><span class="token punctuation">(</span>clrn <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
            <span class="token keyword">integer</span> i<span class="token punctuation">;</span>
            <span class="token function">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">32</span><span class="token punctuation">;</span>i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
                register<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wn <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> we<span class="token punctuation">)</span>
            register<span class="token punctuation">[</span>wn<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> d<span class="token punctuation">;</span>
<span class="token keyword">endmodule</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="完整的数据通路"><a href="#完整的数据通路" class="header-anchor">#</a> 完整的数据通路</h3> <p><img src="/blog/assets/img/riscv_full_data_path.2bd3abe3.png" alt="完整的数据通路"></p> <ul><li>译码阶段，会将指令的功能码和操作码发送给<strong>控制器</strong>，来产生相应的控制信号</li> <li>立即数扩展信号：ImmSel</li> <li>ALU 功能选择信号：ALUSel</li></ul> <h3 id="控制器的设计"><a href="#控制器的设计" class="header-anchor">#</a> 控制器的设计</h3> <p><img src="/blog/assets/img/riscv_cpu_controller_truth_table.9b41a36f.png" alt="控制器的设计"></p> <h3 id="r-型指令数据通路"><a href="#r-型指令数据通路" class="header-anchor">#</a> R 型指令数据通路</h3> <p><img src="/blog/assets/img/riscv_R_instruction_data_path.1c967b1f.png" alt="R型指令数据通路"></p> <ul><li><code>ALUSel</code> 会根据指令的 <code>funct3</code>来取不同的值</li></ul> <h3 id="i-型指令数据通路"><a href="#i-型指令数据通路" class="header-anchor">#</a> I 型指令数据通路</h3> <p><img src="/blog/assets/img/riscv_I_instruction_data_path.a793de42.png" alt="I型指令数据通路"></p> <h3 id="load-指令数据通路"><a href="#load-指令数据通路" class="header-anchor">#</a> Load 指令数据通路</h3> <p><img src="/blog/assets/img/riscv_load_instruction_data_path.994b1edd.png" alt="Load指令数据通路"></p> <h3 id="store-指令数据通路"><a href="#store-指令数据通路" class="header-anchor">#</a> Store 指令数据通路</h3> <p><img src="/blog/assets/img/riscv_store_instruction_data_path.104dac06.png" alt="Store指令数据通路"></p> <ul><li>立即数来自<code>inst[31:25][11:7]</code>，这个和Load不同</li> <li>Store指令没有<strong>写回</strong>阶段</li></ul> <h3 id="b-型指令数据通路"><a href="#b-型指令数据通路" class="header-anchor">#</a> B 型指令数据通路</h3> <p><img src="/blog/assets/img/riscv_B_instruction_data_path.d7c245a9.png" alt="B指令数据通路"></p> <ul><li>无<strong>访存</strong>和<strong>写回</strong>阶段</li></ul> <h3 id="jalr-指令数据通路"><a href="#jalr-指令数据通路" class="header-anchor">#</a> jalr 指令数据通路</h3> <p><img src="/blog/assets/img/riscv_jalr_instruction_data_path.f2b992fe.png" alt="jalr指令数据通路"></p> <ul><li>PC+4 的值会保存到<code>rd</code> 中</li></ul> <h3 id="jal-指令数据通路"><a href="#jal-指令数据通路" class="header-anchor">#</a> jal 指令数据通路</h3> <p><img src="/blog/assets/img/riscv_jal_instruction_data_path.b400a062.png" alt="jal指令数据通路"></p> <h2 id="流水线技术"><a href="#流水线技术" class="header-anchor">#</a> 流水线技术</h2> <p><img src="/blog/assets/img/riscv_pipeline.39941dc3.png" alt="流水线技术"></p> <h3 id="处理器性能公式"><a href="#处理器性能公式" class="header-anchor">#</a> 处理器性能公式</h3> <p></p><p><mjx-container jax="CHTML" display="true" class="MathJax"><mjx-math display="true" class="MJX-TEX"><mjx-mi class="mjx-i"><mjx-c c="P"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="o"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="g"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="a"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="m"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="T"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="i"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="m"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="e"></mjx-c></mjx-mi><mjx-mo space="4" class="mjx-n"><mjx-c c="="></mjx-c></mjx-mo><mjx-mfrac space="4"><mjx-frac type="d"><mjx-num><mjx-nstrut type="d"></mjx-nstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="I"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="n"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="t"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="u"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="c"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="t"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="i"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="o"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="n"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi></mjx-mrow></mjx-num><mjx-dbox><mjx-dtable><mjx-line type="d"></mjx-line><mjx-row><mjx-den><mjx-dstrut type="d"></mjx-dstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="P"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="o"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="g"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="a"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="m"></mjx-c></mjx-mi></mjx-mrow></mjx-den></mjx-row></mjx-dtable></mjx-dbox></mjx-frac></mjx-mfrac><mjx-mo space="3" class="mjx-n"><mjx-c c="2217"></mjx-c></mjx-mo><mjx-mfrac space="3"><mjx-frac type="d"><mjx-num><mjx-nstrut type="d"></mjx-nstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="y"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="c"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="l"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="e"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi></mjx-mrow></mjx-num><mjx-dbox><mjx-dtable><mjx-line type="d"></mjx-line><mjx-row><mjx-den><mjx-dstrut type="d"></mjx-dstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="I"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="n"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="t"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="r"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="u"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="c"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="t"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="i"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="o"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="n"></mjx-c></mjx-mi></mjx-mrow></mjx-den></mjx-row></mjx-dtable></mjx-dbox></mjx-frac></mjx-mfrac><mjx-mo space="3" class="mjx-n"><mjx-c c="2217"></mjx-c></mjx-mo><mjx-mfrac space="3"><mjx-frac type="d"><mjx-num><mjx-nstrut type="d"></mjx-nstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="T"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="i"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="m"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="e"></mjx-c></mjx-mi></mjx-mrow></mjx-num><mjx-dbox><mjx-dtable><mjx-line type="d"></mjx-line><mjx-row><mjx-den><mjx-dstrut type="d"></mjx-dstrut><mjx-mrow><mjx-mi class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="y"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="c"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="l"></mjx-c></mjx-mi><mjx-mi class="mjx-i"><mjx-c c="e"></mjx-c></mjx-mi></mjx-mrow></mjx-den></mjx-row></mjx-dtable></mjx-dbox></mjx-frac></mjx-mfrac></mjx-math></mjx-container></p><p></p> <h3 id="流水线阶段寄存器"><a href="#流水线阶段寄存器" class="header-anchor">#</a> 流水线阶段寄存器</h3> <p>为了确保硬件共享的时候，前一阶段的数据不被丢失，需要在流水线之间插入“阶段寄存器”来保存中间值和控制信号。</p> <p><img src="/blog/assets/img/riscv_pipeline_registers.7691b247.png" alt="流水线寄存器"></p> <h2 id="cache"><a href="#cache" class="header-anchor">#</a> Cache</h2> <p><img src="/blog/assets/img/riscv_cache.0010b661.png" alt="Cache"></p> <h3 id="cache-的结构"><a href="#cache-的结构" class="header-anchor">#</a> Cache 的结构</h3> <p><img src="/blog/assets/img/riscv_cache_structure.b3d3a365.png" alt="Cache的结构"></p> <ul><li>块（block）：两级存储器层次结构中存储器信息交换的最小单元</li> <li>命中（hit）：如果处理器需要的数据存放在高层存储器中的某个块中，称为一次命中</li> <li>缺失（miss）：如果在高层存储器中没有找到所需的数据，这次数据请求称为一次缺失
<ul><li>缺失代价（miss penalty）：将相应的块从底层存储器替换到高层存储器的时间+将该信息块传送给处理器的时间</li></ul></li></ul> <h3 id="cache-直接映射"><a href="#cache-直接映射" class="header-anchor">#</a> Cache 直接映射</h3> <p>直接映射：一种 cache 结构，其中每个存储器地址仅仅对应到 cache 中的一个位置</p> <p>映射方法：（块地址）mod（cache 中的块数）</p> <p>标记：表中的一个字段，包含了地址信息，这些地址信息可以用来判断cache中的字是否就是所请求的字</p> <p>有效位：表中的一个字段，用来标识一个块是否包含有一个有效数据</p> <p><img src="/blog/assets/img/riscv_cache_direct_mapping.a724b585.png" alt="Cache直接映射"></p> <p><img src="/blog/assets/img/riscv_cache_direct_mapping_example.1f5de907.png" alt="Cache直接映射示例"></p> <p>缺点：利用率低，命中率低</p> <h3 id="cache-全相联映射"><a href="#cache-全相联映射" class="header-anchor">#</a> Cache 全相联映射</h3> <p>全相联映射：一个块可以被放置在 cache 中的任何位置</p> <p><img src="/blog/assets/img/riscv_cache_full_association_mapping.50eaacf3.png" alt="Cache全相联映射"></p> <p><img src="/blog/assets/img/riscv_cache_full_association_mapping_example.c6b16b55.png" alt="Cache全相联映射示例"></p> <p>缺点：硬件开销大（有多少cache块就配有相等数量的比较器）</p> <h3 id="cache-组相联映射"><a href="#cache-组相联映射" class="header-anchor">#</a> Cache 组相联映射</h3> <p>在组相联映射中，每个块可被放置的位置数是固定的，每个块有 n 个位置可放的 cache 被称为 n 路组相联 Cache</p> <p><img src="/blog/assets/img/riscv_set_associative_cache.88e53b1f.png" alt="Cache组相联映射"></p> <p><img src="/blog/assets/img/riscv_set_associative_cache_example.90b50168.png" alt="Cache组相联映射示例"></p> <p>四路组相联 Cache：</p> <ul><li>4 个比较器</li> <li>1 个四选一多路选择器</li></ul> <h3 id="cache-的设计"><a href="#cache-的设计" class="header-anchor">#</a> Cache 的设计</h3> <ul><li>要考虑的维度
<ul><li>Cache 的容量</li> <li>块大小</li> <li>组织方式（Direct，Fully Associative，Set Associative）</li> <li>替换算法（FIFO，LRU）</li> <li>写策略（write-through, write-back）</li></ul></li></ul> <h2 id="虚拟地址"><a href="#虚拟地址" class="header-anchor">#</a> 虚拟地址</h2> <p><img src="/blog/assets/img/riscv_mmu.7262e30e.png" alt="虚拟存储器管理"></p> <h3 id="分段管理"><a href="#分段管理" class="header-anchor">#</a> 分段管理</h3> <p><img src="/blog/assets/img/riscv_mmu_segment_manage.fbbecfd3.png" alt="分段管理"></p> <p>分段管理：将一个程序按照逻辑单元分成多个程序段，每一个段使用自己单独的虚拟地址空间。</p> <ul><li>逻辑上相互独立</li> <li>容易实现共享和保护</li> <li>非常容易产生碎片（段长是不确定的）</li></ul> <h3 id="分页管理"><a href="#分页管理" class="header-anchor">#</a> 分页管理</h3> <p><img src="/blog/assets/img/riscv_mmu_page_manage.938e9249.png" alt="分页管理"></p> <ul><li>如果页表项为4字节，那么整张页表会占据4MB大小的内存空间</li></ul> <h3 id="两级分页管理"><a href="#两级分页管理" class="header-anchor">#</a> 两级分页管理</h3> <p><img src="/blog/assets/img/riscv_mmu_two_level_page_manage.5830951d.png" alt="两级分页管理"></p> <ul><li>4KB的页目录+4KB的页表</li></ul> <h3 id="快速地址转换-tlb"><a href="#快速地址转换-tlb" class="header-anchor">#</a> 快速地址转换 TLB</h3> <p><img src="/blog/assets/img/riscv_tlb.22e93fc6.png" alt="块表"></p> <p>块表（Translation-Lookaside Buffer）：用于记录最近使用地址的映射信息的高速缓存，从而可以避免每次都要访问页表</p> <h3 id="使用-tlb-进行地址转换"><a href="#使用-tlb-进行地址转换" class="header-anchor">#</a> 使用 TLB 进行地址转换</h3> <p><img src="/blog/assets/img/riscv_tlb_location.3998049f.png" alt="TLB的位置"></p> <p><img src="/blog/assets/img/riscv_tlb_translation.7a0bf91b.png" alt="TLB实现地址转换的原理"></p> <p><img src="/blog/assets/img/riscv_vma_pma_translation.4670166a.png" alt="TLB虚实地址转换"></p> <h2 id="通用寄存器组"><a href="#通用寄存器组" class="header-anchor">#</a> 通用寄存器组</h2> <table><thead><tr><th>寄存器</th> <th>ABI 名字</th> <th>描述</th> <th>Saver</th></tr></thead> <tbody><tr><td>x0</td> <td>zero</td> <td>硬件连线0</td> <td>-</td></tr> <tr><td>x1</td> <td>ra</td> <td>返回地址</td> <td>Caller</td></tr> <tr><td>x2</td> <td>sp</td> <td>栈指针</td> <td>Callee</td></tr> <tr><td>x3</td> <td>gp</td> <td>全局指针</td> <td>-</td></tr> <tr><td>x4</td> <td>tp</td> <td>线程指针</td> <td>-</td></tr> <tr><td>x5-x7</td> <td>t0-t2</td> <td>临时寄存器</td> <td>Caller</td></tr> <tr><td>x8</td> <td>s0/fp</td> <td>保存的寄存器/帧指针</td> <td>Callee</td></tr> <tr><td>x9</td> <td>s1</td> <td>保存寄存器<br>保存原进程中的关键数据，<br>避免在函数调用过程中被破坏</td> <td>Callee</td></tr> <tr><td>x10-x11</td> <td>a0-a1</td> <td>函数参数/返回值</td> <td>Caller</td></tr> <tr><td>x12-x17</td> <td>a2-a7</td> <td>函数参数</td> <td>Caller</td></tr> <tr><td>x18-x27</td> <td>s2-s11</td> <td>保存寄存器</td> <td>Callee</td></tr> <tr><td>x28-x31</td> <td>t3-t6</td> <td>临时寄存器</td> <td>Caller</td></tr></tbody></table> <h3 id="函数调用时保留的寄存器"><a href="#函数调用时保留的寄存器" class="header-anchor">#</a> 函数调用时保留的寄存器</h3> <p>被调用函数一般不会使用这些寄存器，即便使用也会提前保存好原值，可以信任。这些寄存器有：sp, gp, tp 和 s0-s11 寄存器。</p> <h3 id="函数调用时不保存的寄存器"><a href="#函数调用时不保存的寄存器" class="header-anchor">#</a> 函数调用时不保存的寄存器</h3> <p>有可能被调用函数使用更改，需要caller在调用前对自己用到的寄存器进行保存。这些寄存器有：参数与返回地址寄存器 a0-a7，返回地址寄存器 ra，临时寄存器 t0-t6</p> <h2 id="csr-寄存器组"><a href="#csr-寄存器组" class="header-anchor">#</a> CSR 寄存器组</h2> <h3 id="独立的12位地址编码空间"><a href="#独立的12位地址编码空间" class="header-anchor">#</a> 独立的12位地址编码空间</h3> <p><img src="/blog/assets/img/csr_register_encoding.43e73e84.png" alt="CSR寄存器访问指令的编码"></p> <h3 id="专用的-csr-指令读写-csr-寄存器"><a href="#专用的-csr-指令读写-csr-寄存器" class="header-anchor">#</a> 专用的 CSR 指令读写 CSR 寄存器</h3> <p><img src="/blog/assets/img/riscv_csr_register_access_instruction.f54ee67a.png" alt="CSR寄存器访问指令"></p> <h3 id="标准寄存器列表"><a href="#标准寄存器列表" class="header-anchor">#</a> 标准寄存器列表</h3> <h4 id="machine-mode"><a href="#machine-mode" class="header-anchor">#</a> Machine Mode</h4> <table><thead><tr><th>名称</th> <th>地址</th> <th>属性</th> <th>备注</th></tr></thead> <tbody><tr><td>mvendorid</td> <td>0xF11</td> <td>RO</td> <td>商业供应商编号寄存器</td></tr> <tr><td>marchid</td> <td>0xF12</td> <td>RO</td> <td>架构编号寄存器</td></tr> <tr><td>mimpid</td> <td>0xF13</td> <td>RO</td> <td>硬件实现编号寄存器</td></tr> <tr><td>mhartid</td> <td>0xF14</td> <td>RO</td> <td>Hart编号寄存器 (Hart: Hardware Thread)</td></tr> <tr><td>mstatus</td> <td>0x300</td> <td>RW</td> <td>异常处理状态寄存器</td></tr> <tr><td>misa</td> <td>0x301</td> <td>RO</td> <td>指令集架构寄存器</td></tr> <tr><td>mie</td> <td>0x304</td> <td>RW</td> <td>局部中断屏蔽控制寄存器</td></tr> <tr><td>mtvec</td> <td>0x305</td> <td>RW</td> <td>异常入口基地址寄存器</td></tr> <tr><td>mtvt</td> <td>0x307</td> <td>RW</td> <td>中断向量表的基地址，至少为 <strong>64byte</strong> 对齐</td></tr> <tr><td>mscratch</td> <td>0x340</td> <td>RW</td> <td>暂存寄存器，比如进入异常处理模式后，将应用程序的用户的 sp 寄存器临时保存到这个寄存器中</td></tr> <tr><td>mepc</td> <td>0x341</td> <td>RW</td> <td>异常PC寄存器</td></tr> <tr><td>mcause</td> <td>0x342</td> <td>RW</td> <td>异常原因寄存器</td></tr> <tr><td>mtval</td> <td>0x343</td> <td>RW</td> <td>异常值寄存器，保存进入异常之前出错指令的编码值或者存储器访问的地址值</td></tr> <tr><td>mip</td> <td>0x344</td> <td>RW</td> <td>中断等待寄存器</td></tr> <tr><td>mnxti</td> <td>0x345</td> <td>RW</td> <td>读操作返回值是下一个中断的handler地址，写回操作会更新中断使能的状态</td></tr> <tr><td>mintstatus</td> <td>0x346</td> <td>RO</td> <td>用于保存当前中断 Level</td></tr> <tr><td>mscratchcsw</td> <td>0x348</td> <td>RW</td> <td>用于在特权模式变化时交换mscratch与目的寄存器的值</td></tr> <tr><td>mscratchcswl</td> <td>0x349</td> <td>RW</td> <td>用于在中断Level变化时交换mscratch与目的寄存器的值</td></tr> <tr><td>mcycle</td> <td>0xB00</td> <td>RW</td> <td>周期计数器的低32位</td></tr> <tr><td>mcycleh</td> <td>0xB80</td> <td>RW</td> <td>周期计数器的高32位</td></tr> <tr><td>minstret</td> <td>0xB02</td> <td>RW</td> <td>完成指令计数器的低32位，该寄存器用于衡量处理器的性能</td></tr> <tr><td>minstrech</td> <td>0xB82</td> <td>RW</td> <td>完成指令计数器的高32位</td></tr></tbody></table> <h4 id="user-mode"><a href="#user-mode" class="header-anchor">#</a> User Mode</h4> <table><thead><tr><th>名称</th> <th>地址</th> <th>属性</th> <th>备注</th></tr></thead> <tbody><tr><td>cycle</td> <td>0xC00</td> <td>RO</td> <td>mcycle寄存器的只读副本</td></tr> <tr><td>time</td> <td>0xC01</td> <td>RO</td> <td>mtime寄存器的只读副本</td></tr> <tr><td>instret</td> <td>0xC02</td> <td>RO</td> <td>minstret寄存器的只读副本</td></tr> <tr><td>cycleh</td> <td>0xC80</td> <td>RO</td> <td>mcycleh寄存器的只读副本</td></tr> <tr><td>timeh</td> <td>0xC81</td> <td>RO</td> <td>mtimeh寄存器的只读副本</td></tr> <tr><td>instreth</td> <td>0xC82</td> <td>RO</td> <td>minstreth寄存器的只读副本</td></tr></tbody></table> <h2 id="risc-v-的中断"><a href="#risc-v-的中断" class="header-anchor">#</a> RISC-V 的中断</h2> <p><img src="/blog/assets/img/riscv_interrupt_enter.192ffaf5.png" alt="进入中断"></p> <p><img src="/blog/assets/img/riscv_interrupt_exit.16905898.png" alt="退出中断"></p> <h3 id="中断和异常相关的寄存器"><a href="#中断和异常相关的寄存器" class="header-anchor">#</a> 中断和异常相关的寄存器</h3> <p><img src="/blog/assets/img/riscv_exception_csr_registers.3be19f7b.png" alt="异常相关的CSR寄存器"></p> <p><img src="/blog/assets/img/riscv_exception_csr_register_definitions.7cb72969.png" alt="异常相关的CSR寄存器具体定义"></p> <h3 id="mstatus"><a href="#mstatus" class="header-anchor">#</a> mstatus</h3> <ul><li>MIE：为1表示中断的全局开关打开，中断能够被正常响应</li> <li>FS：维护浮点单元的状态。上电默认为0,表示Off，为了能够正常使用浮点单元，软件需要使用 CSR 写指令将 FS 的值改写为非 0 值以打开浮点单元的功能。操作系统在进行上下文切换的时候，需要通过该值来判断是否需要对浮点单元进行上下文的保存</li> <li>XS：维护用户自定义的扩展指令单元状态，类似与 FS</li></ul> <h3 id="mtvec"><a href="#mtvec" class="header-anchor">#</a> mtvec</h3> <p><img src="/blog/assets/img/riscv_exception_mtvec_register.bf624157.png" alt="mtvec寄存器"></p> <h3 id="异常代码"><a href="#异常代码" class="header-anchor">#</a> 异常代码</h3> <p><img src="/blog/assets/img/riscv_machine_exception_codes.ec2ed612.png" alt="异常代码"></p> <h3 id="中断返回"><a href="#中断返回" class="header-anchor">#</a> 中断返回</h3> <p><img src="/blog/assets/img/riscv_exception_return.65f3e1bd.png" alt="中断返回"></p> <h3 id="中断屏蔽与中断等待"><a href="#中断屏蔽与中断等待" class="header-anchor">#</a> 中断屏蔽与中断等待</h3> <p><img src="/blog/assets/img/riscv_interrupt_enable_pending.c4582d71.png" alt="中断屏蔽和等待相关额寄存器"></p> <h3 id="中断优先级"><a href="#中断优先级" class="header-anchor">#</a> 中断优先级</h3> <p><img src="/blog/assets/img/riscv_interrupt_priority.987e662d.png" alt="中断优先级"></p> <h3 id="单指令数据通路的中断响应与退出"><a href="#单指令数据通路的中断响应与退出" class="header-anchor">#</a> 单指令数据通路的中断响应与退出</h3> <p><img src="/blog/assets/img/riscv_one_cycle_intruction_interrupt_enter.10ae6c05.png" alt="中断响应"></p> <p><img src="/blog/assets/img/riscv_one_cycle_intruction_interrupt_exit.05a8d21c.png" alt="中断退出"></p> <h2 id="risc-v-架构的可扩展性"><a href="#risc-v-架构的可扩展性" class="header-anchor">#</a> RISC-V 架构的可扩展性</h2> <h3 id="指令集的扩展"><a href="#指令集的扩展" class="header-anchor">#</a> 指令集的扩展</h3> <p><img src="/blog/assets/img/riscv_isa_extension.6e965d57.png" alt="指令集扩展"></p> <h3 id="指令编码空间的扩展"><a href="#指令编码空间的扩展" class="header-anchor">#</a> 指令编码空间的扩展</h3> <p><img src="/blog/assets/img/riscv_isa_custom_instruction.47970635.png" alt="指令编码空间的扩展"></p> <ul><li>custom-0、custom-1用于 RV32 的自定义指令集扩展</li> <li>custom-2、custom-3预留给 RV128，也可以用于 RV32、RV64的用户自定义指令集扩展</li></ul> <h2 id="常用伪指令"><a href="#常用伪指令" class="header-anchor">#</a> 常用伪指令</h2> <h5 id="赋值指令"><a href="#赋值指令" class="header-anchor">#</a> 赋值指令</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>mv rd, rs # 等效于 addi rd, rs, x0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="加载立即数"><a href="#加载立即数" class="header-anchor">#</a> 加载立即数</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>li rd, 13 # 等效于 addi rd, x0, 13
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="函数调用和返回"><a href="#函数调用和返回" class="header-anchor">#</a> 函数调用和返回</h5> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>jal my_foo # 函数调用
ret # 函数返回，等效于 jr ra，等效于 jalr x0, ra, 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/cs/risc-v.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/7/16 15:29:05</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/cs/regular_expression.html" class="prev">
        正则表达式
      </a></span> <span class="next"><a href="/blog/cs/scala.html">
        𝙎𝙘𝙖𝙡𝙖 基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.d7405291.js" defer></script><script src="/blog/assets/js/4.2f36c735.js" defer></script><script src="/blog/assets/js/3.33b3326e.js" defer></script><script src="/blog/assets/js/13.76028376.js" defer></script>
  </body>
</html>
