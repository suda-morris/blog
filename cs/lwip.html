<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>𝙇𝙬𝙄𝙋 基础 | suda-morris 个人博客</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <meta name="description" content="记录学习生活，探索未知领域">
    <link rel="preload" href="/blog/assets/css/0.styles.91231688.css" as="style"><link rel="preload" href="/blog/assets/js/app.096a2661.js" as="script"><link rel="preload" href="/blog/assets/js/4.51d7be7e.js" as="script"><link rel="preload" href="/blog/assets/js/5.2b7e4836.js" as="script"><link rel="preload" href="/blog/assets/js/9.eb74a0e3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.3f2cfc8c.js"><link rel="prefetch" href="/blog/assets/js/11.ac4a8615.js"><link rel="prefetch" href="/blog/assets/js/12.1ea0fe59.js"><link rel="prefetch" href="/blog/assets/js/13.afce44b5.js"><link rel="prefetch" href="/blog/assets/js/14.c818e1d3.js"><link rel="prefetch" href="/blog/assets/js/15.ae2cecde.js"><link rel="prefetch" href="/blog/assets/js/16.7cf9847c.js"><link rel="prefetch" href="/blog/assets/js/17.ee83be60.js"><link rel="prefetch" href="/blog/assets/js/18.0bf2b7aa.js"><link rel="prefetch" href="/blog/assets/js/19.72ec98e5.js"><link rel="prefetch" href="/blog/assets/js/2.63bde253.js"><link rel="prefetch" href="/blog/assets/js/20.70479da1.js"><link rel="prefetch" href="/blog/assets/js/21.95f09eba.js"><link rel="prefetch" href="/blog/assets/js/22.ff6d4428.js"><link rel="prefetch" href="/blog/assets/js/23.e1071d8d.js"><link rel="prefetch" href="/blog/assets/js/24.2454f545.js"><link rel="prefetch" href="/blog/assets/js/25.a59865d6.js"><link rel="prefetch" href="/blog/assets/js/26.a0daf39b.js"><link rel="prefetch" href="/blog/assets/js/27.35f7d3e3.js"><link rel="prefetch" href="/blog/assets/js/28.a0caa67f.js"><link rel="prefetch" href="/blog/assets/js/29.d1b74259.js"><link rel="prefetch" href="/blog/assets/js/3.f3599ec0.js"><link rel="prefetch" href="/blog/assets/js/30.f7d1a2e0.js"><link rel="prefetch" href="/blog/assets/js/31.8813c0fd.js"><link rel="prefetch" href="/blog/assets/js/32.3aa7ef43.js"><link rel="prefetch" href="/blog/assets/js/33.e3f91143.js"><link rel="prefetch" href="/blog/assets/js/34.ac540d98.js"><link rel="prefetch" href="/blog/assets/js/35.151d88e0.js"><link rel="prefetch" href="/blog/assets/js/36.de5405c8.js"><link rel="prefetch" href="/blog/assets/js/37.3de5a648.js"><link rel="prefetch" href="/blog/assets/js/38.df2b0c6e.js"><link rel="prefetch" href="/blog/assets/js/39.1d2c721d.js"><link rel="prefetch" href="/blog/assets/js/40.b9a0c27c.js"><link rel="prefetch" href="/blog/assets/js/41.ce4019c7.js"><link rel="prefetch" href="/blog/assets/js/42.65282d20.js"><link rel="prefetch" href="/blog/assets/js/43.f32367bd.js"><link rel="prefetch" href="/blog/assets/js/44.e0c16e45.js"><link rel="prefetch" href="/blog/assets/js/45.3e3389ca.js"><link rel="prefetch" href="/blog/assets/js/46.d2135689.js"><link rel="prefetch" href="/blog/assets/js/47.5af79732.js"><link rel="prefetch" href="/blog/assets/js/48.9e30a325.js"><link rel="prefetch" href="/blog/assets/js/49.f51bf23a.js"><link rel="prefetch" href="/blog/assets/js/50.a191f302.js"><link rel="prefetch" href="/blog/assets/js/51.cb96a0e6.js"><link rel="prefetch" href="/blog/assets/js/52.2b384da1.js"><link rel="prefetch" href="/blog/assets/js/53.25023b26.js"><link rel="prefetch" href="/blog/assets/js/54.5dffb8be.js"><link rel="prefetch" href="/blog/assets/js/55.9fcf8b98.js"><link rel="prefetch" href="/blog/assets/js/56.9447c311.js"><link rel="prefetch" href="/blog/assets/js/57.0454486a.js"><link rel="prefetch" href="/blog/assets/js/58.f3589d9f.js"><link rel="prefetch" href="/blog/assets/js/59.62a3b67d.js"><link rel="prefetch" href="/blog/assets/js/6.7f8984f6.js"><link rel="prefetch" href="/blog/assets/js/60.ccda6e78.js"><link rel="prefetch" href="/blog/assets/js/61.05e307bd.js"><link rel="prefetch" href="/blog/assets/js/62.cb16958f.js"><link rel="prefetch" href="/blog/assets/js/63.bee425fe.js"><link rel="prefetch" href="/blog/assets/js/64.968279a8.js"><link rel="prefetch" href="/blog/assets/js/65.c161042f.js"><link rel="prefetch" href="/blog/assets/js/66.115dce63.js"><link rel="prefetch" href="/blog/assets/js/67.ecca5988.js"><link rel="prefetch" href="/blog/assets/js/68.a49f8a4f.js"><link rel="prefetch" href="/blog/assets/js/69.cfc28f06.js"><link rel="prefetch" href="/blog/assets/js/7.ac3b7d96.js"><link rel="prefetch" href="/blog/assets/js/70.af418843.js"><link rel="prefetch" href="/blog/assets/js/71.3da1e4bb.js"><link rel="prefetch" href="/blog/assets/js/72.4367cade.js"><link rel="prefetch" href="/blog/assets/js/73.08e9de76.js"><link rel="prefetch" href="/blog/assets/js/74.a2768707.js"><link rel="prefetch" href="/blog/assets/js/75.84431190.js"><link rel="prefetch" href="/blog/assets/js/76.cab30c37.js"><link rel="prefetch" href="/blog/assets/js/77.4a2ee29e.js"><link rel="prefetch" href="/blog/assets/js/78.22d3726c.js"><link rel="prefetch" href="/blog/assets/js/79.a042246e.js"><link rel="prefetch" href="/blog/assets/js/8.e299ad29.js"><link rel="prefetch" href="/blog/assets/js/80.b3765db2.js"><link rel="prefetch" href="/blog/assets/js/81.9e43a492.js"><link rel="prefetch" href="/blog/assets/js/82.aefc0f1d.js"><link rel="prefetch" href="/blog/assets/js/83.2030ec71.js"><link rel="prefetch" href="/blog/assets/js/84.972e1955.js"><link rel="prefetch" href="/blog/assets/js/85.6e59ab41.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.91231688.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://asciiflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ascii Flow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://repl.it/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Browser Based IDE (repl)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://qwerty.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Unicode Tools
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diagrams
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://explainshell.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Explain Shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.figma.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Figma
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://send.firefox.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  File Sharing
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.neat-reader.com/webapp#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Neat Reader
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Community" class="dropdown-title"><span class="title">Community</span> <span class="arrow down"></span></button> <button type="button" aria-label="Community" class="mobile-dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TUNA
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://goalkicker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GoalKicker Free Programming Books
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://asciiflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ascii Flow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://repl.it/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Browser Based IDE (repl)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://qwerty.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Unicode Tools
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diagrams
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://explainshell.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Explain Shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.figma.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Figma
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://send.firefox.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  File Sharing
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.neat-reader.com/webapp#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Neat Reader
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Community" class="dropdown-title"><span class="title">Community</span> <span class="arrow down"></span></button> <button type="button" aria-label="Community" class="mobile-dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TUNA
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://goalkicker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GoalKicker Free Programming Books
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/cs/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/cs/bash.html" class="sidebar-link">𝙗𝙖𝙨𝙝 基础</a></li><li><a href="/blog/cs/bit_ops.html" class="sidebar-link">位运算技巧</a></li><li><a href="/blog/cs/cheat_sheet.html" class="sidebar-link">小抄</a></li><li><a href="/blog/cs/cmake.html" class="sidebar-link">𝘾𝙈𝙖𝙠𝙚 基础</a></li><li><a href="/blog/cs/computer_composition.html" class="sidebar-link">计算机组成原理</a></li><li><a href="/blog/cs/concurrent_programming.html" class="sidebar-link">并发编程</a></li><li><a href="/blog/cs/design_pattern.html" class="sidebar-link">设计模式 𝘾 语言描述</a></li><li><a href="/blog/cs/gcc_toolchains.html" class="sidebar-link">𝙂𝘾𝘾 工具链基础</a></li><li><a href="/blog/cs/git.html" class="sidebar-link">𝙂𝙞𝙩 基础</a></li><li><a href="/blog/cs/iptables.html" class="sidebar-link">防火墙 𝙞𝙥𝙩𝙖𝙗𝙡𝙚𝙨 基础</a></li><li><a href="/blog/cs/keras.html" class="sidebar-link">𝙆𝙚𝙧𝙖𝙨 基础</a></li><li><a href="/blog/cs/knowledge_map.html" class="sidebar-link">知识图谱</a></li><li><a href="/blog/cs/logistic_regression.html" class="sidebar-link">逻辑回归</a></li><li><a href="/blog/cs/lwip.html" aria-current="page" class="active sidebar-link">𝙇𝙬𝙄𝙋 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#标准以太网数据帧格式" class="sidebar-link">标准以太网数据帧格式</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-的网络接口管理" class="sidebar-link">LwIP 的网络接口管理</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-的内存管理" class="sidebar-link">LwIP 的内存管理</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#网络数据包" class="sidebar-link">网络数据包</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#网卡接收数据的一般流程" class="sidebar-link">网卡接收数据的一般流程</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-内核超时处理" class="sidebar-link">LwIP 内核超时处理</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#tcpip-thread-线程" class="sidebar-link">tcpip_thread 线程</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-中的消息" class="sidebar-link">LwIP 中的消息</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#arp-协议" class="sidebar-link">ARP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ip-协议" class="sidebar-link">IP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#icmp-协议" class="sidebar-link">ICMP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#udp-协议" class="sidebar-link">UDP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#tcp-协议" class="sidebar-link">TCP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-的三种编程接口" class="sidebar-link">LwIP 的三种编程接口</a></li></ul></li><li><a href="/blog/cs/mbedtls.html" class="sidebar-link">𝙢𝙗𝙚𝙙𝙏𝙇𝙎 基础</a></li><li><a href="/blog/cs/risc-v.html" class="sidebar-link">𝑹𝑰𝑺𝑪-𝑽 基础</a></li><li><a href="/blog/cs/scala.html" class="sidebar-link">𝙎𝙘𝙖𝙡𝙖 基础</a></li><li><a href="/blog/cs/xtensa.html" class="sidebar-link">𝙓𝙩𝙚𝙣𝙨𝙖 基础</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lwip-基础"><a href="#lwip-基础" class="header-anchor">#</a> 𝙇𝙬𝙄𝙋 基础</h1> <p><img src="/blog/assets/img/tcp_ip_stack.13913b2b.png" alt="TCP/IP协议栈"></p> <h2 id="标准以太网数据帧格式"><a href="#标准以太网数据帧格式" class="header-anchor">#</a> 标准以太网数据帧格式</h2> <p><img src="/blog/assets/img/ethernet_frame.f4de10c4.png" alt="Ethernet_Frame"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>MAC 地址可以分成三类：</p> <ol><li>单播地址：第一个字节的 bit0 必须是 0</li> <li>组播地址：第一个字节的 bit- 必须是 1</li> <li>广播地址：FF-FF-FF-FF-FF-FF</li></ol></div> <h2 id="lwip-的网络接口管理"><a href="#lwip-的网络接口管理" class="header-anchor">#</a> LwIP 的网络接口管理</h2> <p>LwIP 使用 <strong>netif</strong> 结构体来描述硬件网络接口，并通过 <code>netif_add</code> 函数将其挂载到全局 <strong>netif 链表</strong>中。</p> <p><img src="/blog/assets/img/netif_list.73bfcf79.png" alt="网卡链表"></p> <h3 id="netif-结构体"><a href="#netif-结构体" class="header-anchor">#</a> netif 结构体</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* struct netif 用于描述不同类型的网卡，在网卡初始化方法中，用户需要指定如下成员：
** hwaddr_len, hwaddr[], mtu, flags
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 如果支持多网卡，则使用单向链表来管理同一设备的多个网卡 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_SINGLE_NETIF</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
    <span class="token comment">/* 网络字节序表示的 IPv4 地址，子网掩码，默认网关 */</span>
    ip_addr_t ip_addr<span class="token punctuation">;</span>
    ip_addr_t netmask<span class="token punctuation">;</span>
    ip_addr_t gw<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
    <span class="token comment">/* 数组保存多个 IPv6 地址 */</span>
    ip_addr_t ip6_addr<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* 每个 IPv6 地址的状态：临时的还是首选的 */</span>
    u8_t ip6_addr_state<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_ADDRESS_LIFETIMES</span></span>
    <span class="token comment">/* 每个 IPv6 地址的剩余有效时间以及总共有效时间，单位：秒 */</span>
    <span class="token comment">/* IP6_ADDR_LIFE_STATIC 表示这个地址是静态分配的 */</span>
    u32_t ip6_addr_valid_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32_t ip6_addr_pref_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
    <span class="token comment">/* 此函数由以太网设备驱动程序调用，将数据包传递给 TCP/IP 协议栈 */</span>
    <span class="token comment">/* 对于以太网设备，通常是 ethernet_input() */</span>
    netif_input_fn input<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
    <span class="token comment">/* 此函数由 IPv4 模块调用，该函数会解析得到硬件地址，然后发送数据包 */</span>
    <span class="token comment">/* 对于以太网设备，通常是 etharp_output() */</span>
    netif_output_fn output<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
    <span class="token comment">/* 此函数由 ARP 模块调用，用于实现在数据链路层发送数据 */</span>
    netif_linkoutput_fn linkoutput<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
    <span class="token comment">/* 此函数由 IPv6 模块调用，该函数会解析得到硬件地址，然后发送数据包 */</span>
    <span class="token comment">/* 对于以太网设备，通常是 ethip6_output() */</span>
    netif_output_ip6_fn output_ip6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_STATUS_CALLBACK</span></span>
    <span class="token comment">/* 当网卡状态设置为 up 或者 down 时，此函数会被调用 */</span>
    netif_status_callback_fn status_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_LINK_CALLBACK</span></span>
    <span class="token comment">/* 当网卡的数据链路设置为 up 或者 down 时，此函数会被调用 */</span>
    netif_status_callback_fn link_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_REMOVE_CALLBACK</span></span>
    <span class="token comment">/* 当网卡被移除时，此函数会被调用 */</span>
    netif_status_callback_fn remove_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_REMOVE_CALLBACK */</span></span>
    <span class="token comment">/* 用于将网卡的私有数据传递给上层 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">netif_get_client_data</span></span>
    <span class="token keyword">void</span> <span class="token operator">*</span>client_data<span class="token punctuation">[</span>LWIP_NETIF_CLIENT_DATA_INDEX_MAX <span class="token operator">+</span> LWIP_NUM_NETIF_CLIENT_DATA<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_HOSTNAME</span></span>
    <span class="token comment">/* 网卡的主机名，设置为 NULL 也合法 */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_HOSTNAME */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_CHECKSUM_CTRL_PER_NETIF</span></span>
    u16_t chksum_flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_CHECKSUM_CTRL_PER_NETIF*/</span></span>
    <span class="token comment">/* 最大传输单元（以字节为单位），对于以太网，一般设为 1500 */</span>
    <span class="token comment">/* IP 层会根据该字段来决定是否需要对数据包进行分片处理 */</span>
    u16_t mtu<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_ND6_ALLOW_RA_UPDATES</span></span>
    <span class="token comment">/* 最大传输单元（以字节为单位），由 RA 来更新 */</span>
    u16_t mtu6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span></span>
    <span class="token comment">/* 数据链路层的硬件地址 */</span>
    u8_t hwaddr<span class="token punctuation">[</span>NETIF_MAX_HWADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* 硬件地址长度，以太网是 6 字节 */</span>
    u8_t hwaddr_len<span class="token punctuation">;</span>
    <span class="token comment">/* 网卡状态信息标志位，包括网卡功能使能、广播使能、ARP 使能等 */</span>
    u8_t flags<span class="token punctuation">;</span>
    <span class="token comment">/* 网卡的名字，蓝牙设备的网卡名字可以使 bt，WLAN 设备的名字可以是 wl */</span>
    <span class="token comment">/* 如果网卡具有相同的名字，需要通过 num 字段来进一步区分 */</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* 网卡的标号，可用来标志同种类型的不同网卡 */</span>
    u8_t num<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_AUTOCONFIG</span></span>
    <span class="token comment">/* 是否使能 IPv6 自动配置 */</span>
    u8_t ip6_autoconfig_enabled<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_SEND_ROUTER_SOLICIT</span></span>
    <span class="token comment">/* 剩余待发送的路由请求消息的数量 */</span>
    u8_t rs_count<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_SEND_ROUTER_SOLICIT */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MIB2_STATS</span></span>
    <span class="token comment">/* 链路类型 */</span>
    u8_t link_type<span class="token punctuation">;</span>
    <span class="token comment">/* 预估的链路层速率 */</span>
    u32_t link_speed<span class="token punctuation">;</span>
    <span class="token comment">/* 最近一次链路层状态变化的时间（建立或者断开链接）*/</span>
    u32_t ts<span class="token punctuation">;</span>
    <span class="token comment">/* 计数器 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">stats_mib2_netif_ctrs</span> mib2_counters<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MIB2_STATS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4 <span class="token operator">&amp;&amp;</span> LWIP_IGMP</span></span>
    <span class="token comment">/* 可以调用此函数来向以太网 MAC 的组播过滤表中添加或删除条目 */</span>
    netif_igmp_mac_filter_fn igmp_mac_filter<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 &amp;&amp; LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_IPV6_MLD</span></span>
    <span class="token comment">/* 可以调用此函数来向以太网 MAC 的 IPv6 组播过滤表中添加或删除条目 */</span>
    netif_mld_mac_filter_fn mld_mac_filter<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_USE_HINTS</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">netif_hint</span> <span class="token operator">*</span>hints<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_USE_HINTS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK</span></span>
    <span class="token comment">/* 待发送给自己的数据包列表 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_first<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_last<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_LOOPBACK_MAX_PBUFS</span></span>
    u16_t loop_cnt_current<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_LOOPBACK_MAX_PBUFS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><h3 id="netif-add-函数"><a href="#netif-add-函数" class="header-anchor">#</a> netif_add 函数</h3> <p>在调用 <code>netif_add</code> 函数之前需要初始化主机的 IP 地址，子网掩码，网关等信息：</p> <p><code>IP4_ADDR(&amp;ipaddr,192,168,1,100)</code></p> <p><code>ip_addr_set_zero_ip4(&amp;ipaddr)</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * @brief 向 LwIP 中添加新的网卡
 *
 * @param netif：netif 结构体（调用函数之前需要为该结构体分配好内存）
 * @param ipaddr：该网卡的 IP 地址
 * @param netmask：该网卡的子网掩码
 * @param gw：该网卡的默认网关
 * @param state： 该网卡的私有数据（LwIP 无法得知该数据的具体含义）
 * @param init：初始化该网卡时的回调函数
 * @param input： 将数据包传递给 LwIP 上层协议的回调函数。如果没有操作系统，建议使用 netif_input，它会将数据包直接传给协议栈；如果有操作系统，建议使用 tcpip_input，它会向 TCPIP 线程发送一个通知。这两个函数会根据网卡的 NETIF_FLAG_ETHARP 和 NETIF_FLAG_ETHERNET 标志来决定将数据包转发给 ethernet_input 函数还是 ip_input 函数。
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span> <span class="token function">netif_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
          <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>netmask<span class="token punctuation">,</span> <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>gw<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
          <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">,</span> netif_init_fn init<span class="token punctuation">,</span> netif_input_fn input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  s8_t i<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SINGLE_NETIF</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif_default <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;single netif already set&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: invalid netif&quot;</span><span class="token punctuation">,</span> netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: No init function given&quot;</span><span class="token punctuation">,</span> init <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipaddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ipaddr <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netmask <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netmask <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gw <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gw <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* 清空网卡之前的 IP 地址，子网掩码，默认网关等字段的信息 */</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>output <span class="token operator">=</span> netif_null_output_ip4<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ip_addr_set_zero_ip6</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip6_addr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_INVALID<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_ADDRESS_LIFETIMES</span></span>
    netif<span class="token operator">-&gt;</span>ip6_addr_valid_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_pref_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span></span>
  <span class="token punctuation">}</span>
  netif<span class="token operator">-&gt;</span>output_ip6 <span class="token operator">=</span> netif_null_output_ip6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
  <span class="token function">NETIF_SET_CHECKSUM_CTRL</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> NETIF_CHECKSUM_ENABLE_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>mtu <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">netif_get_client_data</span></span>
  <span class="token function">memset</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NUM_NETIF_CLIENT_DATA */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_AUTOCONFIG</span></span>
  <span class="token comment">/* 默认不会自动配置 IPv6 地址 */</span>
  netif<span class="token operator">-&gt;</span>ip6_autoconfig_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span></span>
  <span class="token function">nd6_restart_netif</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_STATUS_CALLBACK</span></span>
  netif<span class="token operator">-&gt;</span>status_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_LINK_CALLBACK</span></span>
  netif<span class="token operator">-&gt;</span>link_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
  netif<span class="token operator">-&gt;</span>igmp_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_IPV6_MLD</span></span>
  netif<span class="token operator">-&gt;</span>mld_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK</span></span>
  netif<span class="token operator">-&gt;</span>loop_first <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>loop_last <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK */</span></span>

  <span class="token comment">/* 记录网卡的信息 */</span>
  netif<span class="token operator">-&gt;</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> netif_num<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>

  <span class="token function">NETIF_RESET_HINTS</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK <span class="token operator">&amp;&amp;</span> LWIP_LOOPBACK_MAX_PBUFS</span></span>
  netif<span class="token operator">-&gt;</span>loop_cnt_current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK &amp;&amp; LWIP_LOOPBACK_MAX_PBUFS */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token comment">/* 设置网卡的 IP 地址，子网掩码，默认网关 */</span>
  <span class="token function">netif_set_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ipaddr<span class="token punctuation">,</span> netmask<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>

  <span class="token comment">/* 调用用户自定义的网卡初始化函数 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span> <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_ND6_ALLOW_RA_UPDATES</span></span>
  <span class="token comment">/* Initialize the MTU for IPv6 to the one set by the netif driver.
     This can be updated later by RA. */</span>
  netif<span class="token operator">-&gt;</span>mtu6 <span class="token operator">=</span> netif<span class="token operator">-&gt;</span>mtu<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span></span>

<span class="token comment">/* 为当前网卡确定唯一的 num */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_SINGLE_NETIF</span></span>
  <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num_netifs<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      num_netifs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>netif2 <span class="token operator">=</span> netif_list<span class="token punctuation">;</span> netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> netif2 <span class="token operator">=</span> netif2<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;netif already added&quot;</span><span class="token punctuation">,</span> netif2 <span class="token operator">!=</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_netifs<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;too many netifs, max. supported number is 255&quot;</span><span class="token punctuation">,</span> num_netifs <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>netif2<span class="token operator">-&gt;</span>num <span class="token operator">==</span> netif<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          netif<span class="token operator">-&gt;</span>num<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">254</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token punctuation">(</span>u8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* 将当前网卡插入到全局的 netif_list 链表中，插入方式：头插 */</span>
  netif<span class="token operator">-&gt;</span>next <span class="token operator">=</span> netif_list<span class="token punctuation">;</span>
  netif_list <span class="token operator">=</span> netif<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* &quot;LWIP_SINGLE_NETIF */</span></span>
  <span class="token function">mib2_netif_added</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
  <span class="token comment">/* IGMP 开始工作 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> NETIF_FLAG_IGMP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">igmp_start</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;netif: added interface %c%c IP&quot;</span><span class="token punctuation">,</span>
                            netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; addr &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; netmask &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; gw &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">netif_invoke_ext_callback</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> LWIP_NSC_NETIF_ADDED<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> netif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br></div></div><h3 id="初始化-lwip-的一般流程"><a href="#初始化-lwip-的一般流程" class="header-anchor">#</a> 初始化 LwIP 的一般流程</h3> <p><img src="/blog/assets/img/setup_lwip.c67664dc.png" alt="初始化 LwIP"></p> <h2 id="lwip-的内存管理"><a href="#lwip-的内存管理" class="header-anchor">#</a> LwIP 的内存管理</h2> <p>LwIP 的内存管理机制大致上可以分成三种：</p> <ol><li>C 标准库自带的内存分配策略（即使用 malloc、free等函数，这些函数的<strong>执行时间是不确定的</strong>）</li> <li>LwIP 的<strong>动态内存堆</strong>分配策略</li> <li>LwIP 的<strong>动态内存池</strong>分配策略</li></ol> <div class="custom-block tip"><p class="custom-block-title">LwIP 使用动态内存池的原因</p> <p>LwIP 中有很多固定的数据结构空间，比如 TCP 首部，UDP 首部，IP 首部，Ethernet 首部等。采用内存池策略分配这些固定大小的内存空间，可以大大提升效率，还不会产生内存碎片。</p></div> <h3 id="动态内存池"><a href="#动态内存池" class="header-anchor">#</a> 动态内存池</h3> <h4 id="lwip-mempool"><a href="#lwip-mempool" class="header-anchor">#</a> LWIP_MEMPOOL</h4> <p>在 LwIP 内核初始化时，会根据具体配置在内存中初始化相应的内存池，如定义了 <code>LWIP_UDP</code>，在初始化的时候， UDP 协议控制块需要的内存池就会被初始化。<code>lwip/priv/memp_std.h</code> 中使用 <code>LWIP_MEMPOOL</code> 宏定义了许多数据，但是这些数据的具体含义要取决于具体的 <code>LWIP_MEMPOOL</code> 。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * A list of internal pools used by LWIP.
 *
 * LWIP_MEMPOOL(pool_name, number_elements, element_size, pool_description)
 *     creates a pool name MEMP_pool_name. description is used in stats.c
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_RAW</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>RAW_PCB<span class="token punctuation">,</span>        MEMP_NUM_RAW_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;RAW_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_RAW */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_UDP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>UDP_PCB<span class="token punctuation">,</span>        MEMP_NUM_UDP_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;UDP_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_UDP */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_PCB<span class="token punctuation">,</span>        MEMP_NUM_TCP_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;TCP_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_PCB_LISTEN<span class="token punctuation">,</span> MEMP_NUM_TCP_PCB_LISTEN<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_pcb_listen</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;TCP_PCB_LISTEN&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_SEG<span class="token punctuation">,</span>        MEMP_NUM_TCP_SEG<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_seg</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;TCP_SEG&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>IGMP_GROUP<span class="token punctuation">,</span>     MEMP_NUM_IGMP_GROUP<span class="token punctuation">,</span>      <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">igmp_group</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token string">&quot;IGMP_GROUP&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>

<span class="token comment">/*
 * A list of pools of pbuf's used by LWIP.
 *
 * LWIP_PBUF_MEMPOOL(pool_name, number_elements, pbuf_payload_size, pool_description)
 *     creates a pool name MEMP_pool_name. description is used in stats.c
 *     This allocates enough space for the pbuf struct and a payload.
 *     (Example: pbuf_payload_size=0 allocates only size for the struct)
 */</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>PBUF<span class="token punctuation">,</span>           MEMP_NUM_PBUF<span class="token punctuation">,</span>            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token string">&quot;PBUF_REF/ROM&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_PBUF_MEMPOOL</span><span class="token punctuation">(</span>PBUF_POOL<span class="token punctuation">,</span> PBUF_POOL_SIZE<span class="token punctuation">,</span>           PBUF_POOL_BUFSIZE<span class="token punctuation">,</span>             <span class="token string">&quot;PBUF_POOL&quot;</span><span class="token punctuation">)</span>


<span class="token comment">/*
 * Allow for user-defined pools; this must be explicitly set in lwipopts.h
 * since the default is to NOT look for lwippools.h
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MEMP_USE_CUSTOM_POOLS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwippools.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MEMP_USE_CUSTOM_POOLS */</span></span>

<span class="token comment">/*
 * REQUIRED CLEANUP: Clear up so we don't get &quot;multiply defined&quot; error later
 * (#undef is ignored for something that is not defined)
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MEMPOOL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL_START</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_PBUF_MEMPOOL</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="定义内存池类型"><a href="#定义内存池类型" class="header-anchor">#</a> 定义内存池类型</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** Create the list of all memory pools managed by memp. MEMP_MAX represents a NULL pool at the end */</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span>  MEMP_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">,</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>
  MEMP_MAX
<span class="token punctuation">}</span> memp_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="声明内存池"><a href="#声明内存池" class="header-anchor">#</a> 声明内存池</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span> <span class="token function">LWIP_MEMPOOL_DECLARE</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span><span class="token keyword">const</span> memp_pools<span class="token punctuation">[</span>MEMP_MAX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span> <span class="token operator">&amp;</span>memp_ </span><span class="token punctuation">##</span> <span class="token expression">name<span class="token punctuation">,</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>每种内存池经过编译器编译都会得到一个结构体，比如<code>const struct memp_desc memp_RAW_PCB</code>，里面记录了内存块的数量，大小，起始地址等信息。</p> <h4 id="内存池初始化"><a href="#内存池初始化" class="header-anchor">#</a> 内存池初始化</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Initializes lwIP built-in pools.
 * Related functions: memp_malloc, memp_free
 *
 * Carves out memp_memory into linked lists for each pool-type.
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  u16_t i<span class="token punctuation">;</span>

  <span class="token comment">/* for every pool: */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">LWIP_ARRAYSIZE</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">memp_init_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * Initialize custom memory pool.
 * Related functions: memp_malloc_pool, memp_free_pool
 *
 * @param desc pool to initialize
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_init_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>

  <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN</span><span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* force memset on pool memory */</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>memp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>desc<span class="token operator">-&gt;</span>num <span class="token operator">*</span> <span class="token punctuation">(</span>MEMP_SIZE <span class="token operator">+</span> desc<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* create a linked list of memp elements */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> desc<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memp<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span>
    <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token punctuation">;</span>
    <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
    memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>memp <span class="token operator">+</span> MEMP_SIZE <span class="token operator">+</span> desc<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><img src="/blog/assets/img/lwip_memp.1fc0c568.png" alt="内存池初始化"></p> <h4 id="内存分配"><a href="#内存分配" class="header-anchor">#</a> 内存分配</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Get an element from a specific pool.
 *
 * @param type the pool to get an element from
 *
 * @return a pointer to the allocated memory or a NULL pointer on error
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memp_malloc</span><span class="token punctuation">(</span>memp_t type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: type &lt; MEMP_MAX&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> MEMP_MAX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp <span class="token operator">=</span> <span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> memp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * Get an element from a custom pool.
 *
 * @param desc the pool to get an element from
 *
 * @return a pointer to the allocated memory or a NULL pointer on error
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memp_malloc_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid pool desc&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">SYS_ARCH_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span> <span class="token comment">// 得到对应内存块中的第一个空闲内存块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>memp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span> <span class="token comment">// 移动tab指针，指向下一个空闲内存块</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: memp properly aligned&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>memp <span class="token operator">%</span> MEM_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* cast through u8_t* to get rid of alignment warnings */</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>memp <span class="token operator">+</span> MEMP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEMP_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: out of memory in pool %s\n&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h4 id="内存释放"><a href="#内存释放" class="header-anchor">#</a> 内存释放</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">SYS_ARCH_DECL_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;memp_free: mem properly aligned&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>mem <span class="token operator">%</span> MEM_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
  memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">-</span> MEMP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">SYS_ARCH_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span>
  <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token punctuation">;</span>

  <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Put a custom pool element back into its pool.
 *
 * @param desc the pool where to put mem
 * @param mem the memp element to free
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_free_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid pool desc&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>desc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Put an element back into its pool.
 *
 * @param type the pool where to put mem
 * @param mem the memp element to free
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_free</span><span class="token punctuation">(</span>memp_t type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;memp_free: type &lt; MEMP_MAX&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> MEMP_MAX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="动态内存堆"><a href="#动态内存堆" class="header-anchor">#</a> 动态内存堆</h3> <p>LwIP 中的动态内存堆管理可以分为两种：一种是 C 标准库自带的内存管理策略，另一种是 LwIP 自身实现的内存堆管理策略。这两者的选择需要通过 <code>MEM_LIBC_MALLOC</code> 宏来选择。</p> <h4 id="内存堆的组织结构"><a href="#内存堆的组织结构" class="header-anchor">#</a> 内存堆的组织结构</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * The heap is made up as a list of structs of this type.
 * This does not have to be aligned since for getting its size,
 * we only use the macro SIZEOF_STRUCT_MEM, which automatically aligns.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token punctuation">{</span>
  <span class="token comment">/** index (-&gt; ram[next]) of the next struct */</span>
  mem_size_t next<span class="token punctuation">;</span>
  <span class="token comment">/** index (-&gt; ram[prev]) of the previous struct */</span>
  mem_size_t prev<span class="token punctuation">;</span>
  <span class="token comment">/** 1: this area is used; 0: this area is unused */</span>
  u8_t used<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MEM_OVERFLOW_CHECK</span></span>
  <span class="token comment">/** this keeps track of the user allocation size for guard checks */</span>
  mem_size_t user_size<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** All allocated blocks will be MIN_SIZE bytes big, at least!
 * MIN_SIZE can be overridden to suit your needs. Smaller values save space,
 * larger values could prevent too small blocks to fragment the RAM too much. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MIN_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">MIN_SIZE             <span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MIN_SIZE */</span></span>

<span class="token comment">/** the heap. we need one struct mem at the end and some room for alignment */</span>
<span class="token function">LWIP_DECLARE_MEMORY_ALIGNED</span><span class="token punctuation">(</span>ram_heap<span class="token punctuation">,</span> MEM_SIZE_ALIGNED <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2U</span> <span class="token operator">*</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">LWIP_RAM_HEAP_POINTER ram_heap</span></span>

<span class="token comment">/** pointer to the heap (ram_heap): for alignment, ram is now a pointer instead of an array */</span>
<span class="token keyword">static</span> u8_t <span class="token operator">*</span>ram<span class="token punctuation">;</span>
<span class="token comment">/** the last entry, always unused! */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>ram_end<span class="token punctuation">;</span>

<span class="token comment">/** pointer to the lowest free block, this is used for faster search */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span> LWIP_MEM_LFREE_VOLATILE lfree<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="内存堆初始化"><a href="#内存堆初始化" class="header-anchor">#</a> 内存堆初始化</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Zero the heap and initialize start, end and lowest-free
 */</span>
<span class="token keyword">void</span> <span class="token function">mem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;Sanity check alignment&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span>SIZEOF_STRUCT_MEM <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* align the heap */</span>
  ram <span class="token operator">=</span> <span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN</span><span class="token punctuation">(</span>LWIP_RAM_HEAP_POINTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* initialize the start of the heap */</span>
  mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ram<span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>next <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* initialize the end of the heap */</span>
  ram_end <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>next <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* initialize the lowest-free pointer to the start of the heap */</span>
  lfree <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ram<span class="token punctuation">;</span>

  <span class="token function">MEM_STATS_AVAIL</span><span class="token punctuation">(</span>avail<span class="token punctuation">,</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sys_mutex_new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span> <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create mem_mutex&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="/blog/assets/img/lwip_heap.1ac8ef3c.png" alt="内存堆初始化"></p> <h4 id="内存分配-2"><a href="#内存分配-2" class="header-anchor">#</a> 内存分配</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Allocate a block of memory with a minimum of 'size' bytes.
 *
 * @param size_in is the minimum size of the requested block in bytes.
 * @return pointer to allocated memory or NULL if no free memory was found.
 *
 * Note that the returned value will always be aligned (as defined by MEM_ALIGNMENT).
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mem_malloc</span><span class="token punctuation">(</span>mem_size_t size_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  mem_size_t ptr<span class="token punctuation">,</span> ptr2<span class="token punctuation">,</span> size<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">,</span> <span class="token operator">*</span>mem2<span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_DECL_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size_in <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* 将用户申请的内存大小进行对齐操作 */</span>
  size <span class="token operator">=</span> <span class="token punctuation">(</span>mem_size_t<span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN_SIZE</span><span class="token punctuation">(</span>size_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MIN_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* every data block must be at least MIN_SIZE_ALIGNED long */</span>
    size <span class="token operator">=</span> MIN_SIZE_ALIGNED<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> size_in<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* 互斥访问 */</span>
  <span class="token function">sys_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 遍历空闲内存块链表，直到找到第一个合适的内存块 */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">mem_to_ptr</span><span class="token punctuation">(</span>lfree<span class="token punctuation">)</span><span class="token punctuation">;</span> ptr <span class="token operator">&lt;</span> MEM_SIZE_ALIGNED <span class="token operator">-</span> size<span class="token punctuation">;</span>
         ptr <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mem <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>mem<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 内存块可能很大，判断是否需要切开 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> MIN_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ptr2 <span class="token operator">=</span> <span class="token punctuation">(</span>mem_size_t<span class="token punctuation">)</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid next ptr&quot;</span><span class="token punctuation">,</span>ptr2 <span class="token operator">!=</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* create mem2 struct */</span>
          mem2 <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>next <span class="token operator">=</span> mem<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
          <span class="token comment">/* and insert it between mem and mem-&gt;next */</span>
          mem<span class="token operator">-&gt;</span>next <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
          mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem2<span class="token operator">-&gt;</span>next <span class="token operator">!=</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>mem2<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token operator">-&gt;</span>prev <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">MEM_STATS_INC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token function">MEM_STATS_INC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token function">mem_to_ptr</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> lfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>cur <span class="token operator">=</span> lfree<span class="token punctuation">;</span>
          <span class="token comment">/* Find next free block after mem and update lowest free pointer */</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>used <span class="token operator">&amp;&amp;</span> cur <span class="token operator">!=</span> ram_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cur <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          lfree <span class="token operator">=</span> cur<span class="token punctuation">;</span>
          <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: !lfree-&gt;used&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lfree <span class="token operator">==</span> ram_end<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>lfree<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LWIP_MEM_ALLOC_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: allocated memory not above ram_end.&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> size <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>ram_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: allocated memory properly aligned.&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span> <span class="token operator">%</span> MEM_ALIGNMENT <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: sanity check alignment&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> MEM_SANITY_OFFSET<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token function">MEM_STATS_INC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sys_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: could not allocate %&quot;</span>S16_F<span class="token string">&quot; bytes\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>s16_t<span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h4 id="内存释放-2"><a href="#内存释放-2" class="header-anchor">#</a> 内存释放</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Put a struct mem back on the heap
 *
 * @param rmem is the data portion of a struct mem as returned by a previous
 *             call to mem_malloc()
 */</span>
<span class="token keyword">void</span> <span class="token function">mem_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>rmem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_FREE_DECL_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rmem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free(p == NULL) was called.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mem_ptr_t<span class="token punctuation">)</span>rmem<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: sanity check alignment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: sanity check alignment\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Get the corresponding struct mem: */</span>
  <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
  mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>rmem <span class="token operator">-</span> <span class="token punctuation">(</span>SIZEOF_STRUCT_MEM <span class="token operator">+</span> MEM_SANITY_OFFSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">&lt;</span> ram <span class="token operator">||</span> <span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>rmem <span class="token operator">+</span> MIN_SIZE_ALIGNED <span class="token operator">&gt;</span> <span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>ram_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* protect the heap from concurrent access */</span>
  <span class="token function">LWIP_MEM_FREE_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* mem has to be in a used state */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: double free&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: double free?\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* 检查内存块在链表中的连接是否正常 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mem_link_valid</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: non-linked: double free&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: non-linked: double free?\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* mem is now unused. */</span>
  mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">&lt;</span> lfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* the newly freed struct is now the lowest */</span>
    lfree <span class="token operator">=</span> mem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">MEM_STATS_DEC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span>mem_size_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">-</span> ram<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 尝试进行内存块合并（只要新释放的内存块与上一个或者下一个空闲内存块在地址上是连续的，则进行合并 */</span>
  <span class="token function">plug_holes</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h3 id="lwip-中关于内存管理的配置"><a href="#lwip-中关于内存管理的配置" class="header-anchor">#</a> LwIP 中关于内存管理的配置</h3> <table><thead><tr><th>宏配置</th> <th>说明</th></tr></thead> <tbody><tr><td>MEM_LIBC_MALLOC</td> <td>设置为 1 表示使用 C 标准库自带的分配策略；设置为 0 表示使用 LwIP 自己实现的动态内存管理策略。LwIP 的动态内存管理策略又分为两种实现形式：一种通过内存堆（HEAP）管理策略实现内存管理（大数组），另一种通过内存池（POOL）管理策略实现内存管理（事先开辟好的内存池）</td></tr> <tr><td>MEMP_MEM_MALLOC</td> <td>是否使用 LwIP 内存堆分配策略实现内存池分配（从内存池中获取内存时，实际是从内存堆中分配）</td></tr> <tr><td>MEM_USE_POOLS</td> <td>是否使用 LwIP 内存池分配策略实现内存堆的分配（从内存堆中获取内存时，实际是从内存池中分配）</td></tr></tbody></table> <h2 id="网络数据包"><a href="#网络数据包" class="header-anchor">#</a> 网络数据包</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>LwIP 极力避免在层与层之间进行数据拷贝，所以并没有采取很明确的分层结构，各层之间的部分数据在其它层是可见的，各层之间存在交叉存取数据的现象。</p></div> <h3 id="pbuf-结构体"><a href="#pbuf-结构体" class="header-anchor">#</a> pbuf 结构体</h3> <p><strong>pbuf</strong> 是一个描述协议栈中数据包的数据结构。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** Main packet buffer struct */</span>
<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token punctuation">{</span>
  <span class="token comment">/** 网络中的数据包可能很大，所以采用链表的形式将所有 pbuf 包连接起来，构成一个完整的数据包 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment">/** 指向实际数据区域 */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>payload<span class="token punctuation">;</span>
  <span class="token comment">/** 当前 pbuf 及其后续 pbuf 所有数据的长度
   *  如果当前是链表上的第一个pbuf，则记录着整个 pbuf 链表中所有的pbuf中的数据长度
   */</span>
  u16_t tot_len<span class="token punctuation">;</span>
  <span class="token comment">/** 当前pbuf中有效的数据长度 */</span>
  u16_t len<span class="token punctuation">;</span>
  <span class="token comment">/** pbuf的类型
    */</span>
  u8_t type_internal<span class="token punctuation">;</span>
  <span class="token comment">/** misc flags */</span>
  u8_t flags<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 当前 pbuf 的引用计数，初始化一个 pbuf 的时候，会将其设置为1；当有其它指针指向当前pbuf的时候会加1
   */</span>
  LWIP_PBUF_REF_T ref<span class="token punctuation">;</span>
  <span class="token comment">/** 记录传入的数据包中netif的索引，也就是netif中的num字段 */</span>
  u8_t if_idx<span class="token punctuation">;</span>
  <span class="token comment">/** In case the user needs to store data custom data on a pbuf */</span>
  LWIP_PBUF_CUSTOM_DATA
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="pbuf-的类型"><a href="#pbuf-的类型" class="header-anchor">#</a> pbuf 的类型</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
  <span class="token comment">/** pbuf data is stored in RAM, used for TX mostly, struct pbuf and its payload
      are allocated in one piece of contiguous memory (so the first payload byte
      can be calculated from struct pbuf).
      pbuf_alloc() allocates PBUF_RAM pbufs as unchained pbufs (although that might
      change in future versions).
      This should be used for all OUTGOING packets (TX).*/</span>
  PBUF_RAM <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_ALLOC_FLAG_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_FLAG_STRUCT_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_HEAP<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/** pbuf data is stored in ROM, i.e. struct pbuf and its payload are located in
      totally different memory areas. Since it points to ROM, payload does not
      have to be copied when queued for transmission. */</span>
  PBUF_ROM <span class="token operator">=</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF<span class="token punctuation">,</span>
  <span class="token comment">/** pbuf comes from the pbuf pool. Much like PBUF_ROM but payload might change
      so it has to be duplicated when queued before transmitting, depending on
      who has a 'ref' to it. */</span>
  PBUF_REF <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_TYPE_FLAG_DATA_VOLATILE <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/** pbuf payload refers to RAM. This one comes from a pool and should be used
      for RX. Payload can be chained (scatter-gather RX) but like PBUF_RAM, struct
      pbuf and its payload are allocated in one piece of contiguous memory (so
      the first payload byte can be calculated from struct pbuf).
      Don't use this for TX, if the pool becomes empty e.g. because of TCP queuing,
      you are unable to receive TCP acks! */</span>
  PBUF_POOL <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_ALLOC_FLAG_RX <span class="token operator">|</span> PBUF_TYPE_FLAG_STRUCT_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF_POOL<span class="token punctuation">)</span>
<span class="token punctuation">}</span> pbuf_type<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="pbuf-ram-类型的-pbuf"><a href="#pbuf-ram-类型的-pbuf" class="header-anchor">#</a> PBUF_RAM 类型的 pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_ram.408a7517.png" alt="PBUF_RAM类型的 pbuf"></p> <p>PBUF_RAM 类型的 pbuf 是通过内存堆分配得到，是一个连续的内存区域，其中的 layer(offset) 就是各层协议的首部，比如 TCP 报文首部、IP 首部、以太网帧首部等。LwIP 协议栈中的发送数据包都会采用这种形式。</p> <h4 id="pbuf-pool-类型的-pbuf"><a href="#pbuf-pool-类型的-pbuf" class="header-anchor">#</a> PBUF_POOL 类型的 pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_pool.e9801004.png" alt="PBUF_POOL类型的 pbuf"></p> <p>PBUF_POOL 类型的 pbuf 是通过内存池分配得到，与 PBUF_RAM 类似，其 pbuf 结构体与数据缓冲区也是存在于连续的内存块中。这种类型的 pbuf 可以快速完成分配，在网卡接收数据时，LwIP 一般就使用这种类型的 pbuf 来存储接收到的数据。</p> <h4 id="pbuf-rom-和-pbuf-ref-类型的-pbuf"><a href="#pbuf-rom-和-pbuf-ref-类型的-pbuf" class="header-anchor">#</a> PBUF_ROM 和 PBUF_REF 类型的 pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_rom_ref.64893f56.png" alt="PBUF_ROM 和 PBUF_REF 类型的 pbuf"></p> <p>PBUF_REF 和 PBUF_ROM 类型的 pbuf 基本相同，它们都是从内存池中申请分配 pbuf 结构首部空间，而不申请数据区的空间。两者的区别在于，前者指向 RAM 空间内的某段数据，后者指向 ROM 空间内的某段数据。</p> <h3 id="各层协议首部大小"><a href="#各层协议首部大小" class="header-anchor">#</a> 各层协议首部大小</h3> <p>不同的协议其首部大小是不同的，申请 pbuf 时，协议栈中各层首部的大小都会被预留出来，LwIP 采用枚举变量记录各层的首部大小。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
  <span class="token comment">/** Includes spare room for transport layer header, e.g. UDP header.
   * Use this if you intend to pass the pbuf to functions like udp_send().
   */</span>
  PBUF_TRANSPORT <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN <span class="token operator">+</span> PBUF_IP_HLEN <span class="token operator">+</span> PBUF_TRANSPORT_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for IP header.
   * Use this if you intend to pass the pbuf to functions like raw_send().
   */</span>
  PBUF_IP <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN <span class="token operator">+</span> PBUF_IP_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for link layer header (ethernet header).
   * Use this if you intend to pass the pbuf to functions like ethernet_output().
   * @see PBUF_LINK_HLEN
   */</span>
  PBUF_LINK <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for additional encapsulation header before ethernet
   * headers (e.g. 802.11).
   * Use this if you intend to pass the pbuf to functions like netif-&gt;linkoutput().
   * @see PBUF_LINK_ENCAPSULATION_HLEN
   */</span>
  PBUF_RAW_TX <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Use this for input packets in a netif driver when calling netif-&gt;input()
   * in the most common case - ethernet-layer netif driver. */</span>
  PBUF_RAW <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span> pbuf_layer<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="pbuf-相关-api"><a href="#pbuf-相关-api" class="header-anchor">#</a> pbuf 相关 API</h3> <table><thead><tr><th>API</th> <th>说明</th></tr></thead> <tbody><tr><td>pbuf_alloc</td> <td>申请 pbuf 数据包。</td></tr> <tr><td>pbuf_realloc</td> <td>在 pbuf 尾部释放一定的空间，将数据包 pbuf 中的数据长度<strong>减少</strong>为某个长度值。</td></tr> <tr><td>pbuf_ref</td> <td>增加 pbuf 的引用计数。</td></tr> <tr><td>pbuf_free</td> <td>释放 pbuf 数据包。</td></tr> <tr><td>pbuf_clen</td> <td>返回 pbuf 链中的 pbuf 数量。</td></tr> <tr><td>pbuf_cat</td> <td>将两个 pbuf 链接在一起（但不会改变末尾 pbuf 链的引用计数）。</td></tr> <tr><td>pbuf_chain</td> <td>将两个 pbuf 链接在一起（增减尾链的引用计数）。</td></tr> <tr><td>pbuf_dechain</td> <td>缉拿个第一个 pbuf 与链中后续的 pbuf 断开连接。</td></tr> <tr><td>pbuf_header</td> <td>调整 pbuf 的 payload 指针（向前或向后移动一定字节数），这为各层对数据包首部的操作提供了方便，进行这个操作的时候，len 和 tot_len 字段值也会随之更新。</td></tr> <tr><td>pbuf_copy_partial</td> <td>将部分 pbuf 中的内容复制到缓存中。</td></tr> <tr><td>pbuf_take</td> <td>将用户数据复制到 pbuf 中。</td></tr> <tr><td>pbuf_coalesce</td> <td>从一个 pbuf 队列中创建单个 pbuf。</td></tr> <tr><td>pbuf_memcmp</td> <td>将指定偏移地址处的 pbuf 内容与其它内存比较</td></tr> <tr><td>pbuf_memfind</td> <td>从某个偏移地址开始，在 pbuf 中查找某内存</td></tr> <tr><td>pbuf_strstr</td> <td>从某个偏移地址开始，在 pbuf 中查找某字符串</td></tr> <tr><td>pbuf_copy</td> <td>将任何类型的 pbuf 中的数据拷贝到一个 PBUF_RAM 类型的 pbuf 中。</td></tr></tbody></table> <h4 id="pbuf-alloc-函数"><a href="#pbuf-alloc-函数" class="header-anchor">#</a> pbuf_alloc 函数</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>数据包申请函数有两个重要的参数：数据包 pbuf 的类型和数据包在哪一层被申请。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>pbuf_layer layer<span class="token punctuation">,</span> u16_t length<span class="token punctuation">,</span> pbuf_type type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <p>假设 TCP 协议需要申请一个 pbuf 数据包，则调用如下函数创建 pbuf：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_TRANSPORT<span class="token punctuation">,</span> <span class="token number">1472</span><span class="token punctuation">,</span> PBUF_RAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>内核会分配一个 PBUF_RAM 类型的 pbuf， 其数据区域大小是 1472 字节，并且因为是在传输层，所以内核需要预留 54 字节空间（以太网首部14字节，IPv4首部20字节，TCP首部20字节）。当数据报往下层递交的时候，其它层直接填充对应的协议首部即可。</p> <h4 id="pbuf-free-函数"><a href="#pbuf-free-函数" class="header-anchor">#</a> pbuf_free 函数</h4> <p>在申请 pbuf 的时候，ref 字段就被初始化为1,当释放 pbuf 的时候，先将 ref 减 1,如果 ref 减 1 后为 0,则表示能释放 pbuf 数据包。</p> <ul><li>假设有 4 个 pbuf 链表如下</li></ul> <p><img src="/blog/assets/img/lwip_pbuf_free_0.f2634715.png" alt="初始时的 pbuf 链表"></p> <ul><li>删除第一个节点后的 pbuf 链表如下</li></ul> <p><img src="/blog/assets/img/lwip_pbuf_free_1.33781abf.png" alt="删除第一个节点后的 pbuf 链表"></p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>传递给 pbuf_free() 的参数必须是链表头指针。</p></div> <h2 id="网卡接收数据的一般流程"><a href="#网卡接收数据的一般流程" class="header-anchor">#</a> 网卡接收数据的一般流程</h2> <p><img src="/blog/assets/img/lwip_packets_into_core.85a67ff6.png" alt="网卡数据传入 LwIP 内核"></p> <h2 id="lwip-内核超时处理"><a href="#lwip-内核超时处理" class="header-anchor">#</a> LwIP 内核超时处理</h2> <p>LwIP 中很多时候都需要超时处理，例如 ARP 缓存表的内容的时间管理、IP 分片数据报的重装等待超时、TCP 中的建立连接超时、重传超时机制等等。LwIP 采用软件定时器对这些超时进行处理，移植的时候需要提供一个较为准确的时基。</p> <h3 id="sys-timeo-结构体"><a href="#sys-timeo-结构体" class="header-anchor">#</a> sys_timeo 结构体</h3> <p>LwIP 通过一个 sys_timeo 类型的数据结构管理与超时链表相关的所有超时事件。LwIP 使用这个结构体记录下内核中所有被注册的超时事件，这些结构体会以链表的形式一个个连接在超时链表中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">// 下一个超时事件</span>
  u32_t time<span class="token punctuation">;</span> 			  <span class="token comment">// 发生超时的时间</span>
  sys_timeout_handler h<span class="token punctuation">;</span>  <span class="token comment">// 超时的回调函数</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>              <span class="token comment">// 向回调函数传入的参数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** The one and only timeout list */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>next_timeout<span class="token punctuation">;</span> <span class="token comment">// 指向超时链表的第一个超时事件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="注册超时事件"><a href="#注册超时事件" class="header-anchor">#</a> 注册超时事件</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">sys_timeout</span><span class="token punctuation">(</span>u32_t msecs<span class="token punctuation">,</span> sys_timeout_handler handler<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  u32_t next_timeout_time<span class="token punctuation">;</span>
  next_timeout_time <span class="token operator">=</span> <span class="token punctuation">(</span>u32_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">sys_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> msecs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 根据当前时间计算超时时间</span>
  <span class="token function">sys_timeout_abs</span><span class="token punctuation">(</span>next_timeout_time<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sys_timeout_abs</span><span class="token punctuation">(</span>u32_t abs_time<span class="token punctuation">,</span> sys_timeout_handler handler<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>timeout<span class="token punctuation">,</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>

  timeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">memp_malloc</span><span class="token punctuation">(</span>MEMP_SYS_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>h <span class="token operator">=</span> handler<span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>time <span class="token operator">=</span> abs_time<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>next_timeout <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next_timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据超时事件的时间，升序排列</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TIME_LESS_THAN</span><span class="token punctuation">(</span>timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">,</span> next_timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> next_timeout<span class="token punctuation">;</span>
    next_timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> next_timeout<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">TIME_LESS_THAN</span><span class="token punctuation">(</span>timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> t<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="lwip-内部使用的循环超时事件"><a href="#lwip-内部使用的循环超时事件" class="header-anchor">#</a> LwIP 内部使用的循环超时事件</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** This struct contains information about a stack-internal timer function
 that has to be called at a defined interval */</span>
<span class="token keyword">struct</span> <span class="token class-name">lwip_cyclic_timer</span> <span class="token punctuation">{</span>
  u32_t interval_ms<span class="token punctuation">;</span>
  lwip_cyclic_timer_handler handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">lwip_cyclic_timer</span> lwip_cyclic_timers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/* The TCP timer is a special case: it does not have to run always and
     is triggered to start from TCP using tcp_timer_needed() */</span>
  <span class="token punctuation">{</span>TCP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>tcp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">IP_REASSEMBLY</span></span>
  <span class="token punctuation">{</span>IP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>ip_reass_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* IP_REASSEMBLY */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_ARP</span></span>
  <span class="token punctuation">{</span>ARP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>etharp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ESP_GRATUITOUS_ARP</span></span>
  <span class="token punctuation">{</span>GARP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>garp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ESP_GRATUITOUS_ARP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_ARP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP</span></span>
  <span class="token punctuation">{</span>DHCP_COARSE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp_coarse_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>DHCP_FINE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp_fine_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_DHCP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ESP_DHCPS_TIMER</span></span>
  <span class="token punctuation">{</span>DHCP_COARSE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcps_coarse_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_AUTOIP</span></span>
  <span class="token punctuation">{</span>AUTOIP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>autoip_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_AUTOIP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ESP_LWIP_IGMP_TIMERS_ONDEMAND</span></span>
  <span class="token punctuation">{</span>IGMP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>igmp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DNS</span></span>
  <span class="token punctuation">{</span>DNS_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dns_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_DNS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  <span class="token punctuation">{</span>ND6_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>nd6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_REASS</span></span>
  <span class="token punctuation">{</span>IP6_REASS_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>ip6_reass_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_REASS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_MLD <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ESP_LWIP_MLD6_TIMERS_ONDEMAND</span></span>
  <span class="token punctuation">{</span>MLD6_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>mld6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_DHCP6</span></span>
  <span class="token punctuation">{</span>DHCP6_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_DHCP6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><img src="/blog/assets/img/lwip_timeouts_list.51042adb.png" alt="超时链表"></p> <h2 id="tcpip-thread-线程"><a href="#tcpip-thread-线程" class="header-anchor">#</a> tcpip_thread 线程</h2> <ul><li>标准 TCP/IP 协议栈的各个层次都独立成为一个线程，在这种模式下，各个层次有着严格的分层结构，各个层次的 API 接口也是分层清晰的。但是数据包在向其它层递交的时候，都需要进行拷贝以及切换线程，这是一个很大的开销，会导致系统没法处理大量的数据。</li> <li>协议栈可以驻留在操作系统内核中，应用程序通过系统调用与 TCP/IP 协议栈通信。这种情况让协议栈各层之间与用户线程没有很严格的分层结构，各层之间能交叉存取，从而提高效率。</li> <li>LwIP 让协议栈内核与操作系统相互隔离，协议栈仅仅作为操作系统的一个独立线程存在，用户程序能驻留在协议栈内部，协议栈通过回调函数实现用户与协议栈之间的数据交互；也可以让用户程序单独实现一个线程，通过信号量和邮箱等机制与协议栈线程通信。</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tcpip_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcpip_msg</span> <span class="token operator">*</span>msg<span class="token punctuation">;</span>
  <span class="token function">LWIP_UNUSED_ARG</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LWIP_MARK_TCPIP_THREAD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LOCK_TCPIP_CORE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tcpip_init_done <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">tcpip_init_done</span><span class="token punctuation">(</span>tcpip_init_done_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_TCPIP_THREAD_ALIVE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 等待消息，并且处理超时事件 */</span>
    <span class="token comment">// #define TCPIP_MBOX_FETCH(mbox, msg) tcpip_timeouts_mbox_fetch(mbox, msg)</span>
    <span class="token function">TCPIP_MBOX_FETCH</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcpip_mbox<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>TCPIP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;tcpip_thread: invalid message: NULL\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;tcpip_thread: invalid message&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 等待到消息，对消息进行处理</span>
    <span class="token function">tcpip_thread_handle_msg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="lwip-中的消息"><a href="#lwip-中的消息" class="header-anchor">#</a> LwIP 中的消息</h2> <h3 id="消息结构"><a href="#消息结构" class="header-anchor">#</a> 消息结构</h3> <p>tcpip_thread 线程是通过 <code>tcpip_msg</code> 描述消息的，tcpip_thread 线程接收到消息后，根据消息的类型进行不同的处理。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">enum</span> <span class="token class-name">tcpip_msg_type</span> <span class="token punctuation">{</span>
  TCPIP_MSG_API<span class="token punctuation">,</span>
  TCPIP_MSG_API_CALL<span class="token punctuation">,</span>    	<span class="token comment">// API 函数调用</span>
  TCPIP_MSG_INPKT<span class="token punctuation">,</span>			<span class="token comment">// 底层数据包输入</span>
  TCPIP_MSG_TIMEOUT<span class="token punctuation">,</span>		<span class="token comment">// 注册超时事件</span>
  TCPIP_MSG_UNTIMEOUT<span class="token punctuation">,</span>		<span class="token comment">// 删除超时事件</span>
  TCPIP_MSG_CALLBACK<span class="token punctuation">,</span>
  TCPIP_MSG_CALLBACK_STATIC	<span class="token comment">// 执行回调函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">tcpip_msg</span> <span class="token punctuation">{</span>
  <span class="token keyword">enum</span> <span class="token class-name">tcpip_msg_type</span> type<span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_callback_fn function<span class="token punctuation">;</span>	<span class="token comment">// 内核执行的 API 函数</span>
      <span class="token keyword">void</span><span class="token operator">*</span> msg<span class="token punctuation">;</span>					<span class="token comment">// 执行函数时候的参数，记录在 api_msg 中</span>
    <span class="token punctuation">}</span> api_msg<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_api_call_fn function<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> <span class="token class-name">tcpip_api_call_data</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
      sys_sem_t <span class="token operator">*</span>sem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> api_call<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>				<span class="token comment">// 指向接收到的数据包</span>
      <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>			<span class="token comment">// 接收到数据包的网卡</span>
      netif_input_fn input_fn<span class="token punctuation">;</span>		<span class="token comment">// 输入的函数接口</span>
    <span class="token punctuation">}</span> inp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_callback_fn function<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      u32_t msecs<span class="token punctuation">;</span>					<span class="token comment">// 超时的时间</span>
      sys_timeout_handler h<span class="token punctuation">;</span>		<span class="token comment">// 超时回调函数</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> tmo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="数据包消息"><a href="#数据包消息" class="header-anchor">#</a> 数据包消息</h3> <p><img src="/blog/assets/img/lwip_packet_message.217126c7.png" alt="packet 消息处理生命周期"></p> <h3 id="api-消息"><a href="#api-消息" class="header-anchor">#</a> API 消息</h3> <p>用户使用 NETCONN API 接口时，LwIP 会将对应 API 函数与参数构造成消息传递到 tcpip_thread 线程中，然后根据对应的 API 函数执行对应的操作。用户的应用线程与内核也是相互独立的，依赖操作系统的 IPC 通信机制进行数据交互与同步（邮箱、信号量等）。</p> <p><img src="/blog/assets/img/lwip_api_message.6f551817.png" alt="API 消息生命周期"></p> <h2 id="arp-协议"><a href="#arp-协议" class="header-anchor">#</a> ARP 协议</h2> <p>ARP 协议是 TCP/IP 协议的基础，通过解析 IP 地址得到数据链路层的地址。ARP 协议的核心是 ARP 缓存表，而ARP 协议的实质就是对缓存表的建立、更新、查询等操作。ARP 缓存表是由若干缓存表项组成，在 LwIP 中，描述缓存表项的数据结构叫 <code>etharp_entry</code>。</p> <p><img src="/blog/assets/img/arp_protocol.6e6dab0f.png" alt="ARP协议数据包格式"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Hardware Type：值 1 表示以太网地址，其它的还可能有令牌环地址</p> <p>Protocol Type：值 <code>0x0800</code> 表示 IPv4 协议，其它还可能是 ICMP/IGMP 等</p> <p>Hardware Address Length：硬件地址长度，以太网是 6</p> <p>Protocol Address Length：协议地址长度，对于 ARP 请求和应答包来说，该值是 4</p> <p>Opcode：ARP 操作的类型</p> <div class="language- extra-class"><pre><code>* ARP 请求，值1
* ARP 应答，值2
* RARP请求，值3
* RARP应答，值4
</code></pre></div></div> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUEING</span></span>
  <span class="token comment">/** Pointer to queue of pending outgoing packets on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token comment">/** Pointer to a single pending outgoing packet on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  ip4_addr_t ipaddr<span class="token punctuation">;</span>		<span class="token comment">// IP 地址</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>		<span class="token comment">// 网卡</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethaddr<span class="token punctuation">;</span>	<span class="token comment">// 物理地址</span>
  u16_t ctime<span class="token punctuation">;</span>				<span class="token comment">// 生存时间，当大于最大生存值时，该表项会被删除</span>
  u8_t state<span class="token punctuation">;</span>				<span class="token comment">// 缓存项状态</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="缓存表超时处理"><a href="#缓存表超时处理" class="header-anchor">#</a> 缓存表超时处理</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Clears expired entries in the ARP table.
 *
 * This function should be called every ARP_TMR_INTERVAL milliseconds (1 second),
 * in order to expire entries in the ARP table.
 */</span>
<span class="token keyword">void</span>
<span class="token function">etharp_tmr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;etharp_timer\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 遍历 ARP 表，删除过期的表项 */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ARP_TABLE_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u8_t state <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_EMPTY
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_SUPPORT_STATIC_ENTRIES</span></span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_STATIC<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ETHARP_SUPPORT_STATIC_ENTRIES */</span></span>
       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 一下情形表示ARP表项过期：</span>
        <span class="token comment">// 1. 表项处于 STABLE 状态，并且ctime超过了最大生存时间（5分钟）</span>
        <span class="token comment">// 2. 表项处于 PENDING 状态，并且ctime超过了最大等待时间（5秒）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXAGE<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span>  <span class="token operator">&amp;&amp;</span>
           <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXPENDING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;etharp_timer: expired %s entry %d.\n&quot;</span><span class="token punctuation">,</span>
                                   arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE <span class="token operator">?</span> <span class="token string">&quot;stable&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* clean up entries that have just been expired */</span>
        <span class="token function">etharp_free_entry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Don't send more than one request every 2 seconds. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Reset state to stable, so that the next transmitted packet will
           re-send an ARP request. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* still pending, resend an ARP query */</span>
        <span class="token function">etharp_request</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="arp-数据包接收流程"><a href="#arp-数据包接收流程" class="header-anchor">#</a> ARP 数据包接收流程</h3> <p><img src="/blog/assets/img/lwip_arp_process_input.35e6fc48.png" alt="ARP 接收流程"></p> <h3 id="arp-数据包发送流程"><a href="#arp-数据包发送流程" class="header-anchor">#</a> ARP 数据包发送流程</h3> <p>IP 数据包通过 <code>ip4_output</code> 函数将上层数据包传递到 ARP 协议处理，ARP 通过 <code>etharp_output</code> 函数接收到 IP 数据包后就会进行发送，ARP 会先从数据包中进行分析，判断这个 IP 数据报是单播数据包还是多播或者是广播数据包，然后进行不同的处理：</p> <ul><li>对于对播或者是广播数据包，直接将数据包丢给网卡（调用 <code>ethernet_output</code> 函数）</li> <li>对于单播包，首先判断目标 IP 地址是否和主机处于同一子网上，如果不是，则修改 IP 地址，IP 地址为网关的 IP 地址</li> <li>对于单播包，ARP 协议需要根据 IP 地址找到对应的 MAC 地址，如果找不到 MAC 地址的话，还需要延迟发送数据包，ARP 协议首先会创建一个 ARP 表项，然后将数据包挂到 ARP 表项对应的缓存队列上，于此同时会发出一个 ARP 请求包，等待目标主机的回应后再发送 IP 数据包</li></ul> <p><img src="/blog/assets/img/lwip_arp_process_output.999a53be.png" alt="ARP 发送流程"></p> <h3 id="抓包"><a href="#抓包" class="header-anchor">#</a> 抓包</h3> <p><img src="/blog/assets/img/lwip_arp_request.7e489783.png" alt="arp request"></p> <p><img src="/blog/assets/img/lwip_arp_reply.59985110.png" alt="arp reply"></p> <h2 id="ip-协议"><a href="#ip-协议" class="header-anchor">#</a> IP 协议</h2> <p>IP 协议负责将数据包从源主机发送到目标主机，通过 IP 地址作为唯一识别码，在发送数据包的过程中，IP 协议还可能对数据包进行分片处理，同时在接收数据包的时候还可能需要对分片的数据包进行重装。</p> <h3 id="ip-首部"><a href="#ip-首部" class="header-anchor">#</a> IP 首部</h3> <p><img src="/blog/assets/img/ip_protocol.f8dade33.png" alt="IP协议数据包格式"></p> <p><strong>LwIP 定义了一个 <code>ip_hdr</code> 结构体来描述 IP 数据包的首部</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>IHL：协议头的长度，单位是<strong>字</strong>，所以最大可以记录 60 字节的协议头部</p> <p>TOS：服务类性，用以区分不同类型的 IP 数据包（例如一些特别要求低时延、高吞吐的数据包），路由器会根据这个字段的值来为数据包提供最合理的路径</p> <p>TL：总长度，首部加上数据区域，单位是字节。整个 IP 数据包的理论最大长度为 65535 字节</p> <p>Identification：标识字段用于表示 IP 层发送出去的每一份 IP 数据包，在发送每一份报文时，该值会加 1,在分片的时候，该字段会被复制到每个分片数据包中，目标接收主机会根据该字段判断这些数据是否属于同一个 IP 数据包</p> <p>Fragment Offset：分片偏移量，使用 8 的整数倍记录，所以每个数据包中的分片数据大小也必须是 8 的整数倍</p> <p>TTL：生存时间，每当 IP 数据包由一台路由器处理时，该字段的值减1,若 TTL 字段减为0,则该数据包必须丢弃，同时返回一个 ICMP 差错报文给源主机</p> <p>Protocol：值为 6 表明数据部分要交给 TCP，值为 17 表明数据要交给 UDP</p> <p>Header Checksum：IP 数据包在到达每个路由器上都必须重新计算校验和并再次存放到原处，因为 TTL 字段以及可能的选项字段会改变</p> <p>Data：数据区域包含传输层的报文，或者也可以是 ICMP 报文</p></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>IPv6 不允许数据包分片</li> <li>IPv6 不支持 Options 选项</li></ul></div> <h3 id="ip-数据报分片"><a href="#ip-数据报分片" class="header-anchor">#</a> IP 数据报分片</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一个链路层帧能承载的最大数据量叫做最大传输单元（MTU），以太网帧的 MTU 为 1500 字节。发送方与目的地路径上的每段链路可能使用不同的链路层协议，且每种协议可能具有不同的 MTU，为此需要对 IP 数据报进行分片处理。IP 数据包的重装由目标 IP 地址的主机来完成，每个数据分片到达目标 IP 地址主机的时间是不一样的。</p></div> <p><img src="/blog/assets/img/lwip_ip_frag.c71fe3b0.png" alt="IP 数据包分片"></p> <h3 id="ip-数据报发送"><a href="#ip-数据报发送" class="header-anchor">#</a> IP 数据报发送</h3> <p><code>ip4_output</code> 使用 <code>ip4_route_src</code> 函数查找目标网络接口 netif 来发送 IP 数据包。当网络接口 netif 确定后，IP 数据包通过函数 <code>ip4_output_if</code> 发送出去。若 <code>ip4_route_src</code> 没有找到合适的网络接口，则丢弃该报文，终止本次发送。</p> <p>函数 <code>ip4_route_src</code> 通过遍历网络接口链表 netif_list，查找与目的 IP 地址在同一个子网中的网络接口，并将该网络接口返回给变量 netif。</p> <p><code>ip4_output_if</code>填写 IP 数据报首部对应的各个字段，最后在 IP 层通过回调函数 <code>netif-&gt;output</code>（即 <code>etharp_output</code> 函数）将 IP 数据报投递给 ARP 协议，再调用网卡底层发送函数进行发送。</p> <p><img src="/blog/assets/img/lwip_ip_output.a56af61e.png" alt="IP 数据报发送"></p> <h3 id="ip-数据报接收"><a href="#ip-数据报接收" class="header-anchor">#</a> IP 数据报接收</h3> <p><code>ip4_input</code> 会做各项检查，包括协议版本号，IP 首部的校验值，源 IP 地址是否有效等，然后检测 IP 数据包中的目的 IP 地址是否与本节点的 IP 地址相符，如果是本节点的 IP 地址，则根据该 IP 数据包首部的协议字段判断该数据包应该被递交到哪个上层协议，并调用相应的函数。</p> <p>如果是 UDP 协议，则调用 <code>udp_input</code> 函数；如果是 TCP协议，则调用 <code>tcp_input</code> 函数；如果是 ICMP 协议，则调用 <code>icmp_input</code> 函数；如果是 IGMP 协议，则调用<code>igmp_input</code> 函数；如果都不是，则调用函数 <code>icmp_dest_unreach</code> 返回一个协议不可达 <code>ICMP</code> 数据包给源主机。</p> <p>如果不是本节点的 IP 地址，则通过调用函数 <code>ip_forward</code> 对数据包进行转发。需要注意，由于一个节点可能含有多个 IP 地址，因此 <code>ip4_input</code> 函数会遍历网络接口链表 netif_list上 的 netif 结构变量，来查找与 IP 数据包中相匹配的 IP 地址。</p> <p><img src="/blog/assets/img/lwip_ip_input.2eb1bb3b.png" alt="IP 数据报接收"></p> <h3 id="几个重要的-ip-地址相关的数据结构"><a href="#几个重要的-ip-地址相关的数据结构" class="header-anchor">#</a> 几个重要的 IP 地址相关的数据结构</h3> <h4 id="ipv4-相关"><a href="#ipv4-相关" class="header-anchor">#</a> IPv4 相关</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">in_addr</span>
<span class="token punctuation">{</span>
    in_addr_t s_addr<span class="token punctuation">;</span>  <span class="token comment">//表示32位的IP地址，32位无符号整型</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>
<span class="token punctuation">{</span>
    uint8_t            sin_len<span class="token punctuation">;</span>     <span class="token comment">//表示该结构体的长度，8位无符号整型</span>
    sa_family_t        sin_family<span class="token punctuation">;</span>  <span class="token comment">//表示套接口使用的协议族，8位无符号整型</span>
    in_port_t          sin_port<span class="token punctuation">;</span>    <span class="token comment">//表示套接口使用的端口号，16位无符号整型</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     sin_addr<span class="token punctuation">;</span>    <span class="token comment">//表示IP地址，32位无符号整型</span>
    <span class="token keyword">char</span>               sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//该成员基本不使用，总是置为0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><code>sin_len</code> 成员是不要求一定存在的，即便这个成员存在，也无需设置它或者检查它</li> <li><code>sin_family</code> 的类型与 <code>sin_len</code> 成员有关，如果结构体中定义了成员 <code>sin_len</code>，那么 <code>sin_family</code> 一般就是8位无符号整型；如果结构体中没有定义成员 <code>sin_len</code>，那么 <code>sin_family</code> 一般就是16位无符号整型</li></ul> <h4 id="ipv6-相关"><a href="#ipv6-相关" class="header-anchor">#</a> IPv6 相关</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">in6_addr</span>
<span class="token punctuation">{</span>
    unit8_t s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//表示128位的IP地址，这里采用数组的形式  </span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span>
<span class="token punctuation">{</span>
    uint8_t         sin6_len<span class="token punctuation">;</span>      <span class="token comment">//表示该结构体的长度，8位无符号整型</span>
    sa_family_t     sin6_family<span class="token punctuation">;</span>   <span class="token comment">//表示套接口使用的协议族，8位无符号整型</span>
    in_port_t       sin_port<span class="token punctuation">;</span>      <span class="token comment">//表示套接口使用的端口号，16位无符号整型</span>
    uint32_t        sin_flowinfo<span class="token punctuation">;</span>  <span class="token comment">//低序20位是流标签，高序12位保留</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr      <span class="token comment">//表示128位的IP地址</span>
    uint32_t        sin6_scope_id<span class="token punctuation">;</span> <span class="token comment">//标识对于具备范围的地址而言有意义的范围</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="通用套接字地址结构"><a href="#通用套接字地址结构" class="header-anchor">#</a> 通用套接字地址结构</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>
<span class="token punctuation">{</span>
    uint8_t     sa_len<span class="token punctuation">;</span>
    sa_family_t sa_family<span class="token punctuation">;</span>
    <span class="token keyword">char</span>        sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//表示14字节的协议地址</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="新的通用套接字接口地址结构"><a href="#新的通用套接字接口地址结构" class="header-anchor">#</a> 新的通用套接字接口地址结构</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span>
<span class="token punctuation">{</span>
    uint8_t              ss_len<span class="token punctuation">;</span>    <span class="token comment">//表示该结构的长度</span>
    sa_family_t          ss_family<span class="token punctuation">;</span> <span class="token comment">//表示协议族</span>
    <span class="token keyword">char</span> __ss_padding<span class="token punctuation">[</span>_SS_PADSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>          
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>原有的通用数据结构 <code>sockaddr</code> 只有 16 字节，无法兼容 IPv6 格式，<code>sockaddr_storage</code> 足够大，可以容纳任何套接字接口地址</li></ul> <h4 id="inet-pton-和-inet-ntop-函数"><a href="#inet-pton-和-inet-ntop-函数" class="header-anchor">#</a> inet_pton 和 inet_ntop 函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrstr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//成功返回1，strptr格式错误返回0，失败返回-1</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrstr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//成功则返回指向结果的指针，失败返回NULL</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p><code>family</code> 参数根据协议族的不同，选择 <code>AF_INET</code> 或 <code>AF_INET6</code></p></li> <li><p><code>inet_pton</code> 将 <code>strptr</code> 指向的字符串，转为数值，存放在 <code>addstr</code> 指向的内存中</p></li> <li><p><code>inet_ntop</code> 做相反的运算，<code>len</code> 参数是 <code>strptr</code> 单元的大小，防止溢出。为有助于指定大小，C语言中有做如下定义:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">incldue</span> <span class="token expression"><span class="token operator">&lt;</span>arpa<span class="token operator">/</span>inet<span class="token punctuation">.</span>h<span class="token operator">&gt;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">INET_ADDRSTRLEN    <span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">INET6_ADDRSTRLEN   <span class="token number">46</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h2 id="icmp-协议"><a href="#icmp-协议" class="header-anchor">#</a> ICMP 协议</h2> <p><img src="/blog/assets/img/lwip_icmp_protocol.a19c8c2e.jpg" alt="ICMP 协议数据包格式"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ICMP 报文有两大类型，可以划分为<strong>差错报告</strong>报文和<strong>查询</strong>报文。</p> <p>差错报告报文主要是用来向 IP 数据报源主机返回一个差错报告信息，而这个差错报告信息产生的原因是路由器或者主机不能对当前数据报进行正常的处理。</p> <p>查询报文是用于一台主机向另一台主机发起一个请求，如果目标主机收到这个查询的请求后，就会按照查询报文的格式想源主机作出应答。<code>ping</code> 命令本质上就是一个 ICMP 查询报文。</p></div> <table><tr><th>ICMP 报文类型</th> <th>具体类型</th> <th>描述<br></th></tr> <tr><td rowspan="5">差错报告报文<br></td> <td>3</td> <td>目的不可达</td></tr> <tr><td>4</td> <td>源站抑制</td></tr> <tr><td>5</td> <td>重定向</td></tr> <tr><td>11</td> <td>超时</td></tr> <tr><td>12</td> <td>参数错误报文</td></tr> <tr><td rowspan="5">查询报文</td> <td>0或8</td> <td>回显请求或回显应答</td></tr> <tr><td>9或10</td> <td>路由器询问或通告</td></tr> <tr><td>13或14</td> <td>事件戳请求或应答</td></tr> <tr><td>15或16</td> <td>信息请求或应答</td></tr> <tr><td>17或18</td> <td>掩码请求或应答</td></tr></table> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>ICMP 回显请求报文和回显应答报文是 LwIP 中唯一实现的查询报文，其它几种查询报文用于主机确定自己的 IP 地址、掩码、路由等信息，已经被 DHCP 协议取代了。</p></div> <h3 id="发送差错报文"><a href="#发送差错报文" class="header-anchor">#</a> 发送差错报文</h3> <p>如果 IP 数据报无法递交到传输层时，就会调用 <code>icmp_dest_unreach()</code> 函数返回一个 ICMP 协议不可达报文。</p> <p>如果在传输层中，UDP 协议无法向应用层递交数据报，那么将调用该函数返回一个 ICMP 端口不可达报文。</p> <p>在转发数据报的时候，如果数据报中 TTL 为 0,或者在分片数据报重装的时候超时，LwIP 将调用 <code>icmp_time_exceeded()</code> 函数发送一个 ICMP 超时报文到源主机中。</p> <p><code>icmp_time_exceeded</code> 和 <code>icmp_dest_unreach</code> 都会调用 <code>icmp_send_response</code> 函数发送 ICMP 应答报文。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Send an icmp packet in response to an incoming packet.
 *
 * @param p the input packet for which the 'unreachable' should be sent,
 *          p-&gt;payload pointing to the IP header
 * @param type Type of the ICMP header
 * @param code Code of the ICMP header
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">icmp_send_response</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> u8_t type<span class="token punctuation">,</span> u8_t code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ip_hdr</span> <span class="token operator">*</span>iphdr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span> <span class="token operator">*</span>icmphdr<span class="token punctuation">;</span>
  ip4_addr_t iphdr_src<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>

  <span class="token comment">/* 申请 pbuf 内存块，大小为 ICMP 首部 + IP 首部 + 8 字节数据 */</span>
  q <span class="token operator">=</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_IP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> IP_HLEN <span class="token operator">+</span>                                          ICMP_DEST_UNREACH_DATASIZE<span class="token punctuation">,</span>PBUF_RAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 指向 IP 数据报首部</span>
  iphdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>
  <span class="token comment">// 指向 pbuf 数据区域，并强制转化为 ICMP 报文首部</span>
  icmphdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>seqno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 从原始数据包中复制字段，IP 数据报首部 + 8 字节的数据区域</span>
  <span class="token function">SMEMCPY</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token operator">-&gt;</span>payload <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>u8_t <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span>
          IP_HLEN <span class="token operator">+</span> ICMP_DEST_UNREACH_DATASIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 得到源 IP 地址</span>
  <span class="token function">ip4_addr_copy</span><span class="token punctuation">(</span>iphdr_src<span class="token punctuation">,</span> iphdr<span class="token operator">-&gt;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据路由表查询底层网卡接口</span>
  netif <span class="token operator">=</span> <span class="token function">ip4_route</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iphdr_src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* calculate checksum */</span>
    icmphdr<span class="token operator">-&gt;</span>chksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CHECKSUM_GEN_ICMP</span></span>
    <span class="token function">IF__NETIF_CHECKSUM_ENABLED</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> NETIF_CHECKSUM_GEN_ICMP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      icmphdr<span class="token operator">-&gt;</span>chksum <span class="token operator">=</span> <span class="token function">inet_chksum</span><span class="token punctuation">(</span>icmphdr<span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">ip4_output_if</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iphdr_src<span class="token punctuation">,</span> ICMP_TTL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IP_PROTO_ICMP<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="处理-icmp-报文"><a href="#处理-icmp-报文" class="header-anchor">#</a> 处理 ICMP 报文</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>LwIP 对 ICMP 报文中很多类型的报文都不做处理，LwIP 会将这些不处理的报文丢弃，但是对 ICMP 回显请求报文会做出处理。</p></div> <p><code>icmp_input</code> 在 <code>ip_input</code> 中被调用，它处理接收到的 ICMP 请求报文。首先判断该数据包是否为广播或者组播包，如果是，则直接返回，不再继续处理；如果不是，则继续判断该数据包长度是否小于 ICMP 回显请求头部长度，如果是则丢弃数据包；如果不是则将该 ICMP 报文类型字段变为 0，重新计算校验和，并将 IP 报文首部的源 IP 地址和目的 IP 地址交换位置，并通过调用函数 <code>ip_output_if</code> 将数据包发送出去。</p> <h2 id="udp-协议"><a href="#udp-协议" class="header-anchor">#</a> UDP 协议</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JfdH.png" alt="UDP协议数据包"></p> <ul><li>函数udp_input将检查报文的UDP校验，最终调用函数recv，将收到的报文传递给应用层程序</li> <li>当应用层程序要通过UDP协议向外发送IP报文时，将通过调用函数udp_send实现，函数udp_send通过调用IP层的函数ip_output_if实现报文的发送</li> <li>LwIP使用链表结构体udp_pcb来保存每一个UDP会话的状态</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token punctuation">{</span>
<span class="token comment">/* Common members of all PCB types */</span>
  IP_PCB<span class="token punctuation">;</span>

<span class="token comment">/* Protocol specific PCB members */</span>

  <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  u8_t flags<span class="token punctuation">;</span>
  <span class="token comment">/** ports are in host byte order */</span>
  u16_t local_port<span class="token punctuation">,</span> remote_port<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_MULTICAST_TX_OPTIONS</span></span>
  <span class="token comment">/** outgoing network interface for multicast packets */</span>
  ip_addr_t multicast_ip<span class="token punctuation">;</span>
  <span class="token comment">/** TTL for outgoing multicast packets */</span>
  u8_t mcast_ttl<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_MULTICAST_TX_OPTIONS */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_UDPLITE</span></span>
  <span class="token comment">/** used for UDP_LITE only */</span>
  u16_t chksum_len_rx<span class="token punctuation">,</span> chksum_len_tx<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_UDPLITE */</span></span>

  <span class="token comment">/** receive callback function */</span>
  udp_recv_fn recv<span class="token punctuation">;</span>
  <span class="token comment">/** user-supplied argument for the recv callback */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>recv_arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="tcp-协议"><a href="#tcp-协议" class="header-anchor">#</a> TCP 协议</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JULF.png" alt="TCP协议数据包"></p> <ul><li>TCP的滑动窗口协议是用于实现流量控制的</li> <li>TCP的超时和重传机制提高了数据传输的可靠性</li> <li>拥塞控制是通过慢启动算法和拥塞避免算法来实现的</li> <li>LwIP中含有两个定时器函数：tcp_fasttmr和tcp_slowtmr，tcp_fasttmr每250ms调用一次，tcp_slowtmr每500ms调用一次。快速定时器主要做两个方面的事情：向上层递交上层一直未接收的数据，二是发送该连接上的延迟ACK请求数据段。慢速定时器参与了较多功能，如超时与重传、拥塞控制等。</li></ul> <h2 id="lwip-的三种编程接口"><a href="#lwip-的三种编程接口" class="header-anchor">#</a> LwIP 的三种编程接口</h2> <div class="custom-block tip"><p class="custom-block-title">RAW/Callback API</p> <p>直接调用协议栈各模块的函数（它们是使用<strong>回调函数</strong>的 API 接口，也称为 RAW API）。</p> <p>优点：</p> <ul><li>无需操作系统支持。</li> <li>LwIP 内核把数据交给应用程序的过程只是一次简单的 API 调用，非常节省时间和空间。</li> <li>应用程序和内核程序处于同一线程之中，节省了任务间通信和任务切换的开销。</li></ul> <p>缺点：</p> <ul><li>应用程序的执行会制约内核程序的执行，不同的应用程序之间也会互相制约。在应用程序执行的过程中，内核程序将不能得到运行，这会影响网络数据包的处理效率，严重地还会造成数据包堵塞而发生丢包现象。</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Netconn API</p> <p>使用 LwIP 提供的专用 API，也称为 Sequential API，程序的执行过程基于 <strong>open-read-write-close</strong> 模型。Netconn API 是基于操作系统的 IPC 机制实现的，它将 LwIP 内核代码和网络应用程序分离成独立的线程。</p> <p>优点：</p> <ul><li>LwIP 线程只负责数据包的 TCP/IP 封装和拆封，不用进行数据的应用层处理，提高了系统对网络数据包的处理效率。</li> <li>相较于 Socket API，Netconn API 避免了内核程序和网络应用程序之间的数据拷贝，提高了数据传递的效率。</li></ul> <p>缺点：</p> <ul><li>依赖操作系统。</li> <li>内核程序和网络应用程序之间的数据包传递需要依靠操作系统的信号量和邮箱机制完成，耗费了更多的时间和内存。</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">BSD Socket API</p> <p>Socket 对网络连接进行了高级的抽象，使得用户可以像操作文件一样操作网络连接。LwIP 的 Socket API 是基于 Netconn API 实现的。</p> <p>优点：</p> <ul><li>使用 Socket 编写的网络应用程序具有很好的可移植性。</li></ul> <p>缺点：</p> <ul><li>Socket API 在内核程序和应用程序之间存在数据拷贝，降低了数据传递的效率。</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>LwIP 并没有实现全部的 BSD Socket API。</p></div> <h3 id="tcp-raw-api"><a href="#tcp-raw-api" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6l7j0.png" alt="TCP RAW API"></p> <table><thead><tr><th>函数</th> <th>说明</th></tr></thead> <tbody><tr><td>struct tcp_pcb* tcp_new()</td> <td>新建tcp协议控制块</td></tr> <tr><td>ert_t tcp_bind(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port)</td> <td>绑定本地IP地址和端口号，如果ipaddr为IP_ADDR_ANY，则将连接绑定到所有的本地IP地址上</td></tr> <tr><td>struct tcp_pcb* tcp_listen(struct tcp_pcb* pcb)</td> <td>使指定的连接开始进入监听状态，如果监听成功，就返回一个新的连接控制块pcb</td></tr> <tr><td>void tcp_accepted(struct tcp_pcb* pcb)</td> <td>通知LwIP一个新来的连接已经被接收，这个函数通常在由tcp_accept指定的回调函数中被调用</td></tr> <tr><td>void tcp_accept(struct tcp_pcb* pcb,err_t (*accept)(void* arg,struct tcp_pcb* newpcb,err_t err))</td> <td>指定处于监听状态的连接，在成功建立连接后要调用的回调方法</td></tr> <tr><td>err_t tcp_connect(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port,err_t (* connected)(void* arg,struct tcp_pcb* tpcb,err_t err))</td> <td>请求连接到执行的远程主机</td></tr> <tr><td>err_t tcp_write(struct tcp_pcb* pcb,void* dataptr,u16_t len,u8_t copy)</td> <td>发送TCP数据，将要发送的数据放入发送队列中，由协议栈内核发送，copy为0则不会为发送的数据分配新的内存空间</td></tr> <tr><td>void tcp_sent(struct tcp_pcb* pcb,err_t (*sent)(void* arg,struct tcp_pcb* tpcb,u16_t len))</td> <td>指定当远程主机成功接收数据后，应用程序调用的回调函数</td></tr> <tr><td>void tcp_recv(struct tcp_pcb* pcb,err_t (* recv)(void* arg,struct tcp_pcb* tpcb,struct pbuf* p,err_t err))</td> <td>指定接收数据时调用的回调函数</td></tr> <tr><td>void tcp_recved(struct tcp_pcb* pcb,u16_t len)</td> <td>用于获取接收到的数据的长度，必须在tcp_recv指定的回调函数中被调用</td></tr> <tr><td>err_t tcp_close(struct tcp_pcb* pcb)</td> <td>关闭一个指定的TCP连接，调用该函数后将会释放pcb控制块所占用的内存空间</td></tr> <tr><td>void tcp_abort(struct tcp_pcb* pcb)</td> <td>终止一个指定的连接，调用该函数后，pcb控制块所占用的内存空间将被释放</td></tr> <tr><td>void tcp_err(struct tcp_pcb* pcb,void (*err)(void* arg,err_t err))</td> <td>指定处理错误的回调函数</td></tr></tbody></table> <h3 id="tcp-raw-api-2"><a href="#tcp-raw-api-2" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6lLHU.png" alt="UDP RAW API"></p> <h3 id="netconn-api"><a href="#netconn-api" class="header-anchor">#</a> Netconn API</h3> <ul><li>数据结构netconn描述了应用程序要使用API函数机那里一个连接的各种属性，包括了连接的类型、最近的故障代码、回调函数等。</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** A netconn descriptor */</span>
<span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token punctuation">{</span>
  <span class="token comment">/** type of the netconn (TCP, UDP or RAW) */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> type<span class="token punctuation">;</span>
  <span class="token comment">/** current state of the netconn */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_state</span> state<span class="token punctuation">;</span>
  <span class="token comment">/** the lwIP internal protocol control block */</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_pcb</span>  <span class="token operator">*</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tcp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>udp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span> <span class="token operator">*</span>raw<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> pcb<span class="token punctuation">;</span>
  <span class="token comment">/** the last error this netconn had */</span>
  err_t last_err<span class="token punctuation">;</span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_NETCONN_SEM_PER_THREAD</span></span>
  <span class="token comment">/** sem that is used to synchronously execute functions in the core context */</span>
  sys_sem_t op_completed<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">/** mbox where received packets are stored until they are fetched
      by the netconn application thread (can grow quite big) */</span>
  sys_mbox_t recvmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/** mbox where new connections are stored until processed
      by the application thread */</span>
  sys_mbox_t acceptmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
  <span class="token comment">/** only used for socket layer */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SOCKET</span></span>
  <span class="token keyword">int</span> socket<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SOCKET */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_SNDTIMEO</span></span>
  <span class="token comment">/** timeout to wait for sending data (which means enqueueing data for sending
      in internal buffers) in milliseconds */</span>
  s32_t send_timeout<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVTIMEO */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_RCVTIMEO</span></span>
  <span class="token comment">/** timeout in milliseconds to wait for new data to be received
      (or connections to arrive for listening netconns) */</span>
  <span class="token keyword">int</span> recv_timeout<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVTIMEO */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_RCVBUF</span></span>
  <span class="token comment">/** maximum amount of bytes queued in recvmbox
      not used for TCP: adjust TCP_WND instead! */</span>
  <span class="token keyword">int</span> recv_bufsize<span class="token punctuation">;</span>
  <span class="token comment">/** number of bytes currently in recvmbox to be received,
      tested against recv_bufsize to limit bytes on recvmbox
      for UDP and RAW, used for FIONREAD */</span>
  <span class="token keyword">int</span> recv_avail<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVBUF */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_LINGER</span></span>
   <span class="token comment">/** values &lt;0 mean linger is disabled, values &gt; 0 are seconds to linger */</span>
  s16_t linger<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_LINGER */</span></span>
  <span class="token comment">/** flags holding more netconn-internal state, see NETCONN_FLAG_* defines */</span>
  u8_t flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores how much is already sent. */</span>
  size_t write_offset<span class="token punctuation">;</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores the message.
      Also used during connect and close. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">api_msg_msg</span> <span class="token operator">*</span>current_msg<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
  <span class="token comment">/** A callback function that is informed about events for this netconn */</span>
  netconn_callback callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><img src="https://s1.ax1x.com/2018/08/10/P61AED.png" alt="Netconn API"></p> <table><thead><tr><th>函数</th> <th>说明</th></tr></thead> <tbody><tr><td>struct netconn* netconn_new_with_proto_and_callback(enum netconn_type t,u8_t proto,netconn_callback callback)</td> <td>建立一个新的netconn连接</td></tr> <tr><td>err_t netconn_delete(struct netconn* conn)</td> <td>删除netconn所指向的连接</td></tr> <tr><td>err_t netconn_getaddr(struct netconn* conn,struct ip_addr* addr,u16_t* port,u8_t local)</td> <td>获取conn连接的主机IP地址和端口号</td></tr> <tr><td>err_t netconn_bind(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>将一个IP地址及端口号与conn指向的而连接绑定</td></tr> <tr><td>err_t netconn_connect(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>将服务器端的IP地址和端口号与conn指向的连接绑定</td></tr> <tr><td>err_t netconn_disconnect(struct netconn* conn)</td> <td>断开conn指向的连接</td></tr> <tr><td>err_t netconn_listen_with_backlog(struct netconn* conn，u8_t backlog)</td> <td>将conn指向的连接设定为监听状态</td></tr> <tr><td>struct netconn* netconn_accept(struct netconn* conn)</td> <td>接收客户端的连接，该函数会阻塞在acceptmbox邮箱上</td></tr> <tr><td>struct netbuf* netconn_recv(struct netconn* conn)</td> <td>接收数据，接收到的数据被封装为netbuf结构</td></tr> <tr><td>err_t netconn_sendto(struct netconn* conn,struct netbuf* buf,struct ip_addr* addr,u16_t port)</td> <td>向一个指定的IP地址和端口号发送数据，这个函数只能用在conn类型为UDP或者RAW的连接中</td></tr> <tr><td>err_t netconn_write(struct netconn* conn,const void* dataptr,size_t size,u8_t apiflag)</td> <td>向相应的TCP连接上发送数据，这个函数只能用于发送TCP的报文</td></tr> <tr><td>err_t nnetconn_close(struct netconn* conn)</td> <td>关闭conn指向的连接</td></tr></tbody></table> <ul><li>netconn_new_with_proto_and_callback首先调用netconn_alloc函数分配并初始化一个netconn结构，接下来该函数会构建一个api_msg消息，该消息要求内核执行函数do_newconn，最后调用函数tcpip_apimsg来将消息包装成tcpip_msg结构并发送出去。tcpip_thread函数解析该消息并调用函数do_newconn，do_newconn根据参数的类型调用函数tcp_new创建一个TCP控制块</li> <li>tcpip_thread是处理TCP/IP的内核协议栈进程，它只接收tcpip_msg结构封装的消息，并根据消息的类型来判定该消息来自物理网卡或应用层程序。如果接收到网卡的IP报文，则将该报文递交给ip_input函数；如果是应用层程序发送的消息，则通过调用消息指定的内核处理函数来完成相应的功能</li></ul> <h3 id="socket-api"><a href="#socket-api" class="header-anchor">#</a> Socket API</h3> <blockquote><p>LwIP提供了标准BSD套接字API，它也是有序API，在内存构建于Netconn API之上。所谓“有序”是指其执行模型基于典型的阻塞式打开-读-写-关闭机制。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61V4H.png" alt="Socket API"></p> <div class="custom-block warning"><p class="custom-block-title">HTTP 协议在物联网系统中的劣势</p> <ol><li>HTTP 是一种同步协议，客户端需要等待服务器的响应才可以进行下一步工作（在客户端数量多、网络不可靠的场景下，实现同步通信很困难）</li> <li>HTTP 是单向的，客户端只能主动向服务器发出数据，无法被动接收来自网络的数据（不适用于实时控制的场合）</li> <li>HTTP 有许多帧头和规则，是一种重量级的协议（实现在物联网设备中需要耗费大量的系统资源）</li></ol></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/cs/lwip.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/26/2020, 9:18:54 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/cs/logistic_regression.html" class="prev">
        逻辑回归
      </a></span> <span class="next"><a href="/blog/cs/mbedtls.html">
        𝙢𝙗𝙚𝙙𝙏𝙇𝙎 基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.096a2661.js" defer></script><script src="/blog/assets/js/4.51d7be7e.js" defer></script><script src="/blog/assets/js/5.2b7e4836.js" defer></script><script src="/blog/assets/js/9.eb74a0e3.js" defer></script>
  </body>
</html>
