<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€ | suda-morris ä¸ªäººåšå®¢</title>
    <meta name="description" content="è®°å½•å­¦ä¹ ç”Ÿæ´»ï¼Œæ¢ç´¢æœªçŸ¥é¢†åŸŸ">
    <link rel="icon" href="/blog/favicon.png">
  <link rel="manifest" href="/blog/manifest.json">
    
    <link rel="preload" href="/blog/assets/css/0.styles.6e7aa9f8.css" as="style"><link rel="preload" href="/blog/assets/js/app.d911a002.js" as="script"><link rel="preload" href="/blog/assets/js/2.37a3b3f2.js" as="script"><link rel="preload" href="/blog/assets/js/4.bd9b9f70.js" as="script"><link rel="preload" href="/blog/assets/js/5.22f508ff.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.c734c883.js"><link rel="prefetch" href="/blog/assets/js/11.7c897b7a.js"><link rel="prefetch" href="/blog/assets/js/12.f375e6c7.js"><link rel="prefetch" href="/blog/assets/js/13.1affb5de.js"><link rel="prefetch" href="/blog/assets/js/14.262429b5.js"><link rel="prefetch" href="/blog/assets/js/15.c53d4e02.js"><link rel="prefetch" href="/blog/assets/js/16.777581b6.js"><link rel="prefetch" href="/blog/assets/js/17.3309a30d.js"><link rel="prefetch" href="/blog/assets/js/18.6dc8a613.js"><link rel="prefetch" href="/blog/assets/js/19.6a688e7e.js"><link rel="prefetch" href="/blog/assets/js/20.7ce3a8a6.js"><link rel="prefetch" href="/blog/assets/js/21.68c5d8b6.js"><link rel="prefetch" href="/blog/assets/js/22.feab4881.js"><link rel="prefetch" href="/blog/assets/js/23.d8b937ca.js"><link rel="prefetch" href="/blog/assets/js/24.ce1b5b84.js"><link rel="prefetch" href="/blog/assets/js/25.ff972530.js"><link rel="prefetch" href="/blog/assets/js/26.651d2ba7.js"><link rel="prefetch" href="/blog/assets/js/27.f2cee4f0.js"><link rel="prefetch" href="/blog/assets/js/28.8f1c23df.js"><link rel="prefetch" href="/blog/assets/js/29.3dcb30f5.js"><link rel="prefetch" href="/blog/assets/js/3.7be88220.js"><link rel="prefetch" href="/blog/assets/js/30.932eb429.js"><link rel="prefetch" href="/blog/assets/js/31.07841078.js"><link rel="prefetch" href="/blog/assets/js/32.c38cbc72.js"><link rel="prefetch" href="/blog/assets/js/33.45350cc1.js"><link rel="prefetch" href="/blog/assets/js/34.c366b655.js"><link rel="prefetch" href="/blog/assets/js/35.8ab20b34.js"><link rel="prefetch" href="/blog/assets/js/36.87f73ac6.js"><link rel="prefetch" href="/blog/assets/js/37.9a57abb2.js"><link rel="prefetch" href="/blog/assets/js/38.53f3be72.js"><link rel="prefetch" href="/blog/assets/js/39.cf0a2f9f.js"><link rel="prefetch" href="/blog/assets/js/40.6048bdbc.js"><link rel="prefetch" href="/blog/assets/js/41.767c0d73.js"><link rel="prefetch" href="/blog/assets/js/42.bb91fab8.js"><link rel="prefetch" href="/blog/assets/js/43.a44dea5b.js"><link rel="prefetch" href="/blog/assets/js/44.0f9d7f0e.js"><link rel="prefetch" href="/blog/assets/js/45.99323019.js"><link rel="prefetch" href="/blog/assets/js/46.ac57d8d2.js"><link rel="prefetch" href="/blog/assets/js/47.5489a3f1.js"><link rel="prefetch" href="/blog/assets/js/48.54016560.js"><link rel="prefetch" href="/blog/assets/js/49.b0ee1683.js"><link rel="prefetch" href="/blog/assets/js/50.221101ed.js"><link rel="prefetch" href="/blog/assets/js/51.d5ba66f6.js"><link rel="prefetch" href="/blog/assets/js/52.2f1d9424.js"><link rel="prefetch" href="/blog/assets/js/53.a21fb99f.js"><link rel="prefetch" href="/blog/assets/js/54.c13bb985.js"><link rel="prefetch" href="/blog/assets/js/55.0f8942e5.js"><link rel="prefetch" href="/blog/assets/js/56.b0661fca.js"><link rel="prefetch" href="/blog/assets/js/57.6fe5040b.js"><link rel="prefetch" href="/blog/assets/js/58.370882f4.js"><link rel="prefetch" href="/blog/assets/js/59.72bfc85a.js"><link rel="prefetch" href="/blog/assets/js/6.36d67b0c.js"><link rel="prefetch" href="/blog/assets/js/60.707fdb07.js"><link rel="prefetch" href="/blog/assets/js/61.1242dc55.js"><link rel="prefetch" href="/blog/assets/js/62.5b23e5d6.js"><link rel="prefetch" href="/blog/assets/js/63.c698e42d.js"><link rel="prefetch" href="/blog/assets/js/64.3a34da04.js"><link rel="prefetch" href="/blog/assets/js/65.b708481b.js"><link rel="prefetch" href="/blog/assets/js/66.35cb40b5.js"><link rel="prefetch" href="/blog/assets/js/67.c43e5af8.js"><link rel="prefetch" href="/blog/assets/js/68.a47f5ab5.js"><link rel="prefetch" href="/blog/assets/js/69.263d9819.js"><link rel="prefetch" href="/blog/assets/js/7.bd805a57.js"><link rel="prefetch" href="/blog/assets/js/70.1cc54a3c.js"><link rel="prefetch" href="/blog/assets/js/71.2055d8b6.js"><link rel="prefetch" href="/blog/assets/js/72.0c801372.js"><link rel="prefetch" href="/blog/assets/js/73.6ee05353.js"><link rel="prefetch" href="/blog/assets/js/74.320ad177.js"><link rel="prefetch" href="/blog/assets/js/75.2385407f.js"><link rel="prefetch" href="/blog/assets/js/76.37107d99.js"><link rel="prefetch" href="/blog/assets/js/77.b687a910.js"><link rel="prefetch" href="/blog/assets/js/78.2bad01ab.js"><link rel="prefetch" href="/blog/assets/js/79.458c4197.js"><link rel="prefetch" href="/blog/assets/js/8.a11aa557.js"><link rel="prefetch" href="/blog/assets/js/9.9b11be43.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.6e7aa9f8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris ä¸ªäººåšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">Others</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://beautifuldingbats.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Beautiful Dingbats
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.draw.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  draw.io
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">Others</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://beautifuldingbats.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Beautiful Dingbats
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.draw.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  draw.io
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/cs/about.html" class="sidebar-link">å…³äºæœ¬æ ç›®</a></li><li><a href="/blog/cs/bash.html" class="sidebar-link">ğ™—ğ™–ğ™¨ğ™ åŸºç¡€</a></li><li><a href="/blog/cs/bit_ops.html" class="sidebar-link">ä½è¿ç®—æŠ€å·§</a></li><li><a href="/blog/cs/compilation.html" class="sidebar-link">ç¼–è¯‘åŸºç¡€</a></li><li><a href="/blog/cs/design_pattern.html" class="sidebar-link">è®¾è®¡æ¨¡å¼ ğ˜¾ è¯­è¨€æè¿°</a></li><li><a href="/blog/cs/git.html" class="sidebar-link">ğ™‚ğ™ğ™© åŸºç¡€</a></li><li><a href="/blog/cs/logistic_regression.html" class="sidebar-link">é€»è¾‘å›å½’</a></li><li><a href="/blog/cs/lwip.html" class="active sidebar-link">ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼" class="sidebar-link">æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†" class="sidebar-link">LwIP çš„ç½‘ç»œæ¥å£ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„å†…å­˜ç®¡ç†" class="sidebar-link">LwIP çš„å†…å­˜ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ç½‘ç»œæ•°æ®åŒ…" class="sidebar-link">ç½‘ç»œæ•°æ®åŒ…</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwipæ¶æ„" class="sidebar-link">LwIPæ¶æ„</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#è¿›ç¨‹æ¨¡å‹" class="sidebar-link">è¿›ç¨‹æ¨¡å‹</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#arpå¤„ç†" class="sidebar-link">ARPå¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ipå¤„ç†" class="sidebar-link">IPå¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#icmpå¤„ç†" class="sidebar-link">ICMPå¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#udpå¤„ç†" class="sidebar-link">UDPå¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#tcpå¤„ç†" class="sidebar-link">TCPå¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£" class="sidebar-link">LwIP çš„ä¸‰ç§ç¼–ç¨‹æ¥å£</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwipç§»æ¤" class="sidebar-link">LwIPç§»æ¤</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwipé…ç½®" class="sidebar-link">LwIPé…ç½®</a></li></ul></li><li><a href="/blog/cs/keras.html" class="sidebar-link">ğ™†ğ™šğ™§ğ™–ğ™¨ åŸºç¡€</a></li><li><a href="/blog/cs/scala.html" class="sidebar-link">ğ™ğ™˜ğ™–ğ™¡ğ™– åŸºç¡€</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ğ™‡ğ™¬ğ™„ğ™‹-åŸºç¡€"><a href="#ğ™‡ğ™¬ğ™„ğ™‹-åŸºç¡€" aria-hidden="true" class="header-anchor">#</a> ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€</h1> <p><img src="/blog/assets/img/tcp_ip_stack.13913b2b.png" alt="TCP/IPåè®®æ ˆ"></p> <h2 id="æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼"><a href="#æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼" aria-hidden="true" class="header-anchor">#</a> æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼</h2> <p><img src="/blog/assets/img/ethernet_frame.f4de10c4.png" alt="Ethernet_Frame"></p> <h2 id="lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†"><a href="#lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†" aria-hidden="true" class="header-anchor">#</a> LwIP çš„ç½‘ç»œæ¥å£ç®¡ç†</h2> <p>LwIP ä½¿ç”¨ <strong>netif</strong> ç»“æ„ä½“æ¥æè¿°ç¡¬ä»¶ç½‘ç»œæ¥å£ï¼Œå¹¶é€šè¿‡ <code>netif_add</code> å‡½æ•°å°†å…¶æŒ‚è½½åˆ°å…¨å±€ <strong>netif é“¾è¡¨</strong>ä¸­ã€‚</p> <p><img src="/blog/assets/img/netif_list.73bfcf79.png" alt="ç½‘å¡é“¾è¡¨"></p> <h3 id="netif-ç»“æ„ä½“"><a href="#netif-ç»“æ„ä½“" aria-hidden="true" class="header-anchor">#</a> netif ç»“æ„ä½“</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* struct netif ç”¨äºæè¿°ä¸åŒç±»å‹çš„ç½‘å¡ï¼Œåœ¨ç½‘å¡åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šå¦‚ä¸‹æˆå‘˜ï¼š
** hwaddr_len, hwaddr[], mtu, flags
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* å¦‚æœæ”¯æŒå¤šç½‘å¡ï¼Œåˆ™ä½¿ç”¨å•å‘é“¾è¡¨æ¥ç®¡ç†åŒä¸€è®¾å¤‡çš„å¤šä¸ªç½‘å¡ */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> !LWIP_SINGLE_NETIF</span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
    <span class="token comment">/* ç½‘ç»œå­—èŠ‚åºè¡¨ç¤ºçš„ IPv4 åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ */</span>
    ip_addr_t ip_addr<span class="token punctuation">;</span>
    ip_addr_t netmask<span class="token punctuation">;</span>
    ip_addr_t gw<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
    <span class="token comment">/* æ•°ç»„ä¿å­˜å¤šä¸ª IPv6 åœ°å€ */</span>
    ip_addr_t ip6_addr<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* æ¯ä¸ª IPv6 åœ°å€çš„çŠ¶æ€ï¼šä¸´æ—¶çš„è¿˜æ˜¯é¦–é€‰çš„ */</span>
    u8_t ip6_addr_state<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_ADDRESS_LIFETIMES</span>
    <span class="token comment">/* æ¯ä¸ª IPv6 åœ°å€çš„å‰©ä½™æœ‰æ•ˆæ—¶é—´ä»¥åŠæ€»å…±æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½ï¼šç§’ */</span>
    <span class="token comment">/* IP6_ADDR_LIFE_STATIC è¡¨ç¤ºè¿™ä¸ªåœ°å€æ˜¯é™æ€åˆ†é…çš„ */</span>
    u32_t ip6_addr_valid_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32_t ip6_addr_pref_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”±ä»¥å¤ªç½‘è®¾å¤‡é©±åŠ¨ç¨‹åºè°ƒç”¨ï¼Œå°†æ•°æ®åŒ…ä¼ é€’ç»™ TCP/IP åè®®æ ˆ */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ ethernet_input() */</span>
    netif_input_fn input<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± IPv4 æ¨¡å—è°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¼šè§£æå¾—åˆ°ç¡¬ä»¶åœ°å€ï¼Œç„¶åå‘é€æ•°æ®åŒ… */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ etharp_output() */</span>
    netif_output_fn output<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± ARP æ¨¡å—è°ƒç”¨ï¼Œç”¨äºå®ç°åœ¨æ•°æ®é“¾è·¯å±‚å‘é€æ•°æ® */</span>
    netif_linkoutput_fn linkoutput<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± IPv6 æ¨¡å—è°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¼šè§£æå¾—åˆ°ç¡¬ä»¶åœ°å€ï¼Œç„¶åå‘é€æ•°æ®åŒ… */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ ethip6_output() */</span>
    netif_output_ip6_fn output_ip6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_STATUS_CALLBACK</span>
    <span class="token comment">/* å½“ç½‘å¡çŠ¶æ€è®¾ç½®ä¸º up æˆ–è€… down æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn status_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_LINK_CALLBACK</span>
    <span class="token comment">/* å½“ç½‘å¡çš„æ•°æ®é“¾è·¯è®¾ç½®ä¸º up æˆ–è€… down æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn link_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_REMOVE_CALLBACK</span>
    <span class="token comment">/* å½“ç½‘å¡è¢«ç§»é™¤æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn remove_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_REMOVE_CALLBACK */</span>
    <span class="token comment">/* ç”¨äºå°†ç½‘å¡çš„ç§æœ‰æ•°æ®ä¼ é€’ç»™ä¸Šå±‚ */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> netif_get_client_data</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>client_data<span class="token punctuation">[</span>LWIP_NETIF_CLIENT_DATA_INDEX_MAX <span class="token operator">+</span> LWIP_NUM_NETIF_CLIENT_DATA<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_HOSTNAME</span>
    <span class="token comment">/* ç½‘å¡çš„ä¸»æœºåï¼Œè®¾ç½®ä¸º NULL ä¹Ÿåˆæ³• */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_HOSTNAME */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_CHECKSUM_CTRL_PER_NETIF</span>
    u16_t chksum_flags<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_CHECKSUM_CTRL_PER_NETIF*/</span>
    <span class="token comment">/* æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¯¹äºä»¥å¤ªç½‘ï¼Œä¸€èˆ¬è®¾ä¸º 1500 */</span>
    <span class="token comment">/* IP å±‚ä¼šæ ¹æ®è¯¥å­—æ®µæ¥å†³å®šæ˜¯å¦éœ€è¦å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç‰‡å¤„ç† */</span>
    u16_t mtu<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES</span>
    <span class="token comment">/* æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œç”± RA æ¥æ›´æ–° */</span>
    u16_t mtu6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span>
    <span class="token comment">/* æ•°æ®é“¾è·¯å±‚çš„ç¡¬ä»¶åœ°å€ */</span>
    u8_t hwaddr<span class="token punctuation">[</span>NETIF_MAX_HWADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* ç¡¬ä»¶åœ°å€é•¿åº¦ï¼Œä»¥å¤ªç½‘æ˜¯ 6 å­—èŠ‚ */</span>
    u8_t hwaddr_len<span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çŠ¶æ€ä¿¡æ¯æ ‡å¿—ä½ï¼ŒåŒ…æ‹¬ç½‘å¡åŠŸèƒ½ä½¿èƒ½ã€å¹¿æ’­ä½¿èƒ½ã€ARP ä½¿èƒ½ç­‰ */</span>
    u8_t flags<span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çš„åå­—ï¼Œè“ç‰™è®¾å¤‡çš„ç½‘å¡åå­—å¯ä»¥ä½¿ btï¼ŒWLAN è®¾å¤‡çš„åå­—å¯ä»¥æ˜¯ wl */</span>
    <span class="token comment">/* å¦‚æœç½‘å¡å…·æœ‰ç›¸åŒçš„åå­—ï¼Œéœ€è¦é€šè¿‡ num å­—æ®µæ¥è¿›ä¸€æ­¥åŒºåˆ† */</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çš„æ ‡å·ï¼Œå¯ç”¨æ¥æ ‡å¿—åŒç§ç±»å‹çš„ä¸åŒç½‘å¡ */</span>
    u8_t num<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_AUTOCONFIG</span>
    <span class="token comment">/* æ˜¯å¦ä½¿èƒ½ IPv6 è‡ªåŠ¨é…ç½® */</span>
    u8_t ip6_autoconfig_enabled<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_SEND_ROUTER_SOLICIT</span>
    <span class="token comment">/* å‰©ä½™å¾…å‘é€çš„è·¯ç”±è¯·æ±‚æ¶ˆæ¯çš„æ•°é‡ */</span>
    u8_t rs_count<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_SEND_ROUTER_SOLICIT */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> MIB2_STATS</span>
    <span class="token comment">/* é“¾è·¯ç±»å‹ */</span>
    u8_t link_type<span class="token punctuation">;</span>
    <span class="token comment">/* é¢„ä¼°çš„é“¾è·¯å±‚é€Ÿç‡ */</span>
    u32_t link_speed<span class="token punctuation">;</span>
    <span class="token comment">/* æœ€è¿‘ä¸€æ¬¡é“¾è·¯å±‚çŠ¶æ€å˜åŒ–çš„æ—¶é—´ï¼ˆå»ºç«‹æˆ–è€…æ–­å¼€é“¾æ¥ï¼‰*/</span>
    u32_t ts<span class="token punctuation">;</span>
    <span class="token comment">/* è®¡æ•°å™¨ */</span>
    <span class="token keyword">struct</span> <span class="token class-name">stats_mib2_netif_ctrs</span> mib2_counters<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* MIB2_STATS */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4 &amp;&amp; LWIP_IGMP</span>
    <span class="token comment">/* å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°æ¥å‘ä»¥å¤ªç½‘ MAC çš„ç»„æ’­è¿‡æ»¤è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤æ¡ç›® */</span>
    netif_igmp_mac_filter_fn igmp_mac_filter<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 &amp;&amp; LWIP_IGMP */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD</span>
    <span class="token comment">/* å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°æ¥å‘ä»¥å¤ªç½‘ MAC çš„ IPv6 ç»„æ’­è¿‡æ»¤è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤æ¡ç›® */</span>
    netif_mld_mac_filter_fn mld_mac_filter<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_USE_HINTS</span>
    <span class="token keyword">struct</span> <span class="token class-name">netif_hint</span> <span class="token operator">*</span>hints<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_USE_HINTS */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ENABLE_LOOPBACK</span>
    <span class="token comment">/* å¾…å‘é€ç»™è‡ªå·±çš„æ•°æ®åŒ…åˆ—è¡¨ */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_first<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_last<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_LOOPBACK_MAX_PBUFS</span>
    u16_t loop_cnt_current<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_LOOPBACK_MAX_PBUFS */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ENABLE_LOOPBACK */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><h3 id="netif-add-å‡½æ•°"><a href="#netif-add-å‡½æ•°" aria-hidden="true" class="header-anchor">#</a> netif_add å‡½æ•°</h3> <p>åœ¨è°ƒç”¨ <code>netif_add</code> å‡½æ•°ä¹‹å‰éœ€è¦åˆå§‹åŒ–ä¸»æœºçš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œç½‘å…³ç­‰ä¿¡æ¯ï¼š</p> <p><code>IP4_ADDR(&amp;ipaddr,192,168,1,100)</code></p> <p><code>ip_addr_set_zero_ip4(&amp;ipaddr)</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * @brief å‘ LwIP ä¸­æ·»åŠ æ–°çš„ç½‘å¡
 *
 * @param netifï¼šnetif ç»“æ„ä½“ï¼ˆè°ƒç”¨å‡½æ•°ä¹‹å‰éœ€è¦ä¸ºè¯¥ç»“æ„ä½“åˆ†é…å¥½å†…å­˜ï¼‰
 * @param ipaddrï¼šè¯¥ç½‘å¡çš„ IP åœ°å€
 * @param netmaskï¼šè¯¥ç½‘å¡çš„å­ç½‘æ©ç 
 * @param gwï¼šè¯¥ç½‘å¡çš„é»˜è®¤ç½‘å…³
 * @param stateï¼š è¯¥ç½‘å¡çš„ç§æœ‰æ•°æ®ï¼ˆLwIP æ— æ³•å¾—çŸ¥è¯¥æ•°æ®çš„å…·ä½“å«ä¹‰ï¼‰
 * @param initï¼šåˆå§‹åŒ–è¯¥ç½‘å¡æ—¶çš„å›è°ƒå‡½æ•°
 * @param inputï¼š å°†æ•°æ®åŒ…ä¼ é€’ç»™ LwIP ä¸Šå±‚åè®®çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰æ“ä½œç³»ç»Ÿï¼Œå»ºè®®ä½¿ç”¨ netif_inputï¼Œå®ƒä¼šå°†æ•°æ®åŒ…ç›´æ¥ä¼ ç»™åè®®æ ˆï¼›å¦‚æœæœ‰æ“ä½œç³»ç»Ÿï¼Œå»ºè®®ä½¿ç”¨ tcpip_inputï¼Œå®ƒä¼šå‘ TCPIP çº¿ç¨‹å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¼šæ ¹æ®ç½‘å¡çš„ NETIF_FLAG_ETHARP å’Œ NETIF_FLAG_ETHERNET æ ‡å¿—æ¥å†³å®šå°†æ•°æ®åŒ…è½¬å‘ç»™ ethernet_input å‡½æ•°è¿˜æ˜¯ ip_input å‡½æ•°ã€‚
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span> <span class="token function">netif_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
          <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>netmask<span class="token punctuation">,</span> <span class="token keyword">const</span> ip4_addr_t <span class="token operator">*</span>gw<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">,</span> netif_init_fn init<span class="token punctuation">,</span> netif_input_fn input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
  s8_t i<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SINGLE_NETIF</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif_default <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;single netif already set&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: invalid netif&quot;</span><span class="token punctuation">,</span> netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: No init function given&quot;</span><span class="token punctuation">,</span> init <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipaddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ipaddr <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netmask <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netmask <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gw <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gw <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* æ¸…ç©ºç½‘å¡ä¹‹å‰çš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ç­‰å­—æ®µçš„ä¿¡æ¯ */</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>output <span class="token operator">=</span> netif_null_output_ip4<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ip_addr_set_zero_ip6</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip6_addr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_INVALID<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_ADDRESS_LIFETIMES</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_valid_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_pref_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span>
  <span class="token punctuation">}</span>
  netif<span class="token operator">-&gt;</span>output_ip6 <span class="token operator">=</span> netif_null_output_ip6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
  <span class="token function">NETIF_SET_CHECKSUM_CTRL</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> NETIF_CHECKSUM_ENABLE_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>mtu <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> netif_get_client_data</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NUM_NETIF_CLIENT_DATA */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_AUTOCONFIG</span>
  <span class="token comment">/* é»˜è®¤ä¸ä¼šè‡ªåŠ¨é…ç½® IPv6 åœ°å€ */</span>
  netif<span class="token operator">-&gt;</span>ip6_autoconfig_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span>
  <span class="token function">nd6_restart_netif</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_STATUS_CALLBACK</span>
  netif<span class="token operator">-&gt;</span>status_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_LINK_CALLBACK</span>
  netif<span class="token operator">-&gt;</span>link_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IGMP</span>
  netif<span class="token operator">-&gt;</span>igmp_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IGMP */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD</span>
  netif<span class="token operator">-&gt;</span>mld_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ENABLE_LOOPBACK</span>
  netif<span class="token operator">-&gt;</span>loop_first <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>loop_last <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ENABLE_LOOPBACK */</span>

  <span class="token comment">/* è®°å½•ç½‘å¡çš„ä¿¡æ¯ */</span>
  netif<span class="token operator">-&gt;</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> netif_num<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>

  <span class="token function">NETIF_RESET_HINTS</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ENABLE_LOOPBACK &amp;&amp; LWIP_LOOPBACK_MAX_PBUFS</span>
  netif<span class="token operator">-&gt;</span>loop_cnt_current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ENABLE_LOOPBACK &amp;&amp; LWIP_LOOPBACK_MAX_PBUFS */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
  <span class="token comment">/* è®¾ç½®ç½‘å¡çš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ */</span>
  <span class="token function">netif_set_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ipaddr<span class="token punctuation">,</span> netmask<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>

  <span class="token comment">/* è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘å¡åˆå§‹åŒ–å‡½æ•° */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span> <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES</span>
  <span class="token comment">/* Initialize the MTU for IPv6 to the one set by the netif driver.
     This can be updated later by RA. */</span>
  netif<span class="token operator">-&gt;</span>mtu6 <span class="token operator">=</span> netif<span class="token operator">-&gt;</span>mtu<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span>

<span class="token comment">/* ä¸ºå½“å‰ç½‘å¡ç¡®å®šå”¯ä¸€çš„ num */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> !LWIP_SINGLE_NETIF</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num_netifs<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      num_netifs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>netif2 <span class="token operator">=</span> netif_list<span class="token punctuation">;</span> netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> netif2 <span class="token operator">=</span> netif2<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;netif already added&quot;</span><span class="token punctuation">,</span> netif2 <span class="token operator">!=</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_netifs<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;too many netifs, max. supported number is 255&quot;</span><span class="token punctuation">,</span> num_netifs <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>netif2<span class="token operator">-&gt;</span>num <span class="token operator">==</span> netif<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          netif<span class="token operator">-&gt;</span>num<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">254</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token punctuation">(</span>u8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* å°†å½“å‰ç½‘å¡æ’å…¥åˆ°å…¨å±€çš„ netif_list é“¾è¡¨ä¸­ï¼Œæ’å…¥æ–¹å¼ï¼šå¤´æ’ */</span>
  netif<span class="token operator">-&gt;</span>next <span class="token operator">=</span> netif_list<span class="token punctuation">;</span>
  netif_list <span class="token operator">=</span> netif<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* &quot;LWIP_SINGLE_NETIF */</span>
  <span class="token function">mib2_netif_added</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IGMP</span>
  <span class="token comment">/* IGMP å¼€å§‹å·¥ä½œ */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> NETIF_FLAG_IGMP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">igmp_start</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IGMP */</span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;netif: added interface %c%c IP&quot;</span><span class="token punctuation">,</span>
                            netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; addr &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; netmask &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; gw &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">netif_invoke_ext_callback</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> LWIP_NSC_NETIF_ADDED<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> netif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br></div></div><h3 id="åˆå§‹åŒ–-lwip-çš„ä¸€èˆ¬æµç¨‹"><a href="#åˆå§‹åŒ–-lwip-çš„ä¸€èˆ¬æµç¨‹" aria-hidden="true" class="header-anchor">#</a> åˆå§‹åŒ– LwIP çš„ä¸€èˆ¬æµç¨‹</h3> <p><img src="/blog/assets/img/setup_lwip.c67664dc.png" alt="åˆå§‹åŒ– LwIP"></p> <h2 id="lwip-çš„å†…å­˜ç®¡ç†"><a href="#lwip-çš„å†…å­˜ç®¡ç†" aria-hidden="true" class="header-anchor">#</a> LwIP çš„å†…å­˜ç®¡ç†</h2> <p>LwIP çš„å†…å­˜ç®¡ç†æœºåˆ¶å¤§è‡´ä¸Šå¯ä»¥åˆ†æˆä¸‰ç§ï¼š</p> <ol><li>C æ ‡å‡†åº“è‡ªå¸¦çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼ˆå³ä½¿ç”¨ mallocã€freeç­‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çš„<strong>æ‰§è¡Œæ—¶é—´æ˜¯ä¸ç¡®å®šçš„</strong>ï¼‰</li> <li>LwIP çš„åŠ¨æ€å†…å­˜å †åˆ†é…ç­–ç•¥</li> <li>LwIP çš„åŠ¨æ€å†…å­˜æ± åˆ†é…ç­–ç•¥</li></ol> <div class="tip custom-block"><p class="custom-block-title">LwIP ä½¿ç”¨åŠ¨æ€å†…å­˜æ± çš„åŸå› </p> <p>LwIP ä¸­æœ‰å¾ˆå¤šå›ºå®šçš„æ•°æ®ç»“æ„ç©ºé—´ï¼Œæ¯”å¦‚ TCP é¦–éƒ¨ï¼ŒUDP é¦–éƒ¨ï¼ŒIP é¦–éƒ¨ï¼ŒEthernet é¦–éƒ¨ç­‰ã€‚é‡‡ç”¨å†…å­˜æ± ç­–ç•¥åˆ†é…è¿™äº›å›ºå®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥å¤§å¤§æå‡æ•ˆç‡ï¼Œè¿˜ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p></div> <p><img src="https://s1.ax1x.com/2018/08/01/PwhSgK.png" alt="LwIPå†…å­˜ç®¡ç†"></p> <ul><li>å°†MEM_LIBC_MALLOCè®¾ç½®ä¸º1ï¼Œè¡¨æ˜ä½¿ç”¨æ ‡å‡†Cåº“è‡ªå¸¦çš„å†…å­˜åˆ†é…ç­–ç•¥</li> <li>å°†MEMP_MEM_MALLOCè®¾ç½®ä¸º1ï¼Œè¡¨æ˜ä½¿ç”¨LwIPè‡ªå·±çš„åŠ¨æ€å†…å­˜å †åˆ†é…ç­–ç•¥</li> <li>LwIPè¿˜æ”¯æŒå†…å­˜æ± ï¼Œä¸è¿‡åœ¨ESP-IDFä¸­å¹¶æ²¡æœ‰è¢«ä½¿èƒ½ã€‚ç›¸è¾ƒäºå†…å­˜å †çš„åŠ¨æ€åˆ†é…ï¼Œå†…å­˜æ± æ•ˆç‡æ›´é«˜ï¼Œç¢ç‰‡å°‘ï¼Œä½†æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜</li></ul> <h2 id="ç½‘ç»œæ•°æ®åŒ…"><a href="#ç½‘ç»œæ•°æ®åŒ…" aria-hidden="true" class="header-anchor">#</a> ç½‘ç»œæ•°æ®åŒ…</h2> <blockquote><p>LwIPçš„ç¼“å†²ç®¡ç†æœºåˆ¶çš„åŠŸèƒ½æ˜¯å°½é‡é¿å…å†…å­˜æ‹·è´ï¼Œå°½é‡è¾ƒå°‘å¯¹å†…å­˜å’Œç©ºé—´çš„éœ€æ±‚ï¼Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚LwIPä½¿ç”¨æ•°æ®ç»“æ„pbufæ¥æè¿°å†…å­˜çš„ç¼“å†²æ•°æ®åŒ…ã€‚</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/01/Pw4Mz6.png" alt="pbufç»“æ„ä½“"></p> <ul><li>ç”±äºå®é™…å‘é€æˆ–æ¥æ”¶çš„æ•°æ®åŒ…é•¿åº¦ä¸ä¸€ï¼Œè€Œæ¯ä¸ªpbufåªèƒ½ç®¡ç†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå› æ­¤å¯¹äºå¤§å®¹é‡çš„æ•°æ®åŒ…ï¼Œå°±å¿…é¡»ä½¿ç”¨å¤šä¸ªpbufæ‰èƒ½å®Œæ•´åœ°æè¿°å®ƒ</li> <li>typeè¡¨æ˜äº†è¯¥pbufçš„ç±»å‹ï¼Œç›®å‰LwIPå®šä¹‰äº†å››ç§ç±»å‹çš„pbufï¼Œåˆ†åˆ«æ˜¯ï¼š<code>PBUF_RAM</code>ï¼Œ<code>PBUF_ROM</code>ï¼Œ<code>PBUF_REF</code>ï¼Œ<code>PBUF_POOL</code></li></ul> <p><img src="https://s1.ax1x.com/2018/08/01/Pw4RWq.png" alt="pbufç±»å‹å®šä¹‰"></p> <ul><li>PBUF_RAMç±»å‹çš„pbufæ˜¯é€šè¿‡å†…å­˜å †åˆ†é…å¾—åˆ°çš„ï¼ŒLwIPåè®®æ ˆå’Œåº”ç”¨ç¨‹åºè¦ä¼ é€’çš„æ•°æ®ä¸€èˆ¬éƒ½ä½¿ç”¨è¯¥ç±»å‹çš„pbufã€‚</li> <li>PBUF_POOLç±»å‹çš„pbufæ˜¯é€šè¿‡å†…å­˜æ± åˆ†é…å¾—åˆ°çš„ï¼Œç”±äºåˆ†é…æ­¤ç±»å‹çš„pbufå¯ä»¥å¿«é€Ÿå®Œæˆï¼Œé€‚åˆä¸­æ–­å¤„ç†ï¼Œå› æ­¤å®ƒæ›´å¤šåœ°åº”ç”¨åœ¨ç½‘ç»œè®¾å¤‡é©±åŠ¨å±‚ã€‚</li> <li>PBUF_REFå’ŒPBUF_ROMç±»å‹çš„pbufåŸºæœ¬ç›¸åŒï¼Œä»–ä»¬éƒ½æ˜¯ä»å†…å­˜æ± ä¸­ç”³è¯·åˆ†é…pbufç»“æ„é¦–éƒ¨ç©ºé—´ï¼Œè€Œä¸ç”³è¯·æ•°æ®åŒºçš„ç©ºé—´ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…æŒ‡å‘RAMç©ºé—´å†…çš„æŸæ®µæ•°æ®ï¼Œåè€…æŒ‡å‘ROMç©ºé—´å†…çš„æŸæ®µæ•°æ®ã€‚</li></ul> <p><img src="https://s1.ax1x.com/2018/08/10/P63kMq.png" alt="pbufç»“æ„"></p> <h3 id="pbufç®¡ç†api"><a href="#pbufç®¡ç†api" aria-hidden="true" class="header-anchor">#</a> pbufç®¡ç†API</h3> <blockquote><p>å½“ä½¿ç”¨Netconn APIæ—¶ï¼Œåˆ™ä½¿ç”¨netbufï¼ˆç½‘ç»œç¼“å†²ï¼‰å‘é€/æ¥æ”¶æ•°æ®ï¼Œnetbufåªæ˜¯pbufç»“æ„çš„å°è£…ï¼Œå®ƒå¯å®¹çº³åˆ†é…çš„æˆ–å¼•ç”¨çš„æ•°æ®ã€‚</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61IaD.png" alt="pbufç®¡ç†API"></p> <h2 id=""><a href="#" aria-hidden="true" class="header-anchor">#</a></h2> <div class="warning custom-block"><p class="custom-block-title">HTTP åè®®åœ¨ç‰©è”ç½‘ç³»ç»Ÿä¸­çš„åŠ£åŠ¿</p> <ol><li>HTTP æ˜¯ä¸€ç§åŒæ­¥åè®®ï¼Œå®¢æˆ·ç«¯éœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„å“åº”æ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥å·¥ä½œï¼ˆåœ¨å®¢æˆ·ç«¯æ•°é‡å¤šã€ç½‘ç»œä¸å¯é çš„åœºæ™¯ä¸‹ï¼Œå®ç°åŒæ­¥é€šä¿¡å¾ˆå›°éš¾ï¼‰</li> <li>HTTP æ˜¯å•å‘çš„ï¼Œå®¢æˆ·ç«¯åªèƒ½ä¸»åŠ¨å‘æœåŠ¡å™¨å‘å‡ºæ•°æ®ï¼Œæ— æ³•è¢«åŠ¨æ¥æ”¶æ¥è‡ªç½‘ç»œçš„æ•°æ®ï¼ˆä¸é€‚ç”¨äºå®æ—¶æ§åˆ¶çš„åœºåˆï¼‰</li> <li>HTTP æœ‰è®¸å¤šå¸§å¤´å’Œè§„åˆ™ï¼Œæ˜¯ä¸€ç§é‡é‡çº§çš„åè®®ï¼ˆå®ç°åœ¨ç‰©è”ç½‘è®¾å¤‡ä¸­éœ€è¦è€—è´¹å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼‰</li></ol></div> <h2 id="lwipæ¶æ„"><a href="#lwipæ¶æ„" aria-hidden="true" class="header-anchor">#</a> LwIPæ¶æ„</h2> <p><img src="https://s1.ax1x.com/2018/08/09/PyrZkR.png" alt="LwIPæ¶æ„"></p> <h2 id="è¿›ç¨‹æ¨¡å‹"><a href="#è¿›ç¨‹æ¨¡å‹" aria-hidden="true" class="header-anchor">#</a> è¿›ç¨‹æ¨¡å‹</h2> <blockquote><p>è¿›ç¨‹æ¨¡å‹æ˜¯æŒ‡TCP/IPåè®®æ ˆçš„å„åè®®å…¥IPåè®®ã€TCPåè®®ã€ICMPåè®®ç­‰æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p></blockquote> <ul><li>TCP/IPåè®®æ ˆçš„æ¯ä¸ªåè®®éƒ½é€šè¿‡ä¸€ä¸ªä¸åŒçš„è¿›ç¨‹å®ç°ã€‚åœ¨è¯¥æ¨¡å‹ä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ä¸¥æ ¼åœ°ä¸ä¸€ä¸ªåè®®ç›¸å¯¹åº”ã€‚è¿™ç§è¿›ç¨‹æ¨¡å‹çš„ä¼˜ç‚¹æ˜¯ç½‘ç»œåè®®çš„æ¯ä¸€å±‚éƒ½å¾ˆæ¸…æ™°ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥éšæ—¶å‚ä¸ç³»ç»Ÿè¿è¡Œã€‚è¯¥æ¨¡å‹çš„ç¼ºç‚¹æ˜¯è¿›ç¨‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¾ƒé¢‘ç¹ï¼Œç³»ç»Ÿå°†ä¸ºé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»˜å‡ºè¾ƒå¤§çš„ä»£ä»·ã€‚</li> <li>TCP/IPåè®®æ ˆé©»ç•™åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¸­ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¸TCP/IPåè®®æ ˆé€šä¿¡ã€‚è¯¥æ¨¡å‹ä¸‹ï¼Œå„åè®®æ ˆå¹¶éä¸¥æ ¼åœ°ä¸ä¸€ä¸ªè¿›ç¨‹ç›¸å¯¹åº”ã€‚</li> <li>TCP/IPåè®®æ ˆé©»ç•™åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œç‹¬ç«‹äºæ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´ã€‚LwIPé‡‡ç”¨æ­£æ˜¯è¿™ç§æ–¹å¼ï¼ŒLwIPä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´å†…ï¼Œå…¶ä¼˜ç‚¹æ˜¯å¯ä»¥æ–¹ä¾¿åœ°ç§»æ¤åˆ°ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­è¿è¡Œã€‚</li></ul> <h2 id="arpå¤„ç†"><a href="#arpå¤„ç†" aria-hidden="true" class="header-anchor">#</a> ARPå¤„ç†</h2> <blockquote><p>ARPåè®®æ˜¯TCP/IPåè®®çš„åŸºç¡€ï¼Œæœ¬è´¨æ˜¯å®ç°IPåœ°å€ä¸åº•å±‚ç‰©ç†åœ°å€çš„ç›¸äº’è½¬æ¢ã€‚ARPåè®®çš„æ ¸å¿ƒæ˜¯ARPç¼“å­˜è¡¨ï¼Œè€ŒARPåè®®çš„å®è´¨å°±æ˜¯å¯¹ç¼“å­˜è¡¨çš„å»ºç«‹ã€æ›´æ–°ã€æŸ¥è¯¢ç­‰æ“ä½œã€‚ARPç¼“å­˜è¡¨æ˜¯ç”±è‹¥å¹²ç¼“å­˜è¡¨é¡¹ç»„æˆï¼Œåœ¨LwIPä¸­ï¼Œæè¿°ç¼“å­˜è¡¨é¡¹çš„æ•°æ®ç»“æ„å«etharp_entryã€‚</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/02/P0CQUA.png" alt="ARPåè®®æ•°æ®åŒ…æ ¼å¼"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ARP_QUEUEING</span>
  <span class="token comment">/** Pointer to queue of pending outgoing packets on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* ARP_QUEUEING */</span>
  <span class="token comment">/** Pointer to a single pending outgoing packet on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ARP_QUEUEING */</span>
  ip4_addr_t ipaddr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethaddr<span class="token punctuation">;</span>
  u16_t ctime<span class="token punctuation">;</span>
  u8_t state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>ipaddrå­˜æ”¾IPåœ°å€ï¼Œethaddrå­˜æ”¾ç‰©ç†åœ°å€ï¼Œstateè¡¨ç¤ºç¼“å­˜é¡¹çš„çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯å¦ç¨³å®šï¼‰ï¼Œctimeè®°å½•ARPç¼“å­˜é¡¹å¤„äºæŸä¸ªçŠ¶æ€çš„æ—¶é—´ï¼Œå½“æŸè¡¨é¡¹çš„ctimeå€¼å¤§äºè§„å®šçš„è¡¨é¡¹æœ€å¤§ç”Ÿå­˜å€¼æ—¶ï¼ŒLwIPå†…æ ¸ä¼šåˆ é™¤è¯¥è¡¨é¡¹ã€‚å› æ­¤ä½¿ç”¨ARPåŠŸèƒ½æ—¶ï¼Œå¿…é¡»è®¾ç½®ä¸€ä¸ªARPè¶…æ—¶äº‹ä»¶ï¼Œè¯¥è¶…æ—¶äº‹ä»¶çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯å¯¹æ¯ä¸ªè¡¨é¡¹çš„ctimeå­—æ®µå€¼åŠ 1ï¼Œç„¶ååˆ é™¤é‚£äº›ç”Ÿå­˜æ—¶é—´å¤§äºæœ€å¤§ç”Ÿå­˜å€¼çš„è¡¨é¡¹</li></ul> <p><img src="https://s1.ax1x.com/2018/08/02/P0PcWt.jpg" alt="ARPå¤„ç†æµç¨‹"></p> <ul><li>å‡½æ•°ethernet_inputæ ¹æ®æŠ¥æ–‡é¦–éƒ¨çš„å¸§ç±»å‹å­—æ®µåˆ¤æ–­æ¥æ”¶åˆ°çš„æŠ¥æ–‡ç±»å‹ï¼Œå¦‚æœæ˜¯IPåŒ…ï¼Œåˆ™å°†è¯¥åŒ…ä¼ é€’ç»™etharp_ip_inputï¼Œå¦‚æœæ˜¯ARPåŒ…ï¼Œåˆ™å°†è¯¥åŒ…é€’äº¤ç»™etharp_arp_input</li> <li>å‡½æ•°etharp_ip_inputè°ƒç”¨å‡½æ•°update_arp_entryï¼Œå®ƒæ˜¯å°†æŠ¥æ–‡é¦–éƒ¨çš„MACåœ°å€å’ŒIPåœ°å€æ›´æ–°åˆ°ARPç¼“å­˜ä¸­</li> <li>å‡½æ•°etharp_arp_inputé¦–å…ˆåˆ¤æ–­æ¥æ”¶åˆ°çš„ARPæ•°æ®åŒ…çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ARPè¯·æ±‚åŒ…ï¼Œé‚£ä¹ˆé¦–å…ˆåˆ¤æ–­è¿™ä¸ªåŒ…æ˜¯å¦æ˜¯ç»™è‡ªå·±çš„ï¼Œå¦‚æœæ˜¯ç»™è‡ªå·±çš„ï¼Œå°±åœ¨åŸæœ‰åŒ…çš„åŸºç¡€ä¸Šé‡ç»„ä¸€ä¸ªARPåº”ç­”åŒ…å‘é€å‡ºå»ï¼›å¦‚æœä¸æ˜¯ç»™è‡ªå·±çš„ï¼Œåˆ™ç›´æ¥å¿½ç•¥è€Œå¦‚æœæ¥æ”¶åˆ°çš„æ•°æ®åŒ…æ˜¯ARPåº”ç­”åŒ…ï¼Œé‚£ä¹ˆå°±è°ƒç”¨update_arp_entryæ›´æ–°ARPç¼“å­˜è¡¨</li></ul> <h2 id="ipå¤„ç†"><a href="#ipå¤„ç†" aria-hidden="true" class="header-anchor">#</a> IPå¤„ç†</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0CUbQ.png" alt="IPåè®®æ•°æ®åŒ…æ ¼å¼"></p> <h4 id="lwipè½¯ä»¶å¤§è‡´æ¡†æ¶"><a href="#lwipè½¯ä»¶å¤§è‡´æ¡†æ¶" aria-hidden="true" class="header-anchor">#</a> LwIPè½¯ä»¶å¤§è‡´æ¡†æ¶</h4> <p><img src="https://s1.ax1x.com/2018/08/02/P0keJA.jpg" alt="LwIPæ•´ä½“æ¡†æ¶å›¾"></p> <ul><li>ip_inputä¼šåšå„é¡¹æ£€æŸ¥ï¼ŒåŒ…æ‹¬åè®®ç‰ˆæœ¬å·ï¼ŒIPé¦–éƒ¨çš„æ ¡éªŒå€¼ï¼ŒæºIPåœ°å€æ˜¯å¦æœ‰æ•ˆç­‰ï¼Œç„¶åæ£€æµ‹IPæ•°æ®åŒ…ä¸­çš„ç›®çš„IPåœ°å€æ˜¯å¦ä¸æœ¬èŠ‚ç‚¹çš„IPåœ°å€ç›¸ç¬¦ï¼Œå¦‚æœæ˜¯æœ¬èŠ‚ç‚¹çš„IPåœ°å€ï¼Œåˆ™æ ¹æ®è¯¥IPæ•°æ®åŒ…é¦–éƒ¨çš„åè®®å­—æ®µåˆ¤æ–­è¯¥æ•°æ®åŒ…åº”è¯¥è¢«é€’äº¤åˆ°å“ªä¸ªä¸Šå±‚åè®®ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚å¦‚æœæ˜¯UDPåè®®ï¼Œåˆ™è°ƒç”¨udp_inputå‡½æ•°ï¼›å¦‚æœæ˜¯TCPåè®®ï¼Œåˆ™è°ƒç”¨tcp_inputå‡½æ•°ï¼›å¦‚æœæ˜¯ICMPåè®®ï¼Œåˆ™è°ƒç”¨icmp_inputå‡½æ•°ï¼›å¦‚æœæ˜¯IGMPåè®®ï¼Œåˆ™è°ƒç”¨igmp_inputå‡½æ•°ï¼›å¦‚æœéƒ½ä¸æ˜¯ï¼Œåˆ™è°ƒç”¨å‡½æ•°icmp_dest_unreachè¿”å›ä¸€ä¸ªåè®®ä¸å¯è¾¾ICMPæ•°æ®åŒ…ç»™æºä¸»æœºã€‚å¦‚æœä¸æ˜¯æœ¬èŠ‚ç‚¹çš„IPåœ°å€ï¼Œåˆ™é€šè¿‡è°ƒç”¨å‡½æ•°ip_forwardå¯¹æ•°æ®åŒ…è¿›è¡Œè½¬å‘ã€‚éœ€è¦æ³¨æ„ï¼Œç”±äºä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½å«æœ‰å¤šä¸ªIPåœ°å€ï¼Œå› æ­¤ip_inputå‡½æ•°ä¼šéå†ç½‘ç»œæ¥å£é“¾è¡¨netif_listä¸Šçš„netifç»“æ„å˜é‡ï¼Œæ¥æŸ¥æ‰¾ä¸IPæ•°æ®åŒ…ä¸­ç›¸åŒ¹é…çš„IPåœ°å€ã€‚</li> <li>ip_outputä½¿ç”¨ip_routeå‡½æ•°æŸ¥æ‰¾ç›®æ ‡ç½‘ç»œæ¥å£netifæ¥å‘é€IPæ•°æ®åŒ…ã€‚å½“ç½‘ç»œæ¥å£netifç¡®å®šåï¼ŒIPæ•°æ®åŒ…é€šè¿‡å‡½æ•°ip_output_ifå‘é€å‡ºå»ã€‚è‹¥ip_routeæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç½‘ç»œæ¥å£ï¼Œåˆ™ä¸¢å¼ƒè¯¥æŠ¥æ–‡ï¼Œç»ˆæ­¢æœ¬æ¬¡å‘é€ã€‚å‡½æ•°ip_routeé€šè¿‡éå†ç½‘ç»œæ¥å£é“¾è¡¨netif_listï¼ŒæŸ¥æ‰¾ä¸ç›®çš„IIPåœ°å€åœ¨åŒä¸€ä¸ªå­ç½‘ä¸­çš„ç½‘ç»œæ¥å£ï¼Œå¹¶å°†è¯¥ç½‘ç»œæ¥å£è¿”å›ç»™å˜é‡netifã€‚</li></ul> <h2 id="icmpå¤„ç†"><a href="#icmpå¤„ç†" aria-hidden="true" class="header-anchor">#</a> ICMPå¤„ç†</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0AVmT.jpg" alt="ICMPåè®®æ•°æ®åŒ…æ ¼å¼"></p> <ul><li>icmp_inputåœ¨ip_inputä¸­è¢«è°ƒç”¨ï¼Œå®ƒå¤„ç†æ¥æ”¶åˆ°çš„ICMPæ•°æ®åŒ…ï¼Œå¹¶æ ¹æ®åŒ…ç±»å‹åšç›¸åº”çš„å¤„ç†ã€‚åœ¨LwIPåè®®æ ˆä¸­ï¼Œå®ƒåªå¤„ç†ICMPå›æ˜¾è¯·æ±‚åŒ…ï¼Œå¯¹å…¶ä»–ç±»å‹çš„ICMPåŒ…ä¸ä½œå“åº”ã€‚icmp_inputåœ¨å¤„ç†ICMPå›æ˜¾è¯·æ±‚æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­è¯¥æ•°æ®åŒ…æ˜¯å¦ä¸ºå¹¿æ’­æˆ–è€…ç»„æ’­åŒ…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­å¤„ç†ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™ç»§ç»­åˆ¤æ–­è¯¥æ•°æ®åŒ…é•¿åº¦æ˜¯å¦å°äºICMPå›æ˜¾è¯·æ±‚å¤´éƒ¨é•¿åº¦ï¼Œå¦‚æœæ˜¯åˆ™ä¸¢å¼ƒæ•°æ®åŒ…ï¼›å¦‚æœä¸æ˜¯åˆ™å°†è¯¥ICMPæŠ¥æ–‡ç±»å‹å­—æ®µå˜ä¸º0ï¼Œé‡æ–°è®¡ç®—æ ¡éªŒå’Œï¼Œå¹¶å°†IPæŠ¥æ–‡é¦–éƒ¨çš„æºIPåœ°å€å’Œç›®çš„IPåœ°å€äº¤æ¢ä½ç½®ï¼Œå¹¶é€šè¿‡è°ƒç”¨å‡½æ•°ip_output_ifå°†æ•°æ®åŒ…å‘é€å‡ºå»ã€‚</li> <li>å‡½æ•°icmp_dest_unreachåœ¨ip_inputã€udp_inputä¸­è¢«è°ƒç”¨ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•°icmp_send_responseå‘é€ä¸€ä¸ªâ€œç›®çš„ä¸å¯åˆ°è¾¾â€ç±»å‹çš„icmpæŠ¥æ–‡ã€‚åœ¨å‡½æ•°ip_inputä¸­ï¼Œå½“æ‰€æ¥æ”¶çš„IPæŠ¥æ–‡åè®®å­—æ®µä¸å¯è¯†åˆ«æ—¶ï¼Œicmp_dest_unreachå°±è¢«è°ƒç”¨ã€‚è€Œåœ¨UDPå¤„ç†å™¨ä¸­ï¼Œè‹¥ä¸èƒ½æ‰¾åˆ°ä¸æ¥æ”¶çš„æŠ¥æ–‡ç›¸å¯¹åº”çš„ç«¯å£å·ï¼Œåˆ™icmp_dest_unreachä¹Ÿå°†è¢«è°ƒç”¨ã€‚</li> <li>å‡½æ•°icmp_time_exceededåœ¨ip_forwardä¸­è¢«è°ƒç”¨ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•°icmp_send_responseå‘é€ä¸€ä¸ªâ€œè¶…æ—¶â€ç±»å‹çš„ICMPæŠ¥æ–‡ã€‚åœ¨å‡½æ•°ip_forwardä¸­ï¼Œå½“TTLå‡å°ä¸º0æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°ã€‚</li></ul> <h2 id="udpå¤„ç†"><a href="#udpå¤„ç†" aria-hidden="true" class="header-anchor">#</a> UDPå¤„ç†</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JfdH.png" alt="UDPåè®®æ•°æ®åŒ…"></p> <ul><li>å‡½æ•°udp_inputå°†æ£€æŸ¥æŠ¥æ–‡çš„UDPæ ¡éªŒï¼Œæœ€ç»ˆè°ƒç”¨å‡½æ•°recvï¼Œå°†æ”¶åˆ°çš„æŠ¥æ–‡ä¼ é€’ç»™åº”ç”¨å±‚ç¨‹åº</li> <li>å½“åº”ç”¨å±‚ç¨‹åºè¦é€šè¿‡UDPåè®®å‘å¤–å‘é€IPæŠ¥æ–‡æ—¶ï¼Œå°†é€šè¿‡è°ƒç”¨å‡½æ•°udp_sendå®ç°ï¼Œå‡½æ•°udp_sendé€šè¿‡è°ƒç”¨IPå±‚çš„å‡½æ•°ip_output_ifå®ç°æŠ¥æ–‡çš„å‘é€</li> <li>LwIPä½¿ç”¨é“¾è¡¨ç»“æ„ä½“udp_pcbæ¥ä¿å­˜æ¯ä¸€ä¸ªUDPä¼šè¯çš„çŠ¶æ€</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token punctuation">{</span>
<span class="token comment">/* Common members of all PCB types */</span>
  IP_PCB<span class="token punctuation">;</span>

<span class="token comment">/* Protocol specific PCB members */</span>

  <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  u8_t flags<span class="token punctuation">;</span>
  <span class="token comment">/** ports are in host byte order */</span>
  u16_t local_port<span class="token punctuation">,</span> remote_port<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_MULTICAST_TX_OPTIONS</span>
  <span class="token comment">/** outgoing network interface for multicast packets */</span>
  ip_addr_t multicast_ip<span class="token punctuation">;</span>
  <span class="token comment">/** TTL for outgoing multicast packets */</span>
  u8_t mcast_ttl<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_MULTICAST_TX_OPTIONS */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_UDPLITE</span>
  <span class="token comment">/** used for UDP_LITE only */</span>
  u16_t chksum_len_rx<span class="token punctuation">,</span> chksum_len_tx<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_UDPLITE */</span>

  <span class="token comment">/** receive callback function */</span>
  udp_recv_fn recv<span class="token punctuation">;</span>
  <span class="token comment">/** user-supplied argument for the recv callback */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>recv_arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="tcpå¤„ç†"><a href="#tcpå¤„ç†" aria-hidden="true" class="header-anchor">#</a> TCPå¤„ç†</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JULF.png" alt="TCPåè®®æ•°æ®åŒ…"></p> <ul><li>TCPçš„æ»‘åŠ¨çª—å£åè®®æ˜¯ç”¨äºå®ç°æµé‡æ§åˆ¶çš„</li> <li>TCPçš„è¶…æ—¶å’Œé‡ä¼ æœºåˆ¶æé«˜äº†æ•°æ®ä¼ è¾“çš„å¯é æ€§</li> <li>æ‹¥å¡æ§åˆ¶æ˜¯é€šè¿‡æ…¢å¯åŠ¨ç®—æ³•å’Œæ‹¥å¡é¿å…ç®—æ³•æ¥å®ç°çš„</li> <li>LwIPä¸­å«æœ‰ä¸¤ä¸ªå®šæ—¶å™¨å‡½æ•°ï¼štcp_fasttmrå’Œtcp_slowtmrï¼Œtcp_fasttmræ¯250msè°ƒç”¨ä¸€æ¬¡ï¼Œtcp_slowtmræ¯500msè°ƒç”¨ä¸€æ¬¡ã€‚å¿«é€Ÿå®šæ—¶å™¨ä¸»è¦åšä¸¤ä¸ªæ–¹é¢çš„äº‹æƒ…ï¼šå‘ä¸Šå±‚é€’äº¤ä¸Šå±‚ä¸€ç›´æœªæ¥æ”¶çš„æ•°æ®ï¼ŒäºŒæ˜¯å‘é€è¯¥è¿æ¥ä¸Šçš„å»¶è¿ŸACKè¯·æ±‚æ•°æ®æ®µã€‚æ…¢é€Ÿå®šæ—¶å™¨å‚ä¸äº†è¾ƒå¤šåŠŸèƒ½ï¼Œå¦‚è¶…æ—¶ä¸é‡ä¼ ã€æ‹¥å¡æ§åˆ¶ç­‰ã€‚</li></ul> <h2 id="lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£"><a href="#lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£" aria-hidden="true" class="header-anchor">#</a> LwIP çš„ä¸‰ç§ç¼–ç¨‹æ¥å£</h2> <div class="tip custom-block"><p class="custom-block-title">RAW/Callback API</p> <p>ç›´æ¥è°ƒç”¨åè®®æ ˆå„æ¨¡å—çš„å‡½æ•°ï¼ˆå®ƒä»¬æ˜¯ä½¿ç”¨<strong>å›è°ƒå‡½æ•°</strong>çš„ API æ¥å£ï¼Œä¹Ÿç§°ä¸º RAW APIï¼‰ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>æ— éœ€æ“ä½œç³»ç»Ÿæ”¯æŒã€‚</li> <li>LwIP å†…æ ¸æŠŠæ•°æ®äº¤ç»™åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹åªæ˜¯ä¸€æ¬¡ç®€å•çš„ API è°ƒç”¨ï¼Œéå¸¸èŠ‚çœæ—¶é—´å’Œç©ºé—´ã€‚</li> <li>åº”ç”¨ç¨‹åºå’Œå†…æ ¸ç¨‹åºå¤„äºåŒä¸€çº¿ç¨‹ä¹‹ä¸­ï¼ŒèŠ‚çœäº†ä»»åŠ¡é—´é€šä¿¡å’Œä»»åŠ¡åˆ‡æ¢çš„å¼€é”€ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>åº”ç”¨ç¨‹åºçš„æ‰§è¡Œä¼šåˆ¶çº¦å†…æ ¸ç¨‹åºçš„æ‰§è¡Œï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºä¹‹é—´ä¹Ÿä¼šäº’ç›¸åˆ¶çº¦ã€‚åœ¨åº”ç”¨ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸ç¨‹åºå°†ä¸èƒ½å¾—åˆ°è¿è¡Œï¼Œè¿™ä¼šå½±å“ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†æ•ˆç‡ï¼Œä¸¥é‡åœ°è¿˜ä¼šé€ æˆæ•°æ®åŒ…å µå¡è€Œå‘ç”Ÿä¸¢åŒ…ç°è±¡ã€‚</li></ul></div> <div class="tip custom-block"><p class="custom-block-title">Netconn API</p> <p>ä½¿ç”¨ LwIP æä¾›çš„ä¸“ç”¨ APIï¼Œä¹Ÿç§°ä¸º Sequential APIï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹åŸºäº <strong>open-read-write-close</strong> æ¨¡å‹ã€‚Netconn API æ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„ IPC æœºåˆ¶å®ç°çš„ï¼Œå®ƒå°† LwIP å†…æ ¸ä»£ç å’Œç½‘ç»œåº”ç”¨ç¨‹åºåˆ†ç¦»æˆç‹¬ç«‹çš„çº¿ç¨‹ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>LwIP çº¿ç¨‹åªè´Ÿè´£æ•°æ®åŒ…çš„ TCP/IP å°è£…å’Œæ‹†å°ï¼Œä¸ç”¨è¿›è¡Œæ•°æ®çš„åº”ç”¨å±‚å¤„ç†ï¼Œæé«˜äº†ç³»ç»Ÿå¯¹ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†æ•ˆç‡ã€‚</li> <li>ç›¸è¾ƒäº Socket APIï¼ŒNetconn API é¿å…äº†å†…æ ¸ç¨‹åºå’Œç½‘ç»œåº”ç”¨ç¨‹åºä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œæé«˜äº†æ•°æ®ä¼ é€’çš„æ•ˆç‡ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>ä¾èµ–æ“ä½œç³»ç»Ÿã€‚</li> <li>å†…æ ¸ç¨‹åºå’Œç½‘ç»œåº”ç”¨ç¨‹åºä¹‹é—´çš„æ•°æ®åŒ…ä¼ é€’éœ€è¦ä¾é æ“ä½œç³»ç»Ÿçš„ä¿¡å·é‡å’Œé‚®ç®±æœºåˆ¶å®Œæˆï¼Œè€—è´¹äº†æ›´å¤šçš„æ—¶é—´å’Œå†…å­˜ã€‚</li></ul></div> <div class="tip custom-block"><p class="custom-block-title">BSD Socket API</p> <p>Socket å¯¹ç½‘ç»œè¿æ¥è¿›è¡Œäº†é«˜çº§çš„æŠ½è±¡ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥åƒæ“ä½œæ–‡ä»¶ä¸€æ ·æ“ä½œç½‘ç»œè¿æ¥ã€‚LwIP çš„ Socket API æ˜¯åŸºäº Netconn API å®ç°çš„ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>ä½¿ç”¨ Socket ç¼–å†™çš„ç½‘ç»œåº”ç”¨ç¨‹åºå…·æœ‰å¾ˆå¥½çš„å¯ç§»æ¤æ€§ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>Socket API åœ¨å†…æ ¸ç¨‹åºå’Œåº”ç”¨ç¨‹åºä¹‹é—´å­˜åœ¨æ•°æ®æ‹·è´ï¼Œé™ä½äº†æ•°æ®ä¼ é€’çš„æ•ˆç‡ã€‚</li></ul></div> <div class="warning custom-block"><p>LwIP å¹¶æ²¡æœ‰å®ç°å…¨éƒ¨çš„ BSD Socket APIã€‚</p></div> <h3 id="tcp-raw-api"><a href="#tcp-raw-api" aria-hidden="true" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6l7j0.png" alt="TCP RAW API"></p> <table><thead><tr><th>å‡½æ•°</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>struct tcp_pcb* tcp_new()</td> <td>æ–°å»ºtcpåè®®æ§åˆ¶å—</td></tr> <tr><td>ert_t tcp_bind(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port)</td> <td>ç»‘å®šæœ¬åœ°IPåœ°å€å’Œç«¯å£å·ï¼Œå¦‚æœipaddrä¸ºIP_ADDR_ANYï¼Œåˆ™å°†è¿æ¥ç»‘å®šåˆ°æ‰€æœ‰çš„æœ¬åœ°IPåœ°å€ä¸Š</td></tr> <tr><td>struct tcp_pcb* tcp_listen(struct tcp_pcb* pcb)</td> <td>ä½¿æŒ‡å®šçš„è¿æ¥å¼€å§‹è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œå¦‚æœç›‘å¬æˆåŠŸï¼Œå°±è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥æ§åˆ¶å—pcb</td></tr> <tr><td>void tcp_accepted(struct tcp_pcb* pcb)</td> <td>é€šçŸ¥LwIPä¸€ä¸ªæ–°æ¥çš„è¿æ¥å·²ç»è¢«æ¥æ”¶ï¼Œè¿™ä¸ªå‡½æ•°é€šå¸¸åœ¨ç”±tcp_acceptæŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­è¢«è°ƒç”¨</td></tr> <tr><td>void tcp_accept(struct tcp_pcb* pcb,err_t (*accept)(void* arg,struct tcp_pcb* newpcb,err_t err))</td> <td>æŒ‡å®šå¤„äºç›‘å¬çŠ¶æ€çš„è¿æ¥ï¼Œåœ¨æˆåŠŸå»ºç«‹è¿æ¥åè¦è°ƒç”¨çš„å›è°ƒæ–¹æ³•</td></tr> <tr><td>err_t tcp_connect(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port,err_t (* connected)(void* arg,struct tcp_pcb* tpcb,err_t err))</td> <td>è¯·æ±‚è¿æ¥åˆ°æ‰§è¡Œçš„è¿œç¨‹ä¸»æœº</td></tr> <tr><td>err_t tcp_write(struct tcp_pcb* pcb,void* dataptr,u16_t len,u8_t copy)</td> <td>å‘é€TCPæ•°æ®ï¼Œå°†è¦å‘é€çš„æ•°æ®æ”¾å…¥å‘é€é˜Ÿåˆ—ä¸­ï¼Œç”±åè®®æ ˆå†…æ ¸å‘é€ï¼Œcopyä¸º0åˆ™ä¸ä¼šä¸ºå‘é€çš„æ•°æ®åˆ†é…æ–°çš„å†…å­˜ç©ºé—´</td></tr> <tr><td>void tcp_sent(struct tcp_pcb* pcb,err_t (*sent)(void* arg,struct tcp_pcb* tpcb,u16_t len))</td> <td>æŒ‡å®šå½“è¿œç¨‹ä¸»æœºæˆåŠŸæ¥æ”¶æ•°æ®åï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨çš„å›è°ƒå‡½æ•°</td></tr> <tr><td>void tcp_recv(struct tcp_pcb* pcb,err_t (* recv)(void* arg,struct tcp_pcb* tpcb,struct pbuf* p,err_t err))</td> <td>æŒ‡å®šæ¥æ”¶æ•°æ®æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°</td></tr> <tr><td>void tcp_recved(struct tcp_pcb* pcb,u16_t len)</td> <td>ç”¨äºè·å–æ¥æ”¶åˆ°çš„æ•°æ®çš„é•¿åº¦ï¼Œå¿…é¡»åœ¨tcp_recvæŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­è¢«è°ƒç”¨</td></tr> <tr><td>err_t tcp_close(struct tcp_pcb* pcb)</td> <td>å…³é—­ä¸€ä¸ªæŒ‡å®šçš„TCPè¿æ¥ï¼Œè°ƒç”¨è¯¥å‡½æ•°åå°†ä¼šé‡Šæ”¾pcbæ§åˆ¶å—æ‰€å ç”¨çš„å†…å­˜ç©ºé—´</td></tr> <tr><td>void tcp_abort(struct tcp_pcb* pcb)</td> <td>ç»ˆæ­¢ä¸€ä¸ªæŒ‡å®šçš„è¿æ¥ï¼Œè°ƒç”¨è¯¥å‡½æ•°åï¼Œpcbæ§åˆ¶å—æ‰€å ç”¨çš„å†…å­˜ç©ºé—´å°†è¢«é‡Šæ”¾</td></tr> <tr><td>void tcp_err(struct tcp_pcb* pcb,void (*err)(void* arg,err_t err))</td> <td>æŒ‡å®šå¤„ç†é”™è¯¯çš„å›è°ƒå‡½æ•°</td></tr></tbody></table> <h3 id="tcp-raw-api-2"><a href="#tcp-raw-api-2" aria-hidden="true" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6lLHU.png" alt="UDP RAW API"></p> <h3 id="netconn-api"><a href="#netconn-api" aria-hidden="true" class="header-anchor">#</a> Netconn API</h3> <ul><li>æ•°æ®ç»“æ„netconnæè¿°äº†åº”ç”¨ç¨‹åºè¦ä½¿ç”¨APIå‡½æ•°æœºé‚£é‡Œä¸€ä¸ªè¿æ¥çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬äº†è¿æ¥çš„ç±»å‹ã€æœ€è¿‘çš„æ•…éšœä»£ç ã€å›è°ƒå‡½æ•°ç­‰ã€‚</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** A netconn descriptor */</span>
<span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token punctuation">{</span>
  <span class="token comment">/** type of the netconn (TCP, UDP or RAW) */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> type<span class="token punctuation">;</span>
  <span class="token comment">/** current state of the netconn */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_state</span> state<span class="token punctuation">;</span>
  <span class="token comment">/** the lwIP internal protocol control block */</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_pcb</span>  <span class="token operator">*</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tcp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>udp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span> <span class="token operator">*</span>raw<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> pcb<span class="token punctuation">;</span>
  <span class="token comment">/** the last error this netconn had */</span>
  err_t last_err<span class="token punctuation">;</span>
  
<span class="token macro property">#<span class="token directive keyword">if</span> !LWIP_NETCONN_SEM_PER_THREAD</span>
  <span class="token comment">/** sem that is used to synchronously execute functions in the core context */</span>
  sys_sem_t op_completed<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token comment">/** mbox where received packets are stored until they are fetched
      by the netconn application thread (can grow quite big) */</span>
  sys_mbox_t recvmbox<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_TCP</span>
  <span class="token comment">/** mbox where new connections are stored until processed
      by the application thread */</span>
  sys_mbox_t acceptmbox<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_TCP */</span>
  <span class="token comment">/** only used for socket layer */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SOCKET</span>
  <span class="token keyword">int</span> socket<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SOCKET */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_SNDTIMEO</span>
  <span class="token comment">/** timeout to wait for sending data (which means enqueueing data for sending
      in internal buffers) in milliseconds */</span>
  s32_t send_timeout<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVTIMEO */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_RCVTIMEO</span>
  <span class="token comment">/** timeout in milliseconds to wait for new data to be received
      (or connections to arrive for listening netconns) */</span>
  <span class="token keyword">int</span> recv_timeout<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVTIMEO */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_RCVBUF</span>
  <span class="token comment">/** maximum amount of bytes queued in recvmbox
      not used for TCP: adjust TCP_WND instead! */</span>
  <span class="token keyword">int</span> recv_bufsize<span class="token punctuation">;</span>
  <span class="token comment">/** number of bytes currently in recvmbox to be received,
      tested against recv_bufsize to limit bytes on recvmbox
      for UDP and RAW, used for FIONREAD */</span>
  <span class="token keyword">int</span> recv_avail<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVBUF */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_LINGER</span>
   <span class="token comment">/** values &lt;0 mean linger is disabled, values &gt; 0 are seconds to linger */</span>
  s16_t linger<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_LINGER */</span>
  <span class="token comment">/** flags holding more netconn-internal state, see NETCONN_FLAG_* defines */</span>
  u8_t flags<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_TCP</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores how much is already sent. */</span>
  size_t write_offset<span class="token punctuation">;</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores the message.
      Also used during connect and close. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">api_msg_msg</span> <span class="token operator">*</span>current_msg<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_TCP */</span>
  <span class="token comment">/** A callback function that is informed about events for this netconn */</span>
  netconn_callback callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><img src="https://s1.ax1x.com/2018/08/10/P61AED.png" alt="Netconn API"></p> <table><thead><tr><th>å‡½æ•°</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>struct netconn* netconn_new_with_proto_and_callback(enum netconn_type t,u8_t proto,netconn_callback callback)</td> <td>å»ºç«‹ä¸€ä¸ªæ–°çš„netconnè¿æ¥</td></tr> <tr><td>err_t netconn_delete(struct netconn* conn)</td> <td>åˆ é™¤netconnæ‰€æŒ‡å‘çš„è¿æ¥</td></tr> <tr><td>err_t netconn_getaddr(struct netconn* conn,struct ip_addr* addr,u16_t* port,u8_t local)</td> <td>è·å–connè¿æ¥çš„ä¸»æœºIPåœ°å€å’Œç«¯å£å·</td></tr> <tr><td>err_t netconn_bind(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>å°†ä¸€ä¸ªIPåœ°å€åŠç«¯å£å·ä¸connæŒ‡å‘çš„è€Œè¿æ¥ç»‘å®š</td></tr> <tr><td>err_t netconn_connect(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>å°†æœåŠ¡å™¨ç«¯çš„IPåœ°å€å’Œç«¯å£å·ä¸connæŒ‡å‘çš„è¿æ¥ç»‘å®š</td></tr> <tr><td>err_t netconn_disconnect(struct netconn* conn)</td> <td>æ–­å¼€connæŒ‡å‘çš„è¿æ¥</td></tr> <tr><td>err_t netconn_listen_with_backlog(struct netconn* connï¼Œu8_t backlog)</td> <td>å°†connæŒ‡å‘çš„è¿æ¥è®¾å®šä¸ºç›‘å¬çŠ¶æ€</td></tr> <tr><td>struct netconn* netconn_accept(struct netconn* conn)</td> <td>æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè¯¥å‡½æ•°ä¼šé˜»å¡åœ¨acceptmboxé‚®ç®±ä¸Š</td></tr> <tr><td>struct netbuf* netconn_recv(struct netconn* conn)</td> <td>æ¥æ”¶æ•°æ®ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®è¢«å°è£…ä¸ºnetbufç»“æ„</td></tr> <tr><td>err_t netconn_sendto(struct netconn* conn,struct netbuf* buf,struct ip_addr* addr,u16_t port)</td> <td>å‘ä¸€ä¸ªæŒ‡å®šçš„IPåœ°å€å’Œç«¯å£å·å‘é€æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°åªèƒ½ç”¨åœ¨connç±»å‹ä¸ºUDPæˆ–è€…RAWçš„è¿æ¥ä¸­</td></tr> <tr><td>err_t netconn_write(struct netconn* conn,const void* dataptr,size_t size,u8_t apiflag)</td> <td>å‘ç›¸åº”çš„TCPè¿æ¥ä¸Šå‘é€æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°åªèƒ½ç”¨äºå‘é€TCPçš„æŠ¥æ–‡</td></tr> <tr><td>err_t nnetconn_close(struct netconn* conn)</td> <td>å…³é—­connæŒ‡å‘çš„è¿æ¥</td></tr></tbody></table> <ul><li>netconn_new_with_proto_and_callbacké¦–å…ˆè°ƒç”¨netconn_allocå‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ªnetconnç»“æ„ï¼Œæ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šæ„å»ºä¸€ä¸ªapi_msgæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯è¦æ±‚å†…æ ¸æ‰§è¡Œå‡½æ•°do_newconnï¼Œæœ€åè°ƒç”¨å‡½æ•°tcpip_apimsgæ¥å°†æ¶ˆæ¯åŒ…è£…æˆtcpip_msgç»“æ„å¹¶å‘é€å‡ºå»ã€‚tcpip_threadå‡½æ•°è§£æè¯¥æ¶ˆæ¯å¹¶è°ƒç”¨å‡½æ•°do_newconnï¼Œdo_newconnæ ¹æ®å‚æ•°çš„ç±»å‹è°ƒç”¨å‡½æ•°tcp_newåˆ›å»ºä¸€ä¸ªTCPæ§åˆ¶å—</li> <li>tcpip_threadæ˜¯å¤„ç†TCP/IPçš„å†…æ ¸åè®®æ ˆè¿›ç¨‹ï¼Œå®ƒåªæ¥æ”¶tcpip_msgç»“æ„å°è£…çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®æ¶ˆæ¯çš„ç±»å‹æ¥åˆ¤å®šè¯¥æ¶ˆæ¯æ¥è‡ªç‰©ç†ç½‘å¡æˆ–åº”ç”¨å±‚ç¨‹åºã€‚å¦‚æœæ¥æ”¶åˆ°ç½‘å¡çš„IPæŠ¥æ–‡ï¼Œåˆ™å°†è¯¥æŠ¥æ–‡é€’äº¤ç»™ip_inputå‡½æ•°ï¼›å¦‚æœæ˜¯åº”ç”¨å±‚ç¨‹åºå‘é€çš„æ¶ˆæ¯ï¼Œåˆ™é€šè¿‡è°ƒç”¨æ¶ˆæ¯æŒ‡å®šçš„å†…æ ¸å¤„ç†å‡½æ•°æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½</li></ul> <h3 id="socket-api"><a href="#socket-api" aria-hidden="true" class="header-anchor">#</a> Socket API</h3> <blockquote><p>LwIPæä¾›äº†æ ‡å‡†BSDå¥—æ¥å­—APIï¼Œå®ƒä¹Ÿæ˜¯æœ‰åºAPIï¼Œåœ¨å†…å­˜æ„å»ºäºNetconn APIä¹‹ä¸Šã€‚æ‰€è°“â€œæœ‰åºâ€æ˜¯æŒ‡å…¶æ‰§è¡Œæ¨¡å‹åŸºäºå…¸å‹çš„é˜»å¡å¼æ‰“å¼€-è¯»-å†™-å…³é—­æœºåˆ¶ã€‚</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61V4H.png" alt="Socket API"></p> <h2 id="lwipç§»æ¤"><a href="#lwipç§»æ¤" aria-hidden="true" class="header-anchor">#</a> LwIPç§»æ¤</h2> <blockquote><ol><li>ä»¥å¤ªç½‘æ¥å£ä»»åŠ¡ç”¨äºæ¥æ”¶æ¥è‡ªç‰©ç†ç½‘å¡çš„æ•°æ®æŠ¥æ–‡ï¼ŒåŒæ—¶å°†æ”¶åˆ°çš„æŠ¥æ–‡é€šè¿‡FreeRTOSæä¾›çš„é‚®ç®±ä¼ é€’ç»™TCP/IPåè®®æ ˆä»»åŠ¡ã€‚ä»¥å¤ªç½‘æ¥å£ä»»åŠ¡å¹³æ—¶å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œå½“ç¡¬ä»¶æ”¶åˆ°æŠ¥æ–‡æ—¶ï¼Œå°†äº§ç”Ÿæ¥æ”¶æŠ¥æ–‡ä¸­æ–­ï¼Œè¯¥ç»ˆç«¯ä»¥ä¿¡å·é‡çš„æ–¹å¼å°†ä»¥å¤ªç½‘æ¥å£ä»»åŠ¡æ¿€æ´»</li> <li>åº”ç”¨ç¨‹åºä½¿ç”¨TCP/IPåè®®æ ˆæä¾›çš„Sequential APIæ¥å£è®¿é—®LwIPï¼ŒåŒæ—¶è¿™ä¸¤ä¸ªç‹¬ç«‹çš„ä»»åŠ¡éœ€è¦ä½¿ç”¨FreeRTOSæä¾›çš„é‚®ç®±æœºåˆ¶å®ç°å½¼æ­¤ä¹‹é—´ä¿¡æ¯çš„äº¤äº’ã€‚Sequential APIæ¥å£å‡½æ•°åœ¨FreeRTOSæ“ä½œç³»ç»Ÿè¿è¡Œç¯å¢ƒä¸‹æ˜¯â€œé˜»å¡â€å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åº”ç”¨ç¨‹åºä»»åŠ¡åœ¨è°ƒç”¨Sequential APIæ¥å£å‡½æ•°æ—¶ï¼Œå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°æ¥è‡ªTCP/IPåè®®æ ˆè¿”å›çš„æ¶ˆæ¯åº”ç­”</li> <li>åŸºäºLwIPçš„TCP/IPåè®®æ ˆä¸åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸¤ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ä¸­</li></ol></blockquote> <p><img src="https://s1.ax1x.com/2018/08/09/PyyVRx.jpg" alt="ç½‘å¡é©±åŠ¨ç§»æ¤"></p> <ol><li>ä»¥å¤ªç½‘æ¥å£æ–‡ä»¶ethernetif.cçš„ç§»æ¤ï¼Œä¸»è¦åŒ…å«<code>ethernet_low_level_init</code>ï¼Œ<code>ethernet_low_level_output</code>ï¼Œ<code>ethernetif_input</code>ï¼Œ<code>ethernetif_init</code>è¿™å‡ ä¸ªå‡½æ•°çš„åŠŸèƒ½
<ul><li><code>ethernetif_input</code>å‡½æ•°ç”¨äºä»åº•å±‚ç‰©ç†ç½‘å¡è¯»å–æŠ¥æ–‡ï¼Œå¹¶å°†è¯¥æŠ¥æ–‡å‘ä¸Šä¼ é€’ç»™LwIPåè®®æ ˆå‡½æ•°ethernet_inputè¿›è¡Œå¤„ç†</li> <li><code>ethernetif_init</code>å‡½æ•°æŒ‡å®šäº†ç½‘ç»œæ¥å£netifå¯¹åº”çš„ä¸»æœºååŠç½‘å¡æè¿°ï¼Œå¹¶æŒ‡å®šäº†è¯¥ç½‘å¡çš„MACåœ°å€ï¼ŒåŒäº‹è¿˜æŒ‡å®šäº†netifçš„å‘é€æ•°æ®æŠ¥æ–‡å‡½æ•°</li></ul></li> <li>æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚æ–‡ä»¶sys_arch.cçš„ç§»æ¤ï¼Œæ€»çš„æ¥æ—¶æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚ä¸»è¦å®Œæˆäº†ä¸ä¿¡å·é‡ã€æ¶ˆæ¯é‚®ç®±æœºåˆ¶ã€çº¿ç¨‹ç›¸å…³çš„åŠŸèƒ½
<ul><li>åœ¨sys_arch.hæ–‡ä»¶ä¸­å¯¹ä¿¡å·é‡ã€é‚®ç®±ã€çº¿ç¨‹å¯¹è±¡è¿›è¡Œé‡å®šä¹‰</li> <li>sys_mbox_newå‡½æ•°ï¼Œä½¿ç”¨FreeRTOSæä¾›çš„æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶åˆ›å»ºä¸€ä¸ªç©ºçš„æ¶ˆæ¯é˜Ÿåˆ—</li> <li>sys_mbox_freeå‡½æ•°ï¼Œåˆ é™¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå½“è¯¥é˜Ÿåˆ—ä¸­è¿˜æœ‰æœªè¢«å–å‡ºçš„æ¶ˆæ¯æ—¶ï¼Œè¯¥å‡½æ•°åº”å½“æŠ¥é”™ï¼Œå¹¶é€šçŸ¥åº”ç”¨ç¨‹åº</li> <li>sys_mbox_postå‡½æ•°ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œå½“æ¶ˆæ¯è¢«å‘é€è‡³é˜Ÿåˆ—åï¼Œè¯¥å‡½æ•°æ‰ä¼šé€€å‡ºé˜»å¡çŠ¶æ€</li> <li>sys_mbox_trypostå‡½æ•°ï¼Œç”¨äºå°è¯•å°†æŸä¸ªæ¶ˆæ¯å‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå½“æ¶ˆæ¯è¢«æˆåŠŸæŠ•é€’åï¼Œåˆ™è¿”å›æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥</li> <li>sys_arch_mbox_fetchå‡½æ•°ï¼Œç”¨äºä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹è‹¥æœªå–åˆ°æ¶ˆæ¯ï¼Œåˆ™åœ¨å½¢å‚timeoutæ‰€æŒ‡å®šçš„æ—¶é—´å†…ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡ã€‚å½“è¶…è¿‡timeoutæ‰€æŒ‡å®šçš„æ—¶é—´åï¼Œè¯¥çº¿ç¨‹æ¢å¤è‡³å°±ç»ªçŠ¶æ€ã€‚è‹¥timeoutä¸º0ï¼Œåˆ™è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹ä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°æ¶ˆæ¯</li> <li>sys_arch_mbox_tryfetchå‡½æ•°å°è¯•ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªéé˜»å¡å‡½æ•°ï¼Œå½“å–åˆ°æ¶ˆæ¯æ—¶ï¼Œåˆ™è¿”å›æˆåŠŸï¼Œå¦åˆ™ç«‹å³é€€å‡ºï¼Œè¿”å›é˜Ÿåˆ—ç©º</li> <li>sys_sem_newå‡½æ•°åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œå¹¶æ ¹æ®å½¢å‚çš„å€¼æŒ‡å®šå¥½å½“å‰ä¿¡å·é‡çš„çŠ¶æ€</li> <li>sys_arch_sem_waitå‡½æ•°åœ¨å½¢å‚timeoutæŒ‡å®šçš„æ—¶é—´è¢«é˜»å¡ï¼Œè‹¥timeoutä¸º0ï¼Œåˆ™è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹å°†ä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°ç­‰å¾…çš„ä¿¡å·é‡è¢«é‡Šæ”¾ã€‚ä½†è¯¥å‡½æ•°å–åˆ°ä¿¡å·é‡æ—¶ï¼Œå®ƒå°†è¿”å›å–åˆ°çš„è¯¥ä¿¡å·é‡æ‰€å çš„æ—¶é—´</li> <li>sys_sem_signalå‡½æ•°ç”¨äºé‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡</li> <li>sys_sem_freeå‡½æ•°ç”¨äºåˆ é™¤ä¸€ä¸ªä¿¡å·é‡</li> <li>sys_thread_newå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹</li> <li>sys_initå‡½æ•°æ˜¯æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿå±‚çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¸»è¦å¯¹å®šæ—¶å™¨ç®¡ç†æ•°ç»„è¿›è¡Œäº†åˆå§‹åŒ–</li> <li>sys_zrch_timeoutså‡½æ•°ç”¨äºè¿”å›å½“å‰ä»»åŠ¡çš„å®šæ—¶å™¨ç®¡ç†é“¾è¡¨é¦–åœ°å€</li> <li>sys_arch_protectå‡½æ•°å’Œsys_arch_unprotectå‡½æ•°åœ¨è®¿é—®ä¸´ç•ŒåŒºèµ„æºæ—¶æˆå¯¹ä½¿ç”¨</li></ul></li> <li>ethernet_inputå‡½æ•°çš„å®ç°åœ¨ç‹¬ç«‹æ¨¡å¼å’ŒRTOSæ¨¡å¼æ—¶æ˜¯ä¸åŒçš„ï¼š
<ul><li>åœ¨ç‹¬ç«‹åº”ç”¨ä¸­ï¼Œæ­¤å‡½æ•°å¿…é¡»è¢«æ’å…¥åˆ°åº”ç”¨çš„ä¸»å¾ªç¯ä¸­ï¼Œä»¥ä¾¿è½®è¯¢ä»»ä½•æ”¶åˆ°çš„åŒ…</li> <li>åœ¨RTOSåº”ç”¨ä¸­ï¼Œæ­¤å‡½æ•°ä¸ºä¸€ä¸ªé˜»å¡çº¿ç¨‹ï¼Œåªæœ‰å½“å¾—åˆ°æ‰€ç­‰å¾…çš„ä¿¡å·é‡æ—¶æ‰å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ã€‚å½“ä»¥å¤ªç½‘å¤–è®¾æ”¶åˆ°æ•°æ®å¹¶äº§ç”Ÿä¸­æ–­æ—¶ï¼Œä¼šåœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­é‡Šæ”¾æ­¤ä¿¡å·é‡</li></ul></li></ol> <h2 id="lwipé…ç½®"><a href="#lwipé…ç½®" aria-hidden="true" class="header-anchor">#</a> LwIPé…ç½®</h2> <blockquote><p>LwIPæä¾›äº†åä¸ºlwipopts.hçš„æ–‡ä»¶ï¼Œå®ƒå…è®¸ç”¨æˆ·å……åˆ†é…ç½®æ ˆåŠå…¶æ‰€æœ‰æ¨¡å—ã€‚ç”¨æˆ·ä¸éœ€è¦å®šä¹‰æ‰€æœ‰LwIPé€‰é¡¹ï¼šå¦‚æœæœªå®šä¹‰æŸé€‰é¡¹ï¼Œåˆ™ä½¿ç”¨opt.hæ–‡ä»¶ä¸­å®šä¹‰çš„é»˜è®¤å€¼</p></blockquote> <ul><li>å†…å­˜é…ç½®</li></ul> <p><img src="https://s1.ax1x.com/2018/08/10/P6GG5D.png" alt="LwIPå†…å­˜é…ç½®"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/cs/lwip.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µé¢</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°: </span> <span class="time">7/24/2019, 3:15:05 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/blog/cs/logistic_regression.html" class="prev">
          é€»è¾‘å›å½’
        </a></span> <span class="next"><a href="/blog/cs/keras.html">
          ğ™†ğ™šğ™§ğ™–ğ™¨ åŸºç¡€
        </a>
        â†’
      </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.d911a002.js" defer></script><script src="/blog/assets/js/2.37a3b3f2.js" defer></script><script src="/blog/assets/js/4.bd9b9f70.js" defer></script><script src="/blog/assets/js/5.22f508ff.js" defer></script>
  </body>
</html>
