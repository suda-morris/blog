<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€ | suda-morris ä¸ªäººåšå®¢</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <meta name="description" content="è®°å½•å­¦ä¹ ç”Ÿæ´»ï¼Œæ¢ç´¢æœªçŸ¥é¢†åŸŸ">
    
    <link rel="preload" href="/blog/assets/css/0.styles.5691af22.css" as="style"><link rel="preload" href="/blog/assets/js/app.ac7e3fa7.js" as="script"><link rel="preload" href="/blog/assets/js/4.5a6f3cdb.js" as="script"><link rel="preload" href="/blog/assets/js/6.0f172f01.js" as="script"><link rel="preload" href="/blog/assets/js/13.e6b2f1ea.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f03a3aac.js"><link rel="prefetch" href="/blog/assets/js/11.ae4b2cce.js"><link rel="prefetch" href="/blog/assets/js/12.d4935294.js"><link rel="prefetch" href="/blog/assets/js/14.f74f3f95.js"><link rel="prefetch" href="/blog/assets/js/15.5d1b25db.js"><link rel="prefetch" href="/blog/assets/js/16.a5e998ae.js"><link rel="prefetch" href="/blog/assets/js/17.e89b7550.js"><link rel="prefetch" href="/blog/assets/js/18.54964398.js"><link rel="prefetch" href="/blog/assets/js/19.0cb7ce42.js"><link rel="prefetch" href="/blog/assets/js/2.3d581be0.js"><link rel="prefetch" href="/blog/assets/js/20.54a6100d.js"><link rel="prefetch" href="/blog/assets/js/21.614000c5.js"><link rel="prefetch" href="/blog/assets/js/22.3e97384c.js"><link rel="prefetch" href="/blog/assets/js/23.d71c0873.js"><link rel="prefetch" href="/blog/assets/js/24.71555490.js"><link rel="prefetch" href="/blog/assets/js/25.b16d270c.js"><link rel="prefetch" href="/blog/assets/js/26.f4de8b86.js"><link rel="prefetch" href="/blog/assets/js/27.30c766d7.js"><link rel="prefetch" href="/blog/assets/js/28.2b4252ee.js"><link rel="prefetch" href="/blog/assets/js/29.2c518044.js"><link rel="prefetch" href="/blog/assets/js/3.3b61a6b3.js"><link rel="prefetch" href="/blog/assets/js/30.b2448644.js"><link rel="prefetch" href="/blog/assets/js/31.de945266.js"><link rel="prefetch" href="/blog/assets/js/32.f9d2713e.js"><link rel="prefetch" href="/blog/assets/js/33.c76d7f06.js"><link rel="prefetch" href="/blog/assets/js/34.cdf8e0db.js"><link rel="prefetch" href="/blog/assets/js/35.90ed1ce7.js"><link rel="prefetch" href="/blog/assets/js/36.9e22d936.js"><link rel="prefetch" href="/blog/assets/js/37.08a3211f.js"><link rel="prefetch" href="/blog/assets/js/38.28fe3226.js"><link rel="prefetch" href="/blog/assets/js/39.04c545d7.js"><link rel="prefetch" href="/blog/assets/js/40.56052285.js"><link rel="prefetch" href="/blog/assets/js/41.48bfaa8b.js"><link rel="prefetch" href="/blog/assets/js/42.b7cf8014.js"><link rel="prefetch" href="/blog/assets/js/43.ab729aa6.js"><link rel="prefetch" href="/blog/assets/js/44.5573e15c.js"><link rel="prefetch" href="/blog/assets/js/45.0f64db68.js"><link rel="prefetch" href="/blog/assets/js/46.57527d53.js"><link rel="prefetch" href="/blog/assets/js/47.03e78362.js"><link rel="prefetch" href="/blog/assets/js/48.c19f5f4c.js"><link rel="prefetch" href="/blog/assets/js/49.e4825ced.js"><link rel="prefetch" href="/blog/assets/js/5.1bbacc6b.js"><link rel="prefetch" href="/blog/assets/js/50.36925d23.js"><link rel="prefetch" href="/blog/assets/js/51.82009766.js"><link rel="prefetch" href="/blog/assets/js/52.ddeaaa91.js"><link rel="prefetch" href="/blog/assets/js/53.0aa3c8cb.js"><link rel="prefetch" href="/blog/assets/js/54.2e7c5b35.js"><link rel="prefetch" href="/blog/assets/js/55.939c9d5d.js"><link rel="prefetch" href="/blog/assets/js/56.8848c8bb.js"><link rel="prefetch" href="/blog/assets/js/57.f83da2da.js"><link rel="prefetch" href="/blog/assets/js/58.9f426256.js"><link rel="prefetch" href="/blog/assets/js/59.ff57958f.js"><link rel="prefetch" href="/blog/assets/js/60.a156e06c.js"><link rel="prefetch" href="/blog/assets/js/61.32b296b3.js"><link rel="prefetch" href="/blog/assets/js/62.a9cfd495.js"><link rel="prefetch" href="/blog/assets/js/63.93880c3c.js"><link rel="prefetch" href="/blog/assets/js/64.be1a378f.js"><link rel="prefetch" href="/blog/assets/js/65.bbad144d.js"><link rel="prefetch" href="/blog/assets/js/66.e9ac3c63.js"><link rel="prefetch" href="/blog/assets/js/67.7941d922.js"><link rel="prefetch" href="/blog/assets/js/68.9f9848e9.js"><link rel="prefetch" href="/blog/assets/js/69.d0fbcffe.js"><link rel="prefetch" href="/blog/assets/js/7.13835fce.js"><link rel="prefetch" href="/blog/assets/js/70.c2ba1a64.js"><link rel="prefetch" href="/blog/assets/js/71.b2de6ad0.js"><link rel="prefetch" href="/blog/assets/js/72.4bc22d43.js"><link rel="prefetch" href="/blog/assets/js/73.efb34e2f.js"><link rel="prefetch" href="/blog/assets/js/74.2500540a.js"><link rel="prefetch" href="/blog/assets/js/75.b23c8c5c.js"><link rel="prefetch" href="/blog/assets/js/76.a52d366a.js"><link rel="prefetch" href="/blog/assets/js/77.449ef865.js"><link rel="prefetch" href="/blog/assets/js/78.b3f83541.js"><link rel="prefetch" href="/blog/assets/js/79.fa302424.js"><link rel="prefetch" href="/blog/assets/js/8.0a1f7648.js"><link rel="prefetch" href="/blog/assets/js/80.e6846308.js"><link rel="prefetch" href="/blog/assets/js/81.141bd12e.js"><link rel="prefetch" href="/blog/assets/js/82.08205ae2.js"><link rel="prefetch" href="/blog/assets/js/83.ba2dea91.js"><link rel="prefetch" href="/blog/assets/js/84.5717497f.js"><link rel="prefetch" href="/blog/assets/js/85.37a3ab4d.js"><link rel="prefetch" href="/blog/assets/js/86.e5d721be.js"><link rel="prefetch" href="/blog/assets/js/87.189f9596.js"><link rel="prefetch" href="/blog/assets/js/88.9fe97973.js"><link rel="prefetch" href="/blog/assets/js/89.f7e41ef9.js"><link rel="prefetch" href="/blog/assets/js/9.ad675a21.js"><link rel="prefetch" href="/blog/assets/js/90.e75d916f.js"><link rel="prefetch" href="/blog/assets/js/91.d6fb57f6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5691af22.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris ä¸ªäººåšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link router-link-active">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/cs/about.html" class="sidebar-link">å…³äºæœ¬æ ç›®</a></li><li><a href="/blog/cs/bash.html" class="sidebar-link">ğ™—ğ™–ğ™¨ğ™ åŸºç¡€</a></li><li><a href="/blog/cs/bit_ops.html" class="sidebar-link">ä½è¿ç®—æŠ€å·§</a></li><li><a href="/blog/cs/cheat_sheet.html" class="sidebar-link">å°æŠ„</a></li><li><a href="/blog/cs/cmake.html" class="sidebar-link">ğ˜¾ğ™ˆğ™–ğ™ ğ™š åŸºç¡€</a></li><li><a href="/blog/cs/computer_composition.html" class="sidebar-link">è®¡ç®—æœºç»„æˆåŸç†</a></li><li><a href="/blog/cs/concurrent_programming.html" class="sidebar-link">å¹¶å‘ç¼–ç¨‹</a></li><li><a href="/blog/cs/design_pattern.html" class="sidebar-link">è®¾è®¡æ¨¡å¼ ğ˜¾ è¯­è¨€æè¿°</a></li><li><a href="/blog/cs/gcc_toolchains.html" class="sidebar-link">ğ™‚ğ˜¾ğ˜¾ å·¥å…·é“¾åŸºç¡€</a></li><li><a href="/blog/cs/git.html" class="sidebar-link">ğ™‚ğ™ğ™© åŸºç¡€</a></li><li><a href="/blog/cs/iptables.html" class="sidebar-link">é˜²ç«å¢™ ğ™ğ™¥ğ™©ğ™–ğ™—ğ™¡ğ™šğ™¨ åŸºç¡€</a></li><li><a href="/blog/cs/keras.html" class="sidebar-link">ğ™†ğ™šğ™§ğ™–ğ™¨ åŸºç¡€</a></li><li><a href="/blog/cs/knowledge_map.html" class="sidebar-link">çŸ¥è¯†å›¾è°±</a></li><li><a href="/blog/cs/logistic_regression.html" class="sidebar-link">é€»è¾‘å›å½’</a></li><li><a href="/blog/cs/lwip.html" aria-current="page" class="active sidebar-link">ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼" class="sidebar-link">æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†" class="sidebar-link">LwIP çš„ç½‘ç»œæ¥å£ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„å†…å­˜ç®¡ç†" class="sidebar-link">LwIP çš„å†…å­˜ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ç½‘ç»œæ•°æ®åŒ…" class="sidebar-link">ç½‘ç»œæ•°æ®åŒ…</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ç½‘å¡æ¥æ”¶æ•°æ®çš„ä¸€èˆ¬æµç¨‹" class="sidebar-link">ç½‘å¡æ¥æ”¶æ•°æ®çš„ä¸€èˆ¬æµç¨‹</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-å†…æ ¸è¶…æ—¶å¤„ç†" class="sidebar-link">LwIP å†…æ ¸è¶…æ—¶å¤„ç†</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#tcpip-thread-çº¿ç¨‹" class="sidebar-link">tcpip_thread çº¿ç¨‹</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-ä¸­çš„æ¶ˆæ¯" class="sidebar-link">LwIP ä¸­çš„æ¶ˆæ¯</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#arp-åè®®" class="sidebar-link">ARP åè®®</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#ip-åè®®" class="sidebar-link">IP åè®®</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#icmp-åè®®" class="sidebar-link">ICMP åè®®</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#udp-åè®®" class="sidebar-link">UDP åè®®</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#tcp-åè®®" class="sidebar-link">TCP åè®®</a></li><li class="sidebar-sub-header"><a href="/blog/cs/lwip.html#lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£" class="sidebar-link">LwIP çš„ä¸‰ç§ç¼–ç¨‹æ¥å£</a></li></ul></li><li><a href="/blog/cs/mbedtls.html" class="sidebar-link">ğ™¢ğ™—ğ™šğ™™ğ™ğ™‡ğ™ åŸºç¡€</a></li><li><a href="/blog/cs/python.html" class="sidebar-link">ğ™‹ğ™®ğ™©ğ™ğ™¤ğ™£ ä»£ç ç‰‡æ®µ</a></li><li><a href="/blog/cs/regular_expression.html" class="sidebar-link">æ­£åˆ™è¡¨è¾¾å¼</a></li><li><a href="/blog/cs/risc-v.html" class="sidebar-link">ğ‘¹ğ‘°ğ‘ºğ‘ª-ğ‘½ åŸºç¡€</a></li><li><a href="/blog/cs/scala.html" class="sidebar-link">ğ™ğ™˜ğ™–ğ™¡ğ™– åŸºç¡€</a></li><li><a href="/blog/cs/think_in_code.html" class="sidebar-link">è½¯ä»¶è®¾è®¡æ€æƒ³</a></li><li><a href="/blog/cs/xtensa.html" class="sidebar-link">ğ™“ğ™©ğ™šğ™£ğ™¨ğ™– åŸºç¡€</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lwip-åŸºç¡€"><a href="#lwip-åŸºç¡€" class="header-anchor">#</a> ğ™‡ğ™¬ğ™„ğ™‹ åŸºç¡€</h1> <p><img src="/blog/assets/img/tcp_ip_stack.13913b2b.png" alt="TCP/IPåè®®æ ˆ"></p> <h2 id="æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼"><a href="#æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼" class="header-anchor">#</a> æ ‡å‡†ä»¥å¤ªç½‘æ•°æ®å¸§æ ¼å¼</h2> <p><img src="/blog/assets/img/ethernet_frame.f4de10c4.png" alt="Ethernet_Frame"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>MAC åœ°å€å¯ä»¥åˆ†æˆä¸‰ç±»ï¼š</p> <ol><li>å•æ’­åœ°å€ï¼šç¬¬ä¸€ä¸ªå­—èŠ‚çš„ bit0 å¿…é¡»æ˜¯ 0</li> <li>ç»„æ’­åœ°å€ï¼šç¬¬ä¸€ä¸ªå­—èŠ‚çš„ bit- å¿…é¡»æ˜¯ 1</li> <li>å¹¿æ’­åœ°å€ï¼šFF-FF-FF-FF-FF-FF</li></ol></div> <h2 id="lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†"><a href="#lwip-çš„ç½‘ç»œæ¥å£ç®¡ç†" class="header-anchor">#</a> LwIP çš„ç½‘ç»œæ¥å£ç®¡ç†</h2> <p>LwIP ä½¿ç”¨ <strong>netif</strong> ç»“æ„ä½“æ¥æè¿°ç¡¬ä»¶ç½‘ç»œæ¥å£ï¼Œå¹¶é€šè¿‡ <code>netif_add</code> å‡½æ•°å°†å…¶æŒ‚è½½åˆ°å…¨å±€ <strong>netif é“¾è¡¨</strong>ä¸­ã€‚</p> <p><img src="/blog/assets/img/netif_list.73bfcf79.png" alt="ç½‘å¡é“¾è¡¨"></p> <h3 id="netif-ç»“æ„ä½“"><a href="#netif-ç»“æ„ä½“" class="header-anchor">#</a> netif ç»“æ„ä½“</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* struct netif ç”¨äºæè¿°ä¸åŒç±»å‹çš„ç½‘å¡ï¼Œåœ¨ç½‘å¡åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šå¦‚ä¸‹æˆå‘˜ï¼š
** hwaddr_len, hwaddr[], mtu, flags
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* å¦‚æœæ”¯æŒå¤šç½‘å¡ï¼Œåˆ™ä½¿ç”¨å•å‘é“¾è¡¨æ¥ç®¡ç†åŒä¸€è®¾å¤‡çš„å¤šä¸ªç½‘å¡ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_SINGLE_NETIF</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
    <span class="token comment">/* ç½‘ç»œå­—èŠ‚åºè¡¨ç¤ºçš„ IPv4 åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ */</span>
    <span class="token class-name">ip_addr_t</span> ip_addr<span class="token punctuation">;</span>
    <span class="token class-name">ip_addr_t</span> netmask<span class="token punctuation">;</span>
    <span class="token class-name">ip_addr_t</span> gw<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
    <span class="token comment">/* æ•°ç»„ä¿å­˜å¤šä¸ª IPv6 åœ°å€ */</span>
    <span class="token class-name">ip_addr_t</span> ip6_addr<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* æ¯ä¸ª IPv6 åœ°å€çš„çŠ¶æ€ï¼šä¸´æ—¶çš„è¿˜æ˜¯é¦–é€‰çš„ */</span>
    <span class="token class-name">u8_t</span> ip6_addr_state<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_ADDRESS_LIFETIMES</span></span>
    <span class="token comment">/* æ¯ä¸ª IPv6 åœ°å€çš„å‰©ä½™æœ‰æ•ˆæ—¶é—´ä»¥åŠæ€»å…±æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½ï¼šç§’ */</span>
    <span class="token comment">/* IP6_ADDR_LIFE_STATIC è¡¨ç¤ºè¿™ä¸ªåœ°å€æ˜¯é™æ€åˆ†é…çš„ */</span>
    <span class="token class-name">u32_t</span> ip6_addr_valid_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">u32_t</span> ip6_addr_pref_life<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”±ä»¥å¤ªç½‘è®¾å¤‡é©±åŠ¨ç¨‹åºè°ƒç”¨ï¼Œå°†æ•°æ®åŒ…ä¼ é€’ç»™ TCP/IP åè®®æ ˆ */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ ethernet_input() */</span>
    netif_input_fn input<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± IPv4 æ¨¡å—è°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¼šè§£æå¾—åˆ°ç¡¬ä»¶åœ°å€ï¼Œç„¶åå‘é€æ•°æ®åŒ… */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ etharp_output() */</span>
    netif_output_fn output<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± ARP æ¨¡å—è°ƒç”¨ï¼Œç”¨äºå®ç°åœ¨æ•°æ®é“¾è·¯å±‚å‘é€æ•°æ® */</span>
    netif_linkoutput_fn linkoutput<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
    <span class="token comment">/* æ­¤å‡½æ•°ç”± IPv6 æ¨¡å—è°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¼šè§£æå¾—åˆ°ç¡¬ä»¶åœ°å€ï¼Œç„¶åå‘é€æ•°æ®åŒ… */</span>
    <span class="token comment">/* å¯¹äºä»¥å¤ªç½‘è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ ethip6_output() */</span>
    netif_output_ip6_fn output_ip6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_STATUS_CALLBACK</span></span>
    <span class="token comment">/* å½“ç½‘å¡çŠ¶æ€è®¾ç½®ä¸º up æˆ–è€… down æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn status_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_LINK_CALLBACK</span></span>
    <span class="token comment">/* å½“ç½‘å¡çš„æ•°æ®é“¾è·¯è®¾ç½®ä¸º up æˆ–è€… down æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn link_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_REMOVE_CALLBACK</span></span>
    <span class="token comment">/* å½“ç½‘å¡è¢«ç§»é™¤æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ */</span>
    netif_status_callback_fn remove_callback<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_REMOVE_CALLBACK */</span></span>
    <span class="token comment">/* ç”¨äºå°†ç½‘å¡çš„ç§æœ‰æ•°æ®ä¼ é€’ç»™ä¸Šå±‚ */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">netif_get_client_data</span></span>
    <span class="token keyword">void</span> <span class="token operator">*</span>client_data<span class="token punctuation">[</span>LWIP_NETIF_CLIENT_DATA_INDEX_MAX <span class="token operator">+</span> LWIP_NUM_NETIF_CLIENT_DATA<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_HOSTNAME</span></span>
    <span class="token comment">/* ç½‘å¡çš„ä¸»æœºåï¼Œè®¾ç½®ä¸º NULL ä¹Ÿåˆæ³• */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_HOSTNAME */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_CHECKSUM_CTRL_PER_NETIF</span></span>
    <span class="token class-name">u16_t</span> chksum_flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_CHECKSUM_CTRL_PER_NETIF*/</span></span>
    <span class="token comment">/* æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¯¹äºä»¥å¤ªç½‘ï¼Œä¸€èˆ¬è®¾ä¸º 1500 */</span>
    <span class="token comment">/* IP å±‚ä¼šæ ¹æ®è¯¥å­—æ®µæ¥å†³å®šæ˜¯å¦éœ€è¦å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç‰‡å¤„ç† */</span>
    <span class="token class-name">u16_t</span> mtu<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_ND6_ALLOW_RA_UPDATES</span></span>
    <span class="token comment">/* æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œç”± RA æ¥æ›´æ–° */</span>
    <span class="token class-name">u16_t</span> mtu6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span></span>
    <span class="token comment">/* æ•°æ®é“¾è·¯å±‚çš„ç¡¬ä»¶åœ°å€ */</span>
    <span class="token class-name">u8_t</span> hwaddr<span class="token punctuation">[</span>NETIF_MAX_HWADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* ç¡¬ä»¶åœ°å€é•¿åº¦ï¼Œä»¥å¤ªç½‘æ˜¯ 6 å­—èŠ‚ */</span>
    <span class="token class-name">u8_t</span> hwaddr_len<span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çŠ¶æ€ä¿¡æ¯æ ‡å¿—ä½ï¼ŒåŒ…æ‹¬ç½‘å¡åŠŸèƒ½ä½¿èƒ½ã€å¹¿æ’­ä½¿èƒ½ã€ARP ä½¿èƒ½ç­‰ */</span>
    <span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çš„åå­—ï¼Œè“ç‰™è®¾å¤‡çš„ç½‘å¡åå­—å¯ä»¥ä½¿ btï¼ŒWLAN è®¾å¤‡çš„åå­—å¯ä»¥æ˜¯ wl */</span>
    <span class="token comment">/* å¦‚æœç½‘å¡å…·æœ‰ç›¸åŒçš„åå­—ï¼Œéœ€è¦é€šè¿‡ num å­—æ®µæ¥è¿›ä¸€æ­¥åŒºåˆ† */</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* ç½‘å¡çš„æ ‡å·ï¼Œå¯ç”¨æ¥æ ‡å¿—åŒç§ç±»å‹çš„ä¸åŒç½‘å¡ */</span>
    <span class="token class-name">u8_t</span> num<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_AUTOCONFIG</span></span>
    <span class="token comment">/* æ˜¯å¦ä½¿èƒ½ IPv6 è‡ªåŠ¨é…ç½® */</span>
    <span class="token class-name">u8_t</span> ip6_autoconfig_enabled<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_SEND_ROUTER_SOLICIT</span></span>
    <span class="token comment">/* å‰©ä½™å¾…å‘é€çš„è·¯ç”±è¯·æ±‚æ¶ˆæ¯çš„æ•°é‡ */</span>
    <span class="token class-name">u8_t</span> rs_count<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_SEND_ROUTER_SOLICIT */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MIB2_STATS</span></span>
    <span class="token comment">/* é“¾è·¯ç±»å‹ */</span>
    <span class="token class-name">u8_t</span> link_type<span class="token punctuation">;</span>
    <span class="token comment">/* é¢„ä¼°çš„é“¾è·¯å±‚é€Ÿç‡ */</span>
    <span class="token class-name">u32_t</span> link_speed<span class="token punctuation">;</span>
    <span class="token comment">/* æœ€è¿‘ä¸€æ¬¡é“¾è·¯å±‚çŠ¶æ€å˜åŒ–çš„æ—¶é—´ï¼ˆå»ºç«‹æˆ–è€…æ–­å¼€é“¾æ¥ï¼‰*/</span>
    <span class="token class-name">u32_t</span> ts<span class="token punctuation">;</span>
    <span class="token comment">/* è®¡æ•°å™¨ */</span>
    <span class="token keyword">struct</span> <span class="token class-name">stats_mib2_netif_ctrs</span> mib2_counters<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MIB2_STATS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4 <span class="token operator">&amp;&amp;</span> LWIP_IGMP</span></span>
    <span class="token comment">/* å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°æ¥å‘ä»¥å¤ªç½‘ MAC çš„ç»„æ’­è¿‡æ»¤è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤æ¡ç›® */</span>
    netif_igmp_mac_filter_fn igmp_mac_filter<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 &amp;&amp; LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_IPV6_MLD</span></span>
    <span class="token comment">/* å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°æ¥å‘ä»¥å¤ªç½‘ MAC çš„ IPv6 ç»„æ’­è¿‡æ»¤è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤æ¡ç›® */</span>
    netif_mld_mac_filter_fn mld_mac_filter<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_USE_HINTS</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">netif_hint</span> <span class="token operator">*</span>hints<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_USE_HINTS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK</span></span>
    <span class="token comment">/* å¾…å‘é€ç»™è‡ªå·±çš„æ•°æ®åŒ…åˆ—è¡¨ */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_first<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_last<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_LOOPBACK_MAX_PBUFS</span></span>
    <span class="token class-name">u16_t</span> loop_cnt_current<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_LOOPBACK_MAX_PBUFS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><h3 id="netif-add-å‡½æ•°"><a href="#netif-add-å‡½æ•°" class="header-anchor">#</a> netif_add å‡½æ•°</h3> <p>åœ¨è°ƒç”¨ <code>netif_add</code> å‡½æ•°ä¹‹å‰éœ€è¦åˆå§‹åŒ–ä¸»æœºçš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œç½‘å…³ç­‰ä¿¡æ¯ï¼š</p> <p><code>IP4_ADDR(&amp;ipaddr,192,168,1,100)</code></p> <p><code>ip_addr_set_zero_ip4(&amp;ipaddr)</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * @brief å‘ LwIP ä¸­æ·»åŠ æ–°çš„ç½‘å¡
 *
 * @param netifï¼šnetif ç»“æ„ä½“ï¼ˆè°ƒç”¨å‡½æ•°ä¹‹å‰éœ€è¦ä¸ºè¯¥ç»“æ„ä½“åˆ†é…å¥½å†…å­˜ï¼‰
 * @param ipaddrï¼šè¯¥ç½‘å¡çš„ IP åœ°å€
 * @param netmaskï¼šè¯¥ç½‘å¡çš„å­ç½‘æ©ç 
 * @param gwï¼šè¯¥ç½‘å¡çš„é»˜è®¤ç½‘å…³
 * @param stateï¼š è¯¥ç½‘å¡çš„ç§æœ‰æ•°æ®ï¼ˆLwIP æ— æ³•å¾—çŸ¥è¯¥æ•°æ®çš„å…·ä½“å«ä¹‰ï¼‰
 * @param initï¼šåˆå§‹åŒ–è¯¥ç½‘å¡æ—¶çš„å›è°ƒå‡½æ•°
 * @param inputï¼š å°†æ•°æ®åŒ…ä¼ é€’ç»™ LwIP ä¸Šå±‚åè®®çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰æ“ä½œç³»ç»Ÿï¼Œå»ºè®®ä½¿ç”¨ netif_inputï¼Œå®ƒä¼šå°†æ•°æ®åŒ…ç›´æ¥ä¼ ç»™åè®®æ ˆï¼›å¦‚æœæœ‰æ“ä½œç³»ç»Ÿï¼Œå»ºè®®ä½¿ç”¨ tcpip_inputï¼Œå®ƒä¼šå‘ TCPIP çº¿ç¨‹å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¼šæ ¹æ®ç½‘å¡çš„ NETIF_FLAG_ETHARP å’Œ NETIF_FLAG_ETHERNET æ ‡å¿—æ¥å†³å®šå°†æ•°æ®åŒ…è½¬å‘ç»™ ethernet_input å‡½æ•°è¿˜æ˜¯ ip_input å‡½æ•°ã€‚
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span> <span class="token function">netif_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
          <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>netmask<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>gw<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
          <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">,</span> netif_init_fn init<span class="token punctuation">,</span> netif_input_fn input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  <span class="token class-name">s8_t</span> i<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SINGLE_NETIF</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif_default <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;single netif already set&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: invalid netif&quot;</span><span class="token punctuation">,</span> netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;netif_add: No init function given&quot;</span><span class="token punctuation">,</span> init <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipaddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ipaddr <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netmask <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netmask <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gw <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gw <span class="token operator">=</span> <span class="token function">ip_2_ip4</span><span class="token punctuation">(</span>IP4_ADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* æ¸…ç©ºç½‘å¡ä¹‹å‰çš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ç­‰å­—æ®µçš„ä¿¡æ¯ */</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip_addr_set_zero_ip4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>output <span class="token operator">=</span> netif_null_output_ip4<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ip_addr_set_zero_ip6</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netif<span class="token operator">-&gt;</span>ip6_addr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_INVALID<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_ADDRESS_LIFETIMES</span></span>
    netif<span class="token operator">-&gt;</span>ip6_addr_valid_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
    netif<span class="token operator">-&gt;</span>ip6_addr_pref_life<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> IP6_ADDR_LIFE_STATIC<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_ADDRESS_LIFETIMES */</span></span>
  <span class="token punctuation">}</span>
  netif<span class="token operator">-&gt;</span>output_ip6 <span class="token operator">=</span> netif_null_output_ip6<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
  <span class="token function">NETIF_SET_CHECKSUM_CTRL</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> NETIF_CHECKSUM_ENABLE_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>mtu <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">netif_get_client_data</span></span>
  <span class="token function">memset</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>client_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NUM_NETIF_CLIENT_DATA */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_AUTOCONFIG</span></span>
  <span class="token comment">/* é»˜è®¤ä¸ä¼šè‡ªåŠ¨é…ç½® IPv6 åœ°å€ */</span>
  netif<span class="token operator">-&gt;</span>ip6_autoconfig_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span></span>
  <span class="token function">nd6_restart_netif</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_STATUS_CALLBACK</span></span>
  netif<span class="token operator">-&gt;</span>status_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_LINK_CALLBACK</span></span>
  netif<span class="token operator">-&gt;</span>link_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
  netif<span class="token operator">-&gt;</span>igmp_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_IPV6_MLD</span></span>
  netif<span class="token operator">-&gt;</span>mld_mac_filter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK</span></span>
  netif<span class="token operator">-&gt;</span>loop_first <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>loop_last <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK */</span></span>

  <span class="token comment">/* è®°å½•ç½‘å¡çš„ä¿¡æ¯ */</span>
  netif<span class="token operator">-&gt;</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> netif_num<span class="token punctuation">;</span>
  netif<span class="token operator">-&gt;</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>

  <span class="token function">NETIF_RESET_HINTS</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOOPBACK <span class="token operator">&amp;&amp;</span> LWIP_LOOPBACK_MAX_PBUFS</span></span>
  netif<span class="token operator">-&gt;</span>loop_cnt_current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ENABLE_LOOPBACK &amp;&amp; LWIP_LOOPBACK_MAX_PBUFS */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token comment">/* è®¾ç½®ç½‘å¡çš„ IP åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œé»˜è®¤ç½‘å…³ */</span>
  <span class="token function">netif_set_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ipaddr<span class="token punctuation">,</span> netmask<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>

  <span class="token comment">/* è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘å¡åˆå§‹åŒ–å‡½æ•° */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span> <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6 <span class="token operator">&amp;&amp;</span> LWIP_ND6_ALLOW_RA_UPDATES</span></span>
  <span class="token comment">/* Initialize the MTU for IPv6 to the one set by the netif driver.
     This can be updated later by RA. */</span>
  netif<span class="token operator">-&gt;</span>mtu6 <span class="token operator">=</span> netif<span class="token operator">-&gt;</span>mtu<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_ND6_ALLOW_RA_UPDATES */</span></span>

<span class="token comment">/* ä¸ºå½“å‰ç½‘å¡ç¡®å®šå”¯ä¸€çš„ num */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_SINGLE_NETIF</span></span>
  <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num_netifs<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        netif<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      num_netifs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>netif2 <span class="token operator">=</span> netif_list<span class="token punctuation">;</span> netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> netif2 <span class="token operator">=</span> netif2<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;netif already added&quot;</span><span class="token punctuation">,</span> netif2 <span class="token operator">!=</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_netifs<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;too many netifs, max. supported number is 255&quot;</span><span class="token punctuation">,</span> num_netifs <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>netif2<span class="token operator">-&gt;</span>num <span class="token operator">==</span> netif<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          netif<span class="token operator">-&gt;</span>num<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>netif2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">==</span> <span class="token number">254</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    netif_num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* å°†å½“å‰ç½‘å¡æ’å…¥åˆ°å…¨å±€çš„ netif_list é“¾è¡¨ä¸­ï¼Œæ’å…¥æ–¹å¼ï¼šå¤´æ’ */</span>
  netif<span class="token operator">-&gt;</span>next <span class="token operator">=</span> netif_list<span class="token punctuation">;</span>
  netif_list <span class="token operator">=</span> netif<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* &quot;LWIP_SINGLE_NETIF */</span></span>
  <span class="token function">mib2_netif_added</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
  <span class="token comment">/* IGMP å¼€å§‹å·¥ä½œ */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> NETIF_FLAG_IGMP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">igmp_start</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;netif: added interface %c%c IP&quot;</span><span class="token punctuation">,</span>
                            netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; addr &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; netmask &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot; gw &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ip4_addr_debug_print</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">netif_invoke_ext_callback</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> LWIP_NSC_NETIF_ADDED<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> netif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br></div></div><h3 id="åˆå§‹åŒ–-lwip-çš„ä¸€èˆ¬æµç¨‹"><a href="#åˆå§‹åŒ–-lwip-çš„ä¸€èˆ¬æµç¨‹" class="header-anchor">#</a> åˆå§‹åŒ– LwIP çš„ä¸€èˆ¬æµç¨‹</h3> <p><img src="/blog/assets/img/setup_lwip.c67664dc.png" alt="åˆå§‹åŒ– LwIP"></p> <h2 id="lwip-çš„å†…å­˜ç®¡ç†"><a href="#lwip-çš„å†…å­˜ç®¡ç†" class="header-anchor">#</a> LwIP çš„å†…å­˜ç®¡ç†</h2> <p>LwIP çš„å†…å­˜ç®¡ç†æœºåˆ¶å¤§è‡´ä¸Šå¯ä»¥åˆ†æˆä¸‰ç§ï¼š</p> <ol><li>C æ ‡å‡†åº“è‡ªå¸¦çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼ˆå³ä½¿ç”¨ mallocã€freeç­‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çš„<strong>æ‰§è¡Œæ—¶é—´æ˜¯ä¸ç¡®å®šçš„</strong>ï¼‰</li> <li>LwIP çš„<strong>åŠ¨æ€å†…å­˜å †</strong>åˆ†é…ç­–ç•¥</li> <li>LwIP çš„<strong>åŠ¨æ€å†…å­˜æ± </strong>åˆ†é…ç­–ç•¥</li></ol> <div class="custom-block tip"><p class="custom-block-title">LwIP ä½¿ç”¨åŠ¨æ€å†…å­˜æ± çš„åŸå› </p> <p>LwIP ä¸­æœ‰å¾ˆå¤šå›ºå®šçš„æ•°æ®ç»“æ„ç©ºé—´ï¼Œæ¯”å¦‚ TCP é¦–éƒ¨ï¼ŒUDP é¦–éƒ¨ï¼ŒIP é¦–éƒ¨ï¼ŒEthernet é¦–éƒ¨ç­‰ã€‚é‡‡ç”¨å†…å­˜æ± ç­–ç•¥åˆ†é…è¿™äº›å›ºå®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥å¤§å¤§æå‡æ•ˆç‡ï¼Œè¿˜ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p></div> <h3 id="åŠ¨æ€å†…å­˜æ± "><a href="#åŠ¨æ€å†…å­˜æ± " class="header-anchor">#</a> åŠ¨æ€å†…å­˜æ± </h3> <h4 id="lwip-mempool"><a href="#lwip-mempool" class="header-anchor">#</a> LWIP_MEMPOOL</h4> <p>åœ¨ LwIP å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®å…·ä½“é…ç½®åœ¨å†…å­˜ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜æ± ï¼Œå¦‚å®šä¹‰äº† <code>LWIP_UDP</code>ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ UDP åè®®æ§åˆ¶å—éœ€è¦çš„å†…å­˜æ± å°±ä¼šè¢«åˆå§‹åŒ–ã€‚<code>lwip/priv/memp_std.h</code> ä¸­ä½¿ç”¨ <code>LWIP_MEMPOOL</code> å®å®šä¹‰äº†è®¸å¤šæ•°æ®ï¼Œä½†æ˜¯è¿™äº›æ•°æ®çš„å…·ä½“å«ä¹‰è¦å–å†³äºå…·ä½“çš„ <code>LWIP_MEMPOOL</code> ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * A list of internal pools used by LWIP.
 *
 * LWIP_MEMPOOL(pool_name, number_elements, element_size, pool_description)
 *     creates a pool name MEMP_pool_name. description is used in stats.c
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_RAW</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>RAW_PCB<span class="token punctuation">,</span>        MEMP_NUM_RAW_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;RAW_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_RAW */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_UDP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>UDP_PCB<span class="token punctuation">,</span>        MEMP_NUM_UDP_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;UDP_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_UDP */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_PCB<span class="token punctuation">,</span>        MEMP_NUM_TCP_PCB<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;TCP_PCB&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_PCB_LISTEN<span class="token punctuation">,</span> MEMP_NUM_TCP_PCB_LISTEN<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_pcb_listen</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;TCP_PCB_LISTEN&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>TCP_SEG<span class="token punctuation">,</span>        MEMP_NUM_TCP_SEG<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcp_seg</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">&quot;TCP_SEG&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP</span></span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>IGMP_GROUP<span class="token punctuation">,</span>     MEMP_NUM_IGMP_GROUP<span class="token punctuation">,</span>      <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">igmp_group</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token string">&quot;IGMP_GROUP&quot;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>

<span class="token comment">/*
 * A list of pools of pbuf's used by LWIP.
 *
 * LWIP_PBUF_MEMPOOL(pool_name, number_elements, pbuf_payload_size, pool_description)
 *     creates a pool name MEMP_pool_name. description is used in stats.c
 *     This allocates enough space for the pbuf struct and a payload.
 *     (Example: pbuf_payload_size=0 allocates only size for the struct)
 */</span>
<span class="token function">LWIP_MEMPOOL</span><span class="token punctuation">(</span>PBUF<span class="token punctuation">,</span>           MEMP_NUM_PBUF<span class="token punctuation">,</span>            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token string">&quot;PBUF_REF/ROM&quot;</span><span class="token punctuation">)</span>
<span class="token function">LWIP_PBUF_MEMPOOL</span><span class="token punctuation">(</span>PBUF_POOL<span class="token punctuation">,</span> PBUF_POOL_SIZE<span class="token punctuation">,</span>           PBUF_POOL_BUFSIZE<span class="token punctuation">,</span>             <span class="token string">&quot;PBUF_POOL&quot;</span><span class="token punctuation">)</span>


<span class="token comment">/*
 * Allow for user-defined pools; this must be explicitly set in lwipopts.h
 * since the default is to NOT look for lwippools.h
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MEMP_USE_CUSTOM_POOLS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwippools.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MEMP_USE_CUSTOM_POOLS */</span></span>

<span class="token comment">/*
 * REQUIRED CLEANUP: Clear up so we don't get &quot;multiply defined&quot; error later
 * (#undef is ignored for something that is not defined)
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MEMPOOL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL_START</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_MALLOC_MEMPOOL_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">LWIP_PBUF_MEMPOOL</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="å®šä¹‰å†…å­˜æ± ç±»å‹"><a href="#å®šä¹‰å†…å­˜æ± ç±»å‹" class="header-anchor">#</a> å®šä¹‰å†…å­˜æ± ç±»å‹</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** Create the list of all memory pools managed by memp. MEMP_MAX represents a NULL pool at the end */</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_MEMPOOL</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span>  MEMP_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">,</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>
  MEMP_MAX
<span class="token punctuation">}</span> <span class="token class-name">memp_t</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="å£°æ˜å†…å­˜æ± "><a href="#å£°æ˜å†…å­˜æ± " class="header-anchor">#</a> å£°æ˜å†…å­˜æ± </h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_MEMPOOL</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span> <span class="token function">LWIP_MEMPOOL_DECLARE</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span><span class="token keyword">const</span> memp_pools<span class="token punctuation">[</span>MEMP_MAX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_MEMPOOL</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span> <span class="token operator">&amp;</span>memp_ </span><span class="token punctuation">##</span> <span class="token expression">name<span class="token punctuation">,</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lwip/priv/memp_std.h&quot;</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>æ¯ç§å†…å­˜æ± ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªç»“æ„ä½“ï¼Œæ¯”å¦‚<code>const struct memp_desc memp_RAW_PCB</code>ï¼Œé‡Œé¢è®°å½•äº†å†…å­˜å—çš„æ•°é‡ï¼Œå¤§å°ï¼Œèµ·å§‹åœ°å€ç­‰ä¿¡æ¯ã€‚</p> <h4 id="å†…å­˜æ± åˆå§‹åŒ–"><a href="#å†…å­˜æ± åˆå§‹åŒ–" class="header-anchor">#</a> å†…å­˜æ± åˆå§‹åŒ–</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Initializes lwIP built-in pools.
 * Related functions: memp_malloc, memp_free
 *
 * Carves out memp_memory into linked lists for each pool-type.
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">u16_t</span> i<span class="token punctuation">;</span>

  <span class="token comment">/* for every pool: */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">LWIP_ARRAYSIZE</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">memp_init_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * Initialize custom memory pool.
 * Related functions: memp_malloc_pool, memp_free_pool
 *
 * @param desc pool to initialize
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_init_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>

  <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN</span><span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* force memset on pool memory */</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>memp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>desc<span class="token operator">-&gt;</span>num <span class="token operator">*</span> <span class="token punctuation">(</span>MEMP_SIZE <span class="token operator">+</span> desc<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* create a linked list of memp elements */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> desc<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memp<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span>
    <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token punctuation">;</span>
    <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
    memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>memp <span class="token operator">+</span> MEMP_SIZE <span class="token operator">+</span> desc<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><img src="/blog/assets/img/lwip_memp.1fc0c568.png" alt="å†…å­˜æ± åˆå§‹åŒ–"></p> <h4 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="header-anchor">#</a> å†…å­˜åˆ†é…</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Get an element from a specific pool.
 *
 * @param type the pool to get an element from
 *
 * @return a pointer to the allocated memory or a NULL pointer on error
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memp_malloc</span><span class="token punctuation">(</span><span class="token class-name">memp_t</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: type &lt; MEMP_MAX&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> MEMP_MAX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp <span class="token operator">=</span> <span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> memp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * Get an element from a custom pool.
 *
 * @param desc the pool to get an element from
 *
 * @return a pointer to the allocated memory or a NULL pointer on error
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memp_malloc_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid pool desc&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">do_memp_malloc_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">SYS_ARCH_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span> <span class="token comment">// å¾—åˆ°å¯¹åº”å†…å­˜å—ä¸­çš„ç¬¬ä¸€ä¸ªç©ºé—²å†…å­˜å—</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>memp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span> <span class="token comment">// ç§»åŠ¨tabæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜å—</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: memp properly aligned&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>memp <span class="token operator">%</span> MEM_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* cast through u8_t* to get rid of alignment warnings */</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>memp <span class="token operator">+</span> MEMP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEMP_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;memp_malloc: out of memory in pool %s\n&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h4 id="å†…å­˜é‡Šæ”¾"><a href="#å†…å­˜é‡Šæ”¾" class="header-anchor">#</a> å†…å­˜é‡Šæ”¾</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span>memp<span class="token punctuation">;</span>
  <span class="token function">SYS_ARCH_DECL_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;memp_free: mem properly aligned&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>mem <span class="token operator">%</span> MEM_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
  memp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">memp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">-</span> MEMP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">SYS_ARCH_PROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  memp<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab<span class="token punctuation">;</span>
  <span class="token operator">*</span>desc<span class="token operator">-&gt;</span>tab <span class="token operator">=</span> memp<span class="token punctuation">;</span>

  <span class="token function">SYS_ARCH_UNPROTECT</span><span class="token punctuation">(</span>old_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Put a custom pool element back into its pool.
 *
 * @param desc the pool where to put mem
 * @param mem the memp element to free
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_free_pool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">memp_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid pool desc&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>desc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Put an element back into its pool.
 *
 * @param type the pool where to put mem
 * @param mem the memp element to free
 */</span>
<span class="token keyword">void</span> <span class="token function">memp_free</span><span class="token punctuation">(</span><span class="token class-name">memp_t</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;memp_free: type &lt; MEMP_MAX&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> MEMP_MAX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">do_memp_free_pool</span><span class="token punctuation">(</span>memp_pools<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="åŠ¨æ€å†…å­˜å †"><a href="#åŠ¨æ€å†…å­˜å †" class="header-anchor">#</a> åŠ¨æ€å†…å­˜å †</h3> <p>LwIP ä¸­çš„åŠ¨æ€å†…å­˜å †ç®¡ç†å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯ C æ ‡å‡†åº“è‡ªå¸¦çš„å†…å­˜ç®¡ç†ç­–ç•¥ï¼Œå¦ä¸€ç§æ˜¯ LwIP è‡ªèº«å®ç°çš„å†…å­˜å †ç®¡ç†ç­–ç•¥ã€‚è¿™ä¸¤è€…çš„é€‰æ‹©éœ€è¦é€šè¿‡ <code>MEM_LIBC_MALLOC</code> å®æ¥é€‰æ‹©ã€‚</p> <h4 id="å†…å­˜å †çš„ç»„ç»‡ç»“æ„"><a href="#å†…å­˜å †çš„ç»„ç»‡ç»“æ„" class="header-anchor">#</a> å†…å­˜å †çš„ç»„ç»‡ç»“æ„</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * The heap is made up as a list of structs of this type.
 * This does not have to be aligned since for getting its size,
 * we only use the macro SIZEOF_STRUCT_MEM, which automatically aligns.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token punctuation">{</span>
  <span class="token comment">/** index (-&gt; ram[next]) of the next struct */</span>
  <span class="token class-name">mem_size_t</span> next<span class="token punctuation">;</span>
  <span class="token comment">/** index (-&gt; ram[prev]) of the previous struct */</span>
  <span class="token class-name">mem_size_t</span> prev<span class="token punctuation">;</span>
  <span class="token comment">/** 1: this area is used; 0: this area is unused */</span>
  <span class="token class-name">u8_t</span> used<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">MEM_OVERFLOW_CHECK</span></span>
  <span class="token comment">/** this keeps track of the user allocation size for guard checks */</span>
  <span class="token class-name">mem_size_t</span> user_size<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** All allocated blocks will be MIN_SIZE bytes big, at least!
 * MIN_SIZE can be overridden to suit your needs. Smaller values save space,
 * larger values could prevent too small blocks to fragment the RAM too much. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MIN_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_SIZE</span>             <span class="token expression"><span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* MIN_SIZE */</span></span>

<span class="token comment">/** the heap. we need one struct mem at the end and some room for alignment */</span>
<span class="token function">LWIP_DECLARE_MEMORY_ALIGNED</span><span class="token punctuation">(</span>ram_heap<span class="token punctuation">,</span> MEM_SIZE_ALIGNED <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2U</span> <span class="token operator">*</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_RAM_HEAP_POINTER</span> <span class="token expression">ram_heap</span></span>

<span class="token comment">/** pointer to the heap (ram_heap): for alignment, ram is now a pointer instead of an array */</span>
<span class="token keyword">static</span> <span class="token class-name">u8_t</span> <span class="token operator">*</span>ram<span class="token punctuation">;</span>
<span class="token comment">/** the last entry, always unused! */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>ram_end<span class="token punctuation">;</span>

<span class="token comment">/** pointer to the lowest free block, this is used for faster search */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span> LWIP_MEM_LFREE_VOLATILE lfree<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="å†…å­˜å †åˆå§‹åŒ–"><a href="#å†…å­˜å †åˆå§‹åŒ–" class="header-anchor">#</a> å†…å­˜å †åˆå§‹åŒ–</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Zero the heap and initialize start, end and lowest-free
 */</span>
<span class="token keyword">void</span> <span class="token function">mem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;Sanity check alignment&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span>SIZEOF_STRUCT_MEM <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* align the heap */</span>
  ram <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN</span><span class="token punctuation">(</span>LWIP_RAM_HEAP_POINTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* initialize the start of the heap */</span>
  mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ram<span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>next <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* initialize the end of the heap */</span>
  ram_end <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>next <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  ram_end<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> MEM_SIZE_ALIGNED<span class="token punctuation">;</span>
  <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* initialize the lowest-free pointer to the start of the heap */</span>
  lfree <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ram<span class="token punctuation">;</span>

  <span class="token function">MEM_STATS_AVAIL</span><span class="token punctuation">(</span>avail<span class="token punctuation">,</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sys_mutex_new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span> <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create mem_mutex&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="/blog/assets/img/lwip_heap.1ac8ef3c.png" alt="å†…å­˜å †åˆå§‹åŒ–"></p> <h4 id="å†…å­˜åˆ†é…-2"><a href="#å†…å­˜åˆ†é…-2" class="header-anchor">#</a> å†…å­˜åˆ†é…</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Allocate a block of memory with a minimum of 'size' bytes.
 *
 * @param size_in is the minimum size of the requested block in bytes.
 * @return pointer to allocated memory or NULL if no free memory was found.
 *
 * Note that the returned value will always be aligned (as defined by MEM_ALIGNMENT).
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mem_malloc</span><span class="token punctuation">(</span><span class="token class-name">mem_size_t</span> size_in<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">mem_size_t</span> ptr<span class="token punctuation">,</span> ptr2<span class="token punctuation">,</span> size<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">,</span> <span class="token operator">*</span>mem2<span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_DECL_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size_in <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* å°†ç”¨æˆ·ç”³è¯·çš„å†…å­˜å¤§å°è¿›è¡Œå¯¹é½æ“ä½œ */</span>
  size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">mem_size_t</span><span class="token punctuation">)</span><span class="token function">LWIP_MEM_ALIGN_SIZE</span><span class="token punctuation">(</span>size_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MIN_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* every data block must be at least MIN_SIZE_ALIGNED long */</span>
    size <span class="token operator">=</span> MIN_SIZE_ALIGNED<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> size_in<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* äº’æ–¥è®¿é—® */</span>
  <span class="token function">sys_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* éå†ç©ºé—²å†…å­˜å—é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªåˆé€‚çš„å†…å­˜å— */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">mem_to_ptr</span><span class="token punctuation">(</span>lfree<span class="token punctuation">)</span><span class="token punctuation">;</span> ptr <span class="token operator">&lt;</span> MEM_SIZE_ALIGNED <span class="token operator">-</span> size<span class="token punctuation">;</span>
         ptr <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mem <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>mem<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* å†…å­˜å—å¯èƒ½å¾ˆå¤§ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡å¼€ */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> MIN_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ptr2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">mem_size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;invalid next ptr&quot;</span><span class="token punctuation">,</span>ptr2 <span class="token operator">!=</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* create mem2 struct */</span>
          mem2 <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>ptr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>next <span class="token operator">=</span> mem<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
          mem2<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
          <span class="token comment">/* and insert it between mem and mem-&gt;next */</span>
          mem<span class="token operator">-&gt;</span>next <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
          mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem2<span class="token operator">-&gt;</span>next <span class="token operator">!=</span> MEM_SIZE_ALIGNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>mem2<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token operator">-&gt;</span>prev <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">MEM_STATS_INC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token function">MEM_STATS_INC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token function">mem_to_ptr</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> lfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>cur <span class="token operator">=</span> lfree<span class="token punctuation">;</span>
          <span class="token comment">/* Find next free block after mem and update lowest free pointer */</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>used <span class="token operator">&amp;&amp;</span> cur <span class="token operator">!=</span> ram_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cur <span class="token operator">=</span> <span class="token function">ptr_to_mem</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          lfree <span class="token operator">=</span> cur<span class="token punctuation">;</span>
          <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: !lfree-&gt;used&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lfree <span class="token operator">==</span> ram_end<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>lfree<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LWIP_MEM_ALLOC_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: allocated memory not above ram_end.&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> size <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>ram_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: allocated memory properly aligned.&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM<span class="token punctuation">)</span> <span class="token operator">%</span> MEM_ALIGNMENT <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: sanity check alignment&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> SIZEOF_STRUCT_MEM <span class="token operator">+</span> MEM_SANITY_OFFSET<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token function">MEM_STATS_INC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_ALLOC_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sys_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_malloc: could not allocate %&quot;</span>S16_F<span class="token string">&quot; bytes\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">s16_t</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h4 id="å†…å­˜é‡Šæ”¾-2"><a href="#å†…å­˜é‡Šæ”¾-2" class="header-anchor">#</a> å†…å­˜é‡Šæ”¾</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Put a struct mem back on the heap
 *
 * @param rmem is the data portion of a struct mem as returned by a previous
 *             call to mem_malloc()
 */</span>
<span class="token keyword">void</span> <span class="token function">mem_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>rmem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_FREE_DECL_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rmem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free(p == NULL) was called.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token punctuation">)</span>rmem<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MEM_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: sanity check alignment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: sanity check alignment\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Get the corresponding struct mem: */</span>
  <span class="token comment">/* cast through void* to get rid of alignment warnings */</span>
  mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mem</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>rmem <span class="token operator">-</span> <span class="token punctuation">(</span>SIZEOF_STRUCT_MEM <span class="token operator">+</span> MEM_SANITY_OFFSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">&lt;</span> ram <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>rmem <span class="token operator">+</span> MIN_SIZE_ALIGNED <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>ram_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* protect the heap from concurrent access */</span>
  <span class="token function">LWIP_MEM_FREE_PROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* mem has to be in a used state */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: double free&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: double free?\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* æ£€æŸ¥å†…å­˜å—åœ¨é“¾è¡¨ä¸­çš„è¿æ¥æ˜¯å¦æ­£å¸¸ */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mem_link_valid</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_MEM_ILLEGAL_FREE</span><span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: non-linked: double free&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>MEM_DEBUG <span class="token operator">|</span> LWIP_DBG_LEVEL_SEVERE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;mem_free: illegal memory: non-linked: double free?\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* protect mem stats from concurrent access */</span>
    <span class="token function">MEM_STATS_INC_LOCKED</span><span class="token punctuation">(</span>illegal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* mem is now unused. */</span>
  mem<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">&lt;</span> lfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* the newly freed struct is now the lowest */</span>
    lfree <span class="token operator">=</span> mem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">MEM_STATS_DEC_USED</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> mem<span class="token operator">-&gt;</span>next <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token class-name">mem_size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">-</span> ram<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* å°è¯•è¿›è¡Œå†…å­˜å—åˆå¹¶ï¼ˆåªè¦æ–°é‡Šæ”¾çš„å†…å­˜å—ä¸ä¸Šä¸€ä¸ªæˆ–è€…ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜å—åœ¨åœ°å€ä¸Šæ˜¯è¿ç»­çš„ï¼Œåˆ™è¿›è¡Œåˆå¹¶ */</span>
  <span class="token function">plug_holes</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MEM_SANITY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_MEM_FREE_UNPROTECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h3 id="lwip-ä¸­å…³äºå†…å­˜ç®¡ç†çš„é…ç½®"><a href="#lwip-ä¸­å…³äºå†…å­˜ç®¡ç†çš„é…ç½®" class="header-anchor">#</a> LwIP ä¸­å…³äºå†…å­˜ç®¡ç†çš„é…ç½®</h3> <table><thead><tr><th>å®é…ç½®</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>MEM_LIBC_MALLOC</td> <td>è®¾ç½®ä¸º 1 è¡¨ç¤ºä½¿ç”¨ C æ ‡å‡†åº“è‡ªå¸¦çš„åˆ†é…ç­–ç•¥ï¼›è®¾ç½®ä¸º 0 è¡¨ç¤ºä½¿ç”¨ LwIP è‡ªå·±å®ç°çš„åŠ¨æ€å†…å­˜ç®¡ç†ç­–ç•¥ã€‚LwIP çš„åŠ¨æ€å†…å­˜ç®¡ç†ç­–ç•¥åˆåˆ†ä¸ºä¸¤ç§å®ç°å½¢å¼ï¼šä¸€ç§é€šè¿‡å†…å­˜å †ï¼ˆHEAPï¼‰ç®¡ç†ç­–ç•¥å®ç°å†…å­˜ç®¡ç†ï¼ˆå¤§æ•°ç»„ï¼‰ï¼Œå¦ä¸€ç§é€šè¿‡å†…å­˜æ± ï¼ˆPOOLï¼‰ç®¡ç†ç­–ç•¥å®ç°å†…å­˜ç®¡ç†ï¼ˆäº‹å…ˆå¼€è¾Ÿå¥½çš„å†…å­˜æ± ï¼‰</td></tr> <tr><td>MEMP_MEM_MALLOC</td> <td>æ˜¯å¦ä½¿ç”¨ LwIP å†…å­˜å †åˆ†é…ç­–ç•¥å®ç°å†…å­˜æ± åˆ†é…ï¼ˆä»å†…å­˜æ± ä¸­è·å–å†…å­˜æ—¶ï¼Œå®é™…æ˜¯ä»å†…å­˜å †ä¸­åˆ†é…ï¼‰</td></tr> <tr><td>MEM_USE_POOLS</td> <td>æ˜¯å¦ä½¿ç”¨ LwIP å†…å­˜æ± åˆ†é…ç­–ç•¥å®ç°å†…å­˜å †çš„åˆ†é…ï¼ˆä»å†…å­˜å †ä¸­è·å–å†…å­˜æ—¶ï¼Œå®é™…æ˜¯ä»å†…å­˜æ± ä¸­åˆ†é…ï¼‰</td></tr></tbody></table> <h2 id="ç½‘ç»œæ•°æ®åŒ…"><a href="#ç½‘ç»œæ•°æ®åŒ…" class="header-anchor">#</a> ç½‘ç»œæ•°æ®åŒ…</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>LwIP æåŠ›é¿å…åœ¨å±‚ä¸å±‚ä¹‹é—´è¿›è¡Œæ•°æ®æ‹·è´ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰é‡‡å–å¾ˆæ˜ç¡®çš„åˆ†å±‚ç»“æ„ï¼Œå„å±‚ä¹‹é—´çš„éƒ¨åˆ†æ•°æ®åœ¨å…¶å®ƒå±‚æ˜¯å¯è§çš„ï¼Œå„å±‚ä¹‹é—´å­˜åœ¨äº¤å‰å­˜å–æ•°æ®çš„ç°è±¡ã€‚</p></div> <h3 id="pbuf-ç»“æ„ä½“"><a href="#pbuf-ç»“æ„ä½“" class="header-anchor">#</a> pbuf ç»“æ„ä½“</h3> <p><strong>pbuf</strong> æ˜¯ä¸€ä¸ªæè¿°åè®®æ ˆä¸­æ•°æ®åŒ…çš„æ•°æ®ç»“æ„ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** Main packet buffer struct */</span>
<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token punctuation">{</span>
  <span class="token comment">/** ç½‘ç»œä¸­çš„æ•°æ®åŒ…å¯èƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥é‡‡ç”¨é“¾è¡¨çš„å½¢å¼å°†æ‰€æœ‰ pbuf åŒ…è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ… */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment">/** æŒ‡å‘å®é™…æ•°æ®åŒºåŸŸ */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>payload<span class="token punctuation">;</span>
  <span class="token comment">/** å½“å‰ pbuf åŠå…¶åç»­ pbuf æ‰€æœ‰æ•°æ®çš„é•¿åº¦
   *  å¦‚æœå½“å‰æ˜¯é“¾è¡¨ä¸Šçš„ç¬¬ä¸€ä¸ªpbufï¼Œåˆ™è®°å½•ç€æ•´ä¸ª pbuf é“¾è¡¨ä¸­æ‰€æœ‰çš„pbufä¸­çš„æ•°æ®é•¿åº¦
   */</span>
  <span class="token class-name">u16_t</span> tot_len<span class="token punctuation">;</span>
  <span class="token comment">/** å½“å‰pbufä¸­æœ‰æ•ˆçš„æ•°æ®é•¿åº¦ */</span>
  <span class="token class-name">u16_t</span> len<span class="token punctuation">;</span>
  <span class="token comment">/** pbufçš„ç±»å‹
    */</span>
  <span class="token class-name">u8_t</span> type_internal<span class="token punctuation">;</span>
  <span class="token comment">/** misc flags */</span>
  <span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
  <span class="token comment">/**
   * å½“å‰ pbuf çš„å¼•ç”¨è®¡æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ª pbuf çš„æ—¶å€™ï¼Œä¼šå°†å…¶è®¾ç½®ä¸º1ï¼›å½“æœ‰å…¶å®ƒæŒ‡é’ˆæŒ‡å‘å½“å‰pbufçš„æ—¶å€™ä¼šåŠ 1
   */</span>
  LWIP_PBUF_REF_T ref<span class="token punctuation">;</span>
  <span class="token comment">/** è®°å½•ä¼ å…¥çš„æ•°æ®åŒ…ä¸­netifçš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯netifä¸­çš„numå­—æ®µ */</span>
  <span class="token class-name">u8_t</span> if_idx<span class="token punctuation">;</span>
  <span class="token comment">/** In case the user needs to store data custom data on a pbuf */</span>
  LWIP_PBUF_CUSTOM_DATA
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="pbuf-çš„ç±»å‹"><a href="#pbuf-çš„ç±»å‹" class="header-anchor">#</a> pbuf çš„ç±»å‹</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
  <span class="token comment">/** pbuf data is stored in RAM, used for TX mostly, struct pbuf and its payload
      are allocated in one piece of contiguous memory (so the first payload byte
      can be calculated from struct pbuf).
      pbuf_alloc() allocates PBUF_RAM pbufs as unchained pbufs (although that might
      change in future versions).
      This should be used for all OUTGOING packets (TX).*/</span>
  PBUF_RAM <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_ALLOC_FLAG_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_FLAG_STRUCT_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_HEAP<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/** pbuf data is stored in ROM, i.e. struct pbuf and its payload are located in
      totally different memory areas. Since it points to ROM, payload does not
      have to be copied when queued for transmission. */</span>
  PBUF_ROM <span class="token operator">=</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF<span class="token punctuation">,</span>
  <span class="token comment">/** pbuf comes from the pbuf pool. Much like PBUF_ROM but payload might change
      so it has to be duplicated when queued before transmitting, depending on
      who has a 'ref' to it. */</span>
  PBUF_REF <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_TYPE_FLAG_DATA_VOLATILE <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/** pbuf payload refers to RAM. This one comes from a pool and should be used
      for RX. Payload can be chained (scatter-gather RX) but like PBUF_RAM, struct
      pbuf and its payload are allocated in one piece of contiguous memory (so
      the first payload byte can be calculated from struct pbuf).
      Don't use this for TX, if the pool becomes empty e.g. because of TCP queuing,
      you are unable to receive TCP acks! */</span>
  PBUF_POOL <span class="token operator">=</span> <span class="token punctuation">(</span>PBUF_ALLOC_FLAG_RX <span class="token operator">|</span> PBUF_TYPE_FLAG_STRUCT_DATA_CONTIGUOUS <span class="token operator">|</span> PBUF_TYPE_ALLOC_SRC_MASK_STD_MEMP_PBUF_POOL<span class="token punctuation">)</span>
<span class="token punctuation">}</span> pbuf_type<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="pbuf-ram-ç±»å‹çš„-pbuf"><a href="#pbuf-ram-ç±»å‹çš„-pbuf" class="header-anchor">#</a> PBUF_RAM ç±»å‹çš„ pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_ram.408a7517.png" alt="PBUF_RAMç±»å‹çš„ pbuf"></p> <p>PBUF_RAM ç±»å‹çš„ pbuf æ˜¯é€šè¿‡å†…å­˜å †åˆ†é…å¾—åˆ°ï¼Œæ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­çš„ layer(offset) å°±æ˜¯å„å±‚åè®®çš„é¦–éƒ¨ï¼Œæ¯”å¦‚ TCP æŠ¥æ–‡é¦–éƒ¨ã€IP é¦–éƒ¨ã€ä»¥å¤ªç½‘å¸§é¦–éƒ¨ç­‰ã€‚LwIP åè®®æ ˆä¸­çš„å‘é€æ•°æ®åŒ…éƒ½ä¼šé‡‡ç”¨è¿™ç§å½¢å¼ã€‚</p> <h4 id="pbuf-pool-ç±»å‹çš„-pbuf"><a href="#pbuf-pool-ç±»å‹çš„-pbuf" class="header-anchor">#</a> PBUF_POOL ç±»å‹çš„ pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_pool.e9801004.png" alt="PBUF_POOLç±»å‹çš„ pbuf"></p> <p>PBUF_POOL ç±»å‹çš„ pbuf æ˜¯é€šè¿‡å†…å­˜æ± åˆ†é…å¾—åˆ°ï¼Œä¸ PBUF_RAM ç±»ä¼¼ï¼Œå…¶ pbuf ç»“æ„ä½“ä¸æ•°æ®ç¼“å†²åŒºä¹Ÿæ˜¯å­˜åœ¨äºè¿ç»­çš„å†…å­˜å—ä¸­ã€‚è¿™ç§ç±»å‹çš„ pbuf å¯ä»¥å¿«é€Ÿå®Œæˆåˆ†é…ï¼Œåœ¨ç½‘å¡æ¥æ”¶æ•°æ®æ—¶ï¼ŒLwIP ä¸€èˆ¬å°±ä½¿ç”¨è¿™ç§ç±»å‹çš„ pbuf æ¥å­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®ã€‚</p> <h4 id="pbuf-rom-å’Œ-pbuf-ref-ç±»å‹çš„-pbuf"><a href="#pbuf-rom-å’Œ-pbuf-ref-ç±»å‹çš„-pbuf" class="header-anchor">#</a> PBUF_ROM å’Œ PBUF_REF ç±»å‹çš„ pbuf</h4> <p><img src="/blog/assets/img/lwip_pbuf_rom_ref.64893f56.png" alt="PBUF_ROM å’Œ PBUF_REF ç±»å‹çš„ pbuf"></p> <p>PBUF_REF å’Œ PBUF_ROM ç±»å‹çš„ pbuf åŸºæœ¬ç›¸åŒï¼Œå®ƒä»¬éƒ½æ˜¯ä»å†…å­˜æ± ä¸­ç”³è¯·åˆ†é… pbuf ç»“æ„é¦–éƒ¨ç©ºé—´ï¼Œè€Œä¸ç”³è¯·æ•°æ®åŒºçš„ç©ºé—´ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…æŒ‡å‘ RAM ç©ºé—´å†…çš„æŸæ®µæ•°æ®ï¼Œåè€…æŒ‡å‘ ROM ç©ºé—´å†…çš„æŸæ®µæ•°æ®ã€‚</p> <h3 id="å„å±‚åè®®é¦–éƒ¨å¤§å°"><a href="#å„å±‚åè®®é¦–éƒ¨å¤§å°" class="header-anchor">#</a> å„å±‚åè®®é¦–éƒ¨å¤§å°</h3> <p>ä¸åŒçš„åè®®å…¶é¦–éƒ¨å¤§å°æ˜¯ä¸åŒçš„ï¼Œç”³è¯· pbuf æ—¶ï¼Œåè®®æ ˆä¸­å„å±‚é¦–éƒ¨çš„å¤§å°éƒ½ä¼šè¢«é¢„ç•™å‡ºæ¥ï¼ŒLwIP é‡‡ç”¨æšä¸¾å˜é‡è®°å½•å„å±‚çš„é¦–éƒ¨å¤§å°ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
  <span class="token comment">/** Includes spare room for transport layer header, e.g. UDP header.
   * Use this if you intend to pass the pbuf to functions like udp_send().
   */</span>
  PBUF_TRANSPORT <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN <span class="token operator">+</span> PBUF_IP_HLEN <span class="token operator">+</span> PBUF_TRANSPORT_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for IP header.
   * Use this if you intend to pass the pbuf to functions like raw_send().
   */</span>
  PBUF_IP <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN <span class="token operator">+</span> PBUF_IP_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for link layer header (ethernet header).
   * Use this if you intend to pass the pbuf to functions like ethernet_output().
   * @see PBUF_LINK_HLEN
   */</span>
  PBUF_LINK <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN <span class="token operator">+</span> PBUF_LINK_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Includes spare room for additional encapsulation header before ethernet
   * headers (e.g. 802.11).
   * Use this if you intend to pass the pbuf to functions like netif-&gt;linkoutput().
   * @see PBUF_LINK_ENCAPSULATION_HLEN
   */</span>
  PBUF_RAW_TX <span class="token operator">=</span> PBUF_LINK_ENCAPSULATION_HLEN<span class="token punctuation">,</span>
  <span class="token comment">/** Use this for input packets in a netif driver when calling netif-&gt;input()
   * in the most common case - ethernet-layer netif driver. */</span>
  PBUF_RAW <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span> pbuf_layer<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="pbuf-ç›¸å…³-api"><a href="#pbuf-ç›¸å…³-api" class="header-anchor">#</a> pbuf ç›¸å…³ API</h3> <table><thead><tr><th>API</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>pbuf_alloc</td> <td>ç”³è¯· pbuf æ•°æ®åŒ…ã€‚</td></tr> <tr><td>pbuf_realloc</td> <td>åœ¨ pbuf å°¾éƒ¨é‡Šæ”¾ä¸€å®šçš„ç©ºé—´ï¼Œå°†æ•°æ®åŒ… pbuf ä¸­çš„æ•°æ®é•¿åº¦<strong>å‡å°‘</strong>ä¸ºæŸä¸ªé•¿åº¦å€¼ã€‚</td></tr> <tr><td>pbuf_ref</td> <td>å¢åŠ  pbuf çš„å¼•ç”¨è®¡æ•°ã€‚</td></tr> <tr><td>pbuf_free</td> <td>é‡Šæ”¾ pbuf æ•°æ®åŒ…ã€‚</td></tr> <tr><td>pbuf_clen</td> <td>è¿”å› pbuf é“¾ä¸­çš„ pbuf æ•°é‡ã€‚</td></tr> <tr><td>pbuf_cat</td> <td>å°†ä¸¤ä¸ª pbuf é“¾æ¥åœ¨ä¸€èµ·ï¼ˆä½†ä¸ä¼šæ”¹å˜æœ«å°¾ pbuf é“¾çš„å¼•ç”¨è®¡æ•°ï¼‰ã€‚</td></tr> <tr><td>pbuf_chain</td> <td>å°†ä¸¤ä¸ª pbuf é“¾æ¥åœ¨ä¸€èµ·ï¼ˆå¢å‡å°¾é“¾çš„å¼•ç”¨è®¡æ•°ï¼‰ã€‚</td></tr> <tr><td>pbuf_dechain</td> <td>ç¼‰æ‹¿ä¸ªç¬¬ä¸€ä¸ª pbuf ä¸é“¾ä¸­åç»­çš„ pbuf æ–­å¼€è¿æ¥ã€‚</td></tr> <tr><td>pbuf_header</td> <td>è°ƒæ•´ pbuf çš„ payload æŒ‡é’ˆï¼ˆå‘å‰æˆ–å‘åç§»åŠ¨ä¸€å®šå­—èŠ‚æ•°ï¼‰ï¼Œè¿™ä¸ºå„å±‚å¯¹æ•°æ®åŒ…é¦–éƒ¨çš„æ“ä½œæä¾›äº†æ–¹ä¾¿ï¼Œè¿›è¡Œè¿™ä¸ªæ“ä½œçš„æ—¶å€™ï¼Œlen å’Œ tot_len å­—æ®µå€¼ä¹Ÿä¼šéšä¹‹æ›´æ–°ã€‚</td></tr> <tr><td>pbuf_copy_partial</td> <td>å°†éƒ¨åˆ† pbuf ä¸­çš„å†…å®¹å¤åˆ¶åˆ°ç¼“å­˜ä¸­ã€‚</td></tr> <tr><td>pbuf_take</td> <td>å°†ç”¨æˆ·æ•°æ®å¤åˆ¶åˆ° pbuf ä¸­ã€‚</td></tr> <tr><td>pbuf_coalesce</td> <td>ä»ä¸€ä¸ª pbuf é˜Ÿåˆ—ä¸­åˆ›å»ºå•ä¸ª pbufã€‚</td></tr> <tr><td>pbuf_memcmp</td> <td>å°†æŒ‡å®šåç§»åœ°å€å¤„çš„ pbuf å†…å®¹ä¸å…¶å®ƒå†…å­˜æ¯”è¾ƒ</td></tr> <tr><td>pbuf_memfind</td> <td>ä»æŸä¸ªåç§»åœ°å€å¼€å§‹ï¼Œåœ¨ pbuf ä¸­æŸ¥æ‰¾æŸå†…å­˜</td></tr> <tr><td>pbuf_strstr</td> <td>ä»æŸä¸ªåç§»åœ°å€å¼€å§‹ï¼Œåœ¨ pbuf ä¸­æŸ¥æ‰¾æŸå­—ç¬¦ä¸²</td></tr> <tr><td>pbuf_copy</td> <td>å°†ä»»ä½•ç±»å‹çš„ pbuf ä¸­çš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ª PBUF_RAM ç±»å‹çš„ pbuf ä¸­ã€‚</td></tr></tbody></table> <h4 id="pbuf-alloc-å‡½æ•°"><a href="#pbuf-alloc-å‡½æ•°" class="header-anchor">#</a> pbuf_alloc å‡½æ•°</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>æ•°æ®åŒ…ç”³è¯·å‡½æ•°æœ‰ä¸¤ä¸ªé‡è¦çš„å‚æ•°ï¼šæ•°æ®åŒ… pbuf çš„ç±»å‹å’Œæ•°æ®åŒ…åœ¨å“ªä¸€å±‚è¢«ç”³è¯·ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>pbuf_layer layer<span class="token punctuation">,</span> <span class="token class-name">u16_t</span> length<span class="token punctuation">,</span> pbuf_type type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <p>å‡è®¾ TCP åè®®éœ€è¦ç”³è¯·ä¸€ä¸ª pbuf æ•°æ®åŒ…ï¼Œåˆ™è°ƒç”¨å¦‚ä¸‹å‡½æ•°åˆ›å»º pbufï¼š</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_TRANSPORT<span class="token punctuation">,</span> <span class="token number">1472</span><span class="token punctuation">,</span> PBUF_RAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>å†…æ ¸ä¼šåˆ†é…ä¸€ä¸ª PBUF_RAM ç±»å‹çš„ pbufï¼Œ å…¶æ•°æ®åŒºåŸŸå¤§å°æ˜¯ 1472 å­—èŠ‚ï¼Œå¹¶ä¸”å› ä¸ºæ˜¯åœ¨ä¼ è¾“å±‚ï¼Œæ‰€ä»¥å†…æ ¸éœ€è¦é¢„ç•™ 54 å­—èŠ‚ç©ºé—´ï¼ˆä»¥å¤ªç½‘é¦–éƒ¨14å­—èŠ‚ï¼ŒIPv4é¦–éƒ¨20å­—èŠ‚ï¼ŒTCPé¦–éƒ¨20å­—èŠ‚ï¼‰ã€‚å½“æ•°æ®æŠ¥å¾€ä¸‹å±‚é€’äº¤çš„æ—¶å€™ï¼Œå…¶å®ƒå±‚ç›´æ¥å¡«å……å¯¹åº”çš„åè®®é¦–éƒ¨å³å¯ã€‚</p> <h4 id="pbuf-free-å‡½æ•°"><a href="#pbuf-free-å‡½æ•°" class="header-anchor">#</a> pbuf_free å‡½æ•°</h4> <p>åœ¨ç”³è¯· pbuf çš„æ—¶å€™ï¼Œref å­—æ®µå°±è¢«åˆå§‹åŒ–ä¸º1,å½“é‡Šæ”¾ pbuf çš„æ—¶å€™ï¼Œå…ˆå°† ref å‡ 1,å¦‚æœ ref å‡ 1 åä¸º 0,åˆ™è¡¨ç¤ºèƒ½é‡Šæ”¾ pbuf æ•°æ®åŒ…ã€‚</p> <ul><li>å‡è®¾æœ‰ 4 ä¸ª pbuf é“¾è¡¨å¦‚ä¸‹</li></ul> <p><img src="/blog/assets/img/lwip_pbuf_free_0.f2634715.png" alt="åˆå§‹æ—¶çš„ pbuf é“¾è¡¨"></p> <ul><li>åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åçš„ pbuf é“¾è¡¨å¦‚ä¸‹</li></ul> <p><img src="/blog/assets/img/lwip_pbuf_free_1.33781abf.png" alt="åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åçš„ pbuf é“¾è¡¨"></p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>ä¼ é€’ç»™ pbuf_free() çš„å‚æ•°å¿…é¡»æ˜¯é“¾è¡¨å¤´æŒ‡é’ˆã€‚</p></div> <h2 id="ç½‘å¡æ¥æ”¶æ•°æ®çš„ä¸€èˆ¬æµç¨‹"><a href="#ç½‘å¡æ¥æ”¶æ•°æ®çš„ä¸€èˆ¬æµç¨‹" class="header-anchor">#</a> ç½‘å¡æ¥æ”¶æ•°æ®çš„ä¸€èˆ¬æµç¨‹</h2> <p><img src="/blog/assets/img/lwip_packets_into_core.85a67ff6.png" alt="ç½‘å¡æ•°æ®ä¼ å…¥ LwIP å†…æ ¸"></p> <h2 id="lwip-å†…æ ¸è¶…æ—¶å¤„ç†"><a href="#lwip-å†…æ ¸è¶…æ—¶å¤„ç†" class="header-anchor">#</a> LwIP å†…æ ¸è¶…æ—¶å¤„ç†</h2> <p>LwIP ä¸­å¾ˆå¤šæ—¶å€™éƒ½éœ€è¦è¶…æ—¶å¤„ç†ï¼Œä¾‹å¦‚ ARP ç¼“å­˜è¡¨çš„å†…å®¹çš„æ—¶é—´ç®¡ç†ã€IP åˆ†ç‰‡æ•°æ®æŠ¥çš„é‡è£…ç­‰å¾…è¶…æ—¶ã€TCP ä¸­çš„å»ºç«‹è¿æ¥è¶…æ—¶ã€é‡ä¼ è¶…æ—¶æœºåˆ¶ç­‰ç­‰ã€‚LwIP é‡‡ç”¨è½¯ä»¶å®šæ—¶å™¨å¯¹è¿™äº›è¶…æ—¶è¿›è¡Œå¤„ç†ï¼Œç§»æ¤çš„æ—¶å€™éœ€è¦æä¾›ä¸€ä¸ªè¾ƒä¸ºå‡†ç¡®çš„æ—¶åŸºã€‚</p> <h3 id="sys-timeo-ç»“æ„ä½“"><a href="#sys-timeo-ç»“æ„ä½“" class="header-anchor">#</a> sys_timeo ç»“æ„ä½“</h3> <p>LwIP é€šè¿‡ä¸€ä¸ª sys_timeo ç±»å‹çš„æ•°æ®ç»“æ„ç®¡ç†ä¸è¶…æ—¶é“¾è¡¨ç›¸å…³çš„æ‰€æœ‰è¶…æ—¶äº‹ä»¶ã€‚LwIP ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“è®°å½•ä¸‹å†…æ ¸ä¸­æ‰€æœ‰è¢«æ³¨å†Œçš„è¶…æ—¶äº‹ä»¶ï¼Œè¿™äº›ç»“æ„ä½“ä¼šä»¥é“¾è¡¨çš„å½¢å¼ä¸€ä¸ªä¸ªè¿æ¥åœ¨è¶…æ—¶é“¾è¡¨ä¸­ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">// ä¸‹ä¸€ä¸ªè¶…æ—¶äº‹ä»¶</span>
  <span class="token class-name">u32_t</span> time<span class="token punctuation">;</span> 			  <span class="token comment">// å‘ç”Ÿè¶…æ—¶çš„æ—¶é—´</span>
  sys_timeout_handler h<span class="token punctuation">;</span>  <span class="token comment">// è¶…æ—¶çš„å›è°ƒå‡½æ•°</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>              <span class="token comment">// å‘å›è°ƒå‡½æ•°ä¼ å…¥çš„å‚æ•°</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** The one and only timeout list */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>next_timeout<span class="token punctuation">;</span> <span class="token comment">// æŒ‡å‘è¶…æ—¶é“¾è¡¨çš„ç¬¬ä¸€ä¸ªè¶…æ—¶äº‹ä»¶</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="æ³¨å†Œè¶…æ—¶äº‹ä»¶"><a href="#æ³¨å†Œè¶…æ—¶äº‹ä»¶" class="header-anchor">#</a> æ³¨å†Œè¶…æ—¶äº‹ä»¶</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">sys_timeout</span><span class="token punctuation">(</span><span class="token class-name">u32_t</span> msecs<span class="token punctuation">,</span> sys_timeout_handler handler<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">u32_t</span> next_timeout_time<span class="token punctuation">;</span>
  next_timeout_time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">sys_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> msecs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æ ¹æ®å½“å‰æ—¶é—´è®¡ç®—è¶…æ—¶æ—¶é—´</span>
  <span class="token function">sys_timeout_abs</span><span class="token punctuation">(</span>next_timeout_time<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sys_timeout_abs</span><span class="token punctuation">(</span><span class="token class-name">u32_t</span> abs_time<span class="token punctuation">,</span> sys_timeout_handler handler<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span>timeout<span class="token punctuation">,</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>

  timeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sys_timeo</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">memp_malloc</span><span class="token punctuation">(</span>MEMP_SYS_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>h <span class="token operator">=</span> handler<span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
  timeout<span class="token operator">-&gt;</span>time <span class="token operator">=</span> abs_time<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>next_timeout <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next_timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ ¹æ®è¶…æ—¶äº‹ä»¶çš„æ—¶é—´ï¼Œå‡åºæ’åˆ—</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TIME_LESS_THAN</span><span class="token punctuation">(</span>timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">,</span> next_timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> next_timeout<span class="token punctuation">;</span>
    next_timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> next_timeout<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">TIME_LESS_THAN</span><span class="token punctuation">(</span>timeout<span class="token operator">-&gt;</span>time<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">-&gt;</span>next <span class="token operator">=</span> t<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="lwip-å†…éƒ¨ä½¿ç”¨çš„å¾ªç¯è¶…æ—¶äº‹ä»¶"><a href="#lwip-å†…éƒ¨ä½¿ç”¨çš„å¾ªç¯è¶…æ—¶äº‹ä»¶" class="header-anchor">#</a> LwIP å†…éƒ¨ä½¿ç”¨çš„å¾ªç¯è¶…æ—¶äº‹ä»¶</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** This struct contains information about a stack-internal timer function
 that has to be called at a defined interval */</span>
<span class="token keyword">struct</span> <span class="token class-name">lwip_cyclic_timer</span> <span class="token punctuation">{</span>
  <span class="token class-name">u32_t</span> interval_ms<span class="token punctuation">;</span>
  lwip_cyclic_timer_handler handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">lwip_cyclic_timer</span> lwip_cyclic_timers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/* The TCP timer is a special case: it does not have to run always and
     is triggered to start from TCP using tcp_timer_needed() */</span>
  <span class="token punctuation">{</span>TCP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>tcp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">IP_REASSEMBLY</span></span>
  <span class="token punctuation">{</span>IP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>ip_reass_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* IP_REASSEMBLY */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_ARP</span></span>
  <span class="token punctuation">{</span>ARP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>etharp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ESP_GRATUITOUS_ARP</span></span>
  <span class="token punctuation">{</span>GARP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>garp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ESP_GRATUITOUS_ARP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_ARP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP</span></span>
  <span class="token punctuation">{</span>DHCP_COARSE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp_coarse_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>DHCP_FINE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp_fine_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_DHCP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ESP_DHCPS_TIMER</span></span>
  <span class="token punctuation">{</span>DHCP_COARSE_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcps_coarse_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_AUTOIP</span></span>
  <span class="token punctuation">{</span>AUTOIP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>autoip_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_AUTOIP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IGMP <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ESP_LWIP_IGMP_TIMERS_ONDEMAND</span></span>
  <span class="token punctuation">{</span>IGMP_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>igmp_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IGMP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DNS</span></span>
  <span class="token punctuation">{</span>DNS_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dns_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_DNS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6</span></span>
  <span class="token punctuation">{</span>ND6_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>nd6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_REASS</span></span>
  <span class="token punctuation">{</span>IP6_REASS_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>ip6_reass_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_REASS */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_MLD <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ESP_LWIP_MLD6_TIMERS_ONDEMAND</span></span>
  <span class="token punctuation">{</span>MLD6_TMR_INTERVAL<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>mld6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_MLD */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV6_DHCP6</span></span>
  <span class="token punctuation">{</span>DHCP6_TIMER_MSECS<span class="token punctuation">,</span> <span class="token function">HANDLER</span><span class="token punctuation">(</span>dhcp6_tmr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6_DHCP6 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV6 */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><img src="/blog/assets/img/lwip_timeouts_list.51042adb.png" alt="è¶…æ—¶é“¾è¡¨"></p> <h2 id="tcpip-thread-çº¿ç¨‹"><a href="#tcpip-thread-çº¿ç¨‹" class="header-anchor">#</a> tcpip_thread çº¿ç¨‹</h2> <ul><li>æ ‡å‡† TCP/IP åè®®æ ˆçš„å„ä¸ªå±‚æ¬¡éƒ½ç‹¬ç«‹æˆä¸ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå„ä¸ªå±‚æ¬¡æœ‰ç€ä¸¥æ ¼çš„åˆ†å±‚ç»“æ„ï¼Œå„ä¸ªå±‚æ¬¡çš„ API æ¥å£ä¹Ÿæ˜¯åˆ†å±‚æ¸…æ™°çš„ã€‚ä½†æ˜¯æ•°æ®åŒ…åœ¨å‘å…¶å®ƒå±‚é€’äº¤çš„æ—¶å€™ï¼Œéƒ½éœ€è¦è¿›è¡Œæ‹·è´ä»¥åŠåˆ‡æ¢çº¿ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å¼€é”€ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿæ²¡æ³•å¤„ç†å¤§é‡çš„æ•°æ®ã€‚</li> <li>åè®®æ ˆå¯ä»¥é©»ç•™åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¸ TCP/IP åè®®æ ˆé€šä¿¡ã€‚è¿™ç§æƒ…å†µè®©åè®®æ ˆå„å±‚ä¹‹é—´ä¸ç”¨æˆ·çº¿ç¨‹æ²¡æœ‰å¾ˆä¸¥æ ¼çš„åˆ†å±‚ç»“æ„ï¼Œå„å±‚ä¹‹é—´èƒ½äº¤å‰å­˜å–ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚</li> <li>LwIP è®©åè®®æ ˆå†…æ ¸ä¸æ“ä½œç³»ç»Ÿç›¸äº’éš”ç¦»ï¼Œåè®®æ ˆä»…ä»…ä½œä¸ºæ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å­˜åœ¨ï¼Œç”¨æˆ·ç¨‹åºèƒ½é©»ç•™åœ¨åè®®æ ˆå†…éƒ¨ï¼Œåè®®æ ˆé€šè¿‡å›è°ƒå‡½æ•°å®ç°ç”¨æˆ·ä¸åè®®æ ˆä¹‹é—´çš„æ•°æ®äº¤äº’ï¼›ä¹Ÿå¯ä»¥è®©ç”¨æˆ·ç¨‹åºå•ç‹¬å®ç°ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ä¿¡å·é‡å’Œé‚®ç®±ç­‰æœºåˆ¶ä¸åè®®æ ˆçº¿ç¨‹é€šä¿¡ã€‚</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tcpip_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcpip_msg</span> <span class="token operator">*</span>msg<span class="token punctuation">;</span>
  <span class="token function">LWIP_UNUSED_ARG</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LWIP_MARK_TCPIP_THREAD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LOCK_TCPIP_CORE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tcpip_init_done <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">tcpip_init_done</span><span class="token punctuation">(</span>tcpip_init_done_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LWIP_TCPIP_THREAD_ALIVE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* ç­‰å¾…æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†è¶…æ—¶äº‹ä»¶ */</span>
    <span class="token comment">// #define TCPIP_MBOX_FETCH(mbox, msg) tcpip_timeouts_mbox_fetch(mbox, msg)</span>
    <span class="token function">TCPIP_MBOX_FETCH</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcpip_mbox<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>TCPIP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;tcpip_thread: invalid message: NULL\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">&quot;tcpip_thread: invalid message&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç­‰å¾…åˆ°æ¶ˆæ¯ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†</span>
    <span class="token function">tcpip_thread_handle_msg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="lwip-ä¸­çš„æ¶ˆæ¯"><a href="#lwip-ä¸­çš„æ¶ˆæ¯" class="header-anchor">#</a> LwIP ä¸­çš„æ¶ˆæ¯</h2> <h3 id="æ¶ˆæ¯ç»“æ„"><a href="#æ¶ˆæ¯ç»“æ„" class="header-anchor">#</a> æ¶ˆæ¯ç»“æ„</h3> <p>tcpip_thread çº¿ç¨‹æ˜¯é€šè¿‡ <code>tcpip_msg</code> æè¿°æ¶ˆæ¯çš„ï¼Œtcpip_thread çº¿ç¨‹æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæ ¹æ®æ¶ˆæ¯çš„ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">enum</span> <span class="token class-name">tcpip_msg_type</span> <span class="token punctuation">{</span>
  TCPIP_MSG_API<span class="token punctuation">,</span>
  TCPIP_MSG_API_CALL<span class="token punctuation">,</span>    	<span class="token comment">// API å‡½æ•°è°ƒç”¨</span>
  TCPIP_MSG_INPKT<span class="token punctuation">,</span>			<span class="token comment">// åº•å±‚æ•°æ®åŒ…è¾“å…¥</span>
  TCPIP_MSG_TIMEOUT<span class="token punctuation">,</span>		<span class="token comment">// æ³¨å†Œè¶…æ—¶äº‹ä»¶</span>
  TCPIP_MSG_UNTIMEOUT<span class="token punctuation">,</span>		<span class="token comment">// åˆ é™¤è¶…æ—¶äº‹ä»¶</span>
  TCPIP_MSG_CALLBACK<span class="token punctuation">,</span>
  TCPIP_MSG_CALLBACK_STATIC	<span class="token comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">tcpip_msg</span> <span class="token punctuation">{</span>
  <span class="token keyword">enum</span> <span class="token class-name">tcpip_msg_type</span> type<span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_callback_fn function<span class="token punctuation">;</span>	<span class="token comment">// å†…æ ¸æ‰§è¡Œçš„ API å‡½æ•°</span>
      <span class="token keyword">void</span><span class="token operator">*</span> msg<span class="token punctuation">;</span>					<span class="token comment">// æ‰§è¡Œå‡½æ•°æ—¶å€™çš„å‚æ•°ï¼Œè®°å½•åœ¨ api_msg ä¸­</span>
    <span class="token punctuation">}</span> api_msg<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_api_call_fn function<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> <span class="token class-name">tcpip_api_call_data</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
      <span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> api_call<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>				<span class="token comment">// æŒ‡å‘æ¥æ”¶åˆ°çš„æ•°æ®åŒ…</span>
      <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>			<span class="token comment">// æ¥æ”¶åˆ°æ•°æ®åŒ…çš„ç½‘å¡</span>
      netif_input_fn input_fn<span class="token punctuation">;</span>		<span class="token comment">// è¾“å…¥çš„å‡½æ•°æ¥å£</span>
    <span class="token punctuation">}</span> inp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      tcpip_callback_fn function<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      <span class="token class-name">u32_t</span> msecs<span class="token punctuation">;</span>					<span class="token comment">// è¶…æ—¶çš„æ—¶é—´</span>
      sys_timeout_handler h<span class="token punctuation">;</span>		<span class="token comment">// è¶…æ—¶å›è°ƒå‡½æ•°</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> tmo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="æ•°æ®åŒ…æ¶ˆæ¯"><a href="#æ•°æ®åŒ…æ¶ˆæ¯" class="header-anchor">#</a> æ•°æ®åŒ…æ¶ˆæ¯</h3> <p><img src="/blog/assets/img/lwip_packet_message.217126c7.png" alt="packet æ¶ˆæ¯å¤„ç†ç”Ÿå‘½å‘¨æœŸ"></p> <h3 id="api-æ¶ˆæ¯"><a href="#api-æ¶ˆæ¯" class="header-anchor">#</a> API æ¶ˆæ¯</h3> <p>ç”¨æˆ·ä½¿ç”¨ NETCONN API æ¥å£æ—¶ï¼ŒLwIP ä¼šå°†å¯¹åº” API å‡½æ•°ä¸å‚æ•°æ„é€ æˆæ¶ˆæ¯ä¼ é€’åˆ° tcpip_thread çº¿ç¨‹ä¸­ï¼Œç„¶åæ ¹æ®å¯¹åº”çš„ API å‡½æ•°æ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚ç”¨æˆ·çš„åº”ç”¨çº¿ç¨‹ä¸å†…æ ¸ä¹Ÿæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿçš„ IPC é€šä¿¡æœºåˆ¶è¿›è¡Œæ•°æ®äº¤äº’ä¸åŒæ­¥ï¼ˆé‚®ç®±ã€ä¿¡å·é‡ç­‰ï¼‰ã€‚</p> <p><img src="/blog/assets/img/lwip_api_message.6f551817.png" alt="API æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ"></p> <h2 id="arp-åè®®"><a href="#arp-åè®®" class="header-anchor">#</a> ARP åè®®</h2> <p>ARP åè®®æ˜¯ TCP/IP åè®®çš„åŸºç¡€ï¼Œé€šè¿‡è§£æ IP åœ°å€å¾—åˆ°æ•°æ®é“¾è·¯å±‚çš„åœ°å€ã€‚ARP åè®®çš„æ ¸å¿ƒæ˜¯ ARP ç¼“å­˜è¡¨ï¼Œè€ŒARP åè®®çš„å®è´¨å°±æ˜¯å¯¹ç¼“å­˜è¡¨çš„å»ºç«‹ã€æ›´æ–°ã€æŸ¥è¯¢ç­‰æ“ä½œã€‚ARP ç¼“å­˜è¡¨æ˜¯ç”±è‹¥å¹²ç¼“å­˜è¡¨é¡¹ç»„æˆï¼Œåœ¨ LwIP ä¸­ï¼Œæè¿°ç¼“å­˜è¡¨é¡¹çš„æ•°æ®ç»“æ„å« <code>etharp_entry</code>ã€‚</p> <p><img src="/blog/assets/img/arp_protocol.6e6dab0f.png" alt="ARPåè®®æ•°æ®åŒ…æ ¼å¼"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Hardware Typeï¼šå€¼ 1 è¡¨ç¤ºä»¥å¤ªç½‘åœ°å€ï¼Œå…¶å®ƒçš„è¿˜å¯èƒ½æœ‰ä»¤ç‰Œç¯åœ°å€</p> <p>Protocol Typeï¼šå€¼ <code>0x0800</code> è¡¨ç¤º IPv4 åè®®ï¼Œå…¶å®ƒè¿˜å¯èƒ½æ˜¯ ICMP/IGMP ç­‰</p> <p>Hardware Address Lengthï¼šç¡¬ä»¶åœ°å€é•¿åº¦ï¼Œä»¥å¤ªç½‘æ˜¯ 6</p> <p>Protocol Address Lengthï¼šåè®®åœ°å€é•¿åº¦ï¼Œå¯¹äº ARP è¯·æ±‚å’Œåº”ç­”åŒ…æ¥è¯´ï¼Œè¯¥å€¼æ˜¯ 4</p> <p>Opcodeï¼šARP æ“ä½œçš„ç±»å‹</p> <div class="language- extra-class"><pre><code>* ARP è¯·æ±‚ï¼Œå€¼1
* ARP åº”ç­”ï¼Œå€¼2
* RARPè¯·æ±‚ï¼Œå€¼3
* RARPåº”ç­”ï¼Œå€¼4
</code></pre></div></div> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUEING</span></span>
  <span class="token comment">/** Pointer to queue of pending outgoing packets on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token comment">/** Pointer to a single pending outgoing packet on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token class-name">ip4_addr_t</span> ipaddr<span class="token punctuation">;</span>		<span class="token comment">// IP åœ°å€</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>		<span class="token comment">// ç½‘å¡</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethaddr<span class="token punctuation">;</span>	<span class="token comment">// ç‰©ç†åœ°å€</span>
  <span class="token class-name">u16_t</span> ctime<span class="token punctuation">;</span>				<span class="token comment">// ç”Ÿå­˜æ—¶é—´ï¼Œå½“å¤§äºæœ€å¤§ç”Ÿå­˜å€¼æ—¶ï¼Œè¯¥è¡¨é¡¹ä¼šè¢«åˆ é™¤</span>
  <span class="token class-name">u8_t</span> state<span class="token punctuation">;</span>				<span class="token comment">// ç¼“å­˜é¡¹çŠ¶æ€</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="ç¼“å­˜è¡¨è¶…æ—¶å¤„ç†"><a href="#ç¼“å­˜è¡¨è¶…æ—¶å¤„ç†" class="header-anchor">#</a> ç¼“å­˜è¡¨è¶…æ—¶å¤„ç†</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Clears expired entries in the ARP table.
 *
 * This function should be called every ARP_TMR_INTERVAL milliseconds (1 second),
 * in order to expire entries in the ARP table.
 */</span>
<span class="token keyword">void</span>
<span class="token function">etharp_tmr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;etharp_timer\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* éå† ARP è¡¨ï¼Œåˆ é™¤è¿‡æœŸçš„è¡¨é¡¹ */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ARP_TABLE_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">u8_t</span> state <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_EMPTY
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_SUPPORT_STATIC_ENTRIES</span></span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_STATIC<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ETHARP_SUPPORT_STATIC_ENTRIES */</span></span>
       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸€ä¸‹æƒ…å½¢è¡¨ç¤ºARPè¡¨é¡¹è¿‡æœŸï¼š</span>
        <span class="token comment">// 1. è¡¨é¡¹å¤„äº STABLE çŠ¶æ€ï¼Œå¹¶ä¸”ctimeè¶…è¿‡äº†æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰</span>
        <span class="token comment">// 2. è¡¨é¡¹å¤„äº PENDING çŠ¶æ€ï¼Œå¹¶ä¸”ctimeè¶…è¿‡äº†æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ5ç§’ï¼‰</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXAGE<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span>  <span class="token operator">&amp;&amp;</span>
           <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXPENDING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;etharp_timer: expired %s entry %d.\n&quot;</span><span class="token punctuation">,</span>
                                   arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE <span class="token operator">?</span> <span class="token string">&quot;stable&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* clean up entries that have just been expired */</span>
        <span class="token function">etharp_free_entry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Don't send more than one request every 2 seconds. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Reset state to stable, so that the next transmitted packet will
           re-send an ARP request. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* still pending, resend an ARP query */</span>
        <span class="token function">etharp_request</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="arp-æ•°æ®åŒ…æ¥æ”¶æµç¨‹"><a href="#arp-æ•°æ®åŒ…æ¥æ”¶æµç¨‹" class="header-anchor">#</a> ARP æ•°æ®åŒ…æ¥æ”¶æµç¨‹</h3> <p><img src="/blog/assets/img/lwip_arp_process_input.35e6fc48.png" alt="ARP æ¥æ”¶æµç¨‹"></p> <h3 id="arp-æ•°æ®åŒ…å‘é€æµç¨‹"><a href="#arp-æ•°æ®åŒ…å‘é€æµç¨‹" class="header-anchor">#</a> ARP æ•°æ®åŒ…å‘é€æµç¨‹</h3> <p>IP æ•°æ®åŒ…é€šè¿‡ <code>ip4_output</code> å‡½æ•°å°†ä¸Šå±‚æ•°æ®åŒ…ä¼ é€’åˆ° ARP åè®®å¤„ç†ï¼ŒARP é€šè¿‡ <code>etharp_output</code> å‡½æ•°æ¥æ”¶åˆ° IP æ•°æ®åŒ…åå°±ä¼šè¿›è¡Œå‘é€ï¼ŒARP ä¼šå…ˆä»æ•°æ®åŒ…ä¸­è¿›è¡Œåˆ†æï¼Œåˆ¤æ–­è¿™ä¸ª IP æ•°æ®æŠ¥æ˜¯å•æ’­æ•°æ®åŒ…è¿˜æ˜¯å¤šæ’­æˆ–è€…æ˜¯å¹¿æ’­æ•°æ®åŒ…ï¼Œç„¶åè¿›è¡Œä¸åŒçš„å¤„ç†ï¼š</p> <ul><li>å¯¹äºå¯¹æ’­æˆ–è€…æ˜¯å¹¿æ’­æ•°æ®åŒ…ï¼Œç›´æ¥å°†æ•°æ®åŒ…ä¸¢ç»™ç½‘å¡ï¼ˆè°ƒç”¨ <code>ethernet_output</code> å‡½æ•°ï¼‰</li> <li>å¯¹äºå•æ’­åŒ…ï¼Œé¦–å…ˆåˆ¤æ–­ç›®æ ‡ IP åœ°å€æ˜¯å¦å’Œä¸»æœºå¤„äºåŒä¸€å­ç½‘ä¸Šï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¿®æ”¹ IP åœ°å€ï¼ŒIP åœ°å€ä¸ºç½‘å…³çš„ IP åœ°å€</li> <li>å¯¹äºå•æ’­åŒ…ï¼ŒARP åè®®éœ€è¦æ ¹æ® IP åœ°å€æ‰¾åˆ°å¯¹åº”çš„ MAC åœ°å€ï¼Œå¦‚æœæ‰¾ä¸åˆ° MAC åœ°å€çš„è¯ï¼Œè¿˜éœ€è¦å»¶è¿Ÿå‘é€æ•°æ®åŒ…ï¼ŒARP åè®®é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª ARP è¡¨é¡¹ï¼Œç„¶åå°†æ•°æ®åŒ…æŒ‚åˆ° ARP è¡¨é¡¹å¯¹åº”çš„ç¼“å­˜é˜Ÿåˆ—ä¸Šï¼Œäºæ­¤åŒæ—¶ä¼šå‘å‡ºä¸€ä¸ª ARP è¯·æ±‚åŒ…ï¼Œç­‰å¾…ç›®æ ‡ä¸»æœºçš„å›åº”åå†å‘é€ IP æ•°æ®åŒ…</li></ul> <p><img src="/blog/assets/img/lwip_arp_process_output.999a53be.png" alt="ARP å‘é€æµç¨‹"></p> <h3 id="æŠ“åŒ…"><a href="#æŠ“åŒ…" class="header-anchor">#</a> æŠ“åŒ…</h3> <p><img src="/blog/assets/img/lwip_arp_request.7e489783.png" alt="arp request"></p> <p><img src="/blog/assets/img/lwip_arp_reply.59985110.png" alt="arp reply"></p> <h2 id="ip-åè®®"><a href="#ip-åè®®" class="header-anchor">#</a> IP åè®®</h2> <p>IP åè®®è´Ÿè´£å°†æ•°æ®åŒ…ä»æºä¸»æœºå‘é€åˆ°ç›®æ ‡ä¸»æœºï¼Œé€šè¿‡ IP åœ°å€ä½œä¸ºå”¯ä¸€è¯†åˆ«ç ï¼Œåœ¨å‘é€æ•°æ®åŒ…çš„è¿‡ç¨‹ä¸­ï¼ŒIP åè®®è¿˜å¯èƒ½å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼ŒåŒæ—¶åœ¨æ¥æ”¶æ•°æ®åŒ…çš„æ—¶å€™è¿˜å¯èƒ½éœ€è¦å¯¹åˆ†ç‰‡çš„æ•°æ®åŒ…è¿›è¡Œé‡è£…ã€‚</p> <h3 id="ip-é¦–éƒ¨"><a href="#ip-é¦–éƒ¨" class="header-anchor">#</a> IP é¦–éƒ¨</h3> <p><img src="/blog/assets/img/ip_protocol.f8dade33.png" alt="IPåè®®æ•°æ®åŒ…æ ¼å¼"></p> <p><strong>LwIP å®šä¹‰äº†ä¸€ä¸ª <code>ip_hdr</code> ç»“æ„ä½“æ¥æè¿° IP æ•°æ®åŒ…çš„é¦–éƒ¨</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>IHLï¼šåè®®å¤´çš„é•¿åº¦ï¼Œå•ä½æ˜¯<strong>å­—</strong>ï¼Œæ‰€ä»¥æœ€å¤§å¯ä»¥è®°å½• 60 å­—èŠ‚çš„åè®®å¤´éƒ¨</p> <p>TOSï¼šæœåŠ¡ç±»æ€§ï¼Œç”¨ä»¥åŒºåˆ†ä¸åŒç±»å‹çš„ IP æ•°æ®åŒ…ï¼ˆä¾‹å¦‚ä¸€äº›ç‰¹åˆ«è¦æ±‚ä½æ—¶å»¶ã€é«˜ååçš„æ•°æ®åŒ…ï¼‰ï¼Œè·¯ç”±å™¨ä¼šæ ¹æ®è¿™ä¸ªå­—æ®µçš„å€¼æ¥ä¸ºæ•°æ®åŒ…æä¾›æœ€åˆç†çš„è·¯å¾„</p> <p>TLï¼šæ€»é•¿åº¦ï¼Œé¦–éƒ¨åŠ ä¸Šæ•°æ®åŒºåŸŸï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚æ•´ä¸ª IP æ•°æ®åŒ…çš„ç†è®ºæœ€å¤§é•¿åº¦ä¸º 65535 å­—èŠ‚</p> <p>Identificationï¼šæ ‡è¯†å­—æ®µç”¨äºè¡¨ç¤º IP å±‚å‘é€å‡ºå»çš„æ¯ä¸€ä»½ IP æ•°æ®åŒ…ï¼Œåœ¨å‘é€æ¯ä¸€ä»½æŠ¥æ–‡æ—¶ï¼Œè¯¥å€¼ä¼šåŠ  1,åœ¨åˆ†ç‰‡çš„æ—¶å€™ï¼Œè¯¥å­—æ®µä¼šè¢«å¤åˆ¶åˆ°æ¯ä¸ªåˆ†ç‰‡æ•°æ®åŒ…ä¸­ï¼Œç›®æ ‡æ¥æ”¶ä¸»æœºä¼šæ ¹æ®è¯¥å­—æ®µåˆ¤æ–­è¿™äº›æ•°æ®æ˜¯å¦å±äºåŒä¸€ä¸ª IP æ•°æ®åŒ…</p> <p>Fragment Offsetï¼šåˆ†ç‰‡åç§»é‡ï¼Œä½¿ç”¨ 8 çš„æ•´æ•°å€è®°å½•ï¼Œæ‰€ä»¥æ¯ä¸ªæ•°æ®åŒ…ä¸­çš„åˆ†ç‰‡æ•°æ®å¤§å°ä¹Ÿå¿…é¡»æ˜¯ 8 çš„æ•´æ•°å€</p> <p>TTLï¼šç”Ÿå­˜æ—¶é—´ï¼Œæ¯å½“ IP æ•°æ®åŒ…ç”±ä¸€å°è·¯ç”±å™¨å¤„ç†æ—¶ï¼Œè¯¥å­—æ®µçš„å€¼å‡1,è‹¥ TTL å­—æ®µå‡ä¸º0,åˆ™è¯¥æ•°æ®åŒ…å¿…é¡»ä¸¢å¼ƒï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ª ICMP å·®é”™æŠ¥æ–‡ç»™æºä¸»æœº</p> <p>Protocolï¼šå€¼ä¸º 6 è¡¨æ˜æ•°æ®éƒ¨åˆ†è¦äº¤ç»™ TCPï¼Œå€¼ä¸º 17 è¡¨æ˜æ•°æ®è¦äº¤ç»™ UDP</p> <p>Header Checksumï¼šIP æ•°æ®åŒ…åœ¨åˆ°è¾¾æ¯ä¸ªè·¯ç”±å™¨ä¸Šéƒ½å¿…é¡»é‡æ–°è®¡ç®—æ ¡éªŒå’Œå¹¶å†æ¬¡å­˜æ”¾åˆ°åŸå¤„ï¼Œå› ä¸º TTL å­—æ®µä»¥åŠå¯èƒ½çš„é€‰é¡¹å­—æ®µä¼šæ”¹å˜</p> <p>Dataï¼šæ•°æ®åŒºåŸŸåŒ…å«ä¼ è¾“å±‚çš„æŠ¥æ–‡ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æ˜¯ ICMP æŠ¥æ–‡</p></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>IPv6 ä¸å…è®¸æ•°æ®åŒ…åˆ†ç‰‡</li> <li>IPv6 ä¸æ”¯æŒ Options é€‰é¡¹</li></ul></div> <h3 id="ip-æ•°æ®æŠ¥åˆ†ç‰‡"><a href="#ip-æ•°æ®æŠ¥åˆ†ç‰‡" class="header-anchor">#</a> IP æ•°æ®æŠ¥åˆ†ç‰‡</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ä¸€ä¸ªé“¾è·¯å±‚å¸§èƒ½æ‰¿è½½çš„æœ€å¤§æ•°æ®é‡å«åšæœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰ï¼Œä»¥å¤ªç½‘å¸§çš„ MTU ä¸º 1500 å­—èŠ‚ã€‚å‘é€æ–¹ä¸ç›®çš„åœ°è·¯å¾„ä¸Šçš„æ¯æ®µé“¾è·¯å¯èƒ½ä½¿ç”¨ä¸åŒçš„é“¾è·¯å±‚åè®®ï¼Œä¸”æ¯ç§åè®®å¯èƒ½å…·æœ‰ä¸åŒçš„ MTUï¼Œä¸ºæ­¤éœ€è¦å¯¹ IP æ•°æ®æŠ¥è¿›è¡Œåˆ†ç‰‡å¤„ç†ã€‚IP æ•°æ®åŒ…çš„é‡è£…ç”±ç›®æ ‡ IP åœ°å€çš„ä¸»æœºæ¥å®Œæˆï¼Œæ¯ä¸ªæ•°æ®åˆ†ç‰‡åˆ°è¾¾ç›®æ ‡ IP åœ°å€ä¸»æœºçš„æ—¶é—´æ˜¯ä¸ä¸€æ ·çš„ã€‚</p></div> <p><img src="/blog/assets/img/lwip_ip_frag.c71fe3b0.png" alt="IP æ•°æ®åŒ…åˆ†ç‰‡"></p> <h3 id="ip-æ•°æ®æŠ¥å‘é€"><a href="#ip-æ•°æ®æŠ¥å‘é€" class="header-anchor">#</a> IP æ•°æ®æŠ¥å‘é€</h3> <p><code>ip4_output</code> ä½¿ç”¨ <code>ip4_route_src</code> å‡½æ•°æŸ¥æ‰¾ç›®æ ‡ç½‘ç»œæ¥å£ netif æ¥å‘é€ IP æ•°æ®åŒ…ã€‚å½“ç½‘ç»œæ¥å£ netif ç¡®å®šåï¼ŒIP æ•°æ®åŒ…é€šè¿‡å‡½æ•° <code>ip4_output_if</code> å‘é€å‡ºå»ã€‚è‹¥ <code>ip4_route_src</code> æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç½‘ç»œæ¥å£ï¼Œåˆ™ä¸¢å¼ƒè¯¥æŠ¥æ–‡ï¼Œç»ˆæ­¢æœ¬æ¬¡å‘é€ã€‚</p> <p>å‡½æ•° <code>ip4_route_src</code> é€šè¿‡éå†ç½‘ç»œæ¥å£é“¾è¡¨ netif_listï¼ŒæŸ¥æ‰¾ä¸ç›®çš„ IP åœ°å€åœ¨åŒä¸€ä¸ªå­ç½‘ä¸­çš„ç½‘ç»œæ¥å£ï¼Œå¹¶å°†è¯¥ç½‘ç»œæ¥å£è¿”å›ç»™å˜é‡ netifã€‚</p> <p><code>ip4_output_if</code>å¡«å†™ IP æ•°æ®æŠ¥é¦–éƒ¨å¯¹åº”çš„å„ä¸ªå­—æ®µï¼Œæœ€ååœ¨ IP å±‚é€šè¿‡å›è°ƒå‡½æ•° <code>netif-&gt;output</code>ï¼ˆå³ <code>etharp_output</code> å‡½æ•°ï¼‰å°† IP æ•°æ®æŠ¥æŠ•é€’ç»™ ARP åè®®ï¼Œå†è°ƒç”¨ç½‘å¡åº•å±‚å‘é€å‡½æ•°è¿›è¡Œå‘é€ã€‚</p> <p><img src="/blog/assets/img/lwip_ip_output.a56af61e.png" alt="IP æ•°æ®æŠ¥å‘é€"></p> <h3 id="ip-æ•°æ®æŠ¥æ¥æ”¶"><a href="#ip-æ•°æ®æŠ¥æ¥æ”¶" class="header-anchor">#</a> IP æ•°æ®æŠ¥æ¥æ”¶</h3> <p><code>ip4_input</code> ä¼šåšå„é¡¹æ£€æŸ¥ï¼ŒåŒ…æ‹¬åè®®ç‰ˆæœ¬å·ï¼ŒIP é¦–éƒ¨çš„æ ¡éªŒå€¼ï¼Œæº IP åœ°å€æ˜¯å¦æœ‰æ•ˆç­‰ï¼Œç„¶åæ£€æµ‹ IP æ•°æ®åŒ…ä¸­çš„ç›®çš„ IP åœ°å€æ˜¯å¦ä¸æœ¬èŠ‚ç‚¹çš„ IP åœ°å€ç›¸ç¬¦ï¼Œå¦‚æœæ˜¯æœ¬èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œåˆ™æ ¹æ®è¯¥ IP æ•°æ®åŒ…é¦–éƒ¨çš„åè®®å­—æ®µåˆ¤æ–­è¯¥æ•°æ®åŒ…åº”è¯¥è¢«é€’äº¤åˆ°å“ªä¸ªä¸Šå±‚åè®®ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚</p> <p>å¦‚æœæ˜¯ UDP åè®®ï¼Œåˆ™è°ƒç”¨ <code>udp_input</code> å‡½æ•°ï¼›å¦‚æœæ˜¯ TCPåè®®ï¼Œåˆ™è°ƒç”¨ <code>tcp_input</code> å‡½æ•°ï¼›å¦‚æœæ˜¯ ICMP åè®®ï¼Œåˆ™è°ƒç”¨ <code>icmp_input</code> å‡½æ•°ï¼›å¦‚æœæ˜¯ IGMP åè®®ï¼Œåˆ™è°ƒç”¨<code>igmp_input</code> å‡½æ•°ï¼›å¦‚æœéƒ½ä¸æ˜¯ï¼Œåˆ™è°ƒç”¨å‡½æ•° <code>icmp_dest_unreach</code> è¿”å›ä¸€ä¸ªåè®®ä¸å¯è¾¾ <code>ICMP</code> æ•°æ®åŒ…ç»™æºä¸»æœºã€‚</p> <p>å¦‚æœä¸æ˜¯æœ¬èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œåˆ™é€šè¿‡è°ƒç”¨å‡½æ•° <code>ip_forward</code> å¯¹æ•°æ®åŒ…è¿›è¡Œè½¬å‘ã€‚éœ€è¦æ³¨æ„ï¼Œç”±äºä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½å«æœ‰å¤šä¸ª IP åœ°å€ï¼Œå› æ­¤ <code>ip4_input</code> å‡½æ•°ä¼šéå†ç½‘ç»œæ¥å£é“¾è¡¨ netif_listä¸Š çš„ netif ç»“æ„å˜é‡ï¼Œæ¥æŸ¥æ‰¾ä¸ IP æ•°æ®åŒ…ä¸­ç›¸åŒ¹é…çš„ IP åœ°å€ã€‚</p> <p><img src="/blog/assets/img/lwip_ip_input.2eb1bb3b.png" alt="IP æ•°æ®æŠ¥æ¥æ”¶"></p> <h3 id="å‡ ä¸ªé‡è¦çš„-ip-åœ°å€ç›¸å…³çš„æ•°æ®ç»“æ„"><a href="#å‡ ä¸ªé‡è¦çš„-ip-åœ°å€ç›¸å…³çš„æ•°æ®ç»“æ„" class="header-anchor">#</a> å‡ ä¸ªé‡è¦çš„ IP åœ°å€ç›¸å…³çš„æ•°æ®ç»“æ„</h3> <h4 id="ipv4-ç›¸å…³"><a href="#ipv4-ç›¸å…³" class="header-anchor">#</a> IPv4 ç›¸å…³</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">in_addr</span>
<span class="token punctuation">{</span>
    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>  <span class="token comment">//è¡¨ç¤º32ä½çš„IPåœ°å€ï¼Œ32ä½æ— ç¬¦å·æ•´å‹</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span>            sin_len<span class="token punctuation">;</span>     <span class="token comment">//è¡¨ç¤ºè¯¥ç»“æ„ä½“çš„é•¿åº¦ï¼Œ8ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token class-name">sa_family_t</span>        sin_family<span class="token punctuation">;</span>  <span class="token comment">//è¡¨ç¤ºå¥—æ¥å£ä½¿ç”¨çš„åè®®æ—ï¼Œ8ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token class-name">in_port_t</span>          sin_port<span class="token punctuation">;</span>    <span class="token comment">//è¡¨ç¤ºå¥—æ¥å£ä½¿ç”¨çš„ç«¯å£å·ï¼Œ16ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     sin_addr<span class="token punctuation">;</span>    <span class="token comment">//è¡¨ç¤ºIPåœ°å€ï¼Œ32ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token keyword">char</span>               sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//è¯¥æˆå‘˜åŸºæœ¬ä¸ä½¿ç”¨ï¼Œæ€»æ˜¯ç½®ä¸º0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><code>sin_len</code> æˆå‘˜æ˜¯ä¸è¦æ±‚ä¸€å®šå­˜åœ¨çš„ï¼Œå³ä¾¿è¿™ä¸ªæˆå‘˜å­˜åœ¨ï¼Œä¹Ÿæ— éœ€è®¾ç½®å®ƒæˆ–è€…æ£€æŸ¥å®ƒ</li> <li><code>sin_family</code> çš„ç±»å‹ä¸ <code>sin_len</code> æˆå‘˜æœ‰å…³ï¼Œå¦‚æœç»“æ„ä½“ä¸­å®šä¹‰äº†æˆå‘˜ <code>sin_len</code>ï¼Œé‚£ä¹ˆ <code>sin_family</code> ä¸€èˆ¬å°±æ˜¯8ä½æ— ç¬¦å·æ•´å‹ï¼›å¦‚æœç»“æ„ä½“ä¸­æ²¡æœ‰å®šä¹‰æˆå‘˜ <code>sin_len</code>ï¼Œé‚£ä¹ˆ <code>sin_family</code> ä¸€èˆ¬å°±æ˜¯16ä½æ— ç¬¦å·æ•´å‹</li></ul> <h4 id="ipv6-ç›¸å…³"><a href="#ipv6-ç›¸å…³" class="header-anchor">#</a> IPv6 ç›¸å…³</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">in6_addr</span>
<span class="token punctuation">{</span>
    <span class="token class-name">unit8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//è¡¨ç¤º128ä½çš„IPåœ°å€ï¼Œè¿™é‡Œé‡‡ç”¨æ•°ç»„çš„å½¢å¼</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span>         sin6_len<span class="token punctuation">;</span>      <span class="token comment">//è¡¨ç¤ºè¯¥ç»“æ„ä½“çš„é•¿åº¦ï¼Œ8ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token class-name">sa_family_t</span>     sin6_family<span class="token punctuation">;</span>   <span class="token comment">//è¡¨ç¤ºå¥—æ¥å£ä½¿ç”¨çš„åè®®æ—ï¼Œ8ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token class-name">in_port_t</span>       sin_port<span class="token punctuation">;</span>      <span class="token comment">//è¡¨ç¤ºå¥—æ¥å£ä½¿ç”¨çš„ç«¯å£å·ï¼Œ16ä½æ— ç¬¦å·æ•´å‹</span>
    <span class="token class-name">uint32_t</span>        sin_flowinfo<span class="token punctuation">;</span>  <span class="token comment">//ä½åº20ä½æ˜¯æµæ ‡ç­¾ï¼Œé«˜åº12ä½ä¿ç•™</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr      <span class="token comment">//è¡¨ç¤º128ä½çš„IPåœ°å€</span>
    <span class="token class-name">uint32_t</span>        sin6_scope_id<span class="token punctuation">;</span> <span class="token comment">//æ ‡è¯†å¯¹äºå…·å¤‡èŒƒå›´çš„åœ°å€è€Œè¨€æœ‰æ„ä¹‰çš„èŒƒå›´</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„"><a href="#é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„" class="header-anchor">#</a> é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span>     sa_len<span class="token punctuation">;</span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>
    <span class="token keyword">char</span>        sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//è¡¨ç¤º14å­—èŠ‚çš„åè®®åœ°å€</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="æ–°çš„é€šç”¨å¥—æ¥å­—æ¥å£åœ°å€ç»“æ„"><a href="#æ–°çš„é€šç”¨å¥—æ¥å­—æ¥å£åœ°å€ç»“æ„" class="header-anchor">#</a> æ–°çš„é€šç”¨å¥—æ¥å­—æ¥å£åœ°å€ç»“æ„</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span>              ss_len<span class="token punctuation">;</span>    <span class="token comment">//è¡¨ç¤ºè¯¥ç»“æ„çš„é•¿åº¦</span>
    <span class="token class-name">sa_family_t</span>          ss_family<span class="token punctuation">;</span> <span class="token comment">//è¡¨ç¤ºåè®®æ—</span>
    <span class="token keyword">char</span> __ss_padding<span class="token punctuation">[</span>_SS_PADSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>åŸæœ‰çš„é€šç”¨æ•°æ®ç»“æ„ <code>sockaddr</code> åªæœ‰ 16 å­—èŠ‚ï¼Œæ— æ³•å…¼å®¹ IPv6 æ ¼å¼ï¼Œ<code>sockaddr_storage</code> è¶³å¤Ÿå¤§ï¼Œå¯ä»¥å®¹çº³ä»»ä½•å¥—æ¥å­—æ¥å£åœ°å€</li></ul> <h4 id="inet-pton-å’Œ-inet-ntop-å‡½æ•°"><a href="#inet-pton-å’Œ-inet-ntop-å‡½æ•°" class="header-anchor">#</a> inet_pton å’Œ inet_ntop å‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrstr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æˆåŠŸè¿”å›1ï¼Œstrptræ ¼å¼é”™è¯¯è¿”å›0ï¼Œå¤±è´¥è¿”å›-1</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrstr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æˆåŠŸåˆ™è¿”å›æŒ‡å‘ç»“æœçš„æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›NULL</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p><code>family</code> å‚æ•°æ ¹æ®åè®®æ—çš„ä¸åŒï¼Œé€‰æ‹© <code>AF_INET</code> æˆ– <code>AF_INET6</code></p></li> <li><p><code>inet_pton</code> å°† <code>strptr</code> æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œè½¬ä¸ºæ•°å€¼ï¼Œå­˜æ”¾åœ¨ <code>addstr</code> æŒ‡å‘çš„å†…å­˜ä¸­</p></li> <li><p><code>inet_ntop</code> åšç›¸åçš„è¿ç®—ï¼Œ<code>len</code> å‚æ•°æ˜¯ <code>strptr</code> å•å…ƒçš„å¤§å°ï¼Œé˜²æ­¢æº¢å‡ºã€‚ä¸ºæœ‰åŠ©äºæŒ‡å®šå¤§å°ï¼ŒCè¯­è¨€ä¸­æœ‰åšå¦‚ä¸‹å®šä¹‰:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">incldue</span> <span class="token expression"><span class="token operator">&lt;</span>arpa<span class="token operator">/</span>inet<span class="token punctuation">.</span>h<span class="token operator">&gt;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INET_ADDRSTRLEN</span>    <span class="token expression"><span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INET6_ADDRSTRLEN</span>   <span class="token expression"><span class="token number">46</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h2 id="icmp-åè®®"><a href="#icmp-åè®®" class="header-anchor">#</a> ICMP åè®®</h2> <p><img src="/blog/assets/img/lwip_icmp_protocol.a19c8c2e.jpg" alt="ICMP åè®®æ•°æ®åŒ…æ ¼å¼"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ICMP æŠ¥æ–‡æœ‰ä¸¤å¤§ç±»å‹ï¼Œå¯ä»¥åˆ’åˆ†ä¸º<strong>å·®é”™æŠ¥å‘Š</strong>æŠ¥æ–‡å’Œ<strong>æŸ¥è¯¢</strong>æŠ¥æ–‡ã€‚</p> <p>å·®é”™æŠ¥å‘ŠæŠ¥æ–‡ä¸»è¦æ˜¯ç”¨æ¥å‘ IP æ•°æ®æŠ¥æºä¸»æœºè¿”å›ä¸€ä¸ªå·®é”™æŠ¥å‘Šä¿¡æ¯ï¼Œè€Œè¿™ä¸ªå·®é”™æŠ¥å‘Šä¿¡æ¯äº§ç”Ÿçš„åŸå› æ˜¯è·¯ç”±å™¨æˆ–è€…ä¸»æœºä¸èƒ½å¯¹å½“å‰æ•°æ®æŠ¥è¿›è¡Œæ­£å¸¸çš„å¤„ç†ã€‚</p> <p>æŸ¥è¯¢æŠ¥æ–‡æ˜¯ç”¨äºä¸€å°ä¸»æœºå‘å¦ä¸€å°ä¸»æœºå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœç›®æ ‡ä¸»æœºæ”¶åˆ°è¿™ä¸ªæŸ¥è¯¢çš„è¯·æ±‚åï¼Œå°±ä¼šæŒ‰ç…§æŸ¥è¯¢æŠ¥æ–‡çš„æ ¼å¼æƒ³æºä¸»æœºä½œå‡ºåº”ç­”ã€‚<code>ping</code> å‘½ä»¤æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª ICMP æŸ¥è¯¢æŠ¥æ–‡ã€‚</p></div> <table><tr><th>ICMP æŠ¥æ–‡ç±»å‹</th> <th>å…·ä½“ç±»å‹</th> <th>æè¿°<br></th></tr> <tr><td rowspan="5">å·®é”™æŠ¥å‘ŠæŠ¥æ–‡<br></td> <td>3</td> <td>ç›®çš„ä¸å¯è¾¾</td></tr> <tr><td>4</td> <td>æºç«™æŠ‘åˆ¶</td></tr> <tr><td>5</td> <td>é‡å®šå‘</td></tr> <tr><td>11</td> <td>è¶…æ—¶</td></tr> <tr><td>12</td> <td>å‚æ•°é”™è¯¯æŠ¥æ–‡</td></tr> <tr><td rowspan="5">æŸ¥è¯¢æŠ¥æ–‡</td> <td>0æˆ–8</td> <td>å›æ˜¾è¯·æ±‚æˆ–å›æ˜¾åº”ç­”</td></tr> <tr><td>9æˆ–10</td> <td>è·¯ç”±å™¨è¯¢é—®æˆ–é€šå‘Š</td></tr> <tr><td>13æˆ–14</td> <td>äº‹ä»¶æˆ³è¯·æ±‚æˆ–åº”ç­”</td></tr> <tr><td>15æˆ–16</td> <td>ä¿¡æ¯è¯·æ±‚æˆ–åº”ç­”</td></tr> <tr><td>17æˆ–18</td> <td>æ©ç è¯·æ±‚æˆ–åº”ç­”</td></tr></table> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>ICMP å›æ˜¾è¯·æ±‚æŠ¥æ–‡å’Œå›æ˜¾åº”ç­”æŠ¥æ–‡æ˜¯ LwIP ä¸­å”¯ä¸€å®ç°çš„æŸ¥è¯¢æŠ¥æ–‡ï¼Œå…¶å®ƒå‡ ç§æŸ¥è¯¢æŠ¥æ–‡ç”¨äºä¸»æœºç¡®å®šè‡ªå·±çš„ IP åœ°å€ã€æ©ç ã€è·¯ç”±ç­‰ä¿¡æ¯ï¼Œå·²ç»è¢« DHCP åè®®å–ä»£äº†ã€‚</p></div> <h3 id="å‘é€å·®é”™æŠ¥æ–‡"><a href="#å‘é€å·®é”™æŠ¥æ–‡" class="header-anchor">#</a> å‘é€å·®é”™æŠ¥æ–‡</h3> <p>å¦‚æœ IP æ•°æ®æŠ¥æ— æ³•é€’äº¤åˆ°ä¼ è¾“å±‚æ—¶ï¼Œå°±ä¼šè°ƒç”¨ <code>icmp_dest_unreach()</code> å‡½æ•°è¿”å›ä¸€ä¸ª ICMP åè®®ä¸å¯è¾¾æŠ¥æ–‡ã€‚</p> <p>å¦‚æœåœ¨ä¼ è¾“å±‚ä¸­ï¼ŒUDP åè®®æ— æ³•å‘åº”ç”¨å±‚é€’äº¤æ•°æ®æŠ¥ï¼Œé‚£ä¹ˆå°†è°ƒç”¨è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª ICMP ç«¯å£ä¸å¯è¾¾æŠ¥æ–‡ã€‚</p> <p>åœ¨è½¬å‘æ•°æ®æŠ¥çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æŠ¥ä¸­ TTL ä¸º 0,æˆ–è€…åœ¨åˆ†ç‰‡æ•°æ®æŠ¥é‡è£…çš„æ—¶å€™è¶…æ—¶ï¼ŒLwIP å°†è°ƒç”¨ <code>icmp_time_exceeded()</code> å‡½æ•°å‘é€ä¸€ä¸ª ICMP è¶…æ—¶æŠ¥æ–‡åˆ°æºä¸»æœºä¸­ã€‚</p> <p><code>icmp_time_exceeded</code> å’Œ <code>icmp_dest_unreach</code> éƒ½ä¼šè°ƒç”¨ <code>icmp_send_response</code> å‡½æ•°å‘é€ ICMP åº”ç­”æŠ¥æ–‡ã€‚</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * Send an icmp packet in response to an incoming packet.
 *
 * @param p the input packet for which the 'unreachable' should be sent,
 *          p-&gt;payload pointing to the IP header
 * @param type Type of the ICMP header
 * @param code Code of the ICMP header
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">icmp_send_response</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> type<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">ip_hdr</span> <span class="token operator">*</span>iphdr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span> <span class="token operator">*</span>icmphdr<span class="token punctuation">;</span>
  <span class="token class-name">ip4_addr_t</span> iphdr_src<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>

  <span class="token comment">/* ç”³è¯· pbuf å†…å­˜å—ï¼Œå¤§å°ä¸º ICMP é¦–éƒ¨ + IP é¦–éƒ¨ + 8 å­—èŠ‚æ•°æ® */</span>
  q <span class="token operator">=</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_IP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> IP_HLEN <span class="token operator">+</span>                                          ICMP_DEST_UNREACH_DATASIZE<span class="token punctuation">,</span>PBUF_RAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æŒ‡å‘ IP æ•°æ®æŠ¥é¦–éƒ¨</span>
  iphdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å‘ pbuf æ•°æ®åŒºåŸŸï¼Œå¹¶å¼ºåˆ¶è½¬åŒ–ä¸º ICMP æŠ¥æ–‡é¦–éƒ¨</span>
  icmphdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  icmphdr<span class="token operator">-&gt;</span>seqno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// ä»åŸå§‹æ•°æ®åŒ…ä¸­å¤åˆ¶å­—æ®µï¼ŒIP æ•°æ®æŠ¥é¦–éƒ¨ + 8 å­—èŠ‚çš„æ•°æ®åŒºåŸŸ</span>
  <span class="token function">SMEMCPY</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token operator">-&gt;</span>payload <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp_echo_hdr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span>
          IP_HLEN <span class="token operator">+</span> ICMP_DEST_UNREACH_DATASIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¾—åˆ°æº IP åœ°å€</span>
  <span class="token function">ip4_addr_copy</span><span class="token punctuation">(</span>iphdr_src<span class="token punctuation">,</span> iphdr<span class="token operator">-&gt;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®è·¯ç”±è¡¨æŸ¥è¯¢åº•å±‚ç½‘å¡æ¥å£</span>
  netif <span class="token operator">=</span> <span class="token function">ip4_route</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>iphdr_src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* calculate checksum */</span>
    icmphdr<span class="token operator">-&gt;</span>chksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CHECKSUM_GEN_ICMP</span></span>
    <span class="token function">IF__NETIF_CHECKSUM_ENABLED</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> NETIF_CHECKSUM_GEN_ICMP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      icmphdr<span class="token operator">-&gt;</span>chksum <span class="token operator">=</span> <span class="token function">inet_chksum</span><span class="token punctuation">(</span>icmphdr<span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">ip4_output_if</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iphdr_src<span class="token punctuation">,</span> ICMP_TTL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IP_PROTO_ICMP<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="å¤„ç†-icmp-æŠ¥æ–‡"><a href="#å¤„ç†-icmp-æŠ¥æ–‡" class="header-anchor">#</a> å¤„ç† ICMP æŠ¥æ–‡</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>LwIP å¯¹ ICMP æŠ¥æ–‡ä¸­å¾ˆå¤šç±»å‹çš„æŠ¥æ–‡éƒ½ä¸åšå¤„ç†ï¼ŒLwIP ä¼šå°†è¿™äº›ä¸å¤„ç†çš„æŠ¥æ–‡ä¸¢å¼ƒï¼Œä½†æ˜¯å¯¹ ICMP å›æ˜¾è¯·æ±‚æŠ¥æ–‡ä¼šåšå‡ºå¤„ç†ã€‚</p></div> <p><code>icmp_input</code> åœ¨ <code>ip_input</code> ä¸­è¢«è°ƒç”¨ï¼Œå®ƒå¤„ç†æ¥æ”¶åˆ°çš„ ICMP è¯·æ±‚æŠ¥æ–‡ã€‚é¦–å…ˆåˆ¤æ–­è¯¥æ•°æ®åŒ…æ˜¯å¦ä¸ºå¹¿æ’­æˆ–è€…ç»„æ’­åŒ…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­å¤„ç†ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™ç»§ç»­åˆ¤æ–­è¯¥æ•°æ®åŒ…é•¿åº¦æ˜¯å¦å°äº ICMP å›æ˜¾è¯·æ±‚å¤´éƒ¨é•¿åº¦ï¼Œå¦‚æœæ˜¯åˆ™ä¸¢å¼ƒæ•°æ®åŒ…ï¼›å¦‚æœä¸æ˜¯åˆ™å°†è¯¥ ICMP æŠ¥æ–‡ç±»å‹å­—æ®µå˜ä¸º 0ï¼Œé‡æ–°è®¡ç®—æ ¡éªŒå’Œï¼Œå¹¶å°† IP æŠ¥æ–‡é¦–éƒ¨çš„æº IP åœ°å€å’Œç›®çš„ IP åœ°å€äº¤æ¢ä½ç½®ï¼Œå¹¶é€šè¿‡è°ƒç”¨å‡½æ•° <code>ip_output_if</code> å°†æ•°æ®åŒ…å‘é€å‡ºå»ã€‚</p> <h2 id="udp-åè®®"><a href="#udp-åè®®" class="header-anchor">#</a> UDP åè®®</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JfdH.png" alt="UDPåè®®æ•°æ®åŒ…"></p> <ul><li>å‡½æ•°udp_inputå°†æ£€æŸ¥æŠ¥æ–‡çš„UDPæ ¡éªŒï¼Œæœ€ç»ˆè°ƒç”¨å‡½æ•°recvï¼Œå°†æ”¶åˆ°çš„æŠ¥æ–‡ä¼ é€’ç»™åº”ç”¨å±‚ç¨‹åº</li> <li>å½“åº”ç”¨å±‚ç¨‹åºè¦é€šè¿‡UDPåè®®å‘å¤–å‘é€IPæŠ¥æ–‡æ—¶ï¼Œå°†é€šè¿‡è°ƒç”¨å‡½æ•°udp_sendå®ç°ï¼Œå‡½æ•°udp_sendé€šè¿‡è°ƒç”¨IPå±‚çš„å‡½æ•°ip_output_ifå®ç°æŠ¥æ–‡çš„å‘é€</li> <li>LwIPä½¿ç”¨é“¾è¡¨ç»“æ„ä½“udp_pcbæ¥ä¿å­˜æ¯ä¸€ä¸ªUDPä¼šè¯çš„çŠ¶æ€</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token punctuation">{</span>
<span class="token comment">/* Common members of all PCB types */</span>
  IP_PCB<span class="token punctuation">;</span>

<span class="token comment">/* Protocol specific PCB members */</span>

  <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
  <span class="token comment">/** ports are in host byte order */</span>
  <span class="token class-name">u16_t</span> local_port<span class="token punctuation">,</span> remote_port<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_MULTICAST_TX_OPTIONS</span></span>
  <span class="token comment">/** outgoing network interface for multicast packets */</span>
  <span class="token class-name">ip_addr_t</span> multicast_ip<span class="token punctuation">;</span>
  <span class="token comment">/** TTL for outgoing multicast packets */</span>
  <span class="token class-name">u8_t</span> mcast_ttl<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_MULTICAST_TX_OPTIONS */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_UDPLITE</span></span>
  <span class="token comment">/** used for UDP_LITE only */</span>
  <span class="token class-name">u16_t</span> chksum_len_rx<span class="token punctuation">,</span> chksum_len_tx<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_UDPLITE */</span></span>

  <span class="token comment">/** receive callback function */</span>
  udp_recv_fn recv<span class="token punctuation">;</span>
  <span class="token comment">/** user-supplied argument for the recv callback */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>recv_arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="tcp-åè®®"><a href="#tcp-åè®®" class="header-anchor">#</a> TCP åè®®</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JULF.png" alt="TCPåè®®æ•°æ®åŒ…"></p> <ul><li>TCPçš„æ»‘åŠ¨çª—å£åè®®æ˜¯ç”¨äºå®ç°æµé‡æ§åˆ¶çš„</li> <li>TCPçš„è¶…æ—¶å’Œé‡ä¼ æœºåˆ¶æé«˜äº†æ•°æ®ä¼ è¾“çš„å¯é æ€§</li> <li>æ‹¥å¡æ§åˆ¶æ˜¯é€šè¿‡æ…¢å¯åŠ¨ç®—æ³•å’Œæ‹¥å¡é¿å…ç®—æ³•æ¥å®ç°çš„</li> <li>LwIPä¸­å«æœ‰ä¸¤ä¸ªå®šæ—¶å™¨å‡½æ•°ï¼štcp_fasttmrå’Œtcp_slowtmrï¼Œtcp_fasttmræ¯250msè°ƒç”¨ä¸€æ¬¡ï¼Œtcp_slowtmræ¯500msè°ƒç”¨ä¸€æ¬¡ã€‚å¿«é€Ÿå®šæ—¶å™¨ä¸»è¦åšä¸¤ä¸ªæ–¹é¢çš„äº‹æƒ…ï¼šå‘ä¸Šå±‚é€’äº¤ä¸Šå±‚ä¸€ç›´æœªæ¥æ”¶çš„æ•°æ®ï¼ŒäºŒæ˜¯å‘é€è¯¥è¿æ¥ä¸Šçš„å»¶è¿ŸACKè¯·æ±‚æ•°æ®æ®µã€‚æ…¢é€Ÿå®šæ—¶å™¨å‚ä¸äº†è¾ƒå¤šåŠŸèƒ½ï¼Œå¦‚è¶…æ—¶ä¸é‡ä¼ ã€æ‹¥å¡æ§åˆ¶ç­‰ã€‚</li></ul> <h2 id="lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£"><a href="#lwip-çš„ä¸‰ç§ç¼–ç¨‹æ¥å£" class="header-anchor">#</a> LwIP çš„ä¸‰ç§ç¼–ç¨‹æ¥å£</h2> <div class="custom-block tip"><p class="custom-block-title">RAW/Callback API</p> <p>ç›´æ¥è°ƒç”¨åè®®æ ˆå„æ¨¡å—çš„å‡½æ•°ï¼ˆå®ƒä»¬æ˜¯ä½¿ç”¨<strong>å›è°ƒå‡½æ•°</strong>çš„ API æ¥å£ï¼Œä¹Ÿç§°ä¸º RAW APIï¼‰ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>æ— éœ€æ“ä½œç³»ç»Ÿæ”¯æŒã€‚</li> <li>LwIP å†…æ ¸æŠŠæ•°æ®äº¤ç»™åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹åªæ˜¯ä¸€æ¬¡ç®€å•çš„ API è°ƒç”¨ï¼Œéå¸¸èŠ‚çœæ—¶é—´å’Œç©ºé—´ã€‚</li> <li>åº”ç”¨ç¨‹åºå’Œå†…æ ¸ç¨‹åºå¤„äºåŒä¸€çº¿ç¨‹ä¹‹ä¸­ï¼ŒèŠ‚çœäº†ä»»åŠ¡é—´é€šä¿¡å’Œä»»åŠ¡åˆ‡æ¢çš„å¼€é”€ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>åº”ç”¨ç¨‹åºçš„æ‰§è¡Œä¼šåˆ¶çº¦å†…æ ¸ç¨‹åºçš„æ‰§è¡Œï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºä¹‹é—´ä¹Ÿä¼šäº’ç›¸åˆ¶çº¦ã€‚åœ¨åº”ç”¨ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸ç¨‹åºå°†ä¸èƒ½å¾—åˆ°è¿è¡Œï¼Œè¿™ä¼šå½±å“ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†æ•ˆç‡ï¼Œä¸¥é‡åœ°è¿˜ä¼šé€ æˆæ•°æ®åŒ…å µå¡è€Œå‘ç”Ÿä¸¢åŒ…ç°è±¡ã€‚</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">Netconn API</p> <p>ä½¿ç”¨ LwIP æä¾›çš„ä¸“ç”¨ APIï¼Œä¹Ÿç§°ä¸º Sequential APIï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹åŸºäº <strong>open-read-write-close</strong> æ¨¡å‹ã€‚Netconn API æ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„ IPC æœºåˆ¶å®ç°çš„ï¼Œå®ƒå°† LwIP å†…æ ¸ä»£ç å’Œç½‘ç»œåº”ç”¨ç¨‹åºåˆ†ç¦»æˆç‹¬ç«‹çš„çº¿ç¨‹ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>LwIP çº¿ç¨‹åªè´Ÿè´£æ•°æ®åŒ…çš„ TCP/IP å°è£…å’Œæ‹†å°ï¼Œä¸ç”¨è¿›è¡Œæ•°æ®çš„åº”ç”¨å±‚å¤„ç†ï¼Œæé«˜äº†ç³»ç»Ÿå¯¹ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†æ•ˆç‡ã€‚</li> <li>ç›¸è¾ƒäº Socket APIï¼ŒNetconn API é¿å…äº†å†…æ ¸ç¨‹åºå’Œç½‘ç»œåº”ç”¨ç¨‹åºä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œæé«˜äº†æ•°æ®ä¼ é€’çš„æ•ˆç‡ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>ä¾èµ–æ“ä½œç³»ç»Ÿã€‚</li> <li>å†…æ ¸ç¨‹åºå’Œç½‘ç»œåº”ç”¨ç¨‹åºä¹‹é—´çš„æ•°æ®åŒ…ä¼ é€’éœ€è¦ä¾é æ“ä½œç³»ç»Ÿçš„ä¿¡å·é‡å’Œé‚®ç®±æœºåˆ¶å®Œæˆï¼Œè€—è´¹äº†æ›´å¤šçš„æ—¶é—´å’Œå†…å­˜ã€‚</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">BSD Socket API</p> <p>Socket å¯¹ç½‘ç»œè¿æ¥è¿›è¡Œäº†é«˜çº§çš„æŠ½è±¡ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥åƒæ“ä½œæ–‡ä»¶ä¸€æ ·æ“ä½œç½‘ç»œè¿æ¥ã€‚LwIP çš„ Socket API æ˜¯åŸºäº Netconn API å®ç°çš„ã€‚</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>ä½¿ç”¨ Socket ç¼–å†™çš„ç½‘ç»œåº”ç”¨ç¨‹åºå…·æœ‰å¾ˆå¥½çš„å¯ç§»æ¤æ€§ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>Socket API åœ¨å†…æ ¸ç¨‹åºå’Œåº”ç”¨ç¨‹åºä¹‹é—´å­˜åœ¨æ•°æ®æ‹·è´ï¼Œé™ä½äº†æ•°æ®ä¼ é€’çš„æ•ˆç‡ã€‚</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>LwIP å¹¶æ²¡æœ‰å®ç°å…¨éƒ¨çš„ BSD Socket APIã€‚</p></div> <h3 id="tcp-raw-api"><a href="#tcp-raw-api" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6l7j0.png" alt="TCP RAW API"></p> <table><thead><tr><th>å‡½æ•°</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>struct tcp_pcb* tcp_new()</td> <td>æ–°å»ºtcpåè®®æ§åˆ¶å—</td></tr> <tr><td>ert_t tcp_bind(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port)</td> <td>ç»‘å®šæœ¬åœ°IPåœ°å€å’Œç«¯å£å·ï¼Œå¦‚æœipaddrä¸ºIP_ADDR_ANYï¼Œåˆ™å°†è¿æ¥ç»‘å®šåˆ°æ‰€æœ‰çš„æœ¬åœ°IPåœ°å€ä¸Š</td></tr> <tr><td>struct tcp_pcb* tcp_listen(struct tcp_pcb* pcb)</td> <td>ä½¿æŒ‡å®šçš„è¿æ¥å¼€å§‹è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œå¦‚æœç›‘å¬æˆåŠŸï¼Œå°±è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥æ§åˆ¶å—pcb</td></tr> <tr><td>void tcp_accepted(struct tcp_pcb* pcb)</td> <td>é€šçŸ¥LwIPä¸€ä¸ªæ–°æ¥çš„è¿æ¥å·²ç»è¢«æ¥æ”¶ï¼Œè¿™ä¸ªå‡½æ•°é€šå¸¸åœ¨ç”±tcp_acceptæŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­è¢«è°ƒç”¨</td></tr> <tr><td>void tcp_accept(struct tcp_pcb* pcb,err_t (*accept)(void* arg,struct tcp_pcb* newpcb,err_t err))</td> <td>æŒ‡å®šå¤„äºç›‘å¬çŠ¶æ€çš„è¿æ¥ï¼Œåœ¨æˆåŠŸå»ºç«‹è¿æ¥åè¦è°ƒç”¨çš„å›è°ƒæ–¹æ³•</td></tr> <tr><td>err_t tcp_connect(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port,err_t (* connected)(void* arg,struct tcp_pcb* tpcb,err_t err))</td> <td>è¯·æ±‚è¿æ¥åˆ°æ‰§è¡Œçš„è¿œç¨‹ä¸»æœº</td></tr> <tr><td>err_t tcp_write(struct tcp_pcb* pcb,void* dataptr,u16_t len,u8_t copy)</td> <td>å‘é€TCPæ•°æ®ï¼Œå°†è¦å‘é€çš„æ•°æ®æ”¾å…¥å‘é€é˜Ÿåˆ—ä¸­ï¼Œç”±åè®®æ ˆå†…æ ¸å‘é€ï¼Œcopyä¸º0åˆ™ä¸ä¼šä¸ºå‘é€çš„æ•°æ®åˆ†é…æ–°çš„å†…å­˜ç©ºé—´</td></tr> <tr><td>void tcp_sent(struct tcp_pcb* pcb,err_t (*sent)(void* arg,struct tcp_pcb* tpcb,u16_t len))</td> <td>æŒ‡å®šå½“è¿œç¨‹ä¸»æœºæˆåŠŸæ¥æ”¶æ•°æ®åï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨çš„å›è°ƒå‡½æ•°</td></tr> <tr><td>void tcp_recv(struct tcp_pcb* pcb,err_t (* recv)(void* arg,struct tcp_pcb* tpcb,struct pbuf* p,err_t err))</td> <td>æŒ‡å®šæ¥æ”¶æ•°æ®æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°</td></tr> <tr><td>void tcp_recved(struct tcp_pcb* pcb,u16_t len)</td> <td>ç”¨äºè·å–æ¥æ”¶åˆ°çš„æ•°æ®çš„é•¿åº¦ï¼Œå¿…é¡»åœ¨tcp_recvæŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­è¢«è°ƒç”¨</td></tr> <tr><td>err_t tcp_close(struct tcp_pcb* pcb)</td> <td>å…³é—­ä¸€ä¸ªæŒ‡å®šçš„TCPè¿æ¥ï¼Œè°ƒç”¨è¯¥å‡½æ•°åå°†ä¼šé‡Šæ”¾pcbæ§åˆ¶å—æ‰€å ç”¨çš„å†…å­˜ç©ºé—´</td></tr> <tr><td>void tcp_abort(struct tcp_pcb* pcb)</td> <td>ç»ˆæ­¢ä¸€ä¸ªæŒ‡å®šçš„è¿æ¥ï¼Œè°ƒç”¨è¯¥å‡½æ•°åï¼Œpcbæ§åˆ¶å—æ‰€å ç”¨çš„å†…å­˜ç©ºé—´å°†è¢«é‡Šæ”¾</td></tr> <tr><td>void tcp_err(struct tcp_pcb* pcb,void (*err)(void* arg,err_t err))</td> <td>æŒ‡å®šå¤„ç†é”™è¯¯çš„å›è°ƒå‡½æ•°</td></tr></tbody></table> <h3 id="tcp-raw-api-2"><a href="#tcp-raw-api-2" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6lLHU.png" alt="UDP RAW API"></p> <h3 id="netconn-api"><a href="#netconn-api" class="header-anchor">#</a> Netconn API</h3> <ul><li>æ•°æ®ç»“æ„netconnæè¿°äº†åº”ç”¨ç¨‹åºè¦ä½¿ç”¨APIå‡½æ•°æœºé‚£é‡Œä¸€ä¸ªè¿æ¥çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬äº†è¿æ¥çš„ç±»å‹ã€æœ€è¿‘çš„æ•…éšœä»£ç ã€å›è°ƒå‡½æ•°ç­‰ã€‚</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** A netconn descriptor */</span>
<span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token punctuation">{</span>
  <span class="token comment">/** type of the netconn (TCP, UDP or RAW) */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> type<span class="token punctuation">;</span>
  <span class="token comment">/** current state of the netconn */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_state</span> state<span class="token punctuation">;</span>
  <span class="token comment">/** the lwIP internal protocol control block */</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_pcb</span>  <span class="token operator">*</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tcp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>udp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span> <span class="token operator">*</span>raw<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> pcb<span class="token punctuation">;</span>
  <span class="token comment">/** the last error this netconn had */</span>
  <span class="token class-name">err_t</span> last_err<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_NETCONN_SEM_PER_THREAD</span></span>
  <span class="token comment">/** sem that is used to synchronously execute functions in the core context */</span>
  <span class="token class-name">sys_sem_t</span> op_completed<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">/** mbox where received packets are stored until they are fetched
      by the netconn application thread (can grow quite big) */</span>
  <span class="token class-name">sys_mbox_t</span> recvmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/** mbox where new connections are stored until processed
      by the application thread */</span>
  <span class="token class-name">sys_mbox_t</span> acceptmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
  <span class="token comment">/** only used for socket layer */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SOCKET</span></span>
  <span class="token keyword">int</span> socket<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SOCKET */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_SNDTIMEO</span></span>
  <span class="token comment">/** timeout to wait for sending data (which means enqueueing data for sending
      in internal buffers) in milliseconds */</span>
  <span class="token class-name">s32_t</span> send_timeout<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVTIMEO */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_RCVTIMEO</span></span>
  <span class="token comment">/** timeout in milliseconds to wait for new data to be received
      (or connections to arrive for listening netconns) */</span>
  <span class="token keyword">int</span> recv_timeout<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVTIMEO */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_RCVBUF</span></span>
  <span class="token comment">/** maximum amount of bytes queued in recvmbox
      not used for TCP: adjust TCP_WND instead! */</span>
  <span class="token keyword">int</span> recv_bufsize<span class="token punctuation">;</span>
  <span class="token comment">/** number of bytes currently in recvmbox to be received,
      tested against recv_bufsize to limit bytes on recvmbox
      for UDP and RAW, used for FIONREAD */</span>
  <span class="token keyword">int</span> recv_avail<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVBUF */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_LINGER</span></span>
   <span class="token comment">/** values &lt;0 mean linger is disabled, values &gt; 0 are seconds to linger */</span>
  <span class="token class-name">s16_t</span> linger<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_LINGER */</span></span>
  <span class="token comment">/** flags holding more netconn-internal state, see NETCONN_FLAG_* defines */</span>
  <span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores how much is already sent. */</span>
  <span class="token class-name">size_t</span> write_offset<span class="token punctuation">;</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores the message.
      Also used during connect and close. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">api_msg_msg</span> <span class="token operator">*</span>current_msg<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
  <span class="token comment">/** A callback function that is informed about events for this netconn */</span>
  netconn_callback callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><img src="https://s1.ax1x.com/2018/08/10/P61AED.png" alt="Netconn API"></p> <table><thead><tr><th>å‡½æ•°</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>struct netconn* netconn_new_with_proto_and_callback(enum netconn_type t,u8_t proto,netconn_callback callback)</td> <td>å»ºç«‹ä¸€ä¸ªæ–°çš„netconnè¿æ¥</td></tr> <tr><td>err_t netconn_delete(struct netconn* conn)</td> <td>åˆ é™¤netconnæ‰€æŒ‡å‘çš„è¿æ¥</td></tr> <tr><td>err_t netconn_getaddr(struct netconn* conn,struct ip_addr* addr,u16_t* port,u8_t local)</td> <td>è·å–connè¿æ¥çš„ä¸»æœºIPåœ°å€å’Œç«¯å£å·</td></tr> <tr><td>err_t netconn_bind(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>å°†ä¸€ä¸ªIPåœ°å€åŠç«¯å£å·ä¸connæŒ‡å‘çš„è€Œè¿æ¥ç»‘å®š</td></tr> <tr><td>err_t netconn_connect(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>å°†æœåŠ¡å™¨ç«¯çš„IPåœ°å€å’Œç«¯å£å·ä¸connæŒ‡å‘çš„è¿æ¥ç»‘å®š</td></tr> <tr><td>err_t netconn_disconnect(struct netconn* conn)</td> <td>æ–­å¼€connæŒ‡å‘çš„è¿æ¥</td></tr> <tr><td>err_t netconn_listen_with_backlog(struct netconn* connï¼Œu8_t backlog)</td> <td>å°†connæŒ‡å‘çš„è¿æ¥è®¾å®šä¸ºç›‘å¬çŠ¶æ€</td></tr> <tr><td>struct netconn* netconn_accept(struct netconn* conn)</td> <td>æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè¯¥å‡½æ•°ä¼šé˜»å¡åœ¨acceptmboxé‚®ç®±ä¸Š</td></tr> <tr><td>struct netbuf* netconn_recv(struct netconn* conn)</td> <td>æ¥æ”¶æ•°æ®ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®è¢«å°è£…ä¸ºnetbufç»“æ„</td></tr> <tr><td>err_t netconn_sendto(struct netconn* conn,struct netbuf* buf,struct ip_addr* addr,u16_t port)</td> <td>å‘ä¸€ä¸ªæŒ‡å®šçš„IPåœ°å€å’Œç«¯å£å·å‘é€æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°åªèƒ½ç”¨åœ¨connç±»å‹ä¸ºUDPæˆ–è€…RAWçš„è¿æ¥ä¸­</td></tr> <tr><td>err_t netconn_write(struct netconn* conn,const void* dataptr,size_t size,u8_t apiflag)</td> <td>å‘ç›¸åº”çš„TCPè¿æ¥ä¸Šå‘é€æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°åªèƒ½ç”¨äºå‘é€TCPçš„æŠ¥æ–‡</td></tr> <tr><td>err_t nnetconn_close(struct netconn* conn)</td> <td>å…³é—­connæŒ‡å‘çš„è¿æ¥</td></tr></tbody></table> <ul><li>netconn_new_with_proto_and_callbacké¦–å…ˆè°ƒç”¨netconn_allocå‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ªnetconnç»“æ„ï¼Œæ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šæ„å»ºä¸€ä¸ªapi_msgæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯è¦æ±‚å†…æ ¸æ‰§è¡Œå‡½æ•°do_newconnï¼Œæœ€åè°ƒç”¨å‡½æ•°tcpip_apimsgæ¥å°†æ¶ˆæ¯åŒ…è£…æˆtcpip_msgç»“æ„å¹¶å‘é€å‡ºå»ã€‚tcpip_threadå‡½æ•°è§£æè¯¥æ¶ˆæ¯å¹¶è°ƒç”¨å‡½æ•°do_newconnï¼Œdo_newconnæ ¹æ®å‚æ•°çš„ç±»å‹è°ƒç”¨å‡½æ•°tcp_newåˆ›å»ºä¸€ä¸ªTCPæ§åˆ¶å—</li> <li>tcpip_threadæ˜¯å¤„ç†TCP/IPçš„å†…æ ¸åè®®æ ˆè¿›ç¨‹ï¼Œå®ƒåªæ¥æ”¶tcpip_msgç»“æ„å°è£…çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®æ¶ˆæ¯çš„ç±»å‹æ¥åˆ¤å®šè¯¥æ¶ˆæ¯æ¥è‡ªç‰©ç†ç½‘å¡æˆ–åº”ç”¨å±‚ç¨‹åºã€‚å¦‚æœæ¥æ”¶åˆ°ç½‘å¡çš„IPæŠ¥æ–‡ï¼Œåˆ™å°†è¯¥æŠ¥æ–‡é€’äº¤ç»™ip_inputå‡½æ•°ï¼›å¦‚æœæ˜¯åº”ç”¨å±‚ç¨‹åºå‘é€çš„æ¶ˆæ¯ï¼Œåˆ™é€šè¿‡è°ƒç”¨æ¶ˆæ¯æŒ‡å®šçš„å†…æ ¸å¤„ç†å‡½æ•°æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½</li></ul> <h3 id="socket-api"><a href="#socket-api" class="header-anchor">#</a> Socket API</h3> <blockquote><p>LwIPæä¾›äº†æ ‡å‡†BSDå¥—æ¥å­—APIï¼Œå®ƒä¹Ÿæ˜¯æœ‰åºAPIï¼Œåœ¨å†…å­˜æ„å»ºäºNetconn APIä¹‹ä¸Šã€‚æ‰€è°“â€œæœ‰åºâ€æ˜¯æŒ‡å…¶æ‰§è¡Œæ¨¡å‹åŸºäºå…¸å‹çš„é˜»å¡å¼æ‰“å¼€-è¯»-å†™-å…³é—­æœºåˆ¶ã€‚</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61V4H.png" alt="Socket API"></p> <div class="custom-block warning"><p class="custom-block-title">HTTP åè®®åœ¨ç‰©è”ç½‘ç³»ç»Ÿä¸­çš„åŠ£åŠ¿</p> <ol><li>HTTP æ˜¯ä¸€ç§åŒæ­¥åè®®ï¼Œå®¢æˆ·ç«¯éœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„å“åº”æ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥å·¥ä½œï¼ˆåœ¨å®¢æˆ·ç«¯æ•°é‡å¤šã€ç½‘ç»œä¸å¯é çš„åœºæ™¯ä¸‹ï¼Œå®ç°åŒæ­¥é€šä¿¡å¾ˆå›°éš¾ï¼‰</li> <li>HTTP æ˜¯å•å‘çš„ï¼Œå®¢æˆ·ç«¯åªèƒ½ä¸»åŠ¨å‘æœåŠ¡å™¨å‘å‡ºæ•°æ®ï¼Œæ— æ³•è¢«åŠ¨æ¥æ”¶æ¥è‡ªç½‘ç»œçš„æ•°æ®ï¼ˆä¸é€‚ç”¨äºå®æ—¶æ§åˆ¶çš„åœºåˆï¼‰</li> <li>HTTP æœ‰è®¸å¤šå¸§å¤´å’Œè§„åˆ™ï¼Œæ˜¯ä¸€ç§é‡é‡çº§çš„åè®®ï¼ˆå®ç°åœ¨ç‰©è”ç½‘è®¾å¤‡ä¸­éœ€è¦è€—è´¹å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼‰</li></ol></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/cs/lwip.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µé¢</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2021/9/11 ä¸‹åˆ3:40:37</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/cs/logistic_regression.html" class="prev">
        é€»è¾‘å›å½’
      </a></span> <span class="next"><a href="/blog/cs/mbedtls.html">
        ğ™¢ğ™—ğ™šğ™™ğ™ğ™‡ğ™ åŸºç¡€
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.ac7e3fa7.js" defer></script><script src="/blog/assets/js/4.5a6f3cdb.js" defer></script><script src="/blog/assets/js/6.0f172f01.js" defer></script><script src="/blog/assets/js/13.e6b2f1ea.js" defer></script>
  </body>
</html>
