<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suda-morris 个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <meta name="description" content="记录学习生活，探索未知领域">
    
    <link rel="preload" href="/blog/assets/css/0.styles.6d8afabb.css" as="style"><link rel="preload" href="/blog/assets/js/app.f7371fc1.js" as="script"><link rel="preload" href="/blog/assets/js/4.86db7451.js" as="script"><link rel="preload" href="/blog/assets/js/75.34c15c92.js" as="script"><link rel="preload" href="/blog/assets/js/13.4f481eb8.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d57735f5.js"><link rel="prefetch" href="/blog/assets/js/11.32df3512.js"><link rel="prefetch" href="/blog/assets/js/12.4034ef2f.js"><link rel="prefetch" href="/blog/assets/js/14.59cf0e7f.js"><link rel="prefetch" href="/blog/assets/js/15.c8959e95.js"><link rel="prefetch" href="/blog/assets/js/16.ffd1339b.js"><link rel="prefetch" href="/blog/assets/js/17.7b5dae56.js"><link rel="prefetch" href="/blog/assets/js/18.8697be37.js"><link rel="prefetch" href="/blog/assets/js/19.7515aa84.js"><link rel="prefetch" href="/blog/assets/js/2.f785d2c1.js"><link rel="prefetch" href="/blog/assets/js/20.675d2d6b.js"><link rel="prefetch" href="/blog/assets/js/21.5b1ed3ba.js"><link rel="prefetch" href="/blog/assets/js/22.b0f3c0c2.js"><link rel="prefetch" href="/blog/assets/js/23.e85250c5.js"><link rel="prefetch" href="/blog/assets/js/24.e25d5894.js"><link rel="prefetch" href="/blog/assets/js/25.ab70bdf8.js"><link rel="prefetch" href="/blog/assets/js/26.30c40f25.js"><link rel="prefetch" href="/blog/assets/js/27.98475093.js"><link rel="prefetch" href="/blog/assets/js/28.a550e4dc.js"><link rel="prefetch" href="/blog/assets/js/29.046f7e94.js"><link rel="prefetch" href="/blog/assets/js/3.0f1a8f79.js"><link rel="prefetch" href="/blog/assets/js/30.fced83cb.js"><link rel="prefetch" href="/blog/assets/js/31.6928eb70.js"><link rel="prefetch" href="/blog/assets/js/32.b6a3f81d.js"><link rel="prefetch" href="/blog/assets/js/33.bf2721b1.js"><link rel="prefetch" href="/blog/assets/js/34.56c51ffd.js"><link rel="prefetch" href="/blog/assets/js/35.6c1d065e.js"><link rel="prefetch" href="/blog/assets/js/36.c1e95b2c.js"><link rel="prefetch" href="/blog/assets/js/37.2f057b97.js"><link rel="prefetch" href="/blog/assets/js/38.2506f779.js"><link rel="prefetch" href="/blog/assets/js/39.ae17cd2e.js"><link rel="prefetch" href="/blog/assets/js/40.7af103e2.js"><link rel="prefetch" href="/blog/assets/js/41.7e0c4fd2.js"><link rel="prefetch" href="/blog/assets/js/42.b7df5389.js"><link rel="prefetch" href="/blog/assets/js/43.ce0c76ac.js"><link rel="prefetch" href="/blog/assets/js/44.74acb7f6.js"><link rel="prefetch" href="/blog/assets/js/45.209d70ba.js"><link rel="prefetch" href="/blog/assets/js/46.446b24cf.js"><link rel="prefetch" href="/blog/assets/js/47.cc7c15cb.js"><link rel="prefetch" href="/blog/assets/js/48.d8003d98.js"><link rel="prefetch" href="/blog/assets/js/49.d8a0e817.js"><link rel="prefetch" href="/blog/assets/js/5.cc2c00ae.js"><link rel="prefetch" href="/blog/assets/js/50.28bf0451.js"><link rel="prefetch" href="/blog/assets/js/51.29f7f8e6.js"><link rel="prefetch" href="/blog/assets/js/52.2663a05a.js"><link rel="prefetch" href="/blog/assets/js/53.9ce47afe.js"><link rel="prefetch" href="/blog/assets/js/54.e187ec7a.js"><link rel="prefetch" href="/blog/assets/js/55.2eda951a.js"><link rel="prefetch" href="/blog/assets/js/56.49fca5f7.js"><link rel="prefetch" href="/blog/assets/js/57.57168edc.js"><link rel="prefetch" href="/blog/assets/js/58.aa2bd46e.js"><link rel="prefetch" href="/blog/assets/js/59.cbfa961c.js"><link rel="prefetch" href="/blog/assets/js/6.cc76698f.js"><link rel="prefetch" href="/blog/assets/js/60.56cb85bf.js"><link rel="prefetch" href="/blog/assets/js/61.3b05db21.js"><link rel="prefetch" href="/blog/assets/js/62.a253c43f.js"><link rel="prefetch" href="/blog/assets/js/63.665b3419.js"><link rel="prefetch" href="/blog/assets/js/64.81d19861.js"><link rel="prefetch" href="/blog/assets/js/65.4a6980eb.js"><link rel="prefetch" href="/blog/assets/js/66.1d662c87.js"><link rel="prefetch" href="/blog/assets/js/67.2fa6ac31.js"><link rel="prefetch" href="/blog/assets/js/68.755cdf7f.js"><link rel="prefetch" href="/blog/assets/js/69.3035c303.js"><link rel="prefetch" href="/blog/assets/js/7.3616dd49.js"><link rel="prefetch" href="/blog/assets/js/70.d9d4a8ee.js"><link rel="prefetch" href="/blog/assets/js/71.73cc51c4.js"><link rel="prefetch" href="/blog/assets/js/72.efd94039.js"><link rel="prefetch" href="/blog/assets/js/73.059d55ba.js"><link rel="prefetch" href="/blog/assets/js/74.4ad46ecd.js"><link rel="prefetch" href="/blog/assets/js/76.1b725aa4.js"><link rel="prefetch" href="/blog/assets/js/77.50e92786.js"><link rel="prefetch" href="/blog/assets/js/78.e8947189.js"><link rel="prefetch" href="/blog/assets/js/79.0f0918b7.js"><link rel="prefetch" href="/blog/assets/js/8.25f08ec4.js"><link rel="prefetch" href="/blog/assets/js/80.66771e2f.js"><link rel="prefetch" href="/blog/assets/js/81.9de4e215.js"><link rel="prefetch" href="/blog/assets/js/82.7d56175f.js"><link rel="prefetch" href="/blog/assets/js/83.fa751f46.js"><link rel="prefetch" href="/blog/assets/js/84.5039ce08.js"><link rel="prefetch" href="/blog/assets/js/85.29f3100c.js"><link rel="prefetch" href="/blog/assets/js/86.f2989267.js"><link rel="prefetch" href="/blog/assets/js/87.d8d55a52.js"><link rel="prefetch" href="/blog/assets/js/88.151d8cdc.js"><link rel="prefetch" href="/blog/assets/js/89.7bd0925d.js"><link rel="prefetch" href="/blog/assets/js/9.51fef0b5.js"><link rel="prefetch" href="/blog/assets/js/90.af7f69c8.js"><link rel="prefetch" href="/blog/assets/js/91.22eec426.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.6d8afabb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">
  Others
</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/others/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/others/markdown.html" class="sidebar-link">𝙈𝙖𝙧𝙠𝙙𝙤𝙬𝙣 基本语法</a></li><li><a href="/blog/others/oral_english.html" class="sidebar-link">常用口语</a></li><li><a href="/blog/others/terminal_presentation.html" class="sidebar-link">终端演示工具</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>title: Python Socket
tags:</p> <ul><li>Socket
categories:</li> <li>Python
author: suda-morris
date: 2018-10-17 22:36:12 +0800</li></ul> <hr> <h1 id="python中的socket编程"><a href="#python中的socket编程" class="header-anchor">#</a> Python中的Socket编程</h1> <h2 id="python标准库中的socket模块"><a href="#python标准库中的socket模块" class="header-anchor">#</a> Python标准库中的socket模块</h2> <blockquote><p>socket对象支持使用TCP或者UDP协议进行网络通信，并提供了socket编程所需要的对象、函数和常量</p></blockquote> <h3 id="简单tcp服务器实例"><a href="#简单tcp服务器实例" class="header-anchor">#</a> 简单TCP服务器实例</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的流式套接字</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 绑定本地地址和端口号</span>
    server_sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 使能监听</span>

    client_sock<span class="token punctuation">,</span> client_addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 阻塞，等待客户端连接</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 接收数据</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 数据解码</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Client[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>client_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot;--&gt; OK&quot;</span>
        client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 发送数据给客户端</span>

    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭客户端套接字</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭服务端套接字</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="简单tcp客户端实例"><a href="#简单tcp客户端实例" class="header-anchor">#</a> 简单TCP客户端实例</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的流式套接字</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向服务器发起连接</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server: {content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="简单udp服务器实例"><a href="#简单udp服务器实例" class="header-anchor">#</a> 简单UDP服务器实例</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的数据报套接字</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 绑定IP地址和端口号</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> client_addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Client[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>client_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot; --&gt; OK&quot;</span>
        server_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client_addr_info<span class="token punctuation">)</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="简单udp客户端实例"><a href="#简单udp客户端实例" class="header-anchor">#</a> 简单UDP客户端实例</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的数据报套接字</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data<span class="token punctuation">,</span> server_addr_info <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>server_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="小项目-备份服务器与客户端的简单实现-多线程版"><a href="#小项目-备份服务器与客户端的简单实现-多线程版" class="header-anchor">#</a> 小项目---备份服务器与客户端的简单实现(多线程版)</h2> <p><img src="https://s1.ax1x.com/2018/10/17/idOnEQ.png" alt="bak_server_protocol"></p> <h3 id="服务器"><a href="#服务器" class="header-anchor">#</a> 服务器</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>

DEFAULT_BAK_PATH <span class="token operator">=</span> <span class="token string">r&quot;E:\MyBak&quot;</span>  <span class="token comment"># 服务器端默认备份路径</span>

SERV_RUN_FLAG <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># 服务器运行标志</span>
flag_lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 运行标志的指令锁</span>


<span class="token keyword">def</span> <span class="token function">get_file_infos</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    接受客户端传来的文件列表信息
    :param client:客户端连接套接字
    :return:data要备份的文件列表信息，compress是否是压缩文件
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># 长整形+布尔型</span>
    headsize <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
    data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>headsize<span class="token punctuation">)</span>  <span class="token comment"># 接受文件信息列表的长度</span>
    infos_len<span class="token punctuation">,</span> compress <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span>  <span class="token comment"># unpack字节数据</span>
    data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>  <span class="token comment"># 保存文件列表信息</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  <span class="token comment"># 每次最多接收1K字节</span>
        <span class="token keyword">if</span> infos_len <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            data <span class="token operator">+=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            infos_len <span class="token operator">-=</span> <span class="token number">1024</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            data <span class="token operator">+=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>infos_len<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 使用pickle反序列化</span>
    <span class="token keyword">return</span> data<span class="token punctuation">,</span> compress


<span class="token keyword">def</span> <span class="token function">mk_file_path</span><span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    根据文件的相对路径创建服务器端的路径
    :param filepath_rel: 客户端文件的相对路径
    &quot;&quot;&quot;</span>
    paths <span class="token operator">=</span> filepath_rel<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 按照目录级别切分，去掉最后一项(文件名)</span>
    p <span class="token operator">=</span> DEFAULT_BAK_PATH
    <span class="token keyword">for</span> path <span class="token keyword">in</span> paths<span class="token punctuation">:</span>
        p <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>p<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment"># 逐级创建文件夹</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_compress_size</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    获取压缩文件的大小
    :param client: 客户端连接套接字
    :return: size压缩文件的大小
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q'</span>  <span class="token comment"># 长整型</span>
    size <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
    data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    size <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> size


<span class="token keyword">def</span> <span class="token function">recv_file</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    接收并保存单个文件
    :param client:客户端连接套接字
    :param filepath_rel:文件的相对地址
    :param file_size:文件大小
    :param compress:是否是压缩文件
    :return:返回接收成功与否
    &quot;&quot;&quot;</span>
    res <span class="token operator">=</span> <span class="token boolean">True</span>
    mk_file_path<span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span>
    filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">)</span>  <span class="token comment"># 文件在服务器端的完整路径</span>
    <span class="token keyword">if</span> compress<span class="token punctuation">:</span>
        file_size <span class="token operator">=</span> get_compress_size<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
        filepath <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;.tar.gz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 修改文件拓展名</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb+&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> file_size <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                file_size <span class="token operator">-=</span> <span class="token number">1024</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>file_size<span class="token punctuation">)</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res


<span class="token keyword">def</span> <span class="token function">send_echo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    发送当前文件的备份结果给客户端
    :param client: 客户端连接的套接字
    :param result: 当前文件备份的结果
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> result<span class="token punctuation">:</span>
        client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;success&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;failure&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">client_operate</span><span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    客户端处理线程
    :param client_sock:客户端连接套接字
    &quot;&quot;&quot;</span>
    files_infos<span class="token punctuation">,</span> compress <span class="token operator">=</span> get_file_infos<span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span>  <span class="token comment"># 获取客户端传送的文件列表信息以及是否发送压缩文件</span>
    <span class="token keyword">for</span> file_size<span class="token punctuation">,</span> file_path_rel <span class="token keyword">in</span> files_infos<span class="token punctuation">:</span>  <span class="token comment"># 逐个接收文件</span>
        res <span class="token operator">=</span> recv_file<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> file_path_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>
        send_echo<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭客户端套接字</span>


<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    启动服务后运行的线程函数
    :param host: 服务器IP地址
    :param port: 服务器端口号
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断本地备份根目录是否存在</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 创建流失套接字</span>
    server_sock<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 设置超时时间1s</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 绑定服务器端的IP和端口号</span>
    server_sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 同一时间只处理一个客户端的连接</span>
    flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 访问SERV_RUN_FLAG之前需要先获取指令锁</span>
    <span class="token keyword">while</span> SERV_RUN_FLAG<span class="token punctuation">:</span>
        flag_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 访问完成后立马释放指令锁</span>
        client_sock <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 客户端连接的套接字</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            client_sock<span class="token punctuation">,</span> addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 1s内没有发生客户端连接动作就会产生超时异常</span>
        <span class="token keyword">except</span> socket<span class="token punctuation">.</span>timeout<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">if</span> client_sock<span class="token punctuation">:</span>  <span class="token comment"># 确实有客户端发起连接请求</span>
            t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>client_operate<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 单独开线程处理客户端的需求</span>
            t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 访问SERV_RUN_FLAG之前需要先获取指令锁</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义Frame
        :param root: 父类容器对象
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 网格布局</span>
        self<span class="token punctuation">.</span>local_ip <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
        self<span class="token punctuation">.</span>local_ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10888</span><span class="token punctuation">,</span> <span class="token number">20888</span><span class="token punctuation">,</span> <span class="token number">30888</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        初始化界面组件
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;远程备份服务器&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 横跨两列</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务地址&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>__get_ip_address<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 下拉列表</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># 下拉列表默认值</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务端口&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;启动服务&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;退出服务&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__get_ip_address</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        获取服务器端可用的IP地址
        :return: IP地址列表
        &quot;&quot;&quot;</span>
        hostname <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取主机名</span>
        info <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname_ex<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>  <span class="token comment"># 根据主机名获取IP地址信息</span>
        info <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 第3项才是ip地址列表</span>
        info<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># 加上回环地址</span>
        <span class="token keyword">return</span> info

    <span class="token keyword">def</span> <span class="token function">__start_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【启动服务】按键处理程序
        &quot;&quot;&quot;</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 从下拉列表中获取用户设置的IP地址</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 从下拉列表中获取用户设置的端口号</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 开启线程处理客户端连接请求</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>state<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 启动按钮变暗</span>

    <span class="token keyword">def</span> <span class="token function">__exit_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【退出服务】按键处理程序
        &quot;&quot;&quot;</span>
        <span class="token keyword">global</span> SERV_RUN_FLAG
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                SERV_RUN_FLAG <span class="token operator">=</span> <span class="token boolean">False</span>
                flag_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 退出界面</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;备份服务器&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br></div></div><h3 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> tarfile
<span class="token keyword">import</span> tempfile
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token keyword">def</span> <span class="token function">send_file_infos</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> file_infos<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    发送文件信息
    :param client:客户端连接套接字
    :param file_infos: 文件信息，列表
    :param compress: 是否需要压缩
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># 长整型+布尔类型</span>
    infos_bytes <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>file_infos<span class="token punctuation">)</span>  <span class="token comment"># 对file_infos序列化操作</span>
    infos_bytes_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>infos_bytes<span class="token punctuation">)</span>
    infos_bytes_len_pack <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> infos_bytes_len<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># 用struct模块对长度值进行二进制编码</span>
    client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos_bytes_len_pack<span class="token punctuation">)</span>  <span class="token comment"># 先发送长度</span>
    client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos_bytes<span class="token punctuation">)</span>  <span class="token comment"># 再发送内容</span>


<span class="token keyword">def</span> <span class="token function">send_file</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    发送单个文件至服务器
    :param client:客户端连接套接字
    :param file:#要发送文件的绝对路径
    :param compress:是否需要压缩
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> compress<span class="token punctuation">:</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 二进制只读方式读取文件</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建临时文件</span>
        tar <span class="token operator">=</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">&quot;w:gz&quot;</span><span class="token punctuation">,</span> fileobj<span class="token operator">=</span>f<span class="token punctuation">)</span>  <span class="token comment"># gzip 压缩</span>
        tar<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        tar<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 调整文件指针位置</span>
        file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>stat<span class="token punctuation">(</span>f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>st_size  <span class="token comment"># 计算压缩文件的大小</span>
        file_size_pack <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'Q'</span><span class="token punctuation">,</span> file_size<span class="token punctuation">)</span>  <span class="token comment"># 压缩文件大小二进制编码</span>
        client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>file_size_pack<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 每次发送1K字节，直到发送结束</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 发送原文件或者时压缩文件</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_bak_info</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    从服务器获取当前备份结果信息
    :param client:客户端连接套接字
    :param size:返回结果信息[success,failure]的字节数
    &quot;&quot;&quot;</span>
    msg <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_file_infos_paths</span><span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    获取文件夹下的所有文件信息和文件路径
    :param root_path:文件夹根目录
    :return:infos文件信息列表，元素是元祖(文件大小，文件相对路径)，paths文件绝对路径
    &quot;&quot;&quot;</span>
    infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> root_path <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token keyword">for</span> dirpath<span class="token punctuation">,</span> dirnames<span class="token punctuation">,</span> filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 递归遍历根目录下所有文件</span>
        <span class="token comment"># dirpath根目录，dirnames文件夹名，filenames文件名</span>
        <span class="token keyword">for</span> file_name <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
            file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dirpath<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>  <span class="token comment"># 获取文件的绝对路径</span>
            paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
            file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>stat<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span>st_size  <span class="token comment"># 获取文件大小</span>
            file_path_rel <span class="token operator">=</span> file_path<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>root_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 获取文件相对路径</span>
            infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>file_size<span class="token punctuation">,</span> file_path_rel<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> infos<span class="token punctuation">,</span> paths


<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> root_path<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    开始备份工作的线程函数
    :param host:服务器IP地址
    :param port:服务器端口号
    :param root_path:备份路径根目录
    :param compress:是否需要压缩文件
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">u&quot;备份的路径不存在!&quot;</span><span class="token punctuation">,</span> root_path<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 建立流式套接字</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 连接服务器</span>
    file_infos<span class="token punctuation">,</span> file_paths <span class="token operator">=</span> get_file_infos_paths<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>  <span class="token comment"># 获取指定目录下的文件信息与文件路径</span>
    send_file_infos<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> file_infos<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># 发送需要备份的文件信息</span>
    <span class="token keyword">for</span> fp <span class="token keyword">in</span> file_paths<span class="token punctuation">:</span>
        send_file<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># 依次发送所有文件</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span>  <span class="token comment"># 打印当前正在备份的文件</span>
        get_bak_info<span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span>  <span class="token comment"># 打印文件备份结果</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义Frame
        :param root: 父类容器对象
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root  <span class="token comment"># 保存父类容器控件</span>
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 整体使用网格布局</span>
        self<span class="token punctuation">.</span>remote_ip_default <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>  <span class="token comment"># 默认连接的服务器IP地址</span>
        self<span class="token punctuation">.</span>remote_port_default <span class="token operator">=</span> <span class="token number">10888</span>  <span class="token comment"># 默认连接的服务器端口号</span>
        self<span class="token punctuation">.</span>remote_ip_var <span class="token operator">=</span> StringVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 保存用户输入的服务器IP地址</span>
        self<span class="token punctuation">.</span>remote_port_var <span class="token operator">=</span> IntVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 保存用户输入的服务器端口号</span>
        self<span class="token punctuation">.</span>bak_src_var <span class="token operator">=</span> StringVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 保存用户输入的本地备份路径</span>
        self<span class="token punctuation">.</span>compress_var <span class="token operator">=</span> BooleanVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 保存用户是否需要对文件进行压缩处理</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化界面上的所有组件</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        初始化界面组件
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;远程备份客户端&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 横跨两列</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务器地址：&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">)</span>  <span class="token comment"># 输入框</span>
        self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>remote_ip_default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务器端口：&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>remote_port_default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        bak_src_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;备份的目标：&quot;</span><span class="token punctuation">)</span>
        bak_src_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        compress_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;压缩备份：&quot;</span><span class="token punctuation">)</span>
        compress_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>compress_on <span class="token operator">=</span> Checkbutton<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;开启压缩&quot;</span><span class="token punctuation">,</span> variable<span class="token operator">=</span>self<span class="token punctuation">.</span>compress_var<span class="token punctuation">,</span> onvalue<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> offvalue<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 单选框</span>
        self<span class="token punctuation">.</span>compress_on<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;开始备份&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_bak<span class="token punctuation">)</span>  <span class="token comment"># 按钮，绑定事件处理函数</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;退出程序&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_bak<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__start_bak</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【开始备份】事件处理
        &quot;&quot;&quot;</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        bak_path <span class="token operator">=</span> self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        compress <span class="token operator">=</span> self<span class="token punctuation">.</span>compress_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 清空备份路径输入框</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> bak_path<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建子线程</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit_bak</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【退出程序】事件处理
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 退出界面</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;备份客户端&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 大小不允许伸缩</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><h2 id="socketserver框架"><a href="#socketserver框架" class="header-anchor">#</a> SocketServer框架</h2> <blockquote><p>Python提供了SocketServer框架用来编写网络服务器，它预定义了一个基本的服务器框架</p> <p>步骤：</p> <ol><li>建立客户端处理类</li> <li>初始化服务器类，传入相关参数</li> <li>启动服务器</li></ol></blockquote> <h3 id="socketserver框架下的tcp服务器"><a href="#socketserver框架下的tcp服务器" class="header-anchor">#</a> SocketServer框架下的TCP服务器</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading

HOST <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
PORT <span class="token operator">=</span> <span class="token number">3629</span>


<span class="token keyword">def</span> <span class="token function">shut_server_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> server<span class="token punctuation">:</span>
        server<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 按行读取数据(需要数据中包含换行符)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive From Client: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>shut_server_down<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 服务器的shutdown方法需要在别的线程中调用</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> MyHandler<span class="token punctuation">)</span>  <span class="token comment"># 创建TCP服务器</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 运行服务器</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="配套的tcp客户端"><a href="#配套的tcp客户端" class="header-anchor">#</a> 配套的TCP客户端</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的流式套接字</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向服务器发起连接</span>
    data <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        data <span class="token operator">+=</span> <span class="token string">'\n'</span>
        client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server: {content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="socketserver框架下的udp服务器"><a href="#socketserver框架下的udp服务器" class="header-anchor">#</a> SocketServer框架下的UDP服务器</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading

HOST <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
PORT <span class="token operator">=</span> <span class="token number">3629</span>


<span class="token keyword">def</span> <span class="token function">shut_server_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> server<span class="token punctuation">:</span>
        server<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>DatagramRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> client_sock <span class="token operator">=</span> self<span class="token punctuation">.</span>request
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>shut_server_down<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive From Client: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot;---&gt;OK&quot;</span>
        client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>UDPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> MyHandler<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="配套的udp客户端"><a href="#配套的udp客户端" class="header-anchor">#</a> 配套的UDP客户端</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># 本套接字是建立在IPv4基础上的数据报套接字</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>
            <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 防止接收到空数据</span>
                data<span class="token punctuation">,</span> server_addr_info <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>server_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="使用socketserver框架改写备份服务器程序"><a href="#使用socketserver框架改写备份服务器程序" class="header-anchor">#</a> 使用SocketServer框架改写备份服务器程序</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>

DEFAULT_BAK_PATH <span class="token operator">=</span> <span class="token string">r&quot;E:\MyBak&quot;</span>  <span class="token comment"># 服务器端默认备份路径</span>


<span class="token keyword">def</span> <span class="token function">mk_file_path</span><span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    根据文件的相对路径创建服务器端的路径
    :param filepath_rel: 客户端文件的相对路径
    &quot;&quot;&quot;</span>
    paths <span class="token operator">=</span> filepath_rel<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 按照目录级别切分，去掉最后一项(文件名)</span>
    p <span class="token operator">=</span> DEFAULT_BAK_PATH
    <span class="token keyword">for</span> path <span class="token keyword">in</span> paths<span class="token punctuation">:</span>
        p <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>p<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment"># 逐级创建文件夹</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">BakHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__client_operate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__client_operate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        客户端处理线程
        &quot;&quot;&quot;</span>
        files_infos<span class="token punctuation">,</span> compress <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_file_infos<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取客户端传送的文件列表信息以及是否发送压缩文件</span>
        <span class="token keyword">for</span> file_size<span class="token punctuation">,</span> file_path_rel <span class="token keyword">in</span> files_infos<span class="token punctuation">:</span>  <span class="token comment"># 逐个接收文件</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>__recv_file<span class="token punctuation">(</span>file_path_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># request就是客户端连接的套接字</span>
            self<span class="token punctuation">.</span>__send_echo<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭客户端套接字</span>

    <span class="token keyword">def</span> <span class="token function">__get_file_infos</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        接受客户端传来的文件列表信息
        :return:data要备份的文件列表信息，compress是否是压缩文件
        &quot;&quot;&quot;</span>
        fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># 长整形+布尔型</span>
        headsize <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>headsize<span class="token punctuation">)</span>  <span class="token comment"># 接受文件信息列表的长度</span>
        infos_len<span class="token punctuation">,</span> compress <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span>  <span class="token comment"># unpack字节数据</span>
        data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>  <span class="token comment"># 保存文件列表信息</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  <span class="token comment"># 每次最多接收1K字节</span>
            <span class="token keyword">if</span> infos_len <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                data <span class="token operator">+=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                infos_len <span class="token operator">-=</span> <span class="token number">1024</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">+=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>infos_len<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 使用pickle反序列化</span>
        <span class="token keyword">return</span> data<span class="token punctuation">,</span> compress

    <span class="token keyword">def</span> <span class="token function">__send_echo</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        发送当前文件的备份结果给客户端
        :param result: 当前文件备份的结果
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> result<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;success&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;failure&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__recv_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        接收并保存单个文件
        :param filepath_rel:文件的相对地址
        :param file_size:文件大小
        :param compress:是否是压缩文件
        :return:返回接收成功与否
        &quot;&quot;&quot;</span>
        res <span class="token operator">=</span> <span class="token boolean">True</span>
        mk_file_path<span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">)</span>  <span class="token comment"># 文件在服务器端的完整路径</span>
        <span class="token keyword">if</span> compress<span class="token punctuation">:</span>
            file_size <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_compress_size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            filepath <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;.tar.gz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 修改文件拓展名</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb+&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> file_size <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    file_size <span class="token operator">-=</span> <span class="token number">1024</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>file_size<span class="token punctuation">)</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            res <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> res

    <span class="token keyword">def</span> <span class="token function">__get_compress_size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        获取压缩文件的大小
        :return: size压缩文件的大小
        &quot;&quot;&quot;</span>
        fmt_str <span class="token operator">=</span> <span class="token string">'Q'</span>  <span class="token comment"># 长整型</span>
        size <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        size <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> size


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义Frame
        :param root: 父类容器对象(根窗口)
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 网格布局</span>
        self<span class="token punctuation">.</span>local_ip <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
        self<span class="token punctuation">.</span>local_ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10888</span><span class="token punctuation">,</span> <span class="token number">20888</span><span class="token punctuation">,</span> <span class="token number">30888</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        初始化界面组件
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;远程备份服务器&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 横跨两列</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务地址&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>__get_ip_address<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 下拉列表</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># 下拉列表默认值</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;服务端口&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;启动服务&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;退出服务&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__get_ip_address</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        获取服务器端可用的IP地址
        :return: IP地址列表
        &quot;&quot;&quot;</span>
        hostname <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取主机名</span>
        info <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname_ex<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>  <span class="token comment"># 根据主机名获取IP地址信息</span>
        info <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 第3项才是ip地址列表</span>
        info<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># 加上回环地址</span>
        <span class="token keyword">return</span> info

    <span class="token keyword">def</span> <span class="token function">__start_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【启动服务】按键处理程序
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断本地备份根目录是否存在</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 从下拉列表中获取用户设置的IP地址</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 从下拉列表中获取用户设置的端口号</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>state<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 启动按钮变暗</span>
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BakHandler<span class="token punctuation">)</span>  <span class="token comment"># 创建多线程TCP服务器</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 在新线程中启动服务器</span>

    <span class="token keyword">def</span> <span class="token function">__exit_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        【退出服务】按键处理程序
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>server<span class="token punctuation">:</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 退出界面</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 根窗口</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;备份服务器&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br></div></div><h2 id="项目-简单ftp服务器与客户端的实现"><a href="#项目-简单ftp服务器与客户端的实现" class="header-anchor">#</a> 项目：简单FTP服务器与客户端的实现</h2> <h3 id="ftp服务器的实现"><a href="#ftp服务器的实现" class="header-anchor">#</a> FTP服务器的实现</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">add_opr_file</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    向FTPDataHandler类的操作列表中添加新操作
    命令通道和数据通道，实际上是通过FTPDataHandler类中的client_oper字典联系在一起的
    :param client_addr: 客户端的ip地址
    :param item: 新操作
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> client_addr <span class="token keyword">in</span> FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">:</span>
        FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>client_addr<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>client_addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">,</span> <span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">FTPHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> client_addr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> server<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        FTP服务器的处理类
        :param request: 请求对象，即连接的客户端socket
        :param client_addr: 客户端地址
        :param server: 与自己绑定的服务器对象(即后面的MyThreadFTPServer对象)
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>cmd_keys <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NOOP&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TYPE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PASV&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PORT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># FTP服务器支持的命令</span>
        self<span class="token punctuation">.</span>coms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 字典，{命令:执行方法}</span>
        self<span class="token punctuation">.</span>__init_coms<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化字典coms</span>
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> server  <span class="token comment"># 与服务类绑定的服务器的引用</span>
        self<span class="token punctuation">.</span>cmd_port <span class="token operator">=</span> <span class="token number">21</span>  <span class="token comment"># 命令端口号</span>
        self<span class="token punctuation">.</span>data_port <span class="token operator">=</span> <span class="token number">20</span>  <span class="token comment"># 数据端口号</span>
        self<span class="token punctuation">.</span>pasv_data_ip <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 被动模式下，数据模块线程服务器的IP地址</span>
        self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 被动模式下，数据模块线程服务器的端口号</span>
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 某条命令对应的参数</span>
        self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 用户是否登陆</span>
        self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 当前服务器是否工作在被动模式</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>request<span class="token punctuation">,</span> client_addr<span class="token punctuation">,</span> server<span class="token punctuation">)</span>  <span class="token comment"># 调用父类的构造函数</span>

    <span class="token keyword">def</span> <span class="token function">__init_coms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        初始化字典coms，键为命令名字，值为具体的方法
        &quot;&quot;&quot;</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmd_keys<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>coms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;exe_&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 获取exe_开头的成员方法</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        重写父类的处理函数
        &quot;&quot;&quot;</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            cmds <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 读取一行用户发来的命令</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> cmds<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            cmds <span class="token operator">=</span> cmds<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 解码</span>
            cmd <span class="token operator">=</span> self<span class="token punctuation">.</span>__parse_cmd<span class="token punctuation">(</span>cmds<span class="token punctuation">)</span>  <span class="token comment"># 解析命令</span>
            <span class="token keyword">if</span> cmd <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmd_keys<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>coms<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 执行命令对应的方法</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Invalid command.&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd <span class="token operator">==</span> <span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>

    <span class="token keyword">def</span> <span class="token function">__parse_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        从字符串中提取命令动词和参数
        :param cmds:包含命令、参数的字符串
        :return:命令动词，大写
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token string">' '</span> <span class="token keyword">in</span> cmds<span class="token punctuation">:</span>  <span class="token comment"># 根据空格来判断是否包含命令参数</span>
            cmd<span class="token punctuation">,</span> args <span class="token operator">=</span> cmds<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>  <span class="token comment"># 切分命令动词与命令参数</span>
            self<span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清除换行符与空格</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cmd <span class="token operator">=</span> cmds<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cmd<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        向客户端返回命令执行状态
        :param code:状态码
        :param info:状态信息
        &quot;&quot;&quot;</span>
        infos <span class="token operator">=</span> <span class="token string">&quot;%d %s\n&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__make_pasv_info</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        返回进入主动模式的信息
        :return: 返回给客户端的信息，包括主动模式数据通道的IP地址和端口号，按照FTP协议的格式要求发送
        &quot;&quot;&quot;</span>
        ip_info <span class="token operator">=</span> self<span class="token punctuation">.</span>pasv_data_ip<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>  <span class="token comment"># IP地址之间的.号使用,号来替代</span>
        ip_info <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ip_info<span class="token punctuation">)</span>
        porta_info <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">//</span> <span class="token number">256</span><span class="token punctuation">)</span>
        portb_info <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>ip_info<span class="token punctuation">,</span> porta_info<span class="token punctuation">,</span> portb_info<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter_pasv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        进入被动模式，开启数据服务器
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>data_server<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pasv_data_ip<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">=</span> self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>create_data_server<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_quit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        QUIT命令的执行动作
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">221</span><span class="token punctuation">,</span> <span class="token string">&quot;bye.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_user</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        USER命令的执行动作
        &quot;&quot;&quot;</span>
        user <span class="token operator">=</span> self<span class="token punctuation">.</span>args  <span class="token comment"># 获取登陆的用户名</span>
        <span class="token keyword">if</span> user <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">True</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">230</span><span class="token punctuation">,</span> <span class="token string">&quot;identified!&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">530</span><span class="token punctuation">,</span> <span class="token string">&quot;Only use anonymous.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_noop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        NOOP命令的执行动作
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        TYPE命令的执行动作
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_pasv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        PASV命令的执行动作
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>loged<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">332</span><span class="token punctuation">,</span> <span class="token string">&quot;Please login.&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>  <span class="token comment"># 已经passive模式了</span>
            info <span class="token operator">=</span> <span class="token string">&quot;entering passive mode (%s)&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__make_pasv_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">227</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__enter_pasv<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 进入passive模式</span>
            info <span class="token operator">=</span> <span class="token string">&quot;entering passive mode (%s)&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__make_pasv_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">True</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">227</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>  <span class="token comment"># 进入passive模式失败</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">False</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Fail to enter passvie mode.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_port</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        PORT命令的执行动作
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Do not support port mode.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_retr</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        RETR命令的执行动作
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 确保要下载的文件是存在的</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">550</span><span class="token punctuation">,</span> <span class="token string">&quot;File {file_path} not exist!&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>file_path<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取客户端的IP地址</span>
        add_opr_file<span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向数据通道中添加新的任务</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_stor</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        STOR命令的执行动作
        &quot;&quot;&quot;</span>
        client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        add_opr_file<span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向数据通道中添加新的任务</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">FTPDataHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    client_oper <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 字典，键为客户端IP地址，值为列表，存放具体的操作</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        数据服务器针对每个连接的客户端的操作
        &quot;&quot;&quot;</span>
        peerip <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取连接的客户端的IP地址</span>
        opr <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_opr_args<span class="token punctuation">(</span>peerip<span class="token punctuation">)</span>  <span class="token comment"># 根据IP地址查询该客户端具体的操作</span>
        <span class="token keyword">if</span> opr<span class="token punctuation">:</span>
            <span class="token keyword">if</span> opr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>retr_file<span class="token punctuation">(</span>opr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 下载文件</span>
            <span class="token keyword">elif</span> opr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>stor_file<span class="token punctuation">(</span>opr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 上传文件</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 处理完依次上传或者下载任务后就关闭客户端套接字</span>

    <span class="token keyword">def</span> <span class="token function">__get_opr_args</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> peerip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        根据IP地址查询客户端需要服务的内容
        :param peerip: 远端的IP地址
        :return: opr具体的操作
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> peerip <span class="token keyword">in</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">:</span>
            opr <span class="token operator">=</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>peerip<span class="token punctuation">]</span><span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 弹出列表中的第一个</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>peerip<span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 针对该IP地址，列表中没有其余操作了</span>
                self<span class="token punctuation">.</span>client_oper<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>peerip<span class="token punctuation">)</span>  <span class="token comment"># 在字段中删除这个IP地址为键的项目</span>
            <span class="token keyword">return</span> opr

    <span class="token keyword">def</span> <span class="token function">retr_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        客户端下载文件(对应服务器端的发送文件)
        :param filepath: 文件路径
        &quot;&quot;&quot;</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stor_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        客户端上传文件(对应服务器端的接收并保存文件)
        :param filepath:文件路径
        &quot;&quot;&quot;</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 将新文件保存到当前目录的bakt文件夹下</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyThreadFTPServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义多线程FTP服务器
        :param addr: 服务器地址，元祖(IP地址，端口号)，21命令端口，20数据端口
        :param handler:处理客户端连接的对象
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>data_server <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 专门负责数据通道的服务器</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>addr<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        重写父类的shutdown函数
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>data_server<span class="token punctuation">:</span>  <span class="token comment"># 是否有数据通道服务器没有关闭</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 调用父类的挂机函数</span>

    <span class="token keyword">def</span> <span class="token function">create_data_server</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        创建数据通道专用服务器
        :return:pasv_data_ip数据服务器的IP地址；pasv_data_port数据服务器的端口号
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>data_server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FTPDataHandler<span class="token punctuation">)</span>
        pasv_data_ip<span class="token punctuation">,</span> pasv_data_port <span class="token operator">=</span> self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>server_address  <span class="token comment"># 获取数据服务器的ip地址和端口号</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 开启新线程，启动数据服务器</span>
        <span class="token keyword">return</span> pasv_data_ip<span class="token punctuation">,</span> pasv_data_port


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    ftp_server <span class="token operator">=</span> MyThreadFTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FTPHandler<span class="token punctuation">)</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>ftp_server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 开启新线程，启动FTP服务器</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FTP Server Start...&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># time.sleep(30)</span>
    <span class="token comment"># ftp_server.shutdown()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br></div></div><h3 id="ftp客户端的实现"><a href="#ftp客户端的实现" class="header-anchor">#</a> FTP客户端的实现</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading


<span class="token keyword">def</span> <span class="token function">get_file</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    从服务器下载文件
    :param host: 服务器IP地址
    :param port: 服务器端口号
    :param file_path: 文件路径
    &quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span>  <span class="token comment"># 文件保存在服务器的bakt文件夹下</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">put_data</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    上传文件至服务器
    :param host: 服务器的IP地址
    :param port: 服务器的端口号
    :param file_path: 本地文件路径
    &quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">FTPClient</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        自定义FTP客户端
        :param host:服务器IP地址
        :param port:服务器端口号
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host  <span class="token comment"># 服务器ip地址</span>
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port  <span class="token comment"># 服务器端口号</span>
        self<span class="token punctuation">.</span>cmds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NOOP&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TYPE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PASV&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PORT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 支持的FTP命令</span>
        self<span class="token punctuation">.</span>line_sep <span class="token operator">=</span> <span class="token string">'\n'</span>
        self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 是否已经登陆服务器</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 连接服务器端的套接字</span>
        self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 是否处于被动模式</span>
        self<span class="token punctuation">.</span>pasv_host <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 被动模式的服务器ip地址</span>
        self<span class="token punctuation">.</span>pasv_port <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 被动模式的服务器端口号</span>

    <span class="token keyword">def</span> <span class="token function">__cmd_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        连接服务器
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        登录服务器
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sock<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>send_cmd<span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sock<span class="token punctuation">)</span>
            <span class="token keyword">if</span> res<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;230&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Log in Successfully!&quot;</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">read_line</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sock<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        按行读取服务器返回数据
        :param sock: 套接字
        :return: data接收到的一行数据
        &quot;&quot;&quot;</span>
        data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> data<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_sep<span class="token punctuation">)</span><span class="token punctuation">:</span>
            d <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            data <span class="token operator">+=</span> d<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__parse_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmd_str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        从字符串中解析命令
        :param cmd_str: 命令字符串
        :return: 返回命令动词(大写)，命令参数
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token string">' '</span> <span class="token keyword">in</span> cmd_str<span class="token punctuation">:</span>
            cmd_lst <span class="token operator">=</span> cmd_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
            cmd <span class="token operator">=</span> cmd_lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            args <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>cmd_lst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cmd <span class="token operator">=</span> cmd_str
            args <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">return</span> cmd<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args

    <span class="token keyword">def</span> <span class="token function">send_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        发送命令
        :param cmd: 命令动词
        :param args: 命令参数
        :return: 返回命令发送成功与否
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sock<span class="token punctuation">:</span>
            <span class="token keyword">if</span> args<span class="token punctuation">:</span>
                cmd <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">)</span> <span class="token keyword">or</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter passive mode first&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please specify a file&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
                <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;File not exist&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
            cmd <span class="token operator">+=</span> self<span class="token punctuation">.</span>line_sep
            self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        循环执行用户输入的命令
        &quot;&quot;&quot;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Supported Commands: &quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cmds<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>__cmd_connect<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 连接</span>
        self<span class="token punctuation">.</span>__login<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 登陆</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            cmd_str <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Enter your commands: &quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> cmd_str<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FTP command can not be empty&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            cmd<span class="token punctuation">,</span> args <span class="token operator">=</span> self<span class="token punctuation">.</span>__parse_cmd<span class="token punctuation">(</span>cmd_str<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>send_cmd<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Fail to send your command: &quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sock<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;PASV&quot;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> res<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;227&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">True</span>
                server_info <span class="token operator">=</span> res<span class="token punctuation">[</span>res<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>res<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>pasv_host <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>server_info<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                server_info <span class="token operator">=</span> server_info<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>pasv_port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>server_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>server_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 下载文件</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>get_file<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_port<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 上传文件</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>put_data<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_port<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    ftp_client <span class="token operator">=</span> FTPClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ftp_client<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/others/python-socket.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/7/13 15:19:54</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.f7371fc1.js" defer></script><script src="/blog/assets/js/4.86db7451.js" defer></script><script src="/blog/assets/js/75.34c15c92.js" defer></script><script src="/blog/assets/js/13.4f481eb8.js" defer></script>
  </body>
</html>
