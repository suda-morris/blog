<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suda-morris ä¸ªäººåšå®¢</title>
    <meta name="description" content="è®°å½•å­¦ä¹ ç”Ÿæ´»ï¼Œæ¢ç´¢æœªçŸ¥é¢†åŸŸ">
    <link rel="icon" href="/blog/favicon.png">
  <link rel="manifest" href="/blog/manifest.json">
    
    <link rel="preload" href="/blog/assets/css/0.styles.aea52b3d.css" as="style"><link rel="preload" href="/blog/assets/js/app.49c648e5.js" as="script"><link rel="preload" href="/blog/assets/js/2.4a73e09d.js" as="script"><link rel="preload" href="/blog/assets/js/51.977931fc.js" as="script"><link rel="preload" href="/blog/assets/js/3.b11672f7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ed604406.js"><link rel="prefetch" href="/blog/assets/js/11.59c6397a.js"><link rel="prefetch" href="/blog/assets/js/12.c3dd4916.js"><link rel="prefetch" href="/blog/assets/js/13.2db54e59.js"><link rel="prefetch" href="/blog/assets/js/14.3034a496.js"><link rel="prefetch" href="/blog/assets/js/15.8c0968a2.js"><link rel="prefetch" href="/blog/assets/js/16.1e0835f9.js"><link rel="prefetch" href="/blog/assets/js/17.e6155edb.js"><link rel="prefetch" href="/blog/assets/js/18.e963076d.js"><link rel="prefetch" href="/blog/assets/js/19.cf63efdf.js"><link rel="prefetch" href="/blog/assets/js/20.21d43680.js"><link rel="prefetch" href="/blog/assets/js/21.2016bc02.js"><link rel="prefetch" href="/blog/assets/js/22.97a5e37d.js"><link rel="prefetch" href="/blog/assets/js/23.7786899f.js"><link rel="prefetch" href="/blog/assets/js/24.dc627132.js"><link rel="prefetch" href="/blog/assets/js/25.a101bc2b.js"><link rel="prefetch" href="/blog/assets/js/26.c79cd065.js"><link rel="prefetch" href="/blog/assets/js/27.738b981a.js"><link rel="prefetch" href="/blog/assets/js/28.9cce63f8.js"><link rel="prefetch" href="/blog/assets/js/29.6691870d.js"><link rel="prefetch" href="/blog/assets/js/30.eeee9971.js"><link rel="prefetch" href="/blog/assets/js/31.affaa2dc.js"><link rel="prefetch" href="/blog/assets/js/32.4f06c630.js"><link rel="prefetch" href="/blog/assets/js/33.ae3b46fc.js"><link rel="prefetch" href="/blog/assets/js/34.622d4045.js"><link rel="prefetch" href="/blog/assets/js/35.e3e4ac80.js"><link rel="prefetch" href="/blog/assets/js/36.ff8bbb99.js"><link rel="prefetch" href="/blog/assets/js/37.2affec3f.js"><link rel="prefetch" href="/blog/assets/js/38.32d080a5.js"><link rel="prefetch" href="/blog/assets/js/39.d4034502.js"><link rel="prefetch" href="/blog/assets/js/4.7131e971.js"><link rel="prefetch" href="/blog/assets/js/40.6bbbf9c3.js"><link rel="prefetch" href="/blog/assets/js/41.16e48cb6.js"><link rel="prefetch" href="/blog/assets/js/42.8266f98a.js"><link rel="prefetch" href="/blog/assets/js/43.34b029ca.js"><link rel="prefetch" href="/blog/assets/js/44.e8b99949.js"><link rel="prefetch" href="/blog/assets/js/45.478c6297.js"><link rel="prefetch" href="/blog/assets/js/46.80abc8be.js"><link rel="prefetch" href="/blog/assets/js/47.aa7bc7cc.js"><link rel="prefetch" href="/blog/assets/js/48.b462ae25.js"><link rel="prefetch" href="/blog/assets/js/49.158dc614.js"><link rel="prefetch" href="/blog/assets/js/5.2a354d3d.js"><link rel="prefetch" href="/blog/assets/js/50.1eb1aa33.js"><link rel="prefetch" href="/blog/assets/js/52.ef3bad39.js"><link rel="prefetch" href="/blog/assets/js/53.6befa3d2.js"><link rel="prefetch" href="/blog/assets/js/54.90f1cd79.js"><link rel="prefetch" href="/blog/assets/js/55.21d04997.js"><link rel="prefetch" href="/blog/assets/js/56.33c4b756.js"><link rel="prefetch" href="/blog/assets/js/57.38c26893.js"><link rel="prefetch" href="/blog/assets/js/58.bd545169.js"><link rel="prefetch" href="/blog/assets/js/59.e0a14351.js"><link rel="prefetch" href="/blog/assets/js/6.a0364a73.js"><link rel="prefetch" href="/blog/assets/js/60.7792cc6d.js"><link rel="prefetch" href="/blog/assets/js/61.d9ad6105.js"><link rel="prefetch" href="/blog/assets/js/62.de3a689a.js"><link rel="prefetch" href="/blog/assets/js/63.1e69131c.js"><link rel="prefetch" href="/blog/assets/js/64.7c78e369.js"><link rel="prefetch" href="/blog/assets/js/65.d95bf0ff.js"><link rel="prefetch" href="/blog/assets/js/66.a3e61d41.js"><link rel="prefetch" href="/blog/assets/js/67.991e91bd.js"><link rel="prefetch" href="/blog/assets/js/68.a94e7b95.js"><link rel="prefetch" href="/blog/assets/js/69.cd56f349.js"><link rel="prefetch" href="/blog/assets/js/7.05f8ac37.js"><link rel="prefetch" href="/blog/assets/js/8.ab17c590.js"><link rel="prefetch" href="/blog/assets/js/9.592902ce.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.aea52b3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris ä¸ªäººåšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/others/about.html" class="sidebar-link">å…³äºæœ¬æ ç›®</a></li><li><a href="/blog/others/markdown.html" class="sidebar-link">Markdown åŸºæœ¬è¯­æ³• ğŸ‰ ğŸ’¯</a></li></ul> </aside> <main class="page"> <div class="content default"><p>title: Python Socket
tags:</p> <ul><li>Socket
categories:</li> <li>Python
author: suda-morris
date: 2018-10-17 22:36:12 +0800</li></ul> <hr> <h1 id="pythonä¸­çš„socketç¼–ç¨‹"><a href="#pythonä¸­çš„socketç¼–ç¨‹" aria-hidden="true" class="header-anchor">#</a> Pythonä¸­çš„Socketç¼–ç¨‹</h1> <h2 id="pythonæ ‡å‡†åº“ä¸­çš„socketæ¨¡å—"><a href="#pythonæ ‡å‡†åº“ä¸­çš„socketæ¨¡å—" aria-hidden="true" class="header-anchor">#</a> Pythonæ ‡å‡†åº“ä¸­çš„socketæ¨¡å—</h2> <blockquote><p>socketå¯¹è±¡æ”¯æŒä½¿ç”¨TCPæˆ–è€…UDPåè®®è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œå¹¶æä¾›äº†socketç¼–ç¨‹æ‰€éœ€è¦çš„å¯¹è±¡ã€å‡½æ•°å’Œå¸¸é‡</p></blockquote> <h3 id="ç®€å•tcpæœåŠ¡å™¨å®ä¾‹"><a href="#ç®€å•tcpæœåŠ¡å™¨å®ä¾‹" aria-hidden="true" class="header-anchor">#</a> ç®€å•TCPæœåŠ¡å™¨å®ä¾‹</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æµå¼å¥—æ¥å­—</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç»‘å®šæœ¬åœ°åœ°å€å’Œç«¯å£å·</span>
    server_sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># ä½¿èƒ½ç›‘å¬</span>

    client_sock<span class="token punctuation">,</span> client_addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># é˜»å¡ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># æ¥æ”¶æ•°æ®</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># æ•°æ®è§£ç </span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Client[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>client_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot;--&gt; OK&quot;</span>
        client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯</span>

    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å…³é—­æœåŠ¡ç«¯å¥—æ¥å­—</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="ç®€å•tcpå®¢æˆ·ç«¯å®ä¾‹"><a href="#ç®€å•tcpå®¢æˆ·ç«¯å®ä¾‹" aria-hidden="true" class="header-anchor">#</a> ç®€å•TCPå®¢æˆ·ç«¯å®ä¾‹</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æµå¼å¥—æ¥å­—</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å‘æœåŠ¡å™¨å‘èµ·è¿æ¥</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server: {content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="ç®€å•udpæœåŠ¡å™¨å®ä¾‹"><a href="#ç®€å•udpæœåŠ¡å™¨å®ä¾‹" aria-hidden="true" class="header-anchor">#</a> ç®€å•UDPæœåŠ¡å™¨å®ä¾‹</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æ•°æ®æŠ¥å¥—æ¥å­—</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç»‘å®šIPåœ°å€å’Œç«¯å£å·</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> client_addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Client[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>client_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot; --&gt; OK&quot;</span>
        server_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client_addr_info<span class="token punctuation">)</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="ç®€å•udpå®¢æˆ·ç«¯å®ä¾‹"><a href="#ç®€å•udpå®¢æˆ·ç«¯å®ä¾‹" aria-hidden="true" class="header-anchor">#</a> ç®€å•UDPå®¢æˆ·ç«¯å®ä¾‹</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.103&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æ•°æ®æŠ¥å¥—æ¥å­—</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data<span class="token punctuation">,</span> server_addr_info <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>server_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="å°é¡¹ç›®-å¤‡ä»½æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„ç®€å•å®ç°-å¤šçº¿ç¨‹ç‰ˆ"><a href="#å°é¡¹ç›®-å¤‡ä»½æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„ç®€å•å®ç°-å¤šçº¿ç¨‹ç‰ˆ" aria-hidden="true" class="header-anchor">#</a> å°é¡¹ç›®---å¤‡ä»½æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„ç®€å•å®ç°(å¤šçº¿ç¨‹ç‰ˆ)</h2> <p><img src="https://s1.ax1x.com/2018/10/17/idOnEQ.png" alt="bak_server_protocol"></p> <h3 id="æœåŠ¡å™¨"><a href="#æœåŠ¡å™¨" aria-hidden="true" class="header-anchor">#</a> æœåŠ¡å™¨</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>

DEFAULT_BAK_PATH <span class="token operator">=</span> <span class="token string">r&quot;E:\MyBak&quot;</span>  <span class="token comment"># æœåŠ¡å™¨ç«¯é»˜è®¤å¤‡ä»½è·¯å¾„</span>

SERV_RUN_FLAG <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># æœåŠ¡å™¨è¿è¡Œæ ‡å¿—</span>
flag_lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¿è¡Œæ ‡å¿—çš„æŒ‡ä»¤é”</span>


<span class="token keyword">def</span> <span class="token function">get_file_infos</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ¥å—å®¢æˆ·ç«¯ä¼ æ¥çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯
    :param client:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :return:dataè¦å¤‡ä»½çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯ï¼Œcompressæ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># é•¿æ•´å½¢+å¸ƒå°”å‹</span>
    headsize <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
    data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>headsize<span class="token punctuation">)</span>  <span class="token comment"># æ¥å—æ–‡ä»¶ä¿¡æ¯åˆ—è¡¨çš„é•¿åº¦</span>
    infos_len<span class="token punctuation">,</span> compress <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span>  <span class="token comment"># unpackå­—èŠ‚æ•°æ®</span>
    data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>  <span class="token comment"># ä¿å­˜æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  <span class="token comment"># æ¯æ¬¡æœ€å¤šæ¥æ”¶1Kå­—èŠ‚</span>
        <span class="token keyword">if</span> infos_len <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            data <span class="token operator">+=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            infos_len <span class="token operator">-=</span> <span class="token number">1024</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            data <span class="token operator">+=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>infos_len<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨pickleååºåˆ—åŒ–</span>
    <span class="token keyword">return</span> data<span class="token punctuation">,</span> compress


<span class="token keyword">def</span> <span class="token function">mk_file_path</span><span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ ¹æ®æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„åˆ›å»ºæœåŠ¡å™¨ç«¯çš„è·¯å¾„
    :param filepath_rel: å®¢æˆ·ç«¯æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
    &quot;&quot;&quot;</span>
    paths <span class="token operator">=</span> filepath_rel<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># æŒ‰ç…§ç›®å½•çº§åˆ«åˆ‡åˆ†ï¼Œå»æ‰æœ€åä¸€é¡¹(æ–‡ä»¶å)</span>
    p <span class="token operator">=</span> DEFAULT_BAK_PATH
    <span class="token keyword">for</span> path <span class="token keyword">in</span> paths<span class="token punctuation">:</span>
        p <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>p<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment"># é€çº§åˆ›å»ºæ–‡ä»¶å¤¹</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_compress_size</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    è·å–å‹ç¼©æ–‡ä»¶çš„å¤§å°
    :param client: å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :return: sizeå‹ç¼©æ–‡ä»¶çš„å¤§å°
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q'</span>  <span class="token comment"># é•¿æ•´å‹</span>
    size <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
    data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    size <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> size


<span class="token keyword">def</span> <span class="token function">recv_file</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ¥æ”¶å¹¶ä¿å­˜å•ä¸ªæ–‡ä»¶
    :param client:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :param filepath_rel:æ–‡ä»¶çš„ç›¸å¯¹åœ°å€
    :param file_size:æ–‡ä»¶å¤§å°
    :param compress:æ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
    :return:è¿”å›æ¥æ”¶æˆåŠŸä¸å¦
    &quot;&quot;&quot;</span>
    res <span class="token operator">=</span> <span class="token boolean">True</span>
    mk_file_path<span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span>
    filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">)</span>  <span class="token comment"># æ–‡ä»¶åœ¨æœåŠ¡å™¨ç«¯çš„å®Œæ•´è·¯å¾„</span>
    <span class="token keyword">if</span> compress<span class="token punctuation">:</span>
        file_size <span class="token operator">=</span> get_compress_size<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
        filepath <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;.tar.gz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿®æ”¹æ–‡ä»¶æ‹“å±•å</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb+&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> file_size <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                file_size <span class="token operator">-=</span> <span class="token number">1024</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>file_size<span class="token punctuation">)</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res


<span class="token keyword">def</span> <span class="token function">send_echo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å‘é€å½“å‰æ–‡ä»¶çš„å¤‡ä»½ç»“æœç»™å®¢æˆ·ç«¯
    :param client: å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—
    :param result: å½“å‰æ–‡ä»¶å¤‡ä»½çš„ç»“æœ
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> result<span class="token punctuation">:</span>
        client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;success&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;failure&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">client_operate</span><span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹
    :param client_sock:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    &quot;&quot;&quot;</span>
    files_infos<span class="token punctuation">,</span> compress <span class="token operator">=</span> get_file_infos<span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span>  <span class="token comment"># è·å–å®¢æˆ·ç«¯ä¼ é€çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯ä»¥åŠæ˜¯å¦å‘é€å‹ç¼©æ–‡ä»¶</span>
    <span class="token keyword">for</span> file_size<span class="token punctuation">,</span> file_path_rel <span class="token keyword">in</span> files_infos<span class="token punctuation">:</span>  <span class="token comment"># é€ä¸ªæ¥æ”¶æ–‡ä»¶</span>
        res <span class="token operator">=</span> recv_file<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> file_path_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>
        send_echo<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—</span>


<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å¯åŠ¨æœåŠ¡åè¿è¡Œçš„çº¿ç¨‹å‡½æ•°
    :param host: æœåŠ¡å™¨IPåœ°å€
    :param port: æœåŠ¡å™¨ç«¯å£å·
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># åˆ¤æ–­æœ¬åœ°å¤‡ä»½æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span>
    server_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºæµå¤±å¥—æ¥å­—</span>
    server_sock<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># è®¾ç½®è¶…æ—¶æ—¶é—´1s</span>
    server_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç»‘å®šæœåŠ¡å™¨ç«¯çš„IPå’Œç«¯å£å·</span>
    server_sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># åŒä¸€æ—¶é—´åªå¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥</span>
    flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è®¿é—®SERV_RUN_FLAGä¹‹å‰éœ€è¦å…ˆè·å–æŒ‡ä»¤é”</span>
    <span class="token keyword">while</span> SERV_RUN_FLAG<span class="token punctuation">:</span>
        flag_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è®¿é—®å®Œæˆåç«‹é©¬é‡Šæ”¾æŒ‡ä»¤é”</span>
        client_sock <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            client_sock<span class="token punctuation">,</span> addr_info <span class="token operator">=</span> server_sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 1så†…æ²¡æœ‰å‘ç”Ÿå®¢æˆ·ç«¯è¿æ¥åŠ¨ä½œå°±ä¼šäº§ç”Ÿè¶…æ—¶å¼‚å¸¸</span>
        <span class="token keyword">except</span> socket<span class="token punctuation">.</span>timeout<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">if</span> client_sock<span class="token punctuation">:</span>  <span class="token comment"># ç¡®å®æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚</span>
            t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>client_operate<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å•ç‹¬å¼€çº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯çš„éœ€æ±‚</span>
            t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è®¿é—®SERV_RUN_FLAGä¹‹å‰éœ€è¦å…ˆè·å–æŒ‡ä»¤é”</span>
    server_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è‡ªå®šä¹‰Frame
        :param root: çˆ¶ç±»å®¹å™¨å¯¹è±¡
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ç½‘æ ¼å¸ƒå±€</span>
        self<span class="token punctuation">.</span>local_ip <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
        self<span class="token punctuation">.</span>local_ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10888</span><span class="token punctuation">,</span> <span class="token number">20888</span><span class="token punctuation">,</span> <span class="token number">30888</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        åˆå§‹åŒ–ç•Œé¢ç»„ä»¶
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;è¿œç¨‹å¤‡ä»½æœåŠ¡å™¨&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æ¨ªè·¨ä¸¤åˆ—</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡åœ°å€&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>__get_ip_address<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸‹æ‹‰åˆ—è¡¨</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># ä¸‹æ‹‰åˆ—è¡¨é»˜è®¤å€¼</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡ç«¯å£&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å¯åŠ¨æœåŠ¡&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;é€€å‡ºæœåŠ¡&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__get_ip_address</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è·å–æœåŠ¡å™¨ç«¯å¯ç”¨çš„IPåœ°å€
        :return: IPåœ°å€åˆ—è¡¨
        &quot;&quot;&quot;</span>
        hostname <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–ä¸»æœºå</span>
        info <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname_ex<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>  <span class="token comment"># æ ¹æ®ä¸»æœºåè·å–IPåœ°å€ä¿¡æ¯</span>
        info <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># ç¬¬3é¡¹æ‰æ˜¯ipåœ°å€åˆ—è¡¨</span>
        info<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># åŠ ä¸Šå›ç¯åœ°å€</span>
        <span class="token keyword">return</span> info

    <span class="token keyword">def</span> <span class="token function">__start_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€å¯åŠ¨æœåŠ¡ã€‘æŒ‰é”®å¤„ç†ç¨‹åº
        &quot;&quot;&quot;</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­è·å–ç”¨æˆ·è®¾ç½®çš„IPåœ°å€</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­è·å–ç”¨æˆ·è®¾ç½®çš„ç«¯å£å·</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å¼€å¯çº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>state<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># å¯åŠ¨æŒ‰é’®å˜æš—</span>

    <span class="token keyword">def</span> <span class="token function">__exit_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€é€€å‡ºæœåŠ¡ã€‘æŒ‰é”®å¤„ç†ç¨‹åº
        &quot;&quot;&quot;</span>
        <span class="token keyword">global</span> SERV_RUN_FLAG
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> flag_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                SERV_RUN_FLAG <span class="token operator">=</span> <span class="token boolean">False</span>
                flag_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># é€€å‡ºç•Œé¢</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;å¤‡ä»½æœåŠ¡å™¨&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br></div></div><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" aria-hidden="true" class="header-anchor">#</a> å®¢æˆ·ç«¯</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> tarfile
<span class="token keyword">import</span> tempfile
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token keyword">def</span> <span class="token function">send_file_infos</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> file_infos<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å‘é€æ–‡ä»¶ä¿¡æ¯
    :param client:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :param file_infos: æ–‡ä»¶ä¿¡æ¯ï¼Œåˆ—è¡¨
    :param compress: æ˜¯å¦éœ€è¦å‹ç¼©
    &quot;&quot;&quot;</span>
    fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># é•¿æ•´å‹+å¸ƒå°”ç±»å‹</span>
    infos_bytes <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>file_infos<span class="token punctuation">)</span>  <span class="token comment"># å¯¹file_infosåºåˆ—åŒ–æ“ä½œ</span>
    infos_bytes_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>infos_bytes<span class="token punctuation">)</span>
    infos_bytes_len_pack <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> infos_bytes_len<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># ç”¨structæ¨¡å—å¯¹é•¿åº¦å€¼è¿›è¡ŒäºŒè¿›åˆ¶ç¼–ç </span>
    client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos_bytes_len_pack<span class="token punctuation">)</span>  <span class="token comment"># å…ˆå‘é€é•¿åº¦</span>
    client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos_bytes<span class="token punctuation">)</span>  <span class="token comment"># å†å‘é€å†…å®¹</span>


<span class="token keyword">def</span> <span class="token function">send_file</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å‘é€å•ä¸ªæ–‡ä»¶è‡³æœåŠ¡å™¨
    :param client:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :param file:#è¦å‘é€æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
    :param compress:æ˜¯å¦éœ€è¦å‹ç¼©
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> compress<span class="token punctuation">:</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># äºŒè¿›åˆ¶åªè¯»æ–¹å¼è¯»å–æ–‡ä»¶</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºä¸´æ—¶æ–‡ä»¶</span>
        tar <span class="token operator">=</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">&quot;w:gz&quot;</span><span class="token punctuation">,</span> fileobj<span class="token operator">=</span>f<span class="token punctuation">)</span>  <span class="token comment"># gzip å‹ç¼©</span>
        tar<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        tar<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># è°ƒæ•´æ–‡ä»¶æŒ‡é’ˆä½ç½®</span>
        file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>stat<span class="token punctuation">(</span>f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>st_size  <span class="token comment"># è®¡ç®—å‹ç¼©æ–‡ä»¶çš„å¤§å°</span>
        file_size_pack <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'Q'</span><span class="token punctuation">,</span> file_size<span class="token punctuation">)</span>  <span class="token comment"># å‹ç¼©æ–‡ä»¶å¤§å°äºŒè¿›åˆ¶ç¼–ç </span>
        client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>file_size_pack<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># æ¯æ¬¡å‘é€1Kå­—èŠ‚ï¼Œç›´åˆ°å‘é€ç»“æŸ</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                client<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># å‘é€åŸæ–‡ä»¶æˆ–è€…æ—¶å‹ç¼©æ–‡ä»¶</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_bak_info</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    ä»æœåŠ¡å™¨è·å–å½“å‰å¤‡ä»½ç»“æœä¿¡æ¯
    :param client:å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
    :param size:è¿”å›ç»“æœä¿¡æ¯[success,failure]çš„å­—èŠ‚æ•°
    &quot;&quot;&quot;</span>
    msg <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_file_infos_paths</span><span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    è·å–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯å’Œæ–‡ä»¶è·¯å¾„
    :param root_path:æ–‡ä»¶å¤¹æ ¹ç›®å½•
    :return:infosæ–‡ä»¶ä¿¡æ¯åˆ—è¡¨ï¼Œå…ƒç´ æ˜¯å…ƒç¥–(æ–‡ä»¶å¤§å°ï¼Œæ–‡ä»¶ç›¸å¯¹è·¯å¾„)ï¼Œpathsæ–‡ä»¶ç»å¯¹è·¯å¾„
    &quot;&quot;&quot;</span>
    infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> root_path <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token keyword">for</span> dirpath<span class="token punctuation">,</span> dirnames<span class="token punctuation">,</span> filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># é€’å½’éå†æ ¹ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶</span>
        <span class="token comment"># dirpathæ ¹ç›®å½•ï¼Œdirnamesæ–‡ä»¶å¤¹åï¼Œfilenamesæ–‡ä»¶å</span>
        <span class="token keyword">for</span> file_name <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
            file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dirpath<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>  <span class="token comment"># è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span>
            paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
            file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>stat<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span>st_size  <span class="token comment"># è·å–æ–‡ä»¶å¤§å°</span>
            file_path_rel <span class="token operator">=</span> file_path<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>root_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># è·å–æ–‡ä»¶ç›¸å¯¹è·¯å¾„</span>
            infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>file_size<span class="token punctuation">,</span> file_path_rel<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> infos<span class="token punctuation">,</span> paths


<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> root_path<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å¼€å§‹å¤‡ä»½å·¥ä½œçš„çº¿ç¨‹å‡½æ•°
    :param host:æœåŠ¡å™¨IPåœ°å€
    :param port:æœåŠ¡å™¨ç«¯å£å·
    :param root_path:å¤‡ä»½è·¯å¾„æ ¹ç›®å½•
    :param compress:æ˜¯å¦éœ€è¦å‹ç¼©æ–‡ä»¶
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">u&quot;å¤‡ä»½çš„è·¯å¾„ä¸å­˜åœ¨!&quot;</span><span class="token punctuation">,</span> root_path<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># å»ºç«‹æµå¼å¥—æ¥å­—</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># è¿æ¥æœåŠ¡å™¨</span>
    file_infos<span class="token punctuation">,</span> file_paths <span class="token operator">=</span> get_file_infos_paths<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>  <span class="token comment"># è·å–æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶ä¿¡æ¯ä¸æ–‡ä»¶è·¯å¾„</span>
    send_file_infos<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> file_infos<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># å‘é€éœ€è¦å¤‡ä»½çš„æ–‡ä»¶ä¿¡æ¯</span>
    <span class="token keyword">for</span> fp <span class="token keyword">in</span> file_paths<span class="token punctuation">:</span>
        send_file<span class="token punctuation">(</span>client_sock<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># ä¾æ¬¡å‘é€æ‰€æœ‰æ–‡ä»¶</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°å½“å‰æ­£åœ¨å¤‡ä»½çš„æ–‡ä»¶</span>
        get_bak_info<span class="token punctuation">(</span>client_sock<span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°æ–‡ä»¶å¤‡ä»½ç»“æœ</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è‡ªå®šä¹‰Frame
        :param root: çˆ¶ç±»å®¹å™¨å¯¹è±¡
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root  <span class="token comment"># ä¿å­˜çˆ¶ç±»å®¹å™¨æ§ä»¶</span>
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æ•´ä½“ä½¿ç”¨ç½‘æ ¼å¸ƒå±€</span>
        self<span class="token punctuation">.</span>remote_ip_default <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>  <span class="token comment"># é»˜è®¤è¿æ¥çš„æœåŠ¡å™¨IPåœ°å€</span>
        self<span class="token punctuation">.</span>remote_port_default <span class="token operator">=</span> <span class="token number">10888</span>  <span class="token comment"># é»˜è®¤è¿æ¥çš„æœåŠ¡å™¨ç«¯å£å·</span>
        self<span class="token punctuation">.</span>remote_ip_var <span class="token operator">=</span> StringVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æœåŠ¡å™¨IPåœ°å€</span>
        self<span class="token punctuation">.</span>remote_port_var <span class="token operator">=</span> IntVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æœåŠ¡å™¨ç«¯å£å·</span>
        self<span class="token punctuation">.</span>bak_src_var <span class="token operator">=</span> StringVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æœ¬åœ°å¤‡ä»½è·¯å¾„</span>
        self<span class="token punctuation">.</span>compress_var <span class="token operator">=</span> BooleanVar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿å­˜ç”¨æˆ·æ˜¯å¦éœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©å¤„ç†</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># åˆå§‹åŒ–ç•Œé¢ä¸Šçš„æ‰€æœ‰ç»„ä»¶</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        åˆå§‹åŒ–ç•Œé¢ç»„ä»¶
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;è¿œç¨‹å¤‡ä»½å®¢æˆ·ç«¯&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æ¨ªè·¨ä¸¤åˆ—</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡å™¨åœ°å€ï¼š&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">)</span>  <span class="token comment"># è¾“å…¥æ¡†</span>
        self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>remote_ip_default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡å™¨ç«¯å£ï¼š&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>remote_port_default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        bak_src_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å¤‡ä»½çš„ç›®æ ‡ï¼š&quot;</span><span class="token punctuation">)</span>
        bak_src_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src <span class="token operator">=</span> Entry<span class="token punctuation">(</span>self<span class="token punctuation">,</span> textvariable<span class="token operator">=</span>self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        compress_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å‹ç¼©å¤‡ä»½ï¼š&quot;</span><span class="token punctuation">)</span>
        compress_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>compress_on <span class="token operator">=</span> Checkbutton<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å¼€å¯å‹ç¼©&quot;</span><span class="token punctuation">,</span> variable<span class="token operator">=</span>self<span class="token punctuation">.</span>compress_var<span class="token punctuation">,</span> onvalue<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> offvalue<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># å•é€‰æ¡†</span>
        self<span class="token punctuation">.</span>compress_on<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å¼€å§‹å¤‡ä»½&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_bak<span class="token punctuation">)</span>  <span class="token comment"># æŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;é€€å‡ºç¨‹åº&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_bak<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__start_bak</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€å¼€å§‹å¤‡ä»½ã€‘äº‹ä»¶å¤„ç†
        &quot;&quot;&quot;</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>remote_ip_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>remote_port_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        bak_path <span class="token operator">=</span> self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        compress <span class="token operator">=</span> self<span class="token punctuation">.</span>compress_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bak_src_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># æ¸…ç©ºå¤‡ä»½è·¯å¾„è¾“å…¥æ¡†</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> bak_path<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºå­çº¿ç¨‹</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit_bak</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€é€€å‡ºç¨‹åºã€‘äº‹ä»¶å¤„ç†
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># é€€å‡ºç•Œé¢</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;å¤‡ä»½å®¢æˆ·ç«¯&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># å¤§å°ä¸å…è®¸ä¼¸ç¼©</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><h2 id="socketserveræ¡†æ¶"><a href="#socketserveræ¡†æ¶" aria-hidden="true" class="header-anchor">#</a> SocketServeræ¡†æ¶</h2> <blockquote><p>Pythonæä¾›äº†SocketServeræ¡†æ¶ç”¨æ¥ç¼–å†™ç½‘ç»œæœåŠ¡å™¨ï¼Œå®ƒé¢„å®šä¹‰äº†ä¸€ä¸ªåŸºæœ¬çš„æœåŠ¡å™¨æ¡†æ¶</p> <p>æ­¥éª¤ï¼š</p> <ol><li>å»ºç«‹å®¢æˆ·ç«¯å¤„ç†ç±»</li> <li>åˆå§‹åŒ–æœåŠ¡å™¨ç±»ï¼Œä¼ å…¥ç›¸å…³å‚æ•°</li> <li>å¯åŠ¨æœåŠ¡å™¨</li></ol></blockquote> <h3 id="socketserveræ¡†æ¶ä¸‹çš„tcpæœåŠ¡å™¨"><a href="#socketserveræ¡†æ¶ä¸‹çš„tcpæœåŠ¡å™¨" aria-hidden="true" class="header-anchor">#</a> SocketServeræ¡†æ¶ä¸‹çš„TCPæœåŠ¡å™¨</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading

HOST <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
PORT <span class="token operator">=</span> <span class="token number">3629</span>


<span class="token keyword">def</span> <span class="token function">shut_server_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> server<span class="token punctuation">:</span>
        server<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æŒ‰è¡Œè¯»å–æ•°æ®(éœ€è¦æ•°æ®ä¸­åŒ…å«æ¢è¡Œç¬¦)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive From Client: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>shut_server_down<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æœåŠ¡å™¨çš„shutdownæ–¹æ³•éœ€è¦åœ¨åˆ«çš„çº¿ç¨‹ä¸­è°ƒç”¨</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> MyHandler<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºTCPæœåŠ¡å™¨</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¿è¡ŒæœåŠ¡å™¨</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="é…å¥—çš„tcpå®¢æˆ·ç«¯"><a href="#é…å¥—çš„tcpå®¢æˆ·ç«¯" aria-hidden="true" class="header-anchor">#</a> é…å¥—çš„TCPå®¢æˆ·ç«¯</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æµå¼å¥—æ¥å­—</span>
    client_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å‘æœåŠ¡å™¨å‘èµ·è¿æ¥</span>
    data <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        data <span class="token operator">+=</span> <span class="token string">'\n'</span>
        client_sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server: {content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="socketserveræ¡†æ¶ä¸‹çš„udpæœåŠ¡å™¨"><a href="#socketserveræ¡†æ¶ä¸‹çš„udpæœåŠ¡å™¨" aria-hidden="true" class="header-anchor">#</a> SocketServeræ¡†æ¶ä¸‹çš„UDPæœåŠ¡å™¨</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading

HOST <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
PORT <span class="token operator">=</span> <span class="token number">3629</span>


<span class="token keyword">def</span> <span class="token function">shut_server_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> server<span class="token punctuation">:</span>
        server<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>DatagramRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> client_sock <span class="token operator">=</span> self<span class="token punctuation">.</span>request
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>shut_server_down<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive From Client: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">&quot;---&gt;OK&quot;</span>
        client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>UDPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> MyHandler<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="é…å¥—çš„udpå®¢æˆ·ç«¯"><a href="#é…å¥—çš„udpå®¢æˆ·ç«¯" aria-hidden="true" class="header-anchor">#</a> é…å¥—çš„UDPå®¢æˆ·ç«¯</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> socket

server_host <span class="token operator">=</span> <span class="token string">&quot;192.168.1.104&quot;</span>
server_port <span class="token operator">=</span> <span class="token number">3629</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    client_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>  <span class="token comment"># æœ¬å¥—æ¥å­—æ˜¯å»ºç«‹åœ¨IPv4åŸºç¡€ä¸Šçš„æ•°æ®æŠ¥å¥—æ¥å­—</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Please Enter a Message to Send: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            client_sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>server_host<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>
            <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># é˜²æ­¢æ¥æ”¶åˆ°ç©ºæ•°æ®</span>
                data<span class="token punctuation">,</span> server_addr_info <span class="token operator">=</span> client_sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Receive from Server[{addr_info}]:{content}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>addr_info<span class="token operator">=</span>server_addr_info<span class="token punctuation">,</span> content<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    client_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="ä½¿ç”¨socketserveræ¡†æ¶æ”¹å†™å¤‡ä»½æœåŠ¡å™¨ç¨‹åº"><a href="#ä½¿ç”¨socketserveræ¡†æ¶æ”¹å†™å¤‡ä»½æœåŠ¡å™¨ç¨‹åº" aria-hidden="true" class="header-anchor">#</a> ä½¿ç”¨SocketServeræ¡†æ¶æ”¹å†™å¤‡ä»½æœåŠ¡å™¨ç¨‹åº</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tkinter<span class="token punctuation">.</span>ttk <span class="token keyword">import</span> <span class="token operator">*</span>

DEFAULT_BAK_PATH <span class="token operator">=</span> <span class="token string">r&quot;E:\MyBak&quot;</span>  <span class="token comment"># æœåŠ¡å™¨ç«¯é»˜è®¤å¤‡ä»½è·¯å¾„</span>


<span class="token keyword">def</span> <span class="token function">mk_file_path</span><span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ ¹æ®æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„åˆ›å»ºæœåŠ¡å™¨ç«¯çš„è·¯å¾„
    :param filepath_rel: å®¢æˆ·ç«¯æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
    &quot;&quot;&quot;</span>
    paths <span class="token operator">=</span> filepath_rel<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># æŒ‰ç…§ç›®å½•çº§åˆ«åˆ‡åˆ†ï¼Œå»æ‰æœ€åä¸€é¡¹(æ–‡ä»¶å)</span>
    p <span class="token operator">=</span> DEFAULT_BAK_PATH
    <span class="token keyword">for</span> path <span class="token keyword">in</span> paths<span class="token punctuation">:</span>
        p <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>p<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment"># é€çº§åˆ›å»ºæ–‡ä»¶å¤¹</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">BakHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__client_operate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__client_operate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹
        &quot;&quot;&quot;</span>
        files_infos<span class="token punctuation">,</span> compress <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_file_infos<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å®¢æˆ·ç«¯ä¼ é€çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯ä»¥åŠæ˜¯å¦å‘é€å‹ç¼©æ–‡ä»¶</span>
        <span class="token keyword">for</span> file_size<span class="token punctuation">,</span> file_path_rel <span class="token keyword">in</span> files_infos<span class="token punctuation">:</span>  <span class="token comment"># é€ä¸ªæ¥æ”¶æ–‡ä»¶</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>__recv_file<span class="token punctuation">(</span>file_path_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span>  <span class="token comment"># requestå°±æ˜¯å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—</span>
            self<span class="token punctuation">.</span>__send_echo<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—</span>

    <span class="token keyword">def</span> <span class="token function">__get_file_infos</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        æ¥å—å®¢æˆ·ç«¯ä¼ æ¥çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯
        :return:dataè¦å¤‡ä»½çš„æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯ï¼Œcompressæ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
        &quot;&quot;&quot;</span>
        fmt_str <span class="token operator">=</span> <span class="token string">'Q?'</span>  <span class="token comment"># é•¿æ•´å½¢+å¸ƒå°”å‹</span>
        headsize <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>headsize<span class="token punctuation">)</span>  <span class="token comment"># æ¥å—æ–‡ä»¶ä¿¡æ¯åˆ—è¡¨çš„é•¿åº¦</span>
        infos_len<span class="token punctuation">,</span> compress <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span>  <span class="token comment"># unpackå­—èŠ‚æ•°æ®</span>
        data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>  <span class="token comment"># ä¿å­˜æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  <span class="token comment"># æ¯æ¬¡æœ€å¤šæ¥æ”¶1Kå­—èŠ‚</span>
            <span class="token keyword">if</span> infos_len <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                data <span class="token operator">+=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                infos_len <span class="token operator">-=</span> <span class="token number">1024</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">+=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>infos_len<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨pickleååºåˆ—åŒ–</span>
        <span class="token keyword">return</span> data<span class="token punctuation">,</span> compress

    <span class="token keyword">def</span> <span class="token function">__send_echo</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å‘é€å½“å‰æ–‡ä»¶çš„å¤‡ä»½ç»“æœç»™å®¢æˆ·ç«¯
        :param result: å½“å‰æ–‡ä»¶å¤‡ä»½çš„ç»“æœ
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> result<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;success&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b&quot;failure&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__recv_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        æ¥æ”¶å¹¶ä¿å­˜å•ä¸ªæ–‡ä»¶
        :param filepath_rel:æ–‡ä»¶çš„ç›¸å¯¹åœ°å€
        :param file_size:æ–‡ä»¶å¤§å°
        :param compress:æ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
        :return:è¿”å›æ¥æ”¶æˆåŠŸä¸å¦
        &quot;&quot;&quot;</span>
        res <span class="token operator">=</span> <span class="token boolean">True</span>
        mk_file_path<span class="token punctuation">(</span>filepath_rel<span class="token punctuation">)</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">,</span> filepath_rel<span class="token punctuation">)</span>  <span class="token comment"># æ–‡ä»¶åœ¨æœåŠ¡å™¨ç«¯çš„å®Œæ•´è·¯å¾„</span>
        <span class="token keyword">if</span> compress<span class="token punctuation">:</span>
            file_size <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_compress_size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            filepath <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;.tar.gz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># ä¿®æ”¹æ–‡ä»¶æ‹“å±•å</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb+&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> file_size <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    file_size <span class="token operator">-=</span> <span class="token number">1024</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>file_size<span class="token punctuation">)</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            res <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> res

    <span class="token keyword">def</span> <span class="token function">__get_compress_size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è·å–å‹ç¼©æ–‡ä»¶çš„å¤§å°
        :return: sizeå‹ç¼©æ–‡ä»¶çš„å¤§å°
        &quot;&quot;&quot;</span>
        fmt_str <span class="token operator">=</span> <span class="token string">'Q'</span>  <span class="token comment"># é•¿æ•´å‹</span>
        size <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>fmt_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        size <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt_str<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> size


<span class="token keyword">class</span> <span class="token class-name">MyFrame</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è‡ªå®šä¹‰Frame
        :param root: çˆ¶ç±»å®¹å™¨å¯¹è±¡(æ ¹çª—å£)
        &quot;&quot;&quot;</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> root
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ç½‘æ ¼å¸ƒå±€</span>
        self<span class="token punctuation">.</span>local_ip <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
        self<span class="token punctuation">.</span>local_ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10888</span><span class="token punctuation">,</span> <span class="token number">20888</span><span class="token punctuation">,</span> <span class="token number">30888</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>__init_components<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init_components</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        åˆå§‹åŒ–ç•Œé¢ç»„ä»¶
        &quot;&quot;&quot;</span>
        proj_name <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;è¿œç¨‹å¤‡ä»½æœåŠ¡å™¨&quot;</span><span class="token punctuation">)</span>
        proj_name<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>columnspan<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æ¨ªè·¨ä¸¤åˆ—</span>

        serv_ip_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡åœ°å€&quot;</span><span class="token punctuation">)</span>
        serv_ip_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_ip <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>__get_ip_address<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸‹æ‹‰åˆ—è¡¨</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># ä¸‹æ‹‰åˆ—è¡¨é»˜è®¤å€¼</span>
        self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        serv_port_label <span class="token operator">=</span> Label<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;æœåŠ¡ç«¯å£&quot;</span><span class="token punctuation">)</span>
        serv_port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port <span class="token operator">=</span> Combobox<span class="token punctuation">(</span>self<span class="token punctuation">,</span> values<span class="token operator">=</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>start_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;å¯åŠ¨æœåŠ¡&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__start_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>exit_serv_btn <span class="token operator">=</span> Button<span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">u&quot;é€€å‡ºæœåŠ¡&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>__exit_serv<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exit_serv_btn<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__get_ip_address</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è·å–æœåŠ¡å™¨ç«¯å¯ç”¨çš„IPåœ°å€
        :return: IPåœ°å€åˆ—è¡¨
        &quot;&quot;&quot;</span>
        hostname <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–ä¸»æœºå</span>
        info <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname_ex<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>  <span class="token comment"># æ ¹æ®ä¸»æœºåè·å–IPåœ°å€ä¿¡æ¯</span>
        info <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># ç¬¬3é¡¹æ‰æ˜¯ipåœ°å€åˆ—è¡¨</span>
        info<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>local_ip<span class="token punctuation">)</span>  <span class="token comment"># åŠ ä¸Šå›ç¯åœ°å€</span>
        <span class="token keyword">return</span> info

    <span class="token keyword">def</span> <span class="token function">__start_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€å¯åŠ¨æœåŠ¡ã€‘æŒ‰é”®å¤„ç†ç¨‹åº
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># åˆ¤æ–­æœ¬åœ°å¤‡ä»½æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>DEFAULT_BAK_PATH<span class="token punctuation">)</span>
        host <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_ip<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­è·å–ç”¨æˆ·è®¾ç½®çš„IPåœ°å€</span>
        port <span class="token operator">=</span> self<span class="token punctuation">.</span>serv_port<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­è·å–ç”¨æˆ·è®¾ç½®çš„ç«¯å£å·</span>
        self<span class="token punctuation">.</span>start_serv_btn<span class="token punctuation">.</span>state<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># å¯åŠ¨æŒ‰é’®å˜æš—</span>
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BakHandler<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºå¤šçº¿ç¨‹TCPæœåŠ¡å™¨</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># åœ¨æ–°çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨</span>

    <span class="token keyword">def</span> <span class="token function">__exit_serv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ã€é€€å‡ºæœåŠ¡ã€‘æŒ‰é”®å¤„ç†ç¨‹åº
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>server<span class="token punctuation">:</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># é€€å‡ºç•Œé¢</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æ ¹çª—å£</span>
    root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">u&quot;å¤‡ä»½æœåŠ¡å™¨&quot;</span><span class="token punctuation">)</span>
    root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> MyFrame<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br></div></div><h2 id="é¡¹ç›®ï¼šç®€å•ftpæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„å®ç°"><a href="#é¡¹ç›®ï¼šç®€å•ftpæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„å®ç°" aria-hidden="true" class="header-anchor">#</a> é¡¹ç›®ï¼šç®€å•FTPæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„å®ç°</h2> <h3 id="ftpæœåŠ¡å™¨çš„å®ç°"><a href="#ftpæœåŠ¡å™¨çš„å®ç°" aria-hidden="true" class="header-anchor">#</a> FTPæœåŠ¡å™¨çš„å®ç°</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">add_opr_file</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å‘FTPDataHandlerç±»çš„æ“ä½œåˆ—è¡¨ä¸­æ·»åŠ æ–°æ“ä½œ
    å‘½ä»¤é€šé“å’Œæ•°æ®é€šé“ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡FTPDataHandlerç±»ä¸­çš„client_operå­—å…¸è”ç³»åœ¨ä¸€èµ·çš„
    :param client_addr: å®¢æˆ·ç«¯çš„ipåœ°å€
    :param item: æ–°æ“ä½œ
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> client_addr <span class="token keyword">in</span> FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">:</span>
        FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>client_addr<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        FTPDataHandler<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>client_addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">,</span> <span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">FTPHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> client_addr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> server<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        FTPæœåŠ¡å™¨çš„å¤„ç†ç±»
        :param request: è¯·æ±‚å¯¹è±¡ï¼Œå³è¿æ¥çš„å®¢æˆ·ç«¯socket
        :param client_addr: å®¢æˆ·ç«¯åœ°å€
        :param server: ä¸è‡ªå·±ç»‘å®šçš„æœåŠ¡å™¨å¯¹è±¡(å³åé¢çš„MyThreadFTPServerå¯¹è±¡)
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>cmd_keys <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NOOP&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TYPE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PASV&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PORT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># FTPæœåŠ¡å™¨æ”¯æŒçš„å‘½ä»¤</span>
        self<span class="token punctuation">.</span>coms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># å­—å…¸ï¼Œ{å‘½ä»¤:æ‰§è¡Œæ–¹æ³•}</span>
        self<span class="token punctuation">.</span>__init_coms<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># åˆå§‹åŒ–å­—å…¸coms</span>
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> server  <span class="token comment"># ä¸æœåŠ¡ç±»ç»‘å®šçš„æœåŠ¡å™¨çš„å¼•ç”¨</span>
        self<span class="token punctuation">.</span>cmd_port <span class="token operator">=</span> <span class="token number">21</span>  <span class="token comment"># å‘½ä»¤ç«¯å£å·</span>
        self<span class="token punctuation">.</span>data_port <span class="token operator">=</span> <span class="token number">20</span>  <span class="token comment"># æ•°æ®ç«¯å£å·</span>
        self<span class="token punctuation">.</span>pasv_data_ip <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># è¢«åŠ¨æ¨¡å¼ä¸‹ï¼Œæ•°æ®æ¨¡å—çº¿ç¨‹æœåŠ¡å™¨çš„IPåœ°å€</span>
        self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># è¢«åŠ¨æ¨¡å¼ä¸‹ï¼Œæ•°æ®æ¨¡å—çº¿ç¨‹æœåŠ¡å™¨çš„ç«¯å£å·</span>
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># æŸæ¡å‘½ä»¤å¯¹åº”çš„å‚æ•°</span>
        self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># ç”¨æˆ·æ˜¯å¦ç™»é™†</span>
        self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># å½“å‰æœåŠ¡å™¨æ˜¯å¦å·¥ä½œåœ¨è¢«åŠ¨æ¨¡å¼</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>request<span class="token punctuation">,</span> client_addr<span class="token punctuation">,</span> server<span class="token punctuation">)</span>  <span class="token comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span>

    <span class="token keyword">def</span> <span class="token function">__init_coms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        åˆå§‹åŒ–å­—å…¸comsï¼Œé”®ä¸ºå‘½ä»¤åå­—ï¼Œå€¼ä¸ºå…·ä½“çš„æ–¹æ³•
        &quot;&quot;&quot;</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmd_keys<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>coms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;exe_&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–exe_å¼€å¤´çš„æˆå‘˜æ–¹æ³•</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        é‡å†™çˆ¶ç±»çš„å¤„ç†å‡½æ•°
        &quot;&quot;&quot;</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            cmds <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¯»å–ä¸€è¡Œç”¨æˆ·å‘æ¥çš„å‘½ä»¤</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> cmds<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            cmds <span class="token operator">=</span> cmds<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># è§£ç </span>
            cmd <span class="token operator">=</span> self<span class="token punctuation">.</span>__parse_cmd<span class="token punctuation">(</span>cmds<span class="token punctuation">)</span>  <span class="token comment"># è§£æå‘½ä»¤</span>
            <span class="token keyword">if</span> cmd <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmd_keys<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>coms<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰§è¡Œå‘½ä»¤å¯¹åº”çš„æ–¹æ³•</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Invalid command.&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd <span class="token operator">==</span> <span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>

    <span class="token keyword">def</span> <span class="token function">__parse_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ä»å­—ç¬¦ä¸²ä¸­æå–å‘½ä»¤åŠ¨è¯å’Œå‚æ•°
        :param cmds:åŒ…å«å‘½ä»¤ã€å‚æ•°çš„å­—ç¬¦ä¸²
        :return:å‘½ä»¤åŠ¨è¯ï¼Œå¤§å†™
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token string">' '</span> <span class="token keyword">in</span> cmds<span class="token punctuation">:</span>  <span class="token comment"># æ ¹æ®ç©ºæ ¼æ¥åˆ¤æ–­æ˜¯å¦åŒ…å«å‘½ä»¤å‚æ•°</span>
            cmd<span class="token punctuation">,</span> args <span class="token operator">=</span> cmds<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>  <span class="token comment"># åˆ‡åˆ†å‘½ä»¤åŠ¨è¯ä¸å‘½ä»¤å‚æ•°</span>
            self<span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># æ¸…é™¤æ¢è¡Œç¬¦ä¸ç©ºæ ¼</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cmd <span class="token operator">=</span> cmds<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cmd<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å‘å®¢æˆ·ç«¯è¿”å›å‘½ä»¤æ‰§è¡ŒçŠ¶æ€
        :param code:çŠ¶æ€ç 
        :param info:çŠ¶æ€ä¿¡æ¯
        &quot;&quot;&quot;</span>
        infos <span class="token operator">=</span> <span class="token string">&quot;%d %s\n&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>infos<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__make_pasv_info</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è¿”å›è¿›å…¥ä¸»åŠ¨æ¨¡å¼çš„ä¿¡æ¯
        :return: è¿”å›ç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸»åŠ¨æ¨¡å¼æ•°æ®é€šé“çš„IPåœ°å€å’Œç«¯å£å·ï¼ŒæŒ‰ç…§FTPåè®®çš„æ ¼å¼è¦æ±‚å‘é€
        &quot;&quot;&quot;</span>
        ip_info <span class="token operator">=</span> self<span class="token punctuation">.</span>pasv_data_ip<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>  <span class="token comment"># IPåœ°å€ä¹‹é—´çš„.å·ä½¿ç”¨,å·æ¥æ›¿ä»£</span>
        ip_info <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ip_info<span class="token punctuation">)</span>
        porta_info <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">//</span> <span class="token number">256</span><span class="token punctuation">)</span>
        portb_info <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>ip_info<span class="token punctuation">,</span> porta_info<span class="token punctuation">,</span> portb_info<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter_pasv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è¿›å…¥è¢«åŠ¨æ¨¡å¼ï¼Œå¼€å¯æ•°æ®æœåŠ¡å™¨
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>data_server<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pasv_data_ip<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_data_port <span class="token operator">=</span> self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>create_data_server<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_quit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        QUITå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">221</span><span class="token punctuation">,</span> <span class="token string">&quot;bye.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_user</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        USERå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        user <span class="token operator">=</span> self<span class="token punctuation">.</span>args  <span class="token comment"># è·å–ç™»é™†çš„ç”¨æˆ·å</span>
        <span class="token keyword">if</span> user <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">True</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">230</span><span class="token punctuation">,</span> <span class="token string">&quot;identified!&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">530</span><span class="token punctuation">,</span> <span class="token string">&quot;Only use anonymous.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_noop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        NOOPå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        TYPEå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_pasv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        PASVå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>loged<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">332</span><span class="token punctuation">,</span> <span class="token string">&quot;Please login.&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>  <span class="token comment"># å·²ç»passiveæ¨¡å¼äº†</span>
            info <span class="token operator">=</span> <span class="token string">&quot;entering passive mode (%s)&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__make_pasv_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">227</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__enter_pasv<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¿›å…¥passiveæ¨¡å¼</span>
            info <span class="token operator">=</span> <span class="token string">&quot;entering passive mode (%s)&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__make_pasv_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">True</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">227</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>  <span class="token comment"># è¿›å…¥passiveæ¨¡å¼å¤±è´¥</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">False</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Fail to enter passvie mode.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_port</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        PORTå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;Do not support port mode.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_retr</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        RETRå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ç¡®ä¿è¦ä¸‹è½½çš„æ–‡ä»¶æ˜¯å­˜åœ¨çš„</span>
            self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">550</span><span class="token punctuation">,</span> <span class="token string">&quot;File {file_path} not exist!&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>file_path<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># è·å–å®¢æˆ·ç«¯çš„IPåœ°å€</span>
        add_opr_file<span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å‘æ•°æ®é€šé“ä¸­æ·»åŠ æ–°çš„ä»»åŠ¡</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">exe_stor</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        STORå‘½ä»¤çš„æ‰§è¡ŒåŠ¨ä½œ
        &quot;&quot;&quot;</span>
        client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        add_opr_file<span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å‘æ•°æ®é€šé“ä¸­æ·»åŠ æ–°çš„ä»»åŠ¡</span>
        self<span class="token punctuation">.</span>__send<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">FTPDataHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>StreamRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    client_oper <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># å­—å…¸ï¼Œé”®ä¸ºå®¢æˆ·ç«¯IPåœ°å€ï¼Œå€¼ä¸ºåˆ—è¡¨ï¼Œå­˜æ”¾å…·ä½“çš„æ“ä½œ</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        æ•°æ®æœåŠ¡å™¨é’ˆå¯¹æ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯çš„æ“ä½œ
        &quot;&quot;&quot;</span>
        peerip <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># è·å–è¿æ¥çš„å®¢æˆ·ç«¯çš„IPåœ°å€</span>
        opr <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_opr_args<span class="token punctuation">(</span>peerip<span class="token punctuation">)</span>  <span class="token comment"># æ ¹æ®IPåœ°å€æŸ¥è¯¢è¯¥å®¢æˆ·ç«¯å…·ä½“çš„æ“ä½œ</span>
        <span class="token keyword">if</span> opr<span class="token punctuation">:</span>
            <span class="token keyword">if</span> opr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>retr_file<span class="token punctuation">(</span>opr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸‹è½½æ–‡ä»¶</span>
            <span class="token keyword">elif</span> opr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>stor_file<span class="token punctuation">(</span>opr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸Šä¼ æ–‡ä»¶</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å¤„ç†å®Œä¾æ¬¡ä¸Šä¼ æˆ–è€…ä¸‹è½½ä»»åŠ¡åå°±å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—</span>

    <span class="token keyword">def</span> <span class="token function">__get_opr_args</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> peerip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        æ ¹æ®IPåœ°å€æŸ¥è¯¢å®¢æˆ·ç«¯éœ€è¦æœåŠ¡çš„å†…å®¹
        :param peerip: è¿œç«¯çš„IPåœ°å€
        :return: oprå…·ä½“çš„æ“ä½œ
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> peerip <span class="token keyword">in</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">:</span>
            opr <span class="token operator">=</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>peerip<span class="token punctuation">]</span><span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># å¼¹å‡ºåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>client_oper<span class="token punctuation">[</span>peerip<span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># é’ˆå¯¹è¯¥IPåœ°å€ï¼Œåˆ—è¡¨ä¸­æ²¡æœ‰å…¶ä½™æ“ä½œäº†</span>
                self<span class="token punctuation">.</span>client_oper<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>peerip<span class="token punctuation">)</span>  <span class="token comment"># åœ¨å­—æ®µä¸­åˆ é™¤è¿™ä¸ªIPåœ°å€ä¸ºé”®çš„é¡¹ç›®</span>
            <span class="token keyword">return</span> opr

    <span class="token keyword">def</span> <span class="token function">retr_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å®¢æˆ·ç«¯ä¸‹è½½æ–‡ä»¶(å¯¹åº”æœåŠ¡å™¨ç«¯çš„å‘é€æ–‡ä»¶)
        :param filepath: æ–‡ä»¶è·¯å¾„
        &quot;&quot;&quot;</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stor_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶(å¯¹åº”æœåŠ¡å™¨ç«¯çš„æ¥æ”¶å¹¶ä¿å­˜æ–‡ä»¶)
        :param filepath:æ–‡ä»¶è·¯å¾„
        &quot;&quot;&quot;</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># å°†æ–°æ–‡ä»¶ä¿å­˜åˆ°å½“å‰ç›®å½•çš„baktæ–‡ä»¶å¤¹ä¸‹</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyThreadFTPServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è‡ªå®šä¹‰å¤šçº¿ç¨‹FTPæœåŠ¡å™¨
        :param addr: æœåŠ¡å™¨åœ°å€ï¼Œå…ƒç¥–(IPåœ°å€ï¼Œç«¯å£å·)ï¼Œ21å‘½ä»¤ç«¯å£ï¼Œ20æ•°æ®ç«¯å£
        :param handler:å¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„å¯¹è±¡
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>data_server <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># ä¸“é—¨è´Ÿè´£æ•°æ®é€šé“çš„æœåŠ¡å™¨</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>addr<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        é‡å†™çˆ¶ç±»çš„shutdownå‡½æ•°
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>data_server<span class="token punctuation">:</span>  <span class="token comment"># æ˜¯å¦æœ‰æ•°æ®é€šé“æœåŠ¡å™¨æ²¡æœ‰å…³é—­</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è°ƒç”¨çˆ¶ç±»çš„æŒ‚æœºå‡½æ•°</span>

    <span class="token keyword">def</span> <span class="token function">create_data_server</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        åˆ›å»ºæ•°æ®é€šé“ä¸“ç”¨æœåŠ¡å™¨
        :return:pasv_data_ipæ•°æ®æœåŠ¡å™¨çš„IPåœ°å€ï¼›pasv_data_portæ•°æ®æœåŠ¡å™¨çš„ç«¯å£å·
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>data_server <span class="token operator">=</span> socketserver<span class="token punctuation">.</span>ThreadingTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FTPDataHandler<span class="token punctuation">)</span>
        pasv_data_ip<span class="token punctuation">,</span> pasv_data_port <span class="token operator">=</span> self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>server_address  <span class="token comment"># è·å–æ•°æ®æœåŠ¡å™¨çš„ipåœ°å€å’Œç«¯å£å·</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>data_server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å¼€å¯æ–°çº¿ç¨‹ï¼Œå¯åŠ¨æ•°æ®æœåŠ¡å™¨</span>
        <span class="token keyword">return</span> pasv_data_ip<span class="token punctuation">,</span> pasv_data_port


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    ftp_server <span class="token operator">=</span> MyThreadFTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FTPHandler<span class="token punctuation">)</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>ftp_server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å¼€å¯æ–°çº¿ç¨‹ï¼Œå¯åŠ¨FTPæœåŠ¡å™¨</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FTP Server Start...&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># time.sleep(30)</span>
    <span class="token comment"># ftp_server.shutdown()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br></div></div><h3 id="ftpå®¢æˆ·ç«¯çš„å®ç°"><a href="#ftpå®¢æˆ·ç«¯çš„å®ç°" aria-hidden="true" class="header-anchor">#</a> FTPå®¢æˆ·ç«¯çš„å®ç°</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading


<span class="token keyword">def</span> <span class="token function">get_file</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    ä»æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶
    :param host: æœåŠ¡å™¨IPåœ°å€
    :param port: æœåŠ¡å™¨ç«¯å£å·
    :param file_path: æ–‡ä»¶è·¯å¾„
    &quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&quot;/root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span>  <span class="token comment"># æ–‡ä»¶ä¿å­˜åœ¨æœåŠ¡å™¨çš„baktæ–‡ä»¶å¤¹ä¸‹</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">put_data</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    ä¸Šä¼ æ–‡ä»¶è‡³æœåŠ¡å™¨
    :param host: æœåŠ¡å™¨çš„IPåœ°å€
    :param port: æœåŠ¡å™¨çš„ç«¯å£å·
    :param file_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„
    &quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">FTPClient</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è‡ªå®šä¹‰FTPå®¢æˆ·ç«¯
        :param host:æœåŠ¡å™¨IPåœ°å€
        :param port:æœåŠ¡å™¨ç«¯å£å·
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host  <span class="token comment"># æœåŠ¡å™¨ipåœ°å€</span>
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port  <span class="token comment"># æœåŠ¡å™¨ç«¯å£å·</span>
        self<span class="token punctuation">.</span>cmds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NOOP&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TYPE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PASV&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PORT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RETR&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># æ”¯æŒçš„FTPå‘½ä»¤</span>
        self<span class="token punctuation">.</span>line_sep <span class="token operator">=</span> <span class="token string">'\n'</span>
        self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># æ˜¯å¦å·²ç»ç™»é™†æœåŠ¡å™¨</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># è¿æ¥æœåŠ¡å™¨ç«¯çš„å¥—æ¥å­—</span>
        self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># æ˜¯å¦å¤„äºè¢«åŠ¨æ¨¡å¼</span>
        self<span class="token punctuation">.</span>pasv_host <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># è¢«åŠ¨æ¨¡å¼çš„æœåŠ¡å™¨ipåœ°å€</span>
        self<span class="token punctuation">.</span>pasv_port <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># è¢«åŠ¨æ¨¡å¼çš„æœåŠ¡å™¨ç«¯å£å·</span>

    <span class="token keyword">def</span> <span class="token function">__cmd_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        è¿æ¥æœåŠ¡å™¨
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ç™»å½•æœåŠ¡å™¨
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sock<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>send_cmd<span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sock<span class="token punctuation">)</span>
            <span class="token keyword">if</span> res<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;230&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Log in Successfully!&quot;</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>loged <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">read_line</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sock<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        æŒ‰è¡Œè¯»å–æœåŠ¡å™¨è¿”å›æ•°æ®
        :param sock: å¥—æ¥å­—
        :return: dataæ¥æ”¶åˆ°çš„ä¸€è¡Œæ•°æ®
        &quot;&quot;&quot;</span>
        data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> data<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_sep<span class="token punctuation">)</span><span class="token punctuation">:</span>
            d <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            data <span class="token operator">+=</span> d<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__parse_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmd_str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ä»å­—ç¬¦ä¸²ä¸­è§£æå‘½ä»¤
        :param cmd_str: å‘½ä»¤å­—ç¬¦ä¸²
        :return: è¿”å›å‘½ä»¤åŠ¨è¯(å¤§å†™)ï¼Œå‘½ä»¤å‚æ•°
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token string">' '</span> <span class="token keyword">in</span> cmd_str<span class="token punctuation">:</span>
            cmd_lst <span class="token operator">=</span> cmd_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
            cmd <span class="token operator">=</span> cmd_lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            args <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>cmd_lst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cmd <span class="token operator">=</span> cmd_str
            args <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">return</span> cmd<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args

    <span class="token keyword">def</span> <span class="token function">send_cmd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å‘é€å‘½ä»¤
        :param cmd: å‘½ä»¤åŠ¨è¯
        :param args: å‘½ä»¤å‚æ•°
        :return: è¿”å›å‘½ä»¤å‘é€æˆåŠŸä¸å¦
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sock<span class="token punctuation">:</span>
            <span class="token keyword">if</span> args<span class="token punctuation">:</span>
                cmd <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">)</span> <span class="token keyword">or</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter passive mode first&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please specify a file&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
                <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;File not exist&quot;</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">False</span>
            cmd <span class="token operator">+=</span> self<span class="token punctuation">.</span>line_sep
            self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        å¾ªç¯æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„å‘½ä»¤
        &quot;&quot;&quot;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Supported Commands: &quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cmds<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>__cmd_connect<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¿æ¥</span>
        self<span class="token punctuation">.</span>__login<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ç™»é™†</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            cmd_str <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;Enter your commands: &quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> cmd_str<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FTP command can not be empty&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            cmd<span class="token punctuation">,</span> args <span class="token operator">=</span> self<span class="token punctuation">.</span>__parse_cmd<span class="token punctuation">(</span>cmd_str<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>send_cmd<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Fail to send your command: &quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sock<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;PASV&quot;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> res<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;227&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>pasv_mode <span class="token operator">=</span> <span class="token boolean">True</span>
                server_info <span class="token operator">=</span> res<span class="token punctuation">[</span>res<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>res<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>pasv_host <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>server_info<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                server_info <span class="token operator">=</span> server_info<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>pasv_port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>server_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>server_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;RETR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ä¸‹è½½æ–‡ä»¶</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>get_file<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_port<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;STOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ä¸Šä¼ æ–‡ä»¶</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>pasv_mode<span class="token punctuation">:</span>
                    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>put_data<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pasv_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pasv_port<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;QUIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    ftp_client <span class="token operator">=</span> FTPClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ftp_client<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/others/python-socket.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µé¢</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°: </span> <span class="time">4/30/2019, 11:20:13 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.49c648e5.js" defer></script><script src="/blog/assets/js/2.4a73e09d.js" defer></script><script src="/blog/assets/js/51.977931fc.js" defer></script><script src="/blog/assets/js/3.b11672f7.js" defer></script>
  </body>
</html>
