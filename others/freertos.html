<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suda-morris 个人博客</title>
    <meta name="description" content="记录学习生活，探索未知领域">
    <link rel="icon" href="/blog/favicon.png">
  <link rel="manifest" href="/blog/manifest.json">
    
    <link rel="preload" href="/blog/assets/css/0.styles.6e7aa9f8.css" as="style"><link rel="preload" href="/blog/assets/js/app.f7de9bec.js" as="script"><link rel="preload" href="/blog/assets/js/2.a6386433.js" as="script"><link rel="preload" href="/blog/assets/js/39.6a95c848.js" as="script"><link rel="preload" href="/blog/assets/js/6.fc06098a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.620a7235.js"><link rel="prefetch" href="/blog/assets/js/11.983e8ee4.js"><link rel="prefetch" href="/blog/assets/js/12.aaa824e9.js"><link rel="prefetch" href="/blog/assets/js/13.6659bc17.js"><link rel="prefetch" href="/blog/assets/js/14.71aa194c.js"><link rel="prefetch" href="/blog/assets/js/15.819fd84b.js"><link rel="prefetch" href="/blog/assets/js/16.46175218.js"><link rel="prefetch" href="/blog/assets/js/17.4702b8e7.js"><link rel="prefetch" href="/blog/assets/js/18.d61c8a22.js"><link rel="prefetch" href="/blog/assets/js/19.1a326300.js"><link rel="prefetch" href="/blog/assets/js/20.b0096f85.js"><link rel="prefetch" href="/blog/assets/js/21.7b9078c1.js"><link rel="prefetch" href="/blog/assets/js/22.37e2fc7c.js"><link rel="prefetch" href="/blog/assets/js/23.7f2e0f75.js"><link rel="prefetch" href="/blog/assets/js/24.b9576242.js"><link rel="prefetch" href="/blog/assets/js/25.0b521ebb.js"><link rel="prefetch" href="/blog/assets/js/26.21df83ba.js"><link rel="prefetch" href="/blog/assets/js/27.e303f4d6.js"><link rel="prefetch" href="/blog/assets/js/28.afc228de.js"><link rel="prefetch" href="/blog/assets/js/29.d86d0d55.js"><link rel="prefetch" href="/blog/assets/js/3.aaaf91ce.js"><link rel="prefetch" href="/blog/assets/js/30.c7d55eb4.js"><link rel="prefetch" href="/blog/assets/js/31.4e3b008e.js"><link rel="prefetch" href="/blog/assets/js/32.c8cadbe2.js"><link rel="prefetch" href="/blog/assets/js/33.db71320d.js"><link rel="prefetch" href="/blog/assets/js/34.b8902ad6.js"><link rel="prefetch" href="/blog/assets/js/35.1d211cda.js"><link rel="prefetch" href="/blog/assets/js/36.e3aab90e.js"><link rel="prefetch" href="/blog/assets/js/37.c4640c2b.js"><link rel="prefetch" href="/blog/assets/js/38.c852371d.js"><link rel="prefetch" href="/blog/assets/js/4.4acc1a5c.js"><link rel="prefetch" href="/blog/assets/js/40.98531bca.js"><link rel="prefetch" href="/blog/assets/js/41.629f9020.js"><link rel="prefetch" href="/blog/assets/js/42.160f2cc3.js"><link rel="prefetch" href="/blog/assets/js/43.210d6680.js"><link rel="prefetch" href="/blog/assets/js/44.e2d0b2e1.js"><link rel="prefetch" href="/blog/assets/js/45.39548a8d.js"><link rel="prefetch" href="/blog/assets/js/46.29715187.js"><link rel="prefetch" href="/blog/assets/js/47.c71c7045.js"><link rel="prefetch" href="/blog/assets/js/48.c08950e1.js"><link rel="prefetch" href="/blog/assets/js/49.4f1f87e9.js"><link rel="prefetch" href="/blog/assets/js/5.f3c39b1b.js"><link rel="prefetch" href="/blog/assets/js/50.a60e2f14.js"><link rel="prefetch" href="/blog/assets/js/51.900a066a.js"><link rel="prefetch" href="/blog/assets/js/52.300e8a0b.js"><link rel="prefetch" href="/blog/assets/js/53.76f68176.js"><link rel="prefetch" href="/blog/assets/js/54.04397316.js"><link rel="prefetch" href="/blog/assets/js/55.75673155.js"><link rel="prefetch" href="/blog/assets/js/56.82d0f008.js"><link rel="prefetch" href="/blog/assets/js/57.e4d35fde.js"><link rel="prefetch" href="/blog/assets/js/58.0fb74581.js"><link rel="prefetch" href="/blog/assets/js/59.4c3776db.js"><link rel="prefetch" href="/blog/assets/js/60.f50e224d.js"><link rel="prefetch" href="/blog/assets/js/61.37de38d8.js"><link rel="prefetch" href="/blog/assets/js/62.b723b7c0.js"><link rel="prefetch" href="/blog/assets/js/63.95fe8fa4.js"><link rel="prefetch" href="/blog/assets/js/64.405d9bd5.js"><link rel="prefetch" href="/blog/assets/js/65.75c2a799.js"><link rel="prefetch" href="/blog/assets/js/66.4a707cb8.js"><link rel="prefetch" href="/blog/assets/js/67.21de44f4.js"><link rel="prefetch" href="/blog/assets/js/68.5408515d.js"><link rel="prefetch" href="/blog/assets/js/69.e443b351.js"><link rel="prefetch" href="/blog/assets/js/7.aba7e9e3.js"><link rel="prefetch" href="/blog/assets/js/70.4d2ccca3.js"><link rel="prefetch" href="/blog/assets/js/71.8208ee78.js"><link rel="prefetch" href="/blog/assets/js/72.d2234185.js"><link rel="prefetch" href="/blog/assets/js/73.c7b49f40.js"><link rel="prefetch" href="/blog/assets/js/74.24730200.js"><link rel="prefetch" href="/blog/assets/js/75.7c500590.js"><link rel="prefetch" href="/blog/assets/js/76.4b18e8b0.js"><link rel="prefetch" href="/blog/assets/js/77.0dd9f3bf.js"><link rel="prefetch" href="/blog/assets/js/78.67da02fd.js"><link rel="prefetch" href="/blog/assets/js/79.458c4197.js"><link rel="prefetch" href="/blog/assets/js/8.889bc0f1.js"><link rel="prefetch" href="/blog/assets/js/9.b97d0e6f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.6e7aa9f8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://beautifuldingbats.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Beautiful Dingbats
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.draw.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  draw.io
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://beautifuldingbats.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Beautiful Dingbats
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.draw.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  draw.io
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/others/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/others/markdown.html" class="sidebar-link">𝙈𝙖𝙧𝙠𝙙𝙤𝙬𝙣 基本语法</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>title: FreeRTOS Introduction---Based on ESP32
tags:</p> <ul><li>FreeRTOS
categories:</li> <li>Geek Hobbies
author: suda-morris
date: 2018-05-30 20:56:00</li></ul> <hr> <h2 id="freertos系统配置"><a href="#freertos系统配置" aria-hidden="true" class="header-anchor">#</a> FreeRTOS系统配置</h2> <blockquote><p>FreeRTOS的系统配置文件为FreeRTOSConfig.h，在此配置文件中可以完成FreeRTOS的裁剪和配置。FreeRTOS中的裁剪和配置使用条件编译的方式来实现。</p></blockquote> <ul><li>&quot;INCLUDE_&quot;开始的宏，用来表示使能或者失能FreeRTOS中的相应API函数，比如<code>INCLUDE_vTaskPrioritySet</code>用来决定是否可以使用vTaskPrioritySet函数</li> <li>&quot;config&quot;开始的宏也用来对FreeRTOS的进行裁剪和配置，比如
<ul><li><code>configAPPLICATION_ALLOCATED_HEAP</code>宏，如果不开启，那么FreeRTOS的堆内存由编译器分配，开启后，堆内存将由用户自行设置
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PE0q2D.png" alt="configASSERT设置"></li></ul></li> <li><code>configCHECK_FOR_STACK_OVERFLOW</code>宏如果不为零，用户必须提供一个钩子函数<code>vApplicationStackOverflowHook</code> <ul><li><img src="https://s1.ax1x.com/2018/07/03/PEB4SS.png" alt="PEB4SS.png"></li> <li>当堆栈溢出太严重时可能会损毁该函数的两个参数，这时可以通过查看变量pxCurrentTCB来确定哪个任务发生了堆栈溢出</li> <li><code>vApplicationStackOverflowHook( ( TaskHandle_t ) pxCurrentTCB[ xPortGetCoreID() ], pxCurrentTCB[ xPortGetCoreID() ]-&gt;pcTaskName );</code></li> <li>堆栈溢出有两种检测方法：
<ul><li>方法1：上下文切换的时候需要保存现场，现场是保存在堆栈中的，这个时候任务堆栈使用率很可能达到最大值，方法1就是不断检测任务堆栈指针是否指向有效空间，如果指向了无效空间，则调用钩子函数。该方法的特点是快，缺点是不能检测所有的堆栈溢出</li> <li>方法2：在创建任务的时候向任务堆栈填充一个已知的标记值，然后检测堆栈后面的几个字节是否被改写，如果被改写，则调用钩子函数，方法2几乎能够检测到所有的堆栈溢出</li></ul></li></ul></li> <li><code>configMAX_PRIORITIES</code>设置任务的优先级数量，设置好后任务就可以使用从0～configMAX_PRIORITIES-1的优先级，其中0是最低优先级
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEsHwd.png" alt="PEsHwd.png"></li></ul></li> <li><code>configMINIMAL_STACK_SIZE</code>设置空闲任务的最小任务堆栈大小，以<strong>字</strong>为单位
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEyFkn.png" alt="PEyFkn.png"></li></ul></li> <li><code>configTOTAL_HEAP_SIZE</code>设置堆的大小，如果使用了动态内存管理，则FreeRTOS在创建任务、信号量、队列等的时候就会从用户指定的内存中获取空间
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEyUne.png" alt="PEyUne.png"></li></ul></li> <li><code>configKERNEL_INTERRUPT_PRIORITY</code>设置了内核中断系统中systick中断的优先级(FreeRTOS中systick的中断优先级是最低的)
<ul><li><img src="https://s1.ax1x.com/2018/07/04/PEv1LF.png" alt="PEv1LF.png"></li></ul></li> <li><code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>设置了FreeRTOS系统可管理的最大优先级，这里实际值为<em>3</em>，高于此优先级的中断是不会被FreeRTOS内核屏蔽的，对实时性要求严格的任务就可以使用这些优先级，中断服务函数也不能调用FreeRTOS的API函数；低于（包括本身）此优先级的中断可以安全地调用以FromISR结尾的API函数
<ul><li><img src="https://s1.ax1x.com/2018/07/04/PExpTJ.png" alt="PExpTJ.png"></li></ul></li></ul></li></ul> <h2 id="freertos中的task"><a href="#freertos中的task" aria-hidden="true" class="header-anchor">#</a> FreeRTOS中的Task</h2> <ul><li><p>任务控制块</p> <ul><li><blockquote><p>xTaskCreate()创建任务的时候，会自动给每个任务分配一个任务控制块</p></blockquote></li> <li><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * Task control block.  A task control block (TCB) is allocated for each task,
 * and stores task state information, including a pointer to the task's context
 * (the task's run time environment, including register values)
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tskTaskControlBlock</span>
<span class="token punctuation">{</span>
	<span class="token keyword">volatile</span> StackType_t	<span class="token operator">*</span>pxTopOfStack<span class="token punctuation">;</span>	<span class="token comment">//任务堆栈栈顶</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( portUSING_MPU_WRAPPERS == 1 )</span>
		xMPU_SETTINGS	xMPUSettings<span class="token punctuation">;</span>		<span class="token comment">//MPU相关的设置</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	ListItem_t			xGenericListItem<span class="token punctuation">;</span>	<span class="token comment">//状态列表项</span>
	ListItem_t			xEventListItem<span class="token punctuation">;</span>		<span class="token comment">//事件列表项</span>
	UBaseType_t			uxPriority<span class="token punctuation">;</span>			<span class="token comment">//任务优先级</span>
	StackType_t			<span class="token operator">*</span>pxStack<span class="token punctuation">;</span>			<span class="token comment">//任务堆栈起始地址</span>
	<span class="token keyword">char</span>				pcTaskName<span class="token punctuation">[</span> configMAX_TASK_NAME_LEN <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//任务名字</span>
	BaseType_t			xCoreID<span class="token punctuation">;</span>			<span class="token comment">//执行任务的处理器核ID</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( portSTACK_GROWTH &gt; 0 || configENABLE_TASK_SNAPSHOT == 1 )</span>
		StackType_t		<span class="token operator">*</span>pxEndOfStack<span class="token punctuation">;</span>		<span class="token comment">//任务堆栈栈底</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( portCRITICAL_NESTING_IN_TCB == 1 )</span>
		UBaseType_t 	uxCriticalNesting<span class="token punctuation">;</span> 	<span class="token comment">//临界区嵌套深度</span>
		uint32_t		uxOldInterruptState<span class="token punctuation">;</span> <span class="token comment">/*&lt; Interrupt state before the outer taskEnterCritical was called */</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TRACE_FACILITY == 1 )</span>
		UBaseType_t		uxTCBNumber<span class="token punctuation">;</span>		<span class="token comment">/*&lt; Stores a number that increments each time a TCB is created.  It allows debuggers to determine when a task has been deleted and then recreated. */</span>
		UBaseType_t  	uxTaskNumber<span class="token punctuation">;</span>		<span class="token comment">/*&lt; Stores a number specifically for use by third party trace code. */</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_MUTEXES == 1 )</span>
		UBaseType_t 	uxBasePriority<span class="token punctuation">;</span>		<span class="token comment">//任务基础优先级</span>
		UBaseType_t 	uxMutexesHeld<span class="token punctuation">;</span>		<span class="token comment">//任务获取到的互斥信号量个数</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_APPLICATION_TASK_TAG == 1 )</span>
		TaskHookFunction_t pxTaskTag<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span>( configNUM_THREAD_LOCAL_STORAGE_POINTERS &gt; 0 )</span>
		<span class="token keyword">void</span> <span class="token operator">*</span>pvThreadLocalStoragePointers<span class="token punctuation">[</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS )</span>
		TlsDeleteCallbackFunction_t pvThreadLocalStoragePointersDelCallback<span class="token punctuation">[</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configGENERATE_RUN_TIME_STATS == 1 )</span>
		uint32_t		ulRunTimeCounter<span class="token punctuation">;</span>	<span class="token comment">//记录任务运行总时间</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_NEWLIB_REENTRANT == 1 )</span>
		<span class="token comment">/* Allocate a Newlib reent structure that is specific to this task.
		Note Newlib support has been included by popular demand, but is not
		used by the FreeRTOS maintainers themselves.  FreeRTOS is not
		responsible for resulting newlib operation.  User must be familiar with
		newlib and must provide system-wide implementations of the necessary
		stubs. Be warned that (at the time of writing) the current newlib design
		implements a system-wide malloc() that must be provided with locks. */</span>
		<span class="token keyword">struct</span> 	<span class="token class-name">_reent</span> xNewLib_reent<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TASK_NOTIFICATIONS == 1 )</span>
		<span class="token keyword">volatile</span> uint32_t ulNotifiedValue<span class="token punctuation">;</span>	<span class="token comment">//任务通知值</span>
		<span class="token keyword">volatile</span> eNotifyValue eNotifyState<span class="token punctuation">;</span>	<span class="token comment">//任务通知状态</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token comment">/* See the comments above the definition of
	tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE. */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE != 0 )</span>
		uint8_t	ucStaticallyAllocated<span class="token punctuation">;</span> 		<span class="token comment">//如果任务是静态创建的，该变量就为pdTRUE</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span> tskTCB<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> tskTCB TCB_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div></li></ul></li> <li><p>任务堆栈</p> <ul><li><blockquote><p>任务调度器在进行任务切换的时候，会将当前任务的现场(CPU寄存器值等等)保存在此任务的任务堆栈中；此任务下次运行的时候就会先用堆栈中保存的值来恢复现场，之后任务就会接着从上次中断的地方开始运行。使用动态的方法创建任务时，任务堆栈会自动创建；使用静态的方法创建任务时，任务堆栈需要用户自行定义。任务堆栈的数据类型为<code>StackType_t</code>，其大小为4字节，所以动态创建的任务，其堆栈大小是传入数值4倍</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> portSTACK_TYPE uint32_t</span>
<span class="token keyword">typedef</span> portSTACK_TYPE StackType_t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li></ul> <h4 id="尾调用-调度任务创建和删除api函数"><a href="#尾调用-调度任务创建和删除api函数" aria-hidden="true" class="header-anchor">#</a> 尾调用 调度任务创建和删除API函数</h4> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xTaskCreate()</td> <td>使用动态的方法创建一个任务</td></tr> <tr><td>xTaskCreateStatic()</td> <td>使用静态的方法创建一个任务</td></tr> <tr><td>xTaskCreateRestricted()</td> <td>创建一个使用MPU进行限制的任务，相关内存使用动态内存分配</td></tr> <tr><td>vTaskDelete()</td> <td>删除一个任务</td></tr></tbody></table> <h4 id="任务挂起和恢复api函数"><a href="#任务挂起和恢复api函数" aria-hidden="true" class="header-anchor">#</a> 任务挂起和恢复API函数</h4> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>vTaskSuspend()</td> <td>挂起一个任务，传入某个任务的句柄，NULL表示当前任务</td></tr> <tr><td>vTaskResume()</td> <td>恢复一个任务的运行</td></tr> <tr><td>xTaskResumeFromISR()</td> <td>中断服务函数中恢复一个任务的运行。返回pdTRUE表示恢复运行的任务的优先级等于或者高于正在运行的任务（被中断打断的任务），这意味着在退出中断服务函数的时候必须进行一次上下文切换（调用<em>portYIELD_FROM_ISR</em>）。返回pdFALSE表示恢复运行的任务的优先级低于当前正在运行的任务（被中断打断的任务），这意味着在退出中断服务函数的以后不需要进行上下文切换</td></tr></tbody></table> <h4 id="其他常用api函数-部分函数需要在配置文件中开启相关的宏"><a href="#其他常用api函数-部分函数需要在配置文件中开启相关的宏" aria-hidden="true" class="header-anchor">#</a> 其他常用API函数(部分函数需要在配置文件中开启相关的宏)</h4> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xTaskGetHandle()</td> <td>根据任务名字获取某个任务的任务句柄</td></tr> <tr><td>vTaskStartScheduler()</td> <td>开启任务调度</td></tr> <tr><td>vTaskSuspendAll()</td> <td>挂起任务调度器，支持嵌套</td></tr> <tr><td>vTaskResumeAll()</td> <td>恢复调度器</td></tr> <tr><td>vTaskDelay()</td> <td>任务延时，单位是时钟节拍</td></tr> <tr><td>uxTaskPriorityGet()</td> <td>获取指定任务的优先级</td></tr> <tr><td>vTaskPrioritySet()</td> <td>改变一个任务的任务优先级</td></tr> <tr><td>uxTaskGetSystemState()</td> <td>获取系统中所有任务的任务状态</td></tr> <tr><td>vTaskGetInfo()</td> <td>获取单个任务的状态</td></tr> <tr><td>xTaskGetCurrentTaskHandle()</td> <td>获取当前任务的任务句柄</td></tr> <tr><td>xTaskGetHandle()</td> <td>根据任务名字获取任务的任务句柄</td></tr> <tr><td>xTaskGetIdleTaskHandle()</td> <td>返回空闲任务的任务句柄</td></tr> <tr><td>uxTaskGetStackHighWaterMark()</td> <td>检查任务从创建好到现在的历史剩余最小值，FreeRTOS把这个历史剩余最小值叫“高水位线”</td></tr> <tr><td>eTaskGetState()</td> <td>查询某个任务的运行状态</td></tr> <tr><td>pcTaskGetName()</td> <td>根据某个任务的任务句柄来查询这个任务对应的任务名</td></tr> <tr><td>xTaskGetTickCount()/xTaskGetTickCountFromISR()</td> <td>查询任务调度器从启动到现在的时间计数器xTickCount的值，每个滴答定时器中断时xTickCount就会加1</td></tr> <tr><td>xTaskGetSchedulerState()</td> <td>获取FreeRTOS的任务调度器运行情况：运行、关闭还是挂起</td></tr> <tr><td>uxTaskGetNumberOfTasks()</td> <td>查询系统当前存在的任务数量</td></tr> <tr><td>vTaskList()</td> <td>创建一个表格来描述每个任务的详细信息</td></tr> <tr><td>vTaskGetRunTimeStats()</td> <td>统计任务的运行时间信息，任务的运行时间信息提供了每个任务获取到CPU使用权总的时间</td></tr> <tr><td>SetThreadLocalStoragePointer()</td> <td>设置线程本地存储指针的值，每个任务都有自己的指针数组来作为线程本地存储，使用这些线程本地存储可以用来在任务控制块中存储一些应用信息，这些信息只属于线程自己</td></tr> <tr><td>GetThreadLocalStoragePointer()</td> <td>获取线程本地存储指针的值</td></tr></tbody></table> <h2 id="freertos开关中断"><a href="#freertos开关中断" aria-hidden="true" class="header-anchor">#</a> FreeRTOS开关中断</h2> <p><img src="https://s1.ax1x.com/2018/07/04/PEzUKK.png" alt="PEzUKK.png"></p> <ul><li>关闭中断是指优先级低于XCHAL_EXCM_LEVEL的中断将会被屏蔽</li></ul> <h2 id="freertos临界段代码保护"><a href="#freertos临界段代码保护" aria-hidden="true" class="header-anchor">#</a> FreeRTOS临界段代码保护</h2> <table><thead><tr><th>函数/宏</th> <th>描述</th></tr></thead> <tbody><tr><td>taskENTER_CRITICAL()</td> <td>任务级进入临界段</td></tr> <tr><td>taskEXIT_CRITICAL()</td> <td>任务级退出临界段</td></tr> <tr><td>taskENTER_CRITICAL_FROME_ISR()</td> <td>中断级进入临界段（中断优先级不能高于configMAX_SYSCALL_INTERRUPT_PRIORITY）</td></tr> <tr><td>taskEXIT_CRITICAL_FROM_ISR()</td> <td>中断级退出临界段</td></tr></tbody></table> <h2 id="freertos列表（双向循环链表）和列表项"><a href="#freertos列表（双向循环链表）和列表项" aria-hidden="true" class="header-anchor">#</a> FreeRTOS列表（双向循环链表）和列表项</h2> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xLIST</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_INTEGRITY_CHECK_VALUE			<span class="token comment">//用来检查列表的完整性</span>
	configLIST_VOLATILE UBaseType_t uxNumberOfItems<span class="token punctuation">;</span><span class="token comment">//记录列表中列表项的数量</span>
	ListItem_t <span class="token operator">*</span> configLIST_VOLATILE pxIndex<span class="token punctuation">;</span>		<span class="token comment">//记录最新的列表项，用于遍历列表</span>
	MiniListItem_t xListEnd<span class="token punctuation">;</span>						<span class="token comment">//标记列表的最后一项</span>
	listSECOND_LIST_INTEGRITY_CHECK_VALUE			<span class="token comment">//用来检查列表的完整性</span>
<span class="token punctuation">}</span> List_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_ITEM_INTEGRITY_CHECK_VALUE
	configLIST_VOLATILE TickType_t xItemValue<span class="token punctuation">;</span>			<span class="token comment">//序号，用来对列表项进行排列</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxNext<span class="token punctuation">;</span>		<span class="token comment">//指向下一个列表项</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxPrevious<span class="token punctuation">;</span>	<span class="token comment">//指向前一个列表项</span>
	<span class="token keyword">void</span> <span class="token operator">*</span> pvOwner<span class="token punctuation">;</span>										<span class="token comment">//指向实际包含有该列表项的对象</span>
	<span class="token keyword">void</span> <span class="token operator">*</span> configLIST_VOLATILE pvContainer<span class="token punctuation">;</span>				<span class="token comment">//指向此列表项归属的列表</span>
	listSECOND_LIST_ITEM_INTEGRITY_CHECK_VALUE
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> ListItem_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">xMINI_LIST_ITEM</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_ITEM_INTEGRITY_CHECK_VALUE
	configLIST_VOLATILE TickType_t xItemValue<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxNext<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxPrevious<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xMINI_LIST_ITEM</span> MiniListItem_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="列表操作相关api"><a href="#列表操作相关api" aria-hidden="true" class="header-anchor">#</a> 列表操作相关API</h4> <table><thead><tr><th>函数名</th> <th>描述</th></tr></thead> <tbody><tr><td>void vListInitialise( List_t * const pxList )</td> <td>列表初始化</td></tr> <tr><td>void vListInitialiseItem( ListItem_t * const pxItem )</td> <td>列表项初始化</td></tr> <tr><td>void vListInsert( List_t * const pxList, ListItem_t * const pxNewListItem )</td> <td>列表项插入（指定位置）</td></tr> <tr><td>void vListInsertEnd( List_t * const pxList, ListItem_t * const pxNewListItem )</td> <td>列表项插入（末尾）</td></tr> <tr><td>UBaseType_t uxListRemove( ListItem_t * const pxItemToRemove )</td> <td>列表项删除</td></tr> <tr><td>listGET_OWNER_OF_NEXT_ENTRY(pxTCB,pxList)</td> <td>列表的遍历</td></tr></tbody></table> <ul><li>vListInsert中，列表项的插入位置是根据列表项中的xItemValue来决定，按照<strong>升序</strong>方式排列，例如xItemValue的值为portMAX_DELAY就表示要插入的位置是列表的最末尾</li> <li>vListInsertEnd中，列表项插入的位置是pxList中pxIndex指向的列表项的前面</li> <li>uxListRemove函数会返回删除后列表的剩余长度，该函数只是将指定的列表项从列表中删除掉，并不会将这个列表项的内存释放掉</li> <li>列表中的成员变量pxIndex是用来便利列表的，每调用一次宏listGET_OWNER_OF_NEXT_ENTRY，列表的pxIndex就会指向下一个列表项，并且返回这个列表项的pxOwner变量值</li></ul> <h2 id="freertos的调度器"><a href="#freertos的调度器" aria-hidden="true" class="header-anchor">#</a> FreeRTOS的调度器</h2> <h4 id="vtaskstartscheduler函数"><a href="#vtaskstartscheduler函数" aria-hidden="true" class="header-anchor">#</a> vTaskStartScheduler函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t xReturn<span class="token punctuation">;</span>
	BaseType_t i<span class="token punctuation">;</span>

	<span class="token comment">//给每个内核都创建一个空闲任务，优先级设为最低（0），任务名为“IDLE”</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>portNUM_PROCESSORS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( INCLUDE_xTaskGetIdleTaskHandle == 1 )</span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> <span class="token string">&quot;IDLE&quot;</span><span class="token punctuation">,</span> tskIDLE_STACK_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">|</span> portPRIVILEGE_BIT <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>xIdleTaskHandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">else</span></span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> <span class="token string">&quot;IDLE&quot;</span><span class="token punctuation">,</span> tskIDLE_STACK_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">|</span> portPRIVILEGE_BIT <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* INCLUDE_xTaskGetIdleTaskHandle */</span>	<span class="token comment">/* Event lists are always in priority order. */</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//创建软件定时器任务，任务名为“Tmr Svc”，此任务只在内核0上运行</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TIMERS == 1 )</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xReturn <span class="token operator">==</span> pdPASS <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTimerCreateTimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_TIMERS */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xReturn <span class="token operator">==</span> pdPASS <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token comment">//在开启调度器之前不允许被中断打扰，在这里将中断关闭。之前创建的任务堆栈中包含有一个状态字，指示这中断是打开状态，所以当第一个任务运行起来后，中断将会再一次被开启。</span>
		<span class="token function">portDISABLE_INTERRUPTS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		xTickCount <span class="token operator">=</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span>
		<span class="token comment">//如果需要使用时间统计功能，下面的这个宏需要用户自定义（配置一个计数器或定时器）</span>
		<span class="token function">portCONFIGURE_TIMER_FOR_RUN_TIME_STATS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		xSchedulerRunning <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span><span class="token comment">//表示调度器开始运行</span>

		<span class="token comment">//初始化相关硬件：滴答定时器等，这需要用户自行实现</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xPortStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//一旦调度器起来后就永远不会执行到这里</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//只有调用了xTaskEndScheduler函数后才会执行到这里</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//如果创建空闲任务或者定时器任务时内存不够就会执行到这里</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> xReturn <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="xportstartscheduler函数"><a href="#xportstartscheduler函数" aria-hidden="true" class="header-anchor">#</a> xPortStartScheduler函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xPortStartScheduler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
	<span class="token comment">//初始化任务的协处理器</span>
	<span class="token function">_xt_coproc_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token comment">//初始化滴答计数器的分频系数</span>
	<span class="token function">_xt_tick_divisor_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//配置、使能滴答计数器</span>
	<span class="token function">_frxt_tick_timer_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	port_xSchedulerRunning<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//_frxt_dispatch函数不能直接用C语言调用。调度最高优先级的任务</span>
	__asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">&quot;call0    _frxt_dispatch\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//永远不会返回</span>
	<span class="token keyword">return</span> pdTRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="xtaskcreatepinnedtocore函数"><a href="#xtaskcreatepinnedtocore函数" aria-hidden="true" class="header-anchor">#</a> xTaskCreatePinnedToCore函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//在某个具体的核上创建任务</span>
BaseType_t <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span>	TaskFunction_t pxTaskCode<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> pcName<span class="token punctuation">,</span>
							<span class="token keyword">const</span> uint32_t usStackDepth<span class="token punctuation">,</span>
							<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvParameters<span class="token punctuation">,</span>
							UBaseType_t uxPriority<span class="token punctuation">,</span>
							TaskHandle_t <span class="token operator">*</span> <span class="token keyword">const</span> pxCreatedTask<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">;</span>
    BaseType_t xReturn<span class="token punctuation">;</span>

    <span class="token comment">//如果任务栈向上生长，那么先开辟任务控制块TCB的内存，再开辟任务栈的内存，任务栈的地址保存在TCB中</span>
    <span class="token macro property">#<span class="token directive keyword">if</span>( portSTACK_GROWTH &gt; 0 )</span>
    <span class="token punctuation">{</span>
        pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocTcbMem</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocStackMem</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">vPortFree</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token comment">//如果任务栈向下生长，那么先开辟任务栈的内存，再开辟任务控制块TCB的内存，任务栈的地址保存在TCB中</span>
    <span class="token punctuation">{</span>
        StackType_t <span class="token operator">*</span>pxStack<span class="token punctuation">;</span>
        pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocStackMem</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxStack <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocTcbMem</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">=</span> pxStack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">vPortFree</span><span class="token punctuation">(</span> pxStack <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* portSTACK_GROWTH */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token macro property">#<span class="token directive keyword">if</span>( tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE != 0 )</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//标记该任务后期不需要的时候需要删除</span>
            pxNewTCB<span class="token operator">-&gt;</span>ucStaticallyAllocated <span class="token operator">=</span> tskDYNAMICALLY_ALLOCATED_STACK_AND_TCB<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configSUPPORT_STATIC_ALLOCATION */</span>
		<span class="token comment">//初始化任务</span>
        <span class="token function">prvInitialiseNewTask</span><span class="token punctuation">(</span> pxTaskCode<span class="token punctuation">,</span> pcName<span class="token punctuation">,</span> usStackDepth<span class="token punctuation">,</span> pvParameters<span class="token punctuation">,</span> uxPriority<span class="token punctuation">,</span> pxCreatedTask<span class="token punctuation">,</span> pxNewTCB<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> xCoreID <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将新创建的任务加入就绪列表中</span>
        <span class="token function">prvAddNewTaskToReadyList</span><span class="token punctuation">(</span> pxNewTCB<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> xCoreID <span class="token punctuation">)</span><span class="token punctuation">;</span>
        xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        xReturn <span class="token operator">=</span> errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> xReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h4 id="prvinitialisenewtask函数"><a href="#prvinitialisenewtask函数" aria-hidden="true" class="header-anchor">#</a> prvInitialiseNewTask函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseNewTask</span><span class="token punctuation">(</span> 	TaskFunction_t pxTaskCode<span class="token punctuation">,</span>
									<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> pcName<span class="token punctuation">,</span>
									<span class="token keyword">const</span> uint32_t ulStackDepth<span class="token punctuation">,</span>
									<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvParameters<span class="token punctuation">,</span>
									UBaseType_t uxPriority<span class="token punctuation">,</span>
									TaskHandle_t <span class="token operator">*</span> <span class="token keyword">const</span> pxCreatedTask<span class="token punctuation">,</span>
									TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">,</span>
									<span class="token keyword">const</span> MemoryRegion_t <span class="token operator">*</span> <span class="token keyword">const</span> xRegions<span class="token punctuation">,</span> <span class="token keyword">const</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
StackType_t <span class="token operator">*</span>pxTopOfStack<span class="token punctuation">;</span>
UBaseType_t x<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">if</span>( portUSING_MPU_WRAPPERS == 1 )</span>
		<span class="token comment">//任务使用特权模式创建任务</span>
		BaseType_t xRunPrivileged<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxPriority <span class="token operator">&amp;</span> portPRIVILEGE_BIT <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0U</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xRunPrivileged <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			xRunPrivileged <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		uxPriority <span class="token operator">&amp;=</span> <span class="token operator">~</span>portPRIVILEGE_BIT<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* portUSING_MPU_WRAPPERS == 1 */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( ( configCHECK_FOR_STACK_OVERFLOW &gt; 1 ) || ( configUSE_TRACE_FACILITY == 1 ) || ( INCLUDE_uxTaskGetStackHighWaterMark == 1 ) )</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//将任务栈初始化相同的值(0xA5)</span>
		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token punctuation">)</span> tskSTACK_FILL_BYTE<span class="token punctuation">,</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> ulStackDepth <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token comment">//根据栈的不同生长方向来计算栈顶位置</span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( portSTACK_GROWTH &lt; 0 )</span>
	<span class="token punctuation">{</span>
		pxTopOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">+</span> <span class="token punctuation">(</span> ulStackDepth <span class="token operator">-</span> <span class="token punctuation">(</span> uint32_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		pxTopOfStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxTopOfStack <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 

		<span class="token comment">//检查堆栈栈顶地址是否字节对齐</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxTopOfStack <span class="token operator">&amp;</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( configENABLE_TASK_SNAPSHOT == 1 )</span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>pxEndOfStack <span class="token operator">=</span> pxTopOfStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* portSTACK_GROWTH */</span>
	<span class="token punctuation">{</span>
		pxTopOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">;</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">&amp;</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxEndOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">+</span> <span class="token punctuation">(</span> ulStackDepth <span class="token operator">-</span> <span class="token punctuation">(</span> uint32_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* portSTACK_GROWTH */</span>
	<span class="token comment">//保存任务的任务名</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_TASK_NAME_LEN<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pcTaskName<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> pcName<span class="token punctuation">[</span> x <span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> pcName<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//任务名太长需要截断</span>
	pxNewTCB<span class="token operator">-&gt;</span>pcTaskName<span class="token punctuation">[</span> configMAX_TASK_NAME_LEN <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
	<span class="token comment">//修正不合法的优先级</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxPriority <span class="token operator">&gt;=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		uxPriority <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token operator">-</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1U</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">=</span> uxPriority<span class="token punctuation">;</span><span class="token comment">//初始化任务控制块的优先级字段</span>
	pxNewTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">=</span> xCoreID<span class="token punctuation">;</span><span class="token comment">//初始化任务所在的内核ID号</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_MUTEXES == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxBasePriority <span class="token operator">=</span> uxPriority<span class="token punctuation">;</span><span class="token comment">//如果使用了互斥信号量，就需要指定基础优先级</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxMutexesHeld <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_MUTEXES */</span>

	<span class="token function">vListInitialiseItem</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化通用列表项</span>
	<span class="token function">vListInitialiseItem</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化事件列表项</span>
	<span class="token function">listSET_LIST_ITEM_OWNER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置列表项归属</span>
	<span class="token function">listSET_LIST_ITEM_VALUE</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token operator">-</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置事件列表项的值使得优先级从小到大排列</span>
	<span class="token function">listSET_LIST_ITEM_OWNER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置列表项归属</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( portCRITICAL_NESTING_IN_TCB == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxCriticalNesting <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* portCRITICAL_NESTING_IN_TCB */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_APPLICATION_TASK_TAG == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTaskTag <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_APPLICATION_TASK_TAG */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configGENERATE_RUN_TIME_STATS == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ulRunTimeCounter <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configGENERATE_RUN_TIME_STATS */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( portUSING_MPU_WRAPPERS == 1 )</span>
	<span class="token punctuation">{</span>
		<span class="token function">vPortStoreTaskMPUSettings</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xMPUSettings <span class="token punctuation">)</span><span class="token punctuation">,</span> xRegions<span class="token punctuation">,</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">,</span> ulStackDepth <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">else</span></span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* Avoid compiler warning about unreferenced parameter. */</span>
		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> xRegions<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( configNUM_THREAD_LOCAL_STORAGE_POINTERS != 0 )</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>pvThreadLocalStoragePointers<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token macro property">#<span class="token directive keyword">if</span> ( configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS == 1)</span>
			pxNewTCB<span class="token operator">-&gt;</span>pvThreadLocalStoragePointersDelCallback<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TASK_NOTIFICATIONS == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pxNewTCB<span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotWaitingNotification<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_NEWLIB_REENTRANT == 1 )</span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* Initialise this task's Newlib reent structure. */</span>
		<span class="token function">esp_reent_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxNewTCB<span class="token operator">-&gt;</span>xNewLib_reent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( INCLUDE_xTaskAbortDelay == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ucDelayAborted <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( portUSING_MPU_WRAPPERS == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTopOfStack <span class="token operator">=</span> <span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> pxTopOfStack<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> pvParameters<span class="token punctuation">,</span> xRunPrivileged <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* portUSING_MPU_WRAPPERS */</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTopOfStack <span class="token operator">=</span> <span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> pxTopOfStack<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> pvParameters <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化任务堆栈</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* portUSING_MPU_WRAPPERS */</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxCreatedTask <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//任务句柄其实就是任务控制块的地址</span>
		<span class="token operator">*</span>pxCreatedTask <span class="token operator">=</span> <span class="token punctuation">(</span> TaskHandle_t <span class="token punctuation">)</span> pxNewTCB<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><h4 id="pxportinitialisestack函数"><a href="#pxportinitialisestack函数" aria-hidden="true" class="header-anchor">#</a> pxPortInitialiseStack函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>StackType_t <span class="token operator">*</span><span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> StackType_t <span class="token operator">*</span>pxTopOfStack<span class="token punctuation">,</span> TaskFunction_t pxCode<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	StackType_t <span class="token operator">*</span>sp<span class="token punctuation">,</span> <span class="token operator">*</span>tp<span class="token punctuation">;</span>
	XtExcFrame  <span class="token operator">*</span>frame<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
	uint32_t <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	uint32_t <span class="token operator">*</span>threadptr<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>task_thread_local_start<span class="token punctuation">;</span>
	<span class="token keyword">extern</span> <span class="token keyword">int</span> _thread_local_start<span class="token punctuation">,</span> _thread_local_end<span class="token punctuation">,</span> _rodata_start<span class="token punctuation">;</span>
	<span class="token comment">// TODO: check that TLS area fits the stack</span>
	uint32_t thread_local_sz <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_end <span class="token operator">-</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_start<span class="token punctuation">;</span>

	thread_local_sz <span class="token operator">=</span> <span class="token function">ALIGNUP</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> thread_local_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 初始化任务堆栈，使之从高地址开始往下依次是：

	----LOW ADDRESSES ----------------------------------------HIGH ADDRESSES----------
	task stack | interrupt stack frame | thread local vars | co-processor save area |
	----------------------------------------------------------------------------------
	           |																	|
			   SP 								                            pxTopOfStack
	*/</span>
	sp <span class="token operator">=</span> <span class="token punctuation">(</span>StackType_t <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span><span class="token punctuation">(</span>pxTopOfStack <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> XT_CP_SIZE <span class="token operator">-</span> thread_local_sz <span class="token operator">-</span> XT_STK_FRMSZ<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//16字节对齐</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>tp <span class="token operator">=</span> sp<span class="token punctuation">;</span> tp <span class="token operator">&lt;=</span> pxTopOfStack<span class="token punctuation">;</span> <span class="token operator">++</span>tp<span class="token punctuation">)</span><span class="token comment">//将sp到TopOfStack之间的内存清零</span>
		<span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	frame <span class="token operator">=</span> <span class="token punctuation">(</span>XtExcFrame <span class="token operator">*</span><span class="token punctuation">)</span> sp<span class="token punctuation">;</span>

	<span class="token comment">/* 对一些必要的寄存赋值 */</span>
	frame<span class="token operator">-&gt;</span>pc   <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pxCode<span class="token punctuation">;</span>             <span class="token comment">//PC指针初始化为任务函数的入口地址</span>
	frame<span class="token operator">-&gt;</span>a0   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                <span class="token comment">//组织GDB回溯</span>
	frame<span class="token operator">-&gt;</span>a1   <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> sp <span class="token operator">+</span> XT_STK_FRMSZ<span class="token punctuation">;</span>  
	frame<span class="token operator">-&gt;</span>exit <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> _xt_user_exit<span class="token punctuation">;</span>      

	<span class="token comment">/* Set initial PS to int level 0, EXCM disabled ('rfe' will enable), user mode. */</span>
	<span class="token comment">/* Also set entry point argument parameter. */</span>
	<span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
	frame<span class="token operator">-&gt;</span>a2 <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	frame<span class="token operator">-&gt;</span>ps <span class="token operator">=</span> PS_UM <span class="token operator">|</span> PS_EXCM<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">else</span></span>
	<span class="token comment">/* + for windowed ABI also set WOE and CALLINC (pretend task was 'call4'd). */</span>
	frame<span class="token operator">-&gt;</span>a6 <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	frame<span class="token operator">-&gt;</span>ps <span class="token operator">=</span> PS_UM <span class="token operator">|</span> PS_EXCM <span class="token operator">|</span> PS_WOE <span class="token operator">|</span> <span class="token function">PS_CALLINC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> XT_USE_SWPRI</span>
	<span class="token comment">/* Set the initial virtual priority mask value to all 1's. */</span>
	frame<span class="token operator">-&gt;</span>vpri <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token comment">/* Init threadptr reg and TLS vars */</span>
	task_thread_local_start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>pxTopOfStack <span class="token operator">-</span> XT_CP_SIZE <span class="token operator">-</span> thread_local_sz<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>task_thread_local_start<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_thread_local_start<span class="token punctuation">,</span> thread_local_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	threadptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sp <span class="token operator">+</span> XT_STK_EXTRA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* shift threadptr by the offset of _thread_local_start from DROM start;
	   need to take into account extra 16 bytes offset */</span>
	<span class="token operator">*</span>threadptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>task_thread_local_start <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_start <span class="token operator">-</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>_rodata_start<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
	<span class="token comment">/* Init the coprocessor save area (see xtensa_context.h) */</span>
	p <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> pxTopOfStack <span class="token operator">-</span> XT_CP_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">+</span> XCHAL_TOTAL_SA_ALIGN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">-</span>XCHAL_TOTAL_SA_ALIGN<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> sp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h4 id="prvaddnewtasktoreadylist函数"><a href="#prvaddnewtasktoreadylist函数" aria-hidden="true" class="header-anchor">#</a> prvAddNewTaskToReadyList函数</h4> <blockquote><p>FreeRTOS使用不同的列表来表示任务的不同状态</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvAddNewTaskToReadyList</span><span class="token punctuation">(</span> TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">,</span> TaskFunction_t pxTaskCode<span class="token punctuation">,</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	TCB_t <span class="token operator">*</span>curTCB<span class="token punctuation">,</span> <span class="token operator">*</span>tcb0<span class="token punctuation">,</span> <span class="token operator">*</span>tcb1<span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> tskNO_AFFINITY <span class="token operator">||</span> xCoreID <span class="token operator">&lt;</span> portNUM_PROCESSORS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//确保列表在被更新的过程中不会被中断打断</span>
	<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		uxCurrentNumberOfTasks<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//全局变量，统计任务数量</span>
		<span class="token comment">//判断这个任务在哪个内核上运行</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> tskNO_AFFINITY <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> portNUM_PROCESSORS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				tcb0 <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				tcb1 <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> tcb0 <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb1 <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb0<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&amp;&amp;</span> tcb0<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> tcb1<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb1<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span><span class="token comment">//两个核上的运行的任务，其优先级都比新的任务要高</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

        <span class="token comment">//当前的核上没有任务正在运行</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span> <span class="token operator">=</span> pxNewTCB<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> uxCurrentNumberOfTasks <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> portFIRST_TASK_HOOK</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">vPortFirstTaskHook</span><span class="token punctuation">(</span>pxTaskCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configFIRST_TASK_HOOK */</span>
				<span class="token comment">//正在创建的任务是第一个任务，那么需要先初始化相应的列表</span>
				<span class="token function">prvInitialiseTaskLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token comment">//新任务的优先级比正在运行的任务优先级高</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;=</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span> <span class="token operator">=</span> pxNewTCB<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		uxTaskNumber<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//uxTaskNumber加1，用作任务控制块编号</span>

		<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TRACE_FACILITY == 1 )</span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>uxTCBNumber <span class="token operator">=</span> uxTaskNumber<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_TRACE_FACILITY */</span>
		<span class="token function">traceTASK_CREATE</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">portSETUP_TCB</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		curTCB <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//如果新任务的任务优先级最高，而且调度器已经开始正常运行了，那么就执行任务切换</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> curTCB <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> curTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span>xCoreID<span class="token punctuation">,</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h4 id="prvaddtasktoreadylist宏"><a href="#prvaddtasktoreadylist宏" aria-hidden="true" class="header-anchor">#</a> prvAddTaskToReadyList宏</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> prvAddTaskToReadyList( pxTCB )												\
	traceMOVED_TASK_TO_READY_STATE( pxTCB );										\
	taskRECORD_READY_PRIORITY( ( pxTCB )-&gt;uxPriority );								\
	vListInsertEnd( &amp;( pxReadyTasksLists[ ( pxTCB )-&gt;uxPriority ] ), &amp;( ( pxTCB )-&gt;xGenericListItem ) )</span><span class="token comment">//将任务添加到就绪列表的末尾</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="vtaskdelete函数"><a href="#vtaskdelete函数" aria-hidden="true" class="header-anchor">#</a> vTaskDelete函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelete</span><span class="token punctuation">(</span> TaskHandle_t xTaskToDelete <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxTCB<span class="token punctuation">;</span>
    <span class="token keyword">int</span> core <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UBaseType_t free_now<span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        pxTCB <span class="token operator">=</span> <span class="token function">prvGetTCBFromHandle</span><span class="token punctuation">(</span> xTaskToDelete <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据任务句柄获取TCB指针</span>
        <span class="token comment">//将任务从就绪列表中删除</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">taskRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断该任务是否在等待某个事件，如果是这样，则这个任务会被放到相应的列表中，这里需要将其移除</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//触发调试器刷新任务列表</span>
        uxTaskNumber<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">//被删除的任务是正在运行的任务，或者在别的核，那么就交给空闲任务来释放内存</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span>portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token operator">!</span>core <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span>portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">!</span>core<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTasksWaitingTermination<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>uxTasksDeleted<span class="token punctuation">;</span>
            <span class="token function">portPRE_TASK_DELETE_HOOK</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xYieldPending<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用任务删除钩子函数</span>
            free_now <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>		<span class="token comment">//不能立即释放内存</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//要删除的任务不是当前运行的，也不在别的核上</span>
        <span class="token punctuation">{</span>
            <span class="token operator">--</span>uxCurrentNumberOfTasks<span class="token punctuation">;</span>
            <span class="token comment">//重新计算一下还要多长时间执行下一个任务，也就是下一个任务的解锁时间，防止有的任务的解锁时间参考了刚刚被删除的那个任务</span>
            <span class="token function">prvResetNextTaskUnblockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            free_now <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">traceTASK_DELETE</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>free_now <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token macro property">#<span class="token directive keyword">if</span> ( configNUM_THREAD_LOCAL_STORAGE_POINTERS &gt; 0 ) &amp;&amp; ( configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS )</span>
        <span class="token function">prvDeleteTLS</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Run deletion callbacks before deleting TCB</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token function">prvDeleteTCB</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Must only be called after del cb</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果删除的是正在运行的任务，那么删除完以后肯定需要强制进行一次任务切换</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portPRE_TASK_DELETE_HOOK</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xYieldPending<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token operator">!</span>core<span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//如果被删除的任务正在另外一个核上运行，强制另外一个核做任务切换</span>
            <span class="token function">vPortYieldOtherCore</span><span class="token punctuation">(</span> <span class="token operator">!</span>core <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h4 id="vtasksuspend函数"><a href="#vtasksuspend函数" aria-hidden="true" class="header-anchor">#</a> vTaskSuspend函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskSuspend</span><span class="token punctuation">(</span> TaskHandle_t xTaskToSuspend <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxTCB<span class="token punctuation">;</span>
    TCB_t <span class="token operator">*</span>curTCB<span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        pxTCB <span class="token operator">=</span> <span class="token function">prvGetTCBFromHandle</span><span class="token punctuation">(</span> xTaskToSuspend <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">traceTASK_SUSPEND</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将任务从就绪列表中删除</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">taskRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//将任务从事件列表中删除</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">traceMOVED_TASK_TO_SUSPENDED_LIST</span><span class="token punctuation">(</span>pxTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将任务添加到挂起列表的最后</span>
        <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        curTCB <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> curTCB <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//确保当前核的任务调度器工作正常</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//任务调度器不在工作，只能手动查找下一个要运行的任务</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//所有的任务都被挂起，事实上这种情况几乎不存在，除非在空闲任务中调用了阻塞的API</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listCURRENT_LIST_LENGTH</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList <span class="token punctuation">)</span> <span class="token operator">==</span> uxCurrentNumberOfTasks <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//获取下一个要运行的任务</span>
                <span class="token function">vTaskSwitchContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//如果被挂起的任务当前不在运行，重新计算一下还要多长时间执行下一个任务，防止有的任务的解锁时间参考了刚刚被挂起的任务</span>
            <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">{</span>
                <span class="token function">prvResetNextTaskUnblockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h4 id="vtaskresume函数"><a href="#vtaskresume函数" aria-hidden="true" class="header-anchor">#</a> vTaskResume函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskResume</span><span class="token punctuation">(</span> TaskHandle_t xTaskToResume <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span> <span class="token keyword">const</span> pxTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> xTaskToResume<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xTaskToResume <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//xTaskToResume不能为NULL，也不应该存在恢复当前正在运行的任务这种情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxTCB <span class="token operator">!=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvTaskIsTaskSuspended</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">traceTASK_RESUME</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将要恢复的任务从挂起列表中删除</span>
                <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span>  <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将要恢复的任务添加到就绪任务列表中</span>
                <span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果被恢复的任务优先级更高</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">tskCAN_RUN_HERE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&gt;=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//这个yield不会让恢复的任务立即运行，但是会刷新就绪列表</span>
                    <span class="token function">taskYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">!=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//被恢复的任务不属于当前的核</span>
                    <span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">,</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="freertos任务切换"><a href="#freertos任务切换" aria-hidden="true" class="header-anchor">#</a> FreeRTOS任务切换</h2> <ul><li>FreeRTOS任务切换的场合</li></ul> <blockquote><ol><li>执行一个会引起任务切换的API函数，比如<strong>taskYIELD</strong></li> <li>系统滴答定时器中断</li></ol></blockquote> <ul><li><s>任务切换一般是在PendSV（可挂起的系统调用）中断服务函数里面完成的</s></li></ul> <h3 id="执行系统调用"><a href="#执行系统调用" aria-hidden="true" class="header-anchor">#</a> 执行系统调用</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> taskYIELD()					portYIELD()</span>
<span class="token macro property">#<span class="token directive keyword">define</span> portYIELD()					vPortYield()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="vportyield函数"><a href="#vportyield函数" aria-hidden="true" class="header-anchor">#</a> vPortYield函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//函数void vPortYield(void)使用汇编实现，主要功能是保存待暂停任务的最小现场环境，清除CPENABLE，最后调用_frxt_dispatch函数实现真正的上下文切换</span>
    <span class="token punctuation">.</span>globl  vPortYield
    <span class="token punctuation">.</span>type   vPortYield<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
vPortYield<span class="token operator">:</span>

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    addi    sp<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> <span class="token operator">-</span>XT_SOL_FRMSZ
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    entry   sp<span class="token punctuation">,</span>  XT_SOL_FRMSZ
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    rsr     a2<span class="token punctuation">,</span>  PS
    s32i    a0<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PC
    s32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    s32i    a12<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A12         <span class="token comment">/* save callee-saved registers      */</span>
    s32i    a13<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A13
    s32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A14
    s32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A15
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token comment">/* Spill register windows. Calling xthal_window_spill() causes extra    */</span>
    <span class="token comment">/* spills and reloads, so we will set things up to call the _nw version */</span>
    <span class="token comment">/* instead to save cycles.                                              */</span>
    movi    a6<span class="token punctuation">,</span>  <span class="token operator">~</span><span class="token punctuation">(</span>PS_WOE_MASK<span class="token operator">|</span>PS_INTLEVEL_MASK<span class="token punctuation">)</span>  <span class="token comment">/* spills a4-a7 if needed */</span>
    and     a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a6                           <span class="token comment">/* clear WOE, INTLEVEL    */</span>
    addi    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> XCHAL_EXCM_LEVEL             <span class="token comment">/* set INTLEVEL           */</span>
    wsr     a2<span class="token punctuation">,</span>  PS
    rsync
    call0   xthal_window_spill_nw
    l32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS                    <span class="token comment">/* restore PS             */</span>
    wsr     a2<span class="token punctuation">,</span>  PS
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    rsil    a2<span class="token punctuation">,</span>  XCHAL_EXCM_LEVEL       <span class="token comment">/* disable low/med interrupts       */</span>

    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Save coprocessor callee-saved state (if any). At this point CPENABLE */</span>
    <span class="token comment">/* should still reflect which CPs were in use (enabled).                */</span>
    call0   _xt_coproc_savecs
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    movi    a2<span class="token punctuation">,</span>  pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    l32i    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>                  <span class="token comment">/* a2 = pxCurrentTCB                */</span>
    movi    a3<span class="token punctuation">,</span>  <span class="token number">0</span>
    s32i    a3<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_EXIT        <span class="token comment">/* 0 to flag as solicited frame     */</span>
    s32i    sp<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> TOPOFSTACK_OFFS    <span class="token comment">/* pxCurrentTCB-&gt;pxTopOfStack = SP  */</span>

    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Clear CPENABLE, also in task's co-processor state save area. */</span>
    l32i    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS <span class="token comment">/* a2 = pxCurrentTCB-&gt;cp_state      */</span>
    movi    a3<span class="token punctuation">,</span>  <span class="token number">0</span>
    wsr     a3<span class="token punctuation">,</span>  CPENABLE
    beqz    a2<span class="token punctuation">,</span>  <span class="token number">1f</span>
    s16i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> XT_CPENABLE        <span class="token comment">/* clear saved cpenable             */</span>
<span class="token number">1</span><span class="token operator">:</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Tail-call dispatcher. */</span>
    call0   _frxt_dispatch
    <span class="token comment">/* Never reaches here. */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="frxt-dispatch函数"><a href="#frxt-dispatch函数" aria-hidden="true" class="header-anchor">#</a> _frxt_dispatch函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//该函数的功能是将上下文切换到最高优先级的就绪任务，恢复它的状态，最后将将控制权转交给它</span>
    <span class="token punctuation">.</span>globl  _frxt_dispatch
    <span class="token punctuation">.</span>type   _frxt_dispatch<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
_frxt_dispatch<span class="token operator">:</span>

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    call0   vTaskSwitchContext  <span class="token comment">// Get next TCB to resume</span>
    movi    a2<span class="token punctuation">,</span> pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    call4   vTaskSwitchContext  <span class="token comment">// Get next TCB to resume</span>
    movi    a2<span class="token punctuation">,</span> pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
    l32i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>
    l32i    sp<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> TOPOFSTACK_OFFS     <span class="token comment">/* SP = next_TCB-&gt;pxTopOfStack;  */</span>
    s32i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token comment">/* Determine the type of stack frame. */</span>
    l32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_STK_EXIT        <span class="token comment">/* exit dispatcher or solicited flag */</span>
    bnez    a2<span class="token punctuation">,</span>  <span class="token punctuation">.</span>L_frxt_dispatch_stk

<span class="token punctuation">.</span>L_frxt_dispatch_sol<span class="token operator">:</span>

    <span class="token comment">/* Solicited stack frame. Restore minimal context and return from vPortYield(). */</span>
    l32i    a3<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    l32i    a12<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A12
    l32i    a13<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A13
    l32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A14
    l32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A15
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
    l32i    a0<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PC
    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Ensure wsr.CPENABLE is complete (should be, it was cleared on entry). */</span>
    rsync
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token comment">/* As soons as PS is restored, interrupts can happen. No need to sync PS. */</span>
    wsr     a3<span class="token punctuation">,</span>  PS
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    addi    sp<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_FRMSZ
    ret
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    retw
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token punctuation">.</span>L_frxt_dispatch_stk<span class="token operator">:</span>

    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Restore CPENABLE from task's co-processor save area. */</span>
    movi    a3<span class="token punctuation">,</span> pxCurrentTCB            <span class="token comment">/* cp_state =                       */</span>
	getcoreid a2
	addx4	a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a3
    l32i    a3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>
    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS     <span class="token comment">/* StackType_t                       *pxStack; */</span>
    l16ui   a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> XT_CPENABLE         <span class="token comment">/* CPENABLE = cp_state-&gt;cpenable;   */</span>
    wsr     a3<span class="token punctuation">,</span> CPENABLE
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Interrupt stack frame. Restore full context and return to exit dispatcher. */</span>
    call0   _xt_context_restore

    <span class="token comment">/* In Call0 ABI, restore callee-saved regs (A12, A13 already restored). */</span>
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    l32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_A14
    l32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_A15
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Ensure wsr.CPENABLE has completed. */</span>
    rsync
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">/*
    Must return via the exit dispatcher corresponding to the entrypoint from which
    this was called. Interruptee's A0, A1, PS, PC are restored and the interrupt
    stack frame is deallocated in the exit dispatcher.
    */</span>
    l32i    a0<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_EXIT
    ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h4 id="vtaskswitchcontext函数"><a href="#vtaskswitchcontext函数" aria-hidden="true" class="header-anchor">#</a> vTaskSwitchContext函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//理论上，该函数只有在滴答定时器中断和crosscore中断中被调用</span>
<span class="token keyword">void</span> <span class="token function">vTaskSwitchContext</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> irqstate<span class="token operator">=</span><span class="token function">portENTER_CRITICAL_NESTED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tskTCB <span class="token operator">*</span> pxTCB<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* The scheduler is currently suspended - do not allow a context
		switch. */</span>
		xYieldPending<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		xYieldPending<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
        xSwitchingContext<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
		<span class="token function">traceTASK_SWITCHED_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token macro property">#<span class="token directive keyword">if</span> ( configGENERATE_RUN_TIME_STATS == 1 )</span>
		<span class="token punctuation">{</span>
				<span class="token macro property">#<span class="token directive keyword">ifdef</span> portALT_GET_RUN_TIME_COUNTER_VALUE</span>
					<span class="token function">portALT_GET_RUN_TIME_COUNTER_VALUE</span><span class="token punctuation">(</span> ulTotalRunTime <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token macro property">#<span class="token directive keyword">else</span></span>
					ulTotalRunTime <span class="token operator">=</span> <span class="token function">portGET_RUN_TIME_COUNTER_VALUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token macro property">#<span class="token directive keyword">endif</span></span>

				<span class="token comment">/* Add the amount of time the task has been running to the
				accumulated time so far.  The time the task started running was
				stored in ulTaskSwitchedInTime.  Note that there is no overflow
				protection here so count values are only valid until the timer
				overflows.  The guard against negative values is to protect
				against suspect run time stat counter implementations - which
				are provided by the application, not the kernel. */</span>
				<span class="token function">taskENTER_CRITICAL_ISR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> ulTotalRunTime <span class="token operator">&gt;</span> ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulRunTimeCounter <span class="token operator">+=</span> <span class="token punctuation">(</span> ulTotalRunTime <span class="token operator">-</span> ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">taskEXIT_CRITICAL_ISR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ulTotalRunTime<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configGENERATE_RUN_TIME_STATS */</span>

		<span class="token comment">/* Check for stack overflow, if configured. */</span>
		<span class="token function">taskFIRST_CHECK_FOR_STACK_OVERFLOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">taskSECOND_CHECK_FOR_STACK_OVERFLOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* Select a new task to run */</span>

		<span class="token comment">/*
		 We cannot do taskENTER_CRITICAL_ISR(&amp;xTaskQueueMutex); here because it saves the interrupt context to the task tcb, and we're
		 swapping that out here. Instead, we're going to do the work here ourselves. Because interrupts are already disabled, we only
		 need to acquire the mutex.
		*/</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FREERTOS_PORTMUX_DEBUG</span>
		<span class="token function">vPortCPUAcquireMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
		<span class="token function">vPortCPUAcquireMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

		<span class="token keyword">unsigned</span> portBASE_TYPE foundNonExecutingWaiter <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> resetListHead<span class="token punctuation">;</span>
		portBASE_TYPE uxDynamicTopReady <span class="token operator">=</span> uxTopReadyPriority<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> portBASE_TYPE holdTop<span class="token operator">=</span>pdFALSE<span class="token punctuation">;</span>

		<span class="token comment">/*
		 *  ToDo: This scheduler doesn't correctly implement the round-robin scheduling as done in the single-core
		 *  FreeRTOS stack when multiple tasks have the same priority and are all ready; it just keeps grabbing the
		 *  first one. ToDo: fix this.
		 *  (Is this still true? if any, there's the issue with one core skipping over the processes for the other
		 *  core, potentially not giving the skipped-over processes any time.)
		 */</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span> ableToSchedule <span class="token operator">==</span> pdFALSE <span class="token operator">&amp;&amp;</span> uxDynamicTopReady <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			resetListHead <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
			<span class="token comment">// Nothing to do for empty lists</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
				tskTCB <span class="token operator">*</span> pxRefTCB<span class="token punctuation">;</span>

				<span class="token comment">/* Remember the current list item so that we
				can detect if all items have been inspected.
				Once this happens, we move on to a lower
				priority list (assuming nothing is suitable
				for scheduling). Note: This can return NULL if
				the list index is at the listItem */</span>
				pxRefTCB <span class="token operator">=</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>pxIndex<span class="token operator">-&gt;</span>pvOwner<span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>pxIndex<span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>xListEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">//pxIndex points to the list end marker. Skip that and just get the next item.</span>
					<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxRefTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">do</span> <span class="token punctuation">{</span>
					<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">/* Find out if the next task in the list is
					already being executed by another core */</span>
					foundNonExecutingWaiter <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
					portBASE_TYPE i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>portNUM_PROCESSORS<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">continue</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> pxTCB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							holdTop<span class="token operator">=</span>pdTRUE<span class="token punctuation">;</span> <span class="token comment">//keep this as the top prio, for the other CPU</span>
							foundNonExecutingWaiter <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>foundNonExecutingWaiter <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">/* If the task is not being executed
						by another core and its affinity is
						compatible with the current one,
						prepare it to be swapped in */</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> tskNO_AFFINITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pxTCB<span class="token punctuation">;</span>
							ableToSchedule <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pxTCB<span class="token punctuation">;</span>
							ableToSchedule <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
							holdTop<span class="token operator">=</span>pdTRUE<span class="token punctuation">;</span> <span class="token comment">//keep this as the top prio, for the other CPU</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdFALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						resetListHead <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>resetListHead <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						tskTCB <span class="token operator">*</span> pxResetTCB<span class="token punctuation">;</span>
						<span class="token keyword">do</span> <span class="token punctuation">{</span>
							<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxResetTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>pxResetTCB <span class="token operator">!=</span> pxRefTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdFALSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pxTCB <span class="token operator">!=</span> pxRefTCB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>holdTop<span class="token punctuation">)</span> <span class="token operator">--</span>uxTopReadyPriority<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token operator">--</span>uxDynamicTopReady<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">traceTASK_SWITCHED_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xSwitchingContext<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

		<span class="token comment">//Exit critical region manually as well: release the mux now, interrupts will be re-enabled when we</span>
		<span class="token comment">//exit the function.</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FREERTOS_PORTMUX_DEBUG</span>
		<span class="token function">vPortCPUReleaseMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
		<span class="token function">vPortCPUReleaseMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> CONFIG_FREERTOS_WATCHPOINT_END_OF_STACK</span>
		<span class="token function">vPortSetStackWatchpoint</span><span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>pxStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token punctuation">}</span>
	<span class="token function">portEXIT_CRITICAL_NESTED</span><span class="token punctuation">(</span>irqstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br></div></div><h3 id="系统滴答定时器中断"><a href="#系统滴答定时器中断" aria-hidden="true" class="header-anchor">#</a> 系统滴答定时器中断</h3> <h4 id="frxt-timer-int"><a href="#frxt-timer-int" aria-hidden="true" class="header-anchor">#</a> _frxt_timer_int</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//该函数是系统滴答定时器中断处理函数，每一次tick时钟到来都会调用一次xPortSysTickHandler</span>
    <span class="token punctuation">.</span>globl  _frxt_timer_int
    <span class="token punctuation">.</span>type   _frxt_timer_int<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
_frxt_timer_int<span class="token operator">:</span>

    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PM_TRACE</span>
    movi a6<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* = ESP_PM_TRACE_TICK */</span>
    getcoreid a7
    call4 esp_pm_trace_enter
    <span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">// CONFIG_PM_TRACE</span>

<span class="token punctuation">.</span>L_xt_timer_int_catchup<span class="token operator">:</span>

    <span class="token comment">/* Update the timer comparator for the next tick. */</span>
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> XT_CLOCK_FREQ</span>
    movi    a2<span class="token punctuation">,</span> XT_TICK_DIVISOR         <span class="token comment">/* a2 = comparator increment          */</span>
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    movi    a3<span class="token punctuation">,</span> _xt_tick_divisor
    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>                   <span class="token comment">/* a2 = comparator increment          */</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
    rsr     a3<span class="token punctuation">,</span> XT_CCOMPARE             <span class="token comment">/* a3 = old comparator value          */</span>
    add     a4<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a2                  <span class="token comment">/* a4 = new comparator value          */</span>
    wsr     a4<span class="token punctuation">,</span> XT_CCOMPARE             <span class="token comment">/* update comp. and clear interrupt   */</span>
    esync

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    <span class="token comment">/* Preserve a2 and a3 across C calls. */</span>
    s32i    a2<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">4</span>
    s32i    a3<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">8</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Call the FreeRTOS tick handler (see port.c). */</span>
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    call0   xPortSysTickHandler
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    call4   xPortSysTickHandler
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    <span class="token comment">/* Restore a2 and a3. */</span>
    l32i    a2<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">4</span>
    l32i    a3<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">8</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Check if we need to process more ticks to catch up. */</span>
    esync                               <span class="token comment">/* ensure comparator update complete  */</span>
    rsr     a4<span class="token punctuation">,</span> CCOUNT                  <span class="token comment">/* a4 = cycle count                   */</span>
    sub     a4<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> a3                  <span class="token comment">/* diff = ccount - old comparator     */</span>
    blt     a2<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> <span class="token punctuation">.</span>L_xt_timer_int_catchup  <span class="token comment">/* repeat while diff &gt; divisor */</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PM_TRACE</span>
    movi a6<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* = ESP_PM_TRACE_TICK */</span>
    getcoreid a7
    call4 esp_pm_trace_exit
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">// CONFIG_PM_TRACE</span>

    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h4 id="xportsystickhandler函数"><a href="#xportsystickhandler函数" aria-hidden="true" class="header-anchor">#</a> xPortSysTickHandler函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xPortSysTickHandler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t ret<span class="token punctuation">;</span>

	<span class="token function">portbenchmarkIntLatency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">traceISR_ENTER</span><span class="token punctuation">(</span>SYSTICK_INTR_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">xTaskIncrementTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">portYIELD_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">traceISR_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> portYIELD_FROM_ISR()        {traceISR_EXIT_TO_SCHEDULER(); _frxt_setup_switch();}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="frxt-setup-switch函数"><a href="#frxt-setup-switch函数" aria-hidden="true" class="header-anchor">#</a> _frxt_setup_switch函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//在内部设置一个flag，在退出中断的时候_frxt_int_exit会检查该flag，如果发现flag被设置了，就调用函数vPortYieldFromInt</span>
    <span class="token punctuation">.</span>global     _frxt_setup_switch
    <span class="token punctuation">.</span>type       _frxt_setup_switch<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align      <span class="token number">4</span>
_frxt_setup_switch<span class="token operator">:</span>

    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

	getcoreid a3
    movi    a2<span class="token punctuation">,</span> port_switch_flag
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2

    movi    a3<span class="token punctuation">,</span> <span class="token number">1</span>
    s32i    a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="vportyieldfromint"><a href="#vportyieldfromint" aria-hidden="true" class="header-anchor">#</a> vPortYieldFromInt</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token punctuation">.</span>globl  vPortYieldFromInt
    <span class="token punctuation">.</span>type   vPortYieldFromInt<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
vPortYieldFromInt<span class="token operator">:</span>
    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token macro property">#<span class="token directive keyword">if</span> XCHAL_CP_NUM &gt; 0</span>
    <span class="token comment">/* Save CPENABLE in task's co-processor save area, and clear CPENABLE.  */</span>
    movi    a3<span class="token punctuation">,</span> pxCurrentTCB            <span class="token comment">/* cp_state =                       */</span>
	getcoreid a2
	addx4	a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a3
    l32i    a3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>

    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS

    rsr     a3<span class="token punctuation">,</span> CPENABLE
    s16i    a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> XT_CPENABLE         <span class="token comment">/* cp_state-&gt;cpenable = CPENABLE;   */</span>
    movi    a3<span class="token punctuation">,</span> <span class="token number">0</span>
    wsr     a3<span class="token punctuation">,</span> CPENABLE                <span class="token comment">/* disable all co-processors        */</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token macro property">#<span class="token directive keyword">ifdef</span> __XTENSA_CALL0_ABI__</span>
    <span class="token comment">/* Tail-call dispatcher. */</span>
    call0   _frxt_dispatch
    <span class="token comment">/* Never reaches here. */</span>
    <span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="总结上下文切换的场合"><a href="#总结上下文切换的场合" aria-hidden="true" class="header-anchor">#</a> 🔚总结上下文切换的场合</h4> <div class="language-mermaid line-numbers-mode"><pre class="language-text"><code>graph LR
	fd(_frxt_dispatch) --&gt; tsc(vTaskSwitchContext)
    ty(taskYIELD/portYIELD) --&gt; py(vPortYield)
    py --&gt; fd
	
	fie(XT_RTOS_INT_ENTER/_frxt_int_enter) --&gt; fti(_frxt_timer_int)
    fti --&gt; psth(xPortSysTickHandler)
    psth --&gt; pyfi(portYIELD_FROM_ISR)
	pyfi --&gt; fss(_frxt_setup_switch)
	fss --&gt; fiex(XT_RTOS_INT_EXIT/_frxt_int_exit)
	fiex --&gt; pyf(vPortYieldFromInt)
	pyf --&gt; fd

	tyoc(taskYIELD_OTHER_CORE) --&gt; vpyoc(vPortYieldOtherCore)
	vpyoc --&gt; ecisy(esp_crosscore_int_send_yield)
	ecisy --&gt; ecis(esp_crosscore_int_send)
	ecis --&gt; eci(esp_crosscore_isr)
	eci --&gt; ecihy(esp_crosscore_isr_handle_yield)
	ecihy --&gt; pyfi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="freertos时间片调度"><a href="#freertos时间片调度" aria-hidden="true" class="header-anchor">#</a> FreeRTOS时间片调度</h2> <blockquote><p>时间片调度发生在滴答定时器的中断服务函数中，在中断服务函数中会调用xPortSysTickHandler()，而xPortSysTickHandler会引发任务调度，只是这个任务调度是有条件的，只有<strong>xTaskIncrementTick</strong>的返回值不为pdFALSE时，才会进行任务调度。如果当前任务所对应的优先级下有其他的任务存在，那么函数xTaskIncrementTick就会返回pdTRUE。</p></blockquote> <h2 id="freertos时间管理"><a href="#freertos时间管理" aria-hidden="true" class="header-anchor">#</a> FreeRTOS时间管理</h2> <h4 id="vtaskdelay相对延时函数"><a href="#vtaskdelay相对延时函数" aria-hidden="true" class="header-anchor">#</a> vTaskDelay相对延时函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelay</span><span class="token punctuation">(</span> <span class="token keyword">const</span> TickType_t xTicksToDelay <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    BaseType_t xAlreadyYielded <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

    <span class="token comment">//延时的时间如果不大于0，那就相当于直接进行任务切换</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToDelay <span class="token operator">&gt;</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            <span class="token function">traceTASK_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计算唤醒时间</span>
            xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToDelay<span class="token punctuation">;</span>
            <span class="token comment">//从就绪列表上移除</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//添加到延时列表中</span>
            <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xAlreadyYielded <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="prvaddcurrenttasktodelayedlist函数"><a href="#prvaddcurrenttasktodelayedlist函数" aria-hidden="true" class="header-anchor">#</a> prvAddCurrentTaskToDelayedList函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token keyword">const</span> BaseType_t xCoreID<span class="token punctuation">,</span> <span class="token keyword">const</span> TickType_t xTimeToWake <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//按照唤醒时间从小到达的顺序，插入延时列表</span>
	<span class="token function">listSET_LIST_ITEM_VALUE</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> xTickCount <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token function">traceMOVED_TASK_TO_OVERFLOW_DELAYED_LIST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//唤醒时间已经溢出，将其插入延时溢出列表中</span>
		<span class="token function">vListInsert</span><span class="token punctuation">(</span> pxOverflowDelayedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
        <span class="token function">traceMOVED_TASK_TO_DELAYED_LIST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//时间还没有溢出，插入延时列表中</span>
		<span class="token function">vListInsert</span><span class="token punctuation">(</span> pxDelayedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//xNextTaskUnblockTime是一个全局变量，保存着距离下一个要取消阻塞的任务最小时间点值</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> xNextTaskUnblockTime <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xNextTaskUnblockTime <span class="token operator">=</span> xTimeToWake<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="vtaskdelayuntil绝对延时函数"><a href="#vtaskdelayuntil绝对延时函数" aria-hidden="true" class="header-anchor">#</a> vTaskDelayUntil绝对延时函数</h4> <blockquote><p>使用该函数延时的任务也不一定能够周期性的运行，该函数只能保证按照一定的周期取消阻塞，进入就绪态</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelayUntil</span><span class="token punctuation">(</span> TickType_t <span class="token operator">*</span> <span class="token keyword">const</span> pxPreviousWakeTime<span class="token punctuation">,</span> <span class="token keyword">const</span> TickType_t xTimeIncrement <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    BaseType_t xAlreadyYielded<span class="token operator">=</span>pdFALSE<span class="token punctuation">,</span> xShouldDelay <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> pxPreviousWakeTime <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeIncrement <span class="token operator">&gt;</span> <span class="token number">0U</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> TickType_t xConstTickCount <span class="token operator">=</span> xTickCount<span class="token punctuation">;</span>
        <span class="token comment">//计算任务被唤醒的时刻</span>
        xTimeToWake <span class="token operator">=</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token operator">+</span> xTimeIncrement<span class="token punctuation">;</span>
        <span class="token comment">//tick计数器溢出</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xConstTickCount <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//tick计数器和唤醒时间都溢出，且tick计数器值比唤醒时间小</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&gt;</span> xConstTickCount <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                xShouldDelay <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//tick计数器没有溢出，唤醒时间溢出或者tick计数器值比唤醒时间小，这两种情况都说明还需要继续延时</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&gt;</span> xConstTickCount <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                xShouldDelay <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//为本函数的下一次执行做好准备</span>
        <span class="token operator">*</span>pxPreviousWakeTime <span class="token operator">=</span> xTimeToWake<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xShouldDelay <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">traceTASK_DELAY_UNTIL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//从就序列表中移除</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> xAlreadyYielded <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h4 id="portyield-within-api宏定义"><a href="#portyield-within-api宏定义" aria-hidden="true" class="header-anchor">#</a> portYIELD_WITHIN_API宏定义</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//上下文切换工作需要等待直到中断被允许后才执行，这里使用cross-core中断来触发自己</span>
<span class="token macro property">#<span class="token directive keyword">define</span> portYIELD_WITHIN_API() esp_crosscore_int_send_yield(xPortGetCoreID())</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="xtaskincreamenttick函数的主要功能"><a href="#xtaskincreamenttick函数的主要功能" aria-hidden="true" class="header-anchor">#</a> xTaskIncreamentTick函数的主要功能</h4> <blockquote><p>xTickCount是FreeRTOS的系统节拍计数器，每个滴答定时器中断后xTickCount就会增加一，xTickCount的具体操作是在函数xTaskIncrementTick中进行的</p></blockquote> <ol><li>系统节拍计数器的值加1</li> <li>判断是否有任务的延时等待时间已到，如果就就将其恢复</li> <li>处理时间片调度</li> <li>综上给出是否需要执行上下文切换的判断结果并返回滴答定时器中断</li></ol> <h2 id="freertos队列"><a href="#freertos队列" aria-hidden="true" class="header-anchor">#</a> FreeRTOS队列</h2> <h4 id="队列结构体queue-t"><a href="#队列结构体queue-t" aria-hidden="true" class="header-anchor">#</a> 队列结构体Queue_t</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">QueueDefinition</span>
<span class="token punctuation">{</span>
	int8_t <span class="token operator">*</span>pcHead<span class="token punctuation">;</span>					<span class="token comment">//指向队列存储区开始位置</span>
	int8_t <span class="token operator">*</span>pcTail<span class="token punctuation">;</span>					<span class="token comment">//指向队列存储区最后一个字节</span>
	int8_t <span class="token operator">*</span>pcWriteTo<span class="token punctuation">;</span>				<span class="token comment">//指向存储区中下一个空闲区域</span>
	<span class="token keyword">union</span>							
	<span class="token punctuation">{</span>
		int8_t <span class="token operator">*</span>pcReadFrom<span class="token punctuation">;</span>			<span class="token comment">//用作队列时指向最后一个出队的队列项首地址</span>
		UBaseType_t uxRecursiveCallCount<span class="token punctuation">;</span><span class="token comment">//用作递归互斥信号量时用来记录递归互斥信号量被调用的次数</span>
	<span class="token punctuation">}</span> u<span class="token punctuation">;</span>
	List_t xTasksWaitingToSend<span class="token punctuation">;</span>		<span class="token comment">//那些因为队列满导致入队失败而进入阻塞态的任务就会挂到此列表上，按照优先级排列</span>
	List_t xTasksWaitingToReceive<span class="token punctuation">;</span>	<span class="token comment">//那些因为队列空导致出队失败而进入阻塞态的任务就会挂到此列表上，按照优先级排列</span>

	<span class="token keyword">volatile</span> UBaseType_t uxMessagesWaiting<span class="token punctuation">;</span><span class="token comment">//队列中当前的消息数量</span>
	UBaseType_t uxLength<span class="token punctuation">;</span>			<span class="token comment">//队列中允许的最大的消息数量</span>
	UBaseType_t uxItemSize<span class="token punctuation">;</span>			<span class="token comment">//每个消息允许的最大长度</span>

	<span class="token macro property">#<span class="token directive keyword">if</span>( ( configSUPPORT_STATIC_ALLOCATION == 1 ) &amp;&amp; ( configSUPPORT_DYNAMIC_ALLOCATION == 1 ) )</span>
		uint8_t ucStaticallyAllocated<span class="token punctuation">;</span>	<span class="token comment">//如果队列的内存是静态分配的，则为pdTRUE</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_QUEUE_SETS == 1 )</span>
		<span class="token keyword">struct</span> <span class="token class-name">QueueDefinition</span> <span class="token operator">*</span>pxQueueSetContainer<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TRACE_FACILITY == 1 )</span>
		UBaseType_t uxQueueNumber<span class="token punctuation">;</span>
		uint8_t ucQueueType<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	portMUX_TYPE mux<span class="token punctuation">;</span>		<span class="token comment">//因为SMP的原因，所以需要互斥锁</span>

<span class="token punctuation">}</span> xQUEUE<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> xQUEUE Queue_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="创建队列xqueuecreate"><a href="#创建队列xqueuecreate" aria-hidden="true" class="header-anchor">#</a> 创建队列xQueueCreate</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> xQueueCreate( uxQueueLength, uxItemSize ) xQueueGenericCreate( ( uxQueueLength ), ( uxItemSize ), ( queueQUEUE_TYPE_BASE ) )</span><span class="token comment">//普通消息队列的类型是queueQUEUE_TYPE_BASE</span>
QueueHandle_t <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxQueueLength<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxItemSize<span class="token punctuation">,</span> <span class="token keyword">const</span> uint8_t ucQueueType <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Queue_t <span class="token operator">*</span>pxNewQueue<span class="token punctuation">;</span>
    size_t xQueueSizeInBytes<span class="token punctuation">;</span>
    uint8_t <span class="token operator">*</span>pucQueueStorage<span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxQueueLength <span class="token operator">&gt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> uxItemSize <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        xQueueSizeInBytes <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//如果队列大小为0，那么就不需要存储区</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        xQueueSizeInBytes <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token punctuation">(</span> uxQueueLength <span class="token operator">*</span> uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pxNewQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Queue_t <span class="token punctuation">)</span> <span class="token operator">+</span> xQueueSizeInBytes <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分配内存，这里申请的内存大小是队列结构体和队列中消息存储区的总大小</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewQueue <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pucQueueStorage <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> uint8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxNewQueue <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Queue_t <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">#<span class="token directive keyword">if</span>( configSUPPORT_STATIC_ALLOCATION == 1 )</span>
        <span class="token punctuation">{</span>
            pxNewQueue<span class="token operator">-&gt;</span>ucStaticallyAllocated <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configSUPPORT_STATIC_ALLOCATION */</span>
        <span class="token function">prvInitialiseNewQueue</span><span class="token punctuation">(</span> uxQueueLength<span class="token punctuation">,</span> uxItemSize<span class="token punctuation">,</span> pucQueueStorage<span class="token punctuation">,</span> ucQueueType<span class="token punctuation">,</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化队列</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pxNewQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="初始化队列prvinitialisenewqueue"><a href="#初始化队列prvinitialisenewqueue" aria-hidden="true" class="header-anchor">#</a> 初始化队列prvInitialiseNewQueue</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseNewQueue</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxQueueLength<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxItemSize<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>pucQueueStorage<span class="token punctuation">,</span> <span class="token keyword">const</span> uint8_t ucQueueType<span class="token punctuation">,</span> Queue_t <span class="token operator">*</span>pxNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> ucQueueType<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxItemSize <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token comment">//没有队列存储区，这里将pcHead指向队列开始地址</span>
		pxNewQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">=</span> <span class="token punctuation">(</span> int8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxNewQueue<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//设置pcHaed指向队列存储区首地址</span>
		pxNewQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">=</span> <span class="token punctuation">(</span> int8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pucQueueStorage<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//初始化队列结构体相关成员变量</span>
	pxNewQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">=</span> uxQueueLength<span class="token punctuation">;</span>
	pxNewQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token operator">=</span> uxItemSize<span class="token punctuation">;</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericReset</span><span class="token punctuation">(</span> pxNewQueue<span class="token punctuation">,</span> pdTRUE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位队列</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TRACE_FACILITY == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewQueue<span class="token operator">-&gt;</span>ucQueueType <span class="token operator">=</span> ucQueueType<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_TRACE_FACILITY */</span>
	<span class="token macro property">#<span class="token directive keyword">if</span>( configUSE_QUEUE_SETS == 1 )</span>
	<span class="token punctuation">{</span>
		pxNewQueue<span class="token operator">-&gt;</span>pxQueueSetContainer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_QUEUE_SETS */</span>
	<span class="token function">traceQUEUE_CREATE</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="队列复位函数xqueuegenericreset"><a href="#队列复位函数xqueuegenericreset" aria-hidden="true" class="header-anchor">#</a> 队列复位函数xQueueGenericReset</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xQueueGenericReset</span><span class="token punctuation">(</span> QueueHandle_t xQueue<span class="token punctuation">,</span> BaseType_t xNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	Queue_t <span class="token operator">*</span> <span class="token keyword">const</span> pxQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xQueue<span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> xNewQueue <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化互斥锁</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		pxQueue<span class="token operator">-&gt;</span>pcTail <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">+</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">*</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//pcTail指向队列存储区的末尾</span>
		pxQueue<span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span><span class="token comment">//队列中当前的消息数量是0</span>
		pxQueue<span class="token operator">-&gt;</span>pcWriteTo <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead<span class="token punctuation">;</span><span class="token comment">//指向队列存储区中下一个可写入的位置</span>
		pxQueue<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>pcReadFrom <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">+</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">-</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1U</span> <span class="token punctuation">)</span> <span class="token operator">*</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指向队列存储区中下一个可读取的位置</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xNewQueue <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//由于复位队列以后队列依旧是空的，对于那些从队列中读取而被阻塞的任务来说依旧保持阻塞状态。但是对于那些向队列中写入数据而阻塞的任务来说，这些任务需要接触阻塞状态</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//初始化队列中的列表xTasksWaitingToSend和xTasksWaitingToReceive</span>
			<span class="token function">vListInitialise</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">vListInitialise</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> pdPASS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="向队列发送消息"><a href="#向队列发送消息" aria-hidden="true" class="header-anchor">#</a> 向队列发送消息</h4> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xQueueSend</td> <td>发送消息到消息队列的尾部（后向入队）</td></tr> <tr><td>xQueueSendToBack</td> <td>发送消息到消息队列的尾部（后向入队）</td></tr> <tr><td>xQueueSendToFront</td> <td>发送消息到队列头（前向入队）</td></tr> <tr><td>xQueueOverwrite</td> <td>发送消息到消息队列，带覆写功能；队列满了以后自动覆盖掉旧的消息；通常用于向那些长度为1的队列发送消息</td></tr> <tr><td>xQueueSendFromISR</td> <td>发送消息到消息队列的尾部（后向入队），用于中断服务函数</td></tr> <tr><td>xQueueSendToBackFromISR</td> <td>发送消息到消息队列的尾部（后向入队），用于中断服务函数</td></tr> <tr><td>xQueueSendToFrontFromISR</td> <td>发送消息到队列头（前向入队），用于中断服务函数</td></tr> <tr><td>xQueueOverwriteFromISR</td> <td>发送消息到消息队列，带覆写功能；队列满了以后自动覆盖掉旧的消息，用于中断服务函数</td></tr></tbody></table> <h4 id="xqueuegenericsend函数"><a href="#xqueuegenericsend函数" aria-hidden="true" class="header-anchor">#</a> xQueueGenericSend函数</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xQueueGenericSend</span><span class="token punctuation">(</span> QueueHandle_t xQueue<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvItemToQueue<span class="token punctuation">,</span> TickType_t xTicksToWait<span class="token punctuation">,</span> <span class="token keyword">const</span> BaseType_t xCopyPosition <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t xEntryTimeSet <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> xYieldRequired<span class="token punctuation">;</span>
	TimeOut_t xTimeOut<span class="token punctuation">;</span>
	Queue_t <span class="token operator">*</span> <span class="token keyword">const</span> pxQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xQueue<span class="token punctuation">;</span>

	<span class="token function">configASSERT</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pvItemToQueue <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token operator">!=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xCopyPosition <span class="token operator">==</span> queueOVERWRITE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">if</span> ( ( INCLUDE_xTaskGetSchedulerState == 1 ) || ( configUSE_TIMERS == 1 ) )</span>
	<span class="token punctuation">{</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">xTaskGetSchedulerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> taskSCHEDULER_SUSPENDED <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xTicksToWait <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">&lt;</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> xCopyPosition <span class="token operator">==</span> queueOVERWRITE <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">//当队列未满或者是覆写入队，则可以将消息入队</span>
			<span class="token punctuation">{</span>
				<span class="token function">traceQUEUE_SEND</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
				xYieldRequired <span class="token operator">=</span> <span class="token function">prvCopyDataToQueue</span><span class="token punctuation">(</span> pxQueue<span class="token punctuation">,</span> pvItemToQueue<span class="token punctuation">,</span> xCopyPosition <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将消息复制到队列中</span>
				<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_QUEUE_SETS == 1 )</span>
				<span class="token punctuation">{</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>pxQueueSetContainer <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvNotifyQueueSetContainer</span><span class="token punctuation">(</span> pxQueue<span class="token punctuation">,</span> xCopyPosition <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token comment">/* The queue is a member of a queue set, and posting
							to the queue set caused a higher priority task to
							unblock. A context switch is required. */</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
							<span class="token punctuation">{</span>
								<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token keyword">else</span>
							<span class="token punctuation">{</span>
								<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xYieldRequired <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* configUSE_QUEUE_SETS */</span>
				<span class="token punctuation">{</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//检查是否有任务由于请求队列消息而阻塞，阻塞的任务会挂在队列的xTasksWaitingToReceive列表上</span>
					<span class="token punctuation">{</span>
                        <span class="token comment">//将阻塞的任务从列表xTasksWaitingToReceive上移除，并且把这个任务添加到就序列表中。如果调度器上锁，则这些任务就会挂到列表xPendingReadyList上。如果取消阻塞的任务的优先级比当前正在运行的任务优先级高，则还要标记需要进行任务切换。当函数xTaskRemoveFromEventList返回值为pdTRUE时，需要进行任务切换</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xYieldRequired <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_QUEUE_SETS */</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> pdPASS<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//队列已满，入队有阻碍</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">==</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token comment">//没有设置阻塞时间或者等待时间已到</span>
				<span class="token punctuation">{</span>
					<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">traceQUEUE_SEND_FAILED</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> errQUEUE_FULL<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xEntryTimeSet <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token comment">//设置超时时间结构体，记录当前系统始终节拍计数器的值xTickCount和溢出次数xNumOfOverflows</span>
					<span class="token function">vTaskSetTimeOutState</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTimeOut <span class="token punctuation">)</span><span class="token punctuation">;</span>
					xEntryTimeSet <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//代码执行到这里说明队列已满，而且设置了不为0的阻塞时间</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskCheckForTimeOut</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTimeOut<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xTicksToWait <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//更新xTimeOut，并检查阻塞时间是否到了</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvIsQueueFull</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span> <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//队列依旧是满的</span>
			<span class="token punctuation">{</span>
				<span class="token function">traceBLOCKING_ON_QUEUE_SEND</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">vTaskPlaceOnEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span><span class="token punctuation">,</span> xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将任务添加到队列的xTasksWaitingToSend列表和延时列表中，并且将任务从就绪列表中移除</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//阻塞时间还没有到，但是队列现在有空闲，那么就重新执行一次本循环</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token comment">//需要阻塞的时间到了</span>
		<span class="token punctuation">{</span>
			<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">traceQUEUE_SEND_FAILED</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> errQUEUE_FULL<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br></div></div><h4 id="从队列读取消息"><a href="#从队列读取消息" aria-hidden="true" class="header-anchor">#</a> 从队列读取消息</h4> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xQueueReceive</td> <td>从队列中读取消息，然后从队列中将其删除</td></tr> <tr><td>xQueuePeek</td> <td>从队列中读取消息，不会将其从队列中删除</td></tr> <tr><td>xQueueReceiveFromISR</td> <td>从队列中读取消息，然后从队列中将其删除，用于中断服务函数中</td></tr> <tr><td>xQueuePeekFromISR</td> <td>从队列中读取消息，不会将其从队列中删除，用于中断服务函数中</td></tr></tbody></table> <h2 id="freertos信号量"><a href="#freertos信号量" aria-hidden="true" class="header-anchor">#</a> FreeRTOS信号量</h2> <h4 id="二值信号量和互斥信号量的差别"><a href="#二值信号量和互斥信号量的差别" aria-hidden="true" class="header-anchor">#</a> 二值信号量和互斥信号量的差别</h4> <blockquote><ol><li>互斥信号量拥有<strong>优先级继承机制</strong>，而二值信号量没有优先级继承</li> <li>二值信号量更适用于同步，而互斥信号量适用于简单的互斥访问</li></ol></blockquote> <h4 id="二值信号量"><a href="#二值信号量" aria-hidden="true" class="header-anchor">#</a> 二值信号量</h4> <blockquote><p>二值信号量其实就是只有一个队列项的队列，这个特殊的队列要么是满的，要么是空的，正好就是二值。任务和中断使用这个特殊队列的时候不用在乎队列中存在的是什么消息，只需要知道这个队列是满的还是空的即可，可以利用这个机制来完成任务和中断之间的同步。二值信号量使用的队列是没有存储区的，队列是否为空可以通过队列结构体的成员变量uxMessagesWaiting来判断。</p></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xSemaphoreCreateBinary</td> <td>动态创建二值信号量，新创建的二值信号量默认是空的</td></tr> <tr><td>xSemaphoreCreateBinaryStatic</td> <td>静态创建二值信号量</td></tr> <tr><td>xSemaphoreGive</td> <td>任务级信号量释放函数，可用于释放二值信号量、计数型信号量和互斥信号量</td></tr> <tr><td>xSemaphoreGiveFromISR</td> <td>中断级信号量释放函数，只能用于释放二值信号量和计数型信号量，不能释放互斥信号量(因为互斥信号量需要处理 优先级继承的问题，而中断不属于任务)</td></tr> <tr><td>xSemaphoreTake</td> <td>任务级获取信号量函数，可用于获取二值信号量、计数型信号量和互斥信号量</td></tr> <tr><td>xSemaphoreTakeFromISR</td> <td>中断级获取信号量函数，只能用于获取二值信号量和计数型信号量，不能获取互斥信号量(因为互斥信号量需要处理 优先级继承的问题，而中断不属于任务)</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreCreateBinary() xQueueGenericCreate( ( UBaseType_t ) 1, semSEMAPHORE_QUEUE_ITEM_LENGTH, queueQUEUE_TYPE_BINARY_SEMAPHORE )</span>
<span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreGive( xSemaphore ) xQueueGenericSend( ( QueueHandle_t ) ( xSemaphore ), NULL, semGIVE_BLOCK_TIME, queueSEND_TO_BACK )</span>
<span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreTake( xSemaphore, xBlockTime ) xQueueGenericReceive( ( QueueHandle_t ) ( xSemaphore ), NULL, ( xBlockTime ), pdFALSE )</span>
<span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreTakeFromISR( xSemaphore, pxHigherPriorityTaskWoken )	xQueueReceiveFromISR( ( QueueHandle_t ) ( xSemaphore ), NULL, ( pxHigherPriorityTaskWoken ) )</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="计数型信号量"><a href="#计数型信号量" aria-hidden="true" class="header-anchor">#</a> 计数型信号量</h4> <blockquote><p>计数型信号量就是长度为大于1的队列，只是无需关心队列中存储了什么数据，计数型信号量主要应用场合是：</p> <ol><li><p>事件计数</p> <p>每次事件发生的时候就在事件处理函数中释放信号量（增加信号量的计数值），其他任务会获取信号量来处理事件。在这种场合中，创建的计数型信号量初始计数值为0</p></li> <li><p>资源管理</p> <p>信号量值代表当前资源的可用数量，一个任务想要获得资源的使用权，首先必须获取信号量，成功以后信号量的值就会减1，当信号量值为0的时候就说明没有资源了。一个任务使用完资源以后一定要释放信号量，释放信号量以后信号量值会加1.在这种场合中，创建的计数型信号量初始值应该是资源的数量</p></li></ol></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xSemaphoreCreateCoumting</td> <td>使用动态方法创建计数型信号量</td></tr> <tr><td>xSemaphoreCreateCountingStatic</td> <td>使用静态方法创建计数型信号量</td></tr> <tr><td>xSemaphoreGetCount</td> <td>获取计数型信号量的值</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreCreateCounting( uxMaxCount, uxInitialCount ) xQueueCreateCountingSemaphore( ( uxMaxCount ), ( uxInitialCount ) )</span>
<span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreCreateCountingStatic( uxMaxCount, uxInitialCount, pxSemaphoreBuffer ) xQueueCreateCountingSemaphoreStatic( ( uxMaxCount ), ( uxInitialCount ), ( pxSemaphoreBuffer ) )</span>
QueueHandle_t <span class="token function">xQueueCreateCountingSemaphore</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxMaxCount<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxInitialCount <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    QueueHandle_t xHandle<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxMaxCount <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxInitialCount <span class="token operator">&lt;=</span> uxMaxCount <span class="token punctuation">)</span><span class="token punctuation">;</span>

    xHandle <span class="token operator">=</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> uxMaxCount<span class="token punctuation">,</span> queueSEMAPHORE_QUEUE_ITEM_LENGTH<span class="token punctuation">,</span> queueQUEUE_TYPE_COUNTING_SEMAPHORE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//queueSEMAPHORE_QUEUE_ITEM_LENGTH=0</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> xHandle <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">(</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xHandle <span class="token punctuation">)</span><span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">=</span> uxInitialCount<span class="token punctuation">;</span><span class="token comment">//使用uxMessagesWaiting来计数</span>

        <span class="token function">traceCREATE_COUNTING_SEMAPHORE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">traceCREATE_COUNTING_SEMAPHORE_FAILED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xHandle <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xHandle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="优先级翻转"><a href="#优先级翻转" aria-hidden="true" class="header-anchor">#</a> 优先级翻转</h4> <blockquote><p>使用二值信号量的时候会遇到常见的问题——优先级翻转，优先级翻转在可剥夺内核中是非常常见的，在实时系统中不允许出现这种现场，这样会破坏任务的预期顺序。</p> <p>常见场合描述如下：</p> <p>当一个低优先级和一个高优先级任务同时使用同一个信号量，而系统中还有其他中等优先级任务时，如果低 优先级任务获得了信号量，那么高优先级的任务就会处于等待状态；但是，中等优先级的任务可以打断低优先级任务而先于高优先级任务运行（此时高优先级的任务在等待信号量，所以不能运行），这就出现了优先级翻转的现象。</p></blockquote> <h4 id="互斥信号量"><a href="#互斥信号量" aria-hidden="true" class="header-anchor">#</a> 互斥信号量</h4> <blockquote><p>互斥信号量其实就是一个拥有优先级继承的二值信号量，在同步的应用中，二值信号量最适合。互斥信号量适合用于那些需要互斥访问的应用中。当一个互斥信号量正在被一个低优先级的任务使用，而此时有个高优先级的任务也尝试获取这个互斥信号量的话就会被阻塞。不过这个高优先级的任务会将低优先级任务的优先级提升到与自己相同的优先级，这个过程就是优先级继承。优先级继承尽可能地降低了高优先级任务处于阻塞态的时间，并且将已经出现的“优先级翻转“的影响降到最低。</p></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xSemaphoreCreateMutex</td> <td>使用动态方法创建互斥信号量</td></tr> <tr><td>xSemaphoreCreateMutexStatic</td> <td>使用静态方法创建互斥信号量</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> xSemaphoreCreateMutex() xQueueCreateMutex( queueQUEUE_TYPE_MUTEX )</span>
QueueHandle_t <span class="token function">xQueueCreateMutex</span><span class="token punctuation">(</span> <span class="token keyword">const</span> uint8_t ucQueueType <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Queue_t <span class="token operator">*</span>pxNewQueue<span class="token punctuation">;</span>
    <span class="token keyword">const</span> UBaseType_t uxMutexLength <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">,</span> uxMutexSize <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span>

    pxNewQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> uxMutexLength<span class="token punctuation">,</span> uxMutexSize<span class="token punctuation">,</span> ucQueueType <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prvInitialiseMutex</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pxNewQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseMutex</span><span class="token punctuation">(</span> Queue_t <span class="token operator">*</span>pxNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewQueue <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pxNewQueue<span class="token operator">-&gt;</span>pxMutexHolder <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        pxNewQueue<span class="token operator">-&gt;</span>uxQueueType <span class="token operator">=</span> queueQUEUE_IS_MUTEX<span class="token punctuation">;</span>
        pxNewQueue<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>uxRecursiveCallCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//针对递归互斥信号量的计数器</span>
        <span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxNewQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化CPU内核的自旋锁</span>
        <span class="token function">traceCREATE_MUTEX</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericSend</span><span class="token punctuation">(</span> pxNewQueue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">,</span> queueSEND_TO_BACK <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//互斥信号量默认创建后就是有效的</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">traceCREATE_MUTEX_FAILED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span>portMUX_TYPE <span class="token operator">*</span>mux<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	mux<span class="token operator">-&gt;</span>owner<span class="token operator">=</span>portMUX_FREE_VAL<span class="token punctuation">;</span>
	mux<span class="token operator">-&gt;</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 为了处理多核CPU带来的竞态，使用该结构体实现的“自旋锁” */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* owner field values:
	 * 0                - Uninitialized (invalid)
	 * portMUX_FREE_VAL - Mux is free, can be locked by either CPU
	 * CORE_ID_PRO / CORE_ID_APP - Mux is locked to the particular core
	 *
	 * Any value other than portMUX_FREE_VAL, CORE_ID_PRO, CORE_ID_APP indicates corruption
	 */</span>
	uint32_t owner<span class="token punctuation">;</span>
	<span class="token comment">/* count field:
	 * If mux is unlocked, count should be zero.
	 * If mux is locked, count is non-zero &amp; represents the number of recursive locks on the mux.
	 */</span>
	uint32_t count<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FREERTOS_PORTMUX_DEBUG</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>lastLockedFn<span class="token punctuation">;</span>
	<span class="token keyword">int</span> lastLockedLine<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span> portMUX_TYPE<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="递归互斥信号量"><a href="#递归互斥信号量" aria-hidden="true" class="header-anchor">#</a> 递归互斥信号量</h4> <blockquote><p>已经获取了互斥信号量的任务就不能再次获取这个互斥信号量，但是递归互斥信号量不同，已经获取了递归互斥信号量的任务可以再次获取这个递归互斥信号量，而且次数不限。递归互斥信号量也有优先级继承的机制，所以任务使用完递归互斥信号量以后一定要记得释放。</p></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xSemaphoreCreateRecursiveMutex</td> <td>使用动态方法创建递归互斥信号量</td></tr> <tr><td>xSemaphoreCreateRecursiveMutexStatic</td> <td>使用静态方法创建递归互斥信号量</td></tr> <tr><td>xSemaphoreGiveRecursive</td> <td>释放递归互斥信号量</td></tr> <tr><td>xSemaphoreTakeRecursive</td> <td>获取递归互斥信号量</td></tr></tbody></table> <h2 id="freertos软件定时器"><a href="#freertos软件定时器" aria-hidden="true" class="header-anchor">#</a> FreeRTOS软件定时器</h2> <blockquote><p>软件定时器的回调函数是在定时器服务任务中执行的，所以一定不能在回调函数中调用任何会阻塞任务的API函数，比如定时器回调函数中千万不能调用vTaskDelay、vTaskDelayUntil，还有一些访问队列或者信号量的非零阻塞时间的API函数也不能调用。FreeRTOS提供了很多定时器相关的API函数，这些API函数大多使用FreeRTOS的队列发送命令给定时器服务任务，这个队列叫定时器命令队列，是供给FreeRTOS的软件定时器使用的，用户不能直接访问。</p></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xTimerReset()</td> <td>复位软件定时器</td></tr> <tr><td>xTimerResetFromISR()</td> <td>复位软件定时器，用在中断服务函数中</td></tr> <tr><td>xTimerCreate()</td> <td>使用动态方法创建软件定时器</td></tr> <tr><td>xTimerCreateStatic()</td> <td>使用静态方法创建软件定时器</td></tr> <tr><td>xTimerStart()</td> <td>开启软件定时器，用于任务中</td></tr> <tr><td>xTimerStartFromISR()</td> <td>开启软件定时器，用于中断中</td></tr> <tr><td>xTimerStop()</td> <td>停止软件定时器，用于任务中</td></tr> <tr><td>xTimerStopFromISR()</td> <td>停止软件定时器，用于中断中</td></tr></tbody></table> <h2 id="freertos事件标志组"><a href="#freertos事件标志组" aria-hidden="true" class="header-anchor">#</a> FreeRTOS事件标志组</h2> <blockquote><p>使用信号量同步时任务只能与单个的事件或任务进行同步，有时候某个任务可能需要与多个事件或任务进行同步，此时信号量就无能为力了。FreeRTOS为此提供了一个可选的解决办法——事件标志组。事件标志组的数据类型为EventGroupHandle_t，当configUSE_16_BIT_TICKS为1的时候，则事件标志组可以存储8个事件位；当configUSE_16_BIT_TICKS为0的时候，则事件标志组存储24个事件位。事件标志组中的所有事件位都存储在一个无符号的EventBits_t类型的变量中</p></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xEventGroupCreate()</td> <td>使用动态方法创建事件标志组</td></tr> <tr><td>xEventGroupCreateStatic()</td> <td>使用静态方法创建事件标志组</td></tr> <tr><td>xEventGroupClearBits()</td> <td>将指定的事件位清零，用在任务中</td></tr> <tr><td>xEventGroupClearBitsFromISR()</td> <td>将指定的事件位清零，用在中断服务函数中</td></tr> <tr><td>xEventGroupSetBits()</td> <td>将指定的事件位置1，用在任务中</td></tr> <tr><td>xEventGroupSetBitsFromISR()</td> <td>将指定的事件位置1，用在中断服务函数中</td></tr> <tr><td>xEventGroupGetBits()</td> <td>获取当前事件标志组的值（各个事件的值），用在任务中</td></tr> <tr><td>xEventGroupGetBitsFromISR()</td> <td>获取当前事件标志组的值，用在中断服务函数中</td></tr> <tr><td>xEventGroupWaitBits()</td> <td>等待指定的事件位</td></tr></tbody></table> <h2 id="freertos任务通知"><a href="#freertos任务通知" aria-hidden="true" class="header-anchor">#</a> FreeRTOS任务通知</h2> <blockquote><p>FreeRTOS的每个任务都有一个32位的通知值，任务控制块中的成员变量ulNotifiedValue就是这个通知值。任务通知是一个事件，假如某个任务通知的接收任务因为等待任务通知而阻塞，则向这个接收任务发送任务通知以后就会解除这个任务的阻塞状态。也可以更新接收任务的任务通知值，可以通过以下方法更新接收任务的通知值：</p> <ol><li>不覆盖接收任务的通知值（如果上次发送给接收任务的通知还没被处理）</li> <li>覆盖接收任务的通知值</li> <li>更新接收任务的通知值的一个或多个bit</li> <li>增加接收任务的通知值</li></ol> <p>合理使用上面这些更改任务通知值的方法可以在一些场合中替代队列、二值信号量、计数型信号量和事件标志组，并且可以提高速度，减少RAM的使用量。</p> <p>任务通知的局限：</p> <ul><li>FreeRTOS的任务通知只能有一个接收任务，其实大多数的应用都是这种情况</li> <li>接收任务可以因为接收任务通知而进入阻塞态，但是发送任务不会因为任务通知发送失败而阻塞</li></ul></blockquote> <table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>xTaskNotify</td> <td>发送通知，带有通知值并且不保留接收任务原通知值，用在任务中</td></tr> <tr><td>xTaskNotifyFromISR</td> <td>发送通知，函数xTaskNotify的中断版本</td></tr> <tr><td>xTaskNotifyGive</td> <td>发送通知，不带通知值并且不保留接收任务的通知值，此函数会将接收任务的通知值加1，用于任务中</td></tr> <tr><td>vTaskNotifyGiveFromISR</td> <td>发送通知，函数xTaskNotifyGive的中断版本</td></tr> <tr><td>xTaskNotifyAndQuery</td> <td>发送通知，带有通知值并且保留接收任务的原通知值，用在任务中</td></tr> <tr><td>xTaskNotifyAndQueryFromISR</td> <td>发送通知，函数xTaskNotifyAndQuery的中断版本，用在中断服务函数中</td></tr> <tr><td>ulTaskNotifyTake</td> <td>获取任务通知，可以设置在退出此函数的时候将任务通知值清零或者减一。当任务通知用作二值信号量或者计数信号量的时候，使用此函数来获取信号量</td></tr> <tr><td>xTaskNotifyWait</td> <td>等待任务通知，比ulTaskNotifyTask更为强大，全功能版任务通知获取函数</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xTaskNotify</span><span class="token punctuation">(</span> TaskHandle_t xTaskToNotify<span class="token punctuation">,</span> uint32_t ulValue<span class="token punctuation">,</span> eNotifyAction eAction <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span> pxTCB<span class="token punctuation">;</span>
    eNotifyValue eOriginalNotifyState<span class="token punctuation">;</span>
    BaseType_t xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xTaskToNotify <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pxTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> xTaskToNotify<span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        eOriginalNotifyState <span class="token operator">=</span> pxTCB<span class="token operator">-&gt;</span>eNotifyState<span class="token punctuation">;</span><span class="token comment">//保存当前任务通知状态</span>
        pxTCB<span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotified<span class="token punctuation">;</span><span class="token comment">//更新任务通知状态为eNotified</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span> eAction <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">case</span> eSetBits<span class="token operator">:</span>
                pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">|=</span> ulValue<span class="token punctuation">;</span><span class="token comment">//更新接收任务通知值的一个或多个bit</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eIncrement<span class="token operator">:</span>
                <span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//将任务通知值加1</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eSetValueWithOverwrite<span class="token operator">:</span>
                pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> ulValue<span class="token punctuation">;</span><span class="token comment">//直接覆写原来的任务通知值</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eSetValueWithoutOverwrite<span class="token operator">:</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> eOriginalNotifyState <span class="token operator">!=</span> eNotified <span class="token punctuation">)</span><span class="token comment">//原来的任务通知已经被处理</span>
                <span class="token punctuation">{</span>
                    pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> ulValue<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span><span class="token comment">//原来的任务通知没有被处理</span>
                <span class="token punctuation">{</span>
                    xReturn <span class="token operator">=</span> pdFAIL<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eNoAction<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//判断任务是否因为等待任务通知值而进入了阻塞态</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> eOriginalNotifyState <span class="token operator">==</span> eWaitingNotification <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将任务从状态列表中移除</span>
            <span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将任务重新添加到就绪列表</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">tskCAN_RUN_HERE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&gt;</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token comment">//判断刚刚解除阻塞的任务优先级是否比当前正在运行的任务优先级高</span>
            <span class="token punctuation">{</span>
                <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">!=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">,</span> pxTCB<span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> xReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
uint32_t <span class="token function">ulTaskNotifyTake</span><span class="token punctuation">(</span> BaseType_t xClearCountOnExit<span class="token punctuation">,</span> TickType_t xTicksToWait <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    uint32_t ulReturn<span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span><span class="token comment">//还没有接收到任务通知</span>
        <span class="token punctuation">{</span>
            pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eWaitingNotification<span class="token punctuation">;</span><span class="token comment">//任务通知状态改为eWaitingNotification</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">&gt;</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//将任务添加到延时列表，并进行任务调度</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token macro property">#<span class="token directive keyword">if</span> ( INCLUDE_vTaskSuspend == 1 )</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">==</span> portMAX_DELAY <span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">traceMOVED_TASK_TO_SUSPENDED_LIST</span><span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToWait<span class="token punctuation">;</span>
                        <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* INCLUDE_vTaskSuspend */</span>
                <span class="token punctuation">{</span>
                    xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToWait<span class="token punctuation">;</span>
                    <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* INCLUDE_vTaskSuspend */</span>
                <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        ulReturn <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue<span class="token punctuation">;</span><span class="token comment">//任务通知值不为0，则先获取任务通知值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> ulReturn <span class="token operator">!=</span> <span class="token number">0UL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> xClearCountOnExit <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotWaitingNotification<span class="token punctuation">;</span><span class="token comment">//更新任务通知状态为eNotWaitingNotification</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ulReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br></div></div><h2 id="freertos中的空闲任务"><a href="#freertos中的空闲任务" aria-hidden="true" class="header-anchor">#</a> FreeRTOS中的空闲任务</h2> <blockquote><p>空闲任务不仅仅是为了满足任务调度器启动以后至少有一个任务运行而创建的，空闲任务中还会去做一些其他的事情，如下：</p> <ol><li>判断系统中是否有任务删除自己，如果有，则在空闲任务中释放被删除任务的任务堆栈和任务控制块的内存</li> <li>运行用户设置的空闲任务钩子函数</li> <li>判断是否开启低功耗tickless模式，如果开启，则还需要做相应的处理</li></ol> <p>用户可以创建与空闲任务优先级相同的应用任务，当宏configIDLE_SHOULD_YIELD为1时，空闲任务会让出时间片给相同优先级的应用任务。</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token function">portTASK_FUNCTION</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> pvParameters <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//检查是否有任务要删除自己，如果有，则释放这些任务的任务控制块TCP和任务堆栈的内存</span>
		<span class="token function">prvCheckTasksWaitingTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_PREEMPTION == 0 )</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//如果没有使用抢占式内核，则强制执行一次任务切换，查看是否有其他任务有效；如果有使用抢占式内核，则不需要这一步，因为只要有任何任务就绪，之后都会自动抢夺CPU使用权</span>
			<span class="token function">taskYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_PREEMPTION */</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( ( configUSE_PREEMPTION == 1 ) &amp;&amp; ( configIDLE_SHOULD_YIELD == 1 ) )</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//如果使用抢占式内核并且使能时间片调度，则当有任务和空闲任务共享一个优先级，并且此任务处于就绪态时，空闲任务就应该放弃本时间片，将本时间片剩余的时间让给这个就绪任务。</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listCURRENT_LIST_LENGTH</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> tskIDLE_PRIORITY <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ( ( configUSE_PREEMPTION == 1 ) &amp;&amp; ( configIDLE_SHOULD_YIELD == 1 ) ) */</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_IDLE_HOOK == 1 )</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationIdleHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//执行用户定义的空闲任务钩子函数，注意钩子函数里面不能使用任何可以引起阻塞空闲任务的API函数</span>
			<span class="token function">vApplicationIdleHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_IDLE_HOOK */</span>
		<span class="token punctuation">{</span>
			<span class="token comment">/* Call the esp-idf hook system */</span>
			<span class="token function">esp_vApplicationIdleHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//如果使能了Tickless模式，则执行相关的处理代码</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> ( configUSE_TICKLESS_IDLE != 0 )</span>
		<span class="token punctuation">{</span>
			TickType_t xExpectedIdleTime<span class="token punctuation">;</span>
			BaseType_t xEnteredSleep <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
			<span class="token comment">//获取处理器进入低功耗模式的时长</span>
			xExpectedIdleTime <span class="token operator">=</span> <span class="token function">prvGetExpectedIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">{</span>
					<span class="token comment">//重新采集一次时间值</span>
					<span class="token function">configASSERT</span><span class="token punctuation">(</span> xNextTaskUnblockTime <span class="token operator">&gt;=</span> xTickCount <span class="token punctuation">)</span><span class="token punctuation">;</span>
					xExpectedIdleTime <span class="token operator">=</span> <span class="token function">prvGetExpectedIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token function">traceLOW_POWER_IDLE_BEGIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						xEnteredSleep <span class="token operator">=</span> <span class="token function">portSUPPRESS_TICKS_AND_SLEEP</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//FreeRTOS进入低功耗Tickless模式</span>
						<span class="token function">traceLOW_POWER_IDLE_END</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>xEnteredSleep <span class="token punctuation">)</span><span class="token comment">//FreeRTOS没有真的进入Tickless模式</span>
			<span class="token punctuation">{</span>
				<span class="token function">esp_vApplicationWaitiHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CPU进入低功耗模式</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">else</span></span>
		<span class="token function">esp_vApplicationWaitiHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* configUSE_TICKLESS_IDLE */</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h2 id="freertos低功耗tickless模式"><a href="#freertos低功耗tickless模式" aria-hidden="true" class="header-anchor">#</a> FreeRTOS低功耗Tickless模式</h2> <blockquote><p>当处理器进入空闲任务周期以后就会关闭系统节拍中断（滴答定时器中断），只有其他中断发生或者其他任务需要处理的时候，处理器才会被从低功耗模式中唤醒。为此将会面临两大问题：</p> <ol><li>关闭系统节拍中断会导致系统节拍计数器停止，系统时钟就会停止。
<ul><li>我们需要记录下系统节拍中断的关闭时间，当系统节拍中断再次开启运行的时候补上这段时间即可，这时候就需要使用定时器来记录这段该补上的时间</li></ul></li> <li>如何保证下一个要运行的任务能被准确地唤醒？
<ul><li>处理器在进入低功耗模式之前获取还有多长时间运行下一个任务，开启定时器，定时周期设置为这个时间，定时时间到了则产生定时中断，处理器就从低功耗模式唤醒了</li></ul></li></ol></blockquote> <h4 id="tickless的具体实现"><a href="#tickless的具体实现" aria-hidden="true" class="header-anchor">#</a> Tickless的具体实现</h4> <ol><li>要想使用Tickless模式，则必须首先将FreeRTOSConfig.h中的宏configUSE_TICKLESS_IDLE设置为1</li> <li>使能Tickless模式以后，当下面两种情况都出现的时候，FreeRTOS内核就会调用宏portSUPPRESS_TICKS_AND_SLEEP来处理低功耗相关的工作:
<ul><li>空闲任务是当前唯一可运行的任务，因为其他所有的任务都处于阻塞或者挂起态</li> <li>系统处于低功耗模式的时间至少大于configEXPECTED_IDLE_TIME_BEFORE_SLEEP个时钟节拍</li></ul></li> <li>处理器工作在低功耗模式的时间虽说没有任何限制，一个时钟节拍也行、滴答定时器所能计时的最大值也行，但是时间太短意义也不大，所以必须对工作在低功耗模式的时间做个限制，不能太短了，宏config EXPECTED_IDLE_TIME_BEFORE_SLEEP就是用来实现这个功能的</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> portSUPPRESS_TICKS_AND_SLEEP( idleTime ) vApplicationSleep( idleTime )</span>
bool IRAM_ATTR <span class="token function">vApplicationSleep</span><span class="token punctuation">(</span> TickType_t xExpectedIdleTime <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool result <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">portENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_switch_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_mode <span class="token operator">==</span> PM_MODE_LIGHT_SLEEP <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s_is_switching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//计算可以睡眠的时长</span>
        int64_t next_esp_timer_alarm <span class="token operator">=</span> <span class="token function">esp_timer_get_next_alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int64_t now <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int64_t time_until_next_alarm <span class="token operator">=</span> next_esp_timer_alarm <span class="token operator">-</span> now<span class="token punctuation">;</span>
        int64_t wakeup_delay_us <span class="token operator">=</span> portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span> <span class="token operator">*</span> xExpectedIdleTime<span class="token punctuation">;</span>
        int64_t sleep_time_us <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>wakeup_delay_us<span class="token punctuation">,</span> time_until_next_alarm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sleep_time_us <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token operator">*</span> portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">esp_sleep_enable_timer_wakeup</span><span class="token punctuation">(</span>sleep_time_us <span class="token operator">-</span> LIGHT_SLEEP_EARLY_WAKEUP_US<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PM_TRACE</span>
            <span class="token comment">/* to force tracing GPIOs to keep state */</span>
            <span class="token function">esp_sleep_pd_config</span><span class="token punctuation">(</span>ESP_PD_DOMAIN_RTC_PERIPH<span class="token punctuation">,</span> ESP_PD_OPTION_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
            <span class="token keyword">int</span> core_id <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ESP_PM_TRACE_ENTER</span><span class="token punctuation">(</span>SLEEP<span class="token punctuation">,</span> core_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            int64_t sleep_start <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">esp_light_sleep_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始睡眠</span>
            int64_t slept_us <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sleep_start<span class="token punctuation">;</span>
            <span class="token function">ESP_PM_TRACE_EXIT</span><span class="token punctuation">(</span>SLEEP<span class="token punctuation">,</span> core_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            uint32_t slept_ticks <span class="token operator">=</span> slept_us <span class="token operator">/</span> <span class="token punctuation">(</span>portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slept_ticks <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//根据实际休眠的时间来调整系统滴答计数器的值</span>
                <span class="token function">vTaskStepTick</span><span class="token punctuation">(</span>slept_ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//触发tick中断</span>
                <span class="token function">XTHAL_SET_CCOUNT</span><span class="token punctuation">(</span><span class="token function">XTHAL_GET_CCOMPARE</span><span class="token punctuation">(</span>XT_TIMER_INDEX<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">XTHAL_GET_INTERRUPT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token function">BIT</span><span class="token punctuation">(</span>XT_TIMER_INTNUM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            result <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">portEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_switch_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/others/freertos.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">8/16/2019, 9:47:13 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.f7de9bec.js" defer></script><script src="/blog/assets/js/2.a6386433.js" defer></script><script src="/blog/assets/js/39.6a95c848.js" defer></script><script src="/blog/assets/js/6.fc06098a.js" defer></script>
  </body>
</html>
