<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suda-morris ä¸ªäººåšå®¢</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="manifest" href="/blog/manifest.json">
    <meta name="description" content="è®°å½•å­¦ä¹ ç”Ÿæ´»ï¼Œæ¢ç´¢æœªçŸ¥é¢†åŸŸ">
    <link rel="preload" href="/blog/assets/css/0.styles.91231688.css" as="style"><link rel="preload" href="/blog/assets/js/app.c99cf932.js" as="script"><link rel="preload" href="/blog/assets/js/4.879095c8.js" as="script"><link rel="preload" href="/blog/assets/js/45.ef41e1bf.js" as="script"><link rel="preload" href="/blog/assets/js/9.6d0c3494.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ae56156a.js"><link rel="prefetch" href="/blog/assets/js/11.ab8575fe.js"><link rel="prefetch" href="/blog/assets/js/12.00e807f7.js"><link rel="prefetch" href="/blog/assets/js/13.1b34894f.js"><link rel="prefetch" href="/blog/assets/js/14.6b262d55.js"><link rel="prefetch" href="/blog/assets/js/15.503782b2.js"><link rel="prefetch" href="/blog/assets/js/16.cef0b2a5.js"><link rel="prefetch" href="/blog/assets/js/17.77d455c4.js"><link rel="prefetch" href="/blog/assets/js/18.d9f3619c.js"><link rel="prefetch" href="/blog/assets/js/19.c232406d.js"><link rel="prefetch" href="/blog/assets/js/2.dfc2fd2f.js"><link rel="prefetch" href="/blog/assets/js/20.690d9998.js"><link rel="prefetch" href="/blog/assets/js/21.a009894a.js"><link rel="prefetch" href="/blog/assets/js/22.58736d73.js"><link rel="prefetch" href="/blog/assets/js/23.fafdf039.js"><link rel="prefetch" href="/blog/assets/js/24.9a3ea698.js"><link rel="prefetch" href="/blog/assets/js/25.d8b95ef6.js"><link rel="prefetch" href="/blog/assets/js/26.73376ffc.js"><link rel="prefetch" href="/blog/assets/js/27.a13581ba.js"><link rel="prefetch" href="/blog/assets/js/28.f8e329a1.js"><link rel="prefetch" href="/blog/assets/js/29.c2308395.js"><link rel="prefetch" href="/blog/assets/js/3.62d75057.js"><link rel="prefetch" href="/blog/assets/js/30.7d39ceff.js"><link rel="prefetch" href="/blog/assets/js/31.9d2b9f5c.js"><link rel="prefetch" href="/blog/assets/js/32.521c59b5.js"><link rel="prefetch" href="/blog/assets/js/33.99e33e23.js"><link rel="prefetch" href="/blog/assets/js/34.7f867a89.js"><link rel="prefetch" href="/blog/assets/js/35.d0f19d91.js"><link rel="prefetch" href="/blog/assets/js/36.468324cb.js"><link rel="prefetch" href="/blog/assets/js/37.acb1b76c.js"><link rel="prefetch" href="/blog/assets/js/38.7b7f930d.js"><link rel="prefetch" href="/blog/assets/js/39.25f4bf76.js"><link rel="prefetch" href="/blog/assets/js/40.55667e41.js"><link rel="prefetch" href="/blog/assets/js/41.1b6d2012.js"><link rel="prefetch" href="/blog/assets/js/42.9c448da2.js"><link rel="prefetch" href="/blog/assets/js/43.d01afb55.js"><link rel="prefetch" href="/blog/assets/js/44.001e33b4.js"><link rel="prefetch" href="/blog/assets/js/46.f57563de.js"><link rel="prefetch" href="/blog/assets/js/47.b2e7ef01.js"><link rel="prefetch" href="/blog/assets/js/48.bf213af7.js"><link rel="prefetch" href="/blog/assets/js/49.8841a39f.js"><link rel="prefetch" href="/blog/assets/js/5.b5b8adea.js"><link rel="prefetch" href="/blog/assets/js/50.b448b4ae.js"><link rel="prefetch" href="/blog/assets/js/51.8aeca0cb.js"><link rel="prefetch" href="/blog/assets/js/52.13e77197.js"><link rel="prefetch" href="/blog/assets/js/53.450ccc2e.js"><link rel="prefetch" href="/blog/assets/js/54.cc40ddd5.js"><link rel="prefetch" href="/blog/assets/js/55.32e96a5e.js"><link rel="prefetch" href="/blog/assets/js/56.a396bf02.js"><link rel="prefetch" href="/blog/assets/js/57.4c000e39.js"><link rel="prefetch" href="/blog/assets/js/58.bd95ae7e.js"><link rel="prefetch" href="/blog/assets/js/59.98093720.js"><link rel="prefetch" href="/blog/assets/js/6.45f6babe.js"><link rel="prefetch" href="/blog/assets/js/60.59de88b4.js"><link rel="prefetch" href="/blog/assets/js/61.3e72ef1f.js"><link rel="prefetch" href="/blog/assets/js/62.17df0bab.js"><link rel="prefetch" href="/blog/assets/js/63.59ed8142.js"><link rel="prefetch" href="/blog/assets/js/64.0dfda8d3.js"><link rel="prefetch" href="/blog/assets/js/65.e86b719b.js"><link rel="prefetch" href="/blog/assets/js/66.b2f7e66e.js"><link rel="prefetch" href="/blog/assets/js/67.bed0f0c0.js"><link rel="prefetch" href="/blog/assets/js/68.30924d85.js"><link rel="prefetch" href="/blog/assets/js/69.ff467e71.js"><link rel="prefetch" href="/blog/assets/js/7.36d15a78.js"><link rel="prefetch" href="/blog/assets/js/70.66ccdf30.js"><link rel="prefetch" href="/blog/assets/js/71.7b95dd74.js"><link rel="prefetch" href="/blog/assets/js/72.a7060637.js"><link rel="prefetch" href="/blog/assets/js/73.aaf5e480.js"><link rel="prefetch" href="/blog/assets/js/74.2e6da911.js"><link rel="prefetch" href="/blog/assets/js/75.4811e33a.js"><link rel="prefetch" href="/blog/assets/js/76.9fadcb8b.js"><link rel="prefetch" href="/blog/assets/js/77.881cd289.js"><link rel="prefetch" href="/blog/assets/js/78.631b19fd.js"><link rel="prefetch" href="/blog/assets/js/79.8658c7a9.js"><link rel="prefetch" href="/blog/assets/js/8.d7976355.js"><link rel="prefetch" href="/blog/assets/js/80.1c308107.js"><link rel="prefetch" href="/blog/assets/js/81.d61f3086.js"><link rel="prefetch" href="/blog/assets/js/82.ff0e2604.js"><link rel="prefetch" href="/blog/assets/js/83.fb04b4ee.js"><link rel="prefetch" href="/blog/assets/js/84.1d9a41b7.js"><link rel="prefetch" href="/blog/assets/js/85.38143805.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.91231688.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris ä¸ªäººåšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">
  Others
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://asciiflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ascii Flow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://repl.it/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Browser Based IDE (repl)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://qwerty.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Unicode Tools
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diagrams
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://explainshell.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Explain Shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.figma.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Figma
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://send.firefox.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  File Sharing
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.neat-reader.com/webapp#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Neat Reader
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Community" class="dropdown-title"><span class="title">Community</span> <span class="arrow down"></span></button> <button type="button" aria-label="Community" class="mobile-dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.huaweicloud.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HuaWei Mirrors
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TUNA
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://goalkicker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GoalKicker Free Programming Books
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">
  CS
</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">
  EE
</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">
  Others
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://asciiflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ascii Flow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://repl.it/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Browser Based IDE (repl)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://qwerty.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Unicode Tools
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://devdocs.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  DevDocs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diagrams
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://explainshell.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Explain Shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.figma.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Figma
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://send.firefox.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  File Sharing
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.neat-reader.com/webapp#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Neat Reader
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Community" class="dropdown-title"><span class="title">Community</span> <span class="arrow down"></span></button> <button type="button" aria-label="Community" class="mobile-dropdown-title"><span class="title">Community</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://bootlin.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bootlin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.huaweicloud.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HuaWei Mirrors
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TUNA
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://goalkicker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GoalKicker Free Programming Books
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/others/about.html" class="sidebar-link">å…³äºæœ¬æ ç›®</a></li><li><a href="/blog/others/markdown.html" class="sidebar-link">ğ™ˆğ™–ğ™§ğ™ ğ™™ğ™¤ğ™¬ğ™£ åŸºæœ¬è¯­æ³•</a></li><li><a href="/blog/others/mdp-template.html" class="sidebar-link">ğ™¢ğ™™ğ™¥ æ¼”ç¤ºæ–‡ç¨¿</a></li><li><a href="/blog/others/oral_english.html" class="sidebar-link">å¸¸ç”¨å£è¯­</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>title: FreeRTOS Introduction---Based on ESP32
tags:</p> <ul><li>FreeRTOS
categories:</li> <li>Geek Hobbies
author: suda-morris
date: 2018-05-30 20:56:00</li></ul> <hr> <h2 id="freertosç³»ç»Ÿé…ç½®"><a href="#freertosç³»ç»Ÿé…ç½®" class="header-anchor">#</a> FreeRTOSç³»ç»Ÿé…ç½®</h2> <blockquote><p>FreeRTOSçš„ç³»ç»Ÿé…ç½®æ–‡ä»¶ä¸ºFreeRTOSConfig.hï¼Œåœ¨æ­¤é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å®ŒæˆFreeRTOSçš„è£å‰ªå’Œé…ç½®ã€‚FreeRTOSä¸­çš„è£å‰ªå’Œé…ç½®ä½¿ç”¨æ¡ä»¶ç¼–è¯‘çš„æ–¹å¼æ¥å®ç°ã€‚</p></blockquote> <ul><li>&quot;INCLUDE_&quot;å¼€å§‹çš„å®ï¼Œç”¨æ¥è¡¨ç¤ºä½¿èƒ½æˆ–è€…å¤±èƒ½FreeRTOSä¸­çš„ç›¸åº”APIå‡½æ•°ï¼Œæ¯”å¦‚<code>INCLUDE_vTaskPrioritySet</code>ç”¨æ¥å†³å®šæ˜¯å¦å¯ä»¥ä½¿ç”¨vTaskPrioritySetå‡½æ•°</li> <li>&quot;config&quot;å¼€å§‹çš„å®ä¹Ÿç”¨æ¥å¯¹FreeRTOSçš„è¿›è¡Œè£å‰ªå’Œé…ç½®ï¼Œæ¯”å¦‚
<ul><li><code>configAPPLICATION_ALLOCATED_HEAP</code>å®ï¼Œå¦‚æœä¸å¼€å¯ï¼Œé‚£ä¹ˆFreeRTOSçš„å †å†…å­˜ç”±ç¼–è¯‘å™¨åˆ†é…ï¼Œå¼€å¯åï¼Œå †å†…å­˜å°†ç”±ç”¨æˆ·è‡ªè¡Œè®¾ç½®
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PE0q2D.png" alt="configASSERTè®¾ç½®"></li></ul></li> <li><code>configCHECK_FOR_STACK_OVERFLOW</code>å®å¦‚æœä¸ä¸ºé›¶ï¼Œç”¨æˆ·å¿…é¡»æä¾›ä¸€ä¸ªé’©å­å‡½æ•°<code>vApplicationStackOverflowHook</code> <ul><li><img src="https://s1.ax1x.com/2018/07/03/PEB4SS.png" alt="PEB4SS.png"></li> <li>å½“å †æ ˆæº¢å‡ºå¤ªä¸¥é‡æ—¶å¯èƒ½ä¼šæŸæ¯è¯¥å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡æŸ¥çœ‹å˜é‡pxCurrentTCBæ¥ç¡®å®šå“ªä¸ªä»»åŠ¡å‘ç”Ÿäº†å †æ ˆæº¢å‡º</li> <li><code>vApplicationStackOverflowHook( ( TaskHandle_t ) pxCurrentTCB[ xPortGetCoreID() ], pxCurrentTCB[ xPortGetCoreID() ]-&gt;pcTaskName );</code></li> <li>å †æ ˆæº¢å‡ºæœ‰ä¸¤ç§æ£€æµ‹æ–¹æ³•ï¼š
<ul><li>æ–¹æ³•1ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™éœ€è¦ä¿å­˜ç°åœºï¼Œç°åœºæ˜¯ä¿å­˜åœ¨å †æ ˆä¸­çš„ï¼Œè¿™ä¸ªæ—¶å€™ä»»åŠ¡å †æ ˆä½¿ç”¨ç‡å¾ˆå¯èƒ½è¾¾åˆ°æœ€å¤§å€¼ï¼Œæ–¹æ³•1å°±æ˜¯ä¸æ–­æ£€æµ‹ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ˜¯å¦æŒ‡å‘æœ‰æ•ˆç©ºé—´ï¼Œå¦‚æœæŒ‡å‘äº†æ— æ•ˆç©ºé—´ï¼Œåˆ™è°ƒç”¨é’©å­å‡½æ•°ã€‚è¯¥æ–¹æ³•çš„ç‰¹ç‚¹æ˜¯å¿«ï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½æ£€æµ‹æ‰€æœ‰çš„å †æ ˆæº¢å‡º</li> <li>æ–¹æ³•2ï¼šåœ¨åˆ›å»ºä»»åŠ¡çš„æ—¶å€™å‘ä»»åŠ¡å †æ ˆå¡«å……ä¸€ä¸ªå·²çŸ¥çš„æ ‡è®°å€¼ï¼Œç„¶åæ£€æµ‹å †æ ˆåé¢çš„å‡ ä¸ªå­—èŠ‚æ˜¯å¦è¢«æ”¹å†™ï¼Œå¦‚æœè¢«æ”¹å†™ï¼Œåˆ™è°ƒç”¨é’©å­å‡½æ•°ï¼Œæ–¹æ³•2å‡ ä¹èƒ½å¤Ÿæ£€æµ‹åˆ°æ‰€æœ‰çš„å †æ ˆæº¢å‡º</li></ul></li></ul></li> <li><code>configMAX_PRIORITIES</code>è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§æ•°é‡ï¼Œè®¾ç½®å¥½åä»»åŠ¡å°±å¯ä»¥ä½¿ç”¨ä»0ï½configMAX_PRIORITIES-1çš„ä¼˜å…ˆçº§ï¼Œå…¶ä¸­0æ˜¯æœ€ä½ä¼˜å…ˆçº§
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEsHwd.png" alt="PEsHwd.png"></li></ul></li> <li><code>configMINIMAL_STACK_SIZE</code>è®¾ç½®ç©ºé—²ä»»åŠ¡çš„æœ€å°ä»»åŠ¡å †æ ˆå¤§å°ï¼Œä»¥<strong>å­—</strong>ä¸ºå•ä½
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEyFkn.png" alt="PEyFkn.png"></li></ul></li> <li><code>configTOTAL_HEAP_SIZE</code>è®¾ç½®å †çš„å¤§å°ï¼Œå¦‚æœä½¿ç”¨äº†åŠ¨æ€å†…å­˜ç®¡ç†ï¼Œåˆ™FreeRTOSåœ¨åˆ›å»ºä»»åŠ¡ã€ä¿¡å·é‡ã€é˜Ÿåˆ—ç­‰çš„æ—¶å€™å°±ä¼šä»ç”¨æˆ·æŒ‡å®šçš„å†…å­˜ä¸­è·å–ç©ºé—´
<ul><li><img src="https://s1.ax1x.com/2018/07/03/PEyUne.png" alt="PEyUne.png"></li></ul></li> <li><code>configKERNEL_INTERRUPT_PRIORITY</code>è®¾ç½®äº†å†…æ ¸ä¸­æ–­ç³»ç»Ÿä¸­systickä¸­æ–­çš„ä¼˜å…ˆçº§(FreeRTOSä¸­systickçš„ä¸­æ–­ä¼˜å…ˆçº§æ˜¯æœ€ä½çš„)
<ul><li><img src="https://s1.ax1x.com/2018/07/04/PEv1LF.png" alt="PEv1LF.png"></li></ul></li> <li><code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>è®¾ç½®äº†FreeRTOSç³»ç»Ÿå¯ç®¡ç†çš„æœ€å¤§ä¼˜å…ˆçº§ï¼Œè¿™é‡Œå®é™…å€¼ä¸º<em>3</em>ï¼Œé«˜äºæ­¤ä¼˜å…ˆçº§çš„ä¸­æ–­æ˜¯ä¸ä¼šè¢«FreeRTOSå†…æ ¸å±è”½çš„ï¼Œå¯¹å®æ—¶æ€§è¦æ±‚ä¸¥æ ¼çš„ä»»åŠ¡å°±å¯ä»¥ä½¿ç”¨è¿™äº›ä¼˜å…ˆçº§ï¼Œä¸­æ–­æœåŠ¡å‡½æ•°ä¹Ÿä¸èƒ½è°ƒç”¨FreeRTOSçš„APIå‡½æ•°ï¼›ä½äºï¼ˆåŒ…æ‹¬æœ¬èº«ï¼‰æ­¤ä¼˜å…ˆçº§çš„ä¸­æ–­å¯ä»¥å®‰å…¨åœ°è°ƒç”¨ä»¥FromISRç»“å°¾çš„APIå‡½æ•°
<ul><li><img src="https://s1.ax1x.com/2018/07/04/PExpTJ.png" alt="PExpTJ.png"></li></ul></li></ul></li></ul> <h2 id="freertosä¸­çš„task"><a href="#freertosä¸­çš„task" class="header-anchor">#</a> FreeRTOSä¸­çš„Task</h2> <ul><li><p>ä»»åŠ¡æ§åˆ¶å—</p> <ul><li><blockquote><p>xTaskCreate()åˆ›å»ºä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç»™æ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªä»»åŠ¡æ§åˆ¶å—</p></blockquote></li> <li><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * Task control block.  A task control block (TCB) is allocated for each task,
 * and stores task state information, including a pointer to the task's context
 * (the task's run time environment, including register values)
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tskTaskControlBlock</span>
<span class="token punctuation">{</span>
	<span class="token keyword">volatile</span> StackType_t	<span class="token operator">*</span>pxTopOfStack<span class="token punctuation">;</span>	<span class="token comment">//ä»»åŠ¡å †æ ˆæ ˆé¡¶</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> portUSING_MPU_WRAPPERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		xMPU_SETTINGS	xMPUSettings<span class="token punctuation">;</span>		<span class="token comment">//MPUç›¸å…³çš„è®¾ç½®</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	ListItem_t			xGenericListItem<span class="token punctuation">;</span>	<span class="token comment">//çŠ¶æ€åˆ—è¡¨é¡¹</span>
	ListItem_t			xEventListItem<span class="token punctuation">;</span>		<span class="token comment">//äº‹ä»¶åˆ—è¡¨é¡¹</span>
	UBaseType_t			uxPriority<span class="token punctuation">;</span>			<span class="token comment">//ä»»åŠ¡ä¼˜å…ˆçº§</span>
	StackType_t			<span class="token operator">*</span>pxStack<span class="token punctuation">;</span>			<span class="token comment">//ä»»åŠ¡å †æ ˆèµ·å§‹åœ°å€</span>
	<span class="token keyword">char</span>				pcTaskName<span class="token punctuation">[</span> configMAX_TASK_NAME_LEN <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//ä»»åŠ¡åå­—</span>
	BaseType_t			xCoreID<span class="token punctuation">;</span>			<span class="token comment">//æ‰§è¡Œä»»åŠ¡çš„å¤„ç†å™¨æ ¸ID</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> portSTACK_GROWTH <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> configENABLE_TASK_SNAPSHOT <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		StackType_t		<span class="token operator">*</span>pxEndOfStack<span class="token punctuation">;</span>		<span class="token comment">//ä»»åŠ¡å †æ ˆæ ˆåº•</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> portCRITICAL_NESTING_IN_TCB <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		UBaseType_t 	uxCriticalNesting<span class="token punctuation">;</span> 	<span class="token comment">//ä¸´ç•ŒåŒºåµŒå¥—æ·±åº¦</span>
		uint32_t		uxOldInterruptState<span class="token punctuation">;</span> <span class="token comment">/*&lt; Interrupt state before the outer taskEnterCritical was called */</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TRACE_FACILITY <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		UBaseType_t		uxTCBNumber<span class="token punctuation">;</span>		<span class="token comment">/*&lt; Stores a number that increments each time a TCB is created.  It allows debuggers to determine when a task has been deleted and then recreated. */</span>
		UBaseType_t  	uxTaskNumber<span class="token punctuation">;</span>		<span class="token comment">/*&lt; Stores a number specifically for use by third party trace code. */</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_MUTEXES <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		UBaseType_t 	uxBasePriority<span class="token punctuation">;</span>		<span class="token comment">//ä»»åŠ¡åŸºç¡€ä¼˜å…ˆçº§</span>
		UBaseType_t 	uxMutexesHeld<span class="token punctuation">;</span>		<span class="token comment">//ä»»åŠ¡è·å–åˆ°çš„äº’æ–¥ä¿¡å·é‡ä¸ªæ•°</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_APPLICATION_TASK_TAG <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		TaskHookFunction_t pxTaskTag<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
		<span class="token keyword">void</span> <span class="token operator">*</span>pvThreadLocalStoragePointers<span class="token punctuation">[</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS <span class="token punctuation">)</span></span></span>
		TlsDeleteCallbackFunction_t pvThreadLocalStoragePointersDelCallback<span class="token punctuation">[</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configGENERATE_RUN_TIME_STATS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		uint32_t		ulRunTimeCounter<span class="token punctuation">;</span>	<span class="token comment">//è®°å½•ä»»åŠ¡è¿è¡Œæ€»æ—¶é—´</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_NEWLIB_REENTRANT <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token comment">/* Allocate a Newlib reent structure that is specific to this task.
		Note Newlib support has been included by popular demand, but is not
		used by the FreeRTOS maintainers themselves.  FreeRTOS is not
		responsible for resulting newlib operation.  User must be familiar with
		newlib and must provide system-wide implementations of the necessary
		stubs. Be warned that (at the time of writing) the current newlib design
		implements a system-wide malloc() that must be provided with locks. */</span>
		<span class="token keyword">struct</span> 	<span class="token class-name">_reent</span> xNewLib_reent<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TASK_NOTIFICATIONS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token keyword">volatile</span> uint32_t ulNotifiedValue<span class="token punctuation">;</span>	<span class="token comment">//ä»»åŠ¡é€šçŸ¥å€¼</span>
		<span class="token keyword">volatile</span> eNotifyValue eNotifyState<span class="token punctuation">;</span>	<span class="token comment">//ä»»åŠ¡é€šçŸ¥çŠ¶æ€</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">/* See the comments above the definition of
	tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE. */</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
		uint8_t	ucStaticallyAllocated<span class="token punctuation">;</span> 		<span class="token comment">//å¦‚æœä»»åŠ¡æ˜¯é™æ€åˆ›å»ºçš„ï¼Œè¯¥å˜é‡å°±ä¸ºpdTRUE</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span> tskTCB<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> tskTCB TCB_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div></li></ul></li> <li><p>ä»»åŠ¡å †æ ˆ</p> <ul><li><blockquote><p>ä»»åŠ¡è°ƒåº¦å™¨åœ¨è¿›è¡Œä»»åŠ¡åˆ‡æ¢çš„æ—¶å€™ï¼Œä¼šå°†å½“å‰ä»»åŠ¡çš„ç°åœº(CPUå¯„å­˜å™¨å€¼ç­‰ç­‰)ä¿å­˜åœ¨æ­¤ä»»åŠ¡çš„ä»»åŠ¡å †æ ˆä¸­ï¼›æ­¤ä»»åŠ¡ä¸‹æ¬¡è¿è¡Œçš„æ—¶å€™å°±ä¼šå…ˆç”¨å †æ ˆä¸­ä¿å­˜çš„å€¼æ¥æ¢å¤ç°åœºï¼Œä¹‹åä»»åŠ¡å°±ä¼šæ¥ç€ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹å¼€å§‹è¿è¡Œã€‚ä½¿ç”¨åŠ¨æ€çš„æ–¹æ³•åˆ›å»ºä»»åŠ¡æ—¶ï¼Œä»»åŠ¡å †æ ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼›ä½¿ç”¨é™æ€çš„æ–¹æ³•åˆ›å»ºä»»åŠ¡æ—¶ï¼Œä»»åŠ¡å †æ ˆéœ€è¦ç”¨æˆ·è‡ªè¡Œå®šä¹‰ã€‚ä»»åŠ¡å †æ ˆçš„æ•°æ®ç±»å‹ä¸º<code>StackType_t</code>ï¼Œå…¶å¤§å°ä¸º4å­—èŠ‚ï¼Œæ‰€ä»¥åŠ¨æ€åˆ›å»ºçš„ä»»åŠ¡ï¼Œå…¶å †æ ˆå¤§å°æ˜¯ä¼ å…¥æ•°å€¼4å€</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">portSTACK_TYPE uint32_t</span></span>
<span class="token keyword">typedef</span> portSTACK_TYPE StackType_t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li></ul> <h4 id="å°¾è°ƒç”¨-è°ƒåº¦ä»»åŠ¡åˆ›å»ºå’Œåˆ é™¤apiå‡½æ•°"><a href="#å°¾è°ƒç”¨-è°ƒåº¦ä»»åŠ¡åˆ›å»ºå’Œåˆ é™¤apiå‡½æ•°" class="header-anchor">#</a> å°¾è°ƒç”¨ è°ƒåº¦ä»»åŠ¡åˆ›å»ºå’Œåˆ é™¤APIå‡½æ•°</h4> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xTaskCreate()</td> <td>ä½¿ç”¨åŠ¨æ€çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªä»»åŠ¡</td></tr> <tr><td>xTaskCreateStatic()</td> <td>ä½¿ç”¨é™æ€çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªä»»åŠ¡</td></tr> <tr><td>xTaskCreateRestricted()</td> <td>åˆ›å»ºä¸€ä¸ªä½¿ç”¨MPUè¿›è¡Œé™åˆ¶çš„ä»»åŠ¡ï¼Œç›¸å…³å†…å­˜ä½¿ç”¨åŠ¨æ€å†…å­˜åˆ†é…</td></tr> <tr><td>vTaskDelete()</td> <td>åˆ é™¤ä¸€ä¸ªä»»åŠ¡</td></tr></tbody></table> <h4 id="ä»»åŠ¡æŒ‚èµ·å’Œæ¢å¤apiå‡½æ•°"><a href="#ä»»åŠ¡æŒ‚èµ·å’Œæ¢å¤apiå‡½æ•°" class="header-anchor">#</a> ä»»åŠ¡æŒ‚èµ·å’Œæ¢å¤APIå‡½æ•°</h4> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>vTaskSuspend()</td> <td>æŒ‚èµ·ä¸€ä¸ªä»»åŠ¡ï¼Œä¼ å…¥æŸä¸ªä»»åŠ¡çš„å¥æŸ„ï¼ŒNULLè¡¨ç¤ºå½“å‰ä»»åŠ¡</td></tr> <tr><td>vTaskResume()</td> <td>æ¢å¤ä¸€ä¸ªä»»åŠ¡çš„è¿è¡Œ</td></tr> <tr><td>xTaskResumeFromISR()</td> <td>ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­æ¢å¤ä¸€ä¸ªä»»åŠ¡çš„è¿è¡Œã€‚è¿”å›pdTRUEè¡¨ç¤ºæ¢å¤è¿è¡Œçš„ä»»åŠ¡çš„ä¼˜å…ˆçº§ç­‰äºæˆ–è€…é«˜äºæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆè¢«ä¸­æ–­æ‰“æ–­çš„ä»»åŠ¡ï¼‰ï¼Œè¿™æ„å‘³ç€åœ¨é€€å‡ºä¸­æ–­æœåŠ¡å‡½æ•°çš„æ—¶å€™å¿…é¡»è¿›è¡Œä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆè°ƒç”¨<em>portYIELD_FROM_ISR</em>ï¼‰ã€‚è¿”å›pdFALSEè¡¨ç¤ºæ¢å¤è¿è¡Œçš„ä»»åŠ¡çš„ä¼˜å…ˆçº§ä½äºå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆè¢«ä¸­æ–­æ‰“æ–­çš„ä»»åŠ¡ï¼‰ï¼Œè¿™æ„å‘³ç€åœ¨é€€å‡ºä¸­æ–­æœåŠ¡å‡½æ•°çš„ä»¥åä¸éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</td></tr></tbody></table> <h4 id="å…¶ä»–å¸¸ç”¨apiå‡½æ•°-éƒ¨åˆ†å‡½æ•°éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ç›¸å…³çš„å®"><a href="#å…¶ä»–å¸¸ç”¨apiå‡½æ•°-éƒ¨åˆ†å‡½æ•°éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ç›¸å…³çš„å®" class="header-anchor">#</a> å…¶ä»–å¸¸ç”¨APIå‡½æ•°(éƒ¨åˆ†å‡½æ•°éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ç›¸å…³çš„å®)</h4> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xTaskGetHandle()</td> <td>æ ¹æ®ä»»åŠ¡åå­—è·å–æŸä¸ªä»»åŠ¡çš„ä»»åŠ¡å¥æŸ„</td></tr> <tr><td>vTaskStartScheduler()</td> <td>å¼€å¯ä»»åŠ¡è°ƒåº¦</td></tr> <tr><td>vTaskSuspendAll()</td> <td>æŒ‚èµ·ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ”¯æŒåµŒå¥—</td></tr> <tr><td>vTaskResumeAll()</td> <td>æ¢å¤è°ƒåº¦å™¨</td></tr> <tr><td>vTaskDelay()</td> <td>ä»»åŠ¡å»¶æ—¶ï¼Œå•ä½æ˜¯æ—¶é’ŸèŠ‚æ‹</td></tr> <tr><td>uxTaskPriorityGet()</td> <td>è·å–æŒ‡å®šä»»åŠ¡çš„ä¼˜å…ˆçº§</td></tr> <tr><td>vTaskPrioritySet()</td> <td>æ”¹å˜ä¸€ä¸ªä»»åŠ¡çš„ä»»åŠ¡ä¼˜å…ˆçº§</td></tr> <tr><td>uxTaskGetSystemState()</td> <td>è·å–ç³»ç»Ÿä¸­æ‰€æœ‰ä»»åŠ¡çš„ä»»åŠ¡çŠ¶æ€</td></tr> <tr><td>vTaskGetInfo()</td> <td>è·å–å•ä¸ªä»»åŠ¡çš„çŠ¶æ€</td></tr> <tr><td>xTaskGetCurrentTaskHandle()</td> <td>è·å–å½“å‰ä»»åŠ¡çš„ä»»åŠ¡å¥æŸ„</td></tr> <tr><td>xTaskGetHandle()</td> <td>æ ¹æ®ä»»åŠ¡åå­—è·å–ä»»åŠ¡çš„ä»»åŠ¡å¥æŸ„</td></tr> <tr><td>xTaskGetIdleTaskHandle()</td> <td>è¿”å›ç©ºé—²ä»»åŠ¡çš„ä»»åŠ¡å¥æŸ„</td></tr> <tr><td>uxTaskGetStackHighWaterMark()</td> <td>æ£€æŸ¥ä»»åŠ¡ä»åˆ›å»ºå¥½åˆ°ç°åœ¨çš„å†å²å‰©ä½™æœ€å°å€¼ï¼ŒFreeRTOSæŠŠè¿™ä¸ªå†å²å‰©ä½™æœ€å°å€¼å«â€œé«˜æ°´ä½çº¿â€</td></tr> <tr><td>eTaskGetState()</td> <td>æŸ¥è¯¢æŸä¸ªä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€</td></tr> <tr><td>pcTaskGetName()</td> <td>æ ¹æ®æŸä¸ªä»»åŠ¡çš„ä»»åŠ¡å¥æŸ„æ¥æŸ¥è¯¢è¿™ä¸ªä»»åŠ¡å¯¹åº”çš„ä»»åŠ¡å</td></tr> <tr><td>xTaskGetTickCount()/xTaskGetTickCountFromISR()</td> <td>æŸ¥è¯¢ä»»åŠ¡è°ƒåº¦å™¨ä»å¯åŠ¨åˆ°ç°åœ¨çš„æ—¶é—´è®¡æ•°å™¨xTickCountçš„å€¼ï¼Œæ¯ä¸ªæ»´ç­”å®šæ—¶å™¨ä¸­æ–­æ—¶xTickCountå°±ä¼šåŠ 1</td></tr> <tr><td>xTaskGetSchedulerState()</td> <td>è·å–FreeRTOSçš„ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œæƒ…å†µï¼šè¿è¡Œã€å…³é—­è¿˜æ˜¯æŒ‚èµ·</td></tr> <tr><td>uxTaskGetNumberOfTasks()</td> <td>æŸ¥è¯¢ç³»ç»Ÿå½“å‰å­˜åœ¨çš„ä»»åŠ¡æ•°é‡</td></tr> <tr><td>vTaskList()</td> <td>åˆ›å»ºä¸€ä¸ªè¡¨æ ¼æ¥æè¿°æ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯</td></tr> <tr><td>vTaskGetRunTimeStats()</td> <td>ç»Ÿè®¡ä»»åŠ¡çš„è¿è¡Œæ—¶é—´ä¿¡æ¯ï¼Œä»»åŠ¡çš„è¿è¡Œæ—¶é—´ä¿¡æ¯æä¾›äº†æ¯ä¸ªä»»åŠ¡è·å–åˆ°CPUä½¿ç”¨æƒæ€»çš„æ—¶é—´</td></tr> <tr><td>SetThreadLocalStoragePointer()</td> <td>è®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨æŒ‡é’ˆçš„å€¼ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„æŒ‡é’ˆæ•°ç»„æ¥ä½œä¸ºçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œä½¿ç”¨è¿™äº›çº¿ç¨‹æœ¬åœ°å­˜å‚¨å¯ä»¥ç”¨æ¥åœ¨ä»»åŠ¡æ§åˆ¶å—ä¸­å­˜å‚¨ä¸€äº›åº”ç”¨ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åªå±äºçº¿ç¨‹è‡ªå·±</td></tr> <tr><td>GetThreadLocalStoragePointer()</td> <td>è·å–çº¿ç¨‹æœ¬åœ°å­˜å‚¨æŒ‡é’ˆçš„å€¼</td></tr></tbody></table> <h2 id="freertoså¼€å…³ä¸­æ–­"><a href="#freertoså¼€å…³ä¸­æ–­" class="header-anchor">#</a> FreeRTOSå¼€å…³ä¸­æ–­</h2> <p><img src="https://s1.ax1x.com/2018/07/04/PEzUKK.png" alt="PEzUKK.png"></p> <ul><li>å…³é—­ä¸­æ–­æ˜¯æŒ‡ä¼˜å…ˆçº§ä½äºXCHAL_EXCM_LEVELçš„ä¸­æ–­å°†ä¼šè¢«å±è”½</li></ul> <h2 id="freertosä¸´ç•Œæ®µä»£ç ä¿æŠ¤"><a href="#freertosä¸´ç•Œæ®µä»£ç ä¿æŠ¤" class="header-anchor">#</a> FreeRTOSä¸´ç•Œæ®µä»£ç ä¿æŠ¤</h2> <table><thead><tr><th>å‡½æ•°/å®</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>taskENTER_CRITICAL()</td> <td>ä»»åŠ¡çº§è¿›å…¥ä¸´ç•Œæ®µ</td></tr> <tr><td>taskEXIT_CRITICAL()</td> <td>ä»»åŠ¡çº§é€€å‡ºä¸´ç•Œæ®µ</td></tr> <tr><td>taskENTER_CRITICAL_FROME_ISR()</td> <td>ä¸­æ–­çº§è¿›å…¥ä¸´ç•Œæ®µï¼ˆä¸­æ–­ä¼˜å…ˆçº§ä¸èƒ½é«˜äºconfigMAX_SYSCALL_INTERRUPT_PRIORITYï¼‰</td></tr> <tr><td>taskEXIT_CRITICAL_FROM_ISR()</td> <td>ä¸­æ–­çº§é€€å‡ºä¸´ç•Œæ®µ</td></tr></tbody></table> <h2 id="freertosåˆ—è¡¨-åŒå‘å¾ªç¯é“¾è¡¨-å’Œåˆ—è¡¨é¡¹"><a href="#freertosåˆ—è¡¨-åŒå‘å¾ªç¯é“¾è¡¨-å’Œåˆ—è¡¨é¡¹" class="header-anchor">#</a> FreeRTOSåˆ—è¡¨ï¼ˆåŒå‘å¾ªç¯é“¾è¡¨ï¼‰å’Œåˆ—è¡¨é¡¹</h2> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xLIST</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_INTEGRITY_CHECK_VALUE			<span class="token comment">//ç”¨æ¥æ£€æŸ¥åˆ—è¡¨çš„å®Œæ•´æ€§</span>
	configLIST_VOLATILE UBaseType_t uxNumberOfItems<span class="token punctuation">;</span><span class="token comment">//è®°å½•åˆ—è¡¨ä¸­åˆ—è¡¨é¡¹çš„æ•°é‡</span>
	ListItem_t <span class="token operator">*</span> configLIST_VOLATILE pxIndex<span class="token punctuation">;</span>		<span class="token comment">//è®°å½•æœ€æ–°çš„åˆ—è¡¨é¡¹ï¼Œç”¨äºéå†åˆ—è¡¨</span>
	MiniListItem_t xListEnd<span class="token punctuation">;</span>						<span class="token comment">//æ ‡è®°åˆ—è¡¨çš„æœ€åä¸€é¡¹</span>
	listSECOND_LIST_INTEGRITY_CHECK_VALUE			<span class="token comment">//ç”¨æ¥æ£€æŸ¥åˆ—è¡¨çš„å®Œæ•´æ€§</span>
<span class="token punctuation">}</span> List_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_ITEM_INTEGRITY_CHECK_VALUE
	configLIST_VOLATILE TickType_t xItemValue<span class="token punctuation">;</span>			<span class="token comment">//åºå·ï¼Œç”¨æ¥å¯¹åˆ—è¡¨é¡¹è¿›è¡Œæ’åˆ—</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxNext<span class="token punctuation">;</span>		<span class="token comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªåˆ—è¡¨é¡¹</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxPrevious<span class="token punctuation">;</span>	<span class="token comment">//æŒ‡å‘å‰ä¸€ä¸ªåˆ—è¡¨é¡¹</span>
	<span class="token keyword">void</span> <span class="token operator">*</span> pvOwner<span class="token punctuation">;</span>										<span class="token comment">//æŒ‡å‘å®é™…åŒ…å«æœ‰è¯¥åˆ—è¡¨é¡¹çš„å¯¹è±¡</span>
	<span class="token keyword">void</span> <span class="token operator">*</span> configLIST_VOLATILE pvContainer<span class="token punctuation">;</span>				<span class="token comment">//æŒ‡å‘æ­¤åˆ—è¡¨é¡¹å½’å±çš„åˆ—è¡¨</span>
	listSECOND_LIST_ITEM_INTEGRITY_CHECK_VALUE
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> ListItem_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">xMINI_LIST_ITEM</span>
<span class="token punctuation">{</span>
	listFIRST_LIST_ITEM_INTEGRITY_CHECK_VALUE
	configLIST_VOLATILE TickType_t xItemValue<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxNext<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">xLIST_ITEM</span> <span class="token operator">*</span> configLIST_VOLATILE pxPrevious<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">xMINI_LIST_ITEM</span> MiniListItem_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="åˆ—è¡¨æ“ä½œç›¸å…³api"><a href="#åˆ—è¡¨æ“ä½œç›¸å…³api" class="header-anchor">#</a> åˆ—è¡¨æ“ä½œç›¸å…³API</h4> <table><thead><tr><th>å‡½æ•°å</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>void vListInitialise( List_t * const pxList )</td> <td>åˆ—è¡¨åˆå§‹åŒ–</td></tr> <tr><td>void vListInitialiseItem( ListItem_t * const pxItem )</td> <td>åˆ—è¡¨é¡¹åˆå§‹åŒ–</td></tr> <tr><td>void vListInsert( List_t * const pxList, ListItem_t * const pxNewListItem )</td> <td>åˆ—è¡¨é¡¹æ’å…¥ï¼ˆæŒ‡å®šä½ç½®ï¼‰</td></tr> <tr><td>void vListInsertEnd( List_t * const pxList, ListItem_t * const pxNewListItem )</td> <td>åˆ—è¡¨é¡¹æ’å…¥ï¼ˆæœ«å°¾ï¼‰</td></tr> <tr><td>UBaseType_t uxListRemove( ListItem_t * const pxItemToRemove )</td> <td>åˆ—è¡¨é¡¹åˆ é™¤</td></tr> <tr><td>listGET_OWNER_OF_NEXT_ENTRY(pxTCB,pxList)</td> <td>åˆ—è¡¨çš„éå†</td></tr></tbody></table> <ul><li>vListInsertä¸­ï¼Œåˆ—è¡¨é¡¹çš„æ’å…¥ä½ç½®æ˜¯æ ¹æ®åˆ—è¡¨é¡¹ä¸­çš„xItemValueæ¥å†³å®šï¼ŒæŒ‰ç…§<strong>å‡åº</strong>æ–¹å¼æ’åˆ—ï¼Œä¾‹å¦‚xItemValueçš„å€¼ä¸ºportMAX_DELAYå°±è¡¨ç¤ºè¦æ’å…¥çš„ä½ç½®æ˜¯åˆ—è¡¨çš„æœ€æœ«å°¾</li> <li>vListInsertEndä¸­ï¼Œåˆ—è¡¨é¡¹æ’å…¥çš„ä½ç½®æ˜¯pxListä¸­pxIndexæŒ‡å‘çš„åˆ—è¡¨é¡¹çš„å‰é¢</li> <li>uxListRemoveå‡½æ•°ä¼šè¿”å›åˆ é™¤ååˆ—è¡¨çš„å‰©ä½™é•¿åº¦ï¼Œè¯¥å‡½æ•°åªæ˜¯å°†æŒ‡å®šçš„åˆ—è¡¨é¡¹ä»åˆ—è¡¨ä¸­åˆ é™¤æ‰ï¼Œå¹¶ä¸ä¼šå°†è¿™ä¸ªåˆ—è¡¨é¡¹çš„å†…å­˜é‡Šæ”¾æ‰</li> <li>åˆ—è¡¨ä¸­çš„æˆå‘˜å˜é‡pxIndexæ˜¯ç”¨æ¥ä¾¿åˆ©åˆ—è¡¨çš„ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡å®listGET_OWNER_OF_NEXT_ENTRYï¼Œåˆ—è¡¨çš„pxIndexå°±ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªåˆ—è¡¨é¡¹ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ªåˆ—è¡¨é¡¹çš„pxOwnerå˜é‡å€¼</li></ul> <h2 id="freertosçš„è°ƒåº¦å™¨"><a href="#freertosçš„è°ƒåº¦å™¨" class="header-anchor">#</a> FreeRTOSçš„è°ƒåº¦å™¨</h2> <h4 id="vtaskstartschedulerå‡½æ•°"><a href="#vtaskstartschedulerå‡½æ•°" class="header-anchor">#</a> vTaskStartSchedulerå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t xReturn<span class="token punctuation">;</span>
	BaseType_t i<span class="token punctuation">;</span>

	<span class="token comment">//ç»™æ¯ä¸ªå†…æ ¸éƒ½åˆ›å»ºä¸€ä¸ªç©ºé—²ä»»åŠ¡ï¼Œä¼˜å…ˆçº§è®¾ä¸ºæœ€ä½ï¼ˆ0ï¼‰ï¼Œä»»åŠ¡åä¸ºâ€œIDLEâ€</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>portNUM_PROCESSORS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> INCLUDE_xTaskGetIdleTaskHandle <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> <span class="token string">&quot;IDLE&quot;</span><span class="token punctuation">,</span> tskIDLE_STACK_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">|</span> portPRIVILEGE_BIT <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>xIdleTaskHandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> <span class="token string">&quot;IDLE&quot;</span><span class="token punctuation">,</span> tskIDLE_STACK_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> tskIDLE_PRIORITY <span class="token operator">|</span> portPRIVILEGE_BIT <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* INCLUDE_xTaskGetIdleTaskHandle */</span>	<span class="token comment">/* Event lists are always in priority order. */</span></span>
	<span class="token punctuation">}</span>
	<span class="token comment">//åˆ›å»ºè½¯ä»¶å®šæ—¶å™¨ä»»åŠ¡ï¼Œä»»åŠ¡åä¸ºâ€œTmr Svcâ€ï¼Œæ­¤ä»»åŠ¡åªåœ¨å†…æ ¸0ä¸Šè¿è¡Œ</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TIMERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xReturn <span class="token operator">==</span> pdPASS <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xReturn <span class="token operator">=</span> <span class="token function">xTimerCreateTimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_TIMERS */</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xReturn <span class="token operator">==</span> pdPASS <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token comment">//åœ¨å¼€å¯è°ƒåº¦å™¨ä¹‹å‰ä¸å…è®¸è¢«ä¸­æ–­æ‰“æ‰°ï¼Œåœ¨è¿™é‡Œå°†ä¸­æ–­å…³é—­ã€‚ä¹‹å‰åˆ›å»ºçš„ä»»åŠ¡å †æ ˆä¸­åŒ…å«æœ‰ä¸€ä¸ªçŠ¶æ€å­—ï¼ŒæŒ‡ç¤ºè¿™ä¸­æ–­æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œæ‰€ä»¥å½“ç¬¬ä¸€ä¸ªä»»åŠ¡è¿è¡Œèµ·æ¥åï¼Œä¸­æ–­å°†ä¼šå†ä¸€æ¬¡è¢«å¼€å¯ã€‚</span>
		<span class="token function">portDISABLE_INTERRUPTS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		xTickCount <span class="token operator">=</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span>
		<span class="token comment">//å¦‚æœéœ€è¦ä½¿ç”¨æ—¶é—´ç»Ÿè®¡åŠŸèƒ½ï¼Œä¸‹é¢çš„è¿™ä¸ªå®éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼ˆé…ç½®ä¸€ä¸ªè®¡æ•°å™¨æˆ–å®šæ—¶å™¨ï¼‰</span>
		<span class="token function">portCONFIGURE_TIMER_FOR_RUN_TIME_STATS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		xSchedulerRunning <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span><span class="token comment">//è¡¨ç¤ºè°ƒåº¦å™¨å¼€å§‹è¿è¡Œ</span>

		<span class="token comment">//åˆå§‹åŒ–ç›¸å…³ç¡¬ä»¶ï¼šæ»´ç­”å®šæ—¶å™¨ç­‰ï¼Œè¿™éœ€è¦ç”¨æˆ·è‡ªè¡Œå®ç°</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xPortStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//ä¸€æ—¦è°ƒåº¦å™¨èµ·æ¥åå°±æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//åªæœ‰è°ƒç”¨äº†xTaskEndSchedulerå‡½æ•°åæ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//å¦‚æœåˆ›å»ºç©ºé—²ä»»åŠ¡æˆ–è€…å®šæ—¶å™¨ä»»åŠ¡æ—¶å†…å­˜ä¸å¤Ÿå°±ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> xReturn <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="xportstartschedulerå‡½æ•°"><a href="#xportstartschedulerå‡½æ•°" class="header-anchor">#</a> xPortStartSchedulerå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xPortStartScheduler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
	<span class="token comment">//åˆå§‹åŒ–ä»»åŠ¡çš„åå¤„ç†å™¨</span>
	<span class="token function">_xt_coproc_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">//åˆå§‹åŒ–æ»´ç­”è®¡æ•°å™¨çš„åˆ†é¢‘ç³»æ•°</span>
	<span class="token function">_xt_tick_divisor_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//é…ç½®ã€ä½¿èƒ½æ»´ç­”è®¡æ•°å™¨</span>
	<span class="token function">_frxt_tick_timer_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	port_xSchedulerRunning<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//_frxt_dispatchå‡½æ•°ä¸èƒ½ç›´æ¥ç”¨Cè¯­è¨€è°ƒç”¨ã€‚è°ƒåº¦æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡</span>
	__asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">&quot;call0    _frxt_dispatch\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//æ°¸è¿œä¸ä¼šè¿”å›</span>
	<span class="token keyword">return</span> pdTRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="xtaskcreatepinnedtocoreå‡½æ•°"><a href="#xtaskcreatepinnedtocoreå‡½æ•°" class="header-anchor">#</a> xTaskCreatePinnedToCoreå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//åœ¨æŸä¸ªå…·ä½“çš„æ ¸ä¸Šåˆ›å»ºä»»åŠ¡</span>
BaseType_t <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span>	TaskFunction_t pxTaskCode<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> pcName<span class="token punctuation">,</span>
							<span class="token keyword">const</span> uint32_t usStackDepth<span class="token punctuation">,</span>
							<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvParameters<span class="token punctuation">,</span>
							UBaseType_t uxPriority<span class="token punctuation">,</span>
							TaskHandle_t <span class="token operator">*</span> <span class="token keyword">const</span> pxCreatedTask<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">;</span>
    BaseType_t xReturn<span class="token punctuation">;</span>

    <span class="token comment">//å¦‚æœä»»åŠ¡æ ˆå‘ä¸Šç”Ÿé•¿ï¼Œé‚£ä¹ˆå…ˆå¼€è¾Ÿä»»åŠ¡æ§åˆ¶å—TCBçš„å†…å­˜ï¼Œå†å¼€è¾Ÿä»»åŠ¡æ ˆçš„å†…å­˜ï¼Œä»»åŠ¡æ ˆçš„åœ°å€ä¿å­˜åœ¨TCBä¸­</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portSTACK_GROWTH <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
    <span class="token punctuation">{</span>
        pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocTcbMem</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocStackMem</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">vPortFree</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">//å¦‚æœä»»åŠ¡æ ˆå‘ä¸‹ç”Ÿé•¿ï¼Œé‚£ä¹ˆå…ˆå¼€è¾Ÿä»»åŠ¡æ ˆçš„å†…å­˜ï¼Œå†å¼€è¾Ÿä»»åŠ¡æ§åˆ¶å—TCBçš„å†…å­˜ï¼Œä»»åŠ¡æ ˆçš„åœ°å€ä¿å­˜åœ¨TCBä¸­</span>
    <span class="token punctuation">{</span>
        StackType_t <span class="token operator">*</span>pxStack<span class="token punctuation">;</span>
        pxStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocStackMem</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> usStackDepth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxStack <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxNewTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMallocTcbMem</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> TCB_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">=</span> pxStack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">vPortFree</span><span class="token punctuation">(</span> pxStack <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            pxNewTCB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portSTACK_GROWTH */</span></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> tskSTATIC_AND_DYNAMIC_ALLOCATION_POSSIBLE <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
        <span class="token punctuation">{</span>
            <span class="token comment">//æ ‡è®°è¯¥ä»»åŠ¡åæœŸä¸éœ€è¦çš„æ—¶å€™éœ€è¦åˆ é™¤</span>
            pxNewTCB<span class="token operator">-&gt;</span>ucStaticallyAllocated <span class="token operator">=</span> tskDYNAMICALLY_ALLOCATED_STACK_AND_TCB<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configSUPPORT_STATIC_ALLOCATION */</span></span>
		<span class="token comment">//åˆå§‹åŒ–ä»»åŠ¡</span>
        <span class="token function">prvInitialiseNewTask</span><span class="token punctuation">(</span> pxTaskCode<span class="token punctuation">,</span> pcName<span class="token punctuation">,</span> usStackDepth<span class="token punctuation">,</span> pvParameters<span class="token punctuation">,</span> uxPriority<span class="token punctuation">,</span> pxCreatedTask<span class="token punctuation">,</span> pxNewTCB<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> xCoreID <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†æ–°åˆ›å»ºçš„ä»»åŠ¡åŠ å…¥å°±ç»ªåˆ—è¡¨ä¸­</span>
        <span class="token function">prvAddNewTaskToReadyList</span><span class="token punctuation">(</span> pxNewTCB<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> xCoreID <span class="token punctuation">)</span><span class="token punctuation">;</span>
        xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        xReturn <span class="token operator">=</span> errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> xReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h4 id="prvinitialisenewtaskå‡½æ•°"><a href="#prvinitialisenewtaskå‡½æ•°" class="header-anchor">#</a> prvInitialiseNewTaskå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseNewTask</span><span class="token punctuation">(</span> 	TaskFunction_t pxTaskCode<span class="token punctuation">,</span>
									<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> pcName<span class="token punctuation">,</span>
									<span class="token keyword">const</span> uint32_t ulStackDepth<span class="token punctuation">,</span>
									<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvParameters<span class="token punctuation">,</span>
									UBaseType_t uxPriority<span class="token punctuation">,</span>
									TaskHandle_t <span class="token operator">*</span> <span class="token keyword">const</span> pxCreatedTask<span class="token punctuation">,</span>
									TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">,</span>
									<span class="token keyword">const</span> MemoryRegion_t <span class="token operator">*</span> <span class="token keyword">const</span> xRegions<span class="token punctuation">,</span> <span class="token keyword">const</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
StackType_t <span class="token operator">*</span>pxTopOfStack<span class="token punctuation">;</span>
UBaseType_t x<span class="token punctuation">;</span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portUSING_MPU_WRAPPERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token comment">//ä»»åŠ¡ä½¿ç”¨ç‰¹æƒæ¨¡å¼åˆ›å»ºä»»åŠ¡</span>
		BaseType_t xRunPrivileged<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxPriority <span class="token operator">&amp;</span> portPRIVILEGE_BIT <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0U</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xRunPrivileged <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			xRunPrivileged <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		uxPriority <span class="token operator">&amp;=</span> <span class="token operator">~</span>portPRIVILEGE_BIT<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portUSING_MPU_WRAPPERS == 1 */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> configCHECK_FOR_STACK_OVERFLOW <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> configUSE_TRACE_FACILITY <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> INCLUDE_uxTaskGetStackHighWaterMark <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token comment">//å°†ä»»åŠ¡æ ˆåˆå§‹åŒ–ç›¸åŒçš„å€¼(0xA5)</span>
		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> <span class="token punctuation">)</span> tskSTACK_FILL_BYTE<span class="token punctuation">,</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> ulStackDepth <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> StackType_t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">//æ ¹æ®æ ˆçš„ä¸åŒç”Ÿé•¿æ–¹å‘æ¥è®¡ç®—æ ˆé¡¶ä½ç½®</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portSTACK_GROWTH <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxTopOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">+</span> <span class="token punctuation">(</span> ulStackDepth <span class="token operator">-</span> <span class="token punctuation">(</span> uint32_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		pxTopOfStack <span class="token operator">=</span> <span class="token punctuation">(</span> StackType_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxTopOfStack <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 

		<span class="token comment">//æ£€æŸ¥å †æ ˆæ ˆé¡¶åœ°å€æ˜¯å¦å­—èŠ‚å¯¹é½</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxTopOfStack <span class="token operator">&amp;</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configENABLE_TASK_SNAPSHOT <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>pxEndOfStack <span class="token operator">=</span> pxTopOfStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* portSTACK_GROWTH */</span></span>
	<span class="token punctuation">{</span>
		pxTopOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">;</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">&amp;</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxEndOfStack <span class="token operator">=</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack <span class="token operator">+</span> <span class="token punctuation">(</span> ulStackDepth <span class="token operator">-</span> <span class="token punctuation">(</span> uint32_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portSTACK_GROWTH */</span></span>
	<span class="token comment">//ä¿å­˜ä»»åŠ¡çš„ä»»åŠ¡å</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_TASK_NAME_LEN<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pcTaskName<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> pcName<span class="token punctuation">[</span> x <span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> pcName<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//ä»»åŠ¡åå¤ªé•¿éœ€è¦æˆªæ–­</span>
	pxNewTCB<span class="token operator">-&gt;</span>pcTaskName<span class="token punctuation">[</span> configMAX_TASK_NAME_LEN <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
	<span class="token comment">//ä¿®æ­£ä¸åˆæ³•çš„ä¼˜å…ˆçº§</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxPriority <span class="token operator">&gt;=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		uxPriority <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token operator">-</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1U</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">=</span> uxPriority<span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ä»»åŠ¡æ§åˆ¶å—çš„ä¼˜å…ˆçº§å­—æ®µ</span>
	pxNewTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">=</span> xCoreID<span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ä»»åŠ¡æ‰€åœ¨çš„å†…æ ¸IDå·</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_MUTEXES <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxBasePriority <span class="token operator">=</span> uxPriority<span class="token punctuation">;</span><span class="token comment">//å¦‚æœä½¿ç”¨äº†äº’æ–¥ä¿¡å·é‡ï¼Œå°±éœ€è¦æŒ‡å®šåŸºç¡€ä¼˜å…ˆçº§</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxMutexesHeld <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_MUTEXES */</span></span>

	<span class="token function">vListInitialiseItem</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–é€šç”¨åˆ—è¡¨é¡¹</span>
	<span class="token function">vListInitialiseItem</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–äº‹ä»¶åˆ—è¡¨é¡¹</span>
	<span class="token function">listSET_LIST_ITEM_OWNER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åˆ—è¡¨é¡¹å½’å±</span>
	<span class="token function">listSET_LIST_ITEM_VALUE</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> configMAX_PRIORITIES <span class="token operator">-</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®äº‹ä»¶åˆ—è¡¨é¡¹çš„å€¼ä½¿å¾—ä¼˜å…ˆçº§ä»å°åˆ°å¤§æ’åˆ—</span>
	<span class="token function">listSET_LIST_ITEM_OWNER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åˆ—è¡¨é¡¹å½’å±</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> portCRITICAL_NESTING_IN_TCB <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>uxCriticalNesting <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portCRITICAL_NESTING_IN_TCB */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_APPLICATION_TASK_TAG <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTaskTag <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_APPLICATION_TASK_TAG */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configGENERATE_RUN_TIME_STATS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ulRunTimeCounter <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configGENERATE_RUN_TIME_STATS */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> portUSING_MPU_WRAPPERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token function">vPortStoreTaskMPUSettings</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxNewTCB<span class="token operator">-&gt;</span>xMPUSettings <span class="token punctuation">)</span><span class="token punctuation">,</span> xRegions<span class="token punctuation">,</span> pxNewTCB<span class="token operator">-&gt;</span>pxStack<span class="token punctuation">,</span> ulStackDepth <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* Avoid compiler warning about unreferenced parameter. */</span>
		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> xRegions<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>pvThreadLocalStoragePointers<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>
			pxNewTCB<span class="token operator">-&gt;</span>pvThreadLocalStoragePointersDelCallback<span class="token punctuation">[</span> x <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TASK_NOTIFICATIONS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pxNewTCB<span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotWaitingNotification<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_NEWLIB_REENTRANT <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* Initialise this task's Newlib reent structure. */</span>
		<span class="token function">esp_reent_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxNewTCB<span class="token operator">-&gt;</span>xNewLib_reent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> INCLUDE_xTaskAbortDelay <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>ucDelayAborted <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portUSING_MPU_WRAPPERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTopOfStack <span class="token operator">=</span> <span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> pxTopOfStack<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> pvParameters<span class="token punctuation">,</span> xRunPrivileged <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* portUSING_MPU_WRAPPERS */</span></span>
	<span class="token punctuation">{</span>
		pxNewTCB<span class="token operator">-&gt;</span>pxTopOfStack <span class="token operator">=</span> <span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> pxTopOfStack<span class="token punctuation">,</span> pxTaskCode<span class="token punctuation">,</span> pvParameters <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ä»»åŠ¡å †æ ˆ</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* portUSING_MPU_WRAPPERS */</span></span>

	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxCreatedTask <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//ä»»åŠ¡å¥æŸ„å…¶å®å°±æ˜¯ä»»åŠ¡æ§åˆ¶å—çš„åœ°å€</span>
		<span class="token operator">*</span>pxCreatedTask <span class="token operator">=</span> <span class="token punctuation">(</span> TaskHandle_t <span class="token punctuation">)</span> pxNewTCB<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><h4 id="pxportinitialisestackå‡½æ•°"><a href="#pxportinitialisestackå‡½æ•°" class="header-anchor">#</a> pxPortInitialiseStackå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>StackType_t <span class="token operator">*</span><span class="token function">pxPortInitialiseStack</span><span class="token punctuation">(</span> StackType_t <span class="token operator">*</span>pxTopOfStack<span class="token punctuation">,</span> TaskFunction_t pxCode<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pvParameters <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	StackType_t <span class="token operator">*</span>sp<span class="token punctuation">,</span> <span class="token operator">*</span>tp<span class="token punctuation">;</span>
	XtExcFrame  <span class="token operator">*</span>frame<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
	uint32_t <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	uint32_t <span class="token operator">*</span>threadptr<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>task_thread_local_start<span class="token punctuation">;</span>
	<span class="token keyword">extern</span> <span class="token keyword">int</span> _thread_local_start<span class="token punctuation">,</span> _thread_local_end<span class="token punctuation">,</span> _rodata_start<span class="token punctuation">;</span>
	<span class="token comment">// TODO: check that TLS area fits the stack</span>
	uint32_t thread_local_sz <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_end <span class="token operator">-</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_start<span class="token punctuation">;</span>

	thread_local_sz <span class="token operator">=</span> <span class="token function">ALIGNUP</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> thread_local_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* åˆå§‹åŒ–ä»»åŠ¡å †æ ˆï¼Œä½¿ä¹‹ä»é«˜åœ°å€å¼€å§‹å¾€ä¸‹ä¾æ¬¡æ˜¯ï¼š

	----LOW ADDRESSES ----------------------------------------HIGH ADDRESSES----------
	task stack | interrupt stack frame | thread local vars | co-processor save area |
	----------------------------------------------------------------------------------
	           |																	|
			   SP 								                            pxTopOfStack
	*/</span>
	sp <span class="token operator">=</span> <span class="token punctuation">(</span>StackType_t <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span><span class="token punctuation">(</span>pxTopOfStack <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> XT_CP_SIZE <span class="token operator">-</span> thread_local_sz <span class="token operator">-</span> XT_STK_FRMSZ<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//16å­—èŠ‚å¯¹é½</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>tp <span class="token operator">=</span> sp<span class="token punctuation">;</span> tp <span class="token operator">&lt;=</span> pxTopOfStack<span class="token punctuation">;</span> <span class="token operator">++</span>tp<span class="token punctuation">)</span><span class="token comment">//å°†spåˆ°TopOfStackä¹‹é—´çš„å†…å­˜æ¸…é›¶</span>
		<span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	frame <span class="token operator">=</span> <span class="token punctuation">(</span>XtExcFrame <span class="token operator">*</span><span class="token punctuation">)</span> sp<span class="token punctuation">;</span>

	<span class="token comment">/* å¯¹ä¸€äº›å¿…è¦çš„å¯„å­˜èµ‹å€¼ */</span>
	frame<span class="token operator">-&gt;</span>pc   <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pxCode<span class="token punctuation">;</span>             <span class="token comment">//PCæŒ‡é’ˆåˆå§‹åŒ–ä¸ºä»»åŠ¡å‡½æ•°çš„å…¥å£åœ°å€</span>
	frame<span class="token operator">-&gt;</span>a0   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                <span class="token comment">//ç»„ç»‡GDBå›æº¯</span>
	frame<span class="token operator">-&gt;</span>a1   <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> sp <span class="token operator">+</span> XT_STK_FRMSZ<span class="token punctuation">;</span>  
	frame<span class="token operator">-&gt;</span>exit <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> _xt_user_exit<span class="token punctuation">;</span>      

	<span class="token comment">/* Set initial PS to int level 0, EXCM disabled ('rfe' will enable), user mode. */</span>
	<span class="token comment">/* Also set entry point argument parameter. */</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
	frame<span class="token operator">-&gt;</span>a2 <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	frame<span class="token operator">-&gt;</span>ps <span class="token operator">=</span> PS_UM <span class="token operator">|</span> PS_EXCM<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token comment">/* + for windowed ABI also set WOE and CALLINC (pretend task was 'call4'd). */</span>
	frame<span class="token operator">-&gt;</span>a6 <span class="token operator">=</span> <span class="token punctuation">(</span>UBaseType_t<span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	frame<span class="token operator">-&gt;</span>ps <span class="token operator">=</span> PS_UM <span class="token operator">|</span> PS_EXCM <span class="token operator">|</span> PS_WOE <span class="token operator">|</span> <span class="token function">PS_CALLINC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">XT_USE_SWPRI</span></span>
	<span class="token comment">/* Set the initial virtual priority mask value to all 1's. */</span>
	frame<span class="token operator">-&gt;</span>vpri <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">/* Init threadptr reg and TLS vars */</span>
	task_thread_local_start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>pxTopOfStack <span class="token operator">-</span> XT_CP_SIZE <span class="token operator">-</span> thread_local_sz<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>task_thread_local_start<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_thread_local_start<span class="token punctuation">,</span> thread_local_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	threadptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sp <span class="token operator">+</span> XT_STK_EXTRA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* shift threadptr by the offset of _thread_local_start from DROM start;
	   need to take into account extra 16 bytes offset */</span>
	<span class="token operator">*</span>threadptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>task_thread_local_start <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>_thread_local_start <span class="token operator">-</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>_rodata_start<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">;</span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
	<span class="token comment">/* Init the coprocessor save area (see xtensa_context.h) */</span>
	p <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> pxTopOfStack <span class="token operator">-</span> XT_CP_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">+</span> XCHAL_TOTAL_SA_ALIGN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">-</span>XCHAL_TOTAL_SA_ALIGN<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> sp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h4 id="prvaddnewtasktoreadylistå‡½æ•°"><a href="#prvaddnewtasktoreadylistå‡½æ•°" class="header-anchor">#</a> prvAddNewTaskToReadyListå‡½æ•°</h4> <blockquote><p>FreeRTOSä½¿ç”¨ä¸åŒçš„åˆ—è¡¨æ¥è¡¨ç¤ºä»»åŠ¡çš„ä¸åŒçŠ¶æ€</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvAddNewTaskToReadyList</span><span class="token punctuation">(</span> TCB_t <span class="token operator">*</span>pxNewTCB<span class="token punctuation">,</span> TaskFunction_t pxTaskCode<span class="token punctuation">,</span> BaseType_t xCoreID <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	TCB_t <span class="token operator">*</span>curTCB<span class="token punctuation">,</span> <span class="token operator">*</span>tcb0<span class="token punctuation">,</span> <span class="token operator">*</span>tcb1<span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> tskNO_AFFINITY <span class="token operator">||</span> xCoreID <span class="token operator">&lt;</span> portNUM_PROCESSORS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ç¡®ä¿åˆ—è¡¨åœ¨è¢«æ›´æ–°çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­æ‰“æ–­</span>
	<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		uxCurrentNumberOfTasks<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//å…¨å±€å˜é‡ï¼Œç»Ÿè®¡ä»»åŠ¡æ•°é‡</span>
		<span class="token comment">//åˆ¤æ–­è¿™ä¸ªä»»åŠ¡åœ¨å“ªä¸ªå†…æ ¸ä¸Šè¿è¡Œ</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> tskNO_AFFINITY <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> portNUM_PROCESSORS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				tcb0 <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				tcb1 <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> tcb0 <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb1 <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb0<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&amp;&amp;</span> tcb0<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> tcb1<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> tcb1<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span><span class="token comment">//ä¸¤ä¸ªæ ¸ä¸Šçš„è¿è¡Œçš„ä»»åŠ¡ï¼Œå…¶ä¼˜å…ˆçº§éƒ½æ¯”æ–°çš„ä»»åŠ¡è¦é«˜</span>
				<span class="token punctuation">{</span>
					xCoreID <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

        <span class="token comment">//å½“å‰çš„æ ¸ä¸Šæ²¡æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œ</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span> <span class="token operator">=</span> pxNewTCB<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> uxCurrentNumberOfTasks <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">portFIRST_TASK_HOOK</span></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">vPortFirstTaskHook</span><span class="token punctuation">(</span>pxTaskCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configFIRST_TASK_HOOK */</span></span>
				<span class="token comment">//æ­£åœ¨åˆ›å»ºçš„ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦å…ˆåˆå§‹åŒ–ç›¸åº”çš„åˆ—è¡¨</span>
				<span class="token function">prvInitialiseTaskLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token comment">//æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§é«˜</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;=</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					pxCurrentTCB<span class="token punctuation">[</span>xCoreID<span class="token punctuation">]</span> <span class="token operator">=</span> pxNewTCB<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		uxTaskNumber<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//uxTaskNumberåŠ 1ï¼Œç”¨ä½œä»»åŠ¡æ§åˆ¶å—ç¼–å·</span>

		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TRACE_FACILITY <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			pxNewTCB<span class="token operator">-&gt;</span>uxTCBNumber <span class="token operator">=</span> uxTaskNumber<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_TRACE_FACILITY */</span></span>
		<span class="token function">traceTASK_CREATE</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">portSETUP_TCB</span><span class="token punctuation">(</span> pxNewTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		curTCB <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœæ–°ä»»åŠ¡çš„ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜ï¼Œè€Œä¸”è°ƒåº¦å™¨å·²ç»å¼€å§‹æ­£å¸¸è¿è¡Œäº†ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œä»»åŠ¡åˆ‡æ¢</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> curTCB <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> curTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&lt;</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xCoreID <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span>xCoreID<span class="token punctuation">,</span> pxNewTCB<span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h4 id="prvaddtasktoreadylistå®"><a href="#prvaddtasktoreadylistå®" class="header-anchor">#</a> prvAddTaskToReadyListå®</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span>												</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">traceMOVED_TASK_TO_READY_STATE</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>										</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">taskRECORD_READY_PRIORITY</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>								</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> <span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span></span><span class="token comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°å°±ç»ªåˆ—è¡¨çš„æœ«å°¾</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="vtaskdeleteå‡½æ•°"><a href="#vtaskdeleteå‡½æ•°" class="header-anchor">#</a> vTaskDeleteå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelete</span><span class="token punctuation">(</span> TaskHandle_t xTaskToDelete <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxTCB<span class="token punctuation">;</span>
    <span class="token keyword">int</span> core <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UBaseType_t free_now<span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        pxTCB <span class="token operator">=</span> <span class="token function">prvGetTCBFromHandle</span><span class="token punctuation">(</span> xTaskToDelete <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ ¹æ®ä»»åŠ¡å¥æŸ„è·å–TCBæŒ‡é’ˆ</span>
        <span class="token comment">//å°†ä»»åŠ¡ä»å°±ç»ªåˆ—è¡¨ä¸­åˆ é™¤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">taskRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//åˆ¤æ–­è¯¥ä»»åŠ¡æ˜¯å¦åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™è¿™ä¸ªä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç›¸åº”çš„åˆ—è¡¨ä¸­ï¼Œè¿™é‡Œéœ€è¦å°†å…¶ç§»é™¤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//è§¦å‘è°ƒè¯•å™¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</span>
        uxTaskNumber<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">//è¢«åˆ é™¤çš„ä»»åŠ¡æ˜¯æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œæˆ–è€…åœ¨åˆ«çš„æ ¸ï¼Œé‚£ä¹ˆå°±äº¤ç»™ç©ºé—²ä»»åŠ¡æ¥é‡Šæ”¾å†…å­˜</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span>portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token operator">!</span>core <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span>portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">!</span>core<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTasksWaitingTermination<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>uxTasksDeleted<span class="token punctuation">;</span>
            <span class="token function">portPRE_TASK_DELETE_HOOK</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xYieldPending<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒç”¨ä»»åŠ¡åˆ é™¤é’©å­å‡½æ•°</span>
            free_now <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>		<span class="token comment">//ä¸èƒ½ç«‹å³é‡Šæ”¾å†…å­˜</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//è¦åˆ é™¤çš„ä»»åŠ¡ä¸æ˜¯å½“å‰è¿è¡Œçš„ï¼Œä¹Ÿä¸åœ¨åˆ«çš„æ ¸ä¸Š</span>
        <span class="token punctuation">{</span>
            <span class="token operator">--</span>uxCurrentNumberOfTasks<span class="token punctuation">;</span>
            <span class="token comment">//é‡æ–°è®¡ç®—ä¸€ä¸‹è¿˜è¦å¤šé•¿æ—¶é—´æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªä»»åŠ¡çš„è§£é”æ—¶é—´ï¼Œé˜²æ­¢æœ‰çš„ä»»åŠ¡çš„è§£é”æ—¶é—´å‚è€ƒäº†åˆšåˆšè¢«åˆ é™¤çš„é‚£ä¸ªä»»åŠ¡</span>
            <span class="token function">prvResetNextTaskUnblockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            free_now <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">traceTASK_DELETE</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>free_now <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configNUM_THREAD_LOCAL_STORAGE_POINTERS <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> configTHREAD_LOCAL_STORAGE_DELETE_CALLBACKS <span class="token punctuation">)</span></span></span>
        <span class="token function">prvDeleteTLS</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Run deletion callbacks before deleting TCB</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token function">prvDeleteTCB</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Must only be called after del cb</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å¦‚æœåˆ é™¤çš„æ˜¯æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œé‚£ä¹ˆåˆ é™¤å®Œä»¥åè‚¯å®šéœ€è¦å¼ºåˆ¶è¿›è¡Œä¸€æ¬¡ä»»åŠ¡åˆ‡æ¢</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> core <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portPRE_TASK_DELETE_HOOK</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xYieldPending<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> portNUM_PROCESSORS <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pxTCB <span class="token operator">==</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token operator">!</span>core<span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœè¢«åˆ é™¤çš„ä»»åŠ¡æ­£åœ¨å¦å¤–ä¸€ä¸ªæ ¸ä¸Šè¿è¡Œï¼Œå¼ºåˆ¶å¦å¤–ä¸€ä¸ªæ ¸åšä»»åŠ¡åˆ‡æ¢</span>
            <span class="token function">vPortYieldOtherCore</span><span class="token punctuation">(</span> <span class="token operator">!</span>core <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h4 id="vtasksuspendå‡½æ•°"><a href="#vtasksuspendå‡½æ•°" class="header-anchor">#</a> vTaskSuspendå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskSuspend</span><span class="token punctuation">(</span> TaskHandle_t xTaskToSuspend <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span>pxTCB<span class="token punctuation">;</span>
    TCB_t <span class="token operator">*</span>curTCB<span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        pxTCB <span class="token operator">=</span> <span class="token function">prvGetTCBFromHandle</span><span class="token punctuation">(</span> xTaskToSuspend <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">traceTASK_SUSPEND</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä»»åŠ¡ä»å°±ç»ªåˆ—è¡¨ä¸­åˆ é™¤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">taskRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å°†ä»»åŠ¡ä»äº‹ä»¶åˆ—è¡¨ä¸­åˆ é™¤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">traceMOVED_TASK_TO_SUSPENDED_LIST</span><span class="token punctuation">(</span>pxTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°æŒ‚èµ·åˆ—è¡¨çš„æœ€å</span>
        <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        curTCB <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB <span class="token operator">==</span> curTCB <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//ç¡®ä¿å½“å‰æ ¸çš„ä»»åŠ¡è°ƒåº¦å™¨å·¥ä½œæ­£å¸¸</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//ä»»åŠ¡è°ƒåº¦å™¨ä¸åœ¨å·¥ä½œï¼Œåªèƒ½æ‰‹åŠ¨æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//æ‰€æœ‰çš„ä»»åŠ¡éƒ½è¢«æŒ‚èµ·ï¼Œäº‹å®ä¸Šè¿™ç§æƒ…å†µå‡ ä¹ä¸å­˜åœ¨ï¼Œé™¤éåœ¨ç©ºé—²ä»»åŠ¡ä¸­è°ƒç”¨äº†é˜»å¡çš„API</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listCURRENT_LIST_LENGTH</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList <span class="token punctuation">)</span> <span class="token operator">==</span> uxCurrentNumberOfTasks <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//è·å–ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡</span>
                <span class="token function">vTaskSwitchContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xSchedulerRunning <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœè¢«æŒ‚èµ·çš„ä»»åŠ¡å½“å‰ä¸åœ¨è¿è¡Œï¼Œé‡æ–°è®¡ç®—ä¸€ä¸‹è¿˜è¦å¤šé•¿æ—¶é—´æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œé˜²æ­¢æœ‰çš„ä»»åŠ¡çš„è§£é”æ—¶é—´å‚è€ƒäº†åˆšåˆšè¢«æŒ‚èµ·çš„ä»»åŠ¡</span>
            <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">{</span>
                <span class="token function">prvResetNextTaskUnblockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h4 id="vtaskresumeå‡½æ•°"><a href="#vtaskresumeå‡½æ•°" class="header-anchor">#</a> vTaskResumeå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskResume</span><span class="token punctuation">(</span> TaskHandle_t xTaskToResume <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span> <span class="token keyword">const</span> pxTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> xTaskToResume<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xTaskToResume <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//xTaskToResumeä¸èƒ½ä¸ºNULLï¼Œä¹Ÿä¸åº”è¯¥å­˜åœ¨æ¢å¤å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è¿™ç§æƒ…å†µ</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxTCB <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxTCB <span class="token operator">!=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvTaskIsTaskSuspended</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">traceTASK_RESUME</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//å°†è¦æ¢å¤çš„ä»»åŠ¡ä»æŒ‚èµ·åˆ—è¡¨ä¸­åˆ é™¤</span>
                <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span>  <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//å°†è¦æ¢å¤çš„ä»»åŠ¡æ·»åŠ åˆ°å°±ç»ªä»»åŠ¡åˆ—è¡¨ä¸­</span>
                <span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//å¦‚æœè¢«æ¢å¤çš„ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">tskCAN_RUN_HERE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&gt;=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//è¿™ä¸ªyieldä¸ä¼šè®©æ¢å¤çš„ä»»åŠ¡ç«‹å³è¿è¡Œï¼Œä½†æ˜¯ä¼šåˆ·æ–°å°±ç»ªåˆ—è¡¨</span>
                    <span class="token function">taskYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">!=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//è¢«æ¢å¤çš„ä»»åŠ¡ä¸å±äºå½“å‰çš„æ ¸</span>
                    <span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">,</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="freertosä»»åŠ¡åˆ‡æ¢"><a href="#freertosä»»åŠ¡åˆ‡æ¢" class="header-anchor">#</a> FreeRTOSä»»åŠ¡åˆ‡æ¢</h2> <ul><li>FreeRTOSä»»åŠ¡åˆ‡æ¢çš„åœºåˆ</li></ul> <blockquote><ol><li>æ‰§è¡Œä¸€ä¸ªä¼šå¼•èµ·ä»»åŠ¡åˆ‡æ¢çš„APIå‡½æ•°ï¼Œæ¯”å¦‚<strong>taskYIELD</strong></li> <li>ç³»ç»Ÿæ»´ç­”å®šæ—¶å™¨ä¸­æ–­</li></ol></blockquote> <ul><li><s>ä»»åŠ¡åˆ‡æ¢ä¸€èˆ¬æ˜¯åœ¨PendSVï¼ˆå¯æŒ‚èµ·çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ä¸­æ–­æœåŠ¡å‡½æ•°é‡Œé¢å®Œæˆçš„</s></li></ul> <h3 id="æ‰§è¡Œç³»ç»Ÿè°ƒç”¨"><a href="#æ‰§è¡Œç³»ç»Ÿè°ƒç”¨" class="header-anchor">#</a> æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">taskYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>					<span class="token function">portYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">portYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>					<span class="token function">vPortYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="vportyieldå‡½æ•°"><a href="#vportyieldå‡½æ•°" class="header-anchor">#</a> vPortYieldå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//å‡½æ•°void vPortYield(void)ä½¿ç”¨æ±‡ç¼–å®ç°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä¿å­˜å¾…æš‚åœä»»åŠ¡çš„æœ€å°ç°åœºç¯å¢ƒï¼Œæ¸…é™¤CPENABLEï¼Œæœ€åè°ƒç”¨_frxt_dispatchå‡½æ•°å®ç°çœŸæ­£çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</span>
    <span class="token punctuation">.</span>globl  vPortYield
    <span class="token punctuation">.</span>type   vPortYield<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
vPortYield<span class="token operator">:</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    addi    sp<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> <span class="token operator">-</span>XT_SOL_FRMSZ
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    entry   sp<span class="token punctuation">,</span>  XT_SOL_FRMSZ
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    rsr     a2<span class="token punctuation">,</span>  PS
    s32i    a0<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PC
    s32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    s32i    a12<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A12         <span class="token comment">/* save callee-saved registers      */</span>
    s32i    a13<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A13
    s32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A14
    s32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A15
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* Spill register windows. Calling xthal_window_spill() causes extra    */</span>
    <span class="token comment">/* spills and reloads, so we will set things up to call the _nw version */</span>
    <span class="token comment">/* instead to save cycles.                                              */</span>
    movi    a6<span class="token punctuation">,</span>  <span class="token operator">~</span><span class="token punctuation">(</span>PS_WOE_MASK<span class="token operator">|</span>PS_INTLEVEL_MASK<span class="token punctuation">)</span>  <span class="token comment">/* spills a4-a7 if needed */</span>
    and     a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a6                           <span class="token comment">/* clear WOE, INTLEVEL    */</span>
    addi    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> XCHAL_EXCM_LEVEL             <span class="token comment">/* set INTLEVEL           */</span>
    wsr     a2<span class="token punctuation">,</span>  PS
    rsync
    call0   xthal_window_spill_nw
    l32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS                    <span class="token comment">/* restore PS             */</span>
    wsr     a2<span class="token punctuation">,</span>  PS
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    rsil    a2<span class="token punctuation">,</span>  XCHAL_EXCM_LEVEL       <span class="token comment">/* disable low/med interrupts       */</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Save coprocessor callee-saved state (if any). At this point CPENABLE */</span>
    <span class="token comment">/* should still reflect which CPs were in use (enabled).                */</span>
    call0   _xt_coproc_savecs
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    movi    a2<span class="token punctuation">,</span>  pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    l32i    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>                  <span class="token comment">/* a2 = pxCurrentTCB                */</span>
    movi    a3<span class="token punctuation">,</span>  <span class="token number">0</span>
    s32i    a3<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_EXIT        <span class="token comment">/* 0 to flag as solicited frame     */</span>
    s32i    sp<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> TOPOFSTACK_OFFS    <span class="token comment">/* pxCurrentTCB-&gt;pxTopOfStack = SP  */</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Clear CPENABLE, also in task's co-processor state save area. */</span>
    l32i    a2<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS <span class="token comment">/* a2 = pxCurrentTCB-&gt;cp_state      */</span>
    movi    a3<span class="token punctuation">,</span>  <span class="token number">0</span>
    wsr     a3<span class="token punctuation">,</span>  CPENABLE
    beqz    a2<span class="token punctuation">,</span>  <span class="token number">1f</span>
    s16i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> XT_CPENABLE        <span class="token comment">/* clear saved cpenable             */</span>
<span class="token number">1</span><span class="token operator">:</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Tail-call dispatcher. */</span>
    call0   _frxt_dispatch
    <span class="token comment">/* Never reaches here. */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="frxt-dispatchå‡½æ•°"><a href="#frxt-dispatchå‡½æ•°" class="header-anchor">#</a> _frxt_dispatchå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//è¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯å°†ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„å°±ç»ªä»»åŠ¡ï¼Œæ¢å¤å®ƒçš„çŠ¶æ€ï¼Œæœ€åå°†å°†æ§åˆ¶æƒè½¬äº¤ç»™å®ƒ</span>
    <span class="token punctuation">.</span>globl  _frxt_dispatch
    <span class="token punctuation">.</span>type   _frxt_dispatch<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
_frxt_dispatch<span class="token operator">:</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    call0   vTaskSwitchContext  <span class="token comment">// Get next TCB to resume</span>
    movi    a2<span class="token punctuation">,</span> pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    call4   vTaskSwitchContext  <span class="token comment">// Get next TCB to resume</span>
    movi    a2<span class="token punctuation">,</span> pxCurrentTCB
	getcoreid a3
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    l32i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>
    l32i    sp<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> TOPOFSTACK_OFFS     <span class="token comment">/* SP = next_TCB-&gt;pxTopOfStack;  */</span>
    s32i    a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token comment">/* Determine the type of stack frame. */</span>
    l32i    a2<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_STK_EXIT        <span class="token comment">/* exit dispatcher or solicited flag */</span>
    bnez    a2<span class="token punctuation">,</span>  <span class="token punctuation">.</span>L_frxt_dispatch_stk

<span class="token punctuation">.</span>L_frxt_dispatch_sol<span class="token operator">:</span>

    <span class="token comment">/* Solicited stack frame. Restore minimal context and return from vPortYield(). */</span>
    l32i    a3<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PS
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    l32i    a12<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A12
    l32i    a13<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A13
    l32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A14
    l32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_SOL_A15
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    l32i    a0<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_PC
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Ensure wsr.CPENABLE is complete (should be, it was cleared on entry). */</span>
    rsync
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">/* As soons as PS is restored, interrupts can happen. No need to sync PS. */</span>
    wsr     a3<span class="token punctuation">,</span>  PS
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    addi    sp<span class="token punctuation">,</span>  sp<span class="token punctuation">,</span> XT_SOL_FRMSZ
    ret
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    retw
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">.</span>L_frxt_dispatch_stk<span class="token operator">:</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Restore CPENABLE from task's co-processor save area. */</span>
    movi    a3<span class="token punctuation">,</span> pxCurrentTCB            <span class="token comment">/* cp_state =                       */</span>
	getcoreid a2
	addx4	a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a3
    l32i    a3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>
    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS     <span class="token comment">/* StackType_t                       *pxStack; */</span>
    l16ui   a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> XT_CPENABLE         <span class="token comment">/* CPENABLE = cp_state-&gt;cpenable;   */</span>
    wsr     a3<span class="token punctuation">,</span> CPENABLE
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Interrupt stack frame. Restore full context and return to exit dispatcher. */</span>
    call0   _xt_context_restore

    <span class="token comment">/* In Call0 ABI, restore callee-saved regs (A12, A13 already restored). */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    l32i    a14<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_A14
    l32i    a15<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_A15
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Ensure wsr.CPENABLE has completed. */</span>
    rsync
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/*
    Must return via the exit dispatcher corresponding to the entrypoint from which
    this was called. Interruptee's A0, A1, PS, PC are restored and the interrupt
    stack frame is deallocated in the exit dispatcher.
    */</span>
    l32i    a0<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> XT_STK_EXIT
    ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h4 id="vtaskswitchcontextå‡½æ•°"><a href="#vtaskswitchcontextå‡½æ•°" class="header-anchor">#</a> vTaskSwitchContextå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ç†è®ºä¸Šï¼Œè¯¥å‡½æ•°åªæœ‰åœ¨æ»´ç­”å®šæ—¶å™¨ä¸­æ–­å’Œcrosscoreä¸­æ–­ä¸­è¢«è°ƒç”¨</span>
<span class="token keyword">void</span> <span class="token function">vTaskSwitchContext</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> irqstate<span class="token operator">=</span><span class="token function">portENTER_CRITICAL_NESTED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tskTCB <span class="token operator">*</span> pxTCB<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* The scheduler is currently suspended - do not allow a context
		switch. */</span>
		xYieldPending<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		xYieldPending<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
        xSwitchingContext<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
		<span class="token function">traceTASK_SWITCHED_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configGENERATE_RUN_TIME_STATS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">portALT_GET_RUN_TIME_COUNTER_VALUE</span></span>
					<span class="token function">portALT_GET_RUN_TIME_COUNTER_VALUE</span><span class="token punctuation">(</span> ulTotalRunTime <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
					ulTotalRunTime <span class="token operator">=</span> <span class="token function">portGET_RUN_TIME_COUNTER_VALUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

				<span class="token comment">/* Add the amount of time the task has been running to the
				accumulated time so far.  The time the task started running was
				stored in ulTaskSwitchedInTime.  Note that there is no overflow
				protection here so count values are only valid until the timer
				overflows.  The guard against negative values is to protect
				against suspect run time stat counter implementations - which
				are provided by the application, not the kernel. */</span>
				<span class="token function">taskENTER_CRITICAL_ISR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> ulTotalRunTime <span class="token operator">&gt;</span> ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulRunTimeCounter <span class="token operator">+=</span> <span class="token punctuation">(</span> ulTotalRunTime <span class="token operator">-</span> ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">taskEXIT_CRITICAL_ISR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ulTaskSwitchedInTime<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ulTotalRunTime<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configGENERATE_RUN_TIME_STATS */</span></span>

		<span class="token comment">/* Check for stack overflow, if configured. */</span>
		<span class="token function">taskFIRST_CHECK_FOR_STACK_OVERFLOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">taskSECOND_CHECK_FOR_STACK_OVERFLOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* Select a new task to run */</span>

		<span class="token comment">/*
		 We cannot do taskENTER_CRITICAL_ISR(&amp;xTaskQueueMutex); here because it saves the interrupt context to the task tcb, and we're
		 swapping that out here. Instead, we're going to do the work here ourselves. Because interrupts are already disabled, we only
		 need to acquire the mutex.
		*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FREERTOS_PORTMUX_DEBUG</span></span>
		<span class="token function">vPortCPUAcquireMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
		<span class="token function">vPortCPUAcquireMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

		<span class="token keyword">unsigned</span> portBASE_TYPE foundNonExecutingWaiter <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> resetListHead<span class="token punctuation">;</span>
		portBASE_TYPE uxDynamicTopReady <span class="token operator">=</span> uxTopReadyPriority<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> portBASE_TYPE holdTop<span class="token operator">=</span>pdFALSE<span class="token punctuation">;</span>

		<span class="token comment">/*
		 *  ToDo: This scheduler doesn't correctly implement the round-robin scheduling as done in the single-core
		 *  FreeRTOS stack when multiple tasks have the same priority and are all ready; it just keeps grabbing the
		 *  first one. ToDo: fix this.
		 *  (Is this still true? if any, there's the issue with one core skipping over the processes for the other
		 *  core, potentially not giving the skipped-over processes any time.)
		 */</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span> ableToSchedule <span class="token operator">==</span> pdFALSE <span class="token operator">&amp;&amp;</span> uxDynamicTopReady <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			resetListHead <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
			<span class="token comment">// Nothing to do for empty lists</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
				tskTCB <span class="token operator">*</span> pxRefTCB<span class="token punctuation">;</span>

				<span class="token comment">/* Remember the current list item so that we
				can detect if all items have been inspected.
				Once this happens, we move on to a lower
				priority list (assuming nothing is suitable
				for scheduling). Note: This can return NULL if
				the list index is at the listItem */</span>
				pxRefTCB <span class="token operator">=</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>pxIndex<span class="token operator">-&gt;</span>pvOwner<span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>pxIndex<span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span><span class="token punctuation">.</span>xListEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">//pxIndex points to the list end marker. Skip that and just get the next item.</span>
					<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxRefTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">do</span> <span class="token punctuation">{</span>
					<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">/* Find out if the next task in the list is
					already being executed by another core */</span>
					foundNonExecutingWaiter <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
					portBASE_TYPE i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>portNUM_PROCESSORS<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">continue</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> pxTCB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							holdTop<span class="token operator">=</span>pdTRUE<span class="token punctuation">;</span> <span class="token comment">//keep this as the top prio, for the other CPU</span>
							foundNonExecutingWaiter <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>foundNonExecutingWaiter <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">/* If the task is not being executed
						by another core and its affinity is
						compatible with the current one,
						prepare it to be swapped in */</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> tskNO_AFFINITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pxTCB<span class="token punctuation">;</span>
							ableToSchedule <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">==</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pxTCB<span class="token punctuation">;</span>
							ableToSchedule <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
							holdTop<span class="token operator">=</span>pdTRUE<span class="token punctuation">;</span> <span class="token comment">//keep this as the top prio, for the other CPU</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						ableToSchedule <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdFALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						resetListHead <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>resetListHead <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						tskTCB <span class="token operator">*</span> pxResetTCB<span class="token punctuation">;</span>
						<span class="token keyword">do</span> <span class="token punctuation">{</span>
							<span class="token function">listGET_OWNER_OF_NEXT_ENTRY</span><span class="token punctuation">(</span> pxResetTCB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> uxDynamicTopReady <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>pxResetTCB <span class="token operator">!=</span> pxRefTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ableToSchedule <span class="token operator">==</span> pdFALSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pxTCB <span class="token operator">!=</span> pxRefTCB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>holdTop<span class="token punctuation">)</span> <span class="token operator">--</span>uxTopReadyPriority<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token operator">--</span>uxDynamicTopReady<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">traceTASK_SWITCHED_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xSwitchingContext<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

		<span class="token comment">//Exit critical region manually as well: release the mux now, interrupts will be re-enabled when we</span>
		<span class="token comment">//exit the function.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FREERTOS_PORTMUX_DEBUG</span></span>
		<span class="token function">vPortCPUReleaseMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
		<span class="token function">vPortCPUReleaseMutex</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTaskQueueMutex <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_FREERTOS_WATCHPOINT_END_OF_STACK</span></span>
		<span class="token function">vPortSetStackWatchpoint</span><span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">[</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>pxStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token punctuation">}</span>
	<span class="token function">portEXIT_CRITICAL_NESTED</span><span class="token punctuation">(</span>irqstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br></div></div><h3 id="ç³»ç»Ÿæ»´ç­”å®šæ—¶å™¨ä¸­æ–­"><a href="#ç³»ç»Ÿæ»´ç­”å®šæ—¶å™¨ä¸­æ–­" class="header-anchor">#</a> ç³»ç»Ÿæ»´ç­”å®šæ—¶å™¨ä¸­æ–­</h3> <h4 id="frxt-timer-int"><a href="#frxt-timer-int" class="header-anchor">#</a> _frxt_timer_int</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//è¯¥å‡½æ•°æ˜¯ç³»ç»Ÿæ»´ç­”å®šæ—¶å™¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæ¯ä¸€æ¬¡tickæ—¶é’Ÿåˆ°æ¥éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡xPortSysTickHandler</span>
    <span class="token punctuation">.</span>globl  _frxt_timer_int
    <span class="token punctuation">.</span>type   _frxt_timer_int<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
_frxt_timer_int<span class="token operator">:</span>

    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM_TRACE</span></span>
    movi a6<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* = ESP_PM_TRACE_TICK */</span>
    getcoreid a7
    call4 esp_pm_trace_enter
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CONFIG_PM_TRACE</span></span>

<span class="token punctuation">.</span>L_xt_timer_int_catchup<span class="token operator">:</span>

    <span class="token comment">/* Update the timer comparator for the next tick. */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">XT_CLOCK_FREQ</span></span>
    movi    a2<span class="token punctuation">,</span> XT_TICK_DIVISOR         <span class="token comment">/* a2 = comparator increment          */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    movi    a3<span class="token punctuation">,</span> _xt_tick_divisor
    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>                   <span class="token comment">/* a2 = comparator increment          */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    rsr     a3<span class="token punctuation">,</span> XT_CCOMPARE             <span class="token comment">/* a3 = old comparator value          */</span>
    add     a4<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a2                  <span class="token comment">/* a4 = new comparator value          */</span>
    wsr     a4<span class="token punctuation">,</span> XT_CCOMPARE             <span class="token comment">/* update comp. and clear interrupt   */</span>
    esync

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    <span class="token comment">/* Preserve a2 and a3 across C calls. */</span>
    s32i    a2<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">4</span>
    s32i    a3<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">8</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Call the FreeRTOS tick handler (see port.c). */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    call0   xPortSysTickHandler
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    call4   xPortSysTickHandler
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    <span class="token comment">/* Restore a2 and a3. */</span>
    l32i    a2<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">4</span>
    l32i    a3<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">8</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* Check if we need to process more ticks to catch up. */</span>
    esync                               <span class="token comment">/* ensure comparator update complete  */</span>
    rsr     a4<span class="token punctuation">,</span> CCOUNT                  <span class="token comment">/* a4 = cycle count                   */</span>
    sub     a4<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> a3                  <span class="token comment">/* diff = ccount - old comparator     */</span>
    blt     a2<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> <span class="token punctuation">.</span>L_xt_timer_int_catchup  <span class="token comment">/* repeat while diff &gt; divisor */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM_TRACE</span></span>
    movi a6<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* = ESP_PM_TRACE_TICK */</span>
    getcoreid a7
    call4 esp_pm_trace_exit
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CONFIG_PM_TRACE</span></span>

    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h4 id="xportsystickhandlerå‡½æ•°"><a href="#xportsystickhandlerå‡½æ•°" class="header-anchor">#</a> xPortSysTickHandlerå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xPortSysTickHandler</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t ret<span class="token punctuation">;</span>

	<span class="token function">portbenchmarkIntLatency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">traceISR_ENTER</span><span class="token punctuation">(</span>SYSTICK_INTR_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">xTaskIncrementTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">portYIELD_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">traceISR_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">portYIELD_FROM_ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span><span class="token function">traceISR_EXIT_TO_SCHEDULER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">_frxt_setup_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="frxt-setup-switchå‡½æ•°"><a href="#frxt-setup-switchå‡½æ•°" class="header-anchor">#</a> _frxt_setup_switchå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//åœ¨å†…éƒ¨è®¾ç½®ä¸€ä¸ªflagï¼Œåœ¨é€€å‡ºä¸­æ–­çš„æ—¶å€™_frxt_int_exitä¼šæ£€æŸ¥è¯¥flagï¼Œå¦‚æœå‘ç°flagè¢«è®¾ç½®äº†ï¼Œå°±è°ƒç”¨å‡½æ•°vPortYieldFromInt</span>
    <span class="token punctuation">.</span>global     _frxt_setup_switch
    <span class="token punctuation">.</span>type       _frxt_setup_switch<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align      <span class="token number">4</span>
_frxt_setup_switch<span class="token operator">:</span>

    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

	getcoreid a3
    movi    a2<span class="token punctuation">,</span> port_switch_flag
	addx4	a2<span class="token punctuation">,</span>  a3<span class="token punctuation">,</span> a2

    movi    a3<span class="token punctuation">,</span> <span class="token number">1</span>
    s32i    a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="vportyieldfromint"><a href="#vportyieldfromint" class="header-anchor">#</a> vPortYieldFromInt</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token punctuation">.</span>globl  vPortYieldFromInt
    <span class="token punctuation">.</span>type   vPortYieldFromInt<span class="token punctuation">,</span>@function
    <span class="token punctuation">.</span>align  <span class="token number">4</span>
vPortYieldFromInt<span class="token operator">:</span>
    <span class="token function">ENTRY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">XCHAL_CP_NUM <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
    <span class="token comment">/* Save CPENABLE in task's co-processor save area, and clear CPENABLE.  */</span>
    movi    a3<span class="token punctuation">,</span> pxCurrentTCB            <span class="token comment">/* cp_state =                       */</span>
	getcoreid a2
	addx4	a3<span class="token punctuation">,</span>  a2<span class="token punctuation">,</span> a3
    l32i    a3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token number">0</span>

    l32i    a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> CP_TOPOFSTACK_OFFS

    rsr     a3<span class="token punctuation">,</span> CPENABLE
    s16i    a3<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> XT_CPENABLE         <span class="token comment">/* cp_state-&gt;cpenable = CPENABLE;   */</span>
    movi    a3<span class="token punctuation">,</span> <span class="token number">0</span>
    wsr     a3<span class="token punctuation">,</span> CPENABLE                <span class="token comment">/* disable all co-processors        */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__XTENSA_CALL0_ABI__</span></span>
    <span class="token comment">/* Tail-call dispatcher. */</span>
    call0   _frxt_dispatch
    <span class="token comment">/* Never reaches here. */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token function">RET</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="æ€»ç»“ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åœºåˆ"><a href="#æ€»ç»“ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åœºåˆ" class="header-anchor">#</a> ğŸ”šæ€»ç»“ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åœºåˆ</h4> <div class="language-mermaid line-numbers-mode"><pre class="language-text"><code>graph LR
	fd(_frxt_dispatch) --&gt; tsc(vTaskSwitchContext)
    ty(taskYIELD/portYIELD) --&gt; py(vPortYield)
    py --&gt; fd
	
	fie(XT_RTOS_INT_ENTER/_frxt_int_enter) --&gt; fti(_frxt_timer_int)
    fti --&gt; psth(xPortSysTickHandler)
    psth --&gt; pyfi(portYIELD_FROM_ISR)
	pyfi --&gt; fss(_frxt_setup_switch)
	fss --&gt; fiex(XT_RTOS_INT_EXIT/_frxt_int_exit)
	fiex --&gt; pyf(vPortYieldFromInt)
	pyf --&gt; fd

	tyoc(taskYIELD_OTHER_CORE) --&gt; vpyoc(vPortYieldOtherCore)
	vpyoc --&gt; ecisy(esp_crosscore_int_send_yield)
	ecisy --&gt; ecis(esp_crosscore_int_send)
	ecis --&gt; eci(esp_crosscore_isr)
	eci --&gt; ecihy(esp_crosscore_isr_handle_yield)
	ecihy --&gt; pyfi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="freertosæ—¶é—´ç‰‡è°ƒåº¦"><a href="#freertosæ—¶é—´ç‰‡è°ƒåº¦" class="header-anchor">#</a> FreeRTOSæ—¶é—´ç‰‡è°ƒåº¦</h2> <blockquote><p>æ—¶é—´ç‰‡è°ƒåº¦å‘ç”Ÿåœ¨æ»´ç­”å®šæ—¶å™¨çš„ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ï¼Œåœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šè°ƒç”¨xPortSysTickHandler()ï¼Œè€ŒxPortSysTickHandlerä¼šå¼•å‘ä»»åŠ¡è°ƒåº¦ï¼Œåªæ˜¯è¿™ä¸ªä»»åŠ¡è°ƒåº¦æ˜¯æœ‰æ¡ä»¶çš„ï¼Œåªæœ‰<strong>xTaskIncrementTick</strong>çš„è¿”å›å€¼ä¸ä¸ºpdFALSEæ—¶ï¼Œæ‰ä¼šè¿›è¡Œä»»åŠ¡è°ƒåº¦ã€‚å¦‚æœå½“å‰ä»»åŠ¡æ‰€å¯¹åº”çš„ä¼˜å…ˆçº§ä¸‹æœ‰å…¶ä»–çš„ä»»åŠ¡å­˜åœ¨ï¼Œé‚£ä¹ˆå‡½æ•°xTaskIncrementTickå°±ä¼šè¿”å›pdTRUEã€‚</p></blockquote> <h2 id="freertosæ—¶é—´ç®¡ç†"><a href="#freertosæ—¶é—´ç®¡ç†" class="header-anchor">#</a> FreeRTOSæ—¶é—´ç®¡ç†</h2> <h4 id="vtaskdelayç›¸å¯¹å»¶æ—¶å‡½æ•°"><a href="#vtaskdelayç›¸å¯¹å»¶æ—¶å‡½æ•°" class="header-anchor">#</a> vTaskDelayç›¸å¯¹å»¶æ—¶å‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelay</span><span class="token punctuation">(</span> <span class="token keyword">const</span> TickType_t xTicksToDelay <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    BaseType_t xAlreadyYielded <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

    <span class="token comment">//å»¶æ—¶çš„æ—¶é—´å¦‚æœä¸å¤§äº0ï¼Œé‚£å°±ç›¸å½“äºç›´æ¥è¿›è¡Œä»»åŠ¡åˆ‡æ¢</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToDelay <span class="token operator">&gt;</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            <span class="token function">traceTASK_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è®¡ç®—å”¤é†’æ—¶é—´</span>
            xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToDelay<span class="token punctuation">;</span>
            <span class="token comment">//ä»å°±ç»ªåˆ—è¡¨ä¸Šç§»é™¤</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//æ·»åŠ åˆ°å»¶æ—¶åˆ—è¡¨ä¸­</span>
            <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> xAlreadyYielded <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="prvaddcurrenttasktodelayedlistå‡½æ•°"><a href="#prvaddcurrenttasktodelayedlistå‡½æ•°" class="header-anchor">#</a> prvAddCurrentTaskToDelayedListå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token keyword">const</span> BaseType_t xCoreID<span class="token punctuation">,</span> <span class="token keyword">const</span> TickType_t xTimeToWake <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//æŒ‰ç…§å”¤é†’æ—¶é—´ä»å°åˆ°è¾¾çš„é¡ºåºï¼Œæ’å…¥å»¶æ—¶åˆ—è¡¨</span>
	<span class="token function">listSET_LIST_ITEM_VALUE</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> xTickCount <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token function">traceMOVED_TASK_TO_OVERFLOW_DELAYED_LIST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//å”¤é†’æ—¶é—´å·²ç»æº¢å‡ºï¼Œå°†å…¶æ’å…¥å»¶æ—¶æº¢å‡ºåˆ—è¡¨ä¸­</span>
		<span class="token function">vListInsert</span><span class="token punctuation">(</span> pxOverflowDelayedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
        <span class="token function">traceMOVED_TASK_TO_DELAYED_LIST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//æ—¶é—´è¿˜æ²¡æœ‰æº¢å‡ºï¼Œæ’å…¥å»¶æ—¶åˆ—è¡¨ä¸­</span>
		<span class="token function">vListInsert</span><span class="token punctuation">(</span> pxDelayedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> xCoreID <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//xNextTaskUnblockTimeæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä¿å­˜ç€è·ç¦»ä¸‹ä¸€ä¸ªè¦å–æ¶ˆé˜»å¡çš„ä»»åŠ¡æœ€å°æ—¶é—´ç‚¹å€¼</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> xNextTaskUnblockTime <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			xNextTaskUnblockTime <span class="token operator">=</span> xTimeToWake<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="vtaskdelayuntilç»å¯¹å»¶æ—¶å‡½æ•°"><a href="#vtaskdelayuntilç»å¯¹å»¶æ—¶å‡½æ•°" class="header-anchor">#</a> vTaskDelayUntilç»å¯¹å»¶æ—¶å‡½æ•°</h4> <blockquote><p>ä½¿ç”¨è¯¥å‡½æ•°å»¶æ—¶çš„ä»»åŠ¡ä¹Ÿä¸ä¸€å®šèƒ½å¤Ÿå‘¨æœŸæ€§çš„è¿è¡Œï¼Œè¯¥å‡½æ•°åªèƒ½ä¿è¯æŒ‰ç…§ä¸€å®šçš„å‘¨æœŸå–æ¶ˆé˜»å¡ï¼Œè¿›å…¥å°±ç»ªæ€</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">vTaskDelayUntil</span><span class="token punctuation">(</span> TickType_t <span class="token operator">*</span> <span class="token keyword">const</span> pxPreviousWakeTime<span class="token punctuation">,</span> <span class="token keyword">const</span> TickType_t xTimeIncrement <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    BaseType_t xAlreadyYielded<span class="token operator">=</span>pdFALSE<span class="token punctuation">,</span> xShouldDelay <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> pxPreviousWakeTime <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeIncrement <span class="token operator">&gt;</span> <span class="token number">0U</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxSchedulerSuspended<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> TickType_t xConstTickCount <span class="token operator">=</span> xTickCount<span class="token punctuation">;</span>
        <span class="token comment">//è®¡ç®—ä»»åŠ¡è¢«å”¤é†’çš„æ—¶åˆ»</span>
        xTimeToWake <span class="token operator">=</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token operator">+</span> xTimeIncrement<span class="token punctuation">;</span>
        <span class="token comment">//tickè®¡æ•°å™¨æº¢å‡º</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xConstTickCount <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//tickè®¡æ•°å™¨å’Œå”¤é†’æ—¶é—´éƒ½æº¢å‡ºï¼Œä¸”tickè®¡æ•°å™¨å€¼æ¯”å”¤é†’æ—¶é—´å°</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&gt;</span> xConstTickCount <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                xShouldDelay <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//tickè®¡æ•°å™¨æ²¡æœ‰æº¢å‡ºï¼Œå”¤é†’æ—¶é—´æº¢å‡ºæˆ–è€…tickè®¡æ•°å™¨å€¼æ¯”å”¤é†’æ—¶é—´å°ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½è¯´æ˜è¿˜éœ€è¦ç»§ç»­å»¶æ—¶</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&lt;</span> <span class="token operator">*</span>pxPreviousWakeTime <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> xTimeToWake <span class="token operator">&gt;</span> xConstTickCount <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                xShouldDelay <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ä¸ºæœ¬å‡½æ•°çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œåšå¥½å‡†å¤‡</span>
        <span class="token operator">*</span>pxPreviousWakeTime <span class="token operator">=</span> xTimeToWake<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> xShouldDelay <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">traceTASK_DELAY_UNTIL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ä»å°±åºåˆ—è¡¨ä¸­ç§»é™¤</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> xAlreadyYielded <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h4 id="portyield-within-apiå®å®šä¹‰"><a href="#portyield-within-apiå®å®šä¹‰" class="header-anchor">#</a> portYIELD_WITHIN_APIå®å®šä¹‰</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ä¸Šä¸‹æ–‡åˆ‡æ¢å·¥ä½œéœ€è¦ç­‰å¾…ç›´åˆ°ä¸­æ–­è¢«å…è®¸åæ‰æ‰§è¡Œï¼Œè¿™é‡Œä½¿ç”¨cross-coreä¸­æ–­æ¥è§¦å‘è‡ªå·±</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">esp_crosscore_int_send_yield</span><span class="token punctuation">(</span><span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="xtaskincreamenttickå‡½æ•°çš„ä¸»è¦åŠŸèƒ½"><a href="#xtaskincreamenttickå‡½æ•°çš„ä¸»è¦åŠŸèƒ½" class="header-anchor">#</a> xTaskIncreamentTickå‡½æ•°çš„ä¸»è¦åŠŸèƒ½</h4> <blockquote><p>xTickCountæ˜¯FreeRTOSçš„ç³»ç»ŸèŠ‚æ‹è®¡æ•°å™¨ï¼Œæ¯ä¸ªæ»´ç­”å®šæ—¶å™¨ä¸­æ–­åxTickCountå°±ä¼šå¢åŠ ä¸€ï¼ŒxTickCountçš„å…·ä½“æ“ä½œæ˜¯åœ¨å‡½æ•°xTaskIncrementTickä¸­è¿›è¡Œçš„</p></blockquote> <ol><li>ç³»ç»ŸèŠ‚æ‹è®¡æ•°å™¨çš„å€¼åŠ 1</li> <li>åˆ¤æ–­æ˜¯å¦æœ‰ä»»åŠ¡çš„å»¶æ—¶ç­‰å¾…æ—¶é—´å·²åˆ°ï¼Œå¦‚æœå°±å°±å°†å…¶æ¢å¤</li> <li>å¤„ç†æ—¶é—´ç‰‡è°ƒåº¦</li> <li>ç»¼ä¸Šç»™å‡ºæ˜¯å¦éœ€è¦æ‰§è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„åˆ¤æ–­ç»“æœå¹¶è¿”å›æ»´ç­”å®šæ—¶å™¨ä¸­æ–­</li></ol> <h2 id="freertosé˜Ÿåˆ—"><a href="#freertosé˜Ÿåˆ—" class="header-anchor">#</a> FreeRTOSé˜Ÿåˆ—</h2> <h4 id="é˜Ÿåˆ—ç»“æ„ä½“queue-t"><a href="#é˜Ÿåˆ—ç»“æ„ä½“queue-t" class="header-anchor">#</a> é˜Ÿåˆ—ç»“æ„ä½“Queue_t</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">QueueDefinition</span>
<span class="token punctuation">{</span>
	int8_t <span class="token operator">*</span>pcHead<span class="token punctuation">;</span>					<span class="token comment">//æŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºå¼€å§‹ä½ç½®</span>
	int8_t <span class="token operator">*</span>pcTail<span class="token punctuation">;</span>					<span class="token comment">//æŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºæœ€åä¸€ä¸ªå­—èŠ‚</span>
	int8_t <span class="token operator">*</span>pcWriteTo<span class="token punctuation">;</span>				<span class="token comment">//æŒ‡å‘å­˜å‚¨åŒºä¸­ä¸‹ä¸€ä¸ªç©ºé—²åŒºåŸŸ</span>
	<span class="token keyword">union</span>							
	<span class="token punctuation">{</span>
		int8_t <span class="token operator">*</span>pcReadFrom<span class="token punctuation">;</span>			<span class="token comment">//ç”¨ä½œé˜Ÿåˆ—æ—¶æŒ‡å‘æœ€åä¸€ä¸ªå‡ºé˜Ÿçš„é˜Ÿåˆ—é¡¹é¦–åœ°å€</span>
		UBaseType_t uxRecursiveCallCount<span class="token punctuation">;</span><span class="token comment">//ç”¨ä½œé€’å½’äº’æ–¥ä¿¡å·é‡æ—¶ç”¨æ¥è®°å½•é€’å½’äº’æ–¥ä¿¡å·é‡è¢«è°ƒç”¨çš„æ¬¡æ•°</span>
	<span class="token punctuation">}</span> u<span class="token punctuation">;</span>
	List_t xTasksWaitingToSend<span class="token punctuation">;</span>		<span class="token comment">//é‚£äº›å› ä¸ºé˜Ÿåˆ—æ»¡å¯¼è‡´å…¥é˜Ÿå¤±è´¥è€Œè¿›å…¥é˜»å¡æ€çš„ä»»åŠ¡å°±ä¼šæŒ‚åˆ°æ­¤åˆ—è¡¨ä¸Šï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§æ’åˆ—</span>
	List_t xTasksWaitingToReceive<span class="token punctuation">;</span>	<span class="token comment">//é‚£äº›å› ä¸ºé˜Ÿåˆ—ç©ºå¯¼è‡´å‡ºé˜Ÿå¤±è´¥è€Œè¿›å…¥é˜»å¡æ€çš„ä»»åŠ¡å°±ä¼šæŒ‚åˆ°æ­¤åˆ—è¡¨ä¸Šï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§æ’åˆ—</span>

	<span class="token keyword">volatile</span> UBaseType_t uxMessagesWaiting<span class="token punctuation">;</span><span class="token comment">//é˜Ÿåˆ—ä¸­å½“å‰çš„æ¶ˆæ¯æ•°é‡</span>
	UBaseType_t uxLength<span class="token punctuation">;</span>			<span class="token comment">//é˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§çš„æ¶ˆæ¯æ•°é‡</span>
	UBaseType_t uxItemSize<span class="token punctuation">;</span>			<span class="token comment">//æ¯ä¸ªæ¶ˆæ¯å…è®¸çš„æœ€å¤§é•¿åº¦</span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> configSUPPORT_STATIC_ALLOCATION <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> configSUPPORT_DYNAMIC_ALLOCATION <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
		uint8_t ucStaticallyAllocated<span class="token punctuation">;</span>	<span class="token comment">//å¦‚æœé˜Ÿåˆ—çš„å†…å­˜æ˜¯é™æ€åˆ†é…çš„ï¼Œåˆ™ä¸ºpdTRUE</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_QUEUE_SETS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token keyword">struct</span> <span class="token class-name">QueueDefinition</span> <span class="token operator">*</span>pxQueueSetContainer<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TRACE_FACILITY <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		UBaseType_t uxQueueNumber<span class="token punctuation">;</span>
		uint8_t ucQueueType<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	portMUX_TYPE mux<span class="token punctuation">;</span>		<span class="token comment">//å› ä¸ºSMPçš„åŸå› ï¼Œæ‰€ä»¥éœ€è¦äº’æ–¥é”</span>

<span class="token punctuation">}</span> xQUEUE<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> xQUEUE Queue_t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="åˆ›å»ºé˜Ÿåˆ—xqueuecreate"><a href="#åˆ›å»ºé˜Ÿåˆ—xqueuecreate" class="header-anchor">#</a> åˆ›å»ºé˜Ÿåˆ—xQueueCreate</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xQueueCreate</span><span class="token punctuation">(</span> uxQueueLength<span class="token punctuation">,</span> uxItemSize <span class="token punctuation">)</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxQueueLength <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> uxItemSize <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> queueQUEUE_TYPE_BASE <span class="token punctuation">)</span> <span class="token punctuation">)</span></span><span class="token comment">//æ™®é€šæ¶ˆæ¯é˜Ÿåˆ—çš„ç±»å‹æ˜¯queueQUEUE_TYPE_BASE</span></span>
QueueHandle_t <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxQueueLength<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxItemSize<span class="token punctuation">,</span> <span class="token keyword">const</span> uint8_t ucQueueType <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Queue_t <span class="token operator">*</span>pxNewQueue<span class="token punctuation">;</span>
    size_t xQueueSizeInBytes<span class="token punctuation">;</span>
    uint8_t <span class="token operator">*</span>pucQueueStorage<span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxQueueLength <span class="token operator">&gt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> uxItemSize <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        xQueueSizeInBytes <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœé˜Ÿåˆ—å¤§å°ä¸º0ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å­˜å‚¨åŒº</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        xQueueSizeInBytes <span class="token operator">=</span> <span class="token punctuation">(</span> size_t <span class="token punctuation">)</span> <span class="token punctuation">(</span> uxQueueLength <span class="token operator">*</span> uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pxNewQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Queue_t <span class="token punctuation">)</span> <span class="token operator">+</span> xQueueSizeInBytes <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ†é…å†…å­˜ï¼Œè¿™é‡Œç”³è¯·çš„å†…å­˜å¤§å°æ˜¯é˜Ÿåˆ—ç»“æ„ä½“å’Œé˜Ÿåˆ—ä¸­æ¶ˆæ¯å­˜å‚¨åŒºçš„æ€»å¤§å°</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewQueue <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pucQueueStorage <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> uint8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxNewQueue <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Queue_t <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configSUPPORT_STATIC_ALLOCATION <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
        <span class="token punctuation">{</span>
            pxNewQueue<span class="token operator">-&gt;</span>ucStaticallyAllocated <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configSUPPORT_STATIC_ALLOCATION */</span></span>
        <span class="token function">prvInitialiseNewQueue</span><span class="token punctuation">(</span> uxQueueLength<span class="token punctuation">,</span> uxItemSize<span class="token punctuation">,</span> pucQueueStorage<span class="token punctuation">,</span> ucQueueType<span class="token punctuation">,</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–é˜Ÿåˆ—</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pxNewQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="åˆå§‹åŒ–é˜Ÿåˆ—prvinitialisenewqueue"><a href="#åˆå§‹åŒ–é˜Ÿåˆ—prvinitialisenewqueue" class="header-anchor">#</a> åˆå§‹åŒ–é˜Ÿåˆ—prvInitialiseNewQueue</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseNewQueue</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxQueueLength<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxItemSize<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>pucQueueStorage<span class="token punctuation">,</span> <span class="token keyword">const</span> uint8_t ucQueueType<span class="token punctuation">,</span> Queue_t <span class="token operator">*</span>pxNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> ucQueueType<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> uxItemSize <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token comment">//æ²¡æœ‰é˜Ÿåˆ—å­˜å‚¨åŒºï¼Œè¿™é‡Œå°†pcHeadæŒ‡å‘é˜Ÿåˆ—å¼€å§‹åœ°å€</span>
		pxNewQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">=</span> <span class="token punctuation">(</span> int8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxNewQueue<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//è®¾ç½®pcHaedæŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºé¦–åœ°å€</span>
		pxNewQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">=</span> <span class="token punctuation">(</span> int8_t <span class="token operator">*</span> <span class="token punctuation">)</span> pucQueueStorage<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//åˆå§‹åŒ–é˜Ÿåˆ—ç»“æ„ä½“ç›¸å…³æˆå‘˜å˜é‡</span>
	pxNewQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">=</span> uxQueueLength<span class="token punctuation">;</span>
	pxNewQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token operator">=</span> uxItemSize<span class="token punctuation">;</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericReset</span><span class="token punctuation">(</span> pxNewQueue<span class="token punctuation">,</span> pdTRUE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤ä½é˜Ÿåˆ—</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TRACE_FACILITY <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewQueue<span class="token operator">-&gt;</span>ucQueueType <span class="token operator">=</span> ucQueueType<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_TRACE_FACILITY */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_QUEUE_SETS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		pxNewQueue<span class="token operator">-&gt;</span>pxQueueSetContainer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_QUEUE_SETS */</span></span>
	<span class="token function">traceQUEUE_CREATE</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="é˜Ÿåˆ—å¤ä½å‡½æ•°xqueuegenericreset"><a href="#é˜Ÿåˆ—å¤ä½å‡½æ•°xqueuegenericreset" class="header-anchor">#</a> é˜Ÿåˆ—å¤ä½å‡½æ•°xQueueGenericReset</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xQueueGenericReset</span><span class="token punctuation">(</span> QueueHandle_t xQueue<span class="token punctuation">,</span> BaseType_t xNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	Queue_t <span class="token operator">*</span> <span class="token keyword">const</span> pxQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xQueue<span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> xNewQueue <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–äº’æ–¥é”</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{</span>
		pxQueue<span class="token operator">-&gt;</span>pcTail <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">+</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">*</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//pcTailæŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºçš„æœ«å°¾</span>
		pxQueue<span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">;</span><span class="token comment">//é˜Ÿåˆ—ä¸­å½“å‰çš„æ¶ˆæ¯æ•°é‡æ˜¯0</span>
		pxQueue<span class="token operator">-&gt;</span>pcWriteTo <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead<span class="token punctuation">;</span><span class="token comment">//æŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºä¸­ä¸‹ä¸€ä¸ªå¯å†™å…¥çš„ä½ç½®</span>
		pxQueue<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>pcReadFrom <span class="token operator">=</span> pxQueue<span class="token operator">-&gt;</span>pcHead <span class="token operator">+</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">-</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1U</span> <span class="token punctuation">)</span> <span class="token operator">*</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å‘é˜Ÿåˆ—å­˜å‚¨åŒºä¸­ä¸‹ä¸€ä¸ªå¯è¯»å–çš„ä½ç½®</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> xNewQueue <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//ç”±äºå¤ä½é˜Ÿåˆ—ä»¥åé˜Ÿåˆ—ä¾æ—§æ˜¯ç©ºçš„ï¼Œå¯¹äºé‚£äº›ä»é˜Ÿåˆ—ä¸­è¯»å–è€Œè¢«é˜»å¡çš„ä»»åŠ¡æ¥è¯´ä¾æ—§ä¿æŒé˜»å¡çŠ¶æ€ã€‚ä½†æ˜¯å¯¹äºé‚£äº›å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®è€Œé˜»å¡çš„ä»»åŠ¡æ¥è¯´ï¼Œè¿™äº›ä»»åŠ¡éœ€è¦æ¥è§¦é˜»å¡çŠ¶æ€</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//åˆå§‹åŒ–é˜Ÿåˆ—ä¸­çš„åˆ—è¡¨xTasksWaitingToSendå’ŒxTasksWaitingToReceive</span>
			<span class="token function">vListInitialise</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">vListInitialise</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> pdPASS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯"><a href="#å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯" class="header-anchor">#</a> å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯</h4> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xQueueSend</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆåå‘å…¥é˜Ÿï¼‰</td></tr> <tr><td>xQueueSendToBack</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆåå‘å…¥é˜Ÿï¼‰</td></tr> <tr><td>xQueueSendToFront</td> <td>å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—å¤´ï¼ˆå‰å‘å…¥é˜Ÿï¼‰</td></tr> <tr><td>xQueueOverwrite</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¸¦è¦†å†™åŠŸèƒ½ï¼›é˜Ÿåˆ—æ»¡äº†ä»¥åè‡ªåŠ¨è¦†ç›–æ‰æ—§çš„æ¶ˆæ¯ï¼›é€šå¸¸ç”¨äºå‘é‚£äº›é•¿åº¦ä¸º1çš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯</td></tr> <tr><td>xQueueSendFromISR</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆåå‘å…¥é˜Ÿï¼‰ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°</td></tr> <tr><td>xQueueSendToBackFromISR</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆåå‘å…¥é˜Ÿï¼‰ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°</td></tr> <tr><td>xQueueSendToFrontFromISR</td> <td>å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—å¤´ï¼ˆå‰å‘å…¥é˜Ÿï¼‰ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°</td></tr> <tr><td>xQueueOverwriteFromISR</td> <td>å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¸¦è¦†å†™åŠŸèƒ½ï¼›é˜Ÿåˆ—æ»¡äº†ä»¥åè‡ªåŠ¨è¦†ç›–æ‰æ—§çš„æ¶ˆæ¯ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°</td></tr></tbody></table> <h4 id="xqueuegenericsendå‡½æ•°"><a href="#xqueuegenericsendå‡½æ•°" class="header-anchor">#</a> xQueueGenericSendå‡½æ•°</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xQueueGenericSend</span><span class="token punctuation">(</span> QueueHandle_t xQueue<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvItemToQueue<span class="token punctuation">,</span> TickType_t xTicksToWait<span class="token punctuation">,</span> <span class="token keyword">const</span> BaseType_t xCopyPosition <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	BaseType_t xEntryTimeSet <span class="token operator">=</span> pdFALSE<span class="token punctuation">,</span> xYieldRequired<span class="token punctuation">;</span>
	TimeOut_t xTimeOut<span class="token punctuation">;</span>
	Queue_t <span class="token operator">*</span> <span class="token keyword">const</span> pxQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xQueue<span class="token punctuation">;</span>

	<span class="token function">configASSERT</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pvItemToQueue <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxItemSize <span class="token operator">!=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0U</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xCopyPosition <span class="token operator">==</span> queueOVERWRITE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> INCLUDE_xTaskGetSchedulerState <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> configUSE_TIMERS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">xTaskGetSchedulerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> taskSCHEDULER_SUSPENDED <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xTicksToWait <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">&lt;</span> pxQueue<span class="token operator">-&gt;</span>uxLength <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> xCopyPosition <span class="token operator">==</span> queueOVERWRITE <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">//å½“é˜Ÿåˆ—æœªæ»¡æˆ–è€…æ˜¯è¦†å†™å…¥é˜Ÿï¼Œåˆ™å¯ä»¥å°†æ¶ˆæ¯å…¥é˜Ÿ</span>
			<span class="token punctuation">{</span>
				<span class="token function">traceQUEUE_SEND</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
				xYieldRequired <span class="token operator">=</span> <span class="token function">prvCopyDataToQueue</span><span class="token punctuation">(</span> pxQueue<span class="token punctuation">,</span> pvItemToQueue<span class="token punctuation">,</span> xCopyPosition <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†æ¶ˆæ¯å¤åˆ¶åˆ°é˜Ÿåˆ—ä¸­</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_QUEUE_SETS <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
				<span class="token punctuation">{</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>pxQueueSetContainer <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvNotifyQueueSetContainer</span><span class="token punctuation">(</span> pxQueue<span class="token punctuation">,</span> xCopyPosition <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token comment">/* The queue is a member of a queue set, and posting
							to the queue set caused a higher priority task to
							unblock. A context switch is required. */</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
							<span class="token punctuation">{</span>
								<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token keyword">else</span>
							<span class="token punctuation">{</span>
								<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xYieldRequired <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* configUSE_QUEUE_SETS */</span></span>
				<span class="token punctuation">{</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listLIST_IS_EMPTY</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡ç”±äºè¯·æ±‚é˜Ÿåˆ—æ¶ˆæ¯è€Œé˜»å¡ï¼Œé˜»å¡çš„ä»»åŠ¡ä¼šæŒ‚åœ¨é˜Ÿåˆ—çš„xTasksWaitingToReceiveåˆ—è¡¨ä¸Š</span>
					<span class="token punctuation">{</span>
                        <span class="token comment">//å°†é˜»å¡çš„ä»»åŠ¡ä»åˆ—è¡¨xTasksWaitingToReceiveä¸Šç§»é™¤ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªä»»åŠ¡æ·»åŠ åˆ°å°±åºåˆ—è¡¨ä¸­ã€‚å¦‚æœè°ƒåº¦å™¨ä¸Šé”ï¼Œåˆ™è¿™äº›ä»»åŠ¡å°±ä¼šæŒ‚åˆ°åˆ—è¡¨xPendingReadyListä¸Šã€‚å¦‚æœå–æ¶ˆé˜»å¡çš„ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§é«˜ï¼Œåˆ™è¿˜è¦æ ‡è®°éœ€è¦è¿›è¡Œä»»åŠ¡åˆ‡æ¢ã€‚å½“å‡½æ•°xTaskRemoveFromEventListè¿”å›å€¼ä¸ºpdTRUEæ—¶ï¼Œéœ€è¦è¿›è¡Œä»»åŠ¡åˆ‡æ¢</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskRemoveFromEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToReceive <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE <span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span>
						<span class="token punctuation">{</span>
							<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xYieldRequired <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token function">queueYIELD_IF_USING_PREEMPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_QUEUE_SETS */</span></span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> pdPASS<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//é˜Ÿåˆ—å·²æ»¡ï¼Œå…¥é˜Ÿæœ‰é˜»ç¢</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">==</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token comment">//æ²¡æœ‰è®¾ç½®é˜»å¡æ—¶é—´æˆ–è€…ç­‰å¾…æ—¶é—´å·²åˆ°</span>
				<span class="token punctuation">{</span>
					<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">traceQUEUE_SEND_FAILED</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> errQUEUE_FULL<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> xEntryTimeSet <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token comment">//è®¾ç½®è¶…æ—¶æ—¶é—´ç»“æ„ä½“ï¼Œè®°å½•å½“å‰ç³»ç»Ÿå§‹ç»ˆèŠ‚æ‹è®¡æ•°å™¨çš„å€¼xTickCountå’Œæº¢å‡ºæ¬¡æ•°xNumOfOverflows</span>
					<span class="token function">vTaskSetTimeOutState</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTimeOut <span class="token punctuation">)</span><span class="token punctuation">;</span>
					xEntryTimeSet <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{</span>
					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜é˜Ÿåˆ—å·²æ»¡ï¼Œè€Œä¸”è®¾ç½®äº†ä¸ä¸º0çš„é˜»å¡æ—¶é—´</span>
		<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">xTaskCheckForTimeOut</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xTimeOut<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xTicksToWait <span class="token punctuation">)</span> <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//æ›´æ–°xTimeOutï¼Œå¹¶æ£€æŸ¥é˜»å¡æ—¶é—´æ˜¯å¦åˆ°äº†</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">prvIsQueueFull</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span> <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span><span class="token comment">//é˜Ÿåˆ—ä¾æ—§æ˜¯æ»¡çš„</span>
			<span class="token punctuation">{</span>
				<span class="token function">traceBLOCKING_ON_QUEUE_SEND</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">vTaskPlaceOnEventList</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxQueue<span class="token operator">-&gt;</span>xTasksWaitingToSend <span class="token punctuation">)</span><span class="token punctuation">,</span> xTicksToWait <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—çš„xTasksWaitingToSendåˆ—è¡¨å’Œå»¶æ—¶åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸”å°†ä»»åŠ¡ä»å°±ç»ªåˆ—è¡¨ä¸­ç§»é™¤</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//é˜»å¡æ—¶é—´è¿˜æ²¡æœ‰åˆ°ï¼Œä½†æ˜¯é˜Ÿåˆ—ç°åœ¨æœ‰ç©ºé—²ï¼Œé‚£ä¹ˆå°±é‡æ–°æ‰§è¡Œä¸€æ¬¡æœ¬å¾ªç¯</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token comment">//éœ€è¦é˜»å¡çš„æ—¶é—´åˆ°äº†</span>
		<span class="token punctuation">{</span>
			<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">traceQUEUE_SEND_FAILED</span><span class="token punctuation">(</span> pxQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> errQUEUE_FULL<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br></div></div><h4 id="ä»é˜Ÿåˆ—è¯»å–æ¶ˆæ¯"><a href="#ä»é˜Ÿåˆ—è¯»å–æ¶ˆæ¯" class="header-anchor">#</a> ä»é˜Ÿåˆ—è¯»å–æ¶ˆæ¯</h4> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xQueueReceive</td> <td>ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­å°†å…¶åˆ é™¤</td></tr> <tr><td>xQueuePeek</td> <td>ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œä¸ä¼šå°†å…¶ä»é˜Ÿåˆ—ä¸­åˆ é™¤</td></tr> <tr><td>xQueueReceiveFromISR</td> <td>ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­å°†å…¶åˆ é™¤ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>xQueuePeekFromISR</td> <td>ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œä¸ä¼šå°†å…¶ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œç”¨äºä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr></tbody></table> <h2 id="freertosä¿¡å·é‡"><a href="#freertosä¿¡å·é‡" class="header-anchor">#</a> FreeRTOSä¿¡å·é‡</h2> <h4 id="äºŒå€¼ä¿¡å·é‡å’Œäº’æ–¥ä¿¡å·é‡çš„å·®åˆ«"><a href="#äºŒå€¼ä¿¡å·é‡å’Œäº’æ–¥ä¿¡å·é‡çš„å·®åˆ«" class="header-anchor">#</a> äºŒå€¼ä¿¡å·é‡å’Œäº’æ–¥ä¿¡å·é‡çš„å·®åˆ«</h4> <blockquote><ol><li>äº’æ–¥ä¿¡å·é‡æ‹¥æœ‰<strong>ä¼˜å…ˆçº§ç»§æ‰¿æœºåˆ¶</strong>ï¼Œè€ŒäºŒå€¼ä¿¡å·é‡æ²¡æœ‰ä¼˜å…ˆçº§ç»§æ‰¿</li> <li>äºŒå€¼ä¿¡å·é‡æ›´é€‚ç”¨äºåŒæ­¥ï¼Œè€Œäº’æ–¥ä¿¡å·é‡é€‚ç”¨äºç®€å•çš„äº’æ–¥è®¿é—®</li></ol></blockquote> <h4 id="äºŒå€¼ä¿¡å·é‡"><a href="#äºŒå€¼ä¿¡å·é‡" class="header-anchor">#</a> äºŒå€¼ä¿¡å·é‡</h4> <blockquote><p>äºŒå€¼ä¿¡å·é‡å…¶å®å°±æ˜¯åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—é¡¹çš„é˜Ÿåˆ—ï¼Œè¿™ä¸ªç‰¹æ®Šçš„é˜Ÿåˆ—è¦ä¹ˆæ˜¯æ»¡çš„ï¼Œè¦ä¹ˆæ˜¯ç©ºçš„ï¼Œæ­£å¥½å°±æ˜¯äºŒå€¼ã€‚ä»»åŠ¡å’Œä¸­æ–­ä½¿ç”¨è¿™ä¸ªç‰¹æ®Šé˜Ÿåˆ—çš„æ—¶å€™ä¸ç”¨åœ¨ä¹é˜Ÿåˆ—ä¸­å­˜åœ¨çš„æ˜¯ä»€ä¹ˆæ¶ˆæ¯ï¼Œåªéœ€è¦çŸ¥é“è¿™ä¸ªé˜Ÿåˆ—æ˜¯æ»¡çš„è¿˜æ˜¯ç©ºçš„å³å¯ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºåˆ¶æ¥å®Œæˆä»»åŠ¡å’Œä¸­æ–­ä¹‹é—´çš„åŒæ­¥ã€‚äºŒå€¼ä¿¡å·é‡ä½¿ç”¨çš„é˜Ÿåˆ—æ˜¯æ²¡æœ‰å­˜å‚¨åŒºçš„ï¼Œé˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºå¯ä»¥é€šè¿‡é˜Ÿåˆ—ç»“æ„ä½“çš„æˆå‘˜å˜é‡uxMessagesWaitingæ¥åˆ¤æ–­ã€‚</p></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xSemaphoreCreateBinary</td> <td>åŠ¨æ€åˆ›å»ºäºŒå€¼ä¿¡å·é‡ï¼Œæ–°åˆ›å»ºçš„äºŒå€¼ä¿¡å·é‡é»˜è®¤æ˜¯ç©ºçš„</td></tr> <tr><td>xSemaphoreCreateBinaryStatic</td> <td>é™æ€åˆ›å»ºäºŒå€¼ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreGive</td> <td>ä»»åŠ¡çº§ä¿¡å·é‡é‡Šæ”¾å‡½æ•°ï¼Œå¯ç”¨äºé‡Šæ”¾äºŒå€¼ä¿¡å·é‡ã€è®¡æ•°å‹ä¿¡å·é‡å’Œäº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreGiveFromISR</td> <td>ä¸­æ–­çº§ä¿¡å·é‡é‡Šæ”¾å‡½æ•°ï¼Œåªèƒ½ç”¨äºé‡Šæ”¾äºŒå€¼ä¿¡å·é‡å’Œè®¡æ•°å‹ä¿¡å·é‡ï¼Œä¸èƒ½é‡Šæ”¾äº’æ–¥ä¿¡å·é‡(å› ä¸ºäº’æ–¥ä¿¡å·é‡éœ€è¦å¤„ç† ä¼˜å…ˆçº§ç»§æ‰¿çš„é—®é¢˜ï¼Œè€Œä¸­æ–­ä¸å±äºä»»åŠ¡)</td></tr> <tr><td>xSemaphoreTake</td> <td>ä»»åŠ¡çº§è·å–ä¿¡å·é‡å‡½æ•°ï¼Œå¯ç”¨äºè·å–äºŒå€¼ä¿¡å·é‡ã€è®¡æ•°å‹ä¿¡å·é‡å’Œäº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreTakeFromISR</td> <td>ä¸­æ–­çº§è·å–ä¿¡å·é‡å‡½æ•°ï¼Œåªèƒ½ç”¨äºè·å–äºŒå€¼ä¿¡å·é‡å’Œè®¡æ•°å‹ä¿¡å·é‡ï¼Œä¸èƒ½è·å–äº’æ–¥ä¿¡å·é‡(å› ä¸ºäº’æ–¥ä¿¡å·é‡éœ€è¦å¤„ç† ä¼˜å…ˆçº§ç»§æ‰¿çš„é—®é¢˜ï¼Œè€Œä¸­æ–­ä¸å±äºä»»åŠ¡)</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreCreateBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">,</span> semSEMAPHORE_QUEUE_ITEM_LENGTH<span class="token punctuation">,</span> queueQUEUE_TYPE_BINARY_SEMAPHORE <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span> xSemaphore <span class="token punctuation">)</span> <span class="token function">xQueueGenericSend</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> QueueHandle_t <span class="token punctuation">)</span> <span class="token punctuation">(</span> xSemaphore <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> semGIVE_BLOCK_TIME<span class="token punctuation">,</span> queueSEND_TO_BACK <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span> xSemaphore<span class="token punctuation">,</span> xBlockTime <span class="token punctuation">)</span> <span class="token function">xQueueGenericReceive</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> QueueHandle_t <span class="token punctuation">)</span> <span class="token punctuation">(</span> xSemaphore <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> xBlockTime <span class="token punctuation">)</span><span class="token punctuation">,</span> pdFALSE <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreTakeFromISR</span><span class="token punctuation">(</span> xSemaphore<span class="token punctuation">,</span> pxHigherPriorityTaskWoken <span class="token punctuation">)</span>	<span class="token function">xQueueReceiveFromISR</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> QueueHandle_t <span class="token punctuation">)</span> <span class="token punctuation">(</span> xSemaphore <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> pxHigherPriorityTaskWoken <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="è®¡æ•°å‹ä¿¡å·é‡"><a href="#è®¡æ•°å‹ä¿¡å·é‡" class="header-anchor">#</a> è®¡æ•°å‹ä¿¡å·é‡</h4> <blockquote><p>è®¡æ•°å‹ä¿¡å·é‡å°±æ˜¯é•¿åº¦ä¸ºå¤§äº1çš„é˜Ÿåˆ—ï¼Œåªæ˜¯æ— éœ€å…³å¿ƒé˜Ÿåˆ—ä¸­å­˜å‚¨äº†ä»€ä¹ˆæ•°æ®ï¼Œè®¡æ•°å‹ä¿¡å·é‡ä¸»è¦åº”ç”¨åœºåˆæ˜¯ï¼š</p> <ol><li><p>äº‹ä»¶è®¡æ•°</p> <p>æ¯æ¬¡äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™å°±åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­é‡Šæ”¾ä¿¡å·é‡ï¼ˆå¢åŠ ä¿¡å·é‡çš„è®¡æ•°å€¼ï¼‰ï¼Œå…¶ä»–ä»»åŠ¡ä¼šè·å–ä¿¡å·é‡æ¥å¤„ç†äº‹ä»¶ã€‚åœ¨è¿™ç§åœºåˆä¸­ï¼Œåˆ›å»ºçš„è®¡æ•°å‹ä¿¡å·é‡åˆå§‹è®¡æ•°å€¼ä¸º0</p></li> <li><p>èµ„æºç®¡ç†</p> <p>ä¿¡å·é‡å€¼ä»£è¡¨å½“å‰èµ„æºçš„å¯ç”¨æ•°é‡ï¼Œä¸€ä¸ªä»»åŠ¡æƒ³è¦è·å¾—èµ„æºçš„ä½¿ç”¨æƒï¼Œé¦–å…ˆå¿…é¡»è·å–ä¿¡å·é‡ï¼ŒæˆåŠŸä»¥åä¿¡å·é‡çš„å€¼å°±ä¼šå‡1ï¼Œå½“ä¿¡å·é‡å€¼ä¸º0çš„æ—¶å€™å°±è¯´æ˜æ²¡æœ‰èµ„æºäº†ã€‚ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨å®Œèµ„æºä»¥åä¸€å®šè¦é‡Šæ”¾ä¿¡å·é‡ï¼Œé‡Šæ”¾ä¿¡å·é‡ä»¥åä¿¡å·é‡å€¼ä¼šåŠ 1.åœ¨è¿™ç§åœºåˆä¸­ï¼Œåˆ›å»ºçš„è®¡æ•°å‹ä¿¡å·é‡åˆå§‹å€¼åº”è¯¥æ˜¯èµ„æºçš„æ•°é‡</p></li></ol></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xSemaphoreCreateCoumting</td> <td>ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºè®¡æ•°å‹ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreCreateCountingStatic</td> <td>ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºè®¡æ•°å‹ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreGetCount</td> <td>è·å–è®¡æ•°å‹ä¿¡å·é‡çš„å€¼</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreCreateCounting</span><span class="token punctuation">(</span> uxMaxCount<span class="token punctuation">,</span> uxInitialCount <span class="token punctuation">)</span> <span class="token function">xQueueCreateCountingSemaphore</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxMaxCount <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> uxInitialCount <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreCreateCountingStatic</span><span class="token punctuation">(</span> uxMaxCount<span class="token punctuation">,</span> uxInitialCount<span class="token punctuation">,</span> pxSemaphoreBuffer <span class="token punctuation">)</span> <span class="token function">xQueueCreateCountingSemaphoreStatic</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxMaxCount <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> uxInitialCount <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> pxSemaphoreBuffer <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
QueueHandle_t <span class="token function">xQueueCreateCountingSemaphore</span><span class="token punctuation">(</span> <span class="token keyword">const</span> UBaseType_t uxMaxCount<span class="token punctuation">,</span> <span class="token keyword">const</span> UBaseType_t uxInitialCount <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    QueueHandle_t xHandle<span class="token punctuation">;</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxMaxCount <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> uxInitialCount <span class="token operator">&lt;=</span> uxMaxCount <span class="token punctuation">)</span><span class="token punctuation">;</span>

    xHandle <span class="token operator">=</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> uxMaxCount<span class="token punctuation">,</span> queueSEMAPHORE_QUEUE_ITEM_LENGTH<span class="token punctuation">,</span> queueQUEUE_TYPE_COUNTING_SEMAPHORE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//queueSEMAPHORE_QUEUE_ITEM_LENGTH=0</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> xHandle <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">(</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> xHandle <span class="token punctuation">)</span><span class="token operator">-&gt;</span>uxMessagesWaiting <span class="token operator">=</span> uxInitialCount<span class="token punctuation">;</span><span class="token comment">//ä½¿ç”¨uxMessagesWaitingæ¥è®¡æ•°</span>

        <span class="token function">traceCREATE_COUNTING_SEMAPHORE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">traceCREATE_COUNTING_SEMAPHORE_FAILED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xHandle <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xHandle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="ä¼˜å…ˆçº§ç¿»è½¬"><a href="#ä¼˜å…ˆçº§ç¿»è½¬" class="header-anchor">#</a> ä¼˜å…ˆçº§ç¿»è½¬</h4> <blockquote><p>ä½¿ç”¨äºŒå€¼ä¿¡å·é‡çš„æ—¶å€™ä¼šé‡åˆ°å¸¸è§çš„é—®é¢˜â€”â€”ä¼˜å…ˆçº§ç¿»è½¬ï¼Œä¼˜å…ˆçº§ç¿»è½¬åœ¨å¯å‰¥å¤ºå†…æ ¸ä¸­æ˜¯éå¸¸å¸¸è§çš„ï¼Œåœ¨å®æ—¶ç³»ç»Ÿä¸­ä¸å…è®¸å‡ºç°è¿™ç§ç°åœºï¼Œè¿™æ ·ä¼šç ´åä»»åŠ¡çš„é¢„æœŸé¡ºåºã€‚</p> <p>å¸¸è§åœºåˆæè¿°å¦‚ä¸‹ï¼š</p> <p>å½“ä¸€ä¸ªä½ä¼˜å…ˆçº§å’Œä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªä¿¡å·é‡ï¼Œè€Œç³»ç»Ÿä¸­è¿˜æœ‰å…¶ä»–ä¸­ç­‰ä¼˜å…ˆçº§ä»»åŠ¡æ—¶ï¼Œå¦‚æœä½ ä¼˜å…ˆçº§ä»»åŠ¡è·å¾—äº†ä¿¡å·é‡ï¼Œé‚£ä¹ˆé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å°±ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼›ä½†æ˜¯ï¼Œä¸­ç­‰ä¼˜å…ˆçº§çš„ä»»åŠ¡å¯ä»¥æ‰“æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡è€Œå…ˆäºé«˜ä¼˜å…ˆçº§ä»»åŠ¡è¿è¡Œï¼ˆæ­¤æ—¶é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åœ¨ç­‰å¾…ä¿¡å·é‡ï¼Œæ‰€ä»¥ä¸èƒ½è¿è¡Œï¼‰ï¼Œè¿™å°±å‡ºç°äº†ä¼˜å…ˆçº§ç¿»è½¬çš„ç°è±¡ã€‚</p></blockquote> <h4 id="äº’æ–¥ä¿¡å·é‡"><a href="#äº’æ–¥ä¿¡å·é‡" class="header-anchor">#</a> äº’æ–¥ä¿¡å·é‡</h4> <blockquote><p>äº’æ–¥ä¿¡å·é‡å…¶å®å°±æ˜¯ä¸€ä¸ªæ‹¥æœ‰ä¼˜å…ˆçº§ç»§æ‰¿çš„äºŒå€¼ä¿¡å·é‡ï¼Œåœ¨åŒæ­¥çš„åº”ç”¨ä¸­ï¼ŒäºŒå€¼ä¿¡å·é‡æœ€é€‚åˆã€‚äº’æ–¥ä¿¡å·é‡é€‚åˆç”¨äºé‚£äº›éœ€è¦äº’æ–¥è®¿é—®çš„åº”ç”¨ä¸­ã€‚å½“ä¸€ä¸ªäº’æ–¥ä¿¡å·é‡æ­£åœ¨è¢«ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ä½¿ç”¨ï¼Œè€Œæ­¤æ—¶æœ‰ä¸ªé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¹Ÿå°è¯•è·å–è¿™ä¸ªäº’æ–¥ä¿¡å·é‡çš„è¯å°±ä¼šè¢«é˜»å¡ã€‚ä¸è¿‡è¿™ä¸ªé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šå°†ä½ä¼˜å…ˆçº§ä»»åŠ¡çš„ä¼˜å…ˆçº§æå‡åˆ°ä¸è‡ªå·±ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¼˜å…ˆçº§ç»§æ‰¿ã€‚ä¼˜å…ˆçº§ç»§æ‰¿å°½å¯èƒ½åœ°é™ä½äº†é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¤„äºé˜»å¡æ€çš„æ—¶é—´ï¼Œå¹¶ä¸”å°†å·²ç»å‡ºç°çš„â€œä¼˜å…ˆçº§ç¿»è½¬â€œçš„å½±å“é™åˆ°æœ€ä½ã€‚</p></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xSemaphoreCreateMutex</td> <td>ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºäº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreCreateMutexStatic</td> <td>ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºäº’æ–¥ä¿¡å·é‡</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">xSemaphoreCreateMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">xQueueCreateMutex</span><span class="token punctuation">(</span> queueQUEUE_TYPE_MUTEX <span class="token punctuation">)</span></span></span>
QueueHandle_t <span class="token function">xQueueCreateMutex</span><span class="token punctuation">(</span> <span class="token keyword">const</span> uint8_t ucQueueType <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Queue_t <span class="token operator">*</span>pxNewQueue<span class="token punctuation">;</span>
    <span class="token keyword">const</span> UBaseType_t uxMutexLength <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">,</span> uxMutexSize <span class="token operator">=</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span>

    pxNewQueue <span class="token operator">=</span> <span class="token punctuation">(</span> Queue_t <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericCreate</span><span class="token punctuation">(</span> uxMutexLength<span class="token punctuation">,</span> uxMutexSize<span class="token punctuation">,</span> ucQueueType <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prvInitialiseMutex</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pxNewQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInitialiseMutex</span><span class="token punctuation">(</span> Queue_t <span class="token operator">*</span>pxNewQueue <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> pxNewQueue <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pxNewQueue<span class="token operator">-&gt;</span>pxMutexHolder <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        pxNewQueue<span class="token operator">-&gt;</span>uxQueueType <span class="token operator">=</span> queueQUEUE_IS_MUTEX<span class="token punctuation">;</span>
        pxNewQueue<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>uxRecursiveCallCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//é’ˆå¯¹é€’å½’äº’æ–¥ä¿¡å·é‡çš„è®¡æ•°å™¨</span>
        <span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pxNewQueue<span class="token operator">-&gt;</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–CPUå†…æ ¸çš„è‡ªæ—‹é”</span>
        <span class="token function">traceCREATE_MUTEX</span><span class="token punctuation">(</span> pxNewQueue <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xQueueGenericSend</span><span class="token punctuation">(</span> pxNewQueue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0U</span><span class="token punctuation">,</span> queueSEND_TO_BACK <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//äº’æ–¥ä¿¡å·é‡é»˜è®¤åˆ›å»ºåå°±æ˜¯æœ‰æ•ˆçš„</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">traceCREATE_MUTEX_FAILED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">vPortCPUInitializeMutex</span><span class="token punctuation">(</span>portMUX_TYPE <span class="token operator">*</span>mux<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	mux<span class="token operator">-&gt;</span>owner<span class="token operator">=</span>portMUX_FREE_VAL<span class="token punctuation">;</span>
	mux<span class="token operator">-&gt;</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* ä¸ºäº†å¤„ç†å¤šæ ¸CPUå¸¦æ¥çš„ç«æ€ï¼Œä½¿ç”¨è¯¥ç»“æ„ä½“å®ç°çš„â€œè‡ªæ—‹é”â€ */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* owner field values:
	 * 0                - Uninitialized (invalid)
	 * portMUX_FREE_VAL - Mux is free, can be locked by either CPU
	 * CORE_ID_PRO / CORE_ID_APP - Mux is locked to the particular core
	 *
	 * Any value other than portMUX_FREE_VAL, CORE_ID_PRO, CORE_ID_APP indicates corruption
	 */</span>
	uint32_t owner<span class="token punctuation">;</span>
	<span class="token comment">/* count field:
	 * If mux is unlocked, count should be zero.
	 * If mux is locked, count is non-zero &amp; represents the number of recursive locks on the mux.
	 */</span>
	uint32_t count<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FREERTOS_PORTMUX_DEBUG</span></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>lastLockedFn<span class="token punctuation">;</span>
	<span class="token keyword">int</span> lastLockedLine<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span> portMUX_TYPE<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="é€’å½’äº’æ–¥ä¿¡å·é‡"><a href="#é€’å½’äº’æ–¥ä¿¡å·é‡" class="header-anchor">#</a> é€’å½’äº’æ–¥ä¿¡å·é‡</h4> <blockquote><p>å·²ç»è·å–äº†äº’æ–¥ä¿¡å·é‡çš„ä»»åŠ¡å°±ä¸èƒ½å†æ¬¡è·å–è¿™ä¸ªäº’æ–¥ä¿¡å·é‡ï¼Œä½†æ˜¯é€’å½’äº’æ–¥ä¿¡å·é‡ä¸åŒï¼Œå·²ç»è·å–äº†é€’å½’äº’æ–¥ä¿¡å·é‡çš„ä»»åŠ¡å¯ä»¥å†æ¬¡è·å–è¿™ä¸ªé€’å½’äº’æ–¥ä¿¡å·é‡ï¼Œè€Œä¸”æ¬¡æ•°ä¸é™ã€‚é€’å½’äº’æ–¥ä¿¡å·é‡ä¹Ÿæœ‰ä¼˜å…ˆçº§ç»§æ‰¿çš„æœºåˆ¶ï¼Œæ‰€ä»¥ä»»åŠ¡ä½¿ç”¨å®Œé€’å½’äº’æ–¥ä¿¡å·é‡ä»¥åä¸€å®šè¦è®°å¾—é‡Šæ”¾ã€‚</p></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xSemaphoreCreateRecursiveMutex</td> <td>ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºé€’å½’äº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreCreateRecursiveMutexStatic</td> <td>ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºé€’å½’äº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreGiveRecursive</td> <td>é‡Šæ”¾é€’å½’äº’æ–¥ä¿¡å·é‡</td></tr> <tr><td>xSemaphoreTakeRecursive</td> <td>è·å–é€’å½’äº’æ–¥ä¿¡å·é‡</td></tr></tbody></table> <h2 id="freertosè½¯ä»¶å®šæ—¶å™¨"><a href="#freertosè½¯ä»¶å®šæ—¶å™¨" class="header-anchor">#</a> FreeRTOSè½¯ä»¶å®šæ—¶å™¨</h2> <blockquote><p>è½¯ä»¶å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°æ˜¯åœ¨å®šæ—¶å™¨æœåŠ¡ä»»åŠ¡ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸€å®šä¸èƒ½åœ¨å›è°ƒå‡½æ•°ä¸­è°ƒç”¨ä»»ä½•ä¼šé˜»å¡ä»»åŠ¡çš„APIå‡½æ•°ï¼Œæ¯”å¦‚å®šæ—¶å™¨å›è°ƒå‡½æ•°ä¸­åƒä¸‡ä¸èƒ½è°ƒç”¨vTaskDelayã€vTaskDelayUntilï¼Œè¿˜æœ‰ä¸€äº›è®¿é—®é˜Ÿåˆ—æˆ–è€…ä¿¡å·é‡çš„éé›¶é˜»å¡æ—¶é—´çš„APIå‡½æ•°ä¹Ÿä¸èƒ½è°ƒç”¨ã€‚FreeRTOSæä¾›äº†å¾ˆå¤šå®šæ—¶å™¨ç›¸å…³çš„APIå‡½æ•°ï¼Œè¿™äº›APIå‡½æ•°å¤§å¤šä½¿ç”¨FreeRTOSçš„é˜Ÿåˆ—å‘é€å‘½ä»¤ç»™å®šæ—¶å™¨æœåŠ¡ä»»åŠ¡ï¼Œè¿™ä¸ªé˜Ÿåˆ—å«å®šæ—¶å™¨å‘½ä»¤é˜Ÿåˆ—ï¼Œæ˜¯ä¾›ç»™FreeRTOSçš„è½¯ä»¶å®šæ—¶å™¨ä½¿ç”¨çš„ï¼Œç”¨æˆ·ä¸èƒ½ç›´æ¥è®¿é—®ã€‚</p></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xTimerReset()</td> <td>å¤ä½è½¯ä»¶å®šæ—¶å™¨</td></tr> <tr><td>xTimerResetFromISR()</td> <td>å¤ä½è½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>xTimerCreate()</td> <td>ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºè½¯ä»¶å®šæ—¶å™¨</td></tr> <tr><td>xTimerCreateStatic()</td> <td>ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºè½¯ä»¶å®šæ—¶å™¨</td></tr> <tr><td>xTimerStart()</td> <td>å¼€å¯è½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨äºä»»åŠ¡ä¸­</td></tr> <tr><td>xTimerStartFromISR()</td> <td>å¼€å¯è½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨äºä¸­æ–­ä¸­</td></tr> <tr><td>xTimerStop()</td> <td>åœæ­¢è½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨äºä»»åŠ¡ä¸­</td></tr> <tr><td>xTimerStopFromISR()</td> <td>åœæ­¢è½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨äºä¸­æ–­ä¸­</td></tr></tbody></table> <h2 id="freertosäº‹ä»¶æ ‡å¿—ç»„"><a href="#freertosäº‹ä»¶æ ‡å¿—ç»„" class="header-anchor">#</a> FreeRTOSäº‹ä»¶æ ‡å¿—ç»„</h2> <blockquote><p>ä½¿ç”¨ä¿¡å·é‡åŒæ­¥æ—¶ä»»åŠ¡åªèƒ½ä¸å•ä¸ªçš„äº‹ä»¶æˆ–ä»»åŠ¡è¿›è¡ŒåŒæ­¥ï¼Œæœ‰æ—¶å€™æŸä¸ªä»»åŠ¡å¯èƒ½éœ€è¦ä¸å¤šä¸ªäº‹ä»¶æˆ–ä»»åŠ¡è¿›è¡ŒåŒæ­¥ï¼Œæ­¤æ—¶ä¿¡å·é‡å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚FreeRTOSä¸ºæ­¤æä¾›äº†ä¸€ä¸ªå¯é€‰çš„è§£å†³åŠæ³•â€”â€”äº‹ä»¶æ ‡å¿—ç»„ã€‚äº‹ä»¶æ ‡å¿—ç»„çš„æ•°æ®ç±»å‹ä¸ºEventGroupHandle_tï¼Œå½“configUSE_16_BIT_TICKSä¸º1çš„æ—¶å€™ï¼Œåˆ™äº‹ä»¶æ ‡å¿—ç»„å¯ä»¥å­˜å‚¨8ä¸ªäº‹ä»¶ä½ï¼›å½“configUSE_16_BIT_TICKSä¸º0çš„æ—¶å€™ï¼Œåˆ™äº‹ä»¶æ ‡å¿—ç»„å­˜å‚¨24ä¸ªäº‹ä»¶ä½ã€‚äº‹ä»¶æ ‡å¿—ç»„ä¸­çš„æ‰€æœ‰äº‹ä»¶ä½éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ— ç¬¦å·çš„EventBits_tç±»å‹çš„å˜é‡ä¸­</p></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xEventGroupCreate()</td> <td>ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºäº‹ä»¶æ ‡å¿—ç»„</td></tr> <tr><td>xEventGroupCreateStatic()</td> <td>ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºäº‹ä»¶æ ‡å¿—ç»„</td></tr> <tr><td>xEventGroupClearBits()</td> <td>å°†æŒ‡å®šçš„äº‹ä»¶ä½æ¸…é›¶ï¼Œç”¨åœ¨ä»»åŠ¡ä¸­</td></tr> <tr><td>xEventGroupClearBitsFromISR()</td> <td>å°†æŒ‡å®šçš„äº‹ä»¶ä½æ¸…é›¶ï¼Œç”¨åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>xEventGroupSetBits()</td> <td>å°†æŒ‡å®šçš„äº‹ä»¶ä½ç½®1ï¼Œç”¨åœ¨ä»»åŠ¡ä¸­</td></tr> <tr><td>xEventGroupSetBitsFromISR()</td> <td>å°†æŒ‡å®šçš„äº‹ä»¶ä½ç½®1ï¼Œç”¨åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>xEventGroupGetBits()</td> <td>è·å–å½“å‰äº‹ä»¶æ ‡å¿—ç»„çš„å€¼ï¼ˆå„ä¸ªäº‹ä»¶çš„å€¼ï¼‰ï¼Œç”¨åœ¨ä»»åŠ¡ä¸­</td></tr> <tr><td>xEventGroupGetBitsFromISR()</td> <td>è·å–å½“å‰äº‹ä»¶æ ‡å¿—ç»„çš„å€¼ï¼Œç”¨åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>xEventGroupWaitBits()</td> <td>ç­‰å¾…æŒ‡å®šçš„äº‹ä»¶ä½</td></tr></tbody></table> <h2 id="freertosä»»åŠ¡é€šçŸ¥"><a href="#freertosä»»åŠ¡é€šçŸ¥" class="header-anchor">#</a> FreeRTOSä»»åŠ¡é€šçŸ¥</h2> <blockquote><p>FreeRTOSçš„æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª32ä½çš„é€šçŸ¥å€¼ï¼Œä»»åŠ¡æ§åˆ¶å—ä¸­çš„æˆå‘˜å˜é‡ulNotifiedValueå°±æ˜¯è¿™ä¸ªé€šçŸ¥å€¼ã€‚ä»»åŠ¡é€šçŸ¥æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼Œå‡å¦‚æŸä¸ªä»»åŠ¡é€šçŸ¥çš„æ¥æ”¶ä»»åŠ¡å› ä¸ºç­‰å¾…ä»»åŠ¡é€šçŸ¥è€Œé˜»å¡ï¼Œåˆ™å‘è¿™ä¸ªæ¥æ”¶ä»»åŠ¡å‘é€ä»»åŠ¡é€šçŸ¥ä»¥åå°±ä¼šè§£é™¤è¿™ä¸ªä»»åŠ¡çš„é˜»å¡çŠ¶æ€ã€‚ä¹Ÿå¯ä»¥æ›´æ–°æ¥æ”¶ä»»åŠ¡çš„ä»»åŠ¡é€šçŸ¥å€¼ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ›´æ–°æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼ï¼š</p> <ol><li>ä¸è¦†ç›–æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼ï¼ˆå¦‚æœä¸Šæ¬¡å‘é€ç»™æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥è¿˜æ²¡è¢«å¤„ç†ï¼‰</li> <li>è¦†ç›–æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼</li> <li>æ›´æ–°æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼çš„ä¸€ä¸ªæˆ–å¤šä¸ªbit</li> <li>å¢åŠ æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼</li></ol> <p>åˆç†ä½¿ç”¨ä¸Šé¢è¿™äº›æ›´æ”¹ä»»åŠ¡é€šçŸ¥å€¼çš„æ–¹æ³•å¯ä»¥åœ¨ä¸€äº›åœºåˆä¸­æ›¿ä»£é˜Ÿåˆ—ã€äºŒå€¼ä¿¡å·é‡ã€è®¡æ•°å‹ä¿¡å·é‡å’Œäº‹ä»¶æ ‡å¿—ç»„ï¼Œå¹¶ä¸”å¯ä»¥æé«˜é€Ÿåº¦ï¼Œå‡å°‘RAMçš„ä½¿ç”¨é‡ã€‚</p> <p>ä»»åŠ¡é€šçŸ¥çš„å±€é™ï¼š</p> <ul><li>FreeRTOSçš„ä»»åŠ¡é€šçŸ¥åªèƒ½æœ‰ä¸€ä¸ªæ¥æ”¶ä»»åŠ¡ï¼Œå…¶å®å¤§å¤šæ•°çš„åº”ç”¨éƒ½æ˜¯è¿™ç§æƒ…å†µ</li> <li>æ¥æ”¶ä»»åŠ¡å¯ä»¥å› ä¸ºæ¥æ”¶ä»»åŠ¡é€šçŸ¥è€Œè¿›å…¥é˜»å¡æ€ï¼Œä½†æ˜¯å‘é€ä»»åŠ¡ä¸ä¼šå› ä¸ºä»»åŠ¡é€šçŸ¥å‘é€å¤±è´¥è€Œé˜»å¡</li></ul></blockquote> <table><thead><tr><th>å‡½æ•°</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>xTaskNotify</td> <td>å‘é€é€šçŸ¥ï¼Œå¸¦æœ‰é€šçŸ¥å€¼å¹¶ä¸”ä¸ä¿ç•™æ¥æ”¶ä»»åŠ¡åŸé€šçŸ¥å€¼ï¼Œç”¨åœ¨ä»»åŠ¡ä¸­</td></tr> <tr><td>xTaskNotifyFromISR</td> <td>å‘é€é€šçŸ¥ï¼Œå‡½æ•°xTaskNotifyçš„ä¸­æ–­ç‰ˆæœ¬</td></tr> <tr><td>xTaskNotifyGive</td> <td>å‘é€é€šçŸ¥ï¼Œä¸å¸¦é€šçŸ¥å€¼å¹¶ä¸”ä¸ä¿ç•™æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼ï¼Œæ­¤å‡½æ•°ä¼šå°†æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼åŠ 1ï¼Œç”¨äºä»»åŠ¡ä¸­</td></tr> <tr><td>vTaskNotifyGiveFromISR</td> <td>å‘é€é€šçŸ¥ï¼Œå‡½æ•°xTaskNotifyGiveçš„ä¸­æ–­ç‰ˆæœ¬</td></tr> <tr><td>xTaskNotifyAndQuery</td> <td>å‘é€é€šçŸ¥ï¼Œå¸¦æœ‰é€šçŸ¥å€¼å¹¶ä¸”ä¿ç•™æ¥æ”¶ä»»åŠ¡çš„åŸé€šçŸ¥å€¼ï¼Œç”¨åœ¨ä»»åŠ¡ä¸­</td></tr> <tr><td>xTaskNotifyAndQueryFromISR</td> <td>å‘é€é€šçŸ¥ï¼Œå‡½æ•°xTaskNotifyAndQueryçš„ä¸­æ–­ç‰ˆæœ¬ï¼Œç”¨åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­</td></tr> <tr><td>ulTaskNotifyTake</td> <td>è·å–ä»»åŠ¡é€šçŸ¥ï¼Œå¯ä»¥è®¾ç½®åœ¨é€€å‡ºæ­¤å‡½æ•°çš„æ—¶å€™å°†ä»»åŠ¡é€šçŸ¥å€¼æ¸…é›¶æˆ–è€…å‡ä¸€ã€‚å½“ä»»åŠ¡é€šçŸ¥ç”¨ä½œäºŒå€¼ä¿¡å·é‡æˆ–è€…è®¡æ•°ä¿¡å·é‡çš„æ—¶å€™ï¼Œä½¿ç”¨æ­¤å‡½æ•°æ¥è·å–ä¿¡å·é‡</td></tr> <tr><td>xTaskNotifyWait</td> <td>ç­‰å¾…ä»»åŠ¡é€šçŸ¥ï¼Œæ¯”ulTaskNotifyTaskæ›´ä¸ºå¼ºå¤§ï¼Œå…¨åŠŸèƒ½ç‰ˆä»»åŠ¡é€šçŸ¥è·å–å‡½æ•°</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code>BaseType_t <span class="token function">xTaskNotify</span><span class="token punctuation">(</span> TaskHandle_t xTaskToNotify<span class="token punctuation">,</span> uint32_t ulValue<span class="token punctuation">,</span> eNotifyAction eAction <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TCB_t <span class="token operator">*</span> pxTCB<span class="token punctuation">;</span>
    eNotifyValue eOriginalNotifyState<span class="token punctuation">;</span>
    BaseType_t xReturn <span class="token operator">=</span> pdPASS<span class="token punctuation">;</span>
    <span class="token function">configASSERT</span><span class="token punctuation">(</span> xTaskToNotify <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pxTCB <span class="token operator">=</span> <span class="token punctuation">(</span> TCB_t <span class="token operator">*</span> <span class="token punctuation">)</span> xTaskToNotify<span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        eOriginalNotifyState <span class="token operator">=</span> pxTCB<span class="token operator">-&gt;</span>eNotifyState<span class="token punctuation">;</span><span class="token comment">//ä¿å­˜å½“å‰ä»»åŠ¡é€šçŸ¥çŠ¶æ€</span>
        pxTCB<span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotified<span class="token punctuation">;</span><span class="token comment">//æ›´æ–°ä»»åŠ¡é€šçŸ¥çŠ¶æ€ä¸ºeNotified</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span> eAction <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">case</span> eSetBits<span class="token operator">:</span>
                pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">|=</span> ulValue<span class="token punctuation">;</span><span class="token comment">//æ›´æ–°æ¥æ”¶ä»»åŠ¡é€šçŸ¥å€¼çš„ä¸€ä¸ªæˆ–å¤šä¸ªbit</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eIncrement<span class="token operator">:</span>
                <span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//å°†ä»»åŠ¡é€šçŸ¥å€¼åŠ 1</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eSetValueWithOverwrite<span class="token operator">:</span>
                pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> ulValue<span class="token punctuation">;</span><span class="token comment">//ç›´æ¥è¦†å†™åŸæ¥çš„ä»»åŠ¡é€šçŸ¥å€¼</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eSetValueWithoutOverwrite<span class="token operator">:</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> eOriginalNotifyState <span class="token operator">!=</span> eNotified <span class="token punctuation">)</span><span class="token comment">//åŸæ¥çš„ä»»åŠ¡é€šçŸ¥å·²ç»è¢«å¤„ç†</span>
                <span class="token punctuation">{</span>
                    pxTCB<span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> ulValue<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span><span class="token comment">//åŸæ¥çš„ä»»åŠ¡é€šçŸ¥æ²¡æœ‰è¢«å¤„ç†</span>
                <span class="token punctuation">{</span>
                    xReturn <span class="token operator">=</span> pdFAIL<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> eNoAction<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å› ä¸ºç­‰å¾…ä»»åŠ¡é€šçŸ¥å€¼è€Œè¿›å…¥äº†é˜»å¡æ€</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> eOriginalNotifyState <span class="token operator">==</span> eWaitingNotification <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†ä»»åŠ¡ä»çŠ¶æ€åˆ—è¡¨ä¸­ç§»é™¤</span>
            <span class="token function">prvAddTaskToReadyList</span><span class="token punctuation">(</span> pxTCB <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†ä»»åŠ¡é‡æ–°æ·»åŠ åˆ°å°±ç»ªåˆ—è¡¨</span>
            <span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token function">listLIST_ITEM_CONTAINER</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xEventListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">tskCAN_RUN_HERE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pxTCB<span class="token operator">-&gt;</span>uxPriority <span class="token operator">&gt;</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority <span class="token punctuation">)</span><span class="token comment">//åˆ¤æ–­åˆšåˆšè§£é™¤é˜»å¡çš„ä»»åŠ¡ä¼˜å…ˆçº§æ˜¯å¦æ¯”å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§é«˜</span>
            <span class="token punctuation">{</span>
                <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> pxTCB<span class="token operator">-&gt;</span>xCoreID <span class="token operator">!=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">taskYIELD_OTHER_CORE</span><span class="token punctuation">(</span>pxTCB<span class="token operator">-&gt;</span>xCoreID<span class="token punctuation">,</span> pxTCB<span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> xReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
uint32_t <span class="token function">ulTaskNotifyTake</span><span class="token punctuation">(</span> BaseType_t xClearCountOnExit<span class="token punctuation">,</span> TickType_t xTicksToWait <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TickType_t xTimeToWake<span class="token punctuation">;</span>
    uint32_t ulReturn<span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">==</span> <span class="token number">0UL</span> <span class="token punctuation">)</span><span class="token comment">//è¿˜æ²¡æœ‰æ¥æ”¶åˆ°ä»»åŠ¡é€šçŸ¥</span>
        <span class="token punctuation">{</span>
            pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eWaitingNotification<span class="token punctuation">;</span><span class="token comment">//ä»»åŠ¡é€šçŸ¥çŠ¶æ€æ”¹ä¸ºeWaitingNotification</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">&gt;</span> <span class="token punctuation">(</span> TickType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°å»¶æ—¶åˆ—è¡¨ï¼Œå¹¶è¿›è¡Œä»»åŠ¡è°ƒåº¦</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">uxListRemove</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">portRESET_READY_PRIORITY</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>uxPriority<span class="token punctuation">,</span> uxTopReadyPriority <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> INCLUDE_vTaskSuspend <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> xTicksToWait <span class="token operator">==</span> portMAX_DELAY <span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">traceMOVED_TASK_TO_SUSPENDED_LIST</span><span class="token punctuation">(</span>pxCurrentTCB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">vListInsertEnd</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>xSuspendedTaskList<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>xGenericListItem <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToWait<span class="token punctuation">;</span>
                        <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* INCLUDE_vTaskSuspend */</span></span>
                <span class="token punctuation">{</span>
                    xTimeToWake <span class="token operator">=</span> xTickCount <span class="token operator">+</span> xTicksToWait<span class="token punctuation">;</span>
                    <span class="token function">prvAddCurrentTaskToDelayedList</span><span class="token punctuation">(</span> xTimeToWake <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* INCLUDE_vTaskSuspend */</span></span>
                <span class="token function">portYIELD_WITHIN_API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        ulReturn <span class="token operator">=</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue<span class="token punctuation">;</span><span class="token comment">//ä»»åŠ¡é€šçŸ¥å€¼ä¸ä¸º0ï¼Œåˆ™å…ˆè·å–ä»»åŠ¡é€šçŸ¥å€¼</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> ulReturn <span class="token operator">!=</span> <span class="token number">0UL</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> xClearCountOnExit <span class="token operator">!=</span> pdFALSE <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">(</span> pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>ulNotifiedValue <span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pxCurrentTCB<span class="token punctuation">[</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token operator">-&gt;</span>eNotifyState <span class="token operator">=</span> eNotWaitingNotification<span class="token punctuation">;</span><span class="token comment">//æ›´æ–°ä»»åŠ¡é€šçŸ¥çŠ¶æ€ä¸ºeNotWaitingNotification</span>
    <span class="token punctuation">}</span>
    <span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ulReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br></div></div><h2 id="freertosä¸­çš„ç©ºé—²ä»»åŠ¡"><a href="#freertosä¸­çš„ç©ºé—²ä»»åŠ¡" class="header-anchor">#</a> FreeRTOSä¸­çš„ç©ºé—²ä»»åŠ¡</h2> <blockquote><p>ç©ºé—²ä»»åŠ¡ä¸ä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³ä»»åŠ¡è°ƒåº¦å™¨å¯åŠ¨ä»¥åè‡³å°‘æœ‰ä¸€ä¸ªä»»åŠ¡è¿è¡Œè€Œåˆ›å»ºçš„ï¼Œç©ºé—²ä»»åŠ¡ä¸­è¿˜ä¼šå»åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼Œå¦‚ä¸‹ï¼š</p> <ol><li>åˆ¤æ–­ç³»ç»Ÿä¸­æ˜¯å¦æœ‰ä»»åŠ¡åˆ é™¤è‡ªå·±ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åœ¨ç©ºé—²ä»»åŠ¡ä¸­é‡Šæ”¾è¢«åˆ é™¤ä»»åŠ¡çš„ä»»åŠ¡å †æ ˆå’Œä»»åŠ¡æ§åˆ¶å—çš„å†…å­˜</li> <li>è¿è¡Œç”¨æˆ·è®¾ç½®çš„ç©ºé—²ä»»åŠ¡é’©å­å‡½æ•°</li> <li>åˆ¤æ–­æ˜¯å¦å¼€å¯ä½åŠŸè€—ticklessæ¨¡å¼ï¼Œå¦‚æœå¼€å¯ï¼Œåˆ™è¿˜éœ€è¦åšç›¸åº”çš„å¤„ç†</li></ol> <p>ç”¨æˆ·å¯ä»¥åˆ›å»ºä¸ç©ºé—²ä»»åŠ¡ä¼˜å…ˆçº§ç›¸åŒçš„åº”ç”¨ä»»åŠ¡ï¼Œå½“å®configIDLE_SHOULD_YIELDä¸º1æ—¶ï¼Œç©ºé—²ä»»åŠ¡ä¼šè®©å‡ºæ—¶é—´ç‰‡ç»™ç›¸åŒä¼˜å…ˆçº§çš„åº”ç”¨ä»»åŠ¡ã€‚</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token function">portTASK_FUNCTION</span><span class="token punctuation">(</span> prvIdleTask<span class="token punctuation">,</span> pvParameters <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> pvParameters<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡è¦åˆ é™¤è‡ªå·±ï¼Œå¦‚æœæœ‰ï¼Œåˆ™é‡Šæ”¾è¿™äº›ä»»åŠ¡çš„ä»»åŠ¡æ§åˆ¶å—TCPå’Œä»»åŠ¡å †æ ˆçš„å†…å­˜</span>
		<span class="token function">prvCheckTasksWaitingTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_PREEMPTION <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			<span class="token comment">//å¦‚æœæ²¡æœ‰ä½¿ç”¨æŠ¢å å¼å†…æ ¸ï¼Œåˆ™å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡åˆ‡æ¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–ä»»åŠ¡æœ‰æ•ˆï¼›å¦‚æœæœ‰ä½¿ç”¨æŠ¢å å¼å†…æ ¸ï¼Œåˆ™ä¸éœ€è¦è¿™ä¸€æ­¥ï¼Œå› ä¸ºåªè¦æœ‰ä»»ä½•ä»»åŠ¡å°±ç»ªï¼Œä¹‹åéƒ½ä¼šè‡ªåŠ¨æŠ¢å¤ºCPUä½¿ç”¨æƒ</span>
			<span class="token function">taskYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_PREEMPTION */</span></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span> configUSE_PREEMPTION <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> configIDLE_SHOULD_YIELD <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			<span class="token comment">//å¦‚æœä½¿ç”¨æŠ¢å å¼å†…æ ¸å¹¶ä¸”ä½¿èƒ½æ—¶é—´ç‰‡è°ƒåº¦ï¼Œåˆ™å½“æœ‰ä»»åŠ¡å’Œç©ºé—²ä»»åŠ¡å…±äº«ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œå¹¶ä¸”æ­¤ä»»åŠ¡å¤„äºå°±ç»ªæ€æ—¶ï¼Œç©ºé—²ä»»åŠ¡å°±åº”è¯¥æ”¾å¼ƒæœ¬æ—¶é—´ç‰‡ï¼Œå°†æœ¬æ—¶é—´ç‰‡å‰©ä½™çš„æ—¶é—´è®©ç»™è¿™ä¸ªå°±ç»ªä»»åŠ¡ã€‚</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">listCURRENT_LIST_LENGTH</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span> pxReadyTasksLists<span class="token punctuation">[</span> tskIDLE_PRIORITY <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span> UBaseType_t <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskYIELD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ( ( configUSE_PREEMPTION == 1 ) &amp;&amp; ( configIDLE_SHOULD_YIELD == 1 ) ) */</span></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_IDLE_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationIdleHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//æ‰§è¡Œç”¨æˆ·å®šä¹‰çš„ç©ºé—²ä»»åŠ¡é’©å­å‡½æ•°ï¼Œæ³¨æ„é’©å­å‡½æ•°é‡Œé¢ä¸èƒ½ä½¿ç”¨ä»»ä½•å¯ä»¥å¼•èµ·é˜»å¡ç©ºé—²ä»»åŠ¡çš„APIå‡½æ•°</span>
			<span class="token function">vApplicationIdleHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_IDLE_HOOK */</span></span>
		<span class="token punctuation">{</span>
			<span class="token comment">/* Call the esp-idf hook system */</span>
			<span class="token function">esp_vApplicationIdleHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//å¦‚æœä½¿èƒ½äº†Ticklessæ¨¡å¼ï¼Œåˆ™æ‰§è¡Œç›¸å…³çš„å¤„ç†ä»£ç </span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span> configUSE_TICKLESS_IDLE <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></span></span>
		<span class="token punctuation">{</span>
			TickType_t xExpectedIdleTime<span class="token punctuation">;</span>
			BaseType_t xEnteredSleep <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>
			<span class="token comment">//è·å–å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—æ¨¡å¼çš„æ—¶é•¿</span>
			xExpectedIdleTime <span class="token operator">=</span> <span class="token function">prvGetExpectedIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">{</span>
					<span class="token comment">//é‡æ–°é‡‡é›†ä¸€æ¬¡æ—¶é—´å€¼</span>
					<span class="token function">configASSERT</span><span class="token punctuation">(</span> xNextTaskUnblockTime <span class="token operator">&gt;=</span> xTickCount <span class="token punctuation">)</span><span class="token punctuation">;</span>
					xExpectedIdleTime <span class="token operator">=</span> <span class="token function">prvGetExpectedIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token function">traceLOW_POWER_IDLE_BEGIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						xEnteredSleep <span class="token operator">=</span> <span class="token function">portSUPPRESS_TICKS_AND_SLEEP</span><span class="token punctuation">(</span> xExpectedIdleTime <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//FreeRTOSè¿›å…¥ä½åŠŸè€—Ticklessæ¨¡å¼</span>
						<span class="token function">traceLOW_POWER_IDLE_END</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{</span>
						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>xTaskQueueMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>xEnteredSleep <span class="token punctuation">)</span><span class="token comment">//FreeRTOSæ²¡æœ‰çœŸçš„è¿›å…¥Ticklessæ¨¡å¼</span>
			<span class="token punctuation">{</span>
				<span class="token function">esp_vApplicationWaitiHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CPUè¿›å…¥ä½åŠŸè€—æ¨¡å¼</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
		<span class="token function">esp_vApplicationWaitiHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* configUSE_TICKLESS_IDLE */</span></span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h2 id="freertosä½åŠŸè€—ticklessæ¨¡å¼"><a href="#freertosä½åŠŸè€—ticklessæ¨¡å¼" class="header-anchor">#</a> FreeRTOSä½åŠŸè€—Ticklessæ¨¡å¼</h2> <blockquote><p>å½“å¤„ç†å™¨è¿›å…¥ç©ºé—²ä»»åŠ¡å‘¨æœŸä»¥åå°±ä¼šå…³é—­ç³»ç»ŸèŠ‚æ‹ä¸­æ–­ï¼ˆæ»´ç­”å®šæ—¶å™¨ä¸­æ–­ï¼‰ï¼Œåªæœ‰å…¶ä»–ä¸­æ–­å‘ç”Ÿæˆ–è€…å…¶ä»–ä»»åŠ¡éœ€è¦å¤„ç†çš„æ—¶å€™ï¼Œå¤„ç†å™¨æ‰ä¼šè¢«ä»ä½åŠŸè€—æ¨¡å¼ä¸­å”¤é†’ã€‚ä¸ºæ­¤å°†ä¼šé¢ä¸´ä¸¤å¤§é—®é¢˜ï¼š</p> <ol><li>å…³é—­ç³»ç»ŸèŠ‚æ‹ä¸­æ–­ä¼šå¯¼è‡´ç³»ç»ŸèŠ‚æ‹è®¡æ•°å™¨åœæ­¢ï¼Œç³»ç»Ÿæ—¶é’Ÿå°±ä¼šåœæ­¢ã€‚
<ul><li>æˆ‘ä»¬éœ€è¦è®°å½•ä¸‹ç³»ç»ŸèŠ‚æ‹ä¸­æ–­çš„å…³é—­æ—¶é—´ï¼Œå½“ç³»ç»ŸèŠ‚æ‹ä¸­æ–­å†æ¬¡å¼€å¯è¿è¡Œçš„æ—¶å€™è¡¥ä¸Šè¿™æ®µæ—¶é—´å³å¯ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨å®šæ—¶å™¨æ¥è®°å½•è¿™æ®µè¯¥è¡¥ä¸Šçš„æ—¶é—´</li></ul></li> <li>å¦‚ä½•ä¿è¯ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡èƒ½è¢«å‡†ç¡®åœ°å”¤é†’ï¼Ÿ
<ul><li>å¤„ç†å™¨åœ¨è¿›å…¥ä½åŠŸè€—æ¨¡å¼ä¹‹å‰è·å–è¿˜æœ‰å¤šé•¿æ—¶é—´è¿è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å¯å®šæ—¶å™¨ï¼Œå®šæ—¶å‘¨æœŸè®¾ç½®ä¸ºè¿™ä¸ªæ—¶é—´ï¼Œå®šæ—¶æ—¶é—´åˆ°äº†åˆ™äº§ç”Ÿå®šæ—¶ä¸­æ–­ï¼Œå¤„ç†å™¨å°±ä»ä½åŠŸè€—æ¨¡å¼å”¤é†’äº†</li></ul></li></ol></blockquote> <h4 id="ticklessçš„å…·ä½“å®ç°"><a href="#ticklessçš„å…·ä½“å®ç°" class="header-anchor">#</a> Ticklessçš„å…·ä½“å®ç°</h4> <ol><li>è¦æƒ³ä½¿ç”¨Ticklessæ¨¡å¼ï¼Œåˆ™å¿…é¡»é¦–å…ˆå°†FreeRTOSConfig.hä¸­çš„å®configUSE_TICKLESS_IDLEè®¾ç½®ä¸º1</li> <li>ä½¿èƒ½Ticklessæ¨¡å¼ä»¥åï¼Œå½“ä¸‹é¢ä¸¤ç§æƒ…å†µéƒ½å‡ºç°çš„æ—¶å€™ï¼ŒFreeRTOSå†…æ ¸å°±ä¼šè°ƒç”¨å®portSUPPRESS_TICKS_AND_SLEEPæ¥å¤„ç†ä½åŠŸè€—ç›¸å…³çš„å·¥ä½œ:
<ul><li>ç©ºé—²ä»»åŠ¡æ˜¯å½“å‰å”¯ä¸€å¯è¿è¡Œçš„ä»»åŠ¡ï¼Œå› ä¸ºå…¶ä»–æ‰€æœ‰çš„ä»»åŠ¡éƒ½å¤„äºé˜»å¡æˆ–è€…æŒ‚èµ·æ€</li> <li>ç³»ç»Ÿå¤„äºä½åŠŸè€—æ¨¡å¼çš„æ—¶é—´è‡³å°‘å¤§äºconfigEXPECTED_IDLE_TIME_BEFORE_SLEEPä¸ªæ—¶é’ŸèŠ‚æ‹</li></ul></li> <li>å¤„ç†å™¨å·¥ä½œåœ¨ä½åŠŸè€—æ¨¡å¼çš„æ—¶é—´è™½è¯´æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œä¸€ä¸ªæ—¶é’ŸèŠ‚æ‹ä¹Ÿè¡Œã€æ»´ç­”å®šæ—¶å™¨æ‰€èƒ½è®¡æ—¶çš„æœ€å¤§å€¼ä¹Ÿè¡Œï¼Œä½†æ˜¯æ—¶é—´å¤ªçŸ­æ„ä¹‰ä¹Ÿä¸å¤§ï¼Œæ‰€ä»¥å¿…é¡»å¯¹å·¥ä½œåœ¨ä½åŠŸè€—æ¨¡å¼çš„æ—¶é—´åšä¸ªé™åˆ¶ï¼Œä¸èƒ½å¤ªçŸ­äº†ï¼Œå®config EXPECTED_IDLE_TIME_BEFORE_SLEEPå°±æ˜¯ç”¨æ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">portSUPPRESS_TICKS_AND_SLEEP</span><span class="token punctuation">(</span> idleTime <span class="token punctuation">)</span> <span class="token function">vApplicationSleep</span><span class="token punctuation">(</span> idleTime <span class="token punctuation">)</span></span></span>
bool IRAM_ATTR <span class="token function">vApplicationSleep</span><span class="token punctuation">(</span> TickType_t xExpectedIdleTime <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool result <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">portENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_switch_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_mode <span class="token operator">==</span> PM_MODE_LIGHT_SLEEP <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s_is_switching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è®¡ç®—å¯ä»¥ç¡çœ çš„æ—¶é•¿</span>
        int64_t next_esp_timer_alarm <span class="token operator">=</span> <span class="token function">esp_timer_get_next_alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int64_t now <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int64_t time_until_next_alarm <span class="token operator">=</span> next_esp_timer_alarm <span class="token operator">-</span> now<span class="token punctuation">;</span>
        int64_t wakeup_delay_us <span class="token operator">=</span> portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span> <span class="token operator">*</span> xExpectedIdleTime<span class="token punctuation">;</span>
        int64_t sleep_time_us <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>wakeup_delay_us<span class="token punctuation">,</span> time_until_next_alarm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sleep_time_us <span class="token operator">&gt;=</span> configEXPECTED_IDLE_TIME_BEFORE_SLEEP <span class="token operator">*</span> portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">esp_sleep_enable_timer_wakeup</span><span class="token punctuation">(</span>sleep_time_us <span class="token operator">-</span> LIGHT_SLEEP_EARLY_WAKEUP_US<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM_TRACE</span></span>
            <span class="token comment">/* to force tracing GPIOs to keep state */</span>
            <span class="token function">esp_sleep_pd_config</span><span class="token punctuation">(</span>ESP_PD_DOMAIN_RTC_PERIPH<span class="token punctuation">,</span> ESP_PD_OPTION_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token keyword">int</span> core_id <span class="token operator">=</span> <span class="token function">xPortGetCoreID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ESP_PM_TRACE_ENTER</span><span class="token punctuation">(</span>SLEEP<span class="token punctuation">,</span> core_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            int64_t sleep_start <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">esp_light_sleep_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼€å§‹ç¡çœ </span>
            int64_t slept_us <span class="token operator">=</span> <span class="token function">esp_timer_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sleep_start<span class="token punctuation">;</span>
            <span class="token function">ESP_PM_TRACE_EXIT</span><span class="token punctuation">(</span>SLEEP<span class="token punctuation">,</span> core_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            uint32_t slept_ticks <span class="token operator">=</span> slept_us <span class="token operator">/</span> <span class="token punctuation">(</span>portTICK_PERIOD_MS <span class="token operator">*</span> <span class="token number">1000LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slept_ticks <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ ¹æ®å®é™…ä¼‘çœ çš„æ—¶é—´æ¥è°ƒæ•´ç³»ç»Ÿæ»´ç­”è®¡æ•°å™¨çš„å€¼</span>
                <span class="token function">vTaskStepTick</span><span class="token punctuation">(</span>slept_ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//è§¦å‘tickä¸­æ–­</span>
                <span class="token function">XTHAL_SET_CCOUNT</span><span class="token punctuation">(</span><span class="token function">XTHAL_GET_CCOMPARE</span><span class="token punctuation">(</span>XT_TIMER_INDEX<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">XTHAL_GET_INTERRUPT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token function">BIT</span><span class="token punctuation">(</span>XT_TIMER_INTNUM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            result <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">portEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_switch_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/others/freertos.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µé¢</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">10/19/2020, 2:05:21 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.c99cf932.js" defer></script><script src="/blog/assets/js/4.879095c8.js" defer></script><script src="/blog/assets/js/45.ef41e1bf.js" defer></script><script src="/blog/assets/js/9.6d0c3494.js" defer></script>
  </body>
</html>
