<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ğŸğŸ’ suda-morris ä¸ªäººåšå®¢ ğŸ‡</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="Personal Blog">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="about-me.html">å…³äºæˆ‘</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ä½“ç³»ç»“æ„</li><li class="chapter-item expanded "><a href="cs/riscv.html"><strong aria-hidden="true">1.</strong> RISC-V</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ç¼–è¯‘ç³»ç»Ÿ</li><li class="chapter-item expanded "><a href="cs/gcc-toolchains.html"><strong aria-hidden="true">2.</strong> GCC</a></li><li class="chapter-item expanded "><a href="cs/cmake.html"><strong aria-hidden="true">3.</strong> CMake</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æ“ä½œç³»ç»Ÿ</li><li class="chapter-item expanded "><a href="cs/openwrt.html"><strong aria-hidden="true">4.</strong> OpenWRT</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ç¼–ç¨‹è¯­è¨€</li><li class="chapter-item expanded "><a href="cs/rust.html"><strong aria-hidden="true">5.</strong> Rust</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æ§åˆ¶ç³»ç»Ÿ</li><li class="chapter-item expanded "><a href="ee/control-system.html"><strong aria-hidden="true">6.</strong> æ§åˆ¶ç³»ç»ŸåŸºç¡€</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æµ‹è¯•æ¡†æ¶</li><li class="chapter-item expanded "><a href="cs/pytest.html"><strong aria-hidden="true">7.</strong> pytest</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">å¤šåª’ä½“</li><li class="chapter-item expanded "><a href="cs/video-process.html"><strong aria-hidden="true">8.</strong> è§†é¢‘å¤„ç†</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">é€šä¿¡åè®®</li><li class="chapter-item expanded "><a href="ee/usb.html"><strong aria-hidden="true">9.</strong> USB åè®®åŸºç¡€</a></li><li class="chapter-item expanded "><a href="ee/can.html"><strong aria-hidden="true">10.</strong> CAN åè®®åŸºç¡€</a></li><li class="chapter-item expanded "><a href="ee/mipi-dsi.html"><strong aria-hidden="true">11.</strong> MIPI DSI åè®®åŸºç¡€</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ç”µè·¯è®¾è®¡</li><li class="chapter-item expanded "><a href="ee/yosys.html"><strong aria-hidden="true">12.</strong> Yosys</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">å‰ç«¯</li><li class="chapter-item expanded "><a href="cs/tauri.html"><strong aria-hidden="true">13.</strong> Tauri</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ç®¡ç†</li><li class="chapter-item expanded "><a href="cs/git.html"><strong aria-hidden="true">14.</strong> git</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æ¼”ç¤º</li><li class="chapter-item expanded "><a href="ux/slides-tool.html"><strong aria-hidden="true">15.</strong> slides å·¥å…·</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ğŸğŸ’ suda-morris ä¸ªäººåšå®¢ ğŸ‡</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/suda-morris/blog" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <center>
    <h1 id="èŒ…èƒœè£"><a class="header" href="#èŒ…èƒœè£">èŒ…èƒœè£</a></h1>
    <div>
        <span>
            ğŸ“ 18862141982
        </span>
        <span>
            ğŸ“¬ 18862141982@163.com
        </span>
        <span>
            âœ’ï¸ <a href="https://suda-morris.github.io/blog">blog</a>
        </span>
        <span>
            ğŸ“· <a href="https://space.bilibili.com/9635864">vlog</a>
        </span>
    </div>
</center>
<h2 id="-ä¸ªäººä¿¡æ¯"><a class="header" href="#-ä¸ªäººä¿¡æ¯">ğŸ›ˆ ä¸ªäººä¿¡æ¯</a></h2>
<ul>
<li>ç”·ï¼Œ1992 å¹´å‡ºç”Ÿ</li>
<li>æ±‚èŒæ„å‘ï¼šé«˜çº§åµŒå…¥å¼è½¯ä»¶å·¥ç¨‹å¸ˆ</li>
<li>å·¥ä½œç»éªŒï¼š5 å¹´</li>
<li>ç°å±…åœ°ï¼šæ±Ÿè‹çœè‹å·å¸‚å´ä¸­åŒº</li>
</ul>
<h2 id="-æ•™è‚²ç»å†"><a class="header" href="#-æ•™è‚²ç»å†">ğŸ“ï¸ æ•™è‚²ç»å†</a></h2>
<ul>
<li>ç¡•å£«ï¼Œè‹å·å¤§å­¦ï¼Œç”µå­ç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šï¼Œ2015.9~2018.7ï¼ŒGPA(3.9/4.0)</li>
<li>å­¦å£«ï¼Œè‹å·å¤§å­¦ï¼Œç”µå­ä¿¡æ¯å·¥ç¨‹ä¸“ä¸šï¼Œ2011.9~2015.7ï¼ŒGPA(3.8/4.0)</li>
</ul>
<h2 id="-å·¥ä½œç»å†"><a class="header" href="#-å·¥ä½œç»å†">ğŸ’¼ å·¥ä½œç»å†</a></h2>
<ul>
<li>
<p><strong>ä¹é‘«ä¿¡æ¯ç§‘æŠ€ï¼ŒèŠ¯ç‰‡æ”¯æŒéƒ¨é—¨ï¼ŒåµŒå…¥å¼é©±åŠ¨å·¥ç¨‹å¸ˆï¼Œ2018.7 æœˆè‡³ä»Š</strong></p>
<ul>
<li>èŠ¯ç‰‡ bring up</li>
<li>SOC å¤–è®¾é©±åŠ¨æ¡†æ¶</li>
</ul>
</li>
</ul>
<h2 id="-å“è¶Šè´¡çŒ®"><a class="header" href="#-å“è¶Šè´¡çŒ®">ğŸšµ å“è¶Šè´¡çŒ®</a></h2>
<ul>
<li>
<p><strong>è®¾è®¡å®ç°é€šç”¨åºåˆ—æ”¶å‘å™¨é©±åŠ¨æ¡†æ¶</strong></p>
<p><em>event-driven, OOP, IR, encoder</em></p>
<ul>
<li>å·¥å‚æ¨¡å¼åˆ†é… RMT é€šé“ï¼Œå‘é€å’Œæ¥æ”¶çš„æ¥å£éš”ç¦»</li>
<li>äº‹åŠ¡æ¨¡å‹ï¼Œæ¯ä¸ªå‘é€é€šé“æ‹¥æœ‰ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œä¸åŒäº‹åŠ¡æŒ‰åºæ‰§è¡Œ</li>
<li>åº”ç”¨é€‚é…å™¨æ¨¡å¼å®šä¹‰ RMT encoderï¼Œå°†åº”ç”¨å±‚æ•°æ®è¡¨ç¤ºè½¬è¯‘ä¸º RMT ç¡¬ä»¶ç¬¦å·ï¼Œå®šä¹‰ä¸€å¥—åŸç”Ÿç¼–ç å™¨æ¥å£</li>
<li>ç»„åˆè®¾è®¡æ¨¡å¼ï¼Œå¯è‡ªç”±ç»„åˆåŸç”Ÿç¼–ç å™¨ï¼Œä¸ºç‰¹å®šåº”ç”¨åˆ›å»ºæ–°çš„ç¼–ç å™¨</li>
<li>ä¼ è¾“å±‚æŠ½è±¡ï¼Œæ”¯æŒ DMA ä¸é DMA ä¼ è¾“ï¼Œæ¥å£å±‚ç»Ÿä¸€</li>
<li>RMT é©±åŠ¨è¯¦è§ <a href="https://github.com/espressif/esp-idf/tree/master/components/driver/rmt">GitHub é¡¹ç›®åœ°å€</a></li>
</ul>
</li>
<li>
<p><strong>è®¾è®¡å®ç°åµŒå…¥å¼ä»¥å¤ªç½‘é©±åŠ¨æ¡†æ¶</strong></p>
<p><em>mediator pattern, OOP, Ethernet</em></p>
<ul>
<li>ä¸­ä»‹å™¨è®¾è®¡æ¨¡å¼ï¼Œåˆ†éš”ç”¨æˆ·ã€MAC å±‚å’Œ PHY å±‚</li>
<li>å¤šæ€è®¾è®¡ï¼Œæ”¯æŒ ESP32 å†…éƒ¨ MAC æ§åˆ¶å™¨ä»¥åŠå…¶ä»– SPI æ¥å£çš„ä»¥å¤ªç½‘æ¨¡å—</li>
<li>é©±åŠ¨åˆ†å±‚è®¾è®¡ï¼ŒLL + HAL + driverï¼Œé™ä½é©±åŠ¨åœ¨ä¸åŒèŠ¯ç‰‡å¹³å°ä¸Šç§»æ¤çš„éš¾åº¦</li>
<li>è¯¦è§ <a href="https://github.com/espressif/esp-idf/tree/master/components/esp_eth">GitHub é¡¹ç›®åœ°å€</a></li>
</ul>
</li>
<li>
<p><strong>è®¾è®¡å®ç°åµŒå…¥å¼LCDé©±åŠ¨æ¡†æ¶</strong></p>
<p><em>RGB/YUV, I80, SPI, I2C, LvGL, OOP, LCD</em></p>
<ul>
<li>æŠ½è±¡å‡º panel_io æ¥å£ï¼Œç»Ÿä¸€ SPI/I2C/I80 å¯¹ LCD æ¨¡ç»„å‘é€å‘½ä»¤ä¸æ˜¾å­˜æ•°æ®çš„æ“ä½œ</li>
<li>æŠ½è±¡å‡º panel å¯¹è±¡ï¼Œç»Ÿä¸€åº”ç”¨å±‚å¯¹æ˜¾å­˜è®¾å¤‡çš„æ“ä½œï¼Œæ”¯æŒ RGB æ¥å£çš„ LCD å’Œ panel_io æŠ½è±¡æ¥å£çš„ LCD è®¾å¤‡</li>
<li>IO æ¥å£ä¸æ˜¾å­˜æ“ä½œåˆ†ç¦»ï¼ŒLCD æ§åˆ¶å™¨é©±åŠ¨å¯å¤ç”¨ç¨‹åº¦æœ€å¤§åŒ–</li>
<li>é€‚é… LvGL åº“ï¼Œå¯¹æ¥å¼‚æ­¥æ¥å£</li>
<li>è¯¦è§ <a href="https://github.com/espressif/esp-idf/tree/master/components/esp_lcd">GitHub é¡¹ç›®åœ°å€</a></li>
</ul>
</li>
<li>
<p><strong>BSP è½¯ä»¶åŒ…</strong></p>
<p><em>BSP, Interface Segregation Principle</em></p>
<ul>
<li>å®šä¹‰å¹¶å®ç°æ™ºèƒ½ç¯å¸¦ <a href="https://components.espressif.com/component/espressif/led_strip">led-strip</a> è®¾å¤‡çš„æ“ä½œæ¥å£
<ul>
<li>æœ¬è´¨ä¸Šä¸€ç§ RMT ç¼–ç å™¨å®ç°ï¼ŒåŒæ—¶ä¹Ÿé¢„ç•™äº† SPI å¤–è®¾çš„å®ç°å±‚</li>
</ul>
</li>
<li>å®šä¹‰å¹¶å®ç°ç›´æµæœ‰åˆ·ç”µæœº <a href="https://components.espressif.com/component/espressif/bdc_motor">bdc-motor</a> è®¾å¤‡çš„æ“ä½œæ¥å£
<ul>
<li>æœ¬è´¨ä¸Š MCPWM å¤–è®¾é©±åŠ¨çš„å†å°è£…ï¼ŒåŒæ—¶ä¹Ÿé¢„ç•™äº†å…¶ä»–å¤–è®¾çš„å®ç°å±‚</li>
</ul>
</li>
<li>æ¨¡æ‹Ÿ 1-Wire æ€»çº¿é©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨ <a href="https://components.espressif.com/components/espressif/onewire_bus">onewire_bus</a>
<ul>
<li>åˆ©ç”¨ RMT ç¡¬ä»¶çš„ç‹¬ç‰¹æ€§ï¼Œå®ç°å…¨ç¡¬ä»¶åŒ–çš„å•æ€»çº¿åè®®ï¼ˆé GPIO bit-bangingï¼‰</li>
<li>ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼å®ç°æ€»çº¿ä¸Šè®¾å¤‡çš„æ‰«æåŠŸèƒ½</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="-æŠ€èƒ½æ¸…å•"><a class="header" href="#-æŠ€èƒ½æ¸…å•">ğŸ›  æŠ€èƒ½æ¸…å•</a></h2>
<ul>
<li>â˜…â˜…â˜… C è¯­è¨€é¢å‘å¯¹è±¡å»ºæ¨¡ä¸å®ç°</li>
<li>â˜…â˜…â˜† Pythonã€Bash</li>
<li>â˜…â˜…â˜† è®¡ç®—æœºç½‘ç»œ</li>
</ul>
<h2 id="-èŒä¸šè®¤è¯"><a class="header" href="#-èŒä¸šè®¤è¯">ğŸ†ï¸ èŒä¸šè®¤è¯</a></h2>
<ul>
<li>èŒç§°: æ±Ÿè‹çœ<strong>ä¸­çº§</strong>ä¸“ä¸šæŠ€æœ¯èµ„æ ¼</li>
<li>ç½‘ç»œ: CCNA(920åˆ†), å…¨å›½è®¡ç®—æœºç­‰çº§4çº§(ç½‘ç»œå·¥ç¨‹å¸ˆ)</li>
<li>è¯­è¨€: CET-6(511åˆ†)</li>
<li>ç¼–ç¨‹: æ±Ÿè‹çœè®¡ç®—æœºç­‰çº§3çº§(è½¯ä»¶)</li>
<li>ç«èµ›: å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›äºŒç­‰å¥–</li>
</ul>
<h2 id="-ä¸šä½™çˆ±å¥½"><a class="header" href="#-ä¸šä½™çˆ±å¥½">â›µï¸ ä¸šä½™çˆ±å¥½</a></h2>
<ul>
<li>åª’ä½“: ç”¨åšå®¢ã€è§†é¢‘è®°å½•å·¥ä½œä¸ç”Ÿæ´»</li>
<li>åˆ›å®¢: æ¥è§¦æœ€æ–°æœ€å¥½ç©çš„åˆ›å®¢ç©å…·(æ ‘è“æ´¾, OpenWRT, XMOS, PSoC)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="risc-v-åŸºç¡€"><a class="header" href="#risc-v-åŸºç¡€">RISC-V åŸºç¡€</a></h1>
<h2 id="æŒ‡ä»¤é›†åˆ’åˆ†"><a class="header" href="#æŒ‡ä»¤é›†åˆ’åˆ†">æŒ‡ä»¤é›†åˆ’åˆ†</a></h2>
<div class="table-wrapper"><table><thead><tr><th>åç§°</th><th>ç±»åˆ«</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>RV32I</td><td>åŸºç¡€æŒ‡ä»¤</td><td>æ•´æ•°æŒ‡ä»¤ï¼ŒåŒ…å«ç®—æœ¯ã€åˆ†æ”¯ã€é€»è¾‘ã€è®¿å­˜æŒ‡ä»¤ï¼Œæœ‰32ä¸ª32ä½å¯„å­˜å™¨ï¼Œèƒ½å¯»å€32ä½åœ°å€ç©ºé—´</td></tr>
<tr><td>RV32E</td><td>åŸºç¡€æŒ‡ä»¤</td><td>ä¸RV32Iä¸€æ ·ï¼Œåªä¸è¿‡åªèƒ½ä½¿ç”¨å‰16ä¸ª32ä½å¯„å­˜å™¨</td></tr>
<tr><td>RV64I</td><td>åŸºç¡€æŒ‡ä»¤</td><td>æ•´æ•°æŒ‡ä»¤ï¼ŒåŒ…å«ç®—æœ¯ã€åˆ†æ”¯ã€é€»è¾‘ã€è®¿å­˜æŒ‡ä»¤ï¼Œæœ‰32ä¸ª64ä½å¯„å­˜å™¨ï¼Œèƒ½å¯»å€64ä½åœ°å€ç©ºé—´</td></tr>
<tr><td>RV128I</td><td>åŸºç¡€æŒ‡ä»¤</td><td>æ•´æ•°æŒ‡ä»¤ï¼ŒåŒ…å«ç®—æœ¯ã€åˆ†æ”¯ã€é€»è¾‘ã€è®¿å­˜æŒ‡ä»¤ï¼Œæœ‰32ä¸ª128ä½å¯„å­˜å™¨ï¼Œèƒ½å¯»å€128ä½åœ°å€ç©ºé—´</td></tr>
<tr><td>M</td><td>æ‰©å±•æŒ‡ä»¤</td><td>åŒ…å«ä¹˜æ³•ã€é™¤æ³•ã€æ±‚æ¨¡å–ä½™æŒ‡ä»¤</td></tr>
<tr><td>F</td><td>æ‰©å±•æŒ‡ä»¤</td><td>å•ç²¾åº¦(32bit)æµ®ç‚¹æŒ‡ä»¤</td></tr>
<tr><td>D</td><td>æ‰©å±•æŒ‡ä»¤</td><td>åŒç²¾åº¦(32bit)æµ®ç‚¹æŒ‡ä»¤,å¿…é¡»è¦åŒæ—¶æ”¯æŒFæ‰©å±•æŒ‡ä»¤</td></tr>
<tr><td>Q</td><td>æ‰©å±•æŒ‡ä»¤</td><td>å››å€ç²¾åº¦æµ®ç‚¹æŒ‡ä»¤</td></tr>
<tr><td>A</td><td>æ‰©å±•æŒ‡ä»¤</td><td>å­˜å‚¨å™¨åŸå­æ“ä½œæŒ‡ä»¤ï¼Œæ¯”å¦‚æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œè¯»-æ”¹-å†™ç­‰æŒ‡ä»¤</td></tr>
<tr><td>C</td><td>æ‰©å±•æŒ‡ä»¤</td><td>å‹ç¼©æŒ‡ä»¤,æŒ‡ä»¤é•¿åº¦ä¸º16ä½ï¼Œä¸»è¦ç”¨äºæ”¹å–„ç¨‹åºå¤§å°</td></tr>
<tr><td>P</td><td>æ‰©å±•æŒ‡ä»¤</td><td>å•æŒ‡ä»¤å¤šæ•°æ®ï¼ˆPacked-SIMD)æŒ‡ä»¤</td></tr>
<tr><td>B</td><td>æ‰©å±•æŒ‡ä»¤</td><td>ä½æ“ä½œæŒ‡ä»¤</td></tr>
<tr><td>H</td><td>æ‰©å±•æŒ‡ä»¤</td><td>æ”¯æŒ Hypervisor ç®¡ç†æŒ‡ä»¤</td></tr>
<tr><td>J</td><td>æ‰©å±•æŒ‡ä»¤</td><td>åŠ¨æ€ç¿»è¯‘è¯­è¨€çš„æŒ‡ä»¤</td></tr>
<tr><td>L</td><td>æ‰©å±•æŒ‡ä»¤</td><td>åè¿›åˆ¶æµ®ç‚¹æŒ‡ä»¤</td></tr>
<tr><td>N</td><td>æ‰©å±•æŒ‡ä»¤</td><td>ç”¨æˆ·ä¸­æ–­æŒ‡ä»¤</td></tr>
<tr><td>G</td><td>é€šç”¨æŒ‡ä»¤</td><td>åŒ…å« Iã€Mã€Aã€Fã€DæŒ‡ä»¤</td></tr>
</tbody></table>
</div>
<h3 id="rv32i-åŸºç¡€æŒ‡ä»¤é›†"><a class="header" href="#rv32i-åŸºç¡€æŒ‡ä»¤é›†">RV32I åŸºç¡€æŒ‡ä»¤é›†</a></h3>
<p><img src="cs/../images/risc-v/rv32i.png" alt="RV32I" /></p>
<h3 id="rv32i-é€šç”¨å¯„å­˜å™¨"><a class="header" href="#rv32i-é€šç”¨å¯„å­˜å™¨">RV32I é€šç”¨å¯„å­˜å™¨</a></h3>
<div class="table-wrapper"><table><thead><tr><th>å¯„å­˜å™¨</th><th>ABI åå­—</th><th>æè¿°</th><th>Saver</th></tr></thead><tbody>
<tr><td>x0</td><td>zero</td><td>0å€¼å¯„å­˜å™¨ï¼Œç¡¬ç¼–ç ä¸º0,å†™å…¥æ•°æ®å¿½ç•¥ï¼Œè¯»å–æ°¸è¿œä¸º0</td><td>-</td></tr>
<tr><td>x1</td><td>ra</td><td>è¿”å›åœ°å€</td><td>Caller</td></tr>
<tr><td>x2</td><td>sp</td><td>æ ˆæŒ‡é’ˆ</td><td>Callee</td></tr>
<tr><td>x3</td><td>gp</td><td>å…¨å±€æŒ‡é’ˆ</td><td>-</td></tr>
<tr><td>x4</td><td>tp</td><td>çº¿ç¨‹æŒ‡é’ˆ</td><td>-</td></tr>
<tr><td>x5</td><td>t0</td><td>ä¸´æ—¶å¯„å­˜å™¨æˆ–è€…å¤‡ç”¨çš„é“¾æ¥å¯„å­˜å™¨</td><td>Caller</td></tr>
<tr><td>x6-x7</td><td>t1-t2</td><td>ä¸´æ—¶å¯„å­˜å™¨</td><td>Caller</td></tr>
<tr><td>x8</td><td>s0/fp</td><td>éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨æˆ–è€…å¸§æŒ‡é’ˆå¯„å­˜å™¨</td><td>Callee</td></tr>
<tr><td>x9</td><td>s1</td><td>éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ï¼Œä¿å­˜åŸè¿›ç¨‹ä¸­çš„å…³é”®æ•°æ®ï¼Œé¿å…åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­è¢«ç ´å</td><td>Callee</td></tr>
<tr><td>x10-x11</td><td>a0-a1</td><td>å‡½æ•°å‚æ•°/è¿”å›å€¼</td><td>Caller</td></tr>
<tr><td>x12-x17</td><td>a2-a7</td><td>å‡½æ•°å‚æ•°</td><td>Caller</td></tr>
<tr><td>x18-x27</td><td>s2-s11</td><td>éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨</td><td>Callee</td></tr>
<tr><td>x28-x31</td><td>t3-t6</td><td>ä¸´æ—¶å¯„å­˜å™¨</td><td>Caller</td></tr>
</tbody></table>
</div>
<h4 id="å‡½æ•°è°ƒç”¨æ—¶ä¿ç•™çš„å¯„å­˜å™¨"><a class="header" href="#å‡½æ•°è°ƒç”¨æ—¶ä¿ç•™çš„å¯„å­˜å™¨">å‡½æ•°è°ƒç”¨æ—¶ä¿ç•™çš„å¯„å­˜å™¨</a></h4>
<p>è¢«è°ƒç”¨å‡½æ•°ä¸€èˆ¬ä¸ä¼šä½¿ç”¨è¿™äº›å¯„å­˜å™¨ï¼Œå³ä¾¿ä½¿ç”¨ä¹Ÿä¼šæå‰ä¿å­˜å¥½åŸå€¼ï¼Œå¯ä»¥ä¿¡ä»»ã€‚è¿™äº›å¯„å­˜å™¨æœ‰ï¼šsp, gp, tp å’Œ s0-s11 å¯„å­˜å™¨ã€‚</p>
<h4 id="å‡½æ•°è°ƒç”¨æ—¶ä¸ä¿å­˜çš„å¯„å­˜å™¨"><a class="header" href="#å‡½æ•°è°ƒç”¨æ—¶ä¸ä¿å­˜çš„å¯„å­˜å™¨">å‡½æ•°è°ƒç”¨æ—¶ä¸ä¿å­˜çš„å¯„å­˜å™¨</a></h4>
<p>æœ‰å¯èƒ½è¢«è°ƒç”¨å‡½æ•°ä½¿ç”¨æ›´æ”¹ï¼Œéœ€è¦calleråœ¨è°ƒç”¨å‰å¯¹è‡ªå·±ç”¨åˆ°çš„å¯„å­˜å™¨è¿›è¡Œä¿å­˜ã€‚è¿™äº›å¯„å­˜å™¨æœ‰ï¼šå‚æ•°ä¸è¿”å›åœ°å€å¯„å­˜å™¨ a0-a7ï¼Œè¿”å›åœ°å€å¯„å­˜å™¨ raï¼Œä¸´æ—¶å¯„å­˜å™¨ t0-t6</p>
<h2 id="rv32i-åŸºç¡€æŒ‡ä»¤æ ¼å¼"><a class="header" href="#rv32i-åŸºç¡€æŒ‡ä»¤æ ¼å¼">RV32I åŸºç¡€æŒ‡ä»¤æ ¼å¼</a></h2>
<p><img src="cs/../images/risc-v/rv32i_instruction_format.webp" alt="RV32I æŒ‡ä»¤ç¼–ç æ ¼å¼" /></p>
<ul>
<li>æºå¯„å­˜å™¨å’Œç›®æ ‡å¯„å­˜å™¨éƒ½è®¾è®¡å›ºå®šåœ¨æ‰€æœ‰ RISC-V æŒ‡ä»¤åŒæ ·çš„ä½ç½®ä¸Šï¼ŒæŒ‡ä»¤è¯‘ç ç›¸å¯¹ç®€å•ï¼Œæ‰€ä»¥æŒ‡ä»¤åœ¨ CPU æµæ°´çº¿ä¸­æ‰§è¡Œæ—¶ï¼Œå¯ä»¥å…ˆå¼€å§‹è®¿é—®å¯„å­˜å™¨ï¼Œç„¶åå†å®ŒæˆæŒ‡ä»¤è§£ç ã€‚</li>
<li>æ‰€æœ‰ç«‹å³æ•°çš„<strong>ç¬¦å·ä½</strong>æ€»æ˜¯åœ¨æŒ‡ä»¤çš„<strong>æœ€é«˜ä½</strong>ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ï¼Œæœ‰å¯èƒ½æˆä¸ºå…³é”®è·¯å¾„çš„<strong>ç«‹å³æ•°ç¬¦å·æ‰©å±•</strong>å¯ä»¥åœ¨æŒ‡ä»¤è§£ç å‰è¿›è¡Œï¼Œæœ‰åˆ©äº CPU æµæ°´çº¿çš„æ—¶åºä¼˜åŒ–ã€‚</li>
</ul>
<h3 id="å¯„å­˜å™¨-å¯„å­˜å™¨çš„ç®—æœ¯æŒ‡ä»¤"><a class="header" href="#å¯„å­˜å™¨-å¯„å­˜å™¨çš„ç®—æœ¯æŒ‡ä»¤">å¯„å­˜å™¨-å¯„å­˜å™¨çš„ç®—æœ¯æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/rv32i_instruction_arithmetic_reg2reg.webp" alt="RV32I å¯„å­˜å™¨-å¯„å­˜å™¨çš„ç®—æœ¯æŒ‡ä»¤" /></p>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="åŠ æ³•"><a class="header" href="#åŠ æ³•">åŠ æ³•</a></h5>
<pre><code class="language-assembly">add rd, rs1, rs2
</code></pre>
<h5 id="å‡æ³•"><a class="header" href="#å‡æ³•">å‡æ³•</a></h5>
<pre><code class="language-assembly">sub rd, rs1, rs2
</code></pre>
<h5 id="é€»è¾‘ä¸"><a class="header" href="#é€»è¾‘ä¸">é€»è¾‘ä¸</a></h5>
<pre><code class="language-assembly">and rd, rs1, rs2
</code></pre>
<h5 id="é€»è¾‘æˆ–"><a class="header" href="#é€»è¾‘æˆ–">é€»è¾‘æˆ–</a></h5>
<pre><code class="language-assembly">or rd, rs1, rs2
</code></pre>
<h5 id="é€»è¾‘å¼‚æˆ–"><a class="header" href="#é€»è¾‘å¼‚æˆ–">é€»è¾‘å¼‚æˆ–</a></h5>
<pre><code class="language-assembly">xor rd, rs1, rs2
</code></pre>
<h5 id="æœ‰ç¬¦å·å°äºæ¯”è¾ƒ"><a class="header" href="#æœ‰ç¬¦å·å°äºæ¯”è¾ƒ">æœ‰ç¬¦å·å°äºæ¯”è¾ƒ</a></h5>
<pre><code class="language-assembly">slt rd, rs1, rs2
</code></pre>
<h5 id="æ— ç¬¦å·å°äºæ¯”è¾ƒ"><a class="header" href="#æ— ç¬¦å·å°äºæ¯”è¾ƒ">æ— ç¬¦å·å°äºæ¯”è¾ƒ</a></h5>
<pre><code class="language-assembly">sltu rd, rs1, rs2
</code></pre>
<h5 id="é€»è¾‘å·¦ç§»"><a class="header" href="#é€»è¾‘å·¦ç§»">é€»è¾‘å·¦ç§»</a></h5>
<pre><code class="language-assembly">sll rd, rs1, rs2
</code></pre>
<h5 id="é€»è¾‘å³ç§»"><a class="header" href="#é€»è¾‘å³ç§»">é€»è¾‘å³ç§»</a></h5>
<pre><code class="language-assembly">srl rd, rs1, rs2
</code></pre>
<h5 id="ç®—æ•°å³ç§»"><a class="header" href="#ç®—æ•°å³ç§»">ç®—æ•°å³ç§»</a></h5>
<pre><code class="language-assembly">sra rd, rs1, rs2
</code></pre>
<h3 id="ç«‹å³æ•°çš„ç®—æœ¯æŒ‡ä»¤"><a class="header" href="#ç«‹å³æ•°çš„ç®—æœ¯æŒ‡ä»¤">ç«‹å³æ•°çš„ç®—æœ¯æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/rv32i_instruction_arithmetic_immediate.webp" alt="RV32I ç«‹å³æ•°çš„ç®—æœ¯æŒ‡ä»¤" /></p>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨ç«‹å³æ•°ç®—æœ¯æŒ‡ä»¤ä¸­ï¼Œæ²¡æœ‰å‡æ³•è¿ç®—ã€‚</p>
</blockquote>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-1"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-1">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="ç«‹å³æ•°åŠ æ³•"><a class="header" href="#ç«‹å³æ•°åŠ æ³•">ç«‹å³æ•°åŠ æ³•</a></h5>
<pre><code class="language-assembly">addi rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°é€»è¾‘ä¸"><a class="header" href="#ç«‹å³æ•°é€»è¾‘ä¸">ç«‹å³æ•°é€»è¾‘ä¸</a></h5>
<pre><code class="language-assembly">andi rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°é€»è¾‘æˆ–"><a class="header" href="#ç«‹å³æ•°é€»è¾‘æˆ–">ç«‹å³æ•°é€»è¾‘æˆ–</a></h5>
<pre><code class="language-assembly">ori rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°é€»è¾‘å¼‚æˆ–"><a class="header" href="#ç«‹å³æ•°é€»è¾‘å¼‚æˆ–">ç«‹å³æ•°é€»è¾‘å¼‚æˆ–</a></h5>
<pre><code class="language-assembly">xori rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°æœ‰ç¬¦å·å°äºæ¯”è¾ƒ"><a class="header" href="#ç«‹å³æ•°æœ‰ç¬¦å·å°äºæ¯”è¾ƒ">ç«‹å³æ•°æœ‰ç¬¦å·å°äºæ¯”è¾ƒ</a></h5>
<pre><code class="language-assembly">slti rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°æ— ç¬¦å·å°äºæ¯”è¾ƒ"><a class="header" href="#ç«‹å³æ•°æ— ç¬¦å·å°äºæ¯”è¾ƒ">ç«‹å³æ•°æ— ç¬¦å·å°äºæ¯”è¾ƒ</a></h5>
<pre><code class="language-assembly">sltiu rd, rs1, imm[11:0]
</code></pre>
<h5 id="ç«‹å³æ•°é€»è¾‘å·¦ç§»"><a class="header" href="#ç«‹å³æ•°é€»è¾‘å·¦ç§»">ç«‹å³æ•°é€»è¾‘å·¦ç§»</a></h5>
<pre><code class="language-assembly">slli rd, rs1, shamt[4:0]
</code></pre>
<h5 id="ç«‹å³æ•°é€»è¾‘å³ç§»"><a class="header" href="#ç«‹å³æ•°é€»è¾‘å³ç§»">ç«‹å³æ•°é€»è¾‘å³ç§»</a></h5>
<pre><code class="language-assembly">srli rd, rs1, shamt[4:0]
</code></pre>
<h5 id="ç«‹å³æ•°ç®—æ•°å³ç§»"><a class="header" href="#ç«‹å³æ•°ç®—æ•°å³ç§»">ç«‹å³æ•°ç®—æ•°å³ç§»</a></h5>
<pre><code class="language-assembly">srai rd, rs1, shamt[4:0]
</code></pre>
<h3 id="loadstore-æŒ‡ä»¤"><a class="header" href="#loadstore-æŒ‡ä»¤">Load/Store æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/rv32i_instruction_load_store.webp" alt="RV32I Load/Store æŒ‡ä»¤" /></p>
<p>Load å’Œ Store çš„å¯»å€æ¨¡å¼åªèƒ½æ˜¯ç¬¦å·æ‰©å±• 12 ä½çš„ç«‹å³æ•°ï¼ŒåŠ ä¸ŠåŸºåœ°å€å¯„å­˜å™¨å¾—åˆ°è®¿é—®çš„å­˜å‚¨å™¨åœ°å€ã€‚å› ä¸ºæ²¡æœ‰äº†å¤æ‚çš„å†…å­˜å¯»å€æ–¹å¼ï¼Œè¿™è®© CPU æµæ°´çº¿å¯ä»¥å¯¹æ•°æ®å†²çªæå‰åšå‡ºåˆ¤æ–­ï¼Œå¹¶é€šè¿‡æµæ°´çº¿å„çº§ä¹‹é—´çš„è½¬é€åŠ ä»¥å¤„ç†ï¼Œè€Œä¸éœ€è¦æ’å…¥ç©ºæ“ä½œï¼ˆNOPï¼‰ï¼Œæå¤§æé«˜äº†ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼ŒLoadæŒ‡ä»¤å±äº <strong>I</strong> å‹æŒ‡ä»¤ï¼Œè€Œ Store æŒ‡ä»¤å±äº <strong>S</strong> å‹æŒ‡ä»¤ã€‚</p>
</blockquote>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-2"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-2">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="å­—åŠ è½½"><a class="header" href="#å­—åŠ è½½">å­—åŠ è½½</a></h5>
<pre><code class="language-assembly">lw rd, offset[11:0](rs1)
</code></pre>
<h5 id="åŠå­—åŠ è½½"><a class="header" href="#åŠå­—åŠ è½½">åŠå­—åŠ è½½</a></h5>
<pre><code class="language-assembly">lh rd, offset[11:0](rs1)
</code></pre>
<h5 id="æ— ç¬¦å·åŠå­—åŠ è½½"><a class="header" href="#æ— ç¬¦å·åŠå­—åŠ è½½">æ— ç¬¦å·åŠå­—åŠ è½½</a></h5>
<pre><code class="language-assembly">lhu rd, offset[11:0](rs1)
</code></pre>
<h5 id="å­—èŠ‚åŠ è½½"><a class="header" href="#å­—èŠ‚åŠ è½½">å­—èŠ‚åŠ è½½</a></h5>
<pre><code class="language-assembly">lb rd, offset[11:0](rs1)
</code></pre>
<h5 id="æ— ç¬¦å·å­—èŠ‚åŠ è½½"><a class="header" href="#æ— ç¬¦å·å­—èŠ‚åŠ è½½">æ— ç¬¦å·å­—èŠ‚åŠ è½½</a></h5>
<pre><code class="language-assembly">lbu rd, offset[11:0](rs1)
</code></pre>
<h5 id="å­—å­˜å‚¨"><a class="header" href="#å­—å­˜å‚¨">å­—å­˜å‚¨</a></h5>
<pre><code class="language-assembly">sw rs2, offset[11:0](rs1)
</code></pre>
<h5 id="åŠå­—å­˜å‚¨"><a class="header" href="#åŠå­—å­˜å‚¨">åŠå­—å­˜å‚¨</a></h5>
<pre><code class="language-assembly">sh rs2, offset[11:0](rs1)
</code></pre>
<h5 id="å­—èŠ‚å­˜å‚¨"><a class="header" href="#å­—èŠ‚å­˜å‚¨">å­—èŠ‚å­˜å‚¨</a></h5>
<pre><code class="language-assembly">sb rs2, offset[11:0](rs1)
</code></pre>
<h3 id="æœ‰æ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤"><a class="header" href="#æœ‰æ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤">æœ‰æ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/rv32i_instruction_branch_condition.webp" alt="æœ‰æ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤" /></p>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-3"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-3">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="ç›¸ç­‰è·³è½¬"><a class="header" href="#ç›¸ç­‰è·³è½¬">ç›¸ç­‰è·³è½¬</a></h5>
<pre><code class="language-assembly">beq rs1, rs2, label
</code></pre>
<h5 id="ä¸ç­‰è·³è½¬"><a class="header" href="#ä¸ç­‰è·³è½¬">ä¸ç­‰è·³è½¬</a></h5>
<pre><code class="language-assembly">bne rs1, rs2, label
</code></pre>
<h5 id="å°äºè·³è½¬"><a class="header" href="#å°äºè·³è½¬">å°äºè·³è½¬</a></h5>
<pre><code class="language-assembly">blt rs1, rs2, label
</code></pre>
<h5 id="æ— ç¬¦å·å°äºè·³è½¬"><a class="header" href="#æ— ç¬¦å·å°äºè·³è½¬">æ— ç¬¦å·å°äºè·³è½¬</a></h5>
<pre><code class="language-assembly">bltu rs1, rs2, label
</code></pre>
<h5 id="å¤§äºç­‰äºè·³è½¬"><a class="header" href="#å¤§äºç­‰äºè·³è½¬">å¤§äºç­‰äºè·³è½¬</a></h5>
<pre><code class="language-assembly">bge rs1, rs2, label
</code></pre>
<h5 id="æ— ç¬¦å·å¤§äºç­‰äºè·³è½¬"><a class="header" href="#æ— ç¬¦å·å¤§äºç­‰äºè·³è½¬">æ— ç¬¦å·å¤§äºç­‰äºè·³è½¬</a></h5>
<pre><code class="language-assembly">bgeu rs1, rs2, label
</code></pre>
<h3 id="æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤"><a class="header" href="#æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤">æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤</a></h3>
<blockquote>
<p>æ³¨æ„ï¼Œç›´æ¥è·³è½¬æ˜¯ <strong>J</strong> å‹æŒ‡ä»¤ï¼Œè€Œç›¸å¯¹è·³è½¬æ˜¯ <strong>I</strong> å‹æŒ‡ä»¤ã€‚</p>
</blockquote>
<h4 id="ç›´æ¥è·³è½¬æŒ‡ä»¤"><a class="header" href="#ç›´æ¥è·³è½¬æŒ‡ä»¤">ç›´æ¥è·³è½¬æŒ‡ä»¤</a></h4>
<p><img src="cs/../images/risc-v/rv32i_instruction_branch_direct.webp" alt="æ— æ¡ä»¶ç›´æ¥è·³è½¬" /></p>
<p>JAL æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆï¼ŒæŠŠ 20 ä½çš„ç«‹å³æ•°åšç¬¦å·æ‰©å±•ï¼Œå¹¶å·¦ç§»ä¸€ä½ï¼Œäº§ç”Ÿä¸€ä¸ª 32 ä½çš„ç¬¦å·æ•°</li>
<li>ç„¶åï¼Œå°†è¯¥ 32 ä½ç¬¦å·æ•°å’Œ PC ç›¸åŠ æ¥äº§ç”Ÿç›®æ ‡åœ°å€ï¼ˆè¿™æ · JAL å¯ä»¥ä½œä¸ºçŸ­è·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬è‡³ PCÂ±1MB çš„åœ°å€èŒƒå›´å†…ï¼‰</li>
<li>åŒæ—¶ï¼ŒJAL ä¼šæŠŠç´§éšå…¶åçš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå­˜å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­ã€‚è¿™æ ·ï¼Œå¦‚æœç›®æ ‡å¯„å­˜å™¨æ˜¯0,åˆ™ JAL å°±ç­‰åŒäº goto æŒ‡ä»¤ï¼›å¦‚æœç›®æ ‡å¯„å­˜å™¨ä¸ä¸ºé›¶ï¼ŒJAL å¯ä»¥å®ç°å‡½æ•°è°ƒç”¨çš„åŠŸèƒ½</li>
</ol>
<h4 id="ç›¸å¯¹è·³è½¬æŒ‡ä»¤"><a class="header" href="#ç›¸å¯¹è·³è½¬æŒ‡ä»¤">ç›¸å¯¹è·³è½¬æŒ‡ä»¤</a></h4>
<p><img src="cs/../images/risc-v/rv32i_instruction_branch_relative.webp" alt="æ— æ¡ä»¶ç›¸å¯¹è·³è½¬" /></p>
<p>JALR æŒ‡ä»¤ä¼šæŠŠ 12 ä½ç«‹å³æ•°å’Œæºå¯„å­˜å™¨ç›¸åŠ ï¼Œå¹¶æŠŠç›¸åŠ çš„ç»“æœæœ«ä½æ¸…é›¶ï¼Œä½œä¸ºæ–°çš„è·³è½¬åœ°å€ã€‚å’Œ JAL æŒ‡ä»¤ä¸€æ ·ï¼ŒJALR ä¹Ÿä¼šæŠŠç´§éšå…¶åçš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå­˜å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­ã€‚</p>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-4"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-4">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="æ— æ¡ä»¶ç›´æ¥è·³è½¬"><a class="header" href="#æ— æ¡ä»¶ç›´æ¥è·³è½¬">æ— æ¡ä»¶ç›´æ¥è·³è½¬</a></h5>
<pre><code class="language-assembly">jal rd, label # å°† PC+4 çš„å€¼ä¿å­˜åˆ° rd å¯„å­˜å™¨ä¸­ï¼Œç„¶åè®¾ç½® PC = PC + offset
</code></pre>
<p>ä¼ªæŒ‡ä»¤ <code>j</code> å®é™…ä¸Šå°±æ˜¯jalæŒ‡ä»¤çš„å˜ä½“ï¼Œæ­¤æ—¶ rd ä¼šè¢«è®¾ç½®ä¸º x0,è¡¨ç¤ºä¸¢å¼ƒè¿”å›åœ°å€</p>
<h5 id="æ— æ¡ä»¶ç›¸å¯¹è·³è½¬"><a class="header" href="#æ— æ¡ä»¶ç›¸å¯¹è·³è½¬">æ— æ¡ä»¶ç›¸å¯¹è·³è½¬</a></h5>
<pre><code class="language-assembly">jalr rd, rs1, imm # å°† PC+4 ä¿å­˜åˆ° rd å¯„å­˜å™¨ä¸­ï¼Œç„¶åè®¾ç½® PC = rs1  + imm
</code></pre>
<p>è·³è½¬åˆ°ä»»æ„ 32 ä½ç»å¯¹åœ°å€å¤„</p>
<pre><code class="language-assembly">lui x1, &lt;hi20bits&gt;
jalr ra, x1, &lt;lo12bits&gt;
</code></pre>
<p>ç›¸å¯¹PCåœ°å€32ä½åç§»é‡çš„ç›¸å¯¹è·³è½¬</p>
<pre><code class="language-assembly">auipc x1, &lt;hi20bits&gt;
jalr x0, x1, &lt;lo12bits&gt;
</code></pre>
<h3 id="uupper-immediateå‹æŒ‡ä»¤"><a class="header" href="#uupper-immediateå‹æŒ‡ä»¤">U(Upper immediate)å‹æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/riscv_U_instruction.png" alt="Uå‹æŒ‡ä»¤" /></p>
<h4 id="æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-5"><a class="header" href="#æŒ‡ä»¤æ±‡ç¼–æ ¼å¼-5">æŒ‡ä»¤æ±‡ç¼–æ ¼å¼</a></h4>
<h5 id="lui-æŒ‡ä»¤-load-upper-immediate"><a class="header" href="#lui-æŒ‡ä»¤-load-upper-immediate">lui æŒ‡ä»¤ (Load Upper Immediate)</a></h5>
<pre><code class="language-assembly">lui rd, imm # å°† 20 ä½çš„ç«‹å³æ•°å·¦ç§»12ä½ï¼Œä½ 12 ä½è¡¥é›¶ï¼Œå¹¶å†™å›å¯„å­˜å™¨ rd ä¸­
</code></pre>
<p>é…åˆ addi æŒ‡ä»¤ï¼ˆè®¾ç½®ä½ 12 æ¯”ç‰¹ï¼‰å¯å®ç°è®²å¯„å­˜å™¨è®¾ç½®ä¸ºä»»æ„ 32 æ¯”ç‰¹çš„ç«‹å³æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-assembly">lui x10, 0x87654     # x10 = 0x87654000
addi x10, x10, 0x321 # x10 = 0x87654321
</code></pre>
<p>ä½†æ˜¯ï¼Œå½“è¿™ä¸ª 12 ä½çš„ç«‹å³æ•°ä¸ºè´Ÿæ•°ï¼ˆå³æœ€é«˜æ¯”ç‰¹ä½æ˜¯1ï¼‰æ—¶ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯é«˜ 20 ä½å‡ 1 å†å’Œä½ 12 ä½æ‹¼æ¥ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-assembly">lui x10, 0xDEADB     # x10 = 0xDEADB000
addi x10, x10, 0xEEF # x10 = 0xDEADBEEF
</code></pre>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå¦‚æœä½ 12 ä½çš„ç«‹å³æ•°çš„ç¬¦å·ä½æ˜¯ 1 ,é‚£å°±é¢„å…ˆç»™é«˜ 20 ä½çš„æ•°åŠ  1ã€‚<code>li</code> ä¼ªæŒ‡ä»¤å¯ä»¥æ›¿æˆ‘ä»¬å¤„ç†å¥½è¿™ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<h5 id="auipc-æŒ‡ä»¤-add-upper-immediate-to-pc"><a class="header" href="#auipc-æŒ‡ä»¤-add-upper-immediate-to-pc">auipc æŒ‡ä»¤ (Add Upper Immediate to PC)</a></h5>
<pre><code class="language-assembly">auipc rd, imm # å°† 20 ä½çš„ç«‹å³æ•°å·¦ç§»12ä½ï¼Œä½ 12 ä½è¡¥é›¶ï¼Œå°†å¾—åˆ°çš„ 32 ä½æ•°ä¸ pc çš„å€¼ç›¸åŠ ï¼Œæœ€åå†™å›å¯„å­˜å™¨ rd ä¸­
</code></pre>
<p>å…·ä½“åº”ç”¨æœ‰ï¼š</p>
<pre><code class="language-assembly">Label: auipc x10, 0 # å°† Label çš„åœ°å€ä¿å­˜åœ¨ x10 å¯„å­˜å™¨ä¸­
</code></pre>
<h3 id="æŒ‡ä»¤ç¼–ç ç©ºé—´çš„å¯æ‰©å±•æ€§"><a class="header" href="#æŒ‡ä»¤ç¼–ç ç©ºé—´çš„å¯æ‰©å±•æ€§">æŒ‡ä»¤ç¼–ç ç©ºé—´çš„å¯æ‰©å±•æ€§</a></h3>
<p><img src="cs/../images/risc-v/riscv_isa_custom_instruction.png" alt="æŒ‡ä»¤ç¼–ç ç©ºé—´çš„æ‰©å±•" /></p>
<ul>
<li>custom-0ã€custom-1 ç”¨äº RV32 çš„è‡ªå®šä¹‰æŒ‡ä»¤é›†æ‰©å±•</li>
<li>custom-2ã€custom-3 é¢„ç•™ç»™ RV128ï¼Œä¹Ÿå¯ä»¥ç”¨äº RV32ã€RV64 çš„ç”¨æˆ·è‡ªå®šä¹‰æŒ‡ä»¤é›†æ‰©å±•</li>
</ul>
<h2 id="csr-å¯„å­˜å™¨æŒ‡ä»¤"><a class="header" href="#csr-å¯„å­˜å™¨æŒ‡ä»¤">CSR å¯„å­˜å™¨æŒ‡ä»¤</a></h2>
<p>é™¤äº†å†…å­˜åœ°å€ç©ºé—´å’Œé€šç”¨å¯„å­˜å™¨åœ°å€ç©ºé—´å¤–ï¼ŒRISC-V ä¸­è¿˜å®šä¹‰äº†ä¸€ä¸ªç‹¬ç«‹çš„æ§åˆ¶ä¸çŠ¶æ€å¯„å­˜å™¨ï¼ˆCSRï¼‰åœ°å€ç©ºé—´ã€‚</p>
<h3 id="ç‹¬ç«‹çš„-12-ä½åœ°å€ç¼–ç ç©ºé—´"><a class="header" href="#ç‹¬ç«‹çš„-12-ä½åœ°å€ç¼–ç ç©ºé—´">ç‹¬ç«‹çš„ 12 ä½åœ°å€ç¼–ç ç©ºé—´</a></h3>
<p><img src="cs/../images/risc-v/csr_register_encoding.png" alt="CSRå¯„å­˜å™¨è®¿é—®æŒ‡ä»¤çš„ç¼–ç " /></p>
<h3 id="ä¸“ç”¨çš„-csr-æŒ‡ä»¤"><a class="header" href="#ä¸“ç”¨çš„-csr-æŒ‡ä»¤">ä¸“ç”¨çš„ CSR æŒ‡ä»¤</a></h3>
<p><img src="cs/../images/risc-v/rv32i_csr_instruction.webp" alt="CSR æŒ‡ä»¤" /></p>
<h2 id="å…¶ä»–æŒ‡ä»¤"><a class="header" href="#å…¶ä»–æŒ‡ä»¤">å…¶ä»–æŒ‡ä»¤</a></h2>
<ul>
<li>ç³»ç»Ÿè°ƒç”¨ <code>ecall</code> æŒ‡ä»¤</li>
<li>è°ƒè¯•æ—¶ç”¨äºå°†æ§åˆ¶è½¬ç§»åˆ°è°ƒè¯•ç¯å¢ƒçš„ <code>ebreak</code> æŒ‡ä»¤</li>
</ul>
<h3 id="å¸¸ç”¨æ±‡ç¼–ä¼ªæŒ‡ä»¤"><a class="header" href="#å¸¸ç”¨æ±‡ç¼–ä¼ªæŒ‡ä»¤">å¸¸ç”¨æ±‡ç¼–ä¼ªæŒ‡ä»¤</a></h3>
<h5 id="èµ‹å€¼æŒ‡ä»¤"><a class="header" href="#èµ‹å€¼æŒ‡ä»¤">èµ‹å€¼æŒ‡ä»¤</a></h5>
<pre><code class="language-assembly">mv rd, rs # ç­‰æ•ˆäº addi rd, rs, x0
</code></pre>
<h5 id="åŠ è½½ç«‹å³æ•°"><a class="header" href="#åŠ è½½ç«‹å³æ•°">åŠ è½½ç«‹å³æ•°</a></h5>
<pre><code class="language-assembly">li rd, 13 # ç­‰æ•ˆäº addi rd, x0, 13
</code></pre>
<h5 id="å‡½æ•°è°ƒç”¨å’Œè¿”å›"><a class="header" href="#å‡½æ•°è°ƒç”¨å’Œè¿”å›">å‡½æ•°è°ƒç”¨å’Œè¿”å›</a></h5>
<pre><code class="language-assembly">jal my_foo # å‡½æ•°è°ƒç”¨
ret # å‡½æ•°è¿”å›ï¼Œç­‰æ•ˆäº jr raï¼Œç­‰æ•ˆäº jalr x0, ra, 0
</code></pre>
<h2 id="å•æ ¸-cpu-ç»„æˆç»“æ„"><a class="header" href="#å•æ ¸-cpu-ç»„æˆç»“æ„">å•æ ¸ CPU ç»„æˆç»“æ„</a></h2>
<p><img src="cs/../images/risc-v/riscv_alu.png" alt="ALU" /></p>
<p><strong>æ•°æ®é€šè·¯</strong>æ˜¯å¤„ç†å™¨ä¸­æ‰§è¡Œå¤„ç†å™¨æ‰€éœ€æ“ä½œçš„ç¡¬ä»¶éƒ¨åˆ†ï¼Œå°±åƒæ˜¯å¤„ç†å™¨çš„å››è‚¢ã€‚</p>
<p><strong>æ§åˆ¶å™¨</strong>æ˜¯å¯¹æ•°æ®é€šè·¯è¦åšä»€ä¹ˆæ“ä½œè¿›è¡Œè¡Œä¸ºè°ƒåº¦çš„ç¡¬ä»¶ç»“æ„ï¼Œå°±åƒæ˜¯å¤„ç†å™¨çš„å¤§è„‘ã€‚</p>
<h3 id="æµæ°´çº¿æŠ€æœ¯"><a class="header" href="#æµæ°´çº¿æŠ€æœ¯">æµæ°´çº¿æŠ€æœ¯</a></h3>
<h4 id="äº”çº§æµæ°´çº¿"><a class="header" href="#äº”çº§æµæ°´çº¿">äº”çº§æµæ°´çº¿</a></h4>
<p><img src="cs/../images/risc-v/rv32i_5stage_pipelines.jpeg" alt="äº”çº§æµæ°´çº¿" /></p>
<h4 id="æµæ°´çº¿åœ¨ä¸åŒé˜¶æ®µä½¿ç”¨çš„èµ„æº"><a class="header" href="#æµæ°´çº¿åœ¨ä¸åŒé˜¶æ®µä½¿ç”¨çš„èµ„æº">æµæ°´çº¿åœ¨ä¸åŒé˜¶æ®µä½¿ç”¨çš„èµ„æº</a></h4>
<p><img src="cs/../images/risc-v/riscv_pipeline_resource_usage.png" alt="æµæ°´çº¿èµ„æºä½¿ç”¨" /></p>
<blockquote>
<p>ä¸ºäº†ç¡®ä¿ç¡¬ä»¶å…±äº«çš„æ—¶å€™ï¼Œå‰ä¸€é˜¶æ®µçš„æ•°æ®ä¸è¢«ä¸¢å¤±ï¼Œéœ€è¦åœ¨æµæ°´çº¿ä¹‹é—´æ’å…¥â€œé˜¶æ®µå¯„å­˜å™¨â€æ¥ä¿å­˜ä¸­é—´å€¼å’Œæ§åˆ¶ä¿¡å·ã€‚</p>
</blockquote>
<h3 id="æ•°æ®é€šè·¯"><a class="header" href="#æ•°æ®é€šè·¯">æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_data_path.png" alt="æ•°æ®é€šè·¯" /></p>
<ol>
<li>å–æŒ‡é˜¶æ®µï¼ˆInstruction Fetchï¼‰ï¼šå°†æŒ‡ä»¤ä»å­˜å‚¨å™¨ä¸­è¯»å–å‡ºæ¥ï¼ŒPC å¯„å­˜å™¨å‘Šè¯‰å½“å‰æŒ‡ä»¤åœ¨å­˜å‚¨å™¨ä¸­çš„ä½ç½®ã€‚è¯»å–ä¸€æ¡æŒ‡ä»¤åï¼ŒPC å¯„å­˜å™¨ä¼šæ ¹æ®æŒ‡ä»¤çš„é•¿åº¦è‡ªåŠ¨é€’å¢ï¼Œæˆ–è€…æ”¹å†™æˆæŒ‡å®šçš„åœ°å€ã€‚</li>
<li>è¯‘ç é˜¶æ®µï¼ˆInstruction Decodeï¼‰ï¼šå°†å­˜å‚¨å™¨ä¸­å–å‡ºçš„æŒ‡ä»¤è¿›è¡Œç¿»è¯‘ï¼Œè¯†åˆ«å‡ºæŒ‡ä»¤çš„ç±»åˆ«ä»¥åŠæ‰€éœ€çš„å„ç§æ“ä½œæ•°ã€‚</li>
<li>æ‰§è¡Œé˜¶æ®µï¼ˆInstruction Executeï¼‰ï¼šå¯¹æŒ‡ä»¤è¿›è¡ŒçœŸæ­£çš„è¿ç®—ï¼ŒæœŸé—´æœ€å…³é”®çš„æ¨¡å—æ˜¯ç®—æœ¯é€»è¾‘å•å…ƒï¼ˆALUï¼‰ã€‚</li>
<li>è®¿å­˜é˜¶æ®µï¼ˆMemory Accessï¼‰ï¼šå­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤å°†æ•°æ®ä»å­˜å‚¨å™¨ä¸­è¯»å‡ºï¼Œæˆ–å†™å…¥å­˜å‚¨å™¨ã€‚</li>
<li>å†™å›é˜¶æ®µï¼ˆWrite Backï¼‰ï¼šå°†æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœå†™å›é€šç”¨å¯„å­˜å™¨ã€‚</li>
</ol>
<h3 id="ç®€æ˜“-cpu-å†…éƒ¨ç»„ä»¶æ¡†å›¾"><a class="header" href="#ç®€æ˜“-cpu-å†…éƒ¨ç»„ä»¶æ¡†å›¾">ç®€æ˜“ CPU å†…éƒ¨ç»„ä»¶æ¡†å›¾</a></h3>
<p><img src="cs/../images/risc-v/rv32i_cpu_design.jpeg" alt="RV32I CPU 5çº§æµæ°´çº¿è®¾è®¡æ¡†å›¾" /></p>
<h3 id="pre_if-æ¨¡å—è®¾è®¡"><a class="header" href="#pre_if-æ¨¡å—è®¾è®¡">pre_if æ¨¡å—è®¾è®¡</a></h3>
<p>æ ¹æ®å½“å‰çš„æŒ‡ä»¤å’Œ PC å¯„å­˜å™¨ï¼Œé¢„æµ‹ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚ä¸ºäº†å®ç°ç¨‹åºåˆ†æ”¯è·³è½¬çš„åŠŸèƒ½ï¼Œå°±éœ€è¦è®¾è®¡ä¸€ä¸ª<strong>é¢„è¯»å–</strong>æ¨¡å—ï¼Œä¸ç®¡æŒ‡ä»¤æ˜¯å¦è·³è½¬ï¼ˆè¿™ä¸ªç»“æœä¼šåœ¨æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µç»“æŸæ‰èƒ½çŸ¥é“ï¼‰ï¼Œéƒ½æå‰æŠŠè·³è½¬ä¹‹åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä»å­˜å‚¨å™¨ä¸­è¯»å–å‡ºæ¥ï¼Œä»¥å¤‡æµæ°´çº¿çš„ä¸‹ä¸€ä¸ªé˜¶æ®µä½¿ç”¨ï¼Œè¿™èƒ½æåˆ° CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<pre><code class="language-verilog">module pre_if (
    input [31:0] instr,
    input [31:0] pc,

    output [31:0] pre_pc
);

    wire is_bxx = (instr[6:0] == `OPCODE_BRANCH); // æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„æ“ä½œç 
    wire is_jal = (instr[6:0] == `OPCODE_JAL) ;   // æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„æ“ä½œç 

    // Bå‹æŒ‡ä»¤çš„ç«‹å³æ•°æ‹¼æ¥
    wire [31:0] bimm  = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1'b0};
    // Jå‹æŒ‡ä»¤çš„ç«‹å³æ•°æ‹¼æ¥
    wire [31:0] jimm  = {{12{instr[31]}}, instr[19:12], instr[20], instr[30:21], 1'b0};

    // æŒ‡ä»¤åœ°å€çš„åç§»é‡
    // è¿™é‡Œå®é™…ä¸Šåšäº†ä¸€ä¸ªç®€å•çš„åˆ†æ”¯é¢„æµ‹
    wire [31:0] adder = is_jal ? jimm : (is_bxx &amp; bimm[31]) ? bimm : 4;
    // æ ¹æ®å½“å‰ PC å’ŒæŒ‡ä»¤çš„åç§»é‡ç›¸åŠ ï¼Œå¾—åˆ°é¢„æµ‹çš„ PC å€¼
    assign pre_pc = pc + adder;

endmodule
</code></pre>
<h3 id="if_id-æ¨¡å—è®¾è®¡"><a class="header" href="#if_id-æ¨¡å—è®¾è®¡">if_id æ¨¡å—è®¾è®¡</a></h3>
<p>é¢„è¯»å–æ¨¡å—è¯»å‡ºçš„æŒ‡ä»¤å¹¶ä¸æ˜¯å…¨éƒ¨éƒ½èƒ½å‘é€ç»™åç»­çš„æ¨¡å—æ‰§è¡Œçš„ï¼Œæ¯”å¦‚æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤åœ¨æ‰§è¡Œåå‘ç°è·³è½¬æ¡ä»¶ä¸æˆç«‹ï¼Œè¿™æ—¶é¢„è¯»å–çš„æŒ‡ä»¤å°±æ˜¯æ— æ•ˆçš„ï¼Œéœ€è¦å¯¹æµæ°´çº¿è¿›è¡Œå†²åˆ·ï¼ˆflushï¼‰ï¼ŒæŠŠæ— æ•ˆçš„æŒ‡ä»¤éƒ½æ¸…é™¤æ‰ã€‚</p>
<pre><code class="language-verilog">module if_id (
  input         clk,
  input         reset,
  input  [31:0] in_instr,
  input  [31:0] in_pc,
  input         flush,
  input         valid,
  output [31:0] out_instr,
  output [31:0] out_pc,
  output        out_noflush
);

  reg [31:0] reg_instr;
  reg [31:0] reg_pc;
  reg        reg_noflush;

  assign out_instr = reg_instr;
  assign out_pc = reg_pc;
  assign out_noflush = reg_noflush;

  //æŒ‡ä»¤ä¼ é€’
  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_instr &lt;= 32'h0;
    end else if (flush) begin
      reg_instr &lt;= 32'h0;
    end else if (valid) begin
      reg_instr &lt;= in_instr;
    end
  end

  //PCå€¼è½¬é€’
  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_pc &lt;= 32'h0;
    end else if (flush) begin
      reg_pc &lt;= 32'h0;
    end else if (valid) begin
      reg_pc &lt;= in_pc;
    end
  end

  //æµæ°´çº¿å†²åˆ·æ ‡å¿—ä½
  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_noflush &lt;= 1'h0;
    end else if (flush) begin
      reg_noflush &lt;= 1'h0;
    end else if (valid) begin
      reg_noflush &lt;= 1'h1;
    end

  end

endmodule
</code></pre>
<h3 id="decode-æ¨¡å—è®¾è®¡"><a class="header" href="#decode-æ¨¡å—è®¾è®¡">decode æ¨¡å—è®¾è®¡</a></h3>
<p>å°½ç®¡æŒ‡ä»¤æ ¼å¼ä¸åŒï¼Œä½†æ˜¯æŒ‡ä»¤è¯‘ç æ¨¡å—ç¿»è¯‘æŒ‡ä»¤çš„å·¥ä½œæœºåˆ¶æ˜¯<strong>ç»Ÿä¸€</strong>çš„ã€‚é¦–å…ˆä¼šç¿»è¯‘å‡ºæŒ‡ä»¤ä¸­æºå¸¦çš„å¯„å­˜å™¨ç´¢å¼•ã€ç«‹å³æ•°ç­‰ä¿¡æ¯ï¼Œæ¥ç€å¤„ç†å¯èƒ½å­˜åœ¨çš„æ•°æ®å†’é™©ï¼Œå†ç”±è¯‘ç æ•°æ®é€šè·¯è´Ÿè´£æŠŠè¯‘ç åçš„æŒ‡ä»¤ä¿¡æ¯ï¼Œå‘é€ç»™å¯¹åº”çš„æ‰§è¡Œå•å…ƒå»æ‰§è¡Œã€‚</p>
<p>è¯‘ç çš„è¿‡ç¨‹ï¼šå…ˆè¯†åˆ«æŒ‡ä»¤çš„æ“ä½œç ï¼ˆæ°¸è¿œæ˜¯ä½7ä½ï¼‰ï¼Œæ ¹æ®æ“ä½œç å¯¹åº”çš„ä»£ç æ ‡è¯†ï¼Œäº§ç”Ÿåˆ†æ”¯ä¿¡å· branchã€è·³è½¬ä¿¡å· jumpã€è¯»å­˜å‚¨å™¨ä¿¡å· mem_read ......</p>
<pre><code class="language-verilog">module decode (
  input   [31:0] instr,

  output  [4:0] rs1_addr,
  output  [4:0] rs2_addr,
  output  [4:0] rd_addr,
  output  [2:0] funct3,
  output  [6:0] funct7,
  output        branch,
  output [1:0]  jump,
  output        mem_read,
  output        mem_write,
  output        reg_write,
  output        to_reg,
  output [1:0]  result_sel,
  output        alu_src,
  output        pc_add,
  output [6:0]  types,
  output [1:0]  alu_ctrlop,
  output        valid_inst,
  output [31:0] imm
);

localparam DEC_INVALID = 21'b0;

reg [20:0] dec_array;

//---------- decode rs1ã€rs2 -----------------
assign rs1_addr = instr[19:15];
assign rs2_addr = instr[24:20];

//---------- decode rd -----------------------
assign rd_addr = instr[11:7];

//---------- decode funct3ã€funct7 -----------
assign funct7 = instr[31:25];
assign funct3 = instr[14:12];

// ----------------------------- decode signals ---------------------------------

//                        20     19-18  17       16        15        14     13-12      11      10     9--------3  2---1      0
//                        branch jump   memRead  memWrite  regWrite  toReg  resultSel  aluSrc  pcAdd     RISBUJZ  aluctrlop  validInst
localparam DEC_LUI     = {1'b0,  2'b00, 1'b0,    1'b0,     1'b1,     1'b0,  2'b01,     1'b0,   1'b0,  7'b0000100, 2'b00,     1'b1};
localparam DEC_AUIPC   = {1'b0,  2'b00, 1'b0,    1'b0,     1'b1,     1'b0,  2'b00,     1'b1,   1'b1,  7'b0000100, 2'b00,     1'b1};
localparam DEC_JAL     = {1'b0,  2'b00, 1'b0,    1'b0,     1'b1,     1'b0,  2'b10,     1'b0,   1'b0,  7'b0000010, 2'b00,     1'b1};
localparam DEC_JALR    = {1'b0,  2'b11, 1'b0,    1'b0,     1'b1,     1'b0,  2'b10,     1'b1,   1'b0,  7'b0100000, 2'b00,     1'b1};
localparam DEC_BRANCH  = {1'b1,  2'b00, 1'b0,    1'b0,     1'b0,     1'b0,  2'b00,     1'b0,   1'b0,  7'b0001000, 2'b10,     1'b1};
localparam DEC_LOAD    = {1'b0,  2'b00, 1'b1,    1'b0,     1'b1,     1'b1,  2'b00,     1'b1,   1'b0,  7'b0100000, 2'b00,     1'b1};
localparam DEC_STORE   = {1'b0,  2'b00, 1'b0,    1'b1,     1'b0,     1'b0,  2'b00,     1'b1,   1'b0,  7'b0010000, 2'b00,     1'b1};
localparam DEC_ALUI    = {1'b0,  2'b00, 1'b0,    1'b0,     1'b1,     1'b0,  2'b00,     1'b1,   1'b0,  7'b0100000, 2'b01,     1'b1};
localparam DEC_ALUR    = {1'b0,  2'b00, 1'b0,    1'b0,     1'b1,     1'b0,  2'b00,     1'b0,   1'b0,  7'b1000000, 2'b01,     1'b1};

assign  {branch, jump, mem_read, mem_write, reg_write, to_reg, result_sel, alu_src, pc_add, types, alu_ctrlop, valid_inst} = dec_array;


always @(*) begin
  //$write("%x", instr);
  case(instr[6:0])
    `OPCODE_LUI    :   dec_array &lt;= DEC_LUI;
    `OPCODE_AUIPC  :   dec_array &lt;= DEC_AUIPC;
    `OPCODE_JAL    :   dec_array &lt;= DEC_JAL;
    `OPCODE_JALR   :   dec_array &lt;= DEC_JALR;
    `OPCODE_BRANCH :   dec_array &lt;= DEC_BRANCH;
    `OPCODE_LOAD   :   dec_array &lt;= DEC_LOAD;
    `OPCODE_STORE  :   dec_array &lt;= DEC_STORE;
    `OPCODE_ALUI   :   dec_array &lt;= DEC_ALUI;
    `OPCODE_ALUR   :   dec_array &lt;= DEC_ALUR;
    default        :  begin
                 dec_array &lt;= DEC_INVALID;
               //  $display("~~~decode error~~~%x", instr);
    end
  endcase
end

// -------------------- IMM -------------------------

wire [31:0] Iimm = {{21{instr[31]}}, instr[30:20]};
wire [31:0] Simm = {{21{instr[31]}}, instr[30:25], instr[11:7]};
wire [31:0] Bimm = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1'b0};
wire [31:0] Uimm = {instr[31:12], 12'b0};
wire [31:0] Jimm = {{12{instr[31]}}, instr[19:12], instr[20], instr[30:21], 1'b0};

assign imm = {32{types[5]}} &amp; Iimm
           | {32{types[4]}} &amp; Simm
           | {32{types[3]}} &amp; Bimm
           | {32{types[2]}} &amp; Uimm
           | {32{types[1]}} &amp; Jimm;

endmodule
</code></pre>
<p>å‰é¢è¯‘ç æ¨¡å—å¾—åˆ°çš„æŒ‡ä»¤ä¿¡å·å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œä¸€ç±»æ˜¯æŒ‡ä»¤çš„æ“ä½œç ç»è¿‡è¯‘ç åäº§ç”Ÿçš„<strong>æŒ‡ä»¤æ§åˆ¶ä¿¡å·</strong>ï¼Œå¦ä¸€ç±»æ˜¯ä»æŒ‡ä»¤æºç ä¸­æå–å‡ºæ¥çš„<strong>æ•°æ®ä¿¡æ¯</strong>ï¼Œå¦‚ç«‹å³æ•°ã€å¯„å­˜å™¨ç´¢å¼•ã€åŠŸèƒ½ç ç­‰ã€‚ä¸ºäº†èƒ½å¯¹æµæ°´çº¿æ›´å¥½åœ°å®æ–½æ§åˆ¶ï¼Œæˆ‘ä»¬æŠŠè¯‘ç åçš„æ•°æ®å’Œæ§åˆ¶ä¿¡å·åˆ†å¼€å¤„ç†ã€‚</p>
<h3 id="è¯‘ç æ§åˆ¶æ¨¡å—"><a class="header" href="#è¯‘ç æ§åˆ¶æ¨¡å—">è¯‘ç æ§åˆ¶æ¨¡å—</a></h3>
<p>å½“æŒ‡ä»¤å‘ç”Ÿå†²çªæ—¶ï¼Œéœ€è¦å¯¹æµæ°´çº¿è¿›è¡Œå†²åˆ·ï¼Œè¯‘ç é˜¶æ®µçš„æŒ‡ä»¤ä¿¡æ¯ä¹Ÿéœ€è¦æ¸…é™¤ã€‚</p>
<pre><code class="language-Verilog">module id_ex_ctrl (
  input        clk,
  input        reset,
  input        in_ex_ctrl_itype,
  input  [1:0] in_ex_ctrl_alu_ctrlop,
  input  [1:0] in_ex_ctrl_result_sel,
  input        in_ex_ctrl_alu_src,
  input        in_ex_ctrl_pc_add,
  input        in_ex_ctrl_branch,
  input  [1:0] in_ex_ctrl_jump,
  input        in_mem_ctrl_mem_read,
  input        in_mem_ctrl_mem_write,
  input  [1:0] in_mem_ctrl_mask_mode,
  input        in_mem_ctrl_sext,
  input        in_wb_ctrl_to_reg,
  input        in_wb_ctrl_reg_write,
  input        in_noflush,
  input        flush,
  input        valid,
  output       out_ex_ctrl_itype,
  output [1:0] out_ex_ctrl_alu_ctrlop,
  output [1:0] out_ex_ctrl_result_sel,
  output       out_ex_ctrl_alu_src,
  output       out_ex_ctrl_pc_add,
  output       out_ex_ctrl_branch,
  output [1:0] out_ex_ctrl_jump,
  output       out_mem_ctrl_mem_read,
  output       out_mem_ctrl_mem_write,
  output [1:0] out_mem_ctrl_mask_mode,
  output       out_mem_ctrl_sext,
  output       out_wb_ctrl_to_reg,
  output       out_wb_ctrl_reg_write,
  output       out_noflush
);

  reg  reg_ex_ctrl_itype;
  reg [1:0] reg_ex_ctrl_alu_ctrlop;
  reg [1:0] reg_ex_ctrl_result_sel;
  reg  reg_ex_ctrl_alu_src;
  reg  reg_ex_ctrl_pc_add;
  reg  reg_ex_ctrl_branch;
  reg [1:0] reg_ex_ctrl_jump;
  reg  reg_mem_ctrl_mem_read;
  reg  reg_mem_ctrl_mem_write;
  reg [1:0] reg_mem_ctrl_mask_mode;
  reg  reg_mem_ctrl_sext;
  reg  reg_wb_ctrl_to_reg;
  reg  reg_wb_ctrl_reg_write;
  reg  reg_noflush;

  assign out_ex_ctrl_itype = reg_ex_ctrl_itype;
  assign out_ex_ctrl_alu_ctrlop = reg_ex_ctrl_alu_ctrlop;
  assign out_ex_ctrl_result_sel = reg_ex_ctrl_result_sel;
  assign out_ex_ctrl_alu_src = reg_ex_ctrl_alu_src;
  assign out_ex_ctrl_pc_add = reg_ex_ctrl_pc_add;
  assign out_ex_ctrl_branch = reg_ex_ctrl_branch;
  assign out_ex_ctrl_jump = reg_ex_ctrl_jump;
  assign out_mem_ctrl_mem_read = reg_mem_ctrl_mem_read;
  assign out_mem_ctrl_mem_write = reg_mem_ctrl_mem_write;
  assign out_mem_ctrl_mask_mode = reg_mem_ctrl_mask_mode;
  assign out_mem_ctrl_sext = reg_mem_ctrl_sext;
  assign out_wb_ctrl_to_reg = reg_wb_ctrl_to_reg;
  assign out_wb_ctrl_reg_write = reg_wb_ctrl_reg_write;
  assign out_noflush = reg_noflush;

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_itype &lt;= 1'h0;
    end else if (flush) begin
      reg_ex_ctrl_itype &lt;= 1'h0;
    end else if (valid) begin
      reg_ex_ctrl_itype &lt;= in_ex_ctrl_itype;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_alu_ctrlop &lt;= 2'h0;
    end else if (flush) begin
      reg_ex_ctrl_alu_ctrlop &lt;= 2'h0;
    end else if (valid) begin
      reg_ex_ctrl_alu_ctrlop &lt;= in_ex_ctrl_alu_ctrlop;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_result_sel &lt;= 2'h0;
    end else if (flush) begin
      reg_ex_ctrl_result_sel &lt;= 2'h0;
    end else if (valid) begin
      reg_ex_ctrl_result_sel &lt;= in_ex_ctrl_result_sel;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_alu_src &lt;= 1'h0;
    end else if (flush) begin
      reg_ex_ctrl_alu_src &lt;= 1'h0;
    end else if (valid) begin
      reg_ex_ctrl_alu_src &lt;= in_ex_ctrl_alu_src;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_pc_add &lt;= 1'h0;
    end else if (flush) begin
      reg_ex_ctrl_pc_add &lt;= 1'h0;
    end else if (valid) begin
      reg_ex_ctrl_pc_add &lt;= in_ex_ctrl_pc_add;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_branch &lt;= 1'h0;
    end else if (flush) begin
      reg_ex_ctrl_branch &lt;= 1'h0;
    end else if (valid) begin
      reg_ex_ctrl_branch &lt;= in_ex_ctrl_branch;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_ex_ctrl_jump &lt;= 2'h0;
    end else if (flush) begin
      reg_ex_ctrl_jump &lt;= 2'h0;
    end else if (valid) begin
      reg_ex_ctrl_jump &lt;= in_ex_ctrl_jump;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_mem_ctrl_mem_read &lt;= 1'h0;
    end else if (flush) begin
      reg_mem_ctrl_mem_read &lt;= 1'h0;
    end else if (valid) begin
      reg_mem_ctrl_mem_read &lt;= in_mem_ctrl_mem_read;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_mem_ctrl_mem_write &lt;= 1'h0;
    end else if (flush) begin
      reg_mem_ctrl_mem_write &lt;= 1'h0;
    end else if (valid) begin
      reg_mem_ctrl_mem_write &lt;= in_mem_ctrl_mem_write;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_mem_ctrl_mask_mode &lt;= 2'h0;
    end else if (flush) begin
      reg_mem_ctrl_mask_mode &lt;= 2'h0;
    end else if (valid) begin
      reg_mem_ctrl_mask_mode &lt;= in_mem_ctrl_mask_mode;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_mem_ctrl_sext &lt;= 1'h0;
    end else if (flush) begin
      reg_mem_ctrl_sext &lt;= 1'h0;
    end else if (valid) begin
      reg_mem_ctrl_sext &lt;= in_mem_ctrl_sext;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_wb_ctrl_to_reg &lt;= 1'h0;
    end else if (flush) begin
      reg_wb_ctrl_to_reg &lt;= 1'h0;
    end else if (valid) begin
      reg_wb_ctrl_to_reg &lt;= in_wb_ctrl_to_reg;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_wb_ctrl_reg_write &lt;= 1'h0;
    end else if (flush) begin
      reg_wb_ctrl_reg_write &lt;= 1'h0;
    end else if (valid) begin
      reg_wb_ctrl_reg_write &lt;= in_wb_ctrl_reg_write;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_noflush &lt;= 1'h0;
    end else if (flush) begin
      reg_noflush &lt;= 1'h0;
    end else if (valid) begin
      reg_noflush &lt;= in_noflush;
    end
  end


endmodule
</code></pre>
<h3 id="è¯‘ç æ•°æ®é€šè·¯æ¨¡å—"><a class="header" href="#è¯‘ç æ•°æ®é€šè·¯æ¨¡å—">è¯‘ç æ•°æ®é€šè·¯æ¨¡å—</a></h3>
<p>è¯‘ç æ•°æ®é€šè·¯ä¼šæ ¹æ® CPU ç›¸å…³æ§åˆ¶æ¨¡å—äº§ç”Ÿçš„æµæ°´çº¿å†²åˆ·æ§åˆ¶ä¿¡å·ï¼Œå†³å®šè¦ä¸è¦æŠŠè¿™äº›æ•°æ®å‘é€ç»™åç»­æ¨¡å—ã€‚</p>
<pre><code class="language-Verilog">module id_ex (
  input         clk,
  input         reset,
  input  [4:0]  in_rd_addr,
  input  [6:0]  in_funct7,
  input  [2:0]  in_funct3,
  input  [31:0] in_imm,
  input  [31:0] in_rs2_data,
  input  [31:0] in_rs1_data,
  input  [31:0] in_pc,
  input  [4:0]  in_rs1_addr,
  input  [4:0]  in_rs2_addr,
  input         flush,
  input         valid,
  output [4:0]  out_rd_addr,
  output [6:0]  out_funct7,
  output [2:0]  out_funct3,
  output [31:0] out_imm,
  output [31:0] out_rs2_data,
  output [31:0] out_rs1_data,
  output [31:0] out_pc,
  output [4:0]  out_rs1_addr,
  output [4:0]  out_rs2_addr
);
  reg [4:0] reg_rd_addr;
  reg [6:0] reg_funct7;
  reg [2:0] reg_funct3;
  reg [31:0] reg_imm;
  reg [31:0] reg_rs2_data;
  reg [31:0] reg_rs1_data;
  reg [31:0] reg_pc;
  reg [4:0] reg_rs1_addr;
  reg [4:0] reg_rs2_addr;

  assign out_rd_addr = reg_rd_addr;
  assign out_funct7 = reg_funct7;
  assign out_funct3 = reg_funct3;
  assign out_imm = reg_imm;
  assign out_rs2_data = reg_rs2_data;
  assign out_rs1_data = reg_rs1_data;
  assign out_pc = reg_pc;
  assign out_rs1_addr = reg_rs1_addr;
  assign out_rs2_addr = reg_rs2_addr;

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_rd_addr &lt;= 5'h0;
    end else if (flush) begin
      reg_rd_addr &lt;= 5'h0;
    end else if (valid) begin
      reg_rd_addr &lt;= in_rd_addr;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_funct7 &lt;= 7'h0;
    end else if (flush) begin
      reg_funct7 &lt;= 7'h0;
    end else if (valid) begin
      reg_funct7 &lt;= in_funct7;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_funct3 &lt;= 3'h0;
    end else if (flush) begin
      reg_funct3 &lt;= 3'h0;
    end else if (valid) begin
      reg_funct3 &lt;= in_funct3;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_imm &lt;= 32'h0;
    end else if (flush) begin
      reg_imm &lt;= 32'h0;
    end else if (valid) begin
      reg_imm &lt;= in_imm;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_rs2_data &lt;= 32'h0;
    end else if (flush) begin
      reg_rs2_data &lt;= 32'h0;
    end else if (valid) begin
      reg_rs2_data &lt;= in_rs2_data;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_rs1_data &lt;= 32'h0;
    end else if (flush) begin
      reg_rs1_data &lt;= 32'h0;
    end else if (valid) begin
      reg_rs1_data &lt;= in_rs1_data;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_pc &lt;= 32'h0;
    end else if (flush) begin
      reg_pc &lt;= 32'h0;
    end else if (valid) begin
      reg_pc &lt;= in_pc;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_rs1_addr &lt;= 5'h0;
    end else if (flush) begin
      reg_rs1_addr &lt;= 5'h0;
    end else if (valid) begin
      reg_rs1_addr &lt;= in_rs1_addr;
    end
  end

  always @(posedge clk or posedge reset) begin
    if (reset) begin
      reg_rs2_addr &lt;= 5'h0;
    end else if (flush) begin
      reg_rs2_addr &lt;= 5'h0;
    end else if (valid) begin
      reg_rs2_addr &lt;= in_rs2_addr;
    end
  end

endmodule
</code></pre>
<h3 id="æ‰§è¡Œæ§åˆ¶æ¨¡å—"><a class="header" href="#æ‰§è¡Œæ§åˆ¶æ¨¡å—">æ‰§è¡Œæ§åˆ¶æ¨¡å—</a></h3>
<p>åœ¨æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µï¼Œå­˜å‚¨è®¿é—®æŒ‡ä»¤ç”¨ ALU è¿›è¡Œåœ°å€è®¡ç®—ï¼Œæ¡ä»¶åˆ†æ”¯è·³è½¬æŒ‡ä»¤ç”¨ ALU è¿›è¡Œæ¡ä»¶æ¯”è¾ƒï¼Œç®—æœ¯é€»è¾‘æŒ‡ä»¤ç”¨ ALU è¿›è¡Œé€»è¾‘è¿ç®—ã€‚</p>
<pre><code class="language-Verilog">module alu_ctrl (
    input [2:0]  funct3,
    input [6:0]  funct7,
    input [1:0]  aluCtrlOp,
    input        itype,
    output reg [3:0] aluOp
);
    always @(*) begin
      case(aluCtrlOp)
        2'b00:  aluOp &lt;= `ALU_OP_ADD;           // Load or Store
        2'b01:  begin
          if(itype &amp; funct3[1:0] != 2'b01)
            aluOp &lt;= {1'b0, funct3};
          else
            aluOp &lt;= {funct7[5], funct3};   // normal ALUI/ALUR
        end
        2'b10:  begin
         // $display("~~~aluCtrl bxx~~~%d", funct3);
          case(funct3)                    // bxx
            `BEQ_FUNCT3:  aluOp &lt;= `ALU_OP_EQ;
            `BNE_FUNCT3:  aluOp &lt;= `ALU_OP_NEQ;
            `BLT_FUNCT3:  aluOp &lt;= `ALU_OP_SLT;
            `BGE_FUNCT3:  aluOp &lt;= `ALU_OP_GE;
            `BLTU_FUNCT3: aluOp &lt;= `ALU_OP_SLTU;
            `BGEU_FUNCT3: aluOp &lt;= `ALU_OP_GEU;
            default:      aluOp &lt;= `ALU_OP_XXX;
          endcase
          end
        default: aluOp &lt;= `ALU_OP_XXX;
      endcase
    end
endmodule
</code></pre>
<h3 id="é€šç”¨å¯„å­˜å™¨æ¨¡å—"><a class="header" href="#é€šç”¨å¯„å­˜å™¨æ¨¡å—">é€šç”¨å¯„å­˜å™¨æ¨¡å—</a></h3>
<pre><code class="language-Verilog">module gen_regs (
    input  clk,
    input  reset,
    input  wen,
    input  [4:0] regRAddr1, regRAddr2, regWAddr,
    input  [31:0] regWData,
    output [31:0] regRData1,
    output [31:0] regRData2
);
    integer ii;
    reg [31:0] regs[31:0];

    // write registers
    always @(posedge clk or posedge reset) begin
        if(reset) begin
            for(ii=0; ii&lt;32; ii=ii+1)
                regs[ii] &lt;= 32'b0;
        end
        else if(wen &amp; (|regWAddr))
                regs[regWAddr] &lt;= regWData;
    end

    // read registers
    assign regRData1 = wen &amp; (regWAddr == regRAddr1) ? regWData
                    : ((regRAddr1 != 5'b0) ? regs[regRAddr1] : 32'b0);
    assign regRData2 = wen &amp; (regWAddr == regRAddr2) ? regWData
                    : ((regRAddr2 != 5'b0) ? regs[regRAddr2] : 32'b0);

endmodule
</code></pre>
<p>å†™å¯„å­˜å™¨æ˜¯è¾¹æ²¿è§¦å‘çš„ï¼Œåœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å†™å…¥çš„å­˜å‚¨å™¨æ•°æ®ï¼Œéœ€è¦åœ¨å†™ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰èƒ½æŠŠå†™å…¥çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚ä¸ºäº†æé«˜è¯»å†™æ•ˆç‡ï¼Œåœ¨å¯¹åŒä¸€ä¸ªå¯„å­˜å™¨è¿›è¡Œè¯»å†™æ—¶ï¼Œå¦‚æœå†™ä½¿èƒ½ wen æœ‰æ•ˆï¼Œå°±ç›´æ¥æŠŠå†™å…¥å¯„å­˜å™¨çš„æ•°æ®é€ç»™è¯»æ•°æ®æ¥å£ã€‚</p>
<h3 id="alu-æ¨¡å—"><a class="header" href="#alu-æ¨¡å—">ALU æ¨¡å—</a></h3>
<pre><code class="language-Verilog">module alu (
  input  [31:0] alu_data1_i,
  input  [31:0] alu_data2_i,
  input  [ 3:0] alu_op_i,
  output [31:0] alu_result_o
);

  reg  [31:0] result;

  // alu_op_i çš„ç¬¬3ä½å’Œç¬¬1ä½ä¸º1æ—¶ï¼Œåšå‡æ³•è¿ç®—ï¼Œè¿™æ˜¯ä¸ºå‡æ³•æŒ‡ä»¤æˆ–è€…æ¯”è¾ƒå¤§å°è€Œå‡†å¤‡çš„
  wire [31:0] sum    = alu_data1_i + ((alu_op_i[3] | alu_op_i[1]) ? -alu_data2_i : alu_data2_i);
  // æ ¹æ®å‰é¢ä¸¤ä¸ªæ“ä½œæ•°ç›¸å‡çš„ç»“æœåˆ¤æ–­ä¸¤ä¸ªæ“ä½œæ•°æ˜¯å¦ç›¸ç­‰
  wire        neq    = |sum;
  // æ¯”è¾ƒä¸¤ä¸ªæ“ä½œæ•°çš„å¤§å°ï¼š
  // å¦‚æœæ“ä½œæ•°çš„ç¬¦å·ä½ç›¸åŒï¼Œåˆ™æ ¹æ®ä¸¤ä¸ªæ“ä½œæ•°ç›¸å‡çš„å·®å€¼çš„ç¬¦å·ä½å»åˆ¤æ–­
  // å¦‚æœæ“ä½œæ•°çš„ç¬¦å·ä½ä¸åŒï¼Œå…ˆæ ¹æ®alu_op_i çš„æœ€ä½ä½åˆ¤æ–­æ˜¯å¦æ˜¯æ— ç¬¦å·æ•°æ¯”è¾ƒè¿ç®—
  wire        cmp    = (alu_data1_i[31] == alu_data2_i[31]) ? sum[31]
                     : alu_op_i[0] ? alu_data2_i[31] : alu_data1_i[31];
  wire [ 4:0] shamt  = alu_data2_i[4:0];
  // åˆ¤æ–­æ˜¯å·¦ç§»è¿˜æ˜¯å³ç§»ï¼Œå¦‚æœæ˜¯å·¦ç§»ï¼Œå°±å…ˆå¯¹æºæ“ä½œæ•°åšé•œåƒå¤„ç†
  wire [31:0] shin   = alu_op_i[2] ? alu_data1_i : reverse(alu_data1_i);
  // åˆ¤æ–­æ˜¯ç®—æœ¯å³ç§»è¿˜æ˜¯é€»è¾‘å³ç§»ï¼Œå¦‚æœæ˜¯ç®—æœ¯å³ç§»ï¼Œéœ€è¦åœ¨æœ€é«˜ä½è¡¥ä¸€ä¸ªç¬¦å·ä½
  wire [32:0] shift  = {alu_op_i[3] &amp; shin[31], shin};
  // $signed() å‡½æ•°ä¼šåœ¨å³ç§»æ“ä½œå‰å…ˆæŠŠæ“ä½œæ•°çš„ç¬¦å·ä½æ‰©ä½æˆè·Ÿç»“æœç›¸åŒçš„ä½å®½
  wire [32:0] shiftt = ($signed(shift) &gt;&gt;&gt; shamt);
  wire [31:0] shiftr = shiftt[31:0];
  // å·¦ç§»çš„ç»“æœæ˜¯å³ç§»åçš„ç»“æœå†è¿›è¡Œé•œåƒå¤„ç†
  wire [31:0] shiftl = reverse(shiftr);

  always @(*) begin
    case(alu_op_i)
      `ALU_OP_ADD:    result &lt;= sum;
      `ALU_OP_SUB:    result &lt;= sum;
      `ALU_OP_SLL:    result &lt;= shiftl;
      `ALU_OP_SLT:    result &lt;= cmp;
      `ALU_OP_SLTU:   result &lt;= cmp;
      `ALU_OP_XOR:    result &lt;= (alu_data1_i ^ alu_data2_i);
      `ALU_OP_SRL:    result &lt;= shiftr;
      `ALU_OP_SRA:    result &lt;= shiftr;
      `ALU_OP_OR:     result &lt;= (alu_data1_i | alu_data2_i);
      `ALU_OP_AND:    result &lt;= (alu_data1_i &amp; alu_data2_i);

      `ALU_OP_EQ:     result &lt;= {31'b0, ~neq};
      `ALU_OP_NEQ:    result &lt;= {31'b0, neq};
      `ALU_OP_GE:     result &lt;= {31'b0, ~cmp};
      `ALU_OP_GEU:    result &lt;= {31'b0, ~cmp};
      default:        begin
                      result &lt;= 32'b0;
                      //$display("*** alu error ! ***%x", alu_op_i);
        end
    endcase
  end

  function [31:0] reverse;
    input [31:0] in;
    integer i;
    for(i=0; i&lt;32; i=i+1) begin
      reverse[i] = in[31-i];
    end
  endfunction

  assign alu_result_o = result;

endmodule
</code></pre>
<ul>
<li>å·¦ç§»è¿ç®—å¤ç”¨äº†å³ç§»è¿ç®—çš„ç”µè·¯ï¼Œæ–¹ä¾¿å®ç°</li>
</ul>
<h3 id="å®Œæ•´çš„æ•°æ®é€šè·¯"><a class="header" href="#å®Œæ•´çš„æ•°æ®é€šè·¯">å®Œæ•´çš„æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_full_data_path.png" alt="å®Œæ•´çš„æ•°æ®é€šè·¯" /></p>
<ul>
<li>è¯‘ç é˜¶æ®µï¼Œä¼šå°†æŒ‡ä»¤çš„åŠŸèƒ½ç å’Œæ“ä½œç å‘é€ç»™<strong>æ§åˆ¶å™¨</strong>ï¼Œæ¥äº§ç”Ÿç›¸åº”çš„æ§åˆ¶ä¿¡å·</li>
<li>ç«‹å³æ•°æ‰©å±•ä¿¡å·ï¼šImmSel</li>
<li>ALU åŠŸèƒ½é€‰æ‹©ä¿¡å·ï¼šALUSel</li>
</ul>
<h3 id="æ§åˆ¶å™¨çš„è®¾è®¡"><a class="header" href="#æ§åˆ¶å™¨çš„è®¾è®¡">æ§åˆ¶å™¨çš„è®¾è®¡</a></h3>
<p><img src="cs/../images/risc-v/riscv_cpu_controller_truth_table.png" alt="æ§åˆ¶å™¨çš„è®¾è®¡" /></p>
<h3 id="r-å‹æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#r-å‹æŒ‡ä»¤æ•°æ®é€šè·¯">R å‹æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_R_instruction_data_path.png" alt="Rå‹æŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<ul>
<li><code>ALUSel</code> ä¼šæ ¹æ®æŒ‡ä»¤çš„ <code>funct3</code>æ¥å–ä¸åŒçš„å€¼</li>
</ul>
<h3 id="i-å‹æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#i-å‹æŒ‡ä»¤æ•°æ®é€šè·¯">I å‹æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_I_instruction_data_path.png" alt="Iå‹æŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<h3 id="load-æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#load-æŒ‡ä»¤æ•°æ®é€šè·¯">Load æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_load_instruction_data_path.png" alt="LoadæŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<h3 id="store-æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#store-æŒ‡ä»¤æ•°æ®é€šè·¯">Store æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_store_instruction_data_path.png" alt="StoreæŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<ul>
<li>ç«‹å³æ•°æ¥è‡ª<code>inst[31:25][11:7]</code>ï¼Œè¿™ä¸ªå’ŒLoadä¸åŒ</li>
<li>StoreæŒ‡ä»¤æ²¡æœ‰<strong>å†™å›</strong>é˜¶æ®µ</li>
</ul>
<h3 id="b-å‹æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#b-å‹æŒ‡ä»¤æ•°æ®é€šè·¯">B å‹æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_B_instruction_data_path.png" alt="BæŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<ul>
<li>æ— <strong>è®¿å­˜</strong>å’Œ<strong>å†™å›</strong>é˜¶æ®µ</li>
</ul>
<h3 id="jalr-æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#jalr-æŒ‡ä»¤æ•°æ®é€šè·¯">jalr æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_jalr_instruction_data_path.png" alt="jalræŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<ul>
<li>PC+4 çš„å€¼ä¼šä¿å­˜åˆ°<code>rd</code> ä¸­</li>
</ul>
<h3 id="jal-æŒ‡ä»¤æ•°æ®é€šè·¯"><a class="header" href="#jal-æŒ‡ä»¤æ•°æ®é€šè·¯">jal æŒ‡ä»¤æ•°æ®é€šè·¯</a></h3>
<p><img src="cs/../images/risc-v/riscv_jal_instruction_data_path.png" alt="jalæŒ‡ä»¤æ•°æ®é€šè·¯" /></p>
<h2 id="cache"><a class="header" href="#cache">Cache</a></h2>
<p><img src="cs/../images/risc-v/riscv_cache.png" alt="Cache" /></p>
<h3 id="cache-çš„ç»“æ„"><a class="header" href="#cache-çš„ç»“æ„">Cache çš„ç»“æ„</a></h3>
<p><img src="cs/../images/risc-v/riscv_cache_structure.png" alt="Cacheçš„ç»“æ„" /></p>
<ul>
<li>å—ï¼ˆblockï¼‰ï¼šä¸¤çº§å­˜å‚¨å™¨å±‚æ¬¡ç»“æ„ä¸­å­˜å‚¨å™¨ä¿¡æ¯äº¤æ¢çš„æœ€å°å•å…ƒ</li>
<li>å‘½ä¸­ï¼ˆhitï¼‰ï¼šå¦‚æœå¤„ç†å™¨éœ€è¦çš„æ•°æ®å­˜æ”¾åœ¨é«˜å±‚å­˜å‚¨å™¨ä¸­çš„æŸä¸ªå—ä¸­ï¼Œç§°ä¸ºä¸€æ¬¡å‘½ä¸­</li>
<li>ç¼ºå¤±ï¼ˆmissï¼‰ï¼šå¦‚æœåœ¨é«˜å±‚å­˜å‚¨å™¨ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„æ•°æ®ï¼Œè¿™æ¬¡æ•°æ®è¯·æ±‚ç§°ä¸ºä¸€æ¬¡ç¼ºå¤±
<ul>
<li>ç¼ºå¤±ä»£ä»·ï¼ˆmiss penaltyï¼‰ï¼šå°†ç›¸åº”çš„å—ä»åº•å±‚å­˜å‚¨å™¨æ›¿æ¢åˆ°é«˜å±‚å­˜å‚¨å™¨çš„æ—¶é—´+å°†è¯¥ä¿¡æ¯å—ä¼ é€ç»™å¤„ç†å™¨çš„æ—¶é—´</li>
</ul>
</li>
</ul>
<h3 id="cache-ç›´æ¥æ˜ å°„"><a class="header" href="#cache-ç›´æ¥æ˜ å°„">Cache ç›´æ¥æ˜ å°„</a></h3>
<p>ç›´æ¥æ˜ å°„ï¼šä¸€ç§ cache ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªå­˜å‚¨å™¨åœ°å€ä»…ä»…å¯¹åº”åˆ° cache ä¸­çš„ä¸€ä¸ªä½ç½®</p>
<p>æ˜ å°„æ–¹æ³•ï¼šï¼ˆå—åœ°å€ï¼‰modï¼ˆcache ä¸­çš„å—æ•°ï¼‰</p>
<p>æ ‡è®°ï¼šè¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µï¼ŒåŒ…å«äº†åœ°å€ä¿¡æ¯ï¼Œè¿™äº›åœ°å€ä¿¡æ¯å¯ä»¥ç”¨æ¥åˆ¤æ–­cacheä¸­çš„å­—æ˜¯å¦å°±æ˜¯æ‰€è¯·æ±‚çš„å­—</p>
<p>æœ‰æ•ˆä½ï¼šè¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥æ ‡è¯†ä¸€ä¸ªå—æ˜¯å¦åŒ…å«æœ‰ä¸€ä¸ªæœ‰æ•ˆæ•°æ®</p>
<p><img src="cs/../images/risc-v/riscv_cache_direct_mapping.png" alt="Cacheç›´æ¥æ˜ å°„" /></p>
<p><img src="cs/../images/risc-v/riscv_cache_direct_mapping_example.png" alt="Cacheç›´æ¥æ˜ å°„ç¤ºä¾‹" /></p>
<p>ç¼ºç‚¹ï¼šåˆ©ç”¨ç‡ä½ï¼Œå‘½ä¸­ç‡ä½</p>
<h3 id="cache-å…¨ç›¸è”æ˜ å°„"><a class="header" href="#cache-å…¨ç›¸è”æ˜ å°„">Cache å…¨ç›¸è”æ˜ å°„</a></h3>
<p>å…¨ç›¸è”æ˜ å°„ï¼šä¸€ä¸ªå—å¯ä»¥è¢«æ”¾ç½®åœ¨ cache ä¸­çš„ä»»ä½•ä½ç½®</p>
<p><img src="cs/../images/risc-v/riscv_cache_full_association_mapping.png" alt="Cacheå…¨ç›¸è”æ˜ å°„" /></p>
<p><img src="cs/../images/risc-v/riscv_cache_full_association_mapping_example.png" alt="Cacheå…¨ç›¸è”æ˜ å°„ç¤ºä¾‹" /></p>
<p>ç¼ºç‚¹ï¼šç¡¬ä»¶å¼€é”€å¤§ï¼ˆæœ‰å¤šå°‘cacheå—å°±é…æœ‰ç›¸ç­‰æ•°é‡çš„æ¯”è¾ƒå™¨ï¼‰</p>
<h3 id="cache-ç»„ç›¸è”æ˜ å°„"><a class="header" href="#cache-ç»„ç›¸è”æ˜ å°„">Cache ç»„ç›¸è”æ˜ å°„</a></h3>
<p>åœ¨ç»„ç›¸è”æ˜ å°„ä¸­ï¼Œæ¯ä¸ªå—å¯è¢«æ”¾ç½®çš„ä½ç½®æ•°æ˜¯å›ºå®šçš„ï¼Œæ¯ä¸ªå—æœ‰ n ä¸ªä½ç½®å¯æ”¾çš„ cache è¢«ç§°ä¸º n è·¯ç»„ç›¸è” Cache</p>
<p><img src="cs/../images/risc-v/riscv_set_associative_cache.png" alt="Cacheç»„ç›¸è”æ˜ å°„" /></p>
<p><img src="cs/../images/risc-v/riscv_set_associative_cache_example.png" alt="Cacheç»„ç›¸è”æ˜ å°„ç¤ºä¾‹" /></p>
<p>å››è·¯ç»„ç›¸è” Cacheï¼š</p>
<ul>
<li>4 ä¸ªæ¯”è¾ƒå™¨</li>
<li>1 ä¸ªå››é€‰ä¸€å¤šè·¯é€‰æ‹©å™¨</li>
</ul>
<h3 id="cache-çš„è®¾è®¡"><a class="header" href="#cache-çš„è®¾è®¡">Cache çš„è®¾è®¡</a></h3>
<ul>
<li>è¦è€ƒè™‘çš„ç»´åº¦
<ul>
<li>Cache çš„å®¹é‡</li>
<li>å—å¤§å°</li>
<li>ç»„ç»‡æ–¹å¼ï¼ˆDirectï¼ŒFully Associativeï¼ŒSet Associativeï¼‰</li>
<li>æ›¿æ¢ç®—æ³•ï¼ˆFIFOï¼ŒLRUï¼‰</li>
<li>å†™ç­–ç•¥ï¼ˆwrite-through, write-backï¼‰</li>
</ul>
</li>
</ul>
<h2 id="è™šæ‹Ÿåœ°å€"><a class="header" href="#è™šæ‹Ÿåœ°å€">è™šæ‹Ÿåœ°å€</a></h2>
<p><img src="cs/../images/risc-v/riscv_mmu.png" alt="è™šæ‹Ÿå­˜å‚¨å™¨ç®¡ç†" /></p>
<h3 id="åˆ†æ®µç®¡ç†"><a class="header" href="#åˆ†æ®µç®¡ç†">åˆ†æ®µç®¡ç†</a></h3>
<p><img src="cs/../images/risc-v/riscv_mmu_segment_manage.png" alt="åˆ†æ®µç®¡ç†" /></p>
<p>åˆ†æ®µç®¡ç†ï¼šå°†ä¸€ä¸ªç¨‹åºæŒ‰ç…§é€»è¾‘å•å…ƒåˆ†æˆå¤šä¸ªç¨‹åºæ®µï¼Œæ¯ä¸€ä¸ªæ®µä½¿ç”¨è‡ªå·±å•ç‹¬çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p>
<ul>
<li>é€»è¾‘ä¸Šç›¸äº’ç‹¬ç«‹</li>
<li>å®¹æ˜“å®ç°å…±äº«å’Œä¿æŠ¤</li>
<li>éå¸¸å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼ˆæ®µé•¿æ˜¯ä¸ç¡®å®šçš„ï¼‰</li>
</ul>
<h3 id="åˆ†é¡µç®¡ç†"><a class="header" href="#åˆ†é¡µç®¡ç†">åˆ†é¡µç®¡ç†</a></h3>
<p><img src="cs/../images/risc-v/riscv_mmu_page_manage.png" alt="åˆ†é¡µç®¡ç†" /></p>
<ul>
<li>å¦‚æœé¡µè¡¨é¡¹ä¸º4å­—èŠ‚ï¼Œé‚£ä¹ˆæ•´å¼ é¡µè¡¨ä¼šå æ®4MBå¤§å°çš„å†…å­˜ç©ºé—´</li>
</ul>
<h3 id="ä¸¤çº§åˆ†é¡µç®¡ç†"><a class="header" href="#ä¸¤çº§åˆ†é¡µç®¡ç†">ä¸¤çº§åˆ†é¡µç®¡ç†</a></h3>
<p><img src="cs/../images/risc-v/riscv_mmu_two_level_page_manage.png" alt="ä¸¤çº§åˆ†é¡µç®¡ç†" /></p>
<ul>
<li>4KBçš„é¡µç›®å½•+4KBçš„é¡µè¡¨</li>
</ul>
<h3 id="å¿«é€Ÿåœ°å€è½¬æ¢-tlb"><a class="header" href="#å¿«é€Ÿåœ°å€è½¬æ¢-tlb">å¿«é€Ÿåœ°å€è½¬æ¢ TLB</a></h3>
<p><img src="cs/../images/risc-v/riscv_tlb.png" alt="å—è¡¨" /></p>
<p>å—è¡¨ï¼ˆTranslation-Lookaside Bufferï¼‰ï¼šç”¨äºè®°å½•æœ€è¿‘ä½¿ç”¨åœ°å€çš„æ˜ å°„ä¿¡æ¯çš„é«˜é€Ÿç¼“å­˜ï¼Œä»è€Œå¯ä»¥é¿å…æ¯æ¬¡éƒ½è¦è®¿é—®é¡µè¡¨</p>
<h3 id="ä½¿ç”¨-tlb-è¿›è¡Œåœ°å€è½¬æ¢"><a class="header" href="#ä½¿ç”¨-tlb-è¿›è¡Œåœ°å€è½¬æ¢">ä½¿ç”¨ TLB è¿›è¡Œåœ°å€è½¬æ¢</a></h3>
<p><img src="cs/../images/risc-v/riscv_tlb_location.png" alt="TLBçš„ä½ç½®" /></p>
<p><img src="cs/../images/risc-v/riscv_tlb_translation.png" alt="TLBå®ç°åœ°å€è½¬æ¢çš„åŸç†" /></p>
<p><img src="cs/../images/risc-v/riscv_vma_pma_translation.png" alt="TLBè™šå®åœ°å€è½¬æ¢" /></p>
<h2 id="ç‰¹æƒçº§åˆ«"><a class="header" href="#ç‰¹æƒçº§åˆ«">ç‰¹æƒçº§åˆ«</a></h2>
<p>ä¸€ä¸ª RISC-V çš„ç¡¬ä»¶çº¿ç¨‹åœ¨ä»»ä¸€æ—¶åˆ»åªèƒ½è¿è¡Œåœ¨æŸä¸€ä¸ªç‰¹æƒçº§ä¸Šï¼Œè¿™ä¸ªç‰¹æƒçº§ç”± CSR æŒ‡å®šå’Œé…ç½®ã€‚</p>
<div class="table-wrapper"><table><thead><tr><th>åç§°</th><th>çº§åˆ«</th><th>ç¼©å†™</th><th>ç¼–ç </th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>ç”¨æˆ·åº”ç”¨ç¨‹åºç‰¹æƒçº§</td><td>0</td><td>U</td><td>00</td><td>è¿è¡Œåº”ç”¨ç¨‹åºï¼ŒåŒæ ·ä¹Ÿé€‚ç”¨äºåµŒå…¥å¼ç³»ç»Ÿ</td></tr>
<tr><td>ç®¡ç†å‘˜ç‰¹æƒçº§</td><td>1</td><td>S</td><td>01</td><td>ä¸»è¦ç”¨äºæ”¯æŒç°ä»£æ“ä½œç³»ç»Ÿï¼Œå¦‚Linux</td></tr>
<tr><td>è™šæ‹Ÿæœºç›‘è§†ç‰¹æƒçº§</td><td>2</td><td>H</td><td>10</td><td>æ”¯æŒè™šæ‹Ÿæœºç›‘è§†å™¨</td></tr>
<tr><td>æœºå™¨ç‰¹æƒçº§</td><td>3</td><td>M</td><td>11</td><td>å¯¹å†…å­˜ã€I/Oå’Œä¸€äº›å¿…è¦çš„åº•å±‚åŠŸèƒ½ï¼ˆå¯åŠ¨å’Œç³»ç»Ÿé…ç½®ï¼‰æœ‰ç€å®Œå…¨çš„æ§åˆ¶æƒ</td></tr>
</tbody></table>
</div>
<h3 id="æ ‡å‡†å¯„å­˜å™¨åˆ—è¡¨"><a class="header" href="#æ ‡å‡†å¯„å­˜å™¨åˆ—è¡¨">æ ‡å‡†å¯„å­˜å™¨åˆ—è¡¨</a></h3>
<h4 id="machine-mode"><a class="header" href="#machine-mode">Machine Mode</a></h4>
<div class="table-wrapper"><table><thead><tr><th>åç§°</th><th>åœ°å€</th><th>å±æ€§</th><th>å¤‡æ³¨</th></tr></thead><tbody>
<tr><td>mvendorid</td><td>0xF11</td><td>RO</td><td>å•†ä¸šä¾›åº”å•†ç¼–å·å¯„å­˜å™¨</td></tr>
<tr><td>marchid</td><td>0xF12</td><td>RO</td><td>æ¶æ„ç¼–å·å¯„å­˜å™¨</td></tr>
<tr><td>mimpid</td><td>0xF13</td><td>RO</td><td>ç¡¬ä»¶å®ç°ç¼–å·å¯„å­˜å™¨</td></tr>
<tr><td>mhartid</td><td>0xF14</td><td>RO</td><td>Hartç¼–å·å¯„å­˜å™¨ (Hart: Hardware Thread)</td></tr>
<tr><td>mstatus</td><td>0x300</td><td>RW</td><td>å¼‚å¸¸å¤„ç†çŠ¶æ€å¯„å­˜å™¨</td></tr>
<tr><td>misa</td><td>0x301</td><td>RO</td><td>æŒ‡ä»¤é›†æ¶æ„å¯„å­˜å™¨</td></tr>
<tr><td>mie</td><td>0x304</td><td>RW</td><td>å±€éƒ¨ä¸­æ–­å±è”½æ§åˆ¶å¯„å­˜å™¨</td></tr>
<tr><td>mtvec</td><td>0x305</td><td>RW</td><td>å¼‚å¸¸å…¥å£åŸºåœ°å€å¯„å­˜å™¨</td></tr>
<tr><td>mtvt</td><td>0x307</td><td>RW</td><td>ä¸­æ–­å‘é‡è¡¨çš„åŸºåœ°å€ï¼Œè‡³å°‘ä¸º <strong>64byte</strong> å¯¹é½</td></tr>
<tr><td>mscratch</td><td>0x340</td><td>RW</td><td>æš‚å­˜å¯„å­˜å™¨ï¼Œæ¯”å¦‚è¿›å…¥å¼‚å¸¸å¤„ç†æ¨¡å¼åï¼Œå°†åº”ç”¨ç¨‹åºçš„ç”¨æˆ·çš„ sp å¯„å­˜å™¨ä¸´æ—¶ä¿å­˜åˆ°è¿™ä¸ªå¯„å­˜å™¨ä¸­</td></tr>
<tr><td>mepc</td><td>0x341</td><td>RW</td><td>å¼‚å¸¸PCå¯„å­˜å™¨</td></tr>
<tr><td>mcause</td><td>0x342</td><td>RW</td><td>å¼‚å¸¸åŸå› å¯„å­˜å™¨</td></tr>
<tr><td>mtval</td><td>0x343</td><td>RW</td><td>å¼‚å¸¸å€¼å¯„å­˜å™¨ï¼Œä¿å­˜è¿›å…¥å¼‚å¸¸ä¹‹å‰å‡ºé”™æŒ‡ä»¤çš„ç¼–ç å€¼æˆ–è€…å­˜å‚¨å™¨è®¿é—®çš„åœ°å€å€¼</td></tr>
<tr><td>mip</td><td>0x344</td><td>RW</td><td>ä¸­æ–­ç­‰å¾…å¯„å­˜å™¨</td></tr>
<tr><td>mnxti</td><td>0x345</td><td>RW</td><td>è¯»æ“ä½œè¿”å›å€¼æ˜¯ä¸‹ä¸€ä¸ªä¸­æ–­çš„handleråœ°å€ï¼Œå†™å›æ“ä½œä¼šæ›´æ–°ä¸­æ–­ä½¿èƒ½çš„çŠ¶æ€</td></tr>
<tr><td>mintstatus</td><td>0x346</td><td>RO</td><td>ç”¨äºä¿å­˜å½“å‰ä¸­æ–­ Level</td></tr>
<tr><td>mscratchcsw</td><td>0x348</td><td>RW</td><td>ç”¨äºåœ¨ç‰¹æƒæ¨¡å¼å˜åŒ–æ—¶äº¤æ¢mscratchä¸ç›®çš„å¯„å­˜å™¨çš„å€¼</td></tr>
<tr><td>mscratchcswl</td><td>0x349</td><td>RW</td><td>ç”¨äºåœ¨ä¸­æ–­Levelå˜åŒ–æ—¶äº¤æ¢mscratchä¸ç›®çš„å¯„å­˜å™¨çš„å€¼</td></tr>
<tr><td>mcycle</td><td>0xB00</td><td>RW</td><td>å‘¨æœŸè®¡æ•°å™¨çš„ä½32ä½</td></tr>
<tr><td>mcycleh</td><td>0xB80</td><td>RW</td><td>å‘¨æœŸè®¡æ•°å™¨çš„é«˜32ä½</td></tr>
<tr><td>minstret</td><td>0xB02</td><td>RW</td><td>å®ŒæˆæŒ‡ä»¤è®¡æ•°å™¨çš„ä½32ä½ï¼Œè¯¥å¯„å­˜å™¨ç”¨äºè¡¡é‡å¤„ç†å™¨çš„æ€§èƒ½</td></tr>
<tr><td>minstrech</td><td>0xB82</td><td>RW</td><td>å®ŒæˆæŒ‡ä»¤è®¡æ•°å™¨çš„é«˜32ä½</td></tr>
</tbody></table>
</div>
<h4 id="user-mode"><a class="header" href="#user-mode">User Mode</a></h4>
<div class="table-wrapper"><table><thead><tr><th>åç§°</th><th>åœ°å€</th><th>å±æ€§</th><th>å¤‡æ³¨</th></tr></thead><tbody>
<tr><td>cycle</td><td>0xC00</td><td>RO</td><td>mcycleå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
<tr><td>time</td><td>0xC01</td><td>RO</td><td>mtimeå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
<tr><td>instret</td><td>0xC02</td><td>RO</td><td>minstretå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
<tr><td>cycleh</td><td>0xC80</td><td>RO</td><td>mcyclehå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
<tr><td>timeh</td><td>0xC81</td><td>RO</td><td>mtimehå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
<tr><td>instreth</td><td>0xC82</td><td>RO</td><td>minstrethå¯„å­˜å™¨çš„åªè¯»å‰¯æœ¬</td></tr>
</tbody></table>
</div>
<h2 id="risc-v-çš„ä¸­æ–­"><a class="header" href="#risc-v-çš„ä¸­æ–­">RISC-V çš„ä¸­æ–­</a></h2>
<p><img src="cs/../images/risc-v/riscv_interrupt_enter.png" alt="è¿›å…¥ä¸­æ–­" /></p>
<p><img src="cs/../images/risc-v/riscv_interrupt_exit.png" alt="é€€å‡ºä¸­æ–­" /></p>
<h3 id="ä¸­æ–­å’Œå¼‚å¸¸ç›¸å…³çš„å¯„å­˜å™¨"><a class="header" href="#ä¸­æ–­å’Œå¼‚å¸¸ç›¸å…³çš„å¯„å­˜å™¨">ä¸­æ–­å’Œå¼‚å¸¸ç›¸å…³çš„å¯„å­˜å™¨</a></h3>
<p><img src="cs/../images/risc-v/riscv_exception_csr_registers.png" alt="å¼‚å¸¸ç›¸å…³çš„CSRå¯„å­˜å™¨" /></p>
<p><img src="cs/../images/risc-v/riscv_exception_csr_register_definitions.png" alt="å¼‚å¸¸ç›¸å…³çš„CSRå¯„å­˜å™¨å…·ä½“å®šä¹‰" /></p>
<h3 id="mstatus"><a class="header" href="#mstatus">mstatus</a></h3>
<ul>
<li>MIEï¼šä¸º1è¡¨ç¤ºä¸­æ–­çš„å…¨å±€å¼€å…³æ‰“å¼€ï¼Œä¸­æ–­èƒ½å¤Ÿè¢«æ­£å¸¸å“åº”</li>
<li>FSï¼šç»´æŠ¤æµ®ç‚¹å•å…ƒçš„çŠ¶æ€ã€‚ä¸Šç”µé»˜è®¤ä¸º0,è¡¨ç¤ºOffï¼Œä¸ºäº†èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨æµ®ç‚¹å•å…ƒï¼Œè½¯ä»¶éœ€è¦ä½¿ç”¨ CSR å†™æŒ‡ä»¤å°† FS çš„å€¼æ”¹å†™ä¸ºé 0 å€¼ä»¥æ‰“å¼€æµ®ç‚¹å•å…ƒçš„åŠŸèƒ½ã€‚æ“ä½œç³»ç»Ÿåœ¨è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡è¯¥å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹æµ®ç‚¹å•å…ƒè¿›è¡Œä¸Šä¸‹æ–‡çš„ä¿å­˜</li>
<li>XSï¼šç»´æŠ¤ç”¨æˆ·è‡ªå®šä¹‰çš„æ‰©å±•æŒ‡ä»¤å•å…ƒçŠ¶æ€ï¼Œç±»ä¼¼ä¸ FS</li>
</ul>
<h3 id="mtvec"><a class="header" href="#mtvec">mtvec</a></h3>
<p><img src="cs/../images/risc-v/riscv_exception_mtvec_register.png" alt="mtvecå¯„å­˜å™¨" /></p>
<h3 id="å¼‚å¸¸ä»£ç "><a class="header" href="#å¼‚å¸¸ä»£ç ">å¼‚å¸¸ä»£ç </a></h3>
<p><img src="cs/../images/risc-v/riscv_machine_exception_codes.png" alt="å¼‚å¸¸ä»£ç " /></p>
<h3 id="ä¸­æ–­è¿”å›"><a class="header" href="#ä¸­æ–­è¿”å›">ä¸­æ–­è¿”å›</a></h3>
<p><img src="cs/../images/risc-v/riscv_exception_return.png" alt="ä¸­æ–­è¿”å›" /></p>
<h3 id="ä¸­æ–­å±è”½ä¸ä¸­æ–­ç­‰å¾…"><a class="header" href="#ä¸­æ–­å±è”½ä¸ä¸­æ–­ç­‰å¾…">ä¸­æ–­å±è”½ä¸ä¸­æ–­ç­‰å¾…</a></h3>
<p><img src="cs/../images/risc-v/riscv_interrupt_enable_pending.png" alt="ä¸­æ–­å±è”½å’Œç­‰å¾…ç›¸å…³é¢å¯„å­˜å™¨" /></p>
<h3 id="ä¸­æ–­ä¼˜å…ˆçº§"><a class="header" href="#ä¸­æ–­ä¼˜å…ˆçº§">ä¸­æ–­ä¼˜å…ˆçº§</a></h3>
<p><img src="cs/../images/risc-v/riscv_interrupt_priority.png" alt="ä¸­æ–­ä¼˜å…ˆçº§" /></p>
<h3 id="å•æŒ‡ä»¤æ•°æ®é€šè·¯çš„ä¸­æ–­å“åº”ä¸é€€å‡º"><a class="header" href="#å•æŒ‡ä»¤æ•°æ®é€šè·¯çš„ä¸­æ–­å“åº”ä¸é€€å‡º">å•æŒ‡ä»¤æ•°æ®é€šè·¯çš„ä¸­æ–­å“åº”ä¸é€€å‡º</a></h3>
<p><img src="cs/../images/risc-v/riscv_one_cycle_intruction_interrupt_enter.png" alt="ä¸­æ–­å“åº”" /></p>
<p><img src="cs/../images/risc-v/riscv_one_cycle_intruction_interrupt_exit.png" alt="ä¸­æ–­é€€å‡º" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gcc-å·¥å…·é“¾åŸºç¡€"><a class="header" href="#gcc-å·¥å…·é“¾åŸºç¡€">GCC å·¥å…·é“¾åŸºç¡€</a></h1>
<p>GCC å®è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç¨‹åºï¼Œè€Œæ˜¯å¤šä¸ªç¨‹åºçš„é›†åˆï¼Œå› æ­¤é€šå¸¸ç§°ä¸º GCC å·¥å…·é“¾ã€‚å·¥å…·é“¾è½¯ä»¶åŒ…æ‹¬ GCCã€C è¿è¡Œåº“ã€Binutils å’Œ GDB ç­‰ç­‰ã€‚</p>
<ul>
<li>GCCï¼ˆGNU C Compilerï¼‰æ˜¯ç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥å°† C/C++ è¯­è¨€ç¼–å†™çš„ç¨‹åºè½¬æ¢æˆä¸ºå¤„ç†å™¨èƒ½å¤Ÿæ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç ã€‚</li>
<li>GDBï¼ˆGNU Project Debuggerï¼‰æ˜¯è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥ç”¨äºå¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•ã€‚</li>
</ul>
<h2 id="binutils"><a class="header" href="#binutils">Binutils</a></h2>
<p>è¿™æ˜¯ä¸€ç»„äºŒè¿›åˆ¶ç¨‹åºçš„å¤„ç†å·¥å…·ï¼ŒåŒ…æ‹¬ï¼š<code>addr2line</code>ã€<code>ar</code>ã€<code>objcopy</code>ã€<code>objdump</code>ã€<code>as</code>ã€<code>ld</code>ã€<code>ldd</code>ã€<code>readelf</code>ã€<code>size</code>ç­‰ã€‚</p>
<ul>
<li>addr2lineï¼šç”¨æ¥å°†ç¨‹åºåœ°å€è½¬æ¢æˆå…¶æ‰€å¯¹åº”çš„ç¨‹åºæºæ–‡ä»¶åŠæ‰€å¯¹åº”çš„ä»£ç è¡Œï¼Œä¹Ÿå¯ä»¥å¾—åˆ°æ‰€å¯¹åº”çš„å‡½æ•°ã€‚è¯¥å·¥å…·å°†å¸®åŠ©è°ƒè¯•å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­å®šä½å¯¹åº”çš„æºä»£ç ä½ç½®ã€‚</li>
<li>asï¼šä¸»è¦ç”¨äºæ±‡ç¼–ã€‚</li>
<li>ldï¼šä¸»è¦ç”¨äºé“¾æ¥ã€‚</li>
<li>arï¼šä¸»è¦ç”¨äºåˆ›å»º<strong>é™æ€åº“</strong>ã€‚
<ul>
<li>å¦‚æœè¦å°†å¤šä¸ª <code>.o</code> ç›®æ ‡æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªåº“æ–‡ä»¶ï¼Œåˆ™å­˜åœ¨ä¸¤ç§ç±»å‹çš„åº“ï¼Œä¸€ç§æ˜¯é™æ€åº“ï¼Œå¦ä¸€ç§æ˜¯åŠ¨æ€åº“ã€‚</li>
<li>åœ¨ Windows ä¸­é™æ€åº“æ˜¯ä»¥ <code>.lib</code> ä¸ºåç¼€çš„æ–‡ä»¶ï¼Œå…±äº«åº“æ˜¯ä»¥ <code>.dll</code> ä¸ºåç¼€çš„æ–‡ä»¶ã€‚åœ¨ Linux ä¸­é™æ€åº“æ˜¯ä»¥ <code>.a</code> ä¸ºåç¼€çš„æ–‡ä»¶ï¼Œå…±äº«åº“æ˜¯ä»¥ <code>.so</code> ä¸ºåç¼€çš„æ–‡ä»¶ã€‚</li>
<li>é™æ€åº“å’ŒåŠ¨æ€åº“çš„ä¸åŒç‚¹åœ¨äºä»£ç è¢«è½½å…¥çš„æ—¶åˆ»ä¸åŒã€‚é™æ€åº“çš„ä»£ç åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å·²ç»è¢«è½½å…¥å¯æ‰§è¡Œç¨‹åºï¼Œå› æ­¤ä½“ç§¯è¾ƒå¤§ã€‚å…±äº«åº“çš„ä»£ç æ˜¯åœ¨å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ—¶æ‰è½½å…¥å†…å­˜çš„ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä»…ç®€å•çš„å¼•ç”¨ï¼Œå› æ­¤ä»£ç ä½“ç§¯è¾ƒå°ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç”¨ <code>ldd</code> å‘½ä»¤æŸ¥çœ‹ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºä¾èµ–çš„å…±äº«åº“ã€‚</li>
<li>å¦‚æœä¸€ä¸ªç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªéœ€è¦åŒæ—¶è¿è¡Œçš„ç¨‹åºä¸”è¿™äº›ç¨‹åºä¹‹é—´å­˜åœ¨å…±äº«åº“ï¼Œé‚£ä¹ˆé‡‡ç”¨åŠ¨æ€åº“çš„å½¢å¼å°†æ›´èŠ‚çœå†…å­˜ã€‚ä½†æ˜¯å¯¹äºåµŒå…¥å¼ç³»ç»Ÿï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯æ•´ä¸ªè½¯ä»¶å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºä¸”ä¸æ”¯æŒåŠ¨æ€åŠ è½½çš„æ–¹å¼ï¼Œå³ä»¥é™æ€åº“ä¸ºä¸»ã€‚</li>
</ul>
</li>
<li>lddï¼šå¯ä»¥ç”¨äºæŸ¥çœ‹ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºä¾èµ–çš„<strong>å…±äº«åº“</strong>ã€‚</li>
<li>objcopyï¼šå°†ä¸€ç§å¯¹è±¡æ–‡ä»¶ç¿»è¯‘æˆå¦ä¸€ç§æ ¼å¼ï¼Œæ¯”å¦‚å°†<code>.bin</code> è½¬æ¢æˆ <code>.elf</code>ã€æˆ–è€…å°† <code>.elf</code> è½¬æ¢æˆ <code>.bin</code> ç­‰ã€‚</li>
<li>objdumpï¼šä¸»è¦çš„ä½œç”¨æ˜¯åæ±‡ç¼–ã€‚</li>
<li>readelfï¼šæ˜¾ç¤ºæœ‰å…³ <code>ELF</code> æ–‡ä»¶çš„ä¿¡æ¯ã€‚</li>
<li>sizeï¼šåˆ—å‡ºå¯æ‰§è¡Œæ–‡ä»¶æ¯ä¸ªéƒ¨åˆ†çš„å°ºå¯¸å’Œæ€»å°ºå¯¸ï¼Œä»£ç æ®µã€æ•°æ®æ®µã€æ€»å¤§å°ç­‰ã€‚</li>
</ul>
<h2 id="c-è¿è¡Œåº“"><a class="header" href="#c-è¿è¡Œåº“">C è¿è¡Œåº“</a></h2>
<p>Cè¯­è¨€æ ‡å‡†ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€éƒ¨åˆ†æè¿° C çš„è¯­æ³•ï¼Œå¦ä¸€éƒ¨åˆ†æè¿° C æ ‡å‡†åº“ã€‚C æ ‡å‡†åº“å®šä¹‰äº†ä¸€ç»„æ ‡å‡†å¤´æ–‡ä»¶ï¼Œæ¯ä¸ªå¤´æ–‡ä»¶ä¸­åŒ…å«ä¸€äº›ç›¸å…³çš„å‡½æ•°ã€å˜é‡ã€ç±»å‹å£°æ˜å’Œå®å®šä¹‰ï¼Œæ¯”å¦‚å¸¸è§çš„ printf å‡½æ•°ä¾¿æ˜¯ä¸€ä¸ª C æ ‡å‡†åº“å‡½æ•°ï¼Œå…¶åŸå‹å®šä¹‰åœ¨ stdio å¤´æ–‡ä»¶ä¸­ã€‚</p>
<div id="admonition-default" class="admonition admonish-note">
<div>
<p>C è¯­è¨€æ ‡å‡†ä»…ä»…å®šä¹‰äº† C æ ‡å‡†åº“å‡½æ•°åŸå‹ï¼Œå¹¶æ²¡æœ‰æä¾›å®ç°ã€‚å› æ­¤ï¼ŒC ç¼–è¯‘å™¨éœ€è¦ä¸€ä¸ª C è¿è¡Œæ—¶åº“(C Run Time  Libray,CRT)çš„æ”¯æŒã€‚</p>
</div>
</div>
<p>glibc (GNU C Library) æ˜¯ Linux ä¸‹çš„ C æ ‡å‡†åº“çš„å®ç°ï¼š</p>
<ul>
<li>
<p>glibc æœ¬èº«æ˜¯ GNU æ——ä¸‹çš„ C æ ‡å‡†åº“ï¼Œåæ¥é€æ¸æˆä¸ºäº† Linux çš„æ ‡å‡† C åº“ã€‚glibc çš„ä¸»ä½“åˆ†å¸ƒåœ¨ Linux ç³»ç»Ÿçš„ /lib ä¸ /usr/lib ç›®å½•ä¸­ï¼ŒåŒ…æ‹¬ libc æ ‡å‡† C å‡½æ•°åº“ã€libm æ•°å­¦å‡½å¼åº“ç­‰ï¼Œéƒ½ä»¥ <code>.so</code> ç»“å°¾ã€‚</p>
<div id="admonition-default-1" class="admonition admonish-warning">
<div>
<p>Linux ç³»ç»Ÿä¸‹çš„æ ‡å‡† C åº“ä¸åªæœ‰ glibcï¼Œè¿˜å­˜åœ¨ uclibcã€klibcã€musl ç­‰ç­‰ï¼Œä½†æ˜¯ glibc ä½¿ç”¨æœ€ä¸ºå¹¿æ³›ã€‚</p>
<p>åµŒå…¥å¼ç³»ç»Ÿä¸­ä½¿ç”¨è¾ƒå¤šçš„ C è¿è¡Œåº“æ˜¯ <code>newlib</code>ã€‚</p>
</div>
</div>
</li>
<li>
<p>Linux ç³»ç»Ÿé€šå¸¸å°† libc åº“ä½œä¸ºæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè¢«è§†ä¸ºæ“ä½œç³»ç»Ÿä¸ç”¨æˆ·ç¨‹åºçš„æ¥å£ã€‚æ¯”å¦‚ï¼šglibc ä¸ä»…å®ç°æ ‡å‡† C è¯­è¨€ä¸­çš„å‡½æ•°ï¼Œè¿˜å°è£…äº†æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<ul>
<li>é€šå¸¸æƒ…å†µï¼Œæ¯ä¸ªç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨å¯¹åº”äº†è‡³å°‘ä¸€ä¸ª glibc å°è£…çš„åº“å‡½æ•°ï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨ <code>sys_open</code> å¯¹åº”çš„æ˜¯glibc ä¸­çš„ <code>open</code> å‡½æ•°ï¼›å…¶æ¬¡ï¼Œglibc ä¸€ä¸ªå•ç‹¬çš„ API å¯èƒ½ä¼šè°ƒç”¨å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚ <code>printf</code>  å‡½æ•°ä¼šè°ƒç”¨å¦‚  <code>sys_open</code>ã€<code>sys_mmap</code>ã€<code>sys_write</code>ã€<code>sys_close</code> ç­‰ç³»ç»Ÿè°ƒç”¨ï¼›å¦å¤–ï¼Œå¤šä¸ª glibc  API ä¹Ÿå¯èƒ½å¯¹åº”åŒä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ glibc ä¸‹å®ç°çš„ <code>malloc</code>ã€<code>free</code> ç­‰å‡½æ•°ç”¨æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼Œéƒ½æ˜¯åŸºäºå†…æ ¸çš„<code>sys_brk</code> çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
</ul>
</li>
<li>
<p>å¯¹äº C++ è¯­è¨€ï¼Œå¸¸ç”¨çš„ C++ æ ‡å‡†åº“ä¸º <code>libstdc++</code>ã€‚é€šå¸¸ <code>libstdc++</code> ä¸ GCC æ†ç»‘åœ¨ä¸€èµ·çš„ï¼Œå³å®‰è£… gcc çš„æ—¶å€™ä¼šæŠŠ libstdc++ è£…ä¸Šã€‚è€Œ glibc å¹¶æ²¡æœ‰å’Œ GCC æ†ç»‘äºä¸€èµ·ï¼Œè¿™æ˜¯å› ä¸º glibc éœ€è¦ä¸æ“ä½œç³»ç»Ÿå†…æ ¸æ‰“äº¤é“ï¼Œå› æ­¤å…¶ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿå¹³å°ç´§å¯†è€¦åˆã€‚è€Œ libstdc++ è™½ç„¶æä¾›äº† c++ ç¨‹åºçš„æ ‡å‡†åº“ï¼Œä½†å…¶å¹¶ä¸ä¸å†…æ ¸æ‰“äº¤é“ã€‚å¯¹äºç³»ç»Ÿçº§åˆ«çš„äº‹ä»¶ï¼Œlibstdc++ ä¼šä¸ glibc äº¤äº’ï¼Œä»è€Œå’Œå†…æ ¸é€šä¿¡ã€‚</p>
</li>
</ul>
<h2 id="ç¼–è¯‘è¿‡ç¨‹"><a class="header" href="#ç¼–è¯‘è¿‡ç¨‹">ç¼–è¯‘è¿‡ç¨‹</a></h2>
<h3 id="å‡†å¤‡-hello-world-ç¨‹åº"><a class="header" href="#å‡†å¤‡-hello-world-ç¨‹åº">å‡†å¤‡ Hello World ç¨‹åº</a></h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
int main(void)
{
  printf("Hello World! \n");
  return 0;
}
</code></pre>
<h3 id="é¢„å¤„ç†"><a class="header" href="#é¢„å¤„ç†">é¢„å¤„ç†</a></h3>
<p>é¢„å¤„ç†çš„è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>å°†æ‰€æœ‰çš„ <code>#define</code> åˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰ï¼Œå¹¶ä¸”å¤„ç†æ‰€æœ‰çš„æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œæ¯”å¦‚ <code>#if</code> <code>#ifdef</code> <code>#elif</code> <code>#else</code> <code>#endif</code> ç­‰ã€‚</li>
<li>å¤„ç† <code>#include</code> é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥é¢„ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ã€‚</li>
<li>åˆ é™¤æ‰€æœ‰æ³¨é‡Š <code>//</code> å’Œ <code>/**/</code>ã€‚</li>
<li>æ·»åŠ è¡Œå·å’Œæ–‡ä»¶æ ‡è¯†ï¼Œä»¥ä¾¿ç¼–è¯‘æ—¶äº§ç”Ÿè°ƒè¯•ç”¨çš„è¡Œå·åŠç¼–è¯‘é”™è¯¯è­¦å‘Šè¡Œå·ã€‚</li>
<li>ä¿ç•™æ‰€æœ‰çš„ <code>#pragma</code> ç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œåç»­ç¼–è¯‘è¿‡ç¨‹éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚</li>
</ul>
<p>ä½¿ç”¨ gcc è¿›è¡Œé¢„å¤„ç†çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">gcc -E hello.c -o hello.i  # å°†æºæ–‡ä»¶ hello.c æ–‡ä»¶é¢„å¤„ç†ç”Ÿæˆ hello.i
</code></pre>
<p>hello.i æ–‡ä»¶å¯ä»¥ä½œä¸ºæ™®é€šæ–‡æœ¬æ–‡ä»¶æ‰“å¼€è¿›è¡ŒæŸ¥çœ‹ï¼Œå…¶ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-c">extern void funlockfile (FILE *__stream) __attribute__ ((__nothrow__ , __leaf__));
# 942 "/usr/include/stdio.h" 3 4

# 2 "hello.c" 2


# 3 "hello.c"
int
main(void)
{
  printf("Hello World!" "\n");
  return 0;
}
</code></pre>
<h3 id="ç¼–è¯‘"><a class="header" href="#ç¼–è¯‘">ç¼–è¯‘</a></h3>
<p>ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯å¯¹é¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—çš„è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç ã€‚</p>
<p>ä½¿ç”¨ gcc è¿›è¡Œç¼–è¯‘çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">gcc -S hello.i -o hello.s  # å°†é¢„å¤„ç†ç”Ÿæˆçš„ hello.i æ–‡ä»¶ç¼–è¯‘ç”Ÿæˆæ±‡ç¼–ç¨‹åº hello.s
</code></pre>
<p>ä¸Šè¿°å‘½ä»¤ç”Ÿæˆçš„æ±‡ç¼–ç¨‹åº hello.s çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å…¨éƒ¨ä¸ºæ±‡ç¼–ä»£ç ã€‚</p>
<pre><code class="language-assembly">main:
.LFB0:
    .cfi_startproc
    pushq   %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset 6, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register 6
    movl    $.LC0, %edi
    call    puts
    movl    $0, %eax
    popq    %rbp
    .cfi_def_cfa 7, 8
    ret
    .cfi_endproc
</code></pre>
<h3 id="æ±‡ç¼–"><a class="header" href="#æ±‡ç¼–">æ±‡ç¼–</a></h3>
<p>æ±‡ç¼–è¿‡ç¨‹è°ƒç”¨å¯¹æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆå¤„ç†å™¨èƒ½è¯†åˆ«çš„æŒ‡ä»¤ï¼Œä¿å­˜åœ¨åç¼€ä¸º <code>.o</code> çš„ç›®æ ‡æ–‡ä»¶ä¸­ã€‚ç”±äºæ¯ä¸€ä¸ªæ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡å¤„ç†å™¨æŒ‡ä»¤ï¼Œå› æ­¤ï¼Œæ±‡ç¼–ç›¸å¯¹äºç¼–è¯‘è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡è°ƒç”¨ <code>Binutils</code> ä¸­çš„æ±‡ç¼–å™¨ <code>as</code> æ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œå¤„ç†å™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘å³å¯ã€‚</p>
<p>å½“ç¨‹åºç”±å¤šä¸ªæºä»£ç æ–‡ä»¶æ„æˆæ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½è¦å…ˆå®Œæˆæ±‡ç¼–å·¥ä½œï¼Œç”Ÿæˆ <code>.o</code> ç›®æ ‡æ–‡ä»¶åï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥çš„é“¾æ¥å·¥ä½œã€‚æ³¨æ„ï¼šç›®æ ‡æ–‡ä»¶å·²ç»æ˜¯æœ€ç»ˆç¨‹åºçš„æŸä¸€éƒ¨åˆ†äº†ï¼Œä½†æ˜¯åœ¨é“¾æ¥ä¹‹å‰è¿˜ä¸èƒ½è¿è¡Œã€‚</p>
<p>ä½¿ç”¨ gcc è¿›è¡Œæ±‡ç¼–çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">gcc -c hello.s -o hello.o  # å°†ç¼–è¯‘ç”Ÿæˆçš„ hello.s æ–‡ä»¶æ±‡ç¼–ç”Ÿæˆç›®æ ‡æ–‡ä»¶ hello.o
# æˆ–è€…ç›´æ¥è°ƒç”¨ as è¿›è¡Œæ±‡ç¼–
as -c hello.s -o hello.o  # ä½¿ç”¨ Binutils ä¸­çš„ as å°† hello.s æ–‡ä»¶æ±‡ç¼–ç”Ÿæˆç›®æ ‡æ–‡ä»¶
</code></pre>
<p>:::warning</p>
<p>hello.o ç›®æ ‡æ–‡ä»¶ä¸º <code>ELF(Executable and Linkable Format)</code> æ ¼å¼çš„å¯é‡å®šå‘æ–‡ä»¶ã€‚</p>
<p>:::</p>
<h3 id="é“¾æ¥"><a class="header" href="#é“¾æ¥">é“¾æ¥</a></h3>
<p>ç»è¿‡æ±‡ç¼–ä»¥åçš„ç›®æ ‡æ–‡ä»¶è¿˜ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œä¸ºäº†å˜æˆèƒ½å¤Ÿè¢«åŠ è½½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­å¿…é¡»åŒ…å«å›ºå®šæ ¼å¼çš„ä¿¡æ¯å¤´ï¼Œè¿˜å¿…é¡»ä¸ç³»ç»Ÿæä¾›çš„å¯åŠ¨ä»£ç é“¾æ¥èµ·æ¥æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œè¿™äº›å·¥ä½œéƒ½æ˜¯ç”±é“¾æ¥å™¨æ¥å®Œæˆçš„ã€‚</p>
<p>GCC å¯ä»¥é€šè¿‡è°ƒç”¨ Binutils ä¸­çš„é“¾æ¥å™¨ <code>ld</code> æ¥é“¾æ¥ç¨‹åºè¿è¡Œéœ€è¦çš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ï¼Œä»¥åŠæ‰€ä¾èµ–çš„å…¶å®ƒåº“æ–‡ä»¶ï¼Œæœ€åç”Ÿæˆä¸€ä¸ª <code>ELF</code> æ ¼å¼å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>å¦‚æœç›´æ¥è°ƒç”¨ <code>Binutils</code> ä¸­çš„<code>ld</code> è¿›è¡Œé“¾æ¥ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼Œåˆ™ä¼šæŠ¥å‡ºé”™è¯¯ï¼š</p>
<pre><code class="language-bash"># ç›´æ¥è°ƒç”¨ldè¯•å›¾å°†hello.oæ–‡ä»¶é“¾æ¥æˆä¸ºæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶hello
ld hello.o â€“o hello
ld: warning: cannot find entry symbol _start; defaulting to 00000000004000b0
hello.o: In function `main':
hello.c:(.text+0xa): undefined reference to `puts'
</code></pre>
<p>ä¹‹æ‰€ä»¥ç›´æ¥ç”¨ <code>ld</code> è¿›è¡Œé“¾æ¥ä¼šæŠ¥é”™æ˜¯å› ä¸ºä»…ä»…ä¾é ä¸€ä¸ª <code>hello.o</code> ç›®æ ‡æ–‡ä»¶è¿˜æ— æ³•é“¾æ¥æˆä¸ºä¸€ä¸ªå®Œæ•´çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéœ€è¦æ˜ç¡®çš„æŒ‡æ˜å…¶éœ€è¦çš„å„ç§ä¾èµ–åº“å’Œå¼•å¯¼ç¨‹åºä»¥åŠé“¾æ¥è„šæœ¬ï¼Œæ­¤è¿‡ç¨‹åœ¨åµŒå…¥å¼è½¯ä»¶å¼€å‘æ—¶æ˜¯å¿…ä¸å¯å°‘çš„ã€‚è€Œåœ¨ <code>Linux</code> ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>gcc</code> å‘½ä»¤æ‰§è¡Œç¼–è¯‘ç›´è‡³é“¾æ¥çš„è¿‡ç¨‹ï¼Œgcc ä¼šè‡ªåŠ¨å°†æ‰€éœ€çš„ä¾èµ–åº“ä»¥åŠå¼•å¯¼ç¨‹åºé“¾æ¥åœ¨ä¸€èµ·æˆä¸º Linux ç³»ç»Ÿå¯ä»¥åŠ è½½çš„ <code>ELF</code> æ ¼å¼å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä½¿ç”¨ gcc è¿›è¡Œç¼–è¯‘ç›´è‡³é“¾æ¥çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">gcc hello.c -o hello   # å°† hello.c æ–‡ä»¶ç¼–è¯‘æ±‡ç¼–é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ hello
./hello                 # æˆåŠŸæ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œåœ¨ç»ˆç«¯ä¸Šä¼šæ‰“å° Hello Worldï¼å­—ç¬¦ä¸² Hello World!
</code></pre>
<p>æ³¨æ„ï¼šhello å¯æ‰§è¡Œæ–‡ä»¶ä¸º ELFï¼ˆExecutable and Linkable Formatï¼‰æ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>é“¾æ¥åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ï¼š</p>
<ul>
<li>
<p>é™æ€é“¾æ¥æ˜¯æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µç›´æ¥æŠŠé™æ€åº“åŠ å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»ï¼Œè¿™æ ·å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ã€‚é“¾æ¥å™¨å°†å‡½æ•°çš„ä»£ç ä»å…¶æ‰€åœ¨åœ°ï¼ˆä¸åŒçš„ç›®æ ‡æ–‡ä»¶æˆ–é™æ€é“¾æ¥åº“ä¸­ï¼‰æ‹·è´åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºä¸­ã€‚ä¸ºåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé“¾æ¥å™¨å¿…é¡»è¦å®Œæˆçš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼šç¬¦å·è§£æï¼ˆæŠŠç›®æ ‡æ–‡ä»¶ä¸­ç¬¦å·çš„å®šä¹‰å’Œå¼•ç”¨è”ç³»èµ·æ¥ï¼‰å’Œé‡å®šä½ï¼ˆæŠŠç¬¦å·å®šä¹‰å’Œå†…å­˜åœ°å€å¯¹åº”èµ·æ¥ç„¶åä¿®æ”¹æ‰€æœ‰å¯¹ç¬¦å·çš„å¼•ç”¨ï¼‰ã€‚</p>
</li>
<li>
<p>è€ŒåŠ¨æ€é“¾æ¥åˆ™æ˜¯æŒ‡é“¾æ¥é˜¶æ®µä»…ä»…åªåŠ å…¥ä¸€äº›æè¿°ä¿¡æ¯ï¼Œè€Œç¨‹åºæ‰§è¡Œæ—¶å†ä»ç³»ç»Ÿä¸­æŠŠç›¸åº”åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­å»ã€‚</p>
<ul>
<li>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œgcc ç¼–è¯‘é“¾æ¥æ—¶çš„åŠ¨æ€åº“æœç´¢è·¯å¾„çš„é¡ºåºé€šå¸¸ä¸ºï¼šé¦–å…ˆä» gcc å‘½ä»¤çš„å‚æ•° <code>-L</code> æŒ‡å®šçš„è·¯å¾„å¯»æ‰¾ï¼›å†ä»ç¯å¢ƒå˜é‡ <code>LIBRARY_PATH</code> æŒ‡å®šçš„è·¯å¾„å¯»å€ï¼›å†ä»é»˜è®¤è·¯å¾„ <code>/lib</code>ã€<code>/usr/lib</code>ã€<code>/usr/local/lib</code> ä¸­å¯»æ‰¾ã€‚</li>
<li>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶æ—¶çš„åŠ¨æ€åº“æœç´¢è·¯å¾„çš„é¡ºåºé€šå¸¸ä¸ºï¼šé¦–å…ˆæœç´¢ç¼–è¯‘ç›®æ ‡ä»£ç æ—¶æŒ‡å®šçš„åŠ¨æ€åº“æœç´¢è·¯å¾„ï¼›å†ä»ç¯å¢ƒå˜é‡ <code>LD_LIBRARY_PATH</code> æŒ‡å®šçš„è·¯å¾„å¯»å€ï¼›å†ä»é…ç½®æ–‡ä»¶ <code>/etc/ld.so.conf</code> ä¸­æŒ‡å®šçš„åŠ¨æ€åº“æœç´¢è·¯å¾„ï¼›å†ä»é»˜è®¤è·¯å¾„ <code>/lib</code>ã€<code>/usr/lib</code> ä¸­å¯»æ‰¾ã€‚</li>
<li>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç”¨ <code>ldd</code> å‘½ä»¤æŸ¥çœ‹ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºä¾èµ–çš„å…±äº«åº“ã€‚</li>
</ul>
</li>
<li>
<p>ç”±äºé“¾æ¥åŠ¨æ€åº“å’Œé™æ€åº“çš„è·¯å¾„å¯èƒ½æœ‰é‡åˆï¼Œæ‰€ä»¥å¦‚æœåœ¨è·¯å¾„ä¸­æœ‰åŒåçš„é™æ€åº“æ–‡ä»¶å’ŒåŠ¨æ€åº“æ–‡ä»¶ï¼Œæ¯”å¦‚libtest.a å’Œ libtest.soï¼Œgcc é“¾æ¥æ—¶é»˜è®¤ä¼˜å…ˆé€‰æ‹©åŠ¨æ€åº“ï¼Œä¼šé“¾æ¥ libtest.soï¼Œå¦‚æœè¦è®© gcc é€‰æ‹©é“¾æ¥ libtest.aåˆ™å¯ä»¥æŒ‡å®š gcc é€‰é¡¹ <code>-static</code>ï¼Œè¯¥é€‰é¡¹ä¼šå¼ºåˆ¶ä½¿ç”¨é™æ€åº“è¿›è¡Œé“¾æ¥ã€‚</p>
<ul>
<li>
<p>å¦‚æœä½¿ç”¨å‘½ä»¤ <code>gcc hello.c -o hello</code> åˆ™ä¼šä½¿ç”¨åŠ¨æ€åº“è¿›è¡Œé“¾æ¥ï¼Œç”Ÿæˆçš„ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼ˆä½¿ç”¨Binutils çš„ <code>size</code> å‘½ä»¤æŸ¥çœ‹ï¼‰å’Œé“¾æ¥çš„åŠ¨æ€åº“ï¼ˆä½¿ç”¨ Binutils çš„ <code>ldd</code> å‘½ä»¤æŸ¥çœ‹ï¼‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-bash">$ gcc hello.c -o hello
$ size hello   # ä½¿ç”¨sizeæŸ¥çœ‹å¤§å°
   text    data     bss     dec     hex     filename
   1183     552       8    1743     6cf     hello
$ ldd hello  # å¯ä»¥çœ‹å‡ºè¯¥å¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥äº†å¾ˆå¤šå…¶ä»–åŠ¨æ€åº“ï¼Œä¸»è¦æ˜¯ Linux çš„ glibc åŠ¨æ€åº“
        linux-vdso.so.1 =&gt;  (0x00007fffefd7c000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fadcdd82000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fadce14c000)
</code></pre>
</li>
<li>
<p>å¦‚æœä½¿ç”¨å‘½ä»¤ <code>gcc -static hello.c -o hello</code> åˆ™ä¼šä½¿ç”¨é™æ€åº“è¿›è¡Œé“¾æ¥ï¼Œç”Ÿæˆçš„ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°å’Œé“¾æ¥çš„åŠ¨æ€åº“å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-bash">$ gcc -static hello.c -o hello
$ size hello  # ä½¿ç”¨sizeæŸ¥çœ‹å¤§å°
     text    data     bss     dec     hex   filename
 823726    7284    6360  837370   cc6fa     hello  # å¯ä»¥çœ‹å‡º text æ®µçš„ä»£ç å°ºå¯¸å˜å¤§
$ ldd hello
       not a dynamic executable  # è¯´æ˜æ²¡æœ‰é“¾æ¥åŠ¨æ€åº“
</code></pre>
</li>
</ul>
</li>
</ul>
<p>é“¾æ¥å™¨é“¾æ¥åç”Ÿæˆçš„æœ€ç»ˆæ–‡ä»¶ä¸º ELF æ ¼å¼å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸€ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸è¢«é“¾æ¥ä¸ºä¸åŒçš„æ®µï¼Œå¸¸è§çš„æ®µæœ‰ <code>.text</code>ã€<code>.data</code>ã€<code>.rodata</code>ã€<code>.bss</code> ç­‰ã€‚</p>
<h3 id="ä¸€æ­¥åˆ°ä½çš„ç¼–è¯‘"><a class="header" href="#ä¸€æ­¥åˆ°ä½çš„ç¼–è¯‘">ä¸€æ­¥åˆ°ä½çš„ç¼–è¯‘</a></h3>
<p>ä»åŠŸèƒ½ä¸Šåˆ†ï¼Œé¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥æ˜¯å››ä¸ªä¸åŒçš„é˜¶æ®µï¼Œä½† GCC çš„å®é™…æ“ä½œä¸Šï¼Œå®ƒå¯ä»¥æŠŠè¿™å››ä¸ªæ­¥éª¤åˆå¹¶ä¸ºä¸€ä¸ªæ­¥éª¤æ¥æ‰§è¡Œã€‚å¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-bash">gcc â€“o test first.c second.c third.c
# è¯¥å‘½ä»¤å°†åŒæ—¶ç¼–è¯‘ä¸‰ä¸ªæºæ–‡ä»¶ï¼Œå³ first.cã€second.c å’Œ third.cï¼Œç„¶åå°†å®ƒä»¬é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
</code></pre>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>ä¸€ä¸ªç¨‹åºæ— è®ºæœ‰ä¸€ä¸ªæºæ–‡ä»¶è¿˜æ˜¯å¤šä¸ªæºæ–‡ä»¶ï¼Œæ‰€æœ‰è¢«ç¼–è¯‘å’Œé“¾æ¥çš„æºæ–‡ä»¶ä¸­å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª <code>main</code> å‡½æ•°ã€‚</li>
<li>ä½†å¦‚æœä»…ä»…æ˜¯æŠŠæºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œå› ä¸ºä¸ä¼šè¿›è¡Œé“¾æ¥ï¼Œæ‰€ä»¥ <code>main</code> å‡½æ•°ä¸æ˜¯å¿…éœ€çš„ã€‚</li>
</ul>
<h2 id="åˆ†æ-elf-æ–‡ä»¶"><a class="header" href="#åˆ†æ-elf-æ–‡ä»¶">åˆ†æ ELF æ–‡ä»¶</a></h2>
<h3 id="elf-æ–‡ä»¶ä»‹ç»"><a class="header" href="#elf-æ–‡ä»¶ä»‹ç»">ELF æ–‡ä»¶ä»‹ç»</a></h3>
<p>åœ¨ä»‹ç»ELFæ–‡ä»¶ä¹‹å‰ï¼Œé¦–å…ˆå°†å…¶ä¸å¦ä¸€ç§å¸¸è§çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼binè¿›è¡Œå¯¹æ¯”ï¼š</p>
<ul>
<li>binaryæ–‡ä»¶ï¼Œå…¶ä¸­åªæœ‰æœºå™¨ç ã€‚</li>
<li>elfæ–‡ä»¶é™¤äº†å«æœ‰æœºå™¨ç ä¹‹å¤–è¿˜æœ‰å…¶å®ƒä¿¡æ¯ï¼Œå¦‚ï¼šæ®µåŠ è½½åœ°å€ï¼Œè¿è¡Œå…¥å£åœ°å€ï¼Œæ•°æ®æ®µç­‰ã€‚</li>
</ul>
<p>ELFå…¨ç§°Executable and Linkable Formatï¼Œå¯æ‰§è¡Œé“¾æ¥æ ¼å¼ã€‚ELFæ–‡ä»¶æ ¼å¼ä¸»è¦ä¸‰ç§ï¼š</p>
<ul>
<li>å¯é‡å®šå‘ï¼ˆRelocatableï¼‰æ–‡ä»¶ï¼š
<ul>
<li>æ–‡ä»¶ä¿å­˜ç€ä»£ç å’Œé€‚å½“çš„æ•°æ®ï¼Œç”¨æ¥å’Œå…¶ä»–çš„ç›®æ ‡æ–‡ä»¶ä¸€èµ·æ¥åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…æ˜¯ä¸€ä¸ªå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>å¯æ‰§è¡Œï¼ˆExecutableï¼‰æ–‡ä»¶ï¼š
<ul>
<li>æ–‡ä»¶ä¿å­˜ç€ä¸€ä¸ªç”¨æ¥æ‰§è¡Œçš„ç¨‹åºï¼ˆä¾‹å¦‚bashï¼Œgccç­‰ï¼‰ã€‚</li>
</ul>
</li>
<li>å…±äº«ï¼ˆSharedï¼‰ç›®æ ‡æ–‡ä»¶ï¼ˆLinuxä¸‹åç¼€ä¸º.soçš„æ–‡ä»¶ï¼‰ï¼š
<ul>
<li>å³æ‰€è°“å…±äº«åº“ã€‚</li>
</ul>
</li>
</ul>
<h3 id="elfæ–‡ä»¶çš„æ®µ"><a class="header" href="#elfæ–‡ä»¶çš„æ®µ">ELFæ–‡ä»¶çš„æ®µ</a></h3>
<p>ELFæ–‡ä»¶æ ¼å¼å¦‚å›¾1ä¸­æ‰€ç¤ºï¼Œä½äºELF Headerå’ŒSection Header Tableä¹‹é—´çš„éƒ½æ˜¯æ®µï¼ˆSectionï¼‰ã€‚ä¸€ä¸ªå…¸å‹çš„ELFæ–‡ä»¶åŒ…å«ä¸‹é¢å‡ ä¸ªæ®µï¼š</p>
<ul>
<li>.textï¼šå·²ç¼–è¯‘ç¨‹åºçš„æŒ‡ä»¤ä»£ç æ®µã€‚</li>
<li>.rodataï¼šroä»£è¡¨read onlyï¼Œå³åªè¯»æ•°æ®ï¼ˆè­¬å¦‚å¸¸æ•°constï¼‰ã€‚</li>
<li>.dataï¼šå·²åˆå§‹åŒ–çš„Cç¨‹åºå…¨å±€å˜é‡å’Œé™æ€å±€éƒ¨å˜é‡ã€‚
<ul>
<li>æ³¨æ„ï¼šCç¨‹åºæ™®é€šå±€éƒ¨å˜é‡åœ¨è¿è¡Œæ—¶è¢«ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œæ—¢ä¸å‡ºç°åœ¨.dataæ®µä¸­ï¼Œä¹Ÿä¸å‡ºç°åœ¨.bssæ®µä¸­ã€‚æ­¤å¤–ï¼Œå¦‚æœå˜é‡è¢«åˆå§‹åŒ–å€¼ä¸º0ï¼Œä¹Ÿå¯èƒ½ä¼šæ”¾åˆ°bssæ®µã€‚</li>
</ul>
</li>
<li>.bssï¼šæœªåˆå§‹åŒ–çš„Cç¨‹åºå…¨å±€å˜é‡å’Œé™æ€å±€éƒ¨å˜é‡ã€‚
<ul>
<li>æ³¨æ„ï¼šç›®æ ‡æ–‡ä»¶æ ¼å¼åŒºåˆ†åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–å˜é‡æ˜¯ä¸ºäº†ç©ºé—´æ•ˆç‡ï¼Œåœ¨ELFæ–‡ä»¶ä¸­.bssæ®µä¸å æ®å®é™…çš„å­˜å‚¨å™¨ç©ºé—´ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚</li>
</ul>
</li>
<li>.debugï¼šè°ƒè¯•ç¬¦å·è¡¨ï¼Œè°ƒè¯•å™¨ç”¨æ­¤æ®µçš„ä¿¡æ¯å¸®åŠ©è°ƒè¯•ã€‚</li>
<li>ä¸Šè¿°ä»…è®²è§£äº†æœ€å¸¸è§çš„èŠ‚ï¼ŒELFæ–‡ä»¶è¿˜åŒ…å«å¾ˆå¤šå…¶ä»–ç±»å‹çš„èŠ‚ï¼Œæœ¬æ–‡åœ¨æ­¤ä¸åšèµ˜è¿°ï¼Œè¯·æ„Ÿå…´è¶£çš„è¯»è€…è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™äº†è§£å­¦ä¹ ã€‚</li>
</ul>
<p><img src="https://s1.ax1x.com/2018/11/02/ihFmes.png" alt="ELFæ–‡ä»¶æ ¼å¼" /></p>
<h3 id="æŸ¥çœ‹elfæ–‡ä»¶"><a class="header" href="#æŸ¥çœ‹elfæ–‡ä»¶">æŸ¥çœ‹ELFæ–‡ä»¶</a></h3>
<p>å¯ä»¥ä½¿ç”¨Binutilsä¸­readelfæ¥æŸ¥çœ‹ELFæ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡readelf --helpæ¥æŸ¥çœ‹readelfçš„é€‰é¡¹ï¼š</p>
<pre><code class="language-bash">$ readelf --help
Usage: readelf &lt;option(s)&gt; elf-file(s)
 Display information about the contents of ELF format files
 Options are:
  -a --all               Equivalent to: -h -l -S -s -r -d -V -A -I
  -h --file-header       Display the ELF file header
  -l --program-headers   Display the program headers
     --segments          An alias for --program-headers
  -S --section-headers   Display the sections' header
</code></pre>
<p>ä»¥æœ¬æ–‡Hello Worldç¤ºä¾‹ï¼Œä½¿ç”¨readelf -SæŸ¥çœ‹å…¶å„ä¸ªsectionçš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">$ readelf -S hello
There are 31 section headers, starting at offset 0x19d8:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
â€¦â€¦
  [11] .init             PROGBITS         00000000004003c8  000003c8
       000000000000001a  0000000000000000  AX       0     0     4
â€¦â€¦
  [14] .text             PROGBITS         0000000000400430  00000430
       0000000000000182  0000000000000000  AX       0     0     16
  [15] .fini             PROGBITS         00000000004005b4  000005b4
â€¦â€¦
</code></pre>
<h3 id="åæ±‡ç¼–"><a class="header" href="#åæ±‡ç¼–">åæ±‡ç¼–</a></h3>
<p>ç”±äºELFæ–‡ä»¶æ— æ³•è¢«å½“åšæ™®é€šæ–‡æœ¬æ–‡ä»¶æ‰“å¼€ï¼Œå¦‚æœå¸Œæœ›ç›´æ¥æŸ¥çœ‹ä¸€ä¸ªELFæ–‡ä»¶åŒ…å«çš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œéœ€è¦ä½¿ç”¨åæ±‡ç¼–çš„æ–¹æ³•ã€‚åæ±‡ç¼–æ˜¯ç”¨äºè°ƒè¯•å’Œå®šä½å¤„ç†å™¨é—®é¢˜æ—¶æœ€å¸¸ç”¨çš„æ‰‹æ®µã€‚ å¯ä»¥ä½¿ç”¨Binutilsä¸­objdumpæ¥å¯¹ELFæ–‡ä»¶è¿›è¡Œåæ±‡ç¼–ï¼Œå¯ä»¥é€šè¿‡objdump --helpæ¥æŸ¥çœ‹å…¶é€‰é¡¹ï¼š</p>
<pre><code class="language-bash">$ objdump --help
Usage: objdump &lt;option(s)&gt; &lt;file(s)&gt;
 Display information from object &lt;file(s)&gt;.
 At least one of the following switches must be given:
â€¦â€¦
  -D, --disassemble-all    Display assembler contents of all sections
  -S, --source             Intermix source code with disassembly
â€¦â€¦
</code></pre>
<p>ä»¥æœ¬æ–‡Hello Worldç¤ºä¾‹ï¼Œä½¿ç”¨objdump -Då¯¹å…¶è¿›è¡Œåæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">$ objdump -D hello
â€¦â€¦
0000000000400526 &lt;main&gt;:  # mainæ ‡ç­¾çš„PCåœ°å€
# PCåœ°å€ï¼š    æŒ‡ä»¤ç¼–ç                  æŒ‡ä»¤çš„æ±‡ç¼–æ ¼å¼
  400526:    55                      push   %rbp
  400527:    48 89 e5                mov    %rsp,%rbp
  40052a:    bf c4 05 40 00          mov    $0x4005c4,%edi
  40052f:    e8 cc fe ff ff          callq  400400 &lt;puts@plt&gt;
  400534:    b8 00 00 00 00          mov    $0x0,%eax
  400539:    5d                      pop    %rbp
  40053a:    c3                      retq
  40053b:    0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)
â€¦â€¦
</code></pre>
<p>ä½¿ç”¨objdump -Så°†å…¶åæ±‡ç¼–å¹¶ä¸”å°†å…¶Cè¯­è¨€æºä»£ç æ··åˆæ˜¾ç¤ºå‡ºæ¥ï¼š</p>
<pre><code class="language-bash">$ gcc -o hello -g hello.c # è¦åŠ ä¸Š-gé€‰é¡¹
$ objdump -S hello
â€¦â€¦
0000000000400526 &lt;main&gt;:
#include &lt;stdio.h&gt;

int
main(void)
{
  400526:    55                      push   %rbp
  400527:    48 89 e5                mov    %rsp,%rbp
  printf("Hello World!" "\n");
  40052a:    bf c4 05 40 00          mov    $0x4005c4,%edi
  40052f:    e8 cc fe ff ff          callq  400400 &lt;puts@plt&gt;
  return 0;
  400534:    b8 00 00 00 00          mov    $0x0,%eax
}
  400539:    5d                      pop    %rbp
  40053a:    c3                      retq
  40053b:    0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)
â€¦â€¦
</code></pre>
<h2 id="åµŒå…¥å¼ç³»ç»Ÿç¼–è¯‘çš„ç‰¹æ®Šæ€§"><a class="header" href="#åµŒå…¥å¼ç³»ç»Ÿç¼–è¯‘çš„ç‰¹æ®Šæ€§">åµŒå…¥å¼ç³»ç»Ÿç¼–è¯‘çš„ç‰¹æ®Šæ€§</a></h2>
<p>ä¸ºäº†æ˜“äºè¯»è€…ç†è§£ï¼Œæœ¬æ–‡ä»¥ä¸€ä¸ªHello Worldç¨‹åºä¸ºä¾‹è®²è§£äº†åœ¨Linuxç¯å¢ƒä¸­çš„ç¼–è¯‘è¿‡ç¨‹ä»¥å¸®åŠ©åˆå­¦è€…å…¥é—¨ï¼Œä½†æ˜¯äº†è§£è¿™äº›åŸºç¡€èƒŒæ™¯çŸ¥è¯†å¯¹äºåµŒå…¥å¼å¼€å‘è¿˜è¿œè¿œä¸å¤Ÿã€‚
å¯¹äºåµŒå…¥å¼å¼€å‘ï¼ŒåµŒå…¥å¼ç³»ç»Ÿçš„ç¼–è¯‘è¿‡ç¨‹å’Œå¼€å‘æœ‰å…¶ç‰¹æ®Šæ€§ï¼Œè­¬å¦‚ï¼š</p>
<ul>
<li>åµŒå…¥å¼ç³»ç»Ÿéœ€è¦ä½¿ç”¨äº¤å‰ç¼–è¯‘ä¸è¿œç¨‹è°ƒè¯•çš„æ–¹æ³•è¿›è¡Œå¼€å‘ã€‚</li>
<li>éœ€è¦è‡ªå·±å®šä¹‰å¼•å¯¼ç¨‹åºã€‚</li>
<li>éœ€è¦æ³¨æ„å‡å°‘ä»£ç å°ºå¯¸ã€‚</li>
<li>éœ€è¦ç§»æ¤printfä»è€Œä½¿å¾—åµŒå…¥å¼ç³»ç»Ÿä¹Ÿèƒ½å¤Ÿæ‰“å°è¾“å…¥ã€‚</li>
<li>ä½¿ç”¨Newlibä½œä¸ºCè¿è¡Œåº“ã€‚</li>
<li>æ¯ä¸ªç‰¹å®šçš„åµŒå…¥å¼ç³»ç»Ÿéƒ½éœ€è¦é…å¥—çš„æ¿çº§æ”¯æŒåŒ…ã€‚</li>
</ul>
<h3 id="äº¤å‰ç¼–è¯‘å’Œè¿œç¨‹è°ƒè¯•"><a class="header" href="#äº¤å‰ç¼–è¯‘å’Œè¿œç¨‹è°ƒè¯•">äº¤å‰ç¼–è¯‘å’Œè¿œç¨‹è°ƒè¯•</a></h3>
<p>åµŒå…¥å¼å¹³å°ä¸Šå¾€å¾€èµ„æºæœ‰é™ï¼ŒåµŒå…¥å¼ç³»ç»Ÿï¼ˆè­¬å¦‚å¸¸è§ARM   MCUæˆ–8051å•ç‰‡æœºï¼‰çš„å­˜å‚¨å™¨å®¹é‡é€šå¸¸åªåœ¨å‡ KBåˆ°å‡ MBä¹‹é—´ï¼Œä¸”åªæœ‰é—ªå­˜è€Œæ²¡æœ‰ç¡¬ç›˜è¿™ç§å¤§å®¹é‡å­˜å‚¨è®¾å¤‡ï¼Œåœ¨è¿™ç§èµ„æºæœ‰é™çš„ç¯å¢ƒä¸­ï¼Œä¸å¯èƒ½å°†ç¼–è¯‘å™¨ç­‰å¼€å‘å·¥å…·å®‰è£…åœ¨åµŒå…¥å¼è®¾å¤‡ä¸­ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥åœ¨åµŒå…¥å¼è®¾å¤‡ä¸­è¿›è¡Œè½¯ä»¶å¼€å‘ã€‚å› æ­¤ï¼ŒåµŒå…¥å¼å¹³å°çš„è½¯ä»¶ä¸€èˆ¬åœ¨ä¸»æœºPCä¸Šè¿›è¡Œå¼€å‘å’Œç¼–è¯‘ï¼Œç„¶åå°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ä»£ç ä¸‹è½½è‡³ç›®æ ‡åµŒå…¥å¼ç³»ç»Ÿå¹³å°ä¸Šè¿è¡Œï¼Œè¿™ç§ç¼–è¯‘æ–¹å¼å±äºäº¤å‰ç¼–è¯‘ã€‚</p>
<p>äº¤å‰ç¼–è¯‘å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œåœ¨å½“å‰ç¼–è¯‘å¹³å°ä¸‹ï¼Œç¼–è¯‘å‡ºæ¥çš„ç¨‹åºèƒ½è¿è¡Œåœ¨ä½“ç³»ç»“æ„ä¸åŒçš„å¦ä¸€ç§ç›®æ ‡å¹³å°ä¸Šï¼Œä½†æ˜¯ç¼–è¯‘å¹³å°æœ¬èº«å´ä¸èƒ½è¿è¡Œè¯¥ç¨‹åºï¼Œè­¬å¦‚ï¼Œåœ¨x86å¹³å°çš„PCç”µè„‘ä¸Šç¼–å†™ç¨‹åºå¹¶ç¼–è¯‘æˆèƒ½è¿è¡Œåœ¨ARMå¹³å°çš„ç¨‹åºï¼Œç¼–è¯‘å¾—åˆ°çš„ç¨‹åºåœ¨x86å¹³å°ä¸Šä¸èƒ½è¿è¡Œï¼Œå¿…é¡»æ”¾åˆ°ARMå¹³å°ä¸Šæ‰èƒ½è¿è¡Œã€‚</p>
<p>ä¸äº¤å‰ç¼–è¯‘åŒç†ï¼Œåœ¨åµŒå…¥å¼å¹³å°ä¸Šå¾€å¾€ä¹Ÿæ— æ³•è¿è¡Œå®Œæ•´çš„è°ƒè¯•å™¨ï¼Œå› æ­¤å½“è¿è¡ŒäºåµŒå…¥å¼å¹³å°ä¸Šçš„ç¨‹åºå‡ºç°é—®é¢˜æ—¶ï¼Œéœ€è¦å€ŸåŠ©ä¸»æœºPCå¹³å°ä¸Šçš„è°ƒè¯•å™¨æ¥å¯¹åµŒå…¥å¼å¹³å°è¿›è¡Œè°ƒè¯•ã€‚è¿™ç§è°ƒè¯•æ–¹å¼å±äºè¿œç¨‹è°ƒè¯•ã€‚</p>
<p>å¸¸è§çš„äº¤å‰ç¼–è¯‘å’Œè¿œç¨‹è°ƒè¯•å·¥å…·æ˜¯GCCå’ŒGDBã€‚GCCä¸ä»…èƒ½ä½œä¸ºæœ¬åœ°ç¼–è¯‘å™¨ï¼Œè¿˜èƒ½ä½œä¸ºäº¤å‰ç¼–è¯‘å™¨ï¼›åŒç†GDBä¸ä»…å¯ä»¥ä½œä¸ºæœ¬åœ°è°ƒè¯•å™¨ï¼Œè¿˜å¯ä»¥ä½œä¸ºè¿œç¨‹è°ƒè¯•å™¨ã€‚</p>
<p>å½“ä½œä¸ºäº¤å‰ç¼–è¯‘å™¨ä¹‹æ—¶ï¼ŒGCCé€šå¸¸æœ‰ä¸åŒçš„å‘½åï¼Œè­¬å¦‚ï¼š</p>
<ul>
<li>arm-none-eabi-gccå’Œarm-none-eabi-gdbæ˜¯é¢å‘è£¸æœºï¼ˆBare-Metalï¼‰ARMå¹³å°çš„äº¤å‰ç¼–è¯‘å™¨å’Œè¿œç¨‹è°ƒè¯•å™¨ã€‚
<ul>
<li>æ‰€è°“è£¸æœºï¼ˆBare-Metalï¼‰æ˜¯åµŒå…¥å¼é¢†åŸŸçš„ä¸€ä¸ªå¸¸è§å½¢æ€ï¼Œè¡¨ç¤ºä¸è¿è¡Œæ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿ</li>
</ul>
</li>
<li>è€Œriscv-none-embed-gccå’Œriscv-none-embed-gdbæ˜¯é¢å‘è£¸æœºRISC-Vå¹³å°çš„äº¤å‰ç¼–è¯‘å™¨å’Œè¿œç¨‹è°ƒè¯•å™¨ã€‚</li>
</ul>
<h3 id="ç§»æ¤newlibæˆ–newlib-nanoä½œä¸ºcè¿è¡Œåº“"><a class="header" href="#ç§»æ¤newlibæˆ–newlib-nanoä½œä¸ºcè¿è¡Œåº“">ç§»æ¤newlibæˆ–newlib-nanoä½œä¸ºCè¿è¡Œåº“</a></h3>
<p>newlibæ˜¯ä¸€ä¸ªé¢å‘åµŒå…¥å¼ç³»ç»Ÿçš„Cè¿è¡Œåº“ã€‚ç›¸å¯¹äºglibcï¼Œnewlibå®ç°äº†å¤§éƒ¨åˆ†çš„åŠŸèƒ½å‡½æ•°ï¼Œä½†ä½“ç§¯å´å°å¾ˆå¤šã€‚newlibç‹¬ç‰¹çš„ä½“ç³»ç»“æ„å°†åŠŸèƒ½å®ç°ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿåˆ†å±‚ï¼Œä½¿ä¹‹èƒ½å¤Ÿå¾ˆå¥½åœ°è¿›è¡Œé…ç½®ä»¥æ»¡è¶³åµŒå…¥å¼ç³»ç»Ÿçš„è¦æ±‚ã€‚ç”±äºä¸“ä¸ºåµŒå…¥å¼ç³»ç»Ÿè®¾è®¡ï¼Œnewlibå…·æœ‰å¯ç§»æ¤æ€§å¼ºã€è½»é‡çº§ã€é€Ÿåº¦å¿«ã€åŠŸèƒ½å®Œå¤‡ç­‰ç‰¹ç‚¹ï¼Œå·²å¹¿æ³›åº”ç”¨äºå„ç§åµŒå…¥å¼ç³»ç»Ÿä¸­ã€‚</p>
<p>ç”±äºåµŒå…¥å¼æ“ä½œç³»ç»Ÿå’Œåº•å±‚ç¡¬ä»¶çš„å¤šæ ·æ€§ï¼Œä¸ºäº†èƒ½å¤Ÿå°†C/C++è¯­è¨€æ‰€éœ€è¦çš„åº“å‡½æ•°å®ç°ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿå’Œåº•å±‚ç¡¬ä»¶è¿›è¡Œåˆ†å±‚ï¼Œnewlibçš„æ‰€æœ‰åº“å‡½æ•°éƒ½å»ºç«‹åœ¨20ä¸ªæ¡©å‡½æ•°çš„åŸºç¡€ä¸Šï¼Œè¿™20ä¸ªæ¡©å‡½æ•°å®Œæˆå…·ä½“æ“ä½œç³»ç»Ÿå’Œåº•å±‚ç¡¬ä»¶ç›¸å…³çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>I/Oå’Œæ–‡ä»¶ç³»ç»Ÿè®¿é—®ï¼ˆopenã€closeã€readã€writeã€lseekã€statã€fstatã€fcntlã€linkã€unlinkã€renameï¼‰ï¼›</li>
<li>æ‰©å¤§å†…å­˜å †çš„éœ€æ±‚ï¼ˆsbrkï¼‰ï¼›</li>
<li>è·å¾—å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆgettimeofdayã€timesï¼‰ï¼›</li>
<li>å„ç§ç±»å‹çš„ä»»åŠ¡ç®¡ç†å‡½æ•°ï¼ˆexecveã€forkã€getpidã€killã€waitã€_exitï¼‰ï¼›</li>
</ul>
<p>è¿™20ä¸ªæ¡©å‡½æ•°åœ¨è¯­ä¹‰ã€è¯­æ³•ä¸Šä¸POSIXï¼ˆPortable Operating System Interface of UNIXï¼‰æ ‡å‡†ä¸‹å¯¹åº”çš„20ä¸ªåŒåç³»ç»Ÿè°ƒç”¨å®Œå…¨å…¼å®¹ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœéœ€è¦ç§»æ¤newlibè‡³æŸä¸ªç›®æ ‡åµŒå…¥å¼å¹³å°ï¼ŒæˆåŠŸç§»æ¤çš„å…³é”®æ˜¯åœ¨ç›®æ ‡å¹³å°ä¸‹æ‰¾åˆ°èƒ½å¤Ÿä¸newlibæ¡©å‡½æ•°è¡”æ¥çš„åŠŸèƒ½å‡½æ•°æˆ–è€…å®ç°è¿™äº›æ¡©å‡½æ•°ã€‚</p>
<p>æ³¨æ„ï¼šnewlibçš„ä¸€ä¸ªç‰¹æ®Šç‰ˆæœ¬newlib-nanoç‰ˆæœ¬è¿›ä¸€æ­¥ä¸ºåµŒå…¥å¼å¹³å°å‡å°‘äº†ä»£ç ä½“ç§¯ï¼ˆCode Sizeï¼‰ï¼Œå› ä¸ºnewlib-nanoæä¾›äº†æ›´åŠ ç²¾ç®€ç‰ˆæœ¬çš„mallocå’Œprintfå‡½æ•°çš„å®ç°ï¼Œå¹¶ä¸”å¯¹åº“å‡½æ•°ä½¿ç”¨GCCçš„-Osï¼ˆä¾§é‡ä»£ç ä½“ç§¯çš„ä¼˜åŒ–ï¼‰é€‰é¡¹è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ã€‚</p>
<h3 id="åµŒå…¥å¼å¼•å¯¼ç¨‹åºå’Œä¸­æ–­å¼‚å¸¸å¤„ç†"><a class="header" href="#åµŒå…¥å¼å¼•å¯¼ç¨‹åºå’Œä¸­æ–­å¼‚å¸¸å¤„ç†">åµŒå…¥å¼å¼•å¯¼ç¨‹åºå’Œä¸­æ–­å¼‚å¸¸å¤„ç†</a></h3>
<p>å‰æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨Linuxç³»ç»Ÿçš„PCç”µè„‘ä¸Šå¼€å‘ä¸€ä¸ªHello  Worldç¨‹åºï¼Œå¯¹å…¶è¿›è¡Œç¼–è¯‘ï¼Œç„¶åè¿è¡Œåœ¨æ­¤ç”µè„‘ä¸Šã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œç¨‹åºå‘˜ä»…ä»…åªéœ€è¦å…³æ³¨Hello  Worldç¨‹åºæœ¬èº«ï¼Œç¨‹åºçš„ä¸»ä½“ç”±mainå‡½æ•°ç»„ç»‡è€Œæˆï¼Œç¨‹åºå‘˜å¯ä»¥æ— éœ€å…³æ³¨Linuxæ“ä½œç³»ç»Ÿåœ¨è¿è¡Œè¯¥ç¨‹åºçš„mainå‡½æ•°ä¹‹å‰å’Œä¹‹åéœ€è¦åšä»€ä¹ˆã€‚äº‹å®ä¸Šï¼Œåœ¨Linuxæ“ä½œç³»ç»Ÿä¸­è¿è¡Œåº”ç”¨ç¨‹åºï¼ˆè­¬å¦‚ç®€å•çš„Hello   Worldï¼‰æ—¶ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦åŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€ä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´ã€åˆ›å»ºå¹¶è¿è¡Œè¯¥è¿›ç¨‹çš„å¼•å¯¼ç¨‹åºï¼Œç„¶åæ‰ä¼šå¼€å§‹æ‰§è¡Œè¯¥ç¨‹åºçš„mainå‡½æ•°ï¼Œå¾…å…¶è¿è¡Œç»“æŸä¹‹åï¼Œæ“ä½œç³»ç»Ÿè¿˜è¦æ¸…é™¤å¹¶é‡Šæ”¾å…¶å†…å­˜ç©ºé—´ã€æ³¨é”€è¯¥è¿›ç¨‹ç­‰ã€‚</p>
<p>ä»ä¸Šè¿°è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œç¨‹åºçš„å¼•å¯¼å’Œæ¸…é™¤è¿™äº›â€œè„æ´»ç´¯æ´»â€éƒ½æ˜¯ç”±Linuxè¿™æ ·çš„æ“ä½œç³»ç»Ÿæ¥è´Ÿè´£è¿›è¡Œã€‚ä½†æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œç¨‹åºå‘˜é™¤äº†å¼€å‘ä»¥mainå‡½æ•°ä¸ºä¸»ä½“çš„åŠŸèƒ½ç¨‹åºä¹‹å¤–ï¼Œè¿˜éœ€è¦å…³æ³¨å¦‚ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>å¼•å¯¼ç¨‹åºï¼š
<ul>
<li>åµŒå…¥å¼ç³»ç»Ÿä¸Šç”µåéœ€è¦å¯¹ç³»ç»Ÿç¡¬ä»¶å’Œè½¯ä»¶è¿è¡Œç¯å¢ƒè¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™äº›å·¥ä½œå¾€å¾€ç”±ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„å¼•å¯¼ç¨‹åºå®Œæˆã€‚</li>
<li>å¼•å¯¼ç¨‹åºæ˜¯åµŒå…¥å¼ç³»ç»Ÿä¸Šç”µåè¿è¡Œçš„ç¬¬ä¸€æ®µè½¯ä»¶ä»£ç ã€‚å¼•å¯¼ç¨‹åºå¯¹äºåµŒå…¥å¼ç³»ç»Ÿéå¸¸å…³é”®ï¼Œå¼•å¯¼ç¨‹åºæ‰€æ‰§è¡Œçš„æ“ä½œä¾èµ–äºæ‰€å¼€å‘çš„åµŒå…¥å¼ç³»ç»Ÿçš„è½¯ç¡¬ä»¶ç‰¹æ€§ï¼Œä¸€èˆ¬æµç¨‹åŒ…æ‹¬ï¼šåˆå§‹åŒ–ç¡¬ä»¶ã€è®¾ç½®å¼‚å¸¸å’Œä¸­æ–­å‘é‡è¡¨ã€æŠŠç¨‹åºæ‹·è´åˆ°ç‰‡ä¸ŠSRAMä¸­ã€å®Œæˆä»£ç çš„é‡æ˜ å°„ç­‰ï¼Œæœ€åè·³è½¬åˆ°mainå‡½æ•°å…¥å£ã€‚</li>
</ul>
</li>
<li>ä¸­æ–­å¼‚å¸¸å¤„ç†
<ul>
<li>ä¸­æ–­å’Œå¼‚å¸¸æ˜¯åµŒå…¥å¼ç³»ç»Ÿéå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå› æ­¤ï¼ŒåµŒå…¥å¼ç³»ç»Ÿè½¯ä»¶è¿˜å¿…é¡»æ­£ç¡®åœ°é…ç½®ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†å‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åµŒå…¥å¼ç³»ç»Ÿé“¾æ¥è„šæœ¬"><a class="header" href="#åµŒå…¥å¼ç³»ç»Ÿé“¾æ¥è„šæœ¬">åµŒå…¥å¼ç³»ç»Ÿé“¾æ¥è„šæœ¬</a></h3>
<p>ä¸Šæ–‡ä¸­ä»‹ç»äº†å¦‚ä½•åœ¨Linuxç³»ç»Ÿçš„PCç”µè„‘ä¸Šå¼€å‘ä¸€ä¸ªHello Worldç¨‹åºï¼Œå¯¹å…¶è¿›è¡Œç¼–è¯‘ï¼Œç„¶åè¿è¡Œåœ¨æ­¤ç”µè„‘ä¸Šã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œç¨‹åºå‘˜ä¹Ÿæ— éœ€å…³å¿ƒç¼–è¯‘è¿‡ç¨‹ä¸­çš„â€œé“¾æ¥â€è¿™ä¸€æ­¥éª¤æ‰€ä½¿ç”¨çš„é“¾æ¥è„šæœ¬ï¼Œæ— éœ€ä¸ºç¨‹åºåˆ†é…å…·ä½“çš„å†…å­˜ç©ºé—´ã€‚</p>
<p>ä½†æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œç¨‹åºå‘˜é™¤äº†å¼€å‘ä»¥mainå‡½æ•°ä¸ºä¸»ä½“çš„åŠŸèƒ½ç¨‹åºä¹‹å¤–ï¼Œè¿˜éœ€è¦å…³æ³¨â€œé“¾æ¥è„šæœ¬â€ä¸ºç¨‹åºåˆ†é…åˆé€‚çš„å­˜å‚¨å™¨ç©ºé—´ï¼Œè­¬å¦‚ç¨‹åºæ®µæ”¾åœ¨ä»€ä¹ˆåŒºé—´ã€æ•°æ®æ®µæ”¾åœ¨ä»€ä¹ˆåŒºé—´ç­‰ç­‰ã€‚</p>
<h3 id="å‡å°ä»£ç ä½“ç§¯"><a class="header" href="#å‡å°ä»£ç ä½“ç§¯">å‡å°ä»£ç ä½“ç§¯</a></h3>
<p>åµŒå…¥å¼å¹³å°ä¸Šå¾€å¾€å­˜å‚¨å™¨èµ„æºæœ‰é™ï¼ŒåµŒå…¥å¼ç³»ç»Ÿï¼ˆè­¬å¦‚å¸¸è§çš„ARM   MCUæˆ–8051å•ç‰‡æœºï¼‰çš„å­˜å‚¨å™¨å®¹é‡é€šå¸¸åªåœ¨å‡ KBåˆ°å‡ MBä¹‹é—´ï¼Œä¸”åªæœ‰é—ªå­˜è€Œæ²¡æœ‰ç¡¬ç›˜è¿™ç§å¤§å®¹é‡å­˜å‚¨è®¾å¤‡ï¼Œåœ¨è¿™ç§èµ„æºæœ‰é™çš„ç¯å¢ƒä¸­ï¼Œç¨‹åºçš„ä»£ç ä½“ç§¯ï¼ˆCode  Sizeï¼‰æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œå› æ­¤ï¼Œæœ‰æ•ˆåœ°é™ä½é™ä½ä»£ç ä½“ç§¯ï¼ˆCode Sizeï¼‰æ˜¯åµŒå…¥å¼è½¯ä»¶å¼€å‘å¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ï¼Œå¸¸è§çš„æ–¹æ³•å¦‚ï¼š</p>
<ul>
<li>ä½¿ç”¨newlib-nanoä½œä¸ºCè¿è¡Œåº“ä»¥å–å¾—è¾ƒå°ä»£ç ä½“ç§¯ï¼ˆCode Sizeï¼‰çš„Cåº“å‡½æ•°ã€‚</li>
<li>å°½é‡å°‘ä½¿ç”¨Cè¯­è¨€çš„å¤§å‹åº“å‡½æ•°ï¼Œè­¬å¦‚åœ¨æ­£å¼å‘è¡Œç‰ˆæœ¬çš„ç¨‹åºä¸­é¿å…ä½¿ç”¨printfå’Œscanfç­‰å‡½æ•°ã€‚</li>
<li>å¦‚æœåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ä¸€å®šéœ€è¦ä½¿ç”¨printfå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨æŸäº›è‡ªå·±å®ç°çš„é˜‰å‰²ç‰ˆprintfå‡½æ•°ï¼ˆè€Œä¸æ˜¯Cè¿è¡Œåº“ä¸­æä¾›çš„printfå‡½æ•°ï¼‰ä»¥ç”Ÿæˆè¾ƒå°çš„ä»£ç ä½“ç§¯ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨C/C++è¯­è¨€çš„è¯­æ³•å’Œç¨‹åºå¼€å‘æ–¹é¢ä¹Ÿæœ‰ä¼—å¤šæŠ€å·§ä»¥å–å¾—æ›´å°çš„ä»£ç ä½“ç§¯ï¼ˆCode Sizeï¼‰ã€‚</li>
</ul>
<h3 id="æ”¯æŒprintfå‡½æ•°"><a class="header" href="#æ”¯æŒprintfå‡½æ•°">æ”¯æŒprintfå‡½æ•°</a></h3>
<p>ä¸Šæ–‡ä¸­ä»‹ç»äº†å¦‚ä½•åœ¨Linuxç³»ç»Ÿçš„PCç”µè„‘ä¸Šå¼€å‘ä¸€ä¸ªHello Worldç¨‹åºï¼Œç¨‹åºä¸­ä½¿ç”¨Cè¯­è¨€çš„æ ‡å‡†åº“å‡½æ•°printfæ‰“å°äº†ä¸€ä¸ªâ€œHello  Worldâ€å­—ç¬¦ä¸²ã€‚è¯¥ç¨‹åºåœ¨Linuxç³»ç»Ÿé‡Œé¢è¿è¡Œçš„æ—¶å€™å­—ç¬¦ä¸²è¢«æˆåŠŸçš„è¾“å‡ºåˆ°äº†Linuxçš„ç»ˆç«¯ç•Œé¢ä¸Šã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¨‹åºå‘˜æ— éœ€å…³å¿ƒLinuxç³»ç»Ÿåˆ°åº•æ˜¯å¦‚ä½•å°†printfå‡½æ•°çš„å­—ç¬¦ä¸²è¾“å‡ºåˆ°Linuxç»ˆç«¯ä¸Šçš„ã€‚äº‹å®ä¸Šï¼Œåœ¨Linuxæœ¬åœ°ç¼–è¯‘çš„ç¨‹åºä¼šé“¾æ¥ä½¿ç”¨Linuxç³»ç»Ÿçš„Cè¿è¡Œåº“glibcï¼Œè€Œglibcå……å½“äº†åº”ç”¨ç¨‹åºå’ŒLinuxæ“ä½œç³»ç»Ÿä¹‹é—´çš„æ¥å£ï¼Œglibcæä¾›çš„  printf å‡½æ•°å°±ä¼šè°ƒç”¨å¦‚sys_writeç­‰æ“ä½œç³»ç»Ÿçš„åº•å±‚ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œä»è€Œèƒ½å¤Ÿå°†â€œå­—ç¬¦ä¸²â€è¾“å‡ºåˆ°Linuxç»ˆç«¯ä¸Šã€‚</p>
<p>ä»ä¸Šè¿°è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œç”±äºæœ‰glibcçš„æ”¯æŒï¼Œæ‰€ä»¥printfå‡½æ•°èƒ½å¤Ÿåœ¨Linuxç³»ç»Ÿä¸­æ­£ç¡®çš„è¿›è¡Œè¾“å‡ºã€‚ä½†æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œprintfçš„è¾“å‡ºå´ä¸é‚£ä¹ˆå®¹æ˜“äº†ï¼ŒåŸºäºå¦‚ä¸‹å‡ ä¸ªåŸå› ï¼š</p>
<ul>
<li>åµŒå…¥å¼ç³»ç»Ÿä½¿ç”¨newlibä½œä¸ºCè¿è¡Œåº“ï¼Œè€Œnewlibçš„Cè¿è¡Œåº“æ‰€æä¾›çš„printfå‡½æ•°æœ€ç»ˆä¾èµ–äºå¦‚æœ¬æ–‡ä¸­æ‰€ä»‹ç»çš„newlibæ¡©å‡½æ•°writeï¼Œå› æ­¤å¿…é¡»å®ç°æ­¤writeå‡½æ•°æ‰èƒ½å¤Ÿæ­£ç¡®çš„æ‰§è¡Œprintfå‡½æ•°ã€‚</li>
<li>åµŒå…¥å¼ç³»ç»Ÿå¾€å¾€æ²¡æœ‰â€œæ˜¾ç¤ºç»ˆç«¯â€å­˜åœ¨ï¼Œè­¬å¦‚å¸¸è§çš„å•ç‰‡æœºå…¶ä½œä¸ºä¸€ä¸ªé»‘ç›’å­ä¸€èˆ¬çš„èŠ¯ç‰‡ï¼Œæ ¹æœ¬æ²¡æœ‰æ˜¾ç¤ºç»ˆç«¯ã€‚å› æ­¤ï¼Œä¸ºäº†èƒ½å¤Ÿæ”¯æŒæ˜¾ç¤ºè¾“å‡ºï¼Œé€šå¸¸éœ€è¦å€ŸåŠ©å•ç‰‡æœºèŠ¯ç‰‡çš„UARTæ¥å£å°†printfå‡½æ•°çš„è¾“å‡ºé‡æ–°å®šå‘åˆ°ä¸»æœºPCçš„COMå£ä¸Šï¼Œç„¶åå€ŸåŠ©ä¸»æœºPCçš„ä¸²å£è°ƒè¯•åŠ©æ‰‹æ˜¾ç¤ºå‡ºè¾“å‡ºä¿¡æ¯ã€‚åŒç†ï¼Œå¯¹äºscanfè¾“å…¥å‡½æ•°ï¼Œä¹Ÿéœ€è¦é€šè¿‡ä¸»æœºPCçš„ä¸²å£è°ƒè¯•åŠ©æ‰‹è·å–è¾“å…¥ç„¶åé€šè¿‡ä¸»æœºPCçš„COMå£å‘é€ç»™å•ç‰‡æœºèŠ¯ç‰‡çš„UARTæ¥å£ã€‚</li>
<li>ä»ä»¥ä¸Šä¸¤ç‚¹å¯ä»¥çœ‹å‡ºï¼ŒåµŒå…¥å¼å¹³å°çš„UARTæ¥å£éå¸¸é‡è¦ï¼Œå¾€å¾€æ‰®æ¼”äº†è¾“å‡ºç®¡é“çš„è§’è‰²ï¼Œä¸ºäº†èƒ½å¤Ÿå°†printfå‡½æ•°çš„è¾“å‡ºå®šå‘åˆ°UARTæ¥å£ï¼Œéœ€è¦å®ç°newlibçš„æ¡©å‡½æ•°writeï¼Œä½¿å…¶é€šè¿‡ç¼–ç¨‹UARTçš„ç›¸å…³å¯„å­˜å™¨å°†å­—ç¬¦é€šè¿‡UARTæ¥å£è¾“å‡ºã€‚</li>
</ul>
<h3 id="æä¾›æ¿çº§æ”¯æŒåŒ…"><a class="header" href="#æä¾›æ¿çº§æ”¯æŒåŒ…">æä¾›æ¿çº§æ”¯æŒåŒ…</a></h3>
<p>å¯¹äºç‰¹å®šçš„åµŒå…¥å¼ç¡¬ä»¶å¹³å°ï¼Œä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åœ¨ç¡¬ä»¶å¹³å°ä¸Šå¼€å‘åµŒå…¥å¼ç¨‹åºï¼Œç¡¬ä»¶å¹³å°ä¸€èˆ¬ä¼šæä¾›æ¿çº§æ”¯æŒåŒ…ï¼ˆBoard Support Packageï¼ŒBSPï¼‰ã€‚æ¿çº§æ”¯æŒåŒ…æ‰€åŒ…å«çš„å†…å®¹æ²¡æœ‰ç»å¯¹çš„æ ‡å‡†ï¼Œé€šå¸¸è¯´æ¥ï¼Œå…¶å¿…é¡»åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„åœ°å€åˆ†é…ä¿¡æ¯</li>
<li>åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„é©±åŠ¨å‡½æ•°</li>
<li>ç³»ç»Ÿçš„å¼•å¯¼ç¨‹åº</li>
<li>ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†æœåŠ¡ç¨‹åº</li>
<li>ç³»ç»Ÿçš„é“¾æ¥è„šæœ¬</li>
<li>å¦‚æœä½¿ç”¨newlibä½œä¸ºCè¿è¡Œåº“ï¼Œä¸€èˆ¬è¿˜æä¾›newlibæ¡©å‡½æ•°çš„å®ç°ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cmake-åŸºç¡€"><a class="header" href="#cmake-åŸºç¡€">CMake åŸºç¡€</a></h1>
<p>ä»å¹¿ä¹‰ä¸Šæ¥è®²ï¼ŒCMake æ˜¯ä¸€ç»„å·¥å…·,åŒ…æ‹¬äº† <code>CMake</code>ï¼Œ<code>CTest</code> å’Œ <code>CPack</code>ã€‚</p>
<h2 id="æœ€å°-cmake-å·¥ç¨‹"><a class="header" href="#æœ€å°-cmake-å·¥ç¨‹">æœ€å° CMake å·¥ç¨‹</a></h2>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.20)
project(MyApp
        VERSION 1.0
        LANGUAGES C)
set(SOURCES main.c)
add_executable(MyExe ${SOURCES})
</code></pre>
<p><code>add_executable</code> ç­‰â€œå‡½æ•°â€åœ¨ CMake ä¸­ç§°ä¸º <code>å‘½ä»¤</code>ï¼Œå’Œå‡½æ•°ä¸åŒï¼ŒCMake å‘½ä»¤è™½ç„¶å¯ä»¥ä¼ å…¥å‚æ•°ï¼Œä½†æ˜¯æ— æ³• return ç»“æœç»™è°ƒç”¨è€…ï¼ˆè¿”å›ç»“æœéœ€è¦ä½¿ç”¨å…¶å®ƒæŠ€å·§ï¼‰ã€‚CMake å‘½ä»¤å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œä½†æ˜¯é€šå¸¸ä½¿ç”¨å°å†™ã€‚</p>
<h3 id="cmake_minimum_required"><a class="header" href="#cmake_minimum_required">cmake_minimum_required</a></h3>
<pre><code class="language-cmake">cmake_minimum_required(VERSION major.minor[.patch[.tweak]])
</code></pre>
<p>è¯¥å‘½ä»¤éœ€è¦æ”¾ç½®åœ¨ CMakeLists.txt æ–‡ä»¶çš„ç¬¬ä¸€è¡Œã€‚</p>
<ul>
<li>è¯¥å‘½ä»¤å£°æ˜äº† CMake é¡¹ç›®ä¾èµ–çš„æœ€å°ç‰ˆæœ¬å·ï¼Œç¡®ä¿æŸäº› CMake åŠŸèƒ½åœ¨ç”¨æˆ·çš„ cmake è½¯ä»¶ä¸­æ˜¯å­˜åœ¨çš„</li>
<li>è®¾ç½®é»˜è®¤çš„ CMake ç­–ç•¥ï¼Œä½¿å…¶ä¸æŒ‡å®šçš„ç‰ˆæœ¬å·åŒ¹é…</li>
</ul>
<h3 id="project"><a class="header" href="#project">project</a></h3>
<pre><code class="language-cmake">project(projectName
 [VERSION major[.minor[.patch[.tweak]]]]
 [LANGUAGES languageName ...]
)
</code></pre>
<h2 id="out-of-source-build"><a class="header" href="#out-of-source-build">Out-of-Source Build</a></h2>
<pre><code class="language-bash">mkdir build
cd build
cmake -G "Unix Makefiles" ../source
cmake --build . --config Release --target MyApp
</code></pre>
<p>CMake æ”¯æŒå¤šç§é¡¹ç›®æ–‡ä»¶æ ¼å¼ï¼š</p>
<table>
  <tr>
    <th>Category<br></th>
    <th>Generator Examples</th>
    <th>Multi-config<br></th>
  </tr>
  <tr>
    <td rowspan="3">Visual Studio</td>
    <td>Visual Studio 15 2017</td>
    <td rowspan="3">Yes</td>
  </tr>
  <tr>
    <td>Visual Studio 14 2015</td>
  </tr>
  <tr>
    <td>...</td>
  </tr>
  <tr>
    <td>Xcode</td>
    <td>Xcode</td>
    <td>Yes</td>
  </tr>
  <tr>
    <td>Ninja</td>
    <td>Ninja</td>
    <td>No</td>
  </tr>
  <tr>
    <td rowspan="4">Makefiles</td>
    <td>Unix Makefiles</td>
    <td rowspan="4">No</td>
  </tr>
  <tr>
    <td>MSYS Makefiles</td>
  </tr>
  <tr>
    <td>MinGW Makefiles</td>
  </tr>
  <tr>
    <td>NMake Makefiles<br></td>
  </tr>
</table>
<h2 id="å˜é‡"><a class="header" href="#å˜é‡">å˜é‡</a></h2>
<pre><code class="language-cmake">set(color Green CACHE STRING "Color of folower" FORCE)
set_property(CACHE color PROPERTY STRINGS Red Orange Green)
variable_watch(color)
message(STATUS "Color = ${color}")
message(STATUS "IDF_PATH = $ENV{IDF_PATH}")
message(STATUS "Version = ${PROJECT_VERSION}")
message(STATUS "SrcPath = ${PROJECT_SOURCE_DIR}")
message(STATUS)
set(longStr " ESP8266 ESP32 ESP8089 ")
set(shortStr "ESP")

get_cmake_property(resultVar MACROS)
message(${resultVar})

set_directory_properties(PROPERTIES username "morris")
get_directory_property(resultVar username)
message(${resultVar})

set_property(
 GLOBAL
 PROPERTY FOO
 1
 2
 3)

get_cmake_property(foo_value FOO)
message(STATUS "value of FOO is ${foo_value}")

set(my_list 1 2 3)
set_property(
 DIRECTORY
 PROPERTY FOO
 "${my_list}")

get_property(foo_value DIRECTORY PROPERTY FOO)
message(STATUS "value of FOO is ${foo_value}")
</code></pre>
<h2 id="string-å‘½ä»¤"><a class="header" href="#string-å‘½ä»¤">string å‘½ä»¤</a></h2>
<pre><code class="language-cmake">string(STRIP ${longStr} longStr)
message(${longStr})
string(FIND ${longStr} ${shortStr} outVar)
message(${outVar})
string(FIND ${longStr} ${shortStr} outVar REVERSE)
message(${outVar})
string(REPLACE "ESP" "Espressif" outVar ${longStr})
message(${outVar})
string(REGEX MATCHALL "[0-9]" outVar ${longStr})
message(${outVar})
set(testStr abcdefabcd)
string(REGEX REPLACE "(de)" "X\\1Y" outVar ${testStr})
message(${outVar})
</code></pre>
<h3 id="list-å‘½ä»¤"><a class="header" href="#list-å‘½ä»¤">list å‘½ä»¤</a></h3>
<pre><code class="language-cmake">set(myList a;b;c;def)
message(${myList})
list(LENGTH myList outVar)
message(${outVar})
list(GET myList 3 0 outVar)
message(${outVar})
set(myPaths "/a/b/c" "/b/e" "/a/d" "/b/e")
message(${myPaths})
list(REMOVE_DUPLICATES myPaths)
message(${myPaths})
list(SORT myPaths)
message(${myPaths})

set(tlist "/a;/b;/c")
message(${tlist})
set(tlist "/d;/e" ${tlist})
message(${tlist})
list(APPEND tlist "/f")
message(${tlist})
</code></pre>
<h2 id="æ¡ä»¶åˆ¤æ–­"><a class="header" href="#æ¡ä»¶åˆ¤æ–­">æ¡ä»¶åˆ¤æ–­</a></h2>
<pre><code class="language-cmake">if("/b/e" IN_LIST myPaths)
        message(STATUS "/b/e is in the list")
endif()

set(x 3)
set(y 7)
math(EXPR z "(${x}+${y})/2")
message(${z})

if(x AND ("23" EQUAL 23))
        message("YES")
else()
        message("NO")
endif()

set(who "Morris")
if("Hi from ${who}" MATCHES "Hi from (Morris|Wendy).*")
        message("${CMAKE_MATCH_1} says hello : ${CMAKE_MATCH_0}")
else()
        message("Nobody says hello")
endif()

if(IS_DIRECTORY "/home")
        message("Is Directory")
endif()

if(COMMAND string)
        message("string command exist")
endif()

if(DEFINED ENV{IDF_PATH})
        message("environment IDF_PATH has been defined")
endif()
</code></pre>
<h2 id="å¾ªç¯è¯­å¥"><a class="header" href="#å¾ªç¯è¯­å¥">å¾ªç¯è¯­å¥</a></h2>
<pre><code class="language-cmake">set(list1 A B)
set(list2)
set(foo WillNotBeShown)
foreach(loopVar IN LISTS list1 list2 ITEMS ${foo} bar)
        message("Iteration for: ${loopVar}")
endforeach()

foreach(loopVar RANGE 0 5 1)
        message("${loopVar}")
endforeach()

message("source_dir=${CMAKE_SOURCE_DIR}\r\nbin_dir=${CMAKE_BINARY_DIR}")
message("current_source_dir=${CMAKE_CURRENT_SOURCE_DIR}\r\ncurrent_bin_dir=${CMAKE_CURRENT_BINARY_DIR}")

set(my_value 1)
while(my_value LESS 40)
    message(STATUS "value=${my_value}")
    math(EXPR my_value "${my_value}+1")
endwhile()
</code></pre>
<h2 id="å‡½æ•°"><a class="header" href="#å‡½æ•°">å‡½æ•°</a></h2>
<pre><code class="language-cmake"># ARGN ä»£è¡¨å‰©ä½™çš„å‚æ•°
# ARGV ä»£è¡¨æ‰€æœ‰çš„å‚æ•°
function(func arg)
        message("arg=${arg}")
        message("ARGC=${ARGC}")
        message("ARGV=${ARGV}")
        message("ARGN=${ARGN}")
        if(DEFINED arg)
                message("Function arg is a defined variable")
        else()
                message("Function arg is NOT a defined variable")
        endif()
endfunction()

function(do_cmake_good)
 foreach(arg IN LISTS ARGN)
  message(STATUS "Got argument: ${arg}")
 endforeach()
endfunction()

macro(macr arg)
        message("arg=${arg}")
        message("ARGC=${ARGC}")
        if(DEFINED arg)
                message("Macro arg is a defined variable")
        else()
                message("Macro arg is NOT a defined variable")
        endif()
endmacro()

func(foobar test)
macr(foobar)

function(esp_func)
        set(prefix IDF)
        set(noValues ENABLE_WIFI CONSOLE)
        set(singleValues TARGET)
        set(multiValues SOURCES IMAGES)
        cmake_parse_arguments(${prefix}
                              "${noValues}"
                              "${singleValues}"
                              "${multiValues}"
                              ${ARGN})
        message("Option summary:")
        foreach(arg IN LISTS noValues)
                if(${${prefix}_${arg}})
                        message("${arg} enabled")
                else()
                        message("${arg} disabled")
                endif()
        endforeach()

        foreach(arg IN LISTS singleValues multiValues)
                message("${arg}=${${prefix}_${arg}}")
        endforeach()
endfunction()

esp_func(SOURCES foo.cpp startup.S TARGET esp32 ENABLE_WIFI)
esp_func(CONSOLE TARGET esp8266 IMAGES here.png there.png)

function(myfunc result1 result2)
        set(${result1} "First result" PARENT_SCOPE)
        set(${result2} "Second result" PARENT_SCOPE)
endfunction()

myfunc(res1 res2)
message("result1=${res1}")
message("result2=${res2}")

function(sum out a b)
 math(EXPR ret "${a} + ${b}")
 set("${out}" "${ret}" PARENT_SCOPE)
endfunction()
</code></pre>
<h2 id="include-å‘½ä»¤"><a class="header" href="#include-å‘½ä»¤">include å‘½ä»¤</a></h2>
<pre><code class="language-cmake">include(CMakePrintHelpers)
cmake_print_properties(TARGETS MyExe MyLib PROPERTIES TYPE)
cmake_print_properties(DIRECTORIES "." PROPERTIES username)
cmake_print_variables(tlist CMAKE_VERSION)

include(TestBigEndian)
test_big_endian(isBigEndian)
cmake_print_variables(isBigEndian)

find_package(PythonInterp)
find_package(PythonLibs)
cmake_print_variables(PYTHON_EXECUTABLE)

cmake_print_variables(CMAKE_BUILD_TYPE)
</code></pre>
<h2 id="æœ€ä½³å®æˆ˜"><a class="header" href="#æœ€ä½³å®æˆ˜">æœ€ä½³å®æˆ˜</a></h2>
<ul>
<li>
<p>ä½¿ç”¨ <code>target_xxx</code> ç‰ˆæœ¬çš„ CMake å®</p>
</li>
<li>
<p>æŒ‡å®š <code>property</code> çš„ <code>PUBLIC</code>ï¼Œ<code>PRIVATE</code> æˆ–è€… <code>INTERFACE</code> å±æ€§</p>
</li>
<li>
<p>è·å– <code>target</code> çš„ç¼–è¯‘ <code>flag</code> ä¹‹å‰è¦å…ˆå°†å…¶é“¾æ¥è¿›æ¥</p>
</li>
<li>
<p>è°¨æ…ä½¿ç”¨ä¼šå½±å“æ‰€æœ‰ <code>target</code> çš„å®ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>INCLUDE_DIRECTORIES()</code></li>
<li><code>ADD_DEFINITIONS()</code></li>
<li><code>LINK_LIBRARIES()</code></li>
</ul>
</li>
<li>
<p>ä¸è¦åœ¨ <code>target_include_directories()</code> å¼•ç”¨æ¨¡å—ä¹‹å¤–çš„è·¯å¾„</p>
</li>
<li>
<p>é’ˆå¯¹ä»…ä»…åŒ…å«å¤´æ–‡ä»¶çš„ä¸€äº›åº“ï¼Œå»ºè®®ï¼š</p>
<ul>
<li><code>add_library(mylib INTERFACE)</code></li>
<li><code>target_include_directories(mylib INTERFACE include)</code></li>
<li><code>target_link_libraries(mylib INTERFACE Boost::Boost)</code></li>
</ul>
</li>
<li>
<p>ä¸ºæ¨¡å—æ·»åŠ æ–°çš„ç¼–è¯‘é€‰é¡¹</p>
<pre><code class="language-cmake">target_include_directories(mylib PUBLIC include)
target_include_directories(mylib PRIVATE src)

if(SOME_SETTING)
 target_compile_definitions(mylib
          PUBLIC WITH_SOME_SETTING)
endif()
</code></pre>
</li>
<li>
<p>è®¾ç½®å…¨å±€ç¼–è¯‘é€‰é¡¹</p>
<pre><code class="language-cmake">if(MSVC)
 add_compile_options(/W3 /WX)
else()
 add_compile_options(-W -Wall -Werror)
endif()
</code></pre>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openwrt-åŸºç¡€"><a class="header" href="#openwrt-åŸºç¡€">OpenWRT åŸºç¡€</a></h1>
<h2 id="flash-åˆ†åŒº"><a class="header" href="#flash-åˆ†åŒº">Flash åˆ†åŒº</a></h2>
<p>Linuxç³»ç»Ÿå¯¹é—ªå­˜ç±»å­˜å‚¨å™¨æ˜¯é‡‡ç”¨MTDè®¾å¤‡é©±åŠ¨å®ç°çš„ã€‚</p>
<pre><code class="language-bash">[    0.290000] spi-mt7621 10000b00.spi: sys_freq: 193333333
[    0.300000] m25p80 spi32766.0: w25q256 (32768 Kbytes)
[    0.300000] m25p80 spi32766.0: using chunked io
[    0.310000] 4 ofpart partitions found on MTD device spi32766.0
[    0.310000] Creating 4 MTD partitions on "spi32766.0":
[    0.320000] 0x000000000000-0x000000030000 : "u-boot"
[    0.320000] 0x000000030000-0x000000040000 : "u-boot-env"
[    0.330000] 0x000000040000-0x000000050000 : "factory"
[    0.340000] 0x000000050000-0x000002000000 : "firmware"
[    0.410000] 2 uimage-fw partitions found on MTD device firmware
[    0.410000] 0x000000050000-0x000000168da1 : "kernel"
[    0.420000] 0x000000168da1-0x000002000000 : "rootfs"
[    0.420000] mtd: device 5 (rootfs) set to be root filesystem
[    0.430000] 1 squashfs-split partitions found on MTD device rootfs
[    0.440000] 0x000000620000-0x000002000000 : "rootfs_data"
</code></pre>
<p>::: tip
ç³»ç»Ÿåœ¨SPIè®¾å¤‡ä¸Šåˆ›å»ºäº†4ä¸ªMTDåˆ†åŒº
:::</p>
<div class="table-wrapper"><table><thead><tr><th>åˆ†åŒºå</th><th>åˆ†åŒºä½œç”¨</th></tr></thead><tbody>
<tr><td>u-boot</td><td>å¼•å¯¼ç¨‹åº</td></tr>
<tr><td>u-boot-env</td><td>å¼•å¯¼ç¨‹åºçš„é…ç½®æ•°æ®</td></tr>
<tr><td>factory</td><td>è·¯ç”±å™¨èŠ¯ç‰‡çš„åˆå§‹åŒ–å‚æ•°</td></tr>
<tr><td>firmware</td><td>å›ºä»¶åˆ†åŒº</td></tr>
<tr><td>kernel</td><td>å›ºä»¶åˆ†åŒº<br />Linux å†…æ ¸</td></tr>
<tr><td>rootfs</td><td>å›ºä»¶åˆ†åŒº<br />æ–‡ä»¶ç³»ç»Ÿå­é›†</td></tr>
<tr><td>rootfs_rom</td><td>å›ºä»¶åˆ†åŒº<br />æ–‡ä»¶ç³»ç»Ÿå­é›†<br />åªè¯»åˆ†åŒºå­é›†</td></tr>
<tr><td>rootfs_data</td><td>å›ºä»¶åˆ†åŒº<br />æ–‡ä»¶ç³»ç»Ÿå­é›†<br />å¯å†™åˆ†åŒºå­é›†</td></tr>
</tbody></table>
</div>
<p>::: tip
åˆ†åŒºå­˜åœ¨å­åˆ†åŒºï¼Œkernelå’Œrootfså°±æ˜¯firmwareçš„å­åˆ†åŒºï¼Œrootfs_romå’Œrootfs_dataå°±æ˜¯rootfsçš„å­åˆ†åŒºã€‚
:::</p>
<h3 id="æŸ¥çœ‹ç³»ç»Ÿ-mtd-åˆ†é…"><a class="header" href="#æŸ¥çœ‹ç³»ç»Ÿ-mtd-åˆ†é…">æŸ¥çœ‹ç³»ç»Ÿ MTD åˆ†é…</a></h3>
<pre><code class="language-bash">root@Widora:~# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00030000 00010000 "u-boot"
mtd1: 00010000 00010000 "u-boot-env"
mtd2: 00010000 00010000 "factory"
mtd3: 01fb0000 00010000 "firmware"
mtd4: 00118da1 00010000 "kernel"
mtd5: 01e9725f 00010000 "rootfs"
mtd6: 019e0000 00010000 "rootfs_data"
</code></pre>
<h3 id="æŸ¥çœ‹ç³»ç»Ÿ-mtd-åˆ†é…-1"><a class="header" href="#æŸ¥çœ‹ç³»ç»Ÿ-mtd-åˆ†é…-1">æŸ¥çœ‹ç³»ç»Ÿ MTD åˆ†é…</a></h3>
<pre><code class="language-bash">root@Widora:~# cat /proc/partitions
major   minor  #blocks    name
31       0        192   mtdblock0
31       1         64   mtdblock1
31       2         64   mtdblock2
31       3      32448   mtdblock3
31       4       1123   mtdblock4
31       5      31324   mtdblock5
31       6      26496   mtdblock6
</code></pre>
<h3 id="è¯»å–å¤‡ä»½-factory-åˆ†åŒº"><a class="header" href="#è¯»å–å¤‡ä»½-factory-åˆ†åŒº">è¯»å–/å¤‡ä»½ factory åˆ†åŒº</a></h3>
<p>factory åˆ†åŒºï¼ˆä½äº /dev/mtd2ï¼‰ä¿å­˜äº†é‡è¦çš„é…ç½®å‚æ•°ï¼ˆå¦‚MACåœ°å€ï¼Œå¤©çº¿åŒ¹é…å‚æ•°ç­‰ï¼‰ã€‚</p>
<h4 id="æŸ¥çœ‹åˆ†åŒºå†…å®¹"><a class="header" href="#æŸ¥çœ‹åˆ†åŒºå†…å®¹">æŸ¥çœ‹åˆ†åŒºå†…å®¹</a></h4>
<pre><code class="language-bash">root@Widora:~# hexdump /dev/mtd2
0000000 7628 0001 ef0c d2af b8a9 0000 0000 0000
0000010 ffff ffff ffff ffff ffff ffff ffff ffff
0000020 0000 0000 0020 0000 ef0c d2af b8a9 ef0c
0000030 d2af b9a9 3422 2000 ffff 0100 0000 0000
0000040 0000 0022 0000 0000 0030 0000 0000 0000
0000050 0081 9400 b040 c640 c31a c2c3 c5c0 0027
0000060 ffff ffff ffff ffff ffff ffff ffff ffff
*
00000a0 c6c6 c4c4 c0c4 c4c0 c4c4 c0c4 c0c0 0000
00000b0 ffff ffff ffff ffff ffff ffff ffff ffff
*
00000f0 0000 0000 00d1 8800 0000 0000 0000 0000
0000100 ffff ffff ffff ffff ffff ffff ffff ffff
*
0000120 0000 0000 0000 0000 0000 0000 0000 0077
0000130 1d11 1d11 7f15 7f15 7f17 7f17 3b10 3b10
0000140 ffff ffff ffff ffff ffff ffff ffff ffff
*
0010000
</code></pre>
<h4 id="å¤‡ä»½åˆ†åŒº"><a class="header" href="#å¤‡ä»½åˆ†åŒº">å¤‡ä»½åˆ†åŒº</a></h4>
<p>ä½¿ç”¨ <code>dd</code> å‘½ä»¤å°†åˆ†åŒºè¯»åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨ä¸‹è½½åˆ°æœ¬åœ°ã€‚</p>
<pre><code class="language-bash">root@Widora:~# dd if=/dev/mtd2 of=/www/art.bin
128+0 records in
128+0 records out
root@Widora:~# ls -l /www/art.bin
-rw-r--r--    1 root     root         65536 Apr 27 18:26 /www/art.bin
</code></pre>
<h2 id="æ–‡ä»¶ç³»ç»Ÿ"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</a></h2>
<pre><code class="language-bash">root@Widora:/# df
Filesystem           1K-blocks      Used Available Use% Mounted on
rootfs                   26496       752     25744   3% /
/dev/root                 4864      4864         0 100% /rom
tmpfs                    63232        84     63148   0% /tmp
/dev/mtdblock6           26496       752     25744   3% /overlay
overlayfs:/overlay       26496       752     25744   3% /
tmpfs                      512         0       512   0% /dev
</code></pre>
<ol>
<li>å¼•å¯¼ç¨‹åºå¯åŠ¨å†…æ ¸å®Œæˆåï¼Œç”±å†…æ ¸åŠ è½½ <code>rootfs_rom</code> åªè¯»åˆ†åŒºæ¥å®Œæˆç³»ç»Ÿçš„åˆæ­¥å¯åŠ¨ã€‚<code>rootfs_rom</code> åªè¯»åˆ†åŒºé‡‡ç”¨çš„æ˜¯ Linux å†…æ ¸æ”¯æŒçš„ <strong>squashFS</strong> æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ è½½å®Œæ¯•åå°†å…¶æŒ‚è½½åˆ° <code>/rom</code> ç›®å½•ï¼ŒåŒæ—¶ä¹ŸæŒ‚è½½ä¸º <code>/</code> ç›®å½•ã€‚</li>
<li>ç³»ç»Ÿå°†ä½¿ç”¨ <strong>JFFS2</strong> æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–çš„ <code>rootfs_data</code> å¯å†™æ–‡ä»¶åˆ†åŒºå¹¶å°†è¿™éƒ¨åˆ†æŒ‚è½½åˆ° <code>/overlay</code> ç›®å½•ã€‚</li>
<li>ç³»ç»Ÿå†å°† <code>/overlay</code> é€æ˜æŒ‚è½½ä¸º <code>/</code> æ ¹ç›®å½•ã€‚</li>
<li>æœ€åå°†ä¸€éƒ¨åˆ†å†…å­˜æŒ‚è½½ä¸º<code>/tmp</code> ç›®å½•ã€‚</li>
</ol>
<h3 id="é€æ˜æŒ‚è½½æ ¹ç›®å½•-"><a class="header" href="#é€æ˜æŒ‚è½½æ ¹ç›®å½•-">é€æ˜æŒ‚è½½æ ¹ç›®å½• /</a></h3>
<p>::: tip</p>
<p>OpenWrt è®¾è®¡çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼šç³»ç»Ÿå…ˆå°† <code>rootfs_rom</code> æŒ‚è½½ä¸º <code>/</code> æ ¹ç›®å½•ï¼Œè¿™æ ·å°±å…·å¤‡äº†ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œç„¶åå†å°† <code>rootfs_data</code> ä»¥é€æ˜æ–¹å¼æŒ‚è½½åœ¨ <code>/</code> æ ¹ç›®å½•ä¸Šã€‚</p>
<p>:::</p>
<ul>
<li>æœ€ç»ˆå‘ˆç°çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç”± <code>rootfs_rom</code> å’Œ <code>rootfs_data</code> ä¸¤ä¸ªåˆ†åŒºç»„åˆåœ¨ä¸€èµ·çš„æ•ˆæœã€‚</li>
<li>å¯¹ä»»ä½•æ–‡ä»¶çš„ä¿®æ”¹ï¼ˆå¢ã€åˆ ã€æ”¹ï¼‰éƒ½ä¼šè®°å½•åœ¨ <code>rootfs_data</code> åˆ†åŒºä¸­ã€‚</li>
<li>è¯»å–æ–‡ä»¶å†…å®¹æ—¶ï¼Œé¦–å…ˆæ£€æµ‹ <code>rootfs_data</code> é‡Œçš„çŠ¶æ€ï¼Œå†æ£€æµ‹ <code>roots_rom</code> é‡Œçš„å†…å®¹ï¼Œæœ€åè¾“å‡ºç»“æœã€‚</li>
</ul>
<p>::: warning</p>
<p>å¦‚æœä¿®æ”¹äº†ä¸€ä¸ªåä¸º abc çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨ <code>/rom</code> é‡Œè¿˜ä¼šä¿ç•™ä¿®æ”¹ä¹‹å‰çš„é‚£ä¸ª abc æ–‡ä»¶ï¼ŒåŒæ—¶åœ¨ <code>/overlay</code> é‡Œæœ‰ä¿®æ”¹åçš„ abc æ–‡ä»¶ï¼Œå› æ­¤æ‰€å çš„ç©ºé—´å°†ä¼šå€å¢ã€‚è¿™æ ·å¸¦æ¥çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œåªè¦åˆ é™¤ <code>/overlay</code> é‡Œæ‰€æœ‰çš„æ–‡ä»¶ï¼Œå°±èƒ½è¾¾åˆ°æ¢å¤å‡ºå‚çš„æ•ˆæœã€‚</p>
<p>:::</p>
<h3 id="å¸¸ç”¨æ–‡ä»¶å¤¹"><a class="header" href="#å¸¸ç”¨æ–‡ä»¶å¤¹">å¸¸ç”¨æ–‡ä»¶å¤¹</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æ–‡ä»¶å¤¹è·¯å¾„</th><th>ä½œç”¨</th></tr></thead><tbody>
<tr><td>/etc/</td><td>å­˜æ”¾ç³»ç»Ÿæ‰€æœ‰çš„é…ç½®æ–‡ä»¶</td></tr>
<tr><td>/etc/init.d/</td><td>å­˜æ”¾å¯åŠ¨çš„æœåŠ¡è„šæœ¬</td></tr>
<tr><td>/etc/config/</td><td>å­˜æ”¾ OpenWrt çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç½‘ç»œ</td></tr>
<tr><td>/tmp/</td><td>å­˜æ”¾ä¸´æ—¶æ–‡ä»¶å’ŒåŠ¨æ€çš„é…ç½®æ–‡ä»¶</td></tr>
<tr><td>/tmp/TZ</td><td>ç³»ç»Ÿå¯åŠ¨åæ‰€ä½¿ç”¨çš„æ—¶åŒºå‚æ•°</td></tr>
</tbody></table>
</div>
<h2 id="è½¯ä»¶åŒ…ç®¡ç†å™¨-opkg"><a class="header" href="#è½¯ä»¶åŒ…ç®¡ç†å™¨-opkg">è½¯ä»¶åŒ…ç®¡ç†å™¨ OPKG</a></h2>
<h3 id="é…ç½®-opkg"><a class="header" href="#é…ç½®-opkg">é…ç½® OPKG</a></h3>
<p><code>/etc/opkg.conf</code> æ–‡ä»¶ä¿å­˜ OPKG ç›¸å…³è®¾ç½®ï¼š</p>
<pre><code class="language-bash">root@Widora:/# cat /etc/opkg.conf
dest root /
dest ram /tmp
lists_dir ext /var/opkg-lists
option overlay_root /overlay
option check_signature 1
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>é…ç½®é€‰é¡¹</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>dest root</td><td>å®‰è£…ç›®æ ‡çš„è·Ÿè·¯å¾„</td></tr>
<tr><td>dest ram</td><td>å†…å­˜ä¸´æ—¶æ–‡ä»¶è·¯å¾„</td></tr>
<tr><td>lists_dir ext</td><td>è½¯ä»¶åŒ…åˆ—è¡¨æ–‡ä»¶</td></tr>
<tr><td>option overlay_root</td><td>å¯å†™åˆ†åŒºæŒ‚è½½ä½ç½®</td></tr>
</tbody></table>
</div>
<h3 id="å¸¸ç”¨å‘½ä»¤æ­é…"><a class="header" href="#å¸¸ç”¨å‘½ä»¤æ­é…">å¸¸ç”¨å‘½ä»¤æ­é…</a></h3>
<div class="table-wrapper"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>opkg update</td><td>ä¸‹è½½æœåŠ¡å™¨ä¸Šå¯ç”¨çš„è½¯ä»¶åŒ…åˆ—è¡¨</td></tr>
<tr><td>opkg upgrade &lt;package&gt;</td><td>å‡çº§è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg install &lt;package&gt;</td><td>å®‰è£…è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg configure &lt;package&gt;</td><td>é…ç½®æŸä¸€ä¸ªè½¯ä»¶åŒ…</td></tr>
<tr><td>opkg remove &lt;package&gt;</td><td>å¸è½½è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg list</td><td>åˆ—å‡ºå…¨éƒ¨å¯ç”¨çš„è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg list-installed</td><td>åˆ—å‡ºå·²å®‰è£…çš„è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg list-upgradable</td><td>åˆ—å‡ºå¯ä»¥å‡çº§çš„è½¯ä»¶åŒ…</td></tr>
<tr><td>opkg info [package|regexp]</td><td>æ˜¾ç¤ºæŒ‡å®šè½¯ä»¶åŒ…çš„ä¿¡æ¯</td></tr>
<tr><td>opkg status [package|regexp]</td><td>æ˜¾ç¤ºæŒ‡å®šè½¯ä»¶åŒ…çš„çŠ¶æ€</td></tr>
<tr><td>opkg download &lt;package&gt;</td><td>ä¸‹è½½ä¸€ä¸ªè½¯ä»¶åŒ…åˆ°å½“å‰ç›®å½•ï¼Œä½†ä¸å®‰è£…</td></tr>
</tbody></table>
</div>
<p>::: tip</p>
<p>è½¯ä»¶åŒ…åˆ—è¡¨å¯èƒ½ä¼šæ¯”è¾ƒå¤§ï¼Œå› æ­¤å¹¶ä¸ä¿å­˜åœ¨ç³»ç»Ÿä¸­ï¼Œæ¯æ¬¡å¯åŠ¨éœ€è¦é¦–å…ˆæ‰§è¡Œ <code>opkg update</code> å–å¾—æœ€æ–°çš„è½¯ä»¶åŒ…ã€‚</p>
<p>:::</p>
<pre><code class="language-bash">root@Widora:/# opkg update
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/base/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_base.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/base/Packages.sig.
Signature check passed.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/luci/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_luci.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/luci/Packages.sig.
Signature check passed.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/management/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_management.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/management/Packages.sig.
Signature check passed.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/packages/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_packages.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/packages/Packages.sig.
Signature check passed.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/routing/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_routing.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/routing/Packages.sig.
Signature check passed.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/telephony/Packages.gz.
Updated list of available packages in /var/opkg-lists/chaos_calmer_telephony.
Downloading http://downloads.openwrt.org/chaos_calmer/15.05.1/ramips/mt7688/packages/telephony/Packages.sig.
Signature check passed.
</code></pre>
<h2 id="uci-å‘½ä»¤ç³»ç»Ÿ"><a class="header" href="#uci-å‘½ä»¤ç³»ç»Ÿ">UCI å‘½ä»¤ç³»ç»Ÿ</a></h2>
<p>UCI (Unified Configuration Interface) æ˜¯ OpenWrt ä¸­é…ç½®å‚æ•°ç®¡ç†ç³»ç»Ÿï¼ŒUCI ä¸­å·²ç»åŒ…å«äº†ç½‘ç»œé…ç½®ã€æ— çº¿é…ç½®ã€ç³»ç»Ÿä¿¡æ¯é…ç½®ç­‰åŸºæœ¬è·¯ç”±å™¨æ‰€éœ€çš„ä¸»è¦é…ç½®å‚æ•°ã€‚</p>
<p>UCI é…ç½®æ–‡ä»¶å…¨éƒ¨å­˜å‚¨åœ¨ <code>/etc/config</code> ç›®å½•ä¸‹ï¼š</p>
<pre><code class="language-bash">root@Widora:/# ls /etc/config/
dhcp           fstab          mountd         shairport      uhttpd
dropbear       luci           network        system         wireless
firewall       mjpg-streamer  rpcd           ucitrack
</code></pre>
<p>å¸¸è§çš„ UCI é…ç½®ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>é…ç½®æ–‡ä»¶</th><th>ä½œç”¨</th></tr></thead><tbody>
<tr><td>/etc/config/dhcp</td><td>é¢å‘ LAN å£æä¾›çš„ IP åœ°å€åˆ†é…æœåŠ¡é…ç½®</td></tr>
<tr><td>/etc/config/dropbear</td><td>SSH æœåŠ¡é…ç½®</td></tr>
<tr><td>/etc/config/firewall</td><td>è·¯ç”±è½¬å‘ï¼Œç«¯å£è½¬å‘ï¼Œé˜²ç«å¢™è§„åˆ™</td></tr>
<tr><td>/etc/config/network</td><td>è‡ªèº«ç½‘ç»œæ¥å£é…ç½®</td></tr>
<tr><td>/etc/config/system</td><td>æ—¶é—´æœåŠ¡å™¨æ—¶åŒºé…ç½®</td></tr>
<tr><td>/etc/config/wireless</td><td>æ— çº¿ç½‘ç»œé…ç½®</td></tr>
</tbody></table>
</div>
<p>æ”¯æŒ UCI ç®¡ç†æ¨¡å¼çš„è½¯ä»¶åŒ…æ˜¯è¿™æ ·å®Œæˆå¯åŠ¨çš„ï¼ˆä»¥ <strong>samba</strong> è½¯ä»¶ä¸ºä¾‹ï¼‰ï¼š</p>
<ol>
<li>å¯åŠ¨è„šæœ¬ <code>/etc/init.d/samba</code></li>
<li>å¯åŠ¨è„šæœ¬é€šè¿‡ UCI åˆ†æåº“ä» <code>/etc/config/samba</code> è·å¾—å¯åŠ¨å‚æ•°</li>
<li>å¯åŠ¨è„šæœ¬å®Œæˆæ­£å¸¸å¯åŠ¨</li>
</ol>
<p>::: warning</p>
<p>UCI é…ç½®æ–‡ä»¶æ—¢å¯ä»¥ä½¿ç”¨ UCI å‘½ä»¤è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ç›´æ¥ä¿®æ”¹ã€‚ä½†å¦‚æœä¸¤ç§æ–¹å¼éƒ½ä½¿ç”¨ï¼Œéœ€è¦æ³¨æ„ UCI å‘½ä»¤ä¿®æ”¹ä¼šäº§ç”Ÿç¼“å­˜ï¼Œæ¯æ¬¡ä¿®æ”¹å¥½è¦å°½å¿«ä¿å­˜ç¡®è®¤ï¼Œä»¥å…å‡ºç°å†²çªã€‚</p>
<p>:::</p>
<h3 id="uci-æ–‡ä»¶æ ¼å¼"><a class="header" href="#uci-æ–‡ä»¶æ ¼å¼">UCI æ–‡ä»¶æ ¼å¼</a></h3>
<pre><code>config 'section-type' 'section'
	option 'key' 'value'
	option 'list_key' 'list_value1'
	option 'list_key' 'list_value2'
</code></pre>
<p>::: tip</p>
<p>UCI å…è®¸åªæœ‰ <strong>section-type</strong> çš„åŒ¿åé…ç½®èŠ‚ç‚¹ã€‚</p>
<p>:::</p>
<h3 id="uci-å‘½ä»¤è¯»å†™é…ç½®"><a class="header" href="#uci-å‘½ä»¤è¯»å†™é…ç½®">UCI å‘½ä»¤è¯»å†™é…ç½®</a></h3>
<pre><code class="language-bash">uci [&lt;option&gt;] &lt;command&gt; [&lt;arguments&gt;]
</code></pre>
<h4 id="è¯»å–ç±»è¯­æ³•"><a class="header" href="#è¯»å–ç±»è¯­æ³•">è¯»å–ç±»è¯­æ³•</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>uci get &lt;config&gt;.&lt;section&gt;</td><td>è·å–èŠ‚ç‚¹ç±»å‹</td></tr>
<tr><td>uci get &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</td><td>è·å–å–å¾—ä¸€ä¸ªå€¼</td></tr>
<tr><td>uci show</td><td>æ˜¾ç¤ºå…¨éƒ¨ UCI é…ç½®</td></tr>
<tr><td>uci show &lt;config&gt;</td><td>æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶é…ç½®</td></tr>
<tr><td>uci show &lt;config&gt;.&lt;section&gt;</td><td>æ˜¾ç¤ºæŒ‡å®šèŠ‚ç‚¹çš„é…ç½®</td></tr>
<tr><td>uci show &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</td><td>æ˜¾ç¤ºæŒ‡å®šé€‰é¡¹é…ç½®</td></tr>
<tr><td>uci changes &lt;config&gt;</td><td>æ˜¾ç¤ºå°šæœªç”Ÿæ•ˆçš„ä¿®æ”¹è®°å½•</td></tr>
<tr><td>uci show -X &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</td><td>æ˜¾ç¤ºåŒ¿åèŠ‚ç‚¹</td></tr>
</tbody></table>
</div>
<h4 id="å†™å…¥ç±»è¯­æ³•"><a class="header" href="#å†™å…¥ç±»è¯­æ³•">å†™å…¥ç±»è¯­æ³•</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>uci add &lt;config&gt; &lt;section-type&gt;</td><td>å¢åŠ ä¸€ä¸ªåŒ¿åèŠ‚ç‚¹</td></tr>
<tr><td>uci set &lt;config&gt;.&lt;section&gt; = &lt;section-type&gt;</td><td>å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹/ä¿®æ”¹èŠ‚ç‚¹ç±»å‹</td></tr>
<tr><td>uci set &lt;config&gt;.&lt;section&gt;.&lt;option&gt; = &lt;value&gt;</td><td>å¢åŠ ä¸€ä¸ªé€‰é¡¹å€¼/ä¿®æ”¹ä¸€ä¸ªé€‰é¡¹å€¼</td></tr>
<tr><td>uci add_list &lt;config&gt;.&lt;section&gt;.&lt;option&gt; = &lt;value&gt;</td><td>åœ¨åˆ—è¡¨ä¸­å¢åŠ ä¸€ä¸ªå€¼</td></tr>
<tr><td>uci delete &lt;config&gt;.&lt;section&gt;</td><td>åˆ é™¤æŒ‡å®šèŠ‚ç‚¹</td></tr>
<tr><td>uci delete &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</td><td>åˆ é™¤æŒ‡å®šé€‰é¡¹</td></tr>
<tr><td>uci delete &lt;config&gt;.&lt;section&gt;.&lt;list&gt;</td><td>åˆ é™¤åˆ—è¡¨</td></tr>
<tr><td>uci del_list &lt;config&gt;.&lt;section&gt;.&lt;option&gt; = &lt;string&gt;</td><td>åˆ é™¤åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå€¼</td></tr>
<tr><td>uci commit &lt;config&gt;</td><td>ä½¿ä¿®æ”¹ç”Ÿæ•ˆ</td></tr>
</tbody></table>
</div>
<p>::: warning</p>
<p>UCI è¯»å–æ€»æ˜¯å…ˆè¯»å–å†…å­˜ä¸­çš„ç¼“å­˜ï¼Œç„¶åå†è¯»å–æ–‡ä»¶ä¸­çš„ã€‚è¿›è¡Œè¿‡å¢åˆ æ”¹æ“ä½œåè¦æ‰§è¡Œç”Ÿæ•ˆæŒ‡ä»¤ï¼Œå¦åˆ™æ‰€æœ‰çš„ä¿®æ”¹åªç•™å­˜åœ¨ç¼“å­˜ä¸­ã€‚</p>
<p>:::</p>
<h2 id="å¸¸ç”¨é…ç½®æ“ä½œ"><a class="header" href="#å¸¸ç”¨é…ç½®æ“ä½œ">å¸¸ç”¨é…ç½®æ“ä½œ</a></h2>
<h3 id="æŸ¥çœ‹-system-é…ç½®"><a class="header" href="#æŸ¥çœ‹-system-é…ç½®">æŸ¥çœ‹ system é…ç½®</a></h3>
<pre><code class="language-bash">root@Widora:/# cat /etc/config/system
config system
	option hostname	Widora
	option timezone	CST-8

config timeserver ntp
	list server	0.openwrt.pool.ntp.org
	list server	1.openwrt.pool.ntp.org
	list server	2.openwrt.pool.ntp.org
	list server	3.openwrt.pool.ntp.org
	option enabled 1
	option enable_server 0
root@Widora:/# uci show system
system.@system[0]=system
system.@system[0].hostname='Widora'
system.@system[0].timezone='CST-8'
system.ntp=timeserver
system.ntp.server='0.openwrt.pool.ntp.org' '1.openwrt.pool.ntp.org' '2.openwrt.pool.ntp.org' '3.openwrt.pool.ntp.org'
system.ntp.enabled='1'
system.ntp.enable_server='0'
</code></pre>
<h3 id="æŸ¥çœ‹ç½‘ç»œé…ç½®"><a class="header" href="#æŸ¥çœ‹ç½‘ç»œé…ç½®">æŸ¥çœ‹ç½‘ç»œé…ç½®</a></h3>
<pre><code class="language-bash">root@Widora:/# cat /etc/config/network

config interface 'loopback'
	option ifname 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix 'fdff:c5b2:821c::/48'

config interface 'lan'
	option force_link '1'
	option macaddr '0c:ef:af:d2:a9:b9'
	option type 'bridge'
	option proto 'static'
	option ipaddr '192.168.8.1'
	option netmask '255.255.255.0'
	option ip6assign '60'
	option ifname 'eth0.1'

config interface 'wan'
	option force_link '1'
	option macaddr '0c:ef:af:d2:a9:b8'
	option proto 'dhcp'
	option ifname 'eth0.2'

config interface 'wan6'
	option proto 'dhcpv6'
	option ifname 'eth0.2'

config switch
	option name 'switch0'
	option reset '1'
	option enable_vlan '1'

config switch_vlan
	option device 'switch0'
	option vlan '1'
	option ports '1 2 3 4 6t'

config switch_vlan
	option device 'switch0'
	option vlan '2'
	option ports '0 6t'
</code></pre>
<h3 id="é‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ"><a class="header" href="#é‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ">é‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ</a></h3>
<pre><code class="language-bash">root@Widora:~# /etc/init.d/network restart
</code></pre>
<h3 id="å¼€å¯-wi-fi"><a class="header" href="#å¼€å¯-wi-fi">å¼€å¯ Wi-Fi</a></h3>
<pre><code class="language-bash">uci set wireless.radio0.disabled=0 # ä½¿èƒ½ Wi-Fi
uci commit wireless # ä½¿é…ç½®ç”Ÿæ•ˆ
wifi # å¯åŠ¨ Wi-Fi
</code></pre>
<h3 id="æŸ¥çœ‹å½“å‰ç½‘ç»œ"><a class="header" href="#æŸ¥çœ‹å½“å‰ç½‘ç»œ">æŸ¥çœ‹å½“å‰ç½‘ç»œ</a></h3>
<pre><code class="language-bash">root@Widora:/# ifconfig
br-lan    Link encap:Ethernet  HWaddr 0C:EF:AF:D2:A9:B9
          inet addr:192.168.8.1  Bcast:192.168.8.255  Mask:255.255.255.0
          inet6 addr: fe80::eef:afff:fed2:a9b9/64 Scope:Link
          inet6 addr: fdff:c5b2:821c::1/60 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:574264 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1217669 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:48102567 (45.8 MiB)  TX bytes:1634912136 (1.5 GiB)

eth0      Link encap:Ethernet  HWaddr 0C:EF:AF:D2:A9:B8
          inet6 addr: fe80::eef:afff:fed2:a9b8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1225320 errors:0 dropped:0 overruns:0 frame:0
          TX packets:579507 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1641989813 (1.5 GiB)  TX bytes:59132909 (56.3 MiB)
          Interrupt:5

eth0.1    Link encap:Ethernet  HWaddr 0C:EF:AF:D2:A9:B8
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1 errors:0 dropped:1 overruns:0 frame:0
          TX packets:3544 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:46 (46.0 B)  TX bytes:244206 (238.4 KiB)

eth0.2    Link encap:Ethernet  HWaddr 0C:EF:AF:D2:A9:B8
          inet addr:192.168.1.5  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::eef:afff:fed2:a9b8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1176423 errors:0 dropped:10706 overruns:0 frame:0
          TX packets:575928 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:1617670919 (1.5 GiB)  TX bytes:56565373 (53.9 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:294 errors:0 dropped:0 overruns:0 frame:0
          TX packets:294 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:41961 (40.9 KiB)  TX bytes:41961 (40.9 KiB)

ra0       Link encap:Ethernet  HWaddr 0C:EF:AF:D2:A9:B8
          inet6 addr: fe80::eef:afff:fed2:a9b8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:641847 errors:830 dropped:0 overruns:0 frame:0
          TX packets:1228723 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:70965355 (67.6 MiB)  TX bytes:1630822247 (1.5 GiB)
          Interrupt:6
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>ç½‘ç»œè®¾å¤‡å</th><th>è¯´æ˜</th></tr></thead><tbody>
<tr><td>br-lan</td><td>è™šæ‹Ÿè®¾å¤‡ï¼ŒLAN å£æ¡¥æ¥è®¾å¤‡ï¼ŒåŒ…å«é€šè¿‡ LAN å£å’Œ WAN å£è¿å…¥ç³»ç»Ÿçš„è®¾å¤‡ç»Ÿä¸€æ¡¥æ¥</td></tr>
<tr><td>eth0</td><td>çœŸå®è®¾å¤‡ï¼ŒCPU å†…éƒ¨åˆ°äº¤æ¢æœºèŠ¯ç‰‡ä¹‹é—´åªæœ‰ä¸€ä¸ªæ¥å£</td></tr>
<tr><td>eth0.1</td><td>è™šæ‹Ÿè®¾å¤‡ï¼Œç”± VLAN åˆ’åˆ†çš„æœ‰çº¿çš„ LAN å£ï¼ŒVLAN ç¼–å·ä¸º 1</td></tr>
<tr><td>eth0.2</td><td>è™šæ‹Ÿè®¾å¤‡ï¼Œç”± VLAN åˆ’åˆ†çš„æœ‰çº¿çš„ LAN å£ï¼ŒVLANç¼–å·ä¸º 2</td></tr>
<tr><td>lo</td><td>è™šæ‹Ÿè®¾å¤‡ï¼Œå›ç¯è®¾å¤‡</td></tr>
<tr><td>ra0</td><td>çœŸå®è®¾å¤‡ï¼Œå¯åŠ¨ Wi-Fi åå°†ä¼šäº§ç”Ÿæ­¤æ— çº¿è®¾å¤‡</td></tr>
<tr><td>pppoe-wan</td><td>è™šæ‹Ÿè®¾å¤‡ï¼Œæ˜¯ PPPoE æ‹¨å·ä¸Šç½‘æˆåŠŸåäº§ç”Ÿçš„</td></tr>
</tbody></table>
</div>
<h3 id="æŸ¥çœ‹-br-lan-æ¡¥çŠ¶æ€"><a class="header" href="#æŸ¥çœ‹-br-lan-æ¡¥çŠ¶æ€">æŸ¥çœ‹ br-lan æ¡¥çŠ¶æ€</a></h3>
<pre><code class="language-bash">root@Widora:/# brctl show
bridge name	bridge id			STP enabled	interfaces
br-lan		7fff.0cefafd2a9b9	no			eth0.1
											ra0
</code></pre>
<h3 id="æŸ¥çœ‹å†…æ ¸æ—¥å¿—"><a class="header" href="#æŸ¥çœ‹å†…æ ¸æ—¥å¿—">æŸ¥çœ‹å†…æ ¸æ—¥å¿—</a></h3>
<pre><code class="language-bash">root@Widora:/# logread
</code></pre>
<h3 id="æŸ¥çœ‹å½“å‰-vlan-åˆ’åˆ†"><a class="header" href="#æŸ¥çœ‹å½“å‰-vlan-åˆ’åˆ†">æŸ¥çœ‹å½“å‰ VLAN åˆ’åˆ†</a></h3>
<pre><code class="language-bash">root@Widora:/# swconfig dev switch0 show
Global attributes:
	enable_vlan: 1
	alternate_vlan_disable: 0
	bc_storm_protect: 0
	led_frequency: 0
Port 0:
	disable: 0
	doubletag: 0
	untag: 1
	led: 5
	lan: 1
	recv_bad: 0
	recv_good: 2205
	tr_bad: 0
	tr_good: 52155
	pvid: 2
	link: port:0 link:up speed:100baseT full-duplex
Port 1:
	disable: 0
	doubletag: 0
	untag: 1
	led: 5
	lan: 1
	recv_bad: 0
	recv_good: 0
	tr_bad: 0
	tr_good: 0
	pvid: 1
	link: port:1 link:down
Port 2:
	disable: 0
	doubletag: 0
	untag: 1
	led: 5
	lan: 1
	recv_bad: 0
	recv_good: 0
	tr_bad: 0
	tr_good: 0
	pvid: 1
	link: port:2 link:down
Port 3:
	disable: 0
	doubletag: 0
	untag: 1
	led: 5
	lan: 1
	recv_bad: 0
	recv_good: 0
	tr_bad: 0
	tr_good: 0
	pvid: 1
	link: port:3 link:down
Port 4:
	disable: 0
	doubletag: 0
	untag: 1
	led: 5
	lan: 1
	recv_bad: 0
	recv_good: 0
	tr_bad: 0
	tr_good: 0
	pvid: 1
	link: port:4 link:down
Port 5:
	disable: 1
	doubletag: 0
	untag: 0
	led: ???
	lan: 1
	recv_bad: 0
	recv_good: 0
	tr_bad: 0
	tr_good: 0
	pvid: 0
	link: port:5 link:down
Port 6:
	disable: 0
	doubletag: 0
	untag: 0
	led: ???
	lan: ???
	recv_bad: ???
	recv_good: ???
	tr_bad: ???
	tr_good: ???
	pvid: 0
	link: port:6 link:up speed:1000baseT full-duplex
VLAN 1:
	ports: 1 2 3 4 6t
VLAN 2:
	ports: 0 6t
</code></pre>
<p>::: tip</p>
<p>å“ªä¸ªç½‘å£æ˜¯ LANï¼Œ å“ªä¸ªæ˜¯ WANï¼Œ æ˜¯ç”± VLAN åˆ’åˆ†çš„ã€‚VLAN1 ä¸º LAN å£ï¼ŒåŒ…å« 1ã€2ã€3ã€4 æ¥å£ï¼›VLAN2 ä¸º WAN å£ï¼ŒåŒ…å«äº† 0 æ¥å£ã€‚</p>
<p>:::</p>
<h3 id="é…ç½®-wan-å£å¤–ç½‘"><a class="header" href="#é…ç½®-wan-å£å¤–ç½‘">é…ç½® WAN å£å¤–ç½‘</a></h3>
<h4 id="æŸ¥çœ‹-wan-å£é…ç½®"><a class="header" href="#æŸ¥çœ‹-wan-å£é…ç½®">æŸ¥çœ‹ WAN å£é…ç½®</a></h4>
<pre><code class="language-bash">root@Widora:/# uci show network.wan
network.wan=interface
network.wan.force_link='1'
network.wan.macaddr='0c:ef:af:d2:a9:b8'
network.wan.proto='dhcp'
network.wan.ifname='eth0.2'
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼</th></tr></thead><tbody>
<tr><td>ifname</td><td>è®¾å¤‡æ¥å£å</td><td>eth0.2</td></tr>
<tr><td>proto</td><td>åè®®ç±»å‹</td><td>staticï¼šé™æ€ IP åœ°å€<br />dhcpï¼šåŠ¨æ€è·å– IP åœ°å€<br />pppoeï¼šæ‹¨å·ä¸Šç½‘<br />pptpï¼šè¿œç¨‹ VPN æœåŠ¡å™¨<br />3gï¼šè¿æ¥ 3G/4G æ— çº¿ç”µè¯ç½‘ç»œ</td></tr>
<tr><td>macaddr</td><td>WAN å£ MAC åœ°å€ï¼Œä¿®æ”¹è¯¥åœ°å€å³å¯å®ç° MAC åœ°å€å…‹éš†</td><td>é¦–æ¬¡æ•°æ®æ ¹æ® factory åˆ†åŒºå†…å‚æ•°è‡ªåŠ¨ç”Ÿæˆ</td></tr>
</tbody></table>
</div>
<h4 id="åŠ¨æ€è·å–-ip-é€‰é¡¹"><a class="header" href="#åŠ¨æ€è·å–-ip-é€‰é¡¹">åŠ¨æ€è·å– IP é€‰é¡¹</a></h4>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>proto</td><td>åè®®ç±»å‹</td><td>dhcp</td></tr>
<tr><td>ifname</td><td>è®¾å¤‡åç§°</td><td>eth0.2</td></tr>
<tr><td>macaddr</td><td>MAC åœ°å€</td><td>æ ¹æ® factory åˆ†åŒºè‡ªåŠ¨ç”Ÿæˆçš„å€¼</td></tr>
<tr><td>mtu</td><td>æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œé»˜è®¤ä¸ç”¨è®¾ç½®</td><td>æ•°å€¼</td></tr>
<tr><td>reqopts</td><td>åœ¨å‘ DHCP æœåŠ¡å™¨å‘å‡ºè¯·æ±‚æ—¶å¢åŠ é™„åŠ çš„ DHCP ä¿¡æ¯</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>dns</td><td>ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨åœ°å€æ›¿ä»£è·å¾—çš„ DNS</td><td>å­—ç¬¦ä¸²</td></tr>
</tbody></table>
</div>
<h4 id="æŒ‡å®šé™æ€-ip-é€‰é¡¹"><a class="header" href="#æŒ‡å®šé™æ€-ip-é€‰é¡¹">æŒ‡å®šé™æ€ IP é€‰é¡¹</a></h4>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>proto</td><td>åè®®ç±»å‹</td><td>static</td></tr>
<tr><td>ifname</td><td>è®¾å¤‡åç§°</td><td>eth0.2</td></tr>
<tr><td>macaddr</td><td>MAC åœ°å€</td><td>æ ¹æ® factory åˆ†åŒºè‡ªåŠ¨ç”Ÿæˆçš„å€¼</td></tr>
<tr><td>mtu</td><td>æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œé»˜è®¤ä¸ç”¨è®¾ç½®</td><td>æ•°å€¼</td></tr>
<tr><td>ipaddr</td><td>WAN å£çš„ IP åœ°å€</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>netmask</td><td>WAN å£çš„å­ç½‘æ©ç </td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>gateway</td><td>é»˜è®¤ç½‘å…³</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>broadcast</td><td>å¹¿æ’­åœ°å€</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>dns</td><td>ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨åœ°å€æ›¿ä»£è·å¾—çš„ DNS</td><td>å­—ç¬¦ä¸²</td></tr>
</tbody></table>
</div>
<h4 id="pppoe-æ‹¨å·ä¸Šç½‘é€‰é¡¹"><a class="header" href="#pppoe-æ‹¨å·ä¸Šç½‘é€‰é¡¹">PPPOE æ‹¨å·ä¸Šç½‘é€‰é¡¹</a></h4>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>proto</td><td>åè®®ç±»å‹</td><td>pppoe</td></tr>
<tr><td>ifname</td><td>è®¾å¤‡åç§°</td><td>eth0.2</td></tr>
<tr><td>macaddr</td><td>MAC åœ°å€</td><td>æ ¹æ® factory åˆ†åŒºè‡ªåŠ¨ç”Ÿæˆçš„å€¼</td></tr>
<tr><td>mtu</td><td>æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œé»˜è®¤ä¸ç”¨è®¾ç½®</td><td>æ•°å€¼</td></tr>
<tr><td>username</td><td>æ‹¨å·ä½¿ç”¨çš„å¸å·</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>password</td><td>æ‹¨å·ä½¿ç”¨çš„å¯†ç </td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>ac</td><td>ä½¿ç”¨æŒ‡å®šçš„è®¿é—®é›†ä¸­å™¨è¿›è¡Œè¿æ¥</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>service</td><td>è¿æ¥çš„æœåŠ¡åç§°</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>connect</td><td>è¿æ¥æ—¶å€™æ‰§è¡Œçš„å¤–éƒ¨è„šæœ¬</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>disconnect</td><td>æ–­å¼€è¿æ¥æ—¶æ‰§è¡Œçš„å¤–éƒ¨è„šæœ¬</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>demand</td><td>ç­‰å¾…å¤šä¹…æ²¡æœ‰æ´»åŠ¨å°±æ–­å¼€ PPPOE è¿æ¥</td><td>æ•°å­—ï¼Œå•ä½ç§’</td></tr>
<tr><td>dns</td><td>DNS æœåŠ¡å™¨åœ°å€</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>pppd_options</td><td>ç”¨äº pppd è¿›ç¨‹æ‰§è¡Œæ—¶å€™çš„é™„åŠ å‚æ•°</td><td>å­—ç¬¦ä¸²</td></tr>
</tbody></table>
</div>
<h3 id="é…ç½®-lan-å£æœåŠ¡"><a class="header" href="#é…ç½®-lan-å£æœåŠ¡">é…ç½® LAN å£æœåŠ¡</a></h3>
<p>::: tip</p>
<p>LAN å£ä¸‹çš„è®¾å¤‡å¯ä»¥é€šè¿‡ WAN å£æ¥å…¥ç½‘ç»œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®è®¾å¤‡ä¸Šçš„å„é¡¹åŠŸèƒ½ï¼ˆç³»ç»Ÿé˜²ç«å¢™å¯¹ LAN å£é»˜è®¤ä¸åšä»»ä½•æ‹¦æˆªï¼‰ã€‚</p>
<p>:::</p>
<h4 id="æŸ¥çœ‹-lan-å£é…ç½®"><a class="header" href="#æŸ¥çœ‹-lan-å£é…ç½®">æŸ¥çœ‹ LAN å£é…ç½®</a></h4>
<pre><code class="language-bash">root@Widora:~# uci show network.lan
network.lan=interface
network.lan.force_link='1'
network.lan.macaddr='0c:ef:af:d2:a9:b9'
network.lan.type='bridge'
network.lan.proto='static'
network.lan.ipaddr='192.168.8.1'
network.lan.netmask='255.255.255.0'
network.lan.ip6assign='60'
network.lan.ifname='eth0.1'
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>ifname</td><td>è®¾å¤‡åç§°</td><td>eth0.1</td></tr>
<tr><td>proto</td><td>åè®®ç±»å‹</td><td>static</td></tr>
<tr><td>macaddr</td><td>MAC åœ°å€</td><td>æ ¹æ® factory åˆ†åŒºè‡ªåŠ¨ç”Ÿæˆçš„å€¼</td></tr>
<tr><td>type</td><td>ç½‘ç»œç±»å‹</td><td>bridgeï¼Œæ¡¥æ¨¡å¼ï¼ˆè¿™æ ·æ‰æœ‰äº¤æ¢æœºåŠŸèƒ½ï¼‰</td></tr>
<tr><td>ipaddr</td><td>LAN å£çš„ IP åœ°å€ï¼Œç”¨äºå±€åŸŸç½‘å†…å…¶å®ƒè®¾å¤‡è®¿é—®è·¯ç”±å™¨</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>netmask</td><td>LAN å£çš„å­ç½‘æ©ç </td><td>å­—ç¬¦ä¸²</td></tr>
</tbody></table>
</div>
<p>::: warning</p>
<p>ä¿®æ”¹è¿‡ LAN å£çš„é…ç½®åè¦é‡å¯ç½‘ç»œä»¥åŠ DHCP æœåŠ¡ã€‚</p>
<pre><code class="language-bash">root@Widora:~# /etc/init.d/network restart
root@Widora:~# /etc/odhcpd restart
</code></pre>
<p>:::</p>
<h3 id="é…ç½®æ— çº¿ç½‘ç»œ"><a class="header" href="#é…ç½®æ— çº¿ç½‘ç»œ">é…ç½®æ— çº¿ç½‘ç»œ</a></h3>
<h4 id="æŸ¥çœ‹æ— çº¿ç½‘ç»œé…ç½®"><a class="header" href="#æŸ¥çœ‹æ— çº¿ç½‘ç»œé…ç½®">æŸ¥çœ‹æ— çº¿ç½‘ç»œé…ç½®</a></h4>
<pre><code class="language-bash">root@Widora:~# cat /etc/config/wireless

config wifi-device 'radio0'
	option type 'ralink'
	option variant 'mt7628'
	option country 'CN'
	option hwmode '11bgn'
	option htmode 'HT40'
	option channel 'auto'
	option disabled '0'

config wifi-iface 'ap'
	option device 'radio0'
	option mode 'ap'
	option network 'lan'
	option ifname 'ra0'
	option ssid 'Widora-A9B8'
	option hidden '0'
	option encryption 'psk2'
	option key 'passworkd'

config wifi-iface 'sta'
	option device 'radio0'
	option disabled '1'
	option mode 'sta'
	option network 'wwan'
	option ifname 'apcli0'
	option ssid 'UplinkAp'
	option key 'SecretKey'
</code></pre>
<h4 id="wifi-device-é€‰é¡¹å‚æ•°"><a class="header" href="#wifi-device-é€‰é¡¹å‚æ•°">wifi-device é€‰é¡¹å‚æ•°</a></h4>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>type</td><td>è®¾å¤‡ç±»å‹</td><td>ralink</td></tr>
<tr><td>channel</td><td>æ— çº¿ä¿¡é“ï¼Œä¸åŒçš„å›½å®¶æ”¯æŒçš„ä¿¡é“ä¸åŒ</td><td>auto æˆ– 1ï½13</td></tr>
<tr><td>hwmode</td><td>æ— çº¿åè®®ç±»å‹</td><td>11bgn: IEEE802.11b + IEEE802.11g + IEEE802.11n</td></tr>
<tr><td>htmode</td><td>æ— çº¿é¢‘å®½</td><td>HT20ã€HT40</td></tr>
<tr><td>disable</td><td>å…³é—­æ— çº¿è®¾å¤‡</td><td>0ï¼šå¯ç”¨ï¼›1ï¼šç¦ç”¨</td></tr>
<tr><td>country</td><td>å›½å®¶ç±»å‹ï¼Œè·Ÿæ”¯æŒçš„é¢‘é“æœ‰å…³ï¼Œä¸­å›½ä¸º CNï¼Œæ”¯æŒ 1ï½13</td><td>CNï¼šä¸­å›½</td></tr>
</tbody></table>
</div>
<h4 id="wifi-iface-é€‰é¡¹å‚æ•°"><a class="header" href="#wifi-iface-é€‰é¡¹å‚æ•°">wifi-iface é€‰é¡¹å‚æ•°</a></h4>
<div class="table-wrapper"><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>å¯é€‰å€¼åŠè¯´æ˜</th></tr></thead><tbody>
<tr><td>device</td><td>å…³è”çš„æ— çº¿è®¾å¤‡</td><td>radio0</td></tr>
<tr><td>network</td><td>å…³è”ç½‘ç»œè®¾å¤‡ç±»å‹</td><td>lanï¼šè¡¨ç¤ºæ¡¥æ¥åˆ° LAN ç½‘ä¸Š<br />wwanï¼šè¡¨ç¤ºå¯ç”¨æ— çº¿ä¸­ç»§</td></tr>
<tr><td>mode</td><td>æ— çº¿å·¥ä½œæ¨¡å¼</td><td>apï¼šçƒ­ç‚¹æ¨¡å¼<br />staï¼šå®¢æˆ·ç«¯æ¨¡å¼</td></tr>
<tr><td>ssid</td><td>æ— çº¿çš„åç§°</td><td>å­—ç¬¦ä¸²</td></tr>
<tr><td>hidden</td><td>éšè—æ— çº¿åç§°</td><td>0ï¼šæ˜¾ç¤ºåç§°<br />1ï¼šéšè—åç§°</td></tr>
<tr><td>encryption</td><td>æ— çº¿åŠ å¯†æ–¹å¼</td><td>noneï¼šä¸åŠ å¯†<br />pskï¼šWPA-PSK æ¨¡å¼<br />psk2ï¼šWPA-PSK2 æ¨¡å¼<br />psk-mixedï¼šWPA-PSK / WPA-PSK2 æ··åˆæ¨¡å¼</td></tr>
<tr><td>key</td><td>æ— çº¿å¯†é’¥</td><td>å­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º 8ï½64 ä¸ª ASCII å­—ç¬¦</td></tr>
</tbody></table>
</div>
<p>::: tip</p>
<p>ä¿®æ”¹è¿‡æ— çº¿é…ç½®åéœ€è¦ä½¿ç”¨å‘½ä»¤ <code>wifi</code> ä½¿ä¹‹ç”Ÿæ•ˆ</p>
<p>:::</p>
<h4 id="æŸ¥çœ‹æ— çº¿ç½‘ç»œçŠ¶æ€"><a class="header" href="#æŸ¥çœ‹æ— çº¿ç½‘ç»œçŠ¶æ€">æŸ¥çœ‹æ— çº¿ç½‘ç»œçŠ¶æ€</a></h4>
<pre><code class="language-bash">root@Widora:~# iwinfo
ra0       ESSID: "Widora-A9B8"
          Access Point: 0C:EF:AF:D2:A9:B8
          Mode: Client  Channel: 7 (2.442 GHz)
          Tx-Power: 18 dBm  Link Quality: 10/100
          Signal: -256 dBm  Noise: -82 dBm
          Bit Rate: 150.0 MBit/s
          Encryption: unknown
          Type: wext  HW Mode(s): 802.11bg
          Hardware: unknown [Generic WEXT]
          TX power offset: unknown
          Frequency offset: unknown
          Supports VAPs: no  PHY name: ra0
</code></pre>
<h4 id="æœç´¢èŒƒå›´å†…çš„å…¶å®ƒæ— çº¿è®¾å¤‡"><a class="header" href="#æœç´¢èŒƒå›´å†…çš„å…¶å®ƒæ— çº¿è®¾å¤‡">æœç´¢èŒƒå›´å†…çš„å…¶å®ƒæ— çº¿è®¾å¤‡</a></h4>
<pre><code class="language-bash">root@Widora:~# iwinfo ra0 scan
Cell 01 - Address: 50:64:2B:4B:02:4E
          ESSID: "Xiaomi_024D"
          Mode: Master  Channel: 11
          Signal: -256 dBm  Quality: 55/100
          Encryption: WPA2 PSK (TKIP, AES-OCB)

Cell 02 - Address: 44:97:5A:EC:C5:14
          ESSID: "FAST_C514"
          Mode: Master  Channel: 1
          Signal: -256 dBm  Quality: 47/100
          Encryption: WPA2 PSK (AES-OCB)
</code></pre>
<h2 id="é˜²ç«å¢™"><a class="header" href="#é˜²ç«å¢™">é˜²ç«å¢™</a></h2>
<p>é˜²ç«å¢™ã€DMZï¼ˆç‹¬ç«‹éš”ç¦»åŒºï¼‰ã€NAT è½¬å‘åœ¨ OpenWrt ç³»ç»Ÿä¸­éƒ½æ˜¯ç”± /etc/config/firewall é…ç½®æ–‡ä»¶ç®¡ç†çš„ã€‚</p>
<h3 id="é˜²ç«å¢™å‘½ä»¤"><a class="header" href="#é˜²ç«å¢™å‘½ä»¤">é˜²ç«å¢™å‘½ä»¤</a></h3>
<h4 id="é‡ç½®é˜²ç«å¢™"><a class="header" href="#é‡ç½®é˜²ç«å¢™">é‡ç½®é˜²ç«å¢™</a></h4>
<pre><code class="language-bash">root@Widora:~# /etc/init.d/firewall reload
</code></pre>
<h3 id="é‡å¯é˜²ç«å¢™"><a class="header" href="#é‡å¯é˜²ç«å¢™">é‡å¯é˜²ç«å¢™</a></h3>
<pre><code class="language-bash">root@Widora:~# /etc/init.d/firewall restart
</code></pre>
<h4 id="æŸ¥çœ‹é˜²ç«å¢™å®Œæ•´ç­–ç•¥"><a class="header" href="#æŸ¥çœ‹é˜²ç«å¢™å®Œæ•´ç­–ç•¥">æŸ¥çœ‹é˜²ç«å¢™å®Œæ•´ç­–ç•¥</a></h4>
<pre><code class="language-bash">root@Widora:~# iptables -L
</code></pre>
<h3 id="é˜²ç«å¢™-defaults-é…ç½®"><a class="header" href="#é˜²ç«å¢™-defaults-é…ç½®">é˜²ç«å¢™ defaults é…ç½®</a></h3>
<pre><code class="language-bash">config defaults
	option syn_flood	1			# å¯ç”¨é˜²æ´ªæ°´æ”»å‡»
	option input		ACCEPT		# INPUT é“¾è¿‡æ»¤ç­–ç•¥
	option output		ACCEPT		# OUTPUT é“¾è¿‡æ»¤ç­–ç•¥
	option forward		REJECT		# FORWARD é“¾è¿‡æ»¤ç­–ç•¥
</code></pre>
<h3 id="é˜²ç«å¢™-zone-åŸŸé…ç½®"><a class="header" href="#é˜²ç«å¢™-zone-åŸŸé…ç½®">é˜²ç«å¢™ zone åŸŸé…ç½®</a></h3>
<p>ç³»ç»Ÿå°† LAN å’Œ WAN åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„ zoneï¼Œå®ƒä»¬ä¹‹é—´æ˜¯éš”ç¦»çš„ã€‚</p>
<pre><code class="language-bash">config zone
	option name			lan			# zone èŠ‚ç‚¹å
	list   network		'lan'		# æŒ‡å®šç»‘å®šåˆ°è¯¥ zone ä¸Šçš„è®¾å¤‡
	option input		ACCEPT
	option output		ACCEPT
	option forward		ACCEPT

config zone
	option name			wan
	list   network		'wan'
	list   network		'wan6'
	list   network		'wwan'
	option input		ACCEPT
	option output		ACCEPT
	option forward		REJECT
	option masq			1			# ä¼ è¾“ä¼ªè£…å¼€å…³ï¼ŒWAN å¿…é¡»è®¾ä¸º 1
	option mtu_fix		1			# æ•°æ®è¾“å‡ºæ—¶å¼€å¯ MSS é’³åˆ¶ï¼ŒWAN å¿…é¡»è®¾ä¸º 1
</code></pre>
<h3 id="é˜²ç«å¢™-forwarding-è½¬å‘é…ç½®"><a class="header" href="#é˜²ç«å¢™-forwarding-è½¬å‘é…ç½®">é˜²ç«å¢™ forwarding è½¬å‘é…ç½®</a></h3>
<p>forwarding é…ç½®å¯ä»¥å®ç°ä¸¤ä¸ªä¸åŒ zone åŸŸä¹‹é—´çš„æ•°æ®å‘é€</p>
<pre><code class="language-bash">config forwarding
	option src		lan			# æ¥æº zone
	option dest		wan			# ç›®æ ‡ zone
</code></pre>
<h3 id="é˜²ç«å¢™-rule-è§„åˆ™"><a class="header" href="#é˜²ç«å¢™-rule-è§„åˆ™">é˜²ç«å¢™ rule è§„åˆ™</a></h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿›å…¥ WAN å£çš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œå¦‚æœå¸Œæœ›æœ‰ä¾‹å¤–ï¼Œé‚£ä¹ˆè¦é€šè¿‡ rule æ¥å®ç°è®¸å¯ã€‚</p>
<pre><code class="language-bash"># Allow IPv4 ping
config rule
	option name			Allow-Ping
	option src			wan					# æ•°æ®æºçš„ zone åŸŸ
	option proto		icmp				# æ•°æ®æºçš„åè®®ç±»å‹
	option icmp_type	echo-request
	option family		ipv4				# IP åè®®ç±»å‹
	option target		ACCEPT				# è§„åˆ™åŠ¨ä½œ

# ç¦æ­¢ LAN å£çš„æŸä¸ª IP è®¿é—® WAN å£
config rule
	option src		lan						# æ•°æ®æºçš„ zone åŸŸ
	option src_ip	192.168.45.2			# æ•°æ®æºçš„ IP åœ°å€
	option dest		wan						# ç›®çš„åœ°çš„ zone åŸŸ
	option proto	tcp
	option target	REJECT

# ç¦æ­¢æŸä¸ª MAC åœ°å€è®¿é—® WAN
config rule
	option dest		wan
	option src_mac	00:11:22:33:44:66		# æ•°æ®æºçš„ MAC åœ°å€
	option target	REJECT

# é˜»å¡æŸä¸ª zone ä¸Šçš„ ICMP æµé‡
config rule
	option src		lan
	option proto	ICMP
	option target	DROP
</code></pre>
<h3 id="é˜²ç«å¢™-redirect-ç«¯å£è½¬å‘"><a class="header" href="#é˜²ç«å¢™-redirect-ç«¯å£è½¬å‘">é˜²ç«å¢™ redirect ç«¯å£è½¬å‘</a></h3>
<p>ç«¯å£è½¬å‘å…è®¸è®¿é—®è€…é€šè¿‡ WAN å£è®¿é—® LAN å£ä¸­çš„ä¸€ä¸ªç‰¹å®šç«¯å£ï¼Œå¹¶å°†ç»“æœè½¬å‘å›ç»™è®¿é—®è€…ã€‚</p>
<pre><code class="language-bash"># å°† LAN å£çš„ 80 ç«¯å£å¼€æ”¾åˆ° WAN å£ä¸Š
config redirect
	option src			wan				# è¢«è½¬å‘æ¥æº zone åŸŸ
	option src_dport	80				# è¢«è½¬å‘çš„ç«¯å£
	option dest			lan				# è½¬å‘åˆ°å“ªä¸ª zone åŸŸ
	option dest_ip		192.168.16.235 	# è½¬å‘åˆ°å“ªä¸ª IP åœ°å€
	option dest_port	80				# è½¬å‘åˆ°å“ªä¸ªç«¯å£
	option proto		tcp				# åè®®ç±»å‹

# å°†æ‰€æœ‰æ¥è‡ª WAN å£çš„ TCP åè®®è®¿é—® 22001 çš„è¯·æ±‚éƒ½è½¬å‘ç»™ LAN ä¸­çš„ä¸€å° 80 ç«¯å£çš„è®¡ç®—æœº
config redirect
	option src			wan
	option src_dport	22001
	option dest			lan
	option dest_port	22
	option proto		tcp

# å°† IP åœ°å€ 192.168.1.2 è®¾ç½®åˆ° DMZ éš”ç¦»åŒº
config redirect
	option src			wan
	option proto		all
	option dest_ip		192.168.1.2
</code></pre>
<h2 id="ntp"><a class="header" href="#ntp">NTP</a></h2>
<p>NTP ç”¨æ¥ä½¿ç½‘ç»œä¸­çš„å„ä¸ªè®¡ç®—æœºæ—¶é—´åŒæ­¥çš„ä¸€ç§åè®®ï¼Œå®ƒçš„ç”¨é€”æ˜¯æŠŠç³»ç»Ÿçš„æ—¶é’ŸåŒæ­¥åˆ° UTC æ—¶åŒºï¼Œå…¶ç²¾åº¦åœ¨å±€åŸŸç½‘å†…å¯è¾¾åˆ° 0.1msï¼Œåœ¨äº’è”ç½‘ä¸Šç»å¤§å¤šæ•°æƒ…å†µå…¶ç²¾åº¦å¯ä»¥è¾¾åˆ°1ï½50msã€‚</p>
<p>é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">root@Widora:~# cat /etc/config/system
config system
	option hostname	Widora				# ä¸»æœºå
	option timezone	CST-8				# æ—¶åŒº

config timeserver ntp
	list server	0.openwrt.pool.ntp.org	# NTP æœåŠ¡å™¨åœ°å€
	list server	1.openwrt.pool.ntp.org
	list server	2.openwrt.pool.ntp.org
	list server	3.openwrt.pool.ntp.org
	option enabled 1					# å¼€å¯ NTP åŠŸèƒ½
	option enable_server 0
</code></pre>
<p>::: tip</p>
<p>é˜¿é‡Œäº‘æä¾›äº† NTP æœåŠ¡åŠŸèƒ½ï¼š</p>
<p>ntp1.aliyun.com</p>
<p>ntp2.aliyun.com</p>
<p>ntp3.aliyun.com</p>
<p>:::</p>
<h2 id="æœåŠ¡ç®¡ç†"><a class="header" href="#æœåŠ¡ç®¡ç†">æœåŠ¡ç®¡ç†</a></h2>
<h3 id="æŸ¥çœ‹ç³»ç»ŸæœåŠ¡å‘½ä»¤"><a class="header" href="#æŸ¥çœ‹ç³»ç»ŸæœåŠ¡å‘½ä»¤">æŸ¥çœ‹ç³»ç»ŸæœåŠ¡å‘½ä»¤</a></h3>
<pre><code class="language-bash">root@Widora:~# ls /etc/init.d/
avahi-daemon   dbus           dropbear       led            mountd         rpcd           sysctl         system         umount
boot           dnsmasq        firewall       log            network        setnetmode     sysfixtime     telnet
cron           done           fstab          mjpg-streamer  odhcpd         shairport      sysntpd        uhttpd
</code></pre>
<h3 id="æœåŠ¡å‘½ä»¤çš„è¯­æ³•æ ¼å¼"><a class="header" href="#æœåŠ¡å‘½ä»¤çš„è¯­æ³•æ ¼å¼">æœåŠ¡å‘½ä»¤çš„è¯­æ³•æ ¼å¼</a></h3>
<pre><code>æœåŠ¡çš„è¯­æ³•æ ¼å¼ï¼š/etc/init.d/æœåŠ¡åç§° [å‘½ä»¤]
å¯ç”¨å‘½ä»¤ï¼š
		start	ä¸´æ—¶å¼€å¯è¿™ä¸ªæœåŠ¡
		stop	ä¸´æ—¶å…³é—­è¿™ä¸ªæœåŠ¡
		restart é‡å¯å½“å‰å·²å¼€å¯çš„æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯å°±å¼€å¯å®ƒ
		reload 	é‡æ–°è¯»å–è¯¥æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼ˆå¦‚æœæœåŠ¡æ”¯æŒçš„è¯ï¼‰
		enable	è®¾ç½®è¯¥æœåŠ¡éšç³»ç»Ÿä¸€åŒå¯åŠ¨
		disable	ç¦æ­¢è¯¥æœåŠ¡éšç³»ç»Ÿä¸€åŒå¯åŠ¨
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-çŸ¥è¯†ç¢ç‰‡"><a class="header" href="#rust-çŸ¥è¯†ç¢ç‰‡">Rust çŸ¥è¯†ç¢ç‰‡</a></h1>
<h2 id="ç¼–è¯‘è¿‡ç¨‹-1"><a class="header" href="#ç¼–è¯‘è¿‡ç¨‹-1">ç¼–è¯‘è¿‡ç¨‹</a></h2>
<p><img src="cs/../images/rust/compile-process.png" alt="Rust çš„ç¼–è¯‘è¿‡ç¨‹" /></p>
<ol>
<li>åˆ†è¯ï¼šæŠŠè¯æ³•ç»“æ„å¤„ç†æˆ<strong>è¯æ¡æµ</strong></li>
<li>è¯æ¡æµç»è¿‡è¯­æ³•è§£æå½¢æˆ<strong>æŠ½è±¡è¯­æ³•æ ‘</strong></li>
<li>æŠ½è±¡è¯­æ³•æ ‘ç®€åŒ–æˆé«˜çº§ä¸­é—´è¯­è¨€ (<strong>HIR</strong>)ï¼Œç¼–è¯‘å™¨å¯¹ HIR è¿›è¡Œç±»å‹æ£€æŸ¥ã€æ–¹æ³•æŸ¥æ‰¾ç­‰å·¥ä½œ</li>
<li>HIR è¿›ä¸€æ­¥ç®€åŒ–å½¢æˆä¸­çº§ä¸­é—´è¯­è¨€ (<strong>MIR</strong>)ï¼Œç¼–è¯‘å™¨å¯¹ MIR è¿›è¡Œå€Ÿç”¨æ£€æŸ¥ã€ä¼˜åŒ–ç­‰å·¥ä½œï¼Œåœ¨ MIR ä¸­å·²ç»çœ‹ä¸åˆ° Rust å„ç‰ˆæ¬¡(Edition)çš„å·®å¼‚äº†</li>
<li>äº§ç”Ÿ <strong>LLVM</strong> ä¸­é—´è¯­è¨€</li>
<li>LLVM åç«¯ä¼šå¯¹ LLVM ä¸­é—´è¯­è¨€è¿›è¡Œä¼˜åŒ–ï¼Œæœ€ç»ˆç”Ÿæˆ<strong>æœºå™¨ä»£ç </strong></li>
</ol>
<h2 id="å¸¸ç”¨æ•°æ®ç»“æ„"><a class="header" href="#å¸¸ç”¨æ•°æ®ç»“æ„">å¸¸ç”¨æ•°æ®ç»“æ„</a></h2>
<p><img src="cs/../images/rust/data-structure.webp" alt="æ•°æ®ç»“æ„" /></p>
<h2 id="å€¼æ”¾å †ä¸Šè¿˜æ˜¯æ ˆä¸Š"><a class="header" href="#å€¼æ”¾å †ä¸Šè¿˜æ˜¯æ ˆä¸Š">å€¼æ”¾å †ä¸Šè¿˜æ˜¯æ ˆä¸Š</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let s = "hello world".to_string();
println!("'hello world': {:p}, s: {:p}, len: {}, capacity: {}, size: {}",
        &amp;"hello world", &amp;s, s.len(), s.capacity(), std::mem::size_of_val(&amp;s));
<span class="boring">}</span></code></pre></pre>
<p><img src="cs/../images/rust/string-in-memory.webp" alt="stringçš„å†…å­˜å¸ƒå±€" /></p>
<blockquote>
<p>æ ˆä¸Šå­˜æ”¾çš„æ•°æ®æ˜¯é™æ€çš„ï¼Œå›ºå®šå¤§å°ï¼Œå›ºå®šç”Ÿå‘½å‘¨æœŸï¼›å †ä¸Šå­˜æ”¾çš„æ•°æ®æ˜¯åŠ¨æ€çš„ï¼Œä¸å›ºå®šå¤§å°ï¼Œä¸å›ºå®šç”Ÿå‘½å‘¨æœŸã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static MAX: u32 = 0;
fn foo() {}
let hello = "hello world".to_string();
let data = Box::new(1);

// string literals æŒ‡å‘ RODATA åœ°å€
println!("RODATA: {:p}", "hello world!");
// static å˜é‡åœ¨ DATA section
println!("DATA (static var): {:p}", &amp;MAX);
// function åœ¨ TEXT
println!("TEXT (function): {:p}", foo as *const ());
// String ç»“æ„ä½“åˆ†é…åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥å…¶å¼•ç”¨æŒ‡å‘ä¸€ä¸ªæ ˆåœ°å€
println!("STACK (&amp;hello): {:p}", &amp;hello);
// éœ€è¦é€šè¿‡è§£å¼•ç”¨è·å–å…¶å †ä¸Šæ•°æ®ï¼Œç„¶åå–å…¶å¼•ç”¨
println!("HEAP (&amp;*hello): {:p}", &amp;*hello);
// Box å®ç°äº† Pointer trait æ— éœ€é¢å¤–è§£å¼•ç”¨
println!("HEAP (box impl Pointer) {:p} {:p}", data, &amp;*data);
<span class="boring">}</span></code></pre></pre>
<h2 id="move-copy-borrow"><a class="header" href="#move-copy-borrow">move, copy, borrow</a></h2>
<p><img src="cs/../images/rust/move-copy-borrow.jpg" alt="move, copy, borrow" /></p>
<p>å…¶å® Copy å’Œ Move åœ¨å†…éƒ¨å®ç°ä¸Šï¼Œéƒ½æ˜¯æµ…å±‚çš„<strong>æŒ‰ä½</strong>åšå†…å­˜å¤åˆ¶ï¼Œåªä¸è¿‡ Copy å…è®¸ä½ è®¿é—®ä¹‹å‰çš„å˜é‡ï¼Œè€Œ Move ä¸å…è®¸ã€‚</p>
<h3 id="å…³äºå†…å­˜å¤åˆ¶ä¸Šçš„è¯¯åŒº"><a class="header" href="#å…³äºå†…å­˜å¤åˆ¶ä¸Šçš„è¯¯åŒº">å…³äºå†…å­˜å¤åˆ¶ä¸Šçš„è¯¯åŒº</a></h3>
<p>å¦‚æœä»£ç çš„å…³é”®è·¯å¾„ä¸­çš„æ¯æ¬¡éƒ½è¦å¤åˆ¶å‡ ç™¾ k çš„æ•°æ®ï¼ˆæ¯”å¦‚ä¸€ä¸ªå¤§æ•°ç»„ï¼‰ï¼Œè¿™æ˜¯å¾ˆä½æ•ˆçš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¦å¤åˆ¶çš„åªæ˜¯åŸç”Ÿç±»å‹ï¼ˆCopyï¼‰æˆ–è€…æ ˆä¸Šçš„èƒ–æŒ‡é’ˆï¼ˆMoveï¼‰ï¼Œä¸æ¶‰åŠå †å†…å­˜çš„å¤åˆ¶ï¼ˆå³æ²¡æœ‰åšæ·±æ‹·è´ï¼ˆdeep copyï¼‰ï¼‰ï¼Œé‚£è¿™ä¸ªæ•ˆç‡æ˜¯éå¸¸é«˜çš„ï¼Œä¸å¿…æ‹…å¿ƒæ¯æ¬¡èµ‹å€¼æˆ–è€…æ¯æ¬¡ä¼ å‚å¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚</p>
<p>Rust çš„é›†åˆç±»å‹ä¼šåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰©å±•ã€‚ä»¥ä¸€ä¸ª Vec ä¸ºä¾‹ï¼Œå½“ä½¿ç”¨å®Œå †å†…å­˜å½“å‰å®¹é‡åï¼Œè¿˜ç»§ç»­æ·»åŠ æ–°çš„å†…å®¹ï¼Œå°±ä¼šè§¦å‘å †å†…å­˜çš„è‡ªåŠ¨å¢é•¿ã€‚æœ‰æ—¶å€™ï¼Œé›†åˆç±»å‹é‡Œçš„æ•°æ®ä¸æ–­è¿›è¿›å‡ºå‡ºï¼Œå¯¼è‡´é›†åˆä¸€ç›´å¢é•¿ï¼Œä½†å®é™…åªä½¿ç”¨äº†å¾ˆå°éƒ¨åˆ†çš„å®¹é‡ï¼Œå¯¼è‡´å†…å­˜çš„ä½¿ç”¨æ•ˆç‡å¾ˆä½ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>shrink_to_fit</code> æ–¹æ³•æ¥èŠ‚çº¦å¯¹å†…å­˜çš„ä½¿ç”¨ã€‚</p>
<h2 id="æ‰€æœ‰æƒ"><a class="header" href="#æ‰€æœ‰æƒ">æ‰€æœ‰æƒ</a></h2>
<p><img src="cs/../images/rust/ownership.webp" alt="ownership" /></p>
<h3 id="æ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥å’ŒåŠ¨æ€æ£€æŸ¥"><a class="header" href="#æ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥å’ŒåŠ¨æ€æ£€æŸ¥">æ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥å’ŒåŠ¨æ€æ£€æŸ¥</a></h3>
<p>åœ¨æ‰€æœ‰æƒæ¨¡å‹ä¸‹ï¼Œå †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œå’Œåˆ›å»ºå®ƒçš„æ ˆå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚ç¼–è¯‘å™¨å¯ä»¥ä¿è¯ä»£ç ç¬¦åˆæ‰€æœ‰æƒè§„åˆ™ï¼ˆé™æ€æ£€æŸ¥ï¼‰ã€‚</p>
<p>åŠ¨æ€æ£€æŸ¥ï¼Œé€šè¿‡ <code>Box::leak()</code> è®©å †å†…å­˜æ‹¥æœ‰ä¸å—é™åˆ¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶ååœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å¯¹å¼•ç”¨è®¡æ•°çš„æ£€æŸ¥ï¼Œä¿è¯è¿™æ ·çš„å †å†…å­˜æœ€ç»ˆä¼šå¾—åˆ°é‡Šæ”¾ã€‚</p>
<h3 id="å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§"><a class="header" href="#å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§">å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§</a></h3>
<div class="table-wrapper"><table><thead><tr><th></th><th>ä½¿ç”¨æ–¹æ³•</th><th>æ‰€æœ‰æƒæ£€æŸ¥</th></tr></thead><tbody>
<tr><td>å¤–éƒ¨å¯å˜æ€§</td><td><code>let mut</code> æˆ–è€… <code>&amp;mut</code></td><td>ç¼–è¯‘æ—¶ï¼Œå¦‚æœä¸ç¬¦åˆè§„åˆ™ï¼Œäº§ç”Ÿç¼–è¯‘é”™è¯¯</td></tr>
<tr><td>å†…éƒ¨å¯å˜æ€§</td><td>ä½¿ç”¨ Cell/RefCell</td><td>è¿è¡Œæ—¶ï¼Œå¦‚æœä¸ç¬¦åˆè§„åˆ™ï¼Œäº§ç”Ÿ panic</td></tr>
</tbody></table>
</div>
<pre><pre class="playground"><code class="language-rust edition2021">use std::cell::RefCell;

fn main() {
    let data = RefCell::new(1);
    // æ ¹æ®æ‰€æœ‰æƒè§„åˆ™ï¼Œåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œä¸èƒ½åŒæ—¶æœ‰æ´»è·ƒçš„å¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨
    // é€šè¿‡è¿™å¯¹èŠ±æ‹¬å·ï¼Œæˆ‘ä»¬ç¼©å°äº†å¯å˜å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸ
    {
        // è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨
        let mut v = data.borrow_mut();
        *v += 1;
    }
    println!("data: {:?}", data.borrow());
}</code></pre></pre>
<h2 id="ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021">pub fn strtok&lt;'a&gt;(s: &amp;mut &amp;'a str, delimiter: char) -&gt; &amp;'a str {
    if let Some(i) = s.find(delimiter) {
        let prefix = &amp;s[..i];
        // ç”±äº delimiter å¯ä»¥æ˜¯ utf8ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è·å¾—å…¶ utf8 é•¿åº¦ï¼Œ
        // ç›´æ¥ä½¿ç”¨ len è¿”å›çš„æ˜¯å­—èŠ‚é•¿åº¦ï¼Œä¼šæœ‰é—®é¢˜
        let suffix = &amp;s[(i + delimiter.len_utf8())..];
        *s = suffix;
        prefix
    } else {
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›æ•´ä¸ªå­—ç¬¦ä¸²ï¼ŒæŠŠåŸå­—ç¬¦ä¸²æŒ‡é’ˆ s æŒ‡å‘ç©ºä¸²
        let prefix = *s;
        *s = "";
        prefix
    }
}

fn main() {
    let s = String::from("hello world");
    let mut s1 = s.as_str();
    let hello = strtok(&amp;mut s1, ' ');
    println!("hello is: {}, s1: {}, s: {}", hello, s1, s);
}</code></pre></pre>
<p><img src="cs/../images/rust/lifetime-example.webp" alt="lifetime" /></p>
<blockquote>
<p>æ³¨æ„ï¼šå½“ä½ è¦è¿”å›åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºçš„æˆ–è€…å¾—åˆ°çš„æ•°æ®ï¼Œå’Œå‚æ•°æ— å…³ï¼Œé‚£ä¹ˆæ— è®ºå®ƒæ˜¯ä¸€ä¸ªæœ‰æ‰€æœ‰æƒçš„æ•°æ®ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œä½ åªèƒ½è¿”å›å¸¦æ‰€æœ‰æƒçš„æ•°æ®ã€‚å¯¹äºå¼•ç”¨ï¼Œè¿™å°±æ„å‘³ç€è°ƒç”¨ <code>clone()</code> æˆ–è€… <code>to_owned()</code> æ¥ä»å¼•ç”¨ä¸­å¾—åˆ°æ‰€æœ‰æƒã€‚</p>
</blockquote>
<h2 id="ç»“æ„ä½“æˆå‘˜è‡ªåŠ¨é‡æ’"><a class="header" href="#ç»“æ„ä½“æˆå‘˜è‡ªåŠ¨é‡æ’">ç»“æ„ä½“æˆå‘˜è‡ªåŠ¨é‡æ’</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021">use std::mem::{align_of, size_of};

struct S1 {
    a: u8,
    b: u16,
    c: u8,
}

struct S2 {
    a: u8,
    c: u8,
    b: u16,
}

#[repr(C)]
struct S3 {
    a: u8,
    b: u16,
    c: u8,
}

fn main() {
    println!(
        "sizeof S1: {}, S2: {}, S3: {}",
        size_of::&lt;S1&gt;(),
        size_of::&lt;S2&gt;(),
        size_of::&lt;S3&gt;()
    );
    println!(
        "alignof S1: {}, S2: {}, S3: {}",
        align_of::&lt;S1&gt;(),
        align_of::&lt;S2&gt;(),
        align_of::&lt;S3&gt;()
    );
}</code></pre></pre>
<p>Rust ç¼–è¯‘å™¨é»˜ä¼šä¼˜åŒ–ç»“æ„ä½“çš„æ’åˆ—ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>#[repr]</code> å®ï¼Œå¼ºåˆ¶è®© Rust ç¼–è¯‘å™¨ä¸åšä¼˜åŒ–ï¼Œå’Œ C çš„è¡Œä¸ºä¸€è‡´ï¼Œè¿™æ ·ï¼ŒRust ä»£ç å¯ä»¥æ–¹ä¾¿åœ°å’Œ C ä»£ç æ— ç¼äº¤äº’ã€‚</p>
<h2 id="enum-çš„å†…å­˜å¸ƒå±€"><a class="header" href="#enum-çš„å†…å­˜å¸ƒå±€">enum çš„å†…å­˜å¸ƒå±€</a></h2>
<p><img src="cs/../images/rust/enum-memory-layout.webp" alt="enum" /></p>
<p>enum æ˜¯ä¸€ä¸ªæ ‡ç­¾è”åˆä½“ï¼ˆtagged unionï¼‰ï¼Œå®ƒçš„å¤§å°æ˜¯æ ‡ç­¾çš„å¤§å°ï¼ŒåŠ ä¸Šæœ€å¤§ç±»å‹çš„é•¿åº¦ã€‚æ‰€ä»¥å¯¹äº <code>Option&lt;u8&gt;</code>ï¼Œå…¶é•¿åº¦æ˜¯ 1 + 1 = 2 å­—èŠ‚ï¼Œè€Œ <code>Option&lt;f64&gt;</code>ï¼Œé•¿åº¦æ˜¯ 8 + 8 =16 å­—èŠ‚ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::collections::HashMap;
use std::mem::size_of;

enum MyEnum {
    A(f64),
    B(HashMap&lt;String, String&gt;),
    C(Result&lt;Vec&lt;u8&gt;, String&gt;),
}

// è¿™æ˜¯ä¸€ä¸ªå£°æ˜å®ï¼Œå®ƒä¼šæ‰“å°å„ç§æ•°æ®ç»“æ„æœ¬èº«çš„å¤§å°ï¼Œåœ¨ Option ä¸­çš„å¤§å°ï¼Œä»¥åŠåœ¨ Result ä¸­çš„å¤§å°
macro_rules! show_size {
    (header) =&gt; {
        println!(
            "{:&lt;24} {:&gt;4}    {}    {}",
            "Type", "T", "Option&lt;T&gt;", "Result&lt;T, io::Error&gt;"
        );
        println!("{}", "-".repeat(64));
    };
    ($t:ty) =&gt; {
        println!(
            "{:&lt;24} {:4} {:8} {:12}",
            stringify!($t),
            size_of::&lt;$t&gt;(),
            size_of::&lt;Option&lt;$t&gt;&gt;(),
            size_of::&lt;Result&lt;$t, std::io::Error&gt;&gt;(),
        )
    };
}

fn main() {
    show_size!(header);
    show_size!(u8);
    show_size!(f64);
    show_size!(&amp;u8);
    show_size!(Box&lt;u8&gt;);
    show_size!(&amp;[u8]);

    show_size!(String);
    show_size!(Vec&lt;u8&gt;);
    show_size!(HashMap&lt;String, String&gt;);
    show_size!(MyEnum);
}</code></pre></pre>
<p>ä½†æ˜¯ Rust ç¼–è¯‘å™¨ä¼šå¯¹ enum åšä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œè®©æŸäº›å¸¸ç”¨ç»“æ„çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘ã€‚Option é…åˆå¸¦æœ‰å¼•ç”¨ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ &amp;u8ã€Boxã€Vecã€HashMap ï¼Œæ²¡æœ‰é¢å¤–å ç”¨ç©ºé—´ã€‚å¼•ç”¨ç±»å‹çš„ç¬¬ä¸€ä¸ªåŸŸæ˜¯ä¸ªæŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆæ˜¯ä¸å¯èƒ½ç­‰äº 0 çš„ï¼Œé€šè¿‡å¤ç”¨è¿™ä¸ªæŒ‡é’ˆï¼šå½“å…¶ä¸º 0 æ—¶ï¼Œè¡¨ç¤º Noneï¼Œå¦åˆ™æ˜¯ Someï¼Œå‡å°‘äº†å†…å­˜å ç”¨ã€‚</p>
<h2 id="çº¿ç¨‹å®‰å…¨çš„å…¨å±€å˜é‡-lazy_static"><a class="header" href="#çº¿ç¨‹å®‰å…¨çš„å…¨å±€å˜é‡-lazy_static">çº¿ç¨‹å®‰å…¨çš„å…¨å±€å˜é‡ (lazy_static)</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021">use lazy_static::lazy_static;
use std::collections::HashMap;
use std::sync::{Arc, Mutex};

lazy_static! {
    static ref HASHMAP: Arc&lt;Mutex&lt;HashMap&lt;u32, &amp;'static str&gt;&gt;&gt; = {
        let mut m = HashMap::new();
        m.insert(0, "foo");
        m.insert(1, "bar");
        m.insert(2, "baz");
        Arc::new(Mutex::new(m))
    };
}

fn main() {
    let mut map = HASHMAP.lock().unwrap();
    map.insert(3, "waz");

    println!("map: {:?}", map);
}</code></pre></pre>
<h2 id="å¸¦å…³è”ç±»å‹çš„-trait"><a class="header" href="#å¸¦å…³è”ç±»å‹çš„-trait">å¸¦å…³è”ç±»å‹çš„ trait</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021">use std::str::FromStr;

use lazy_static::lazy_static;
use regex::Regex;

pub trait ParseFromStr {
    type Error;
    fn parse_from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt;
    where
        Self: Sized;
}

impl&lt;T&gt; ParseFromStr for T
where
    T: FromStr,
{
    // å®šä¹‰å…³è”ç±»å‹ Error ä¸º String
    type Error = String;

    fn parse_from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; {
        // ensure that regular expressions are compiled exactly once.
        lazy_static! {
            static ref RE: Regex = Regex::new(r"^\d+(\.\d+)?").unwrap();
        };
        if let Some(captures) = RE.captures(s) {
            captures
                .get(0)
                .map_or(Err("failed to capture".to_string()), |s| {
                    s.as_str()
                        .parse()
                        .map_err(|_e| "failed to parse captured string".to_string())
                })
        } else {
            Err("failed to parse string".to_string())
        }
    }
}

fn main() {
    println!("result: {}", u8::parse_from_str("255 hello").unwrap());
    println!("result: {}", u8::parse_from_str("001 world").unwrap());
    println!("result: {}", u8::parse_from_str("!").unwrap_or_default());
    println!("result: {}", f64::parse_from_str("123.45abc").unwrap());
}</code></pre></pre>
<h2 id="trait-object-çš„å®ç°æœºåˆ¶"><a class="header" href="#trait-object-çš„å®ç°æœºåˆ¶">trait object çš„å®ç°æœºåˆ¶</a></h2>
<p><img src="cs/../images/rust/trait-object.webp" alt="trait object çš„å†…å­˜å¸ƒå±€" /></p>
<p>trait object çš„åº•å±‚é€»è¾‘å°±æ˜¯æ—æŒ‡é’ˆï¼Œå…¶ä¸­ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®æœ¬èº«ï¼Œå¦ä¸€ä¸ªåˆ™æŒ‡å‘è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ã€‚vtable æ˜¯ä¸€å¼ é™æ€çš„è¡¨ï¼ŒRust åœ¨ç¼–è¯‘æ—¶ä¼šä¸ºä½¿ç”¨äº† trait object çš„ç±»å‹çš„ trait å®ç°ç”Ÿæˆä¸€å¼ è¡¨ï¼Œæ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ˆä¸€èˆ¬åœ¨textæˆ–rodataæ®µï¼‰ã€‚</p>
<p>å¦‚æœ trait <strong>æ‰€æœ‰</strong>çš„æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯ Self æˆ–è€…æºå¸¦æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ª trait å°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚trait object åœ¨äº§ç”Ÿæ—¶ï¼ŒåŸæ¥çš„ç±»å‹ä¼šè¢«æŠ¹å»ï¼Œæ‰€ä»¥ Self ç©¶ç«Ÿæ˜¯è°ä¸çŸ¥é“ã€‚Rust é‡Œå¸¦æ³›å‹çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶ä¼šåš<strong>å•æ€åŒ–</strong>ï¼Œè€Œ trait object æ˜¯è¿è¡Œæ—¶çš„äº§ç‰©ï¼Œä¸¤è€…ä¸èƒ½å…¼å®¹ã€‚<strong>å¦‚æœä¸€ä¸ª trait åªæœ‰éƒ¨åˆ†æ–¹æ³•è¿”å› Self æˆ–è€…æºå¸¦æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ–¹æ³•åœ¨ trait object ä¸­ä¸èƒ½è¢«è°ƒç”¨</strong>ã€‚</p>
<h2 id="å¸¸ç”¨-trait-ä»‹ç»"><a class="header" href="#å¸¸ç”¨-trait-ä»‹ç»">å¸¸ç”¨ trait ä»‹ç»</a></h2>
<h3 id="clone"><a class="header" href="#clone">Clone</a></h3>
<p>Clone æ˜¯æ·±åº¦æ‹·è´ï¼Œæ ˆå†…å­˜å’Œå †å†…å­˜ä¸€èµ·æ‹·è´ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Clone {
    // åœ¨ clone ä¸€ä¸ªæ•°æ®æ—¶åªéœ€è¦æœ‰å·²æœ‰æ•°æ®çš„åªè¯»å¼•ç”¨
    fn clone(&amp;self) -&gt; Self;

    fn clone_from(&amp;mut self, source: &amp;Self) {
        *self = source.clone()
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="copy"><a class="header" href="#copy">Copy</a></h3>
<p>Copy trait æ²¡æœ‰ä»»ä½•é¢å¤–çš„æ–¹æ³•ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®° traitï¼Œå¯ä»¥ç”¨ä½œ trait bound æ¥è¿›è¡Œç±»å‹å®‰å…¨æ£€æŸ¥ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// å¦‚æœè¦å®ç° Copy trait çš„è¯ï¼Œå¿…é¡»å®ç° Clone traitã€‚
pub trait Copy: Clone {}
<span class="boring">}</span></code></pre></pre>
<h3 id="drop"><a class="header" href="#drop">Drop</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Drop {
    fn drop(&amp;mut self);
}
<span class="boring">}</span></code></pre></pre>
<p>å¤§éƒ¨åˆ†åœºæ™¯æ— éœ€ä¸ºæ•°æ®ç»“æ„æä¾› Drop traitï¼Œç³»ç»Ÿé»˜è®¤ä¼šä¾æ¬¡å¯¹æ•°æ®ç»“æ„çš„æ¯ä¸ªåŸŸåš dropã€‚ä½†æœ‰ä¸¤ç§æƒ…å†µéœ€è¦æ‰‹åŠ¨å®ç° Drop:</p>
<ol>
<li>å¸Œæœ›åœ¨æ•°æ®ç»“æŸç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—</li>
<li>éœ€è¦å¯¹èµ„æºè¿›è¡Œå›æ”¶ï¼Œæ¯”å¦‚é”èµ„æºçš„é‡Šæ”¾</li>
</ol>
<p><strong>Copy trait å’Œ Drop trait æ˜¯äº’æ–¥çš„ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜</strong>ã€‚å› ä¸º Copy æ˜¯æŒ‰ä½åšæµ…æ‹·è´ï¼Œå®ƒæ‹·è´çš„æ•°æ®æ²¡æœ‰éœ€è¦é‡Šæ”¾çš„èµ„æºï¼Œè€Œ Drop æ°æ°æ˜¯ä¸ºäº†é‡Šæ”¾é¢å¤–çš„èµ„æºè€Œç”Ÿçš„ã€‚</p>
<h3 id="sized"><a class="header" href="#sized">Sized</a></h3>
<p>Sized trait ç”¨äºæ ‡è®°æœ‰å…·ä½“å¤§å°çš„ç±»å‹ã€‚åœ¨ä½¿ç”¨æ³›å‹å‚æ•°æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ³›å‹å‚æ•°åŠ ä¸Š Sized çº¦æŸã€‚å¦‚æœå¼€å‘è€…æ˜¾å¼å®šä¹‰äº†T: ?Sizedï¼Œé‚£ä¹ˆ T å°±å¯ä»¥æ˜¯ä»»æ„å¤§å°ã€‚</p>
<h3 id="send--sync-ç”¨äºå¹¶å‘å®‰å…¨"><a class="header" href="#send--sync-ç”¨äºå¹¶å‘å®‰å…¨">Send / Sync ç”¨äºå¹¶å‘å®‰å…¨</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub unsafe auto trait Send {}
pub unsafe auto trait Sync {}
<span class="boring">}</span></code></pre></pre>
<p>è¿™é‡Œçš„ <code>auto</code> æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨åˆé€‚çš„åœºåˆï¼Œè‡ªåŠ¨ä¸ºæ•°æ®ç»“æ„æ·»åŠ å®ƒä»¬çš„å®ç°ã€‚</p>
<p>å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Send trait,æ„å‘³ç€ T å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå³æ‰€æœ‰æƒå¯ä»¥åœ¨çº¿ç¨‹é—´ç§»åŠ¨ã€‚
å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Sync trait,æ„å‘³ç€ &amp;T å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ã€‚</p>
<p>å¯¹äº Send/Sync åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨ï¼šå¦‚æœä¸€ä¸ªç±»å‹ <code>T: Send</code>ï¼Œé‚£ä¹ˆ T åœ¨æŸä¸ªçº¿ç¨‹ä¸­çš„<strong>ç‹¬å è®¿é—®</strong>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›å¦‚æœä¸€ä¸ªç±»å‹ <code>T: Sync</code>ï¼Œé‚£ä¹ˆ T åœ¨çº¿ç¨‹é—´çš„<strong>åªè¯»å…±äº«</strong>æ˜¯å®‰å…¨çš„ã€‚</p>
<p>å¼•ç”¨è®¡æ•° <code>Rc&lt;T&gt;</code> ä¸æ”¯æŒ Send ä¹Ÿä¸æ”¯æŒ Syncã€‚æ‰€ä»¥ <code>Rc&lt;T&gt;</code> æ— æ³•è·¨çº¿ç¨‹ã€‚
<code>RefCell&lt;T&gt;</code> å®ç°äº† Sendï¼Œæ‰€ä»¥å¯ä»¥åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒã€‚ä½†æ²¡æœ‰å®ç° Syncï¼Œå› æ­¤æ— æ³•è·¨çº¿ç¨‹ä½¿ç”¨ <code>Arc&lt;RefCell&lt;T&gt;&gt;</code> è¿™æ ·çš„æ•°æ®ï¼ˆå› ä¸º Arc å†…éƒ¨çš„æ•°æ®æ˜¯å…±äº«çš„ï¼Œéœ€è¦æ”¯æŒ Sync çš„æ•°æ®ç»“æ„ï¼‰ã€‚</p>
<h3 id="fromt--intot-ç”¨äºä»å€¼åˆ°å€¼çš„è½¬æ¢"><a class="header" href="#fromt--intot-ç”¨äºä»å€¼åˆ°å€¼çš„è½¬æ¢">From&lt;T&gt; / Into&lt;T&gt; ç”¨äºä»å€¼åˆ°å€¼çš„è½¬æ¢</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait From&lt;T&gt; {
    fn from(t: T) -&gt; Self;
}

pub trait Into&lt;T&gt; {
    fn into(self) -&gt; T;
}

// å®ç° From ä¼šè‡ªåŠ¨å®ç° Into
impl&lt;T, U&gt; Into&lt;U&gt; for T where U: From&lt;T&gt; {
    fn into(self) -&gt; U {
        U::from(self)
    }
}

// Fromï¼ˆä»¥åŠ Intoï¼‰æ˜¯è‡ªåçš„ï¼šæŠŠç±»å‹ T çš„å€¼è½¬æ¢æˆç±»å‹ T,ä¼šç›´æ¥è¿”å›
impl&lt;T&gt; From&lt;T&gt; for T {
    fn from(t: T) -&gt; T {
        t
    }
}
<span class="boring">}</span></code></pre></pre>
<p>æœ‰äº†è¿™ä¸¤ä¸ª trait,å‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»ï¼Œæ¯”å¦‚å‡½æ•°å¦‚æœæ¥å—ä¸€ä¸ª IpAddr ä¸ºå‚æ•°ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨ <code>Into&lt;IpAddr&gt;</code> è®©æ›´å¤šçš„ç±»å‹å¯ä»¥è¢«è¿™ä¸ªå‡½æ•°ä½¿ç”¨ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::net::{IpAddr, Ipv4Addr, Ipv6Addr};

fn print(v: impl Into&lt;IpAddr&gt;) {
    println!("{:?}", v.into());
}

fn main() {
    let v4: Ipv4Addr = "2.2.2.2".parse().unwrap();
    let v6: Ipv6Addr = "::1".parse().unwrap();

    // IPAddr å®ç°äº† From&lt;[u8; 4]ï¼Œè½¬æ¢ IPv4 åœ°å€
    print([1, 1, 1, 1]);
    // IPAddr å®ç°äº† From&lt;[u16; 8]ï¼Œè½¬æ¢ IPv6 åœ°å€
    print([0xfe80, 0, 0, 0, 0xaede, 0x48ff, 0xfe00, 0x1122]);
    // IPAddr å®ç°äº† From&lt;Ipv4Addr&gt;
    print(v4);
    // IPAddr å®ç°äº† From&lt;Ipv6Addr&gt;
    print(v6);
}</code></pre></pre>
<p>å¦‚æœæ•°æ®ç±»å‹åœ¨è½¬æ¢è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å‡ºç°é”™è¯¯ï¼Œå°±éœ€è¦ä½¿ç”¨ TryFrom&lt;T&gt; å’Œ TryInto&lt;T&gt;ã€‚</p>
<h3 id="asreft--asmutt-ç”¨äºä»å¼•ç”¨åˆ°å¼•ç”¨çš„è½¬æ¢"><a class="header" href="#asreft--asmutt-ç”¨äºä»å¼•ç”¨åˆ°å¼•ç”¨çš„è½¬æ¢">AsRef&lt;T&gt; / AsMut&lt;T&gt; ç”¨äºä»å¼•ç”¨åˆ°å¼•ç”¨çš„è½¬æ¢</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// T ä½¿ç”¨å¤§å°å¯å˜çš„ç±»å‹ï¼Œå¦‚ strã€[u8] ç­‰
pub trait AsRef&lt;T&gt; where T: ?Sized {
    fn as_ref(&amp;self) -&gt; &amp;T;
}

pub trait AsMut&lt;T&gt; where T: ?Sized {
    fn as_mut(&amp;mut self) -&gt; &amp;mut T;
}
<span class="boring">}</span></code></pre></pre>
<p>æ ‡å‡†åº“ä¸­æ‰“å¼€æ–‡ä»¶çš„æ¥å£ <code>std::fs::File::open</code></p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn open&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; io::Result&lt;File&gt;
<span class="boring">}</span></code></pre></pre>
<p>æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¸ºè¿™ä¸ªå‚æ•°ä¼ å…¥ Stringã€&amp;strã€PathBufã€Path ç­‰ç±»å‹ï¼Œå½“ä½¿ç”¨ <code>path.as_ref()</code> æ—¶ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ª <code>&amp;Path</code>ã€‚</p>
<h3 id="deref--derefmut"><a class="header" href="#deref--derefmut">Deref / DerefMut</a></h3>
<p>Rust ä¸ºæ‰€æœ‰çš„è¿ç®—ç¬¦éƒ½æä¾›äº† traitï¼Œæˆ‘ä»¬å¯ä»¥ç»™è‡ªå®šä¹‰ç±»å‹é‡è½½æŸäº›æ“ä½œç¬¦ã€‚</p>
<p><img src="cs/../images/rust/operators.webp" alt="æ“ä½œè¿ç®—ç¬¦" /></p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Deref {
    // è§£å¼•ç”¨å‡ºæ¥çš„ç»“æœç±»å‹
    type Target: ?Sized;
    fn deref(&amp;self) -&gt; &amp;Self::Target;
}

// DerefMut â€œç»§æ‰¿â€äº† Deref
pub trait DerefMut: Deref {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target;
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Deref å’Œ DerefMut æ˜¯è‡ªåŠ¨è°ƒç”¨çš„ï¼Œ<code>*b</code> ä¼šè¢«å±•å¼€ä¸º <code>*(b.deref())</code></strong>ã€‚</p>
<p><img src="cs/../images/rust/deref.webp" alt="deref" /></p>
<h3 id="debug--display"><a class="header" href="#debug--display">Debug / Display</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Debug {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;
}

pub trait Display {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;
}
<span class="boring">}</span></code></pre></pre>
<p>Debug æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ï¼Œè€Œ Display æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ã€‚Debug trait çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆï¼Œè€Œ <strong>Display å¿…é¡»æ‰‹å·¥å®ç°</strong>ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒDebug ç”¨ {:?} æ¥æ‰“å°ï¼ŒDisplay ç”¨ {} æ‰“å°ã€‚</p>
<h3 id="default-ä¸ºç±»å‹æä¾›ç¼ºçœå€¼"><a class="header" href="#default-ä¸ºç±»å‹æä¾›ç¼ºçœå€¼">Default ä¸ºç±»å‹æä¾›ç¼ºçœå€¼</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Default {
    fn default() -&gt; Self;
}
<span class="boring">}</span></code></pre></pre>
<p>å¯ä»¥é€šè¿‡ derive å® #[derive(Default)] æ¥ç”Ÿæˆå®ç°ï¼Œå‰ææ˜¯ç±»å‹ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Default traitã€‚æ³¨æ„ï¼Œenum ä¸èƒ½é€šè¿‡ derive å®æ¥å®ç° Defaultï¼Œå› ä¸º enum çš„æ¯ä¸ªå˜ä½“éƒ½å¯èƒ½æœ‰ä¸åŒçš„å­—æ®µï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å®ç°ã€‚</p>
<p>åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åå‰©ä½™çš„éƒ¨åˆ†ä½¿ç”¨ <code>..Default::default()</code>ã€‚</p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<h3 id="æ™ºèƒ½æŒ‡é’ˆ-vs-èƒ–æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ-vs-èƒ–æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ vs èƒ–æŒ‡é’ˆ</a></h3>
<p>æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯èƒ–æŒ‡é’ˆï¼ˆæ¯”å¦‚ <code>String</code>ï¼‰ï¼Œä½†æ˜¯èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ˆæ¯”å¦‚ <code>&amp;str</code>ï¼‰ï¼Œå› ä¸º String å¯¹å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ²¡æœ‰æ‰€æœ‰æƒã€‚</p>
<h3 id="æ™ºèƒ½æŒ‡é’ˆ-vs-ç»“æ„ä½“"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ-vs-ç»“æ„ä½“">æ™ºèƒ½æŒ‡é’ˆ vs ç»“æ„ä½“</a></h3>
<p>å‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† <code>Deref/DerefMut/Drop</code>ï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<h3 id="boxt"><a class="header" href="#boxt">Box&lt;T&gt;</a></h3>
<h4 id="new-æ–¹æ³•"><a class="header" href="#new-æ–¹æ³•"><code>new</code> æ–¹æ³•</a></h4>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>#[cfg(not(no_global_oom_handling))]
#[inline(always)]
pub fn new(x: T) -&gt; Self {
    // box æ˜¯ Rust çš„å†…éƒ¨å…³é”®å­—ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä½¿ç”¨å†…å­˜åˆ†é…å™¨æ¥åˆ†é…å†…å­˜
    box x
}
<span class="boring">}</span></code></pre></pre>
<p>Box::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ debug æ¨¡å¼ä¸‹ï¼Œä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç°åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·æ ˆæº¢å‡ºã€‚åœ¨ release æ¨¡å¼ä¸‹ï¼Œè¯¥å‡½æ•°è°ƒç”¨ä¼šè¢«<strong>inline</strong>ä¼˜åŒ–ã€‚</p>
<h4 id="å®ç°-drop-trait"><a class="header" href="#å®ç°-drop-trait">å®ç° <code>Drop</code> trait</a></h4>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>unsafe impl&lt;#[may_dangle] T: ?Sized, A: Allocator&gt; Drop for Box&lt;T, A&gt; {
    fn drop(&amp;mut self) {
        // Do nothing, drop is currently performed by compiler.
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="cowa-b"><a class="header" href="#cowa-b">Cow&lt;'a, B&gt;</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum Cow&lt;'a, B&gt; where B: 'a + ToOwned + ?Sized {
  Borrowed(&amp;'a B),
  Owned(&lt;B as ToOwned&gt;::Owned),
}
<span class="boring">}</span></code></pre></pre>
<p>Cow åŒ…è£¹äº†ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®ã€‚è¿™ç§æ•°æ®ç»“æ„å¯ä»¥å‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…ï¼Œæå‡ç³»ç»Ÿæ•ˆç‡ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait ToOwned {
    type Owned: Borrow&lt;Self&gt;;
    #[must_use = "cloning is often expensive and is not expected to have side effects"]
    fn to_owned(&amp;self) -&gt; Self::Owned;

    fn clone_into(&amp;self, target: &amp;mut Self::Owned) { ... }
}

// Borrow æ˜¯ä¸ªæ³›å‹ traitï¼Œè¡¨æ˜ä¸€ä¸ªç±»å‹å¯ä»¥è¢«å€Ÿç”¨æˆä¸åŒçš„å¼•ç”¨
// æ¯”å¦‚ String å¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;String æˆ–è€… &amp;str
pub trait Borrow&lt;Borrowed&gt; where Borrowed: ?Sized {
    fn borrow(&amp;self) -&gt; &amp;Borrowed;
}
<span class="boring">}</span></code></pre></pre>
<p>str å¯¹ <code>ToOwned</code> trait çš„å®ç°ï¼š</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl ToOwned for str {
    type Owned = String;
    #[inline]
    fn to_owned(&amp;self) -&gt; String {
        unsafe { String::from_utf8_unchecked(self.as_bytes().to_owned()) }
    }

    fn clone_into(&amp;self, target: &amp;mut String) {
        let mut b = mem::take(target).into_bytes();
        self.as_bytes().clone_into(&amp;mut b);
        *target = unsafe { String::from_utf8_unchecked(b) }
    }
}
<span class="boring">}</span></code></pre></pre>
<p>åŒæ—¶ String å¿…é¡»è¦å®ç° <code>Borrow&lt;str&gt;</code> traitï¼Œè¿™æ ·èƒ½ç¬¦åˆ ToOwned çš„è¦æ±‚ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Borrow&lt;str&gt; for String {
    #[inline]
    fn borrow(&amp;self) -&gt; &amp;str {
        &amp;self[..]
    }
}
<span class="boring">}</span></code></pre></pre>
<p>ç»™ Cow å®ç° Deref</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;B: ?Sized + ToOwned&gt; Deref for Cow&lt;'_, B&gt; {
    type Target = B;

    fn deref(&amp;self) -&gt; &amp;B {
        // æˆ‘ä»¬åˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼•ç”¨
        match *self {
            Borrowed(borrowed) =&gt; borrowed, // å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å–å‡ºå½“ä¸­çš„å¼•ç”¨
            Owned(ref owned) =&gt; owned.borrow(), // å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h4 id="åº”ç”¨æ¡ˆä¾‹"><a class="header" href="#åº”ç”¨æ¡ˆä¾‹">åº”ç”¨æ¡ˆä¾‹</a></h4>
<pre><pre class="playground"><code class="language-rust edition2021">use std::borrow::Cow;
use url::Url;

fn main() {
    let url = Url::parse("https://tyr.com/rust?page=1024&amp;sort=desc&amp;extra=hello%20world").unwrap();
    let mut pairs = url.query_pairs();

    assert_eq!(pairs.count(), 3);

    let (mut k, v) = pairs.next().unwrap();
    // å› ä¸º k, v éƒ½æ˜¯ Cow&lt;str&gt; ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &amp;str æˆ–è€… String ä¸€æ ·
    // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed
    println!("key: {}, v: {}", k, v);
    // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned
    k.to_mut().push_str("_lala");

    print_pairs((k, v));

    print_pairs(pairs.next().unwrap());
    // åœ¨å¤„ç† extra=hello%20world æ—¶ï¼Œvalue è¢«å¤„ç†æˆ "hello world"
    // æ‰€ä»¥è¿™é‡Œ value æ˜¯ Owned
    print_pairs(pairs.next().unwrap());
}

fn print_pairs(pair: (Cow&lt;str&gt;, Cow&lt;str&gt;)) {
    println!("key: {}, value: {}", show_cow(pair.0), show_cow(pair.1));
}

fn show_cow(cow: Cow&lt;str&gt;) -&gt; String {
    match cow {
        Cow::Borrowed(v) =&gt; format!("Borrowed {}", v),
        Cow::Owned(v) =&gt; format!("Owned {}", v),
    }
}</code></pre></pre>
<pre><pre class="playground"><code class="language-rust edition2021">use serde::Deserialize;
use std::borrow::Cow;

#[derive(Debug, Deserialize)]
struct User&lt;'input&gt; {
    #[serde(borrow)]
    name: Cow&lt;'input, str&gt;,
    age: u8,
}

fn main() {
    let input = r#"{ "name": "Tyr", "age": 18 }"#;
    let user: User = serde_json::from_str(input).unwrap();

    match user.name {
        Cow::Borrowed(x) =&gt; println!("borrowed {}", x),
        Cow::Owned(x) =&gt; println!("owned {}", x),
    }
}</code></pre></pre>
<h3 id="mutexguardt"><a class="header" href="#mutexguardt">MutexGuard&lt;T&gt;</a></h3>
<p>MutexGuard é€šè¿‡ Drop trait æ¥ç¡®ä¿é€€å‡ºæ—¶é‡Šæ”¾äº’æ–¥é”ï¼Œè¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨ Mutex æ—¶ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒä½•æ—¶é‡Šæ”¾è¿™ä¸ªäº’æ–¥é”ã€‚å› ä¸ºæ— è®ºä½ åœ¨è°ƒç”¨æ ˆä¸Šæ€æ ·ä¼ é€’ MutexGuard ï¼Œå“ªæ€•åœ¨é”™è¯¯å¤„ç†æµç¨‹ä¸Šæå‰é€€å‡ºï¼ŒRust çš„æ‰€æœ‰æƒæœºåˆ¶å¯ä»¥ç¡®ä¿åªè¦ MutexGuard ç¦»å¼€ä½œç”¨åŸŸï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>MutexGuard ä¸å…è®¸ Sendï¼Œåªå…è®¸ Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ ·å¯ä»¥é¿å…å› åŠ é”å’Œè§£é”åœ¨ä¸åŒçš„çº¿ç¨‹ä¸‹å¸¦æ¥çš„æ­»é”é£é™©ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::borrow::Cow;
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰
    let metrics: Arc&lt;Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt;&gt; =
        Arc::new(Mutex::new(HashMap::new()));
    for _ in 0..32 {
        let m = metrics.clone();
        thread::spawn(move || {
            let mut g = m.lock().unwrap();
            // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap
            let data = &amp;mut *g;
            // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œ
            // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ "hello".into() ç”Ÿæˆ Cow
            let entry = data.entry("hello".into()).or_insert(0);
            *entry += 1;
            // MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾
        });
    }

    thread::sleep(Duration::from_millis(100));

    println!("metrics: {:?}", metrics.lock().unwrap());
}</code></pre></pre>
<h2 id="å†…å­˜åˆ†é…å™¨"><a class="header" href="#å†…å­˜åˆ†é…å™¨">å†…å­˜åˆ†é…å™¨</a></h2>
<h3 id="æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨"><a class="header" href="#æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨">æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨</a></h3>
<p>å †ä¸Šåˆ†é…å†…å­˜çš„ <code>Box&lt;T&gt;</code> æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° <code>A</code>ï¼Œéœ€è¦æ»¡è¶³ <code>Allocator</code>ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯ <code>Global</code>ï¼Œè¿™ä¸ª <code>Global</code> å°±æ˜¯é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use jemallocator::Jemalloc;

#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

fn main() {}</code></pre></pre>
<h3 id="è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨"><a class="header" href="#è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨">è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨</a></h3>
<p>å¦‚æœæƒ³è¦ç¼–å†™ä¸€ä¸ªå…¨å±€åˆ†é…å™¨ï¼Œå¯ä»¥å®ç° <code>GlobalAlloc</code> traitï¼Œå®ƒå’Œ <code>Allocator</code> trait çš„ä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦å…è®¸åˆ†é…é•¿åº¦ä¸º0çš„å†…å­˜ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::alloc::{GlobalAlloc, Layout, System};

struct MyAllocator;

unsafe impl GlobalAlloc for MyAllocator {
    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
        let data = System.alloc(layout);
        // è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!()
        // stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…
        // åˆ†é…çš„å†…å­˜åˆä¼šè§¦å‘ println!()ï¼Œæœ€ç»ˆé€ æˆç¨‹åºå´©æºƒ
        // eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š buffer
        eprintln!("ALLOC: {:p}, size {}", data, layout.size());
        data
    }

    unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) {
        System.dealloc(ptr, layout);
        eprintln!("FREE: {:p}, size {}", ptr, layout.size());
    }
}

#[global_allocator]
static GLOBAL: MyAllocator = MyAllocator;

#[allow(dead_code)]
struct Matrix {
    // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥
    data: [u8; 505],
}

impl Default for Matrix {
    fn default() -&gt; Self {
        Self { data: [0; 505] }
    }
}

fn main() {
    // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰å¥½å¤šå†…å­˜åˆ†é…
    let data = Box::new(Matrix::default());

    // è¾“å‡ºä¸­æœ‰ä¸€ä¸ª 1024 å¤§å°çš„å†…å­˜åˆ†é…ï¼Œæ˜¯ println! å¯¼è‡´çš„
    println!(
        "!!! allocated memory: {:p}, len: {}",
        &amp;*data,
        std::mem::size_of::&lt;Matrix&gt;()
    );

    // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE
    // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾
}</code></pre></pre>
<p>Standard Error ä¸­è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-plain">ALLOC: 0x55c63eb5b940, size 5
ALLOC: 0x55c63eb5b960, size 48
ALLOC: 0x55c63eb5b9d0, size 505
ALLOC: 0x55c63eb5b500, size 1024
FREE: 0x55c63eb5b9d0, size 505
FREE: 0x55c63eb5b500, size 1024
FREE: 0x55c63eb5b940, size 5
FREE: 0x55c63eb5b960, size 48
</code></pre>
<h2 id="åˆ‡ç‰‡"><a class="header" href="#åˆ‡ç‰‡">åˆ‡ç‰‡</a></h2>
<blockquote>
<p>å½“æˆ‘ä»¬æ„å»ºè‡ªå·±çš„æ•°æ®ç»“æ„æ—¶ï¼Œå¦‚æœå®ƒå†…éƒ¨ä¹Ÿæœ‰è¿ç»­æ’åˆ—çš„ç­‰é•¿çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘ AsRef æˆ–è€… Deref åˆ°åˆ‡ç‰‡ã€‚</p>
</blockquote>
<p>åˆ‡ç‰‡æ˜¯æè¿°ä¸€ç»„å±äºåŒä¸€ç±»å‹ã€é•¿åº¦ä¸ç¡®å®šçš„ã€åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾çš„æ•°æ®ç»“æ„ï¼Œç”¨ [T] æ¥è¡¨è¿°ã€‚å› ä¸ºé•¿åº¦ä¸ç¡®å®šï¼Œæ‰€ä»¥åˆ‡ç‰‡æ˜¯ä¸ª DSTï¼ˆDynamically Sized Typeï¼‰ã€‚åœ¨ä½¿ç”¨ä¸­ä¸»è¦ç”¨ä»¥ä¸‹å½¢å¼ï¼š</p>
<ul>
<li>&amp;[T]ï¼šè¡¨ç¤ºä¸€ä¸ªåªè¯»çš„åˆ‡ç‰‡å¼•ç”¨</li>
<li>&amp;mut [T]ï¼šè¡¨ç¤ºä¸€ä¸ªå¯å†™çš„åˆ‡ç‰‡å¼•ç”¨</li>
<li>Box&lt;[T]&gt;ï¼šä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2021">fn main() {
    let arr = [1, 2, 3, 4, 5];
    let vec = vec![1, 2, 3, 4, 5];
    let s1 = &amp;arr[..2];
    let s2 = &amp;vec[..2];
    println!("s1: {:?}, s2: {:?}", s1, s2);

    // &amp;[T] å’Œ &amp;[T] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[T] å¯ä»¥å’Œ Vec&lt;T&gt;/[T;n] æ¯”è¾ƒï¼Œä¹Ÿä¼šçœ‹é•¿åº¦å’Œå†…å®¹
    // è¿™æ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´å®ç°äº† PartialEq trait
    assert_eq!(&amp;arr[..], vec);
    assert_eq!(&amp;vec[..], arr);
}</code></pre></pre>
<p>åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹ã€‚æ¯”å¦‚ Vec å’Œ [T; n] ä¼šè½¬åŒ–æˆä¸º &amp;[T]ï¼Œè¿™æ˜¯å› ä¸º Vec å®ç°äº† Deref traitï¼Œè€Œ array å†…å»ºäº†åˆ° &amp;[T] çš„è§£å¼•ç”¨ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œé€šè¿‡è§£å¼•ç”¨ï¼Œè¿™å‡ ä¸ªå’Œåˆ‡ç‰‡æœ‰å…³çš„æ•°æ®ç»“æ„éƒ½ä¼šè·å¾—åˆ‡ç‰‡çš„æ‰€æœ‰èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼š<code>binary_search</code>ã€<code>chunks</code>ã€<code>concat</code>ã€<code>contains</code>ã€<code>start_with</code>ã€<code>end_with</code>ã€<code>group_by</code>ã€<code>iter</code>ã€<code>join</code>ã€<code>sort</code>ã€<code>split</code>ã€<code>swap</code> ç­‰ä¸€ç³»åˆ—ä¸°å¯Œçš„åŠŸèƒ½ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::fmt;
fn main() {
    let v = vec![1, 2, 3, 4];

    // Vec å®ç°äº† Derefï¼Œ&amp;Vec&lt;T&gt; ä¼šè¢«è‡ªåŠ¨è§£å¼•ç”¨ä¸º &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v);
    // ç›´æ¥æ˜¯ &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v[..]);

    // &amp;Vec&lt;T&gt; æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v);
    // &amp;[T] æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v[..]);
    // Vec&lt;T&gt; ä¹Ÿæ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(v);

    let arr = [1, 2, 3, 4];
    // æ•°ç»„è™½æ²¡æœ‰å®ç° Derefï¼Œä½†å®ƒçš„è§£å¼•ç”¨å°±æ˜¯ &amp;[T]
    print_slice(&amp;arr);
    print_slice(&amp;arr[..]);
    print_slice1(&amp;arr);
    print_slice1(&amp;arr[..]);
    print_slice1(arr);
}

fn print_slice&lt;T: fmt::Debug&gt;(s: &amp;[T]) {
    println!("{:?}", s);
}

fn print_slice1&lt;T, U&gt;(s: T)
where
    T: AsRef&lt;[U]&gt;,
    U: fmt::Debug,
{
    println!("{:?}", s.as_ref());
}</code></pre></pre>
<h3 id="å°†-slice-è½¬åŒ–æˆè¿­ä»£å™¨"><a class="header" href="#å°†-slice-è½¬åŒ–æˆè¿­ä»£å™¨">å°† slice è½¬åŒ–æˆè¿­ä»£å™¨</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">fn main() {
    // è¿™é‡Œ Vec åœ¨è°ƒç”¨ iter() æ—¶è¢«è§£å¼•ç”¨æˆ &amp;[T]ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—® iter()
    let result: Vec&lt;i32&gt; = vec![1, 2, 3, 4]
        .iter()
        .map(|v| v * v)
        .filter(|v| *v &lt; 16)
        .collect();

    println!("{:?}", result);
}</code></pre></pre>
<p>Rust ä¸‹çš„è¿­ä»£å™¨æ˜¯ä¸ª<code>æ‡’æ¥å£ï¼ˆlazy interfaceï¼‰</code>ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ®µä»£ç ç›´åˆ°è¿è¡Œåˆ° <code>collect</code> æ—¶æ‰çœŸæ­£å¼€å§‹æ‰§è¡Œï¼Œä¹‹å‰çš„éƒ¨åˆ†ä¸è¿‡æ˜¯åœ¨ä¸æ–­åœ°ç”Ÿæˆæ–°çš„ç»“æ„ï¼Œæ¥ç´¯ç§¯å¤„ç†é€»è¾‘è€Œå·²ã€‚Rust å¤§é‡ä½¿ç”¨äº† inline ç­‰ä¼˜åŒ–æŠ€å·§ï¼Œä½¿å¾—è¿­ä»£å™¨çš„æ€§èƒ½å’Œ C è¯­è¨€çš„ for å¾ªç¯å·®åˆ«ä¸å¤§ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>itertools</code> crate è¿˜æä¾›äº†é¢å¤–çš„ï¼Œæ ‡å‡†åº“ä¸­æ²¡æœ‰æä¾›çš„è¿­ä»£å™¨ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use itertools::Itertools;

fn main() {
    let err_str = "bad happened";
    let input = vec![Ok(21), Err(err_str), Ok(7)];
    let it = input
        .into_iter()
        // å¯¹æˆåŠŸçš„ç»“æœè¿›ä¸€æ­¥åš filter/map æ“ä½œ
        .filter_map_ok(|i| if i &gt; 10 { Some(i * 2) } else { None });
    // ç»“æœåº”è¯¥æ˜¯ï¼švec![Ok(42), Err(err_str)]
    println!("{:?}", it.collect::&lt;Vec&lt;_&gt;&gt;());
}</code></pre></pre>
<h3 id="ç‰¹æ®Šçš„åˆ‡ç‰‡-str"><a class="header" href="#ç‰¹æ®Šçš„åˆ‡ç‰‡-str">ç‰¹æ®Šçš„åˆ‡ç‰‡ &amp;str</a></h3>
<p><img src="cs/../images/rust/string-slice-vs-vector-slice.webp" alt="å­—ç¬¦åˆ—è¡¨å’Œå­—ç¬¦ä¸²çš„åŒºåˆ«" /></p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::iter::FromIterator;

fn main() {
    let arr = ['h', 'e', 'l', 'l', 'o'];
    let vec = vec!['h', 'e', 'l', 'l', 'o'];
    let s = String::from("hello");
    let s1 = &amp;arr[1..3];
    let s2 = &amp;vec[1..3];
    // &amp;str æœ¬èº«å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ slice
    let s3 = &amp;s[1..3];
    println!("s1: {:?}, s2: {:?}, s3: {:?}", s1, s2, s3);

    // &amp;[char] å’Œ &amp;[char] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[char] å’Œ &amp;str ä¸èƒ½ç›´æ¥å¯¹æ¯”ï¼Œæˆ‘ä»¬æŠŠ s3 å˜æˆ Vec&lt;char&gt;
    assert_eq!(s2, s3.chars().collect::&lt;Vec&lt;_&gt;&gt;());
    // &amp;[char] å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString å’Œ &amp;str å¯ä»¥ç›´æ¥å¯¹æ¯”
    assert_eq!(String::from_iter(s2), s3);
}</code></pre></pre>
<p>å­—ç¬¦åˆ—è¡¨å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString ä¹Ÿå¯ä»¥é€šè¿‡ chars() å‡½æ•°è½¬æ¢æˆå­—ç¬¦åˆ—è¡¨ï¼Œå¦‚æœä¸è½¬æ¢ï¼ŒäºŒè€…ä¸èƒ½æ¯”è¾ƒã€‚</p>
<h3 id="boxt-å †ä¸Šçš„åˆ‡ç‰‡"><a class="header" href="#boxt-å †ä¸Šçš„åˆ‡ç‰‡">Box&lt;[T]&gt; å †ä¸Šçš„åˆ‡ç‰‡</a></h3>
<p><code>Box&lt;[T]&gt;</code> å’Œåˆ‡ç‰‡çš„å¼•ç”¨ <code>&amp;[T]</code> å¾ˆç±»ä¼¼ï¼šå®ƒä»¬éƒ½æ˜¯åœ¨æ ˆä¸Šæœ‰ä¸€ä¸ªåŒ…å«é•¿åº¦çš„èƒ–æŒ‡é’ˆï¼ŒæŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜ä½ç½®ã€‚åŒºåˆ«æ˜¯ï¼š<code>Box&lt;[T]&gt;</code> åªä¼šæŒ‡å‘å †ï¼Œ<code>&amp;[T]</code> æŒ‡å‘çš„ä½ç½®å¯ä»¥æ˜¯æ ˆä¹Ÿå¯ä»¥æ˜¯å †ï¼›æ­¤å¤–ï¼Œ<code>Box&lt;[T]&gt;</code> å¯¹æ•°æ®å…·æœ‰æ‰€æœ‰æƒï¼Œè€Œ <code>&amp;[T]</code> åªæ˜¯ä¸€ä¸ªå€Ÿç”¨ã€‚</p>
<p><code>Box&lt;[T]&gt;</code> å’Œ <code>Vec&lt;T&gt;</code> æœ‰ä¸€ç‚¹ç‚¹å·®åˆ«ï¼š<code>Vec&lt;T&gt;</code> æœ‰é¢å¤–çš„ capacityï¼Œå¯ä»¥å¢é•¿ï¼›è€Œ <code>Box&lt;[T]&gt;</code> ä¸€æ—¦ç”Ÿæˆå°±å›ºå®šä¸‹æ¥ï¼Œæ²¡æœ‰ capacityï¼Œä¹Ÿæ— æ³•å¢é•¿ã€‚</p>
<p><img src="cs/../images/rust/slice-on-heap.webp" alt="å †ä¸Šçš„åˆ‡ç‰‡" /></p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::ops::Deref;

fn main() {
    let mut v1 = vec![1, 2, 3, 4];
    v1.push(5);
    println!("cap should be 8: {}", v1.capacity());

    // ä» Vec&lt;T&gt; è½¬æ¢æˆ Box&lt;[T]&gt;ï¼Œæ­¤æ—¶ä¼šä¸¢å¼ƒå¤šä½™çš„ capacity
    let b1 = v1.into_boxed_slice();
    let mut b2 = b1.clone();

    let v2 = b1.into_vec();
    println!("cap should be exactly 5: {}", v2.capacity());

    assert!(b2.deref() == v2);

    // Box&lt;[T]&gt; å¯ä»¥æ›´æ”¹å…¶å†…éƒ¨æ•°æ®ï¼Œä½†æ— æ³• push
    b2[0] = 2;
    // b2.push(6);
    println!("b2: {:?}", b2);

    // æ³¨æ„ Box&lt;[T]&gt; å’Œ Box&lt;[T; n]&gt; å¹¶ä¸ç›¸åŒ
    let b3 = Box::new([2, 2, 3, 4, 5]);
    println!("b3: {:?}", b3);

    // b2 å’Œ b3 ç›¸ç­‰ï¼Œä½† b3.deref() å’Œ v2 æ— æ³•æ¯”è¾ƒ
    assert!(b2 == b3);
    // assert!(b3.deref() == v2);
}</code></pre></pre>
<p><code>Vec&lt;T&gt;</code> å¯ä»¥é€šè¿‡ i<code>nto_boxed_slice()</code> è½¬æ¢æˆ <code>Box&lt;[T]&gt;</code>ï¼Œ<code>Box&lt;[T]&gt;</code> ä¹Ÿå¯ä»¥é€šè¿‡ <code>into_vec()</code> è½¬æ¢å› <code>Vec&lt;T&gt;</code>ã€‚</p>
<p><code>Box&lt;[T]&gt;</code> æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯ï¼Œä¸åƒ <code>Box&lt;[T;n]&gt;</code> é‚£æ ·åœ¨ç¼–è¯‘æ—¶å°±è¦ç¡®å®šå¤§å°ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œä»¥åå¤§å°ä¸ä¼šå†æ”¹å˜ã€‚</p>
<h2 id="hashmap"><a class="header" href="#hashmap">HashMap</a></h2>
<p>Rust å“ˆå¸Œè¡¨ä¸æ˜¯ç”¨å†²çªé“¾æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œè€Œæ˜¯ç”¨å¼€æ”¾å¯»å€æ³•çš„äºŒæ¬¡æ¢æŸ¥æ¥è§£å†³çš„ã€‚</p>
<p>å¦‚æœåªéœ€è¦ç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¯ä»¥ç”¨ HashSetï¼Œå®ƒå°±æ˜¯ç®€åŒ–çš„ HashMapï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ— åºçš„é›†åˆã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use hashbrown::hash_map as base;

// RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•
#[derive(Clone)]
pub struct RandomState {
    k0: u64,
    k1: u64,
}

pub struct HashMap&lt;K, V, S = RandomState&gt; {
    // å¤ç”¨äº† hashbrown åº“çš„ HashMap
    base: base::HashMap&lt;K, V, S&gt;,
}

// hashbrown åº“çš„ HashMap
pub struct HashMap&lt;K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {
    pub(crate) hash_builder: S,
    pub(crate) table: RawTable&lt;(K, V), A&gt;,
}

pub struct RawTable&lt;T, A: Allocator + Clone = Global&gt; {
    table: RawTableInner&lt;A&gt;,

    // Tell dropck that we own instances of T.
    marker: PhantomData&lt;T&gt;,
}

struct RawTableInner&lt;A&gt; {
    bucket_mask: usize,

    // [Padding], T1, T2, ..., Tlast, C1, C2, ...
    //                                ^ points here
    // æŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒº
    ctrl: NonNull&lt;u8&gt;,

    // å“ˆå¸Œè¡¨åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¢é•¿å‰è¿˜èƒ½å­˜å‚¨å¤šå°‘æ•°æ®
    // éšç€å“ˆå¸Œè¡¨ä¸æ–­æ’å…¥æ•°æ®ï¼Œå®ƒä¼šä»¥ 2 çš„å¹‚å‡ä¸€çš„æ–¹å¼å¢é•¿
    growth_left: usize,

    // å“ˆå¸Œè¡¨ç°åœ¨æœ‰å¤šå°‘æ•°æ®
    items: usize,
    alloc: A,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="è‡ªå®šä¹‰æ•°æ®ç»“æ„åš-hash-key"><a class="header" href="#è‡ªå®šä¹‰æ•°æ®ç»“æ„åš-hash-key">è‡ªå®šä¹‰æ•°æ®ç»“æ„åš Hash key</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">use std::{
    collections::{hash_map::DefaultHasher, HashMap},
    hash::{Hash, Hasher},
};

// å¦‚æœè¦æ”¯æŒ Hashï¼Œå¯ä»¥ç”¨ #[derive(Hash)]ï¼Œå‰ææ˜¯æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Hash
// å¦‚æœè¦èƒ½ä½œä¸º HashMap çš„ keyï¼Œè¿˜éœ€è¦ PartialEq å’Œ Eq
#[derive(Debug, Hash, PartialEq, Eq)]
struct Student&lt;'a&gt; {
    name: &amp;'a str,
    age: u8,
}

impl&lt;'a&gt; Student&lt;'a&gt; {
    pub fn new(name: &amp;'a str, age: u8) -&gt; Self {
        Self { name, age }
    }
}

fn main() {
    let mut hasher = DefaultHasher::new();
    let student = Student::new("Tyr", 18);
    // å®ç°äº† Hash çš„æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥è°ƒç”¨ hash æ–¹æ³•
    student.hash(&amp;mut hasher);
    let mut map = HashMap::new();
    // å®ç°äº† Hash / PartialEq / Eq çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º HashMap çš„ key
    map.insert(student, vec!["Math", "Writing"]);
    println!("hash: 0x{:x}, map: {:?}", hasher.finish(), map);
}</code></pre></pre>
<h2 id="btreemap"><a class="header" href="#btreemap">BTreeMap</a></h2>
<p>BTreeMap æ˜¯å†…éƒ¨ä½¿ç”¨ B-tree æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼Œå’Œ HashMap ä¸åŒçš„æ˜¯ï¼ŒBTreeMap æ˜¯æœ‰åºçš„ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::collections::BTreeMap;

fn main() {
    let map = BTreeMap::new();
    let mut map = explain("empty", map);

    for i in 0..16usize {
        map.insert(format!("Tyr {}", i), i);
    }

    let mut map = explain("added", map);

    map.remove("Tyr 1");

    let map = explain("remove 1", map);

    for item in map.iter() {
        println!("{:?}", item);
    }
}

// BTreeMap ç»“æ„æœ‰ heightï¼Œnode å’Œ length
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: BTreeMap&lt;K, V&gt;) -&gt; BTreeMap&lt;K, V&gt; {
    let arr: [usize; 3] = unsafe { std::mem::transmute(map) };
    println!(
        "{}: height: {}, root node: 0x{:x}, len: 0x{:x}",
        name, arr[0], arr[1], arr[2]
    );
    unsafe { std::mem::transmute(arr) }
}</code></pre></pre>
<p>å¦‚æœæƒ³è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º BTreeMap çš„ keyï¼Œé‚£ä¹ˆéœ€è¦å®ç° PartialOrd å’Œ Ordã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::collections::BTreeMap;

#[derive(Debug, PartialOrd, Ord, PartialEq, Eq)]
struct Name {
    pub name: String,
    pub flags: u32,
}

impl Name {
    pub fn new(name: impl AsRef&lt;str&gt;, flags: u32) -&gt; Self {
        Self {
            name: name.as_ref().to_string(),
            flags,
        }
    }
}

fn main() {
    let mut map = BTreeMap::new();
    map.insert(Name::new("/etc/password", 0x1), 12);
    map.insert(Name::new("/etc/hosts", 0x1), 4);
    map.insert(Name::new("/home/tchen", 0x0), 28);

    for item in map.iter() {
        println!("{:?}", item);
    }
}</code></pre></pre>
<h2 id="é”™è¯¯å¤„ç†"><a class="header" href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></h2>
<h3 id="-æ“ä½œç¬¦"><a class="header" href="#-æ“ä½œç¬¦"><code>?</code> æ“ä½œç¬¦</a></h3>
<p>? æ“ä½œç¬¦å†…éƒ¨è¢«å±•å¼€æˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>match result {
    Ok(v) =&gt; v,
    Err(e) =&gt; return Err(e.into())
}
<span class="boring">}</span></code></pre></pre>
<h3 id="å‡½æ•°å¼é”™è¯¯å¤„ç†"><a class="header" href="#å‡½æ•°å¼é”™è¯¯å¤„ç†">å‡½æ•°å¼é”™è¯¯å¤„ç†</a></h3>
<p><img src="cs/../images/rust/functional-error-handling.webp" alt="å‡½æ•°å¼é”™è¯¯å¤„ç†" /></p>
<h3 id="cache_unwind"><a class="header" href="#cache_unwind">cache_unwind</a></h3>
<p>Rust æ ‡å‡†åº“æä¾›äº†<code>catch_unwind()</code>å‡½æ•°ï¼Œèƒ½å¤Ÿåƒå¼‚å¸¸å¤„ç†é‚£æ ·å°†è°ƒç”¨æ ˆå›æº¯åˆ° catch_unwind è¿™ä¸€åˆ»ï¼Œä½œç”¨å’Œå…¶å®ƒè¯­è¨€çš„ try {â€¦} catch {â€¦} ä¸€æ ·ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::panic;

fn main() {
    let result = panic::catch_unwind(|| {
        println!("hello!");
    });
    assert!(result.is_ok());
    let result = panic::catch_unwind(|| {
        panic!("oh no!");
    });
    assert!(result.is_err());
    println!("panic captured: {:#?}", result);
}</code></pre></pre>
<h3 id="error-trait"><a class="header" href="#error-trait"><code>Error</code> trait</a></h3>
<p>ä¸ºäº†è§„èŒƒä»£è¡¨é”™è¯¯çš„æ•°æ®ç±»å‹çš„è¡Œä¸ºï¼ŒRust å®šä¹‰äº† Error traitï¼š</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Error: Debug + Display {
    fn source(&amp;self) -&gt; Option&lt;&amp;(dyn Error + 'static)&gt; { ... }
    fn backtrace(&amp;self) -&gt; Option&lt;&amp;Backtrace&gt; { ... }
    fn description(&amp;self) -&gt; &amp;str { ... }
    fn cause(&amp;self) -&gt; Option&lt;&amp;dyn Error&gt; { ... }
}
<span class="boring">}</span></code></pre></pre>
<p><a href="https://github.com/dtolnay/thiserror">thiserror</a> å¯ä»¥å¸®åŠ©ç®€åŒ–é”™è¯¯ç±»å‹çš„å®šä¹‰ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use thiserror::Error;
#[derive(Error, Debug)]
#[non_exhaustive]
pub enum DataStoreError {
    #[error("data store disconnected")]
    Disconnect(#[from] io::Error),
    #[error("the data for key `{0}` is not available")]
    Redaction(String),
    #[error("invalid header (expected {expected:?}, found {found:?})")]
    InvalidHeader {
        expected: String,
        found: String,
    },
    #[error("unknown data store error")]
    Unknown,
}
<span class="boring">}</span></code></pre></pre>
<p><a href="https://github.com/dtolnay/anyhow">anyhow</a> å®ç°äº† <code>anyhow::Error</code> å’Œä»»æ„ç¬¦åˆ Error trait çš„é”™è¯¯ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ <code>?</code> æ“ä½œç¬¦ï¼Œä¸å¿…å†æ‰‹å·¥è½¬æ¢é”™è¯¯ç±»å‹ã€‚</p>
<h2 id="é—­åŒ…"><a class="header" href="#é—­åŒ…">é—­åŒ…</a></h2>
<p>é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡ã€‚é—­åŒ…æ˜¯å­˜å‚¨åœ¨<strong>æ ˆ</strong>ä¸Šï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::{collections::HashMap, mem::size_of_val};

// é•¿åº¦ä¸º 0
let c1 = || println!("hello world!");
// å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
let c2 = |i: i32| println!("hello: {}", i);
let name = String::from("tyr");
let name1 = name.clone();
let mut table = HashMap::new();
table.insert("hello", "world");
// å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
let c3 = || println!("hello: {}", name);
// æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œå› æ­¤ closure é•¿åº¦ 72
let c4 = move || println!("hello: {}, {:?}", name1, table);
let name2 = name.clone();
// å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œå› æ­¤ closure é•¿åº¦ 24
let c5 = move || {
    let x = 1;
    let name3 = String::from("lindsey");
    println!("hello: {}, {:?}, {:?}", x, name2, name3);
};

println!(
    "c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}",
    size_of_val(&amp;c1),
    size_of_val(&amp;c2),
    size_of_val(&amp;c3),
    size_of_val(&amp;c4),
    size_of_val(&amp;c5),
    size_of_val(&amp;main),
);
<span class="boring">}</span></code></pre></pre>
<p><strong>ä¸å¸¦ move æ—¶ï¼Œé—­åŒ…æ•è·çš„æ˜¯å¯¹åº”è‡ªç”±å˜é‡çš„å¼•ç”¨ï¼›å¸¦ move æ—¶ï¼Œå¯¹åº”è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨åˆ°é—­åŒ…ç»“æ„ä¸­</strong>ã€‚</p>
<h3 id="é—­åŒ…çš„ç±»å‹"><a class="header" href="#é—­åŒ…çš„ç±»å‹">é—­åŒ…çš„ç±»å‹</a></h3>
<p><img src="cs/../images/rust/closure-trait.webp" alt="é—­åŒ…çš„ç±»å‹" /></p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait FnOnce&lt;Args&gt; {
    type Output;
    // ä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­
    extern "rust-call" fn call_once(self, args: Args) -&gt; Self::Output;
}
<span class="boring">}</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ä¸€ä¸ª FnMut é—­åŒ…ï¼Œå¯ä»¥è¢«ä¼ ç»™ä¸€ä¸ªéœ€è¦ FnOnce çš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è°ƒç”¨é—­åŒ…ç›¸å½“äºè°ƒç”¨äº† call_once()
pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; {
    extern "rust-call" fn call_mut(
        &amp;mut self,
        args: Args
    ) -&gt; Self::Output;
}
<span class="boring">}</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…
pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; {
    extern "rust-call" fn call(&amp;self, args: Args) -&gt; Self::Output;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’"><a class="header" href="#å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’">å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">fn main() {
    let v = vec![0u8; 1024];
    let v1 = vec![0u8; 1023];

    // Fnï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒ
    let mut c = |x: u64| v.len() as u64 * x;
    // Fnï¼Œç§»åŠ¨æ‰€æœ‰æƒ
    let mut c1 = move |x: u64| v1.len() as u64 * x;

    println!("direct call: {}", c(2));
    println!("direct call: {}", c1(2));

    println!("call: {}", call(3, &amp;c));
    println!("call: {}", call(3, &amp;c1));

    println!("call_mut: {}", call_mut(4, &amp;mut c));
    println!("call_mut: {}", call_mut(4, &amp;mut c1));

    println!("call_once: {}", call_once(5, c));
    println!("call_once: {}", call_once(5, c1));
}

fn call(arg: u64, c: &amp;impl Fn(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_mut(arg: u64, c: &amp;mut impl FnMut(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_once(arg: u64, c: impl FnOnce(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}</code></pre></pre>
<h3 id="è¿”å›é—­åŒ…"><a class="header" href="#è¿”å›é—­åŒ…">è¿”å›é—­åŒ…</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">use std::ops::Mul;

fn main() {
    let c1 = curry(5);
    println!("5 multiply 2 is: {}", c1(2));

    let adder2 = curry(3.14);
    println!("pi multiply 4^2 is: {}", adder2(4. * 4.));
}

fn curry&lt;T&gt;(x: T) -&gt; impl Fn(T) -&gt; T
where
    T: Mul&lt;Output = T&gt; + Copy,
{
    move |y| x * y
}</code></pre></pre>
<h3 id="ç»™é—­åŒ…å®ç°å…¶ä»–-trait"><a class="header" href="#ç»™é—­åŒ…å®ç°å…¶ä»–-trait">ç»™é—­åŒ…å®ç°å…¶ä»– trait</a></h3>
<p>æœ‰äº›æ¥å£æ—¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼Œåˆå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æˆ–è€…é—­åŒ…ã€‚</p>
<pre><pre class="playground"><code class="language-rust edition2021">pub trait Executor {
    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;'static str&gt;;
}

struct BashExecutor {
    env: String,
}

impl Executor for BashExecutor {
    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;'static str&gt; {
        Ok(format!(
            "fake bash execute: env: {}, cmd: {}",
            self.env, cmd
        ))
    }
}

impl&lt;T&gt; Executor for T
where
    T: Fn(&amp;str) -&gt; Result&lt;String, &amp;'static str&gt;,
{
    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;'static str&gt; {
        self(cmd)
    }
}

fn main() {
    let env = "PATH=/usr/bin".to_string();

    let cmd = "cat /etc/passwd";
    let r1 = execute(cmd, BashExecutor { env: env.clone() });
    println!("{:?}", r1);

    let r2 = execute(cmd, |cmd: &amp;str| {
        Ok(format!("fake fish execute: env: {}, cmd: {}", env, cmd))
    });
    println!("{:?}", r2);
}

fn execute(cmd: &amp;str, exec: impl Executor) -&gt; Result&lt;String, &amp;'static str&gt; {
    exec.execute(cmd)
}</code></pre></pre>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://cheats.rs/">cheats.rs</a></li>
<li><a href="https://lldb.llvm.org/use/map.html">GDB/LLDB å‘½ä»¤æ‰‹å†Œ</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ§åˆ¶ç³»ç»ŸåŸºç¡€"><a class="header" href="#æ§åˆ¶ç³»ç»ŸåŸºç¡€">æ§åˆ¶ç³»ç»ŸåŸºç¡€</a></h1>
<h2 id="æ§åˆ¶ç³»ç»Ÿå»ºæ¨¡"><a class="header" href="#æ§åˆ¶ç³»ç»Ÿå»ºæ¨¡">æ§åˆ¶ç³»ç»Ÿå»ºæ¨¡</a></h2>
<p>å¯¹äºä¸€ä¸ªè¾“å…¥ä¸º \(u\)ï¼Œè¾“å‡ºä¸º \(y\) çš„åŠ¨æ€ç³»ç»Ÿï¼Œå½“ \(t\) æ—¶åˆ»çš„è¾“å‡º \(y(t)\) ç”±ç›´åˆ° \(t\) æ—¶åˆ»ä¸ºæ­¢çš„è¾“å…¥å’Œè¾“å‡ºæ¥å†³å®šçš„æ—¶å€™ï¼Œè¿™ä¸ªç³»ç»Ÿå¯ä»¥ç”¨ä¸‹é¢çš„å¾®åˆ†æ–¹ç¨‹æ¥è¡¨ç¤ºï¼š</p>
<p>$$
\frac{d^n}{dt^n}y(t) + a_{n-1}\frac{d^{n-1}}{dt^{n-1}}y(t) + \cdots + a_1\frac{d}{dt}y(t) + a_0y(t) \\
= b_m\frac{d^m}{dt^m}u(t) + b_{m-1}\frac{d^{m-1}}{dt^{m-1}}u(t) + \cdots + b_1\frac{d}{dt}u(t) + b_0u(t)
$$</p>
<p>å¾®åˆ†æ–¹ç¨‹å¾ˆéš¾æ±‚è§£ä»¥åŠåˆ†æç³»ç»Ÿè¡Œä¸ºï¼Œæ‰€ä»¥é€šå¸¸ä¼šå°†å¾®åˆ†æ–¹ç¨‹è½¬æ¢æˆ<strong>ä¼ é€’å‡½æ•°æ¨¡å‹</strong>æˆ–è€…<strong>çŠ¶æ€ç©ºé—´æ¨¡å‹</strong>ã€‚</p>
<h3 id="ä¼ é€’å‡½æ•°"><a class="header" href="#ä¼ é€’å‡½æ•°">ä¼ é€’å‡½æ•°</a></h3>
<p>ä¼ é€’å‡½æ•°æ¨¡å‹ä½¿ç”¨å¤å˜å‡½æ•°æ¥è¡¨ç°ç³»ç»Ÿæ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡å°†å¾®åˆ†æ–¹ç¨‹ä¸¤è¾¹è¿›è¡Œåˆå§‹å€¼ä¸º0çš„æ‹‰æ™®æ‹‰æ–¯å˜æ¢å¾—åˆ°ã€‚</p>
<p>æ‹‰æ™®æ‹‰æ–¯å˜æ¢çš„å®šä¹‰ï¼š\(g(s) = \mathcal{L}[g(t)] = \int_0^{\infty}g(\tau)e^{-s\tau}d\tau\)</p>
<hr />
<p>å¾®åˆ†çš„æ‹‰æ™®æ‹‰æ–¯å˜æ¢</p>
<p>$$
\begin{align}
\mathcal{L}[\dot y(t)] &amp;= \int_0^{\infty}\dot y(\tau)e^{-s\tau}d\tau \\
&amp;= [y(\tau)e^{-s\tau}]_0^{\infty} - \int_0^{\infty}-sy(\tau)e^{-s\tau}d\tau \\
&amp;= [y(\tau)e^{-s\tau}]_0^{\infty} + s\int_0^{\infty}y(\tau)e^{-s\tau}d\tau \\
&amp;= y(\infty) -y(0) + s\mathcal{L}[y(t)] \\
&amp;= sy(s) - y(0)
\end{align}
$$</p>
<p>ä»¤ \(y(0) = 0\)ï¼Œåˆ™å¾—åˆ° \(\mathcal{L}[\dot y(t)] = sy(s)\)</p>
<hr />
<p>ç§¯åˆ†çš„æ‹‰æ™®æ‹‰æ–¯å˜æ¢</p>
<p>ä»¤ \(f(t) = \int_0^ty(\tau)d\tau\), åˆ™ \(\dot f(t) = y(t)\)</p>
<p>$$
\begin{align}
\mathcal{L}[\dot f(t)] &amp;= sf(s) - f(0) \\
&amp;= sf(s) - \int_0^0y(\tau)d\tau \\
&amp;= sf(s)
\end{align}
$$</p>
<p>$$
\mathcal{L}[\int_0^ty(\tau)d\tau] = \mathcal{L}[f(t)] = f(s) = \frac{1}{s}\mathcal{L}[\dot f(t)] = \frac{1}{s}\mathcal{L}[y(t)] = \frac{1}{s}y(s)
$$</p>
<h3 id="çŠ¶æ€ç©ºé—´"><a class="header" href="#çŠ¶æ€ç©ºé—´">çŠ¶æ€ç©ºé—´</a></h3>
<p>çŠ¶æ€ç©ºé—´æ¨¡å‹é€šè¿‡çŸ©é˜µçš„å½¢å¼å°†å¤šå…ƒé«˜é˜¶å¾®åˆ†æ–¹ç¨‹è¡¨ç¤ºæˆä¸€é˜¶å¾®åˆ†æ–¹ç¨‹çš„å½¢å¼ã€‚ä¼ é€’å‡½æ•°æ¨¡å‹è¡¨è¾¾çš„æ˜¯è¾“å…¥å’Œè¾“å‡ºçš„å…³ç³»ï¼Œè€ŒçŠ¶æ€ç©ºé—´æ¨¡å‹è¡¨è¾¾çš„æ˜¯è¾“å…¥-&gt;çŠ¶æ€-&gt;è¾“å‡ºçš„å…³ç³»ã€‚æˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°é€‰æ‹©çŠ¶æ€å˜é‡ã€‚æ­¤å¤–ï¼ŒçŠ¶æ€ç©ºé—´æ¨¡å‹ä¹Ÿå¯ä»¥å¤„ç†åˆå§‹å€¼ä¸ä¸º0çš„æƒ…å†µã€‚</p>
<p>$$
\mathcal{P}:
\begin{cases}
\mathbf{\dot x}(t) &amp;= \mathbf{A} \mathbf{x}(t) + \mathbf{B} \mathbf{u}(t) \\
\mathbf{y}(t)      &amp;= \mathbf{C} \mathbf{x}(t) + \mathbf{D} \mathbf{u}(t)
\end{cases}
$$</p>
<p>è¿™é‡Œçš„\(\mathbf{x}\)ä¸ºçŠ¶æ€ï¼Œ\(\mathbf{u}\)ä¸ºè¾“å…¥ï¼Œ\(\mathbf{y}\)ä¸ºè¾“å‡ºï¼Œ\(\mathbf{A}\), \(\mathbf{B}\), \(\mathbf{C}\), \(\mathbf{D}\)ä¸ºå¸¸æ•°çŸ©é˜µã€‚</p>
<h3 id="rlc-ç”µè·¯"><a class="header" href="#rlc-ç”µè·¯">RLC ç”µè·¯</a></h3>
<p><img src="ee/../images/control/RLC.jpg" alt="RLCç”µè·¯" /></p>
<p>æ ¹æ®æ¬§å§†å®šå¾‹ï¼Œ
$$
v_{in}(t) = L\frac{d}{dt}i(t) + Ri(t) + \frac{1}{C}\int_{0}^{t}i(\tau) d\tau
$$</p>
<p>è®¾å®šè¾“å‡ºä¸º \(y(t) = v_{out}(t) = \frac{1}{C}\int_{0}^{t}i(\tau) d\tau\), åˆ™ \(C\dot y(t) = i(t)\)</p>
<p>è®¾å®šè¾“å…¥ä¸º \(u(t) = v_{in}(t)\)</p>
<p>å¯ä»¥å¾—åˆ°
$$
LC\ddot y(t) + RC\dot y(t) + y(t) = u(t)
$$</p>
<h4 id="ä¼ é€’å‡½æ•°æ¨¡å‹"><a class="header" href="#ä¼ é€’å‡½æ•°æ¨¡å‹">ä¼ é€’å‡½æ•°æ¨¡å‹</a></h4>
<p>å¯¹å¾®åˆ†æ–¹ç¨‹ä¸¤è¾¹åšæ‹‰æ™®æ‹‰æ–¯å˜æ¢ï¼Œå¾—åˆ°
$$
LCs^2y(s) + RCsy(s) + y(s) = u(s)
$$</p>
<p>äºæ˜¯ä¼ é€’å‡½æ•°æ¨¡å‹ç­‰äº
$$
\mathcal{P} = \frac{y(s)}{u(s)} = \frac{1}{LCs^2 + RCs + 1}
$$</p>
<h4 id="çŠ¶æ€ç©ºé—´æ¨¡å‹"><a class="header" href="#çŠ¶æ€ç©ºé—´æ¨¡å‹">çŠ¶æ€ç©ºé—´æ¨¡å‹</a></h4>
<p>è®¾ \(\mathbf{x}(t) = \left[ \begin{matrix}
\int_0^t i(\tau)d\tau \\
i(t) \\
\end{matrix} \right] \)ï¼Œ \(u(t) = v_{in}\)ï¼Œ\(y(t) = \frac{1}{C}\int_0^t i(\tau)d\tau\)</p>
<p>åˆ™çŠ¶æ€æ–¹ç¨‹ä¸º
$$
\mathbf{\dot x}(t) = \left[ \begin{matrix}
0&amp; 1 \\
-\frac{1}{LC}&amp; -\frac{R}{L} \\
\end{matrix}\right] \mathbf{x}(t) + \left[ \begin{matrix}
0 \\
\frac{1}{L} \\
\end{matrix} \right] u(t)
$$</p>
<p>è€Œè¾“å‡ºæ–¹ç¨‹ä¸º
$$
y(t) = \left[ \begin{matrix}
\frac{1}{C} \quad 0
\end{matrix}\right] \mathbf{x}(t)
$$</p>
<h3 id="è¿æ”¾ç”µè·¯"><a class="header" href="#è¿æ”¾ç”µè·¯">è¿æ”¾ç”µè·¯</a></h3>
<p><img src="ee/../images/control/Opamp.jpg" alt="è¿æ”¾ç”µè·¯" /></p>
<p>æ ¹æ®è¿æ”¾çš„"è™šçŸ­"ç‰¹æ€§ï¼Œå¯ä»¥å¾—åˆ° \(i_1(t) = \frac{v_{in}(t)}{R_1}\), \(i_2(t) = \frac{v_{out}(t)}{R_2}\)</p>
<p>ä»¥åŠ \(v_{out}(t) = \frac{1}{C}\int_{0}^{\tau}i_3(\tau) d\tau\)ï¼Œ å³ \(i_3(t) = C\dot v_{out}\)</p>
<p>æ ¹æ®è¿æ”¾çš„"è™šæ–­"ç‰¹æ€§ï¼Œ\(i_1(t) + i_2(t) + i_3(t) = 0\)</p>
<p>ä»£å…¥æ–¹ç¨‹å¾—åˆ°
$$
\frac{v_{in}(t)}{R_1} + \frac{v_{out}(t)}{R_2} + C\dot v_{out}(t) = 0
$$</p>
<p>è®¾å®šè¾“å‡º \(y(t)=v_{out}(t)\), è®¾å®šè¾“å…¥ \(u(t)=v_{in}(t)\)</p>
<p>å› æ­¤å¯ä»¥å¾—åˆ°
$$R_1R_2C\dot y(t) + R_1y(t) = -R_2u(t)$$</p>
<h4 id="ä¼ é€’å‡½æ•°æ¨¡å‹-1"><a class="header" href="#ä¼ é€’å‡½æ•°æ¨¡å‹-1">ä¼ é€’å‡½æ•°æ¨¡å‹</a></h4>
<p>å¯¹å¾®åˆ†æ–¹ç¨‹ä¸¤è¾¹åšæ‹‰æ™®æ‹‰æ–¯å˜æ¢ï¼Œå¾—åˆ° \(R_1R_2Csy(s) + R_1y(s) = -R_2u(s)\), äºæ˜¯ä¼ é€’å‡½æ•°æ¨¡å‹ç­‰äº
$$
\mathcal{P} = \frac{y(s)}{u(s)} = \frac{-R_2}{R_1R_2Cs + R_1}
$$</p>
<h4 id="çŠ¶æ€ç©ºé—´æ¨¡å‹-1"><a class="header" href="#çŠ¶æ€ç©ºé—´æ¨¡å‹-1">çŠ¶æ€ç©ºé—´æ¨¡å‹</a></h4>
<p>è®¾ \(x(t) = v_{out}(t), u(t)=v_{in}(t),y(t)=v_{out}(t)\)ï¼Œåˆ™å¯å¾—åˆ°çŠ¶æ€æ–¹ç¨‹
$$
\dot x(t) = -\frac{1}{CR_2}x(t) - \frac{1}{CR_1}u(t)
$$
è¾“å‡ºæ–¹ç¨‹ä¸º
$$
y(t)=x(t)
$$</p>
<h2 id="ä¸€é˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”"><a class="header" href="#ä¸€é˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”">ä¸€é˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”</a></h2>
<p>ä¸€é˜¶æ»åç³»ç»Ÿçš„ä¼ é€’å‡½æ•°æ¨¡å‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$
\mathcal{P}(s) = \frac{K}{Ts + 1}
$$
\(K\) æ˜¯æ»åç³»ç»Ÿçš„<strong>å¢ç›Š</strong>ï¼Œ\(T\) æ˜¯æ»åç³»ç»Ÿçš„<strong>æ—¶é—´å¸¸æ•°</strong>ã€‚
æ—¶é—´å¸¸æ•°æŒ‡çš„æ˜¯è¾¾åˆ°ç¨³å®šå€¼çš„ 63.2% æ—¶æ‰€éœ€çš„æ—¶é—´ï¼Œå®ƒå†³å®šäº†ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ã€‚</p>
<p><img src="ee/../images/control/step-response-first-order-system.png" alt="ä¸€é˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”" /></p>
<h3 id="æ¨å¯¼ä¸€é˜¶æ»åç³»ç»Ÿåœ¨æ—¶åŸŸä¸Šçš„é˜¶è·ƒå“åº”"><a class="header" href="#æ¨å¯¼ä¸€é˜¶æ»åç³»ç»Ÿåœ¨æ—¶åŸŸä¸Šçš„é˜¶è·ƒå“åº”">æ¨å¯¼ä¸€é˜¶æ»åç³»ç»Ÿåœ¨æ—¶åŸŸä¸Šçš„é˜¶è·ƒå“åº”</a></h3>
<p>$$
y(s) = \frac{K}{Ts+1}\frac{1}{s} = K(\frac{1}{s} - \frac{T}{Ts+1}) = K(\frac{1}{s} - \frac{1}{s+\frac{1}{T}})
$$</p>
<p>å¯¹å…¶è¿›è¡Œæ‹‰æ™®æ‹‰æ–¯é€†å˜æ¢å¾—åˆ°
$$
y(t) = K(1-e^{-\frac{1}{T}t})
$$</p>
<p>å½“ T &gt; 0 æ—¶ï¼Œ\(y(\infty)=K, y(T)=1-e^{-1}=0.632\)</p>
<h2 id="äºŒé˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”"><a class="header" href="#äºŒé˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”">äºŒé˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”</a></h2>
<p>äºŒé˜¶æ»åç³»ç»Ÿçš„ä¼ é€’å‡½æ•°æ¨¡å‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$
\mathcal{P}(s) = \frac{K\omega_n^2}{s^2+2\zeta\omega_ns+\omega_n^2}
$$
\(\zeta\)ç§°ä¸º<strong>é˜»å°¼ç³»æ•°</strong>ï¼Œ\(\omega_n\)ç§°ä¸º<strong>æ— é˜»å°¼è‡ªç„¶æŒ¯è¡é¢‘ç‡</strong>ã€‚</p>
<p><img src="ee/../images/control/step-response-second-order-system.png" alt="äºŒé˜¶æ»åç³»ç»Ÿçš„é˜¶è·ƒå“åº”" /></p>
<p>é˜»å°¼ç³»æ•°æ˜¯ç¡®å®šé˜»å°¼ç‰¹æ€§ï¼ˆç¨³å®šåº¦ï¼‰çš„å‚æ•°:</p>
<ul>
<li>å½“\(\zeta\) ä¸ºè´Ÿå€¼æ—¶ï¼Œè¾“å‡ºä¼šå‘æ•£</li>
<li>å½“\(\zeta\) ä¸ºæ­£å€¼æ—¶ï¼Œè¾“å‡ºä¼šæ”¶æ•›äºç¨³å®šå€¼:
<ul>
<li>å½“\(0&lt;\zeta&lt;1\)æ—¶ï¼Œç³»ç»ŸæŒ¯è¡è€Œæ”¶æ•›ï¼Œåœ¨ \(T_p = \frac{\pi}{\omega_n \sqrt{1-\zeta^2}}\)å¤„å–å¾—æœ€å¤§å€¼ \(y_{max}=K(1+e^{-\zeta\omega_nT_p})\)</li>
<li>å½“\(\zeta \geq 1\)æ—¶ç³»ç»Ÿä¸æŒ¯è¡è€Œæ”¶æ•›</li>
</ul>
</li>
</ul>
<p>æ— é˜»å°¼è‡ªç„¶æŒ¯è¡é¢‘ç‡\(\omega_n\)ç±»ä¼¼äºä¸€é˜¶æ»åç³»ç»Ÿä¸­çš„æ—¶é—´å¸¸æ•°T,å†³å®šäº†å“åº”é€Ÿåº¦çš„å¿«æ…¢ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pytest-åŸºç¡€"><a class="header" href="#pytest-åŸºç¡€">pytest åŸºç¡€</a></h1>
<h2 id="å¸¸ç”¨å‘½ä»¤è¡Œé€‰é¡¹"><a class="header" href="#å¸¸ç”¨å‘½ä»¤è¡Œé€‰é¡¹">å¸¸ç”¨å‘½ä»¤è¡Œé€‰é¡¹</a></h2>
<ul>
<li>
<p><code>--collect-only</code>ï¼šå±•ç¤ºåœ¨ç»™å®šçš„é…ç½®ä¸‹å“ªäº›æµ‹è¯•ç”¨ä¾‹ä¼šè¢«è¿è¡Œ</p>
</li>
<li>
<p><code>-k</code>ï¼šä½¿ç”¨è¡¨è¾¾å¼æŒ‡å®šè¦è¿è¡Œçš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¡¨è¾¾å¼å¯ä»¥åŒ¹é…æµ‹è¯•åï¼Œä¸”è¡¨è¾¾å¼ä¸­å¯ä»¥åŒ…å« <code>and</code>,<code>or</code>,<code>not</code> å…³é”®å­—</p>
<pre><code class="language-text">â¤ pytest -v --collect-only -k "replace or asdict"

&lt;Package tests&gt;
  &lt;Module test_named_tuple.py&gt;
    &lt;Function test_asdict&gt;
      _asdict() should return a dictionary.
    &lt;Function test_replace&gt;
      replace() should change passed in fields.
</code></pre>
</li>
<li>
<p><code>-m</code>ï¼šæ ‡è®°æµ‹è¯•å¹¶åˆ†ç»„ï¼Œä»¥ä¾¿å¿«é€Ÿé€‰ä¸­å¹¶è¿è¡Œï¼Œå¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæ ‡è®°ï¼Œæ ‡è®°ä¹‹é—´å¯ä»¥ä½¿ç”¨ <code>and</code>,<code>or</code>,<code>not</code> å…³é”®å­—</p>
</li>
<li>
<p><code>-s</code>ï¼šå…è®¸ç»ˆç«¯åœ¨æµ‹è¯•è¿è¡Œæ—¶è¾“å‡ºæŸäº›ç»“æœï¼ŒåŒ…æ‹¬ä»»ä½•ç¬¦åˆæ ‡å‡†çš„è¾“å‡ºæµä¿¡æ¯ï¼Œç­‰ä»·äº <code>--capture=no</code></p>
</li>
<li>
<p><code>--markers</code>ï¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ marker</p>
</li>
<li>
<p><code>--fixtures</code>ï¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ fixture</p>
</li>
<li>
<p><code>--setup-show</code>ï¼šæ˜¾ç¤ºæµ‹è¯•ç”¨ä¾‹çš„ setup å’Œ teardown è¿‡ç¨‹</p>
</li>
<li>
<p><code>--durations=0</code>ï¼šå°†æ‰€æœ‰é˜¶æ®µçš„è€—æ—¶ä»é•¿åˆ°çŸ­æ’åº</p>
</li>
<li>
<p><code>-l</code>ï¼šæ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹çš„å±€éƒ¨å˜é‡</p>
</li>
<li>
<p><code>-x</code>ï¼šé‡åˆ°å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹æ—¶åœæ­¢è¿è¡Œ</p>
</li>
<li>
<p><code>--lf, --last-failed</code>ï¼šåªè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåˆ™è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹</p>
</li>
<li>
<p><code>--ff, --failed-first</code>ï¼šå…ˆè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç„¶åå†è¿è¡Œå…¶ä»–æµ‹è¯•ç”¨ä¾‹</p>
</li>
<li>
<p><code>--cache-show</code>ï¼šæ˜¾ç¤ºç¼“å­˜çš„å†…å®¹ï¼ˆå¯ç”¨äºå¤šä¸ªæµ‹è¯•ä¼šè¯ä¹‹é—´å…±äº«ï¼‰</p>
</li>
<li>
<p><code>--cache-clear</code>ï¼šæ¸…é™¤ç¼“å­˜</p>
</li>
<li>
<p><code>--pdb</code>ï¼šé‡åˆ°å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹æ—¶è¿›å…¥è°ƒè¯•æ¨¡å¼</p>
</li>
<li>
<p><code>--tb=[auto/long/short/line/native/no]</code>ï¼šæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶å †æ ˆå›æº¯ä¿¡æ¯çš„ç²’åº¦</p>
</li>
<li>
<p><code>--junit-xml</code>ï¼šå°†æµ‹è¯•ç»“æœè¾“å‡ºä¸º junit æ ¼å¼çš„ xml æ–‡ä»¶</p>
</li>
</ul>
<h2 id="æµ‹è¯•æœç´¢"><a class="header" href="#æµ‹è¯•æœç´¢">æµ‹è¯•æœç´¢</a></h2>
<p>pytest èƒ½è‡ªåŠ¨æœç´¢æ‰€æœ‰å¾…æ‰§è¡Œçš„æµ‹è¯•ç”¨ä¾‹ï¼Œä½ éœ€è¦éµå®ˆä»¥ä¸‹å‡ æ¡å‘½åè§„åˆ™ï¼š</p>
<ul>
<li>æµ‹è¯•æ–‡ä»¶åº”è¯¥å‘½åä¸º <code>test_*.py</code> æˆ–è€… <code>*_test.py</code></li>
<li>æµ‹è¯•å‡½æ•°ã€æµ‹è¯•ç±»æ–¹æ³•åº”å½“å‘½åä¸º <code>test_&lt;something&gt;</code></li>
<li>æµ‹è¯•ç±»è¦å‘½åä¸º <code>Test&lt;Something&gt;</code></li>
<li>é»˜è®¤çš„æµ‹è¯•æœç´¢è§„åˆ™å¯ä»¥åœ¨ <code>pytest.ini</code> ä¸­è¿›è¡Œä¿®æ”¹</li>
</ul>
<h2 id="ç¼–å†™æµ‹è¯•å‡½æ•°"><a class="header" href="#ç¼–å†™æµ‹è¯•å‡½æ•°">ç¼–å†™æµ‹è¯•å‡½æ•°</a></h2>
<ul>
<li>
<p>pytest ä¼šæˆªæ–­å¯¹åŸç”Ÿ <code>assert</code> çš„è°ƒç”¨ï¼Œæ›¿æ¢ä¸º pytest å®šä¹‰çš„ <code>assert</code></p>
</li>
<li>
<p>ä½¿ç”¨ <code>with pytest.raises(Exception):</code> æ¥æ–­è¨€å¼‚å¸¸</p>
<pre><code class="language-python">def test_start_tasks_db_raises():
  """Make sure unsupported db raises an exception."""
  with pytest.raises(ValueError) as exc_info:
      tasks.start_tasks_db("some/great/path", "mysql")
  exception_msg = exc_info.value.args[0]
  assert exc_info.type == ValueError
  assert exception_msg == "db_type must be a 'tiny' or 'mongo'"
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>pytest.approx</code> æ¥æ–­è¨€æµ®ç‚¹æ•°</p>
<pre><code class="language-python">def test_approx():
  """Using pytest.approx."""
  v1 = 0.1 + 0.2
  v2 = 0.3
  assert v1 != v2
  assert v1 == pytest.approx(v2)
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>@pytest.mark.skip</code> å’Œ <code>@pytest.mark.skipif</code> è£…æ—¶æœŸæ¥è·³è¿‡ä¸å¸Œæœ›è¿è¡Œçš„æµ‹è¯•</p>
</li>
<li>
<p>ä½¿ç”¨ <code>@pytest.mark.xfail</code> è£…é¥°å™¨æ¥æ ‡è®°é¢„æœŸå¤±è´¥çš„æµ‹è¯•</p>
<pre><code class="language-python">@pytest.mark.xfail(
    sys.platform == "win32",
    reason="can't run on Windows"
)
def test_unique_id_is_a_duck():
    """Demonstrate xfail"""
    uid = tasks.unique_id()
    assert uid == "a duck"
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>@pytest.mark.parametrize(argnames, argvalues)</code> è£…é¥°å™¨æ¥è¿è¡Œç›¸åŒæµ‹è¯•ç”¨ä¾‹çš„ä¸åŒå‚æ•°ç»„åˆ, <code>parametrize()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<strong>ç”¨é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²åˆ—è¡¨</strong>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯<strong>å€¼åˆ—è¡¨</strong></p>
<pre><code class="language-python">@pytest.mark.parametrize(
    "summary, owner, done",
    [
        ("sleep", None, False),
        ("wake", "brian", False),
        ("breath", "iris", True),
        ("eat", "bob", True),
    ],
)
def test_add_variety(summary, owner, done):
    """Demonstrate parameterize with 3 parameters."""
    new_task = Task(summary, owner, done)
    task_id = tasks.add(new_task)
    task_from_db = tasks.get(task_id)
    assert equivalent(new_task, task_from_db)
</code></pre>
</li>
<li>
<p><code>parametrize()</code> è¿˜å¯ä»¥é€šè¿‡ <code>ids</code> å‚æ•°æ¥æŒ‡å®šæ¯ä¸ªå‚æ•°ç»„åˆçš„åå­—, <code>ids</code> å‚æ•°çš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œé•¿åº¦å¿…é¡»å’Œ <code>argvalues</code> å‚æ•°çš„é•¿åº¦ä¸€è‡´</p>
<pre><code class="language-python">tasks_to_try = (
  Task("sleep", None, True),
  Task("wake", "brian", False),
  Task("breathe", "bob", True),
  Task("exercise", "iris", False),
)
task_ids = [f"Task({t.summary},{t.owner},{t.done})" for t in tasks_to_try]


@pytest.mark.parametrize("task", tasks_to_try, ids=task_ids)
def test_add_variety(task):
    """Demonstrate parameterize with 3 parameters."""
    task_id = tasks.add(task)
    task_from_db = tasks.get(task_id)
    assert equivalent(task, task_from_db)
</code></pre>
</li>
<li>
<p>å½“ <code>ids</code> ä¸èƒ½è¢«å‚æ•°åŒ–æ‰¹é‡ç”Ÿæˆæ—¶ï¼Œéœ€è¦è‡ªå®šä¹‰çš„æ—¶å€™ï¼Œå¯ä»¥ç»™æ¯ä¸ªå‚æ•°å€¼å®šä¹‰ä¸€ä¸ª <code>id</code> æ¥åšæ ‡è¯†: <code>pytest.param(&lt;value&gt;, id="something")</code></p>
<pre><code class="language-python">@pytest.mark.parametrize(
    "task",
    [
        pytest.param(Task("sleep")),
        pytest.param(Task("wake", "brian"), id="summary/owner"),
        pytest.param(Task("breathe", "BRIAN", True), id="summary/owner/done"),
    ],
)
def test_add_variety(task):
    """Demonstrate parameterize with 3 parameters."""
    task_id = tasks.add(task)
    task_from_db = tasks.get(task_id)
    assert equivalent(task, task_from_db)
</code></pre>
<p>è¿è¡Œç»“æœ:</p>
<pre><code class="language-bash">test_add.py::test_add_variety[task0] PASSED # å› ä¸ºæ²¡æœ‰æ·»åŠ idæ ‡è¯†ï¼Œæ‰€ä»¥å¯è¯»æ€§ä¸å¥½
test_add.py::test_add_variety[summary/owner] PASSED
test_add.py::test_add_variety[summary/owner/done] PASSED
</code></pre>
</li>
</ul>
<h2 id="fixture"><a class="header" href="#fixture">Fixture</a></h2>
<ul>
<li>
<p>Fixture æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œåœ¨æµ‹è¯•å‡½æ•°è¿è¡Œå‰åï¼Œç”± pytest æ‰§è¡Œçš„å¤–å£³å‡½æ•°ï¼Œé€šå¸¸ç”¨æ¥åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚åˆ›å»ºæ•°æ®åº“è¿æ¥ï¼Œåˆ›å»ºä¸´æ—¶æ–‡ä»¶ç­‰ã€‚</p>
<pre><code class="language-python">@pytest.fixture()
def some_data():
    return 42


def test_some_data(some_data):
    assert some_data == 42
</code></pre>
</li>
<li>
<p>å¤šä¸ª fixture ä¹‹é—´å¯ä»¥ç›¸äº’ä¾èµ–ï¼Œæ¯”å¦‚ä¸€ä¸ª fixture ä¾èµ–å¦ä¸€ä¸ª fixtureï¼Œè¿™æ—¶å¯ä»¥åœ¨ fixture å‡½æ•°çš„å‚æ•°åˆ—è¡¨ä¸­æ·»åŠ ä¾èµ–çš„ fixture å‡½æ•°</p>
<pre><code class="language-python">@pytest.fixture()
def db_with_3_tasks(tasks_db, tasks_just_a_few):
    """Connected db with 3 tasks, all unique"""
    for t in tasks_just_a_few:
        tasks.add(t)

def test_add_increases_count(db_with_3_tasks):
  tasks.add(Task("throw a party"))
  assert tasks.count() == 4
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>usefixtures</code> ä¸ºæµ‹è¯•ç±»æŒ‡å®š fixtureï¼Œè¿™ç§æ–¹æ³•<strong>ä¸èƒ½</strong>å¤Ÿä½¿ç”¨ fixture å‡½æ•°çš„è¿”å›å€¼</p>
<pre><code class="language-python">@pytest.mark.usefixtures("tasks_db")
class TestAdd:
    """Using a fixture for setup and teardown."""

    def test_add_increases_count(self):
        """tasks.add() affect tasks.count()."""
        tasks.add(Task("throw a party"))
        assert tasks.count() == 1
</code></pre>
</li>
<li>
<p>é€šè¿‡ <code>scope</code> å‚æ•°æŒ‡å®š fixture çš„ä½œç”¨èŒƒå›´ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæ§åˆ¶ fixture æ‰§è¡Œ setup å’Œ teardown çš„é¢‘ç‡ï¼‰ï¼Œ<code>scope</code> å‚æ•°çš„å€¼å¯ä»¥æ˜¯ <code>function</code>ã€<code>class</code>ã€<code>module</code>ã€<code>session</code>ï¼Œé»˜è®¤å€¼æ˜¯ <code>function</code>ã€‚fixture åªèƒ½ä½¿ç”¨åŒçº§åˆ«çš„ fixture æˆ–è€…æ¯”è‡ªå·±çº§åˆ«æ›´é«˜çš„ fixtureã€‚</p>
<pre><code class="language-python">@pytest.fixture(scope="session")
def tasks_db(tmpdir_factory):
    """Connect to db before testing, disconnect after."""
    tmp_dir = tmpdir_factory.mktemp("temp")
    tasks.start_tasks_db(str(tmp_dir), "tiny")
    yield
    tasks.stop_tasks_db()
</code></pre>
</li>
<li>
<p>å¯ä»¥ä¸ºå¸¸ç”¨ fixture æ·»åŠ  <code>autouse=True</code> é€‰é¡¹ï¼Œä½¿å¾—ä½œç”¨åŸŸå†…çš„æµ‹è¯•å‡½æ•°è‡ªåŠ¨è¿è¡Œè¯¥ fixture</p>
</li>
<li>
<p>å¯ä»¥è®¾ç½® <code>name</code> å‚æ•°æ¥é‡å‘½å fixture</p>
</li>
<li>
<p>å¯¹æµ‹è¯•å‡½æ•°è¿›è¡Œå‚æ•°åŒ–ï¼Œå¯ä»¥å¤šæ¬¡è¿è¡Œçš„åªæ˜¯è¯¥æµ‹è¯•å‡½æ•°ã€‚è€Œä½¿ç”¨<strong>å‚æ•°åŒ–</strong> fixture,æ¯ä¸ªä½¿ç”¨è¯¥ fixture çš„æµ‹è¯•å‡½æ•°éƒ½å¯ä»¥è¢«è¿è¡Œå¤šæ¬¡</p>
<pre><code class="language-python">tasks_to_try = [
    pytest.param(Task("sleep")),
    pytest.param(Task("wake", "brian")),
    pytest.param(Task("breathe", "BRIAN", True)),
]


def id_func(task: Task):
    """Create a string representation for test report."""
    return f"({task.summary},{task.owner},{task.done})"


@pytest.fixture(params=tasks_to_try, ids=id_func)
def a_task(request):
    """Using a fixture to pass data to a test."""
    return request.param


def test_add_variety(a_task):
    """Demonstrate parameterize with 3 parameters."""
    task_id = tasks.add(a_task)
    task_from_db = tasks.get(task_id)
    assert equivalent(a_task, task_from_db)
</code></pre>
<p><code>ids</code> å‚æ•°å¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªå‡½æ•°ï¼Œä¾› pytest é’ˆå¯¹æ¯ä¸ªå‚æ•°ç”Ÿæˆæ ‡è¯†</p>
</li>
</ul>
<h3 id="å†…ç½®-fixture"><a class="header" href="#å†…ç½®-fixture">å†…ç½® Fixture</a></h3>
<h4 id="tmpdir-å’Œ-tmpdir_factory"><a class="header" href="#tmpdir-å’Œ-tmpdir_factory">tmpdir å’Œ tmpdir_factory</a></h4>
<pre><code class="language-python">def test_tmpdir(tmpdir):
    print(tmpdir.realpath)
    # tmpdir already has a path name associated with it
    # join() extends the path to include a filename
    # the file is created when it's written to
    # tmpdir is a py.path.local object
    a_file = tmpdir.join("something.txt")

    # you can create directories
    a_sub_dir = tmpdir.mkdir("anything")

    # you can create files in the directory (created when written)
    another_file = a_sub_dir.join("something_else.txt")

    # this write creates "something.txt"
    a_file.write("contents may settle during shipping")

    # this write creates "anything/something_else.txt"
    another_file.write("something different")

    assert a_file.read() == "contents may settle during shipping"
    assert another_file.read() == "something different"
</code></pre>
<pre><code class="language-python">def test_tmpdir_factor(tmpdir_factory):
    print(tmpdir_factory.getbasetemp())

    # you should start with making a directory
    # a_dir acts like the object returned from the tmpdir fixture
    a_dir = tmpdir_factory.mktemp("mydir")
    a_file = a_dir.join("something.txt")

    # you can create directories
    a_sub_dir = a_dir.mkdir("anything")

    # you can create files in the directory (created when written)
    another_file = a_sub_dir.join("something_else.txt")

    # this write creates "something.txt"
    a_file.write("contents may settle during shipping")

    # this write creates "anything/something_else.txt"
    another_file.write("something different")

    assert a_file.read() == "contents may settle during shipping"
    assert another_file.read() == "something different"
</code></pre>
<p><code>tmpdir_factory</code> çš„ä½œç”¨èŒƒå›´æ˜¯ä¼šè¯çº§åˆ«ï¼Œ<code>tmpdir</code> çš„ä½œç”¨èŒƒå›´æ˜¯å‡½æ•°çº§åˆ«ã€‚å¦‚æœéœ€è¦æ¨¡å—æˆ–è€…ç±»çº§åˆ«ä½œç”¨èŒƒå›´çš„ç›®å½•ï¼Œå¯ä»¥åˆ©ç”¨ <code>tmpdir_factory</code> å†åˆ›å»ºä¸€ä¸ª fixtureã€‚</p>
<pre><code class="language-python">@pytest.fixture(scope="module")
def my_tmpdir(tmpdir_factory):
    pass
</code></pre>
<h4 id="pytestconfig"><a class="header" href="#pytestconfig">pytestconfig</a></h4>
<p><code>pytestconfig</code> æ˜¯ <code>request.config</code> çš„å¿«æ·æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡ <code>pytestconfig.getoption()</code> è·å–å‘½ä»¤è¡Œé€‰é¡¹ã€‚</p>
<pre><code class="language-python">def test_option(pytestconfig):
    print(f"args: {pytestconfig.args}")
    print(f"invocation_dir: {pytestconfig.invocation_dir}")
    print(f"rootdir: {pytestconfig.rootdir}")
    print(f"inifile: {pytestconfig.inifile}")
    print(f"basetemp: {pytestconfig.getoption('basetemp')}")
    print(f"-k EXPRESSION: {pytestconfig.getoption('keyword')}")
    print(f"-v, --verbose: {pytestconfig.getoption('verbose')}")
    print(f"--tb style: {pytestconfig.getoption('tbstyle')}")
</code></pre>
<p>ä¹Ÿå¯ä»¥åŸºäº <code>pytestconfig</code> åˆ›å»ºæ–°çš„ fixture</p>
<pre><code class="language-python">@pytest.fixture()
def foo(pytestconfig):
    return pytestconfig.option.foo


def test_option(foo):
    print("foo: {}".format(foo))
</code></pre>
<h4 id="cache-1"><a class="header" href="#cache-1">cache</a></h4>
<p>cache çš„ä½œç”¨æ˜¯å­˜å‚¨ä¸€æ®µæµ‹è¯•ä¼šè¯çš„ä¿¡æ¯ï¼Œåœ¨ä¸‹ä¸€æ®µæµ‹è¯•ä¼šè¯ä¸­ä½¿ç”¨ã€‚<code>cache</code>çš„æ¥å£ä¸»è¦æœ‰ä¸¤ä¸ªï¼š<code>cache.get(key, default)</code> å’Œ <code>cache.set(key, value)</code>ã€‚</p>
<p>ä¹ æƒ¯ä¸Šï¼Œé”®åä»¥åº”ç”¨åå­—æˆ–æ’ä»¶åå­—å¼€å§‹ï¼Œæ¥ç€æ˜¯<code>/</code>ï¼Œç„¶åæ˜¯åˆ†éš”å¼€çš„é”®å­—ç¬¦ä¸²ã€‚é”®å€¼å¯ä»¥æ˜¯ä»»ä½•å¯ä»¥è½¬æ¢æˆ JSON çš„å¯¹è±¡ã€‚</p>
<pre><code class="language-python">Duration = namedtuple("Duration", ["current", "last"])


@pytest.fixture(scope="session")
def duration_cache(request):
    key = "duration/test_durations"
    d = Duration({}, request.config.cache.get(key, {}))
    yield d
    request.config.cache.set(key, d.current)


@pytest.fixture(autouse=True)
def check_duration(request, duration_cache):
    d = duration_cache
    nodeid = request.node.nodeid  # nodeid is a unique identifier for the test
    start_time = datetime.datetime.now()
    yield
    duration = (datetime.datetime.now() - start_time).total_seconds()
    d.current[nodeid] = duration
    if d.last.get(nodeid, None) is not None:
        errorstring = "test duration over 2x last duration"
        assert duration &lt;= (d.last[nodeid] * 2), errorstring


@pytest.mark.parametrize("i", range(5))
def test_slow_stuff(i):
    time.sleep(random.random())
</code></pre>
<pre><code class="language-text">â¤ pytest --cache-show
================ test session starts ================
platform linux -- Python 3.10.7, pytest-7.1.2, pluggy-1.0.0
rootdir: /home/morris/tasks/tests
cachedir: /home/morris/tasks/tests/.pytest_cache
---------------- cache values for '*' ----------------
duration/test_durations contains:
  {'test_cache.py::test_slow_stuff[0]': 0.133439,
   'test_cache.py::test_slow_stuff[1]': 0.569769,
   'test_cache.py::test_slow_stuff[2]': 0.7625,
   'test_cache.py::test_slow_stuff[3]': 0.930151,
   'test_cache.py::test_slow_stuff[4]': 0.748842}
</code></pre>
<p>åŒæ—¶ä¹Ÿèƒ½çœ‹åˆ°è¢« <code>cache</code> çš„æ•°æ®ä¿å­˜åœ¨ <code>.pytest_cache</code> ç›®å½•ä¸‹ã€‚</p>
<h4 id="capsys"><a class="header" href="#capsys">capsys</a></h4>
<ul>
<li>
<p><code>capsys.readouterr()</code>ï¼šè¿”å›ä¸€ä¸ªåŒ…å« <code>out</code> å’Œ <code>err</code> çš„ <code>namedtuple</code>ï¼Œåˆ†åˆ«æ˜¯æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯çš„å†…å®¹</p>
<pre><code class="language-python">def test_capsys(capsys):
    print("hello")
    print("world", file=sys.stderr)
    out, err = capsys.readouterr()
    assert out == "hello\n"
    assert err == "world\n"
</code></pre>
</li>
<li>
<p>ä¸´æ—¶è®©è¾“å‡ºç»•è¿‡é»˜è®¤çš„è¾“å‡ºæ•è·æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>capsys.disabled()</code> ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>
<pre><code class="language-python">def test_capsys_disabled(capsys):
    with capsys.disabled():
        print("always print this")
    print("normal print, usually captured")
</code></pre>
</li>
</ul>
<h4 id="monkeypatch"><a class="header" href="#monkeypatch">monkeypatch</a></h4>
<p>monkeypatch å¯ä»¥åœ¨è¿è¡ŒæœŸé—´å¯¹ç±»æˆ–æ¨¡å—è¿›è¡ŒåŒæ€ä¿®æ”¹ï¼Œæ¯”å¦‚ä¿®æ”¹ç¯å¢ƒå˜é‡ã€ä¿®æ”¹ç±»å±æ€§ã€ä¿®æ”¹æ¨¡å—å±æ€§ç­‰ã€‚</p>
<ul>
<li>
<p>setattr(target, name, value, raising=True)ï¼šä¿®æ”¹å¯¹è±¡çš„å±æ€§å€¼</p>
<pre><code class="language-python">def test_setattr(monkeypatch):
    class A:
        a = 1

    monkeypatch.setattr(A, "a", 2)
    assert A.a == 2
</code></pre>
</li>
<li>
<p>delattr(target, name, raising=True)ï¼šåˆ é™¤å¯¹è±¡çš„å±æ€§</p>
<pre><code class="language-python">def test_delattr(monkeypatch):
    class A:
        a = 1

    monkeypatch.delattr(A, "a")
    assert not hasattr(A, "a")
</code></pre>
</li>
<li>
<p>setitem(mapping, name, value)ï¼šä¿®æ”¹å­—å…¸çš„å€¼</p>
<pre><code class="language-python">def test_setitem(monkeypatch):
    d = {"a": 1}
    monkeypatch.setitem(d, "a", 2)
    assert d["a"] == 2
</code></pre>
</li>
<li>
<p>delitem(obj, name, raising=True)ï¼šåˆ é™¤å­—å…¸çš„å€¼</p>
<pre><code class="language-python">def test_delitem(monkeypatch):
    d = {"a": 1}
    monkeypatch.delitem(d, "a")
    assert "a" not in d
</code></pre>
</li>
<li>
<p>setenv(name, value, prepend=False)ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡</p>
<pre><code class="language-python">def test_setenv(monkeypatch):
    monkeypatch.setenv("foo", "bar")
    assert os.environ["foo"] == "bar"
</code></pre>
</li>
<li>
<p>delenv(name, raising=True)ï¼šåˆ é™¤ç¯å¢ƒå˜é‡</p>
<pre><code class="language-python">def test_delenv(monkeypatch):
    monkeypatch.setenv("foo", "bar")
    monkeypatch.delenv("foo")
    assert "foo" not in os.environ
</code></pre>
</li>
<li>
<p>syspath_prepend(path)ï¼šåœ¨ <code>sys.path</code> çš„å¼€å¤´æ·»åŠ è·¯å¾„ï¼Œ<code>sys.path</code> æ˜¯ Python æ¨¡å—çš„æœç´¢è·¯å¾„</p>
<pre><code class="language-python">def test_syspath_prepend(monkeypatch):
    monkeypatch.syspath_prepend("/foo")
    assert sys.path[0] == "/foo"
</code></pre>
</li>
<li>
<p>chdir(path)ï¼šä¿®æ”¹å½“å‰å·¥ä½œç›®å½•</p>
<pre><code class="language-python">def test_chdir(monkeypatch):
    monkeypatch.chdir("/tmp")
    assert os.getcwd() == "/tmp"
</code></pre>
</li>
</ul>
<h4 id="recwarn"><a class="header" href="#recwarn">recwarn</a></h4>
<p>recwarn ç”¨æ¥æ£€æŸ¥å¾…æµ‹ä»£ç äº§ç”Ÿçš„è­¦å‘Šä¿¡æ¯ã€‚</p>
<pre><code class="language-python">def test_recwarn(recwarn):
    warnings.warn("Please stop using this function", DeprecationWarning)
    assert len(recwarn) == 1
    w = recwarn.pop()
    assert w.category == DeprecationWarning
    assert str(w.message) == "Please stop using this function"
</code></pre>
<p>pytest è¿˜å¯ä»¥ä½¿ç”¨ <code>pytest.warns</code> æ¥æ£€æŸ¥è­¦å‘Šä¿¡æ¯ã€‚</p>
<pre><code class="language-python">def lame_function():
    warnings.warn("Please stop using this", DeprecationWarning)


def test_lame_function():
    with pytest.warns(DeprecationWarning) as warning_list:
        lame_function()

    assert len(warning_list) == 1
    w = warning_list.pop()
    assert w.category == DeprecationWarning
    assert str(w.message) == "Please stop using this"
</code></pre>
<h2 id="æ’ä»¶"><a class="header" href="#æ’ä»¶">æ’ä»¶</a></h2>
<h3 id="å¯»æ‰¾æ’ä»¶"><a class="header" href="#å¯»æ‰¾æ’ä»¶">å¯»æ‰¾æ’ä»¶</a></h3>
<ul>
<li><a href="https://docs.pytest.org/en/latest/reference/plugin_list.html#plugin-list">https://docs.pytest.org/en/latest/reference/plugin_list.html#plugin-list</a></li>
</ul>
<h3 id="ç¼–å†™æ’ä»¶"><a class="header" href="#ç¼–å†™æ’ä»¶">ç¼–å†™æ’ä»¶</a></h3>
<ul>
<li>
<p>ä½¿ç”¨ <code>pytest_addoption</code> å¯ä»¥ç»™ pytest æ·»åŠ é¢å¤–çš„å‘½ä»¤è¡Œé€‰é¡¹</p>
<pre><code class="language-python">def pytest_addoption(parser):
    parser.addoption(
        "--myopt",
        action="store_true",
        help="some boolean option",
    )
    parser.addoption(
        "--foo",
        action="store",
        default="bar",
        help="foo: bar or baz",
    )
</code></pre>
<p>æˆ–è€…ä¸é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿ç”¨ <code>pytest.ini</code> æ–‡ä»¶åšè‡ªå®šä¹‰çš„é…ç½®</p>
<pre><code class="language-python">def pytest_addoption(parser):
    parser.addini(
        "myopt",
        type="bool",
        default=False,
        help="some boolean option",
    )
    parser.addini(
        "foo",
        type="string",
        default="bar",
        help="foo: bar or baz",
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>pytest_report_header</code> å¯ä»¥åœ¨æµ‹è¯•æŠ¥å‘Šçš„ header ä¸­æ·»åŠ é¢å¤–çš„ä¿¡æ¯</p>
<pre><code class="language-python">def pytest_report_header(config):
    return "ğŸğŸğŸğŸğŸğŸğŸğŸğŸ"
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>pytest_report_teststatus</code> å¯ä»¥ä¿®æ”¹æµ‹è¯•æŠ¥å‘Šä¸­çš„æµ‹è¯•çŠ¶æ€</p>
<pre><code class="language-python">def pytest_report_teststatus(report):
    if report.when == "call" and report.failed:
        return report.outcome, "ğŸ’¥", "ğŸ’¥"
</code></pre>
</li>
</ul>
<h3 id="æµ‹è¯•æ’ä»¶"><a class="header" href="#æµ‹è¯•æ’ä»¶">æµ‹è¯•æ’ä»¶</a></h3>
<ul>
<li>
<p>å¼€å¯ <code>pytester</code> æ’ä»¶ï¼Œåœ¨ conftest.py ä¸­æ·»åŠ  <code>pytest_plugins = ["pytester"]</code></p>
</li>
<li>
<p>ä½¿ç”¨ <code>pytester</code> æ¥æµ‹è¯•æ’ä»¶</p>
<pre><code class="language-python">@pytest.fixture()
def sample_test(testdir):
    testdir.makepyfile(
        """
        def test_sample():
            assert True
        """
    )
    return testdir


def test_verbose(sample_test):
    result = sample_test.runpytest("-v")
    result.stdout.fnmatch_lines(["*::test_sample PASSED*"])
    result.assert_outcomes(passed=1)
</code></pre>
<p><code>testdir</code> è‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨æ¥å­˜æ”¾æµ‹è¯•æ–‡ä»¶</p>
</li>
</ul>
<h3 id="å¸¸ç”¨æ’ä»¶"><a class="header" href="#å¸¸ç”¨æ’ä»¶">å¸¸ç”¨æ’ä»¶</a></h3>
<h4 id="pytest-cov"><a class="header" href="#pytest-cov">pytest-cov</a></h4>
<p>æŠ¥å‘Šæµ‹è¯•è¦†ç›–ç‡</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-cov</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --cov=src --cov-report=html tests</code></li>
</ul>
<h4 id="pytest-mock"><a class="header" href="#pytest-mock">pytest-mock</a></h4>
<p>æ›¿æ¢ç³»ç»Ÿçš„æŸä¸ªéƒ¨åˆ†ä»¥éš”ç¦»è¦æµ‹è¯•çš„ä»£ç </p>
<ul>
<li>
<p>å®‰è£…ï¼š<code>pip install pytest-mock</code></p>
</li>
<li>
<p>ä½¿ç”¨</p>
<pre><code class="language-python">def test_mock(mocker):
    mocker.patch("os.path.exists", return_value=True)
    assert os.path.exists("/tmp")
</code></pre>
</li>
</ul>
<h4 id="pytest-xdist"><a class="header" href="#pytest-xdist">pytest-xdist</a></h4>
<p>é€šå¸¸ï¼Œæµ‹è¯•éƒ½æ˜¯ä¾æ¬¡æ‰§è¡Œçš„ï¼Œå› ä¸ºæœ‰äº›èµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è®¿é—®ã€‚å¦‚æœä½ çš„æµ‹è¯•ä¸éœ€è¦è®¿é—®å…±äº«èµ„æºï¼Œå¯ä»¥é€šè¿‡å¹¶è¡Œè¿è¡Œæ¥æé€Ÿ</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-xdist</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest -n auto</code></li>
</ul>
<h4 id="pytest-benchmark"><a class="header" href="#pytest-benchmark">pytest-benchmark</a></h4>
<p>æµ‹è¯•ä»£ç çš„æ€§èƒ½</p>
<ul>
<li>
<p>å®‰è£…ï¼š<code>pip install pytest-benchmark</code></p>
</li>
<li>
<p>ä½¿ç”¨</p>
<pre><code class="language-python">def test_benchmark(benchmark):
    benchmark.pedantic(lambda: 1 + 1, iterations=100, rounds=100)
</code></pre>
</li>
</ul>
<h4 id="pytest-repeat"><a class="header" href="#pytest-repeat">pytest-repeat</a></h4>
<p>é‡å¤è¿è¡Œæµ‹è¯•</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-repeat</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --count=3</code></li>
</ul>
<h4 id="pytest-rerunfailures"><a class="header" href="#pytest-rerunfailures">pytest-rerunfailures</a></h4>
<p>å¤±è´¥çš„æµ‹è¯•é‡è·‘</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-rerunfailures</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --reruns=3</code></li>
</ul>
<h4 id="pytest-timeout"><a class="header" href="#pytest-timeout">pytest-timeout</a></h4>
<p>è®¾ç½®æµ‹è¯•çš„è¶…æ—¶æ—¶é—´ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œpytest é‡Œçš„æµ‹è¯•æ˜¯æ²¡æœ‰æ—¶é—´é™åˆ¶çš„ï¼‰</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-timeout</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --timeout=10</code></li>
<li>æˆ–è€…åœ¨ä»£ç ä¸­ä½¿ç”¨ <code>@pytest.mark.timeout(10)</code> æ¥è®¾ç½®å•ä¸ªæµ‹è¯•çš„è¶…æ—¶æ—¶é—´</li>
</ul>
<h4 id="pytest-instafail"><a class="header" href="#pytest-instafail">pytest-instafail</a></h4>
<p>æµ‹è¯•å¤±è´¥æ—¶ç«‹å³è¾“å‡ºå †æ ˆå›æº¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç­‰åˆ°æ‰€æœ‰æµ‹è¯•éƒ½æ‰§è¡Œå®Œæ¯•</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-instafail</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --instafail</code></li>
</ul>
<h4 id="pytest-sugar"><a class="header" href="#pytest-sugar">pytest-sugar</a></h4>
<p>æ˜¾ç¤ºå½©è‰²å’Œè¿›åº¦æ¡</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-sugar</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --sugar</code></li>
</ul>
<h4 id="pytest-emoji"><a class="header" href="#pytest-emoji">pytest-emoji</a></h4>
<p>æ˜¾ç¤º emoji</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-emoji</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --emoji</code></li>
</ul>
<h4 id="pytest-html"><a class="header" href="#pytest-html">pytest-html</a></h4>
<p>ç”Ÿæˆ html æŠ¥å‘Š</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-html</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --html=report.html</code></li>
</ul>
<h4 id="pytest-flake8"><a class="header" href="#pytest-flake8">pytest-flake8</a></h4>
<p>æ£€æŸ¥ä»£ç é£æ ¼</p>
<ul>
<li>å®‰è£…ï¼š<code>pip install pytest-flake8</code></li>
<li>ä½¿ç”¨ï¼š<code>pytest --flake8</code></li>
</ul>
<h4 id="pytest-selenium"><a class="header" href="#pytest-selenium">pytest-selenium</a></h4>
<p>å€ŸåŠ©æµè§ˆå™¨å®Œæˆè‡ªåŠ¨åŒ–æµ‹è¯•</p>
<ul>
<li>
<p>å®‰è£…ï¼š<code>pip install pytest-selenium</code></p>
</li>
<li>
<p>ä½¿ç”¨</p>
<pre><code class="language-python">def test_selenium(selenium):
    selenium.get("https://www.baidu.com")
    selenium.find_element_by_id("kw").send_keys("pytest")
    selenium.find_element_by_id("su").click()
    assert "pytest" in selenium.title
</code></pre>
</li>
</ul>
<h2 id="é…ç½®"><a class="header" href="#é…ç½®">é…ç½®</a></h2>
<h3 id="pytestini"><a class="header" href="#pytestini">pytest.ini</a></h3>
<p>å®ƒæ˜¯ pytest çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ <code>~/.config/pytest.ini</code> ä¸­åˆ›å»ºå…¨å±€é…ç½®æ–‡ä»¶</p>
<h4 id="ä¿®æ”¹é»˜è®¤å‘½ä»¤è¡Œé€‰é¡¹"><a class="header" href="#ä¿®æ”¹é»˜è®¤å‘½ä»¤è¡Œé€‰é¡¹">ä¿®æ”¹é»˜è®¤å‘½ä»¤è¡Œé€‰é¡¹</a></h4>
<pre><code class="language-ini">[pytest]
addopts = -s --tb=short --strict-markers
</code></pre>
<h4 id="æ³¨å†Œæ ‡è®°"><a class="header" href="#æ³¨å†Œæ ‡è®°">æ³¨å†Œæ ‡è®°</a></h4>
<pre><code class="language-ini">[pytest]
markers =
    smoke: smoke test
    regression: regression test
</code></pre>
<h4 id="å¿½ç•¥é‚£äº›ä¸éœ€è¦é€’å½’æœç´¢çš„ç›®å½•"><a class="header" href="#å¿½ç•¥é‚£äº›ä¸éœ€è¦é€’å½’æœç´¢çš„ç›®å½•">å¿½ç•¥é‚£äº›ä¸éœ€è¦é€’å½’æœç´¢çš„ç›®å½•</a></h4>
<pre><code class="language-ini">[pytest]
norecursedirs = .* venv *.egg dist build
</code></pre>
<h4 id="æŒ‡å®šæµ‹è¯•ç›®å½•"><a class="header" href="#æŒ‡å®šæµ‹è¯•ç›®å½•">æŒ‡å®šæµ‹è¯•ç›®å½•</a></h4>
<pre><code class="language-ini">[pytest]
testpaths = tests
</code></pre>
<h4 id="æ›´æ”¹æµ‹è¯•æœç´¢çš„è§„åˆ™"><a class="header" href="#æ›´æ”¹æµ‹è¯•æœç´¢çš„è§„åˆ™">æ›´æ”¹æµ‹è¯•æœç´¢çš„è§„åˆ™</a></h4>
<pre><code class="language-ini">[pytest]
python_files = test_*.py *_test.py pytest_*.py check_*.py
python_classes = Tests* *Test *Suite
python_functions = test_* check_*
</code></pre>
<h4 id="ç¦ç”¨-xpass"><a class="header" href="#ç¦ç”¨-xpass">ç¦ç”¨ xpass</a></h4>
<p>é‚£äº›è¢«æ ‡è®°ä¸º <code>@pytest.mark.xfail</code> ä½†å®é™…é€šè¿‡çš„æµ‹è¯•ç”¨ä¾‹ä¹Ÿè¢«æŠ¥å‘Šä¸ºå¤±è´¥</p>
<pre><code class="language-ini">[pytest]
xfail_strict = true
</code></pre>
<h3 id="conftestpy"><a class="header" href="#conftestpy">conftest.py</a></h3>
<p>å®ƒæ˜¯æœ¬åœ°æ’ä»¶åº“ï¼Œå…¶ä¸­çš„ hook å‡½æ•°å’Œ fixture å°†ä½œç”¨äºè¯¥æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä»¥åŠæ‰€æœ‰å­ç›®å½•</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è§†é¢‘å¤„ç†"><a class="header" href="#è§†é¢‘å¤„ç†">è§†é¢‘å¤„ç†</a></h1>
<p><img src="cs/../images/video-process/video-process-flow.jpg" alt="è§†é¢‘å¤„ç†å·¥ä½œæµç¨‹" /></p>
<h2 id="è§†é¢‘ä¸å›¾åƒçš„åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#è§†é¢‘ä¸å›¾åƒçš„åŸºæœ¬æ¦‚å¿µ">è§†é¢‘ä¸å›¾åƒçš„åŸºæœ¬æ¦‚å¿µ</a></h2>
<p><img src="cs/../images/video-process/image-basis.jpg" alt="è§†é¢‘å›¾åƒåŸºç¡€" /></p>
<ul>
<li>å­˜å–ä¸€å¹…å›¾åƒéœ€è¦ç‰¹åˆ«æ³¨æ„ Stride è¿™ä¸ªå‚æ•°ï¼Œå®ƒè·Ÿåˆ†è¾¨ç‡ä¸­çš„ Width æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¸ºäº†å¿«é€Ÿå­˜å–ï¼Œå¾€å¾€ä¼šé€‰æ‹©ä»¥å†…å­˜å¯¹é½çš„æ–¹å¼å­˜å‚¨ä¸€è¡Œåƒç´ ï¼ˆæ¯”å¦‚ 16 å­—èŠ‚ï¼‰ã€‚æœ‰çš„æ—¶å€™å³ä¾¿å›¾åƒçš„ Width æ˜¯ä¸€ä¸ªè§„åˆ™çš„å€¼ï¼Œå›¾åƒå­˜å‚¨åœ¨å†…å­˜ä¸­æœ‰å¯èƒ½ Stride å’Œ Width ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œå°¤å…¶æ˜¯ä¸åŒçš„è§†é¢‘è§£ç å™¨å†…éƒ¨å®ç°çš„ä¸åŒï¼Œä¼šå¯¼è‡´è¾“å‡ºçš„å›¾åƒçš„ Stride ä¸ä¸€æ ·ã€‚</li>
<li>æˆ‘ä»¬åœ¨ç”µå½±é™¢çœ‹çš„ç”µå½±å¸§ç‡ä¸€èˆ¬æ˜¯ 24fpsï¼ˆå¸§æ¯ç§’ï¼‰ï¼Œç›‘æ§è¡Œä¸šå¸¸ç”¨ 25fpsã€‚</li>
<li>æˆ‘ä»¬å­˜å‚¨è§†é¢‘çš„æ—¶å€™éœ€è¦å¯¹å›¾åƒè¿›è¡Œå‹ç¼©ä¹‹åå†å­˜å‚¨ã€‚ç ç‡æ˜¯æŒ‡è§†é¢‘åœ¨å•ä½æ—¶é—´å†…çš„æ•°æ®é‡çš„å¤§å°ï¼Œå•ä½ä¸€èˆ¬æ˜¯ Kb/s æˆ–è€… Mb/sã€‚</li>
<li>è§†é¢‘å‹ç¼©ä¹‹åçš„æ¸…æ™°åº¦è¿˜è·Ÿå‹ç¼©æ—¶é€‰ç”¨çš„å‹ç¼©ç®—æ³•ï¼Œä»¥åŠå‹ç¼©æ—¶ä½¿ç”¨çš„å‹ç¼©é€Ÿåº¦æœ‰å…³ã€‚å‹ç¼©ç®—æ³•è¶Šå…ˆè¿›ï¼Œå‹ç¼©ç‡å°±ä¼šè¶Šé«˜ï¼Œç ç‡è‡ªç„¶å°±ä¼šè¶Šå°ã€‚å‹ç¼©é€Ÿåº¦è¶Šæ…¢ï¼Œå‹ç¼©çš„æ—¶å€™å‹ç¼©ç®—æ³•å°±ä¼šè¶Šç²¾ç»†ï¼Œæœ€åå‹ç¼©ç‡ä¹Ÿä¼šæœ‰æé«˜ï¼Œç›¸åŒçš„æ¸…æ™°åº¦ç ç‡ä¹Ÿä¼šæ›´å°ã€‚</li>
</ul>
<h3 id="color-range"><a class="header" href="#color-range">Color Range</a></h3>
<p>å¯¹äºä¸€ä¸ª 8bit çš„ RGB å›¾åƒï¼Œ<strong>Full Range</strong> çš„ Rã€Gã€B å–å€¼èŒƒå›´æ˜¯ 0<del>255ï¼Œ è€Œ <strong>Limited Range</strong> çš„ Rã€Gã€B å–å€¼èŒƒå›´æ˜¯ 16</del>235ã€‚</p>
<h2 id="é¢œè‰²ç©ºé—´"><a class="header" href="#é¢œè‰²ç©ºé—´">é¢œè‰²ç©ºé—´</a></h2>
<h3 id="rgb"><a class="header" href="#rgb">RGB</a></h3>
<p><img src="cs/../images/video-process/RGB-format.png" alt="RGBå­˜å‚¨æ ¼å¼" /></p>
<ul>
<li>OpenCV ä½¿ç”¨çš„æ˜¯ BGR æ ¼å¼ï¼Œè€Œä¸æ˜¯ RGBã€‚</li>
<li>RGB ä¸‰ä¸ªé¢œè‰²æ˜¯æœ‰<strong>ç›¸å…³æ€§</strong>çš„ï¼Œæ‰€ä»¥ä¸å¤ªæ–¹ä¾¿åšå›¾åƒå‹ç¼©ç¼–ç ã€‚</li>
<li>RGB é¢œè‰²ç©ºé—´æ›´é€‚åˆå›¾åƒé‡‡é›†å’Œæ˜¾ç¤ºã€‚</li>
</ul>
<h3 id="yuv"><a class="header" href="#yuv">YUV</a></h3>
<p>YUV å›¾åƒå°†äº®åº¦ä¿¡æ¯ Y ä¸è‰²å½©ä¿¡æ¯ Uã€V åˆ†ç¦»å¼€æ¥ã€‚Y è¡¨ç¤ºäº®åº¦(Luma)ï¼Œæ˜¯å›¾åƒçš„æ€»ä½“è½®å»“ï¼ŒUã€V è¡¨ç¤ºè‰²åº¦(Chroma)ï¼Œä¸»è¦æç»˜å›¾åƒçš„è‰²å½©ç­‰ä¿¡æ¯ã€‚YUV é¢œè‰²ç©ºé—´æ›´é€‚åˆäºç¼–ç å’Œå­˜å‚¨ã€‚</p>
<p>æ ¹æ®é‡‡æ ·æ–¹å¼çš„ä¸åŒï¼ŒYUV ä¸»è¦åˆ†ä¸º YUV 4:4:4ã€YUV 4:2:2ã€YUV 4:2:0 ä¸‰ç§ã€‚</p>
<p>æ ¹æ®å­˜å‚¨æ–¹å¼çš„ä¸åŒï¼ŒYUV è¿˜å¯ä»¥åˆ†æˆä¸‰å¤§ç±»ï¼š<strong>Planar</strong>ï¼Œ <strong>Semi-Planar</strong> å’Œ <strong>Packed</strong>ã€‚Planar æ ¼å¼çš„ YUV æ˜¯å…ˆè¿ç»­å­˜å‚¨æ‰€æœ‰åƒç´ ç‚¹çš„ Yï¼Œç„¶åå­˜å‚¨æ‰€æœ‰åƒç´ ç‚¹çš„ Uï¼ˆæˆ–è€… Vï¼‰ï¼Œä¹‹åå†å­˜å‚¨æ‰€æœ‰åƒç´ ç‚¹çš„ Vï¼ˆæˆ–è€… Uï¼‰ã€‚Semi-planar æ ¼å¼çš„ YUV æ˜¯å…ˆå­˜å‚¨å®Œæ‰€æœ‰åƒç´ çš„ Yï¼Œç„¶å Uã€V è¿ç»­åœ°äº¤é”™å­˜å‚¨ã€‚packed æ ¼å¼çš„ YUV æ˜¯è¿ç»­äº¤é”™å­˜å‚¨çš„ã€‚</p>
<h4 id="yuv444"><a class="header" href="#yuv444">YUV444</a></h4>
<p><img src="cs/../images/video-process/yuv444-sample.jpg" alt="YUV444é‡‡æ ·" /></p>
<p>Planar å­˜å‚¨æ ¼å¼:
<img src="cs/../images/video-process/yuv444-storage.jpg" alt="YUV444å­˜å‚¨" /></p>
<h4 id="yuv422"><a class="header" href="#yuv422">YUV422</a></h4>
<p><img src="cs/../images/video-process/yuv422-sample.jpg" alt="YUV422é‡‡æ ·" /></p>
<p>Planar å­˜å‚¨æ ¼å¼:
<img src="cs/../images/video-process/yuv422-storage-planar.jpg" alt="YUV422På­˜å‚¨" /></p>
<p>Semi-Planar å­˜å‚¨æ ¼å¼:
<img src="cs/../images/video-process/yuv422-storage-semiplanar.jpg" alt="YUV422SPå­˜å‚¨" /></p>
<h4 id="yuv420-æœ€å¸¸ç”¨"><a class="header" href="#yuv420-æœ€å¸¸ç”¨">YUV420 (æœ€å¸¸ç”¨)</a></h4>
<p><img src="cs/../images/video-process/yuv420-sample.jpg" alt="YUV420é‡‡æ ·" /></p>
<p>Planar å­˜å‚¨æ ¼å¼:
<img src="cs/../images/video-process/yuv420-storage-planar.jpg" alt="YUV420På­˜å‚¨" /></p>
<p>Semi-Planar å­˜å‚¨æ ¼å¼:
<img src="cs/../images/video-process/yuv420-storage-semiplanar.jpg" alt="YUV420SPå­˜å‚¨" /></p>
<h3 id="rgb-ä¸-yuv-è½¬æ¢"><a class="header" href="#rgb-ä¸-yuv-è½¬æ¢">RGB ä¸ YUV è½¬æ¢</a></h3>
<p><strong>RGB å’Œ YUV æ ¼å¼è½¬æ¢éœ€è¦åŒæ–¹ç¡®å®šå¥½è½¬æ¢æ ‡å‡†å’Œ Color Range</strong>ã€‚</p>
<h4 id="bt601-æ ‡å‡†æ ‡æ¸…"><a class="header" href="#bt601-æ ‡å‡†æ ‡æ¸…">BT601 æ ‡å‡†ï¼ˆæ ‡æ¸…ï¼‰</a></h4>
<p><strong>Limited Range</strong>:</p>
<p>RGB-&gt;YUV è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
Y &amp;= 0.299 * R + 0.587 * G + 0.114 * B \\
U &amp;= -0.172 * R - 0.339 * G + 0.511 * B + 128 \\
V &amp;= 0.511 * R - 0.428 * G - 0.083 * B + 128
\end{cases}
$$</p>
<p>YUV-&gt;RGB è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
R &amp;= Y + 1.371 * (V - 128) \\
G &amp;= Y - 0.336 * (U - 128) - 0.698 * (V - 128) \\
B &amp;= Y + 1.732 * (U - 128)
\end{cases}
$$</p>
<p><strong>Full Range</strong>:</p>
<p>RGB-&gt;YUV è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
Y &amp;= 16 + 0.257 * R + 0.504 * G + 0.098 * B \\
U &amp;= 128 - 0.148 * R - 0.291 * G + 0.439 * B \\
V &amp;= 128 + 0.439 * R - 0.368 * G - 0.071 * B
\end{cases}
$$</p>
<p>YUV-&gt;RGB è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
R &amp;= 1.164 * (Y - 16) + 1.596 * (V - 128) \\
G &amp;= 1.164 * (Y - 16) - 0.392 * (U - 128) - 0.812 * (V - 128) \\
B &amp;= 1.164 * (Y - 16) + 2.016 * (U - 128)
\end{cases}
$$</p>
<h4 id="bt709-æ ‡å‡†é«˜æ¸…"><a class="header" href="#bt709-æ ‡å‡†é«˜æ¸…">BT709 æ ‡å‡†ï¼ˆé«˜æ¸…ï¼‰</a></h4>
<p><strong>Limited Range</strong>:</p>
<p>RGB-&gt;YUV è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
Y &amp;= 0.213 * R + 0.715 * G + 0.072 * B \\
U &amp;= -0.117 * R - 0.394 * G + 0.511 * B + 128 \\
V &amp;= 0.511 * R - 0.464 * G - 0.047 * B + 128
\end{cases}
$$</p>
<p>YUV-&gt;RGB è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
R &amp;= Y + 1.540 * (V - 128) \\
G &amp;= Y - 0.183 * (U - 128) - 0.459 * (V - 128) \\
B &amp;= Y + 1.816 * (U - 128)
\end{cases}
$$</p>
<p><strong>Full Range</strong>:</p>
<p>RGB-&gt;YUV è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
Y &amp;= 16 + 0.183 * R + 0.614 * G + 0.062 * B \\
U &amp;= 128 - 0.101 * R - 0.339 * G + 0.439 * B \\
V &amp;= 128 + 0.439 * R - 0.339 * G - 0.040 * B
\end{cases}
$$</p>
<p>YUV-&gt;RGB è½¬æ¢å…¬å¼</p>
<p>$$
\begin{cases}
R &amp;= 1.164 * (Y - 16) + 1.792 * (V - 128) \\
G &amp;= 1.164 * (Y - 16) - 0.213 * (U - 128) - 0.534 * (V - 128) \\
B &amp;= 1.164 * (Y - 16) + 2.114 * (U - 128)
\end{cases}
$$</p>
<h3 id="ä½¿ç”¨-ffmpeg-å°†-png-å›¾ç‰‡è½¬æˆ-yuv-æ ¼å¼"><a class="header" href="#ä½¿ç”¨-ffmpeg-å°†-png-å›¾ç‰‡è½¬æˆ-yuv-æ ¼å¼">ä½¿ç”¨ ffmpeg å°† png å›¾ç‰‡è½¬æˆ YUV æ ¼å¼</a></h3>
<p><a href="https://fakeimg.pl/320x320/448aff/fff/?text=hello&amp;font=lobster">è·å– png å›¾ç‰‡</a></p>
<pre><code class="language-bash">ffmpeg -i hello.png -pix_fmt yuv420p hello-yuv420p.yuv
</code></pre>
<p>è½¬æ¢å¾—åˆ°çš„ yuv å›¾åƒå¯ä»¥ä½¿ç”¨ <a href="https://github.com/IENT/YUView">YUView</a> è½¯ä»¶æ‰“å¼€ï¼ˆæ³¨æ„ï¼Œéœ€è¦è‡ªè¡Œè®¾ç½®å›¾ç‰‡çš„åˆ†è¾¨ç‡ç­‰å‚æ•°ï¼Œå¦åˆ™ä¸èƒ½æ­£ç¡®æ˜¾ç¤ºï¼‰ã€‚</p>
<p>ç”±äº yuv å›¾ç‰‡é™¤äº†åŸå§‹çš„åƒç´ æ•°æ®ï¼Œæ²¡æœ‰ä¿å­˜é¢å¤–çš„æ•°æ®ï¼Œå› æ­¤è½¬æ¢å¾—åˆ°çš„å›¾åƒå¤§å°ä¸ºï¼š320*320*3/2 = 153600 å­—èŠ‚ã€‚</p>
<h2 id="å›¾åƒçš„ç¼©æ”¾"><a class="header" href="#å›¾åƒçš„ç¼©æ”¾">å›¾åƒçš„ç¼©æ”¾</a></h2>
<p>å›¾åƒçš„ç¼©æ”¾å°±æ˜¯å°†åŸå›¾åƒçš„å·²æœ‰åƒç´ ç»è¿‡åŠ æƒè¿ç®—å¾—åˆ°ç›®æ ‡å›¾åƒçš„ç›®æ ‡åƒç´ ã€‚</p>
<p>å‡è®¾åŸå›¾åƒçš„åˆ†è¾¨ç‡æ˜¯ <code>w0 * h0</code>ï¼Œæˆ‘ä»¬éœ€è¦ç¼©æ”¾åˆ° <code>w1 * h1</code>ã€‚é‚£æˆ‘ä»¬åªéœ€è¦å°†ç›®æ ‡å›¾åƒä¸­çš„åƒç´ ä½ç½®<code>ï¼ˆxï¼Œyï¼‰</code>æ˜ å°„åˆ°åŸå›¾åƒçš„<code>ï¼ˆx * w0 / w1ï¼Œy * h0 / h1ï¼‰</code>ï¼Œå†æ’å€¼å¾—åˆ°è¿™ä¸ªåƒç´ å€¼å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªæ’å€¼å¾—åˆ°çš„åƒç´ å€¼å°±æ˜¯ç›®æ ‡å›¾åƒåƒç´ ç‚¹<code>ï¼ˆxï¼Œyï¼‰</code>çš„åƒç´ å€¼ã€‚æ³¨æ„ï¼Œ<code>ï¼ˆx * w0 / w1ï¼Œy * h0 / h1ï¼‰</code>ç»å¤§å¤šæ•°æ—¶å€™æ˜¯å°æ•°ã€‚</p>
<h3 id="å›¾åƒç¼©æ”¾çš„åœºæ™¯"><a class="header" href="#å›¾åƒç¼©æ”¾çš„åœºæ™¯">å›¾åƒç¼©æ”¾çš„åœºæ™¯</a></h3>
<ol>
<li>æ’­æ”¾çª—å£ä¸åŸå§‹å›¾åƒåˆ†è¾¨ç‡ä¸åŒ¹é…çš„æ—¶å€™éœ€è¦ç¼©æ”¾</li>
<li>åœ¨çº¿è§‚çœ‹è§†é¢‘æ—¶ä¼šæœ‰å¤šç§åˆ†è¾¨ç‡å¯ä»¥é€‰æ‹©ï¼Œå³éœ€è¦åœ¨ä¸€ä¸ªå›¾åƒåˆ†è¾¨ç‡çš„åŸºç¡€ä¸Šç¼©æ”¾å‡ºå¤šç§ä¸åŒå°ºå¯¸çš„å›¾åƒå‡ºæ¥åšç¼–ç ï¼Œå¹¶ä¿å­˜å¤šä¸ªä¸åŒåˆ†è¾¨ç‡çš„è§†é¢‘æ–‡ä»¶</li>
<li>RTC åœºæ™¯ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®ç½‘ç»œçŠ¶å†µå®æ—¶è°ƒèŠ‚è§†é¢‘é€šè¯çš„åˆ†è¾¨ç‡</li>
</ol>
<h3 id="æ’å€¼ç®—æ³•"><a class="header" href="#æ’å€¼ç®—æ³•">æ’å€¼ç®—æ³•</a></h3>
<p>ä½¿ç”¨å‘¨å›´å·²æœ‰çš„åƒç´ å€¼é€šè¿‡ä¸€å®šçš„åŠ æƒè¿ç®—å¾—åˆ°â€œæ’å€¼åƒç´ å€¼â€ã€‚æ’å€¼ç®—æ³•ä¸»è¦åŒ…æ‹¬ï¼šæœ€è¿‘é‚»æ’å€¼ç®—æ³•ï¼ˆNearestï¼‰ã€åŒçº¿æ€§æ’å€¼ç®—æ³•ï¼ˆBilinearï¼‰ã€åŒä¸‰æ¬¡æ’å€¼ç®—æ³•ï¼ˆBiCubicï¼‰ç­‰ã€‚</p>
<h4 id="æœ€è¿‘é‚»æ’å€¼ç®—æ³•"><a class="header" href="#æœ€è¿‘é‚»æ’å€¼ç®—æ³•">æœ€è¿‘é‚»æ’å€¼ç®—æ³•</a></h4>
<blockquote>
<p>é€‰æ‹©å¾…æ’å€¼åƒç´ å‘¨å›´çš„ 4 ä¸ªåƒç´ ï¼Œå¹¶å–ç¦»å¾…æ’å€¼åƒç´ ä½ç½®æœ€è¿‘çš„åƒç´ ç‚¹æƒé‡ä¸º 1ï¼Œå…¶ä½™ 3 ä¸ªç‚¹æƒé‡ä¸º 0</p>
</blockquote>
<ol>
<li>å°†ç›®æ ‡å›¾åƒä¸­çš„ç›®æ ‡åƒç´ ä½ç½®ï¼Œæ˜ å°„åˆ°åŸå›¾åƒçš„æ˜ å°„ä½ç½®</li>
<li>æ‰¾åˆ°åŸå›¾åƒä¸­æ˜ å°„ä½ç½®å‘¨å›´çš„ 4 ä¸ªåƒç´ </li>
<li>å–ç¦»æ˜ å°„ä½ç½®æœ€è¿‘çš„åƒç´ ç‚¹çš„åƒç´ å€¼ä½œä¸ºç›®æ ‡åƒç´ </li>
</ol>
<p><strong>ç¼ºç‚¹</strong>: å®ƒç›´æ¥ä½¿ç”¨ç¦»æ’å€¼ä½ç½®æœ€è¿‘çš„æ•´æ•°ä½ç½®çš„åƒç´ ä½œä¸ºæ’å€¼åƒç´ ï¼Œå¯¼è‡´ç›¸é‚»ä¸¤ä¸ªæ’å€¼åƒç´ æœ‰å¾ˆå¤§çš„æ¦‚ç‡æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·å¾—åˆ°çš„æ”¾å¤§å›¾åƒå¤§æ¦‚ç‡ä¼šå‡ºç°<strong>å—çŠ¶æ•ˆåº”</strong>ï¼Œè€Œç¼©å°å›¾åƒå®¹æ˜“å‡ºç°é”¯é½¿ã€‚</p>
<h4 id="åŒçº¿æ€§æ’å€¼ç®—æ³•"><a class="header" href="#åŒçº¿æ€§æ’å€¼ç®—æ³•">åŒçº¿æ€§æ’å€¼ç®—æ³•</a></h4>
<blockquote>
<p>é€‰æ‹©å¾…æ’å€¼åƒç´ å‘¨å›´çš„ 4 ä¸ªåƒç´ ï¼Œå¹¶ä¸”æ¯ä¸ªåƒç´ ä»¥è·ç¦»ä½œä¸ºæƒé‡ï¼Œè·ç¦»è¶Šè¿‘æƒé‡è¶Šå¤§ï¼Œè·ç¦»è¶Šè¿œæƒé‡è¶Šå°</p>
</blockquote>
<p>åŒçº¿æ€§æ’å€¼å…¶å®å°±æ˜¯ä¸‰æ¬¡çº¿æ€§æ’å€¼çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ä¸¤æ¬¡çº¿æ€§æ’å€¼å¾—åˆ°ä¸¤ä¸ªä¸­é—´å€¼ï¼Œç„¶åå†é€šè¿‡å¯¹è¿™ä¸¤ä¸ªä¸­é—´å€¼è¿›è¡Œä¸€æ¬¡æ’å€¼å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚</p>
<p><img src="cs/../images/video-process/bilinear-interpolation.webp" alt="åŒçº¿æ€§æ’å€¼" /></p>
<p>$$
val(m) = \frac{x - x_1}{x_2 - x_1} * val(b) + \frac{x_2 - x}{x_2 - x_1} * val(a) \\
val(n) = \frac{x - x_1}{x_2 - x_1} * val(d) + \frac{x_2 - x}{x_2 - x_1} * val(c) \\
val(p) = \frac{y - y_1}{y_2 - y_1} * val(m) + \frac{y_2 - y}{y_2 - y_1} * val(n)
$$</p>
<p>å…¶ä¸­çš„ <code>val()</code> è¡¨ç¤ºè¯¥åƒç´ çš„åƒç´ å€¼ã€‚</p>
<h4 id="åŒä¸‰æ¬¡æ’å€¼ç®—æ³•"><a class="header" href="#åŒä¸‰æ¬¡æ’å€¼ç®—æ³•">åŒä¸‰æ¬¡æ’å€¼ç®—æ³•</a></h4>
<ol>
<li>åŒä¸‰æ¬¡æ’å€¼é€‰å–çš„æ˜¯å‘¨å›´çš„ 16 ä¸ªåƒç´ ï¼Œæ¯”å‰ä¸¤ç§æ’å€¼ç®—æ³•å¤šäº† 3 å€</li>
<li>å‘¨å›´åƒç´ çš„æƒé‡è®¡ç®—æ˜¯ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ <strong>BiCubic</strong> åŸºå‡½æ•°æ¥è®¡ç®—çš„</li>
</ol>
<p>å…ˆé€šè¿‡è¿™ä¸ª BiCubic åŸºå‡½æ•°è®¡ç®—å¾—åˆ°å¾…æ’å€¼åƒç´ å‘¨å›´ 16 ä¸ªåƒç´ çš„æƒé‡ï¼Œç„¶åå°† 16 ä¸ªåƒç´ åŠ æƒå¹³å‡å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„å¾…æ’å€¼åƒç´ äº†ã€‚</p>
<p>BiCubic å‡½æ•°çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$$
f(x) = \begin{cases}
(a+2)|x|^3 - (a+3)|x|^2 + 1 &amp; 0 \le |x| &lt; 1 \\
a|x|^3 - 5a|x|^2 + 8a|x| - 4a &amp; 1 \le |x| &lt; 2 \\
0 &amp; 2 \le |x|
\end{cases}
$$</p>
<p>å…¶ä¸­ a çš„å–å€¼èŒƒå›´æ˜¯ [-1, 0]ï¼Œä¸€èˆ¬å– -0.5ã€‚</p>
<p>å¯¹äºå‘¨å›´ 16 ä¸ªç‚¹ä¸­çš„æ¯ä¸€ä¸ªç‚¹ï¼Œå…¶åæ ‡å€¼ä¸ºï¼ˆxï¼Œyï¼‰ï¼Œè€Œç›®æ ‡å›¾åƒä¸­çš„ç›®æ ‡åƒç´ åœ¨åŸå›¾åƒä¸­çš„æ˜ å°„åæ ‡ä¸º pï¼ˆuï¼Œvï¼‰ã€‚é‚£ä¹ˆé€šè¿‡ä¸Šé¢å…¬å¼å¯ä»¥æ±‚å¾—å…¶æ°´å¹³æƒé‡ Wï¼ˆu - xï¼‰ï¼Œå‚ç›´æƒé‡ Wï¼ˆv - yï¼‰ã€‚å°† Wï¼ˆu - xï¼‰ä¹˜ä»¥ Wï¼ˆv - yï¼‰å¾—åˆ°æœ€ç»ˆæƒé‡å€¼ï¼Œç„¶åå†ç”¨æœ€ç»ˆæƒé‡å€¼ä¹˜ä»¥è¯¥ç‚¹çš„åƒç´ å€¼ï¼Œå¹¶å¯¹ 16 ä¸ªç‚¹åˆ†åˆ«åšåŒæ ·çš„æ“ä½œå¹¶æ±‚å’Œï¼Œå°±å¾—åˆ°å¾…æ’å€¼çš„åƒç´ å€¼äº†ã€‚</p>
<h2 id="è§†é¢‘ç¼–ç "><a class="header" href="#è§†é¢‘ç¼–ç ">è§†é¢‘ç¼–ç </a></h2>
<p>äººçœ¼å¯¹äºäº®åº¦ä¿¡æ¯æ›´åŠ æ•æ„Ÿï¼Œè€Œå¯¹äºè‰²åº¦ä¿¡æ¯ç¨å¼±ï¼Œæ‰€ä»¥è§†é¢‘ç¼–ç æ˜¯å°† Y åˆ†é‡å’Œ UV åˆ†é‡åˆ†å¼€æ¥ç¼–ç çš„ã€‚å¯¹äºæ¯ä¸€å¸§å›¾åƒï¼Œåˆæ˜¯åˆ’åˆ†æˆä¸€ä¸ªä¸ªå—æ¥è¿›è¡Œç¼–ç çš„ï¼Œè¿™ä¸€ä¸ªä¸ªå—åœ¨ H264 ä¸­å«åšå®å—ã€‚å®å—çš„å¤§å°ä¸€èˆ¬æ˜¯ 16x16ã€‚</p>
<h3 id="å›¾åƒçš„æ•°æ®å†—ä½™"><a class="header" href="#å›¾åƒçš„æ•°æ®å†—ä½™">å›¾åƒçš„æ•°æ®å†—ä½™</a></h3>
<ul>
<li><strong>ç©ºé—´å†—ä½™</strong>ï¼šä¸€å¹…å›¾åƒä¸­ç›¸é‚»åƒç´ çš„äº®åº¦å’Œè‰²åº¦ä¿¡æ¯æ˜¯æ¯”è¾ƒæ¥è¿‘çš„ï¼Œå¹¶ä¸”äº®åº¦å’Œè‰²åº¦ä¿¡æ¯ä¹Ÿæ˜¯é€æ¸å˜åŒ–çš„ï¼Œä¸å¤ªä¼šå‡ºç°çªå˜ã€‚</li>
<li><strong>æ—¶é—´å†—ä½™</strong>ï¼šç›¸é‚»ä¸¤å¸§å›¾åƒçš„å˜åŒ–æ¯”è¾ƒå°ï¼Œç›¸ä¼¼æ€§å¾ˆé«˜</li>
<li><strong>è§†è§‰å†—ä½™</strong>ï¼šäººçœ¼å¯¹äºå›¾åƒä¸­é«˜é¢‘ä¿¡æ¯çš„æ•æ„Ÿåº¦è¦å°äºä½é¢‘ä¿¡æ¯çš„ï¼Œå»é™¤å›¾åƒä¸­çš„ä¸€äº›é«˜é¢‘ä¿¡æ¯å¯¹äºäººçœ¼æ¥è¯´å·®åˆ«ä¸å¤§</li>
<li><strong>ä¿¡æ¯ç†µå†—ä½™</strong>ï¼šå›¾åƒä¸­çš„ä¸€äº›åƒç´ å€¼å‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒå¤§ï¼Œè€Œå¦ä¸€äº›åƒç´ å€¼å‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œå› æ­¤å¯ä»¥é€šè¿‡åˆç†çš„ç¼–ç æ¥å‹ç¼©æ•°æ®</li>
</ul>
<h3 id="ç¼–ç åŸç†"><a class="header" href="#ç¼–ç åŸç†">ç¼–ç åŸç†</a></h3>
<p>åœ¨æ¯ä¸€ä¸ªå®å—ä¸­ï¼Œä»å·¦ä¸Šè§’å¼€å§‹<strong>ä¹‹</strong>å­—å½¢æ‰«ææ¯ä¸€ä¸ªåƒç´ å€¼ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªâ€œåƒç´ ä¸²â€ã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æœ€åç†µç¼–ç çš„æ—¶å€™å‹ç¼©ç‡æ›´é«˜ï¼Œæˆ‘ä»¬å¸Œæœ›é€åˆ°ç†µç¼–ç ï¼ˆä»¥<strong>è¡Œç¨‹ç¼–ç </strong>ä¸ºä¾‹ï¼‰çš„â€œåƒç´ ä¸²â€ï¼Œæ˜¯ä¸€ä¸²å«æœ‰å¾ˆå¤š 0ï¼Œå¹¶ä¸”æœ€å¥½è¿ç»­ä¸º 0 çš„â€œåƒç´ ä¸²â€ã€‚</p>
<h4 id="å¸§å†…é¢„æµ‹å‡å°å›¾åƒå—çš„ç©ºé—´å†—ä½™"><a class="header" href="#å¸§å†…é¢„æµ‹å‡å°å›¾åƒå—çš„ç©ºé—´å†—ä½™"><strong>å¸§å†…é¢„æµ‹</strong>å‡å°å›¾åƒå—çš„ç©ºé—´å†—ä½™</a></h4>
<p>å¸§å†…é¢„æµ‹å°±æ˜¯åœ¨å½“å‰ç¼–ç å›¾åƒå†…éƒ¨å·²ç»ç¼–ç å®Œæˆçš„å—ä¸­æ‰¾åˆ°ä¸å°†è¦ç¼–ç çš„å—ç›¸é‚»çš„å—ã€‚ä¸€èˆ¬å°±æ˜¯å³å°†ç¼–ç å—çš„å·¦è¾¹å—ã€ä¸Šè¾¹å—ã€å·¦ä¸Šè§’å—å’Œå³ä¸Šè§’å—ï¼Œé€šè¿‡å°†è¿™äº›å—ä¸ç¼–ç å—ç›¸é‚»çš„åƒç´ ç»è¿‡<strong>å¤šç§ä¸åŒçš„ç®—æ³•</strong>å¾—åˆ°å¤šä¸ªä¸åŒçš„<strong>é¢„æµ‹å—</strong>ã€‚ç„¶åæˆ‘ä»¬å†ç”¨ç¼–ç å—å‡å»æ¯ä¸€ä¸ªé¢„æµ‹å—å¾—åˆ°ä¸€ä¸ªä¸ª<strong>æ®‹å·®å—</strong>ã€‚æœ€åï¼Œæˆ‘ä»¬å–è¿™äº›ç®—æ³•å¾—åˆ°çš„æ®‹å·®å—ä¸­åƒç´ çš„ç»å¯¹å€¼åŠ èµ·æ¥æœ€å°çš„å—ä¸ºé¢„æµ‹å—ã€‚è€Œå¾—åˆ°è¿™ä¸ªé¢„æµ‹å—çš„ç®—æ³•ä¸ºå¸§å†…é¢„æµ‹æ¨¡å¼ã€‚å¸§å†…é¢„æµ‹æ˜¯æ ¹æ®å—çš„å¤§å°åˆ†ä¸ºä¸åŒçš„é¢„æµ‹æ¨¡å¼çš„ã€‚åœ¨ H264 æ ‡å‡†é‡Œé¢ï¼Œå—åˆ†ä¸ºå®å—å’Œå­å—ã€‚å®å—çš„å¤§å°æ˜¯ 16 x 16ï¼ˆYUV 4:2:0 å›¾åƒäº®åº¦å—ä¸º 16 x 16ï¼Œè‰²åº¦å—ä¸º 8 x 8ï¼‰ã€‚åœ¨å¸§å†…é¢„æµ‹ä¸­ï¼Œäº®åº¦å®å—å¯ä»¥ç»§ç»­åˆ’åˆ†æˆ 16 ä¸ª 4 x 4 çš„å­å—ã€‚å› ä¸ºå›¾åƒä¸­æœ‰çš„åœ°æ–¹ç»†èŠ‚å¾ˆå¤šï¼Œæˆ‘ä»¬éœ€è¦åˆ’åˆ†æˆæ›´å°çš„å—æ¥åšé¢„æµ‹ä¼šæ›´ç²¾ç»†ï¼Œæ‰€ä»¥ä¼šå°†å®å—å†åˆ’åˆ†æˆ 4 x 4 çš„å­å—ã€‚å¸§å†…é¢„æµ‹ä¸­äº®åº¦å—å’Œè‰²åº¦å—æ˜¯åˆ†å¼€ç‹¬ç«‹è¿›è¡Œé¢„æµ‹çš„ï¼Œå³äº®åº¦å—å‚è€ƒå·²ç¼–ç äº®åº¦å—çš„åƒç´ ï¼Œè€Œè‰²åº¦å—å‚è€ƒå·²ç¼–ç è‰²åº¦å—çš„åƒç´ ã€‚</p>
<p><img src="cs/../images/video-process/intra-frame-predicdion.webp" alt="å¸§å†…é¢„æµ‹" /></p>
<h5 id="4-x-4-äº®åº¦å—çš„å¸§å†…é¢„æµ‹æ¨¡å¼"><a class="header" href="#4-x-4-äº®åº¦å—çš„å¸§å†…é¢„æµ‹æ¨¡å¼">4 x 4 äº®åº¦å—çš„å¸§å†…é¢„æµ‹æ¨¡å¼</a></h5>
<ol>
<li>
<p>Vertical æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-vertical-mode.webp" alt="Verticalæ¨¡å¼" /></p>
</li>
<li>
<p>Horizontal æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-horizontal-mode.webp" alt="Horizontalæ¨¡å¼" /></p>
</li>
<li>
<p>DC æ¨¡å¼</p>
<p>DC æ¨¡å¼å°±æ˜¯æŒ‡ï¼Œå½“å‰ç¼–ç äº®åº¦å—çš„æ¯ä¸€ä¸ªåƒç´ å€¼ï¼Œæ˜¯ä¸Šè¾¹å·²ç»ç¼–ç å—çš„æœ€ä¸‹é¢é‚£ä¸€è¡Œå’Œå·¦è¾¹å·²ç¼–ç å—å³è¾¹æœ€åä¸€åˆ—çš„æ‰€æœ‰åƒç´ å€¼çš„å¹³å‡å€¼ã€‚æ³¨æ„ï¼ŒDC æ¨¡å¼é¢„æµ‹å¾—åˆ°çš„å—ä¸­æ¯ä¸€ä¸ªåƒç´ å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<p><img src="cs/../images/video-process/intra-dc-mode.webp" alt="DCæ¨¡å¼" /></p>
</li>
<li>
<p>Diagonal Down-Left æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-diagonal-down-left-mode.webp" alt="Diagonal Down-Leftæ¨¡å¼" /></p>
</li>
<li>
<p>Diagonal Down-Right æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-diagonal-down-right-mode.webp" alt="Diagonal Down-Rightæ¨¡å¼" /></p>
</li>
<li>
<p>Vertical-Right æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-vertical-right-mode.webp" alt="Vertical-Rightæ¨¡å¼" /></p>
</li>
<li>
<p>Horizontal-Down æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-horizontal-down-mode.webp" alt="Horizontal-Downæ¨¡å¼" /></p>
</li>
<li>
<p>Vertical-Left æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-vertical-left-mode.webp" alt="Vertical-Leftæ¨¡å¼" /></p>
</li>
<li>
<p>Horizontal-Up æ¨¡å¼</p>
<p><img src="cs/../images/video-process/intra-horizontal-up-mode.webp" alt="Horizontal-Upæ¨¡å¼" /></p>
</li>
</ol>
<p>å¯¹äºæ¯ä¸€ä¸ªå—æˆ–è€…å­å—ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°é¢„æµ‹å—ï¼Œå†ç”¨å®é™…å¾…ç¼–ç çš„å—å‡å»é¢„æµ‹å—å°±å¯ä»¥å¾—åˆ°æ®‹å·®å—ã€‚ä¸»è¦æœ‰ä¸‹é¢ 3 ç§æ–¹æ¡ˆæ¥å¾—åˆ°æœ€ä¼˜é¢„æµ‹æ¨¡å¼ï¼š</p>
<p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå…ˆå¯¹æ¯ä¸€ç§é¢„æµ‹æ¨¡å¼çš„æ®‹å·®å—çš„åƒç´ å€¼æ±‚ç»å¯¹å€¼å†æ±‚å’Œï¼Œç§°ä¹‹ä¸º costï¼Œç„¶åå–å…¶ä¸­æ®‹å·®å—ç»å¯¹å€¼ä¹‹å’Œä¹Ÿå°±æ˜¯ cost æœ€å°çš„é¢„æµ‹æ¨¡å¼ä¸ºæœ€ä¼˜é¢„æµ‹æ¨¡å¼ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¯¹æ®‹å·®å—å…ˆè¿›è¡Œ Hadamard å˜æ¢ï¼ˆåœ¨ DCT å˜æ¢å’Œé‡åŒ–é‚£èŠ‚è¯¾ä¸­ä¼šä»‹ç»ï¼‰ï¼Œå˜æ¢åˆ°é¢‘åŸŸä¹‹åå†æ±‚ç»å¯¹å€¼æ±‚å’Œï¼ŒåŒæ ·ç§°ä¸º costï¼Œç„¶åå– cost æœ€å°çš„é¢„æµ‹æ¨¡å¼ä¸ºæœ€ä¼˜é¢„æµ‹æ¨¡å¼ã€‚</p>
<p>ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥å¯¹æ®‹å·®å—ç›´æ¥è¿›è¡Œ DCT å˜æ¢é‡åŒ–ç†µç¼–ç ï¼Œè®¡ç®—å¾—åˆ°å¤±çœŸå¤§å°å’Œç¼–ç åçš„ç æµå¤§å°ï¼Œç„¶åé€šè¿‡<strong>ç‡å¤±çœŸä¼˜åŒ–</strong>çš„æ–¹æ³•æ¥é€‰æ‹©æœ€ä¼˜é¢„æµ‹æ¨¡å¼ã€‚</p>
<p>é€šè¿‡ä¸Šé¢è®²çš„è¿™äº›æ–¹æ³•æˆ‘ä»¬æ‰¾åˆ°äº†æ¯ä¸€ä¸ª 4 x 4 å—çš„æœ€ä¼˜æ¨¡å¼ä¹‹åï¼Œå°†è¿™ 16 ä¸ª 4 x 4 å—çš„ cost åŠ èµ·æ¥ï¼Œä¸ 16 x 16 å—çš„æœ€å° cost å¯¹æ¯”ï¼Œé€‰æ‹© cost æœ€å°çš„å—åˆ’åˆ†æ–¹å¼å’Œé¢„æµ‹æ¨¡å¼ä½œä¸ºå¸§å†…é¢„æµ‹æ¨¡å¼ã€‚</p>
<p><strong>åœ¨ H264 æ ‡å‡†é‡Œé¢ï¼Œè§†é¢‘çš„ç¬¬ä¸€å¸§çš„ç¬¬ä¸€ä¸ªå—çš„å·¦å’Œä¸Šéƒ½æ˜¯ç©ºï¼Œæ²¡æ³•é¢„æµ‹ï¼Œæ‰€ä»¥è®¾ç½®æˆäº†ä¸€ä¸ªçº¦å®šå€¼128ï¼Œæ–¹ä¾¿ç¼–ç </strong>ã€‚</p>
<h4 id="å¸§é—´é¢„æµ‹å‡å°å›¾åƒå—çš„æ—¶é—´å†—ä½™"><a class="header" href="#å¸§é—´é¢„æµ‹å‡å°å›¾åƒå—çš„æ—¶é—´å†—ä½™"><strong>å¸§é—´é¢„æµ‹</strong>å‡å°å›¾åƒå—çš„æ—¶é—´å†—ä½™</a></h4>
<p>åœ¨å‰é¢å·²ç»ç¼–ç å®Œæˆçš„å›¾åƒä¸­ï¼Œå¾ªç¯éå†æ¯ä¸€ä¸ªå—ï¼Œå°†å®ƒä½œä¸ºé¢„æµ‹å—ï¼Œç”¨å½“å‰çš„ç¼–ç å—ä¸è¿™ä¸ªå—åšå·®å€¼ï¼Œå¾—åˆ°æ®‹å·®å—ï¼Œå–æ®‹å·®å—ä¸­åƒç´ å€¼çš„ç»å¯¹å€¼åŠ èµ·æ¥æœ€å°çš„å—ä¸ºé¢„æµ‹å—ï¼Œé¢„æµ‹å—æ‰€åœ¨çš„å·²ç»ç¼–ç çš„å›¾åƒç§°ä¸ºå‚è€ƒå¸§ã€‚é¢„æµ‹å—åœ¨å‚è€ƒå¸§ä¸­çš„åæ ‡å€¼ (x0, y0) ä¸ç¼–ç å—åœ¨ç¼–ç å¸§ä¸­çš„åæ ‡å€¼ (x1, y1) çš„å·®å€¼ (x0 - x1, y0 - y1) ç§°ä¹‹ä¸ºè¿åŠ¨çŸ¢é‡ã€‚åœ¨å‚è€ƒå¸§ä¸­å»å¯»æ‰¾é¢„æµ‹å—çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºè¿åŠ¨æœç´¢ã€‚å¸§é—´é¢„æµ‹æ—¢å¯ä»¥å‚è€ƒå‰é¢çš„å›¾åƒä¹Ÿå¯ä»¥å‚è€ƒåé¢çš„å›¾åƒã€‚åªå‚è€ƒå‰é¢å›¾åƒçš„å¸§æˆ‘ä»¬ç§°ä¸ºå‰å‘å‚è€ƒå¸§ï¼Œä¹Ÿå« P å¸§ï¼›å‚è€ƒåé¢çš„å›¾åƒæˆ–è€…å‰é¢åé¢å›¾åƒéƒ½å‚è€ƒçš„å¸§ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºåŒå‘å‚è€ƒå¸§ï¼Œä¹Ÿå«åš B å¸§ã€‚B å¸§ç›¸æ¯” P å¸§ä¸»è¦æ˜¯éœ€è¦å…ˆç¼–ç åé¢çš„å¸§ï¼Œå¹¶ä¸” B å¸§ä¸€ä¸ªç¼–ç å—å¯ä»¥æœ‰ä¸¤ä¸ªé¢„æµ‹å—ï¼Œè¿™ä¸¤ä¸ªé¢„æµ‹å—åˆ†åˆ«ç”±ä¸¤ä¸ªå‚è€ƒå¸§é¢„æµ‹å¾—åˆ°ï¼Œæœ€ååŠ æƒå¹³å‡å¾—åˆ°æœ€ç»ˆçš„é¢„æµ‹å—ã€‚</p>
<p>å¸§é—´é¢„æµ‹çš„å®å—å¤§å° 16 x 16ï¼Œå¯ä»¥åˆ’åˆ†ä¸º 16 x 8ï¼Œ8 x 16ï¼Œ 8 x 8 ä¸‰ç§ï¼Œå…¶ä¸­ 8 x 8 å¯ä»¥ç»§ç»­åˆ’åˆ†æˆ 8 x 4ï¼Œ4 x 8 å’Œ 4 x 4ï¼Œè¿™æ˜¯äº®åº¦å—çš„åˆ’åˆ†ã€‚åœ¨ YUV 4:2:0 ä¸­ï¼Œè‰²åº¦å—å®½é«˜å¤§å°éƒ½æ˜¯äº®åº¦å—çš„ä¸€åŠã€‚</p>
<p>åœ¨ H264 æ ‡å‡†ä¸­ï¼ŒP å¸§æœ€å¤šæ”¯æŒä» 16 ä¸ªå‚è€ƒå¸§ä¸­é€‰å‡ºä¸€ä¸ªä½œä¸ºç¼–ç å—çš„å‚è€ƒå¸§ï¼Œä½†æ˜¯åŒä¸€ä¸ªå¸§ä¸­çš„ä¸åŒå—å¯ä»¥é€‰æ‹©ä¸åŒçš„å‚è€ƒå¸§ï¼Œè¿™å°±æ˜¯å¤šå‚è€ƒã€‚</p>
<h5 id="è¿åŠ¨æœç´¢"><a class="header" href="#è¿åŠ¨æœç´¢">è¿åŠ¨æœç´¢</a></h5>
<ul>
<li>é’»çŸ³æœç´¢</li>
</ul>
<p><img src="cs/../images/video-process/motion-search-diamond.webp" alt="é’»çŸ³æœç´¢" /></p>
<ul>
<li>å…­è¾¹å½¢æœç´¢</li>
</ul>
<p><img src="cs/../images/video-process/motion-search-hexagon.webp" alt="å…­è¾¹å½¢æœç´¢" /></p>
<h4 id="dctå˜æ¢å’Œé‡åŒ–å‡å°å›¾åƒå—çš„è§†è§‰å†—ä½™"><a class="header" href="#dctå˜æ¢å’Œé‡åŒ–å‡å°å›¾åƒå—çš„è§†è§‰å†—ä½™"><strong>DCT</strong>å˜æ¢å’Œé‡åŒ–å‡å°å›¾åƒå—çš„è§†è§‰å†—ä½™</a></h4>
<p>åœ¨H264ä¸­ï¼Œå¦‚æœä¸€ä¸ªå—å¤§å°æ˜¯16x16ï¼Œä¸€èˆ¬ä¼šåˆ’åˆ†æˆ16ä¸ª4x4çš„å—ï¼Œç„¶åå¯¹æ¯ä¸ª 4x4 çš„å—åš DCT å˜æ¢å¾—åˆ°ç›¸åº”çš„ 4x4 çš„å˜æ¢å—ã€‚å˜æ¢å—çš„æ¯ä¸€ä¸ªâ€œåƒç´ å€¼â€æˆ‘ä»¬ç§°ä¸ºç³»æ•°ã€‚å˜æ¢å—<strong>å·¦ä¸Šè§’</strong>çš„ç³»æ•°å€¼å°±æ˜¯å›¾åƒçš„<strong>ä½é¢‘</strong>ä¿¡æ¯ï¼Œå…¶ä½™çš„å°±æ˜¯å›¾åƒçš„é«˜é¢‘ä¿¡æ¯ï¼Œå¹¶ä¸”é«˜é¢‘ä¿¡æ¯å å¤§éƒ¨åˆ†ã€‚ä½é¢‘ä¿¡æ¯è¡¨ç¤ºçš„æ˜¯ä¸€å¼ å›¾çš„æ€»ä½“æ ·è²Œã€‚ä¸€èˆ¬ä½é¢‘ç³»æ•°çš„å€¼ä¹Ÿæ¯”è¾ƒå¤§ã€‚è€Œé«˜é¢‘ä¿¡æ¯ä¸»è¦è¡¨ç¤ºçš„æ˜¯å›¾åƒä¸­äººç‰©æˆ–ç‰©ä½“çš„è½®å»“è¾¹ç¼˜ç­‰å˜åŒ–å‰§çƒˆçš„åœ°æ–¹ã€‚é«˜é¢‘ç³»æ•°çš„æ•°é‡å¤šï¼Œä½†é«˜é¢‘ç³»æ•°çš„å€¼ä¸€èˆ¬æ¯”è¾ƒå°ã€‚</p>
<p>è®©å˜æ¢å—çš„ç³»æ•°éƒ½åŒæ—¶é™¤ä»¥ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼æˆ‘ä»¬ç§°ä¹‹ä¸ºé‡åŒ–æ­¥é•¿ï¼Œä¹Ÿå°±æ˜¯ QStepï¼ˆQStep æ˜¯ç¼–ç å™¨å†…éƒ¨çš„æ¦‚å¿µï¼Œç”¨æˆ·ä¸€èˆ¬ä½¿ç”¨é‡åŒ–å‚æ•° QP è¿™ä¸ªå€¼ï¼ŒQP å’Œ QStep ä¸€ä¸€å¯¹åº”ï¼‰ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯é‡åŒ–åçš„ç³»æ•°ã€‚QStep è¶Šå¤§ï¼Œå¾—åˆ°é‡åŒ–åçš„ç³»æ•°å°±ä¼šè¶Šå°ã€‚åŒæ—¶ï¼Œç›¸åŒçš„ QStep å€¼ï¼Œé«˜é¢‘ç³»æ•°å€¼ç›¸æ¯”ä½é¢‘ç³»æ•°å€¼æ›´å°ï¼Œé‡åŒ–åå°±æ›´å®¹æ˜“å˜æˆ 0ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å¤§éƒ¨åˆ†é«˜é¢‘ç³»æ•°å˜æˆ 0ã€‚</p>
<p>QP å€¼è¶Šå¤§ï¼ŒæŸå¤±å°±è¶Šå¤§ï¼Œä»è€Œç”»é¢çš„æ¸…æ™°åº¦å°±ä¼šè¶Šä½ã€‚åŒæ—¶ï¼ŒQP å€¼è¶Šå¤§ç³»æ•°è¢«é‡åŒ–æˆ 0 çš„æ¦‚ç‡å°±è¶Šå¤§ï¼Œè¿™æ ·ç¼–ç ä¹‹åç æµå¤§å°å°±ä¼šè¶Šå°ï¼Œå‹ç¼©å°±ä¼šè¶Šé«˜ã€‚</p>
<p><img src="cs/../images/video-process/dct-quantize.webp" alt="ä½™å¼¦å˜æ¢ä¸é‡åŒ–" /></p>
<h2 id="ç æµç»“æ„-h264"><a class="header" href="#ç æµç»“æ„-h264">ç æµç»“æ„ (H264)</a></h2>
<h3 id="å¸§ç±»å‹"><a class="header" href="#å¸§ç±»å‹">å¸§ç±»å‹</a></h3>
<div class="table-wrapper"><table><thead><tr><th></th><th>å¸§ç±»å‹</th><th>é¢„æµ‹æ–¹å¼</th><th>å‚è€ƒå¸§</th><th>ä¼˜ç¼ºç‚¹</th></tr></thead><tbody>
<tr><td>I å¸§</td><td>å¸§å†…ç¼–ç å¸§</td><td>åªè¿›è¡Œå¸§å†…é¢„æµ‹</td><td>æ— </td><td>è‡ªèº«èƒ½ç‹¬ç«‹å®Œæˆç¼–ç è§£ç ï¼Œå‹ç¼©ç‡å°</td></tr>
<tr><td>P å¸§</td><td>å‰å‘ç¼–ç å¸§</td><td>å¯ä»¥è¿›è¡Œå¸§å†…é¢„æµ‹å’Œå¸§é—´é¢„æµ‹</td><td>å‰é¢çš„ I å¸§å’Œ P å¸§</td><td>å‹ç¼©ç‡æ¯” I å¸§é«˜ï¼Œå¿…é¡»è¦å‚è€ƒå¸§æ‰èƒ½æ­£ç¡®ç¼–è§£ç </td></tr>
<tr><td>B å¸§</td><td>åŒå‘ç¼–ç å¸§</td><td>å¯ä»¥è¿›è¡Œå¸§å†…é¢„æµ‹å’Œå¸§é—´é¢„æµ‹</td><td>å‰é¢æˆ–è€…åé¢çš„ I å¸§å’Œ P å¸§</td><td>å‹ç¼©ç‡æœ€é«˜ï¼Œéœ€è¦ç¼“å­˜å¸§ï¼Œå»¶æ—¶é«˜ï¼ŒRTC åœºæ™¯ä¸é€‚åˆ</td></tr>
</tbody></table>
</div>
<p><img src="cs/../images/video-process/frames-in-order.webp" alt="ä¸‰ç§å¸§çš„ç¤ºä¾‹å›¾" /></p>
<p>ä¸ºäº†é˜²æ­¢æŸä¸ªå‚è€ƒå¸§å‡ºé”™è€Œå¯¼è‡´é”™è¯¯çš„ä¸æ–­ä¼ é€’ï¼ŒH264 è§„å®šäº†ä¸€ä¸ªç‰¹æ®Šçš„ I å¸§å« <strong>IDR</strong>å¸§ï¼Œä¹Ÿå«ç«‹å³åˆ·æ–°å¸§ã€‚<strong>IDR å¸§ä¹‹åçš„å¸§ä¸èƒ½å†å‚è€ƒ IDR å¸§ä¹‹å‰çš„å¸§</strong>ã€‚</p>
<h3 id="è§†é¢‘å›¾åƒçš„åºåˆ—ç»“æ„"><a class="header" href="#è§†é¢‘å›¾åƒçš„åºåˆ—ç»“æ„">è§†é¢‘å›¾åƒçš„åºåˆ—ç»“æ„</a></h3>
<p>ä»ä¸€ä¸ª IDR å¸§å¼€å§‹åˆ°ä¸‹ä¸€ä¸ª IDR å¸§çš„å‰ä¸€å¸§ä¸ºæ­¢ï¼Œè¿™é‡Œé¢åŒ…å«çš„ IDR å¸§ã€æ™®é€š I å¸§ã€P å¸§å’Œ B å¸§ï¼Œæˆ‘ä»¬ç§°ä¸ºä¸€ä¸ª GOP (Group of Pictures) å›¾åƒç»„ã€‚</p>
<p><img src="cs/../images/video-process/group-of-pictures.webp" alt="GOP" /></p>
<p>GOP è¶Šå¤§ï¼Œç¼–ç çš„ I å¸§å°±è¶Šå°‘ï¼Œç›¸æ¯”è€Œè¨€ï¼ŒPå¸§å’ŒBå¸§çš„å‹ç¼©ç‡æ›´é«˜ï¼Œå› æ­¤æ•´ä¸ªè§†é¢‘çš„ç¼–ç æ•ˆç‡è¶Šé«˜ã€‚ä½†æ˜¯ GOP å¤ªå¤§ï¼Œä¼šå¯¼è‡´ IDR å¸§è·ç¦»å¤ªå¤§ï¼Œç‚¹æ’­åœºæ™¯æ—¶è¿›è¡Œè§†é¢‘çš„ seek æ“ä½œä¸æ–¹ä¾¿ã€‚å¹¶ä¸”ï¼Œåœ¨ RTC å’Œç›´æ’­åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› å¯¼è‡´ä¸¢åŒ…è€Œå¼•èµ·æ¥æ”¶ç«¯çš„ä¸¢å¸§ï¼Œå¤§çš„ GOP æœ€ç»ˆå¯èƒ½å¯¼è‡´å‚è€ƒå¸§ä¸¢å¤±è€Œå‡ºç°è§£ç é”™è¯¯ï¼Œä»è€Œå¼•èµ·é•¿æ—¶é—´èŠ±å±å’Œå¡é¡¿ã€‚</p>
<h3 id="å›¾åƒå†…éƒ¨çš„å±‚æ¬¡ç»“æ„"><a class="header" href="#å›¾åƒå†…éƒ¨çš„å±‚æ¬¡ç»“æ„">å›¾åƒå†…éƒ¨çš„å±‚æ¬¡ç»“æ„</a></h3>
<p><strong>Slice å…¶å®æ˜¯ä¸ºäº†å¹¶è¡Œç¼–ç è®¾è®¡çš„</strong>ã€‚å°†ä¸€å¸§å›¾åƒåˆ’åˆ†æˆå‡ ä¸ª Sliceï¼Œå¹¶ä¸” Slice ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€äº’ä¸ä¾èµ–ã€ç‹¬ç«‹ç¼–ç ã€‚å¹¶è¡Œå¯¹å¤šä¸ª Slice è¿›è¡Œç¼–ç å¯ä»¥æå‡é€Ÿåº¦ï¼Œä½†æ˜¯å¸§å†…é¢„æµ‹ä¸èƒ½è·¨ Slice è¿›è¡Œï¼Œå› æ­¤ç¼–ç æ€§èƒ½ä¼šå·®ä¸€äº›ã€‚ä¸€ä¸ª Slice ä¼šåŒ…å«æ•´æ•°ä¸ªå®å—ã€‚åœ¨åšå¸§å†…å’Œå¸§é—´é¢„æµ‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¯ä»¥å°†å®å—ç»§ç»­åˆ’åˆ†æˆä¸åŒå¤§å°çš„å­å—ï¼Œç”¨æ¥ç»™å¤æ‚åŒºåŸŸåšç²¾ç»†åŒ–ç¼–ç ã€‚</p>
<p><img src="cs/../images/video-process/slice.webp" alt="Slice" /></p>
<h3 id="ç æµæ ¼å¼"><a class="header" href="#ç æµæ ¼å¼">ç æµæ ¼å¼</a></h3>
<p>H264 ç æµæœ‰ä¸¤ç§æ ¼å¼ï¼šä¸€ç§æ˜¯ <strong>Annexb</strong> æ ¼å¼ï¼›ä¸€ç§æ˜¯ <strong>MP4</strong> æ ¼å¼ã€‚</p>
<p><img src="cs/../images/video-process/annexb.webp" alt="annexb" /></p>
<p>Annexb æ ¼å¼ä½¿ç”¨<strong>èµ·å§‹ç </strong>æ¥è¡¨ç¤ºä¸€ä¸ªç¼–ç æ•°æ®çš„å¼€å§‹ã€‚èµ·å§‹ç æœ¬èº«ä¸æ˜¯å›¾åƒç¼–ç çš„å†…å®¹ï¼Œåªæ˜¯ç”¨æ¥åˆ†éš”ç”¨çš„ã€‚</p>
<p><img src="cs/../images/video-process/mp4.webp" alt="mp4" /></p>
<p>MP4 æ ¼å¼åœ¨å›¾åƒç¼–ç æ•°æ®çš„å¼€å§‹ä½¿ç”¨äº† 4 ä¸ªå­—èŠ‚ä½œä¸ºé•¿åº¦æ ‡è¯†ï¼Œç”¨æ¥è¡¨ç¤ºç¼–ç æ•°æ®çš„é•¿åº¦ã€‚</p>
<h3 id="nalu-ç½‘ç»œæŠ½è±¡å±‚å•å…ƒ"><a class="header" href="#nalu-ç½‘ç»œæŠ½è±¡å±‚å•å…ƒ">NALU (ç½‘ç»œæŠ½è±¡å±‚å•å…ƒ)</a></h3>
<p>ç¼–ç æ•°æ®ä¸­é™¤äº†å›¾åƒæ•°æ®ï¼Œè¿˜æœ‰ä¸€äº›ç¼–ç å‚æ•°æ•°æ®ï¼Œä¸ºäº†èƒ½å¤Ÿå°†ä¸€äº›é€šç”¨çš„ç¼–ç å‚æ•°æå–å‡ºæ¥ï¼Œä¸åœ¨å›¾åƒç¼–ç æ•°æ®ä¸­é‡å¤ï¼ŒH264 è®¾è®¡äº†<strong>ä¸¤ä¸ªé‡è¦çš„å‚æ•°é›†ï¼šä¸€ä¸ªæ˜¯ SPSï¼ˆåºåˆ—å‚æ•°é›†ï¼‰ï¼›ä¸€ä¸ªæ˜¯ PPSï¼ˆå›¾åƒå‚æ•°é›†ï¼‰</strong>ã€‚</p>
<p>SPS ä¸»è¦åŒ…å«çš„æ˜¯å›¾åƒçš„å®½ã€é«˜ã€YUV æ ¼å¼å’Œä½æ·±ç­‰åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p>PPS ä¸»è¦åŒ…å«ç†µç¼–ç ç±»å‹ã€åŸºç¡€ QP å’Œæœ€å¤§å‚è€ƒå¸§æ•°é‡ç­‰åŸºæœ¬ç¼–ç ä¿¡æ¯ã€‚</p>
<p><strong>H264 çš„ç æµä¸»è¦æ˜¯ç”± SPSã€PPSã€I Sliceã€P Sliceå’ŒB Slice ç»„æˆçš„</strong>ã€‚</p>
<p><img src="cs/../images/video-process/nalu.webp" alt="H264ç æµç»„æˆ" /></p>
<p>SPS æ˜¯ä¸€ä¸ª NALUã€PPS æ˜¯ä¸€ä¸ª NALUã€æ¯ä¸€ä¸ª Slice ä¹Ÿæ˜¯ä¸€ä¸ª NALUã€‚æ¯ä¸€ä¸ª NALU åˆéƒ½æ˜¯ç”±ä¸€ä¸ª 1 å­—èŠ‚çš„ NALU Header å’Œè‹¥å¹²å­—èŠ‚çš„ NALU Data ç»„æˆçš„ã€‚è€Œå¯¹äºæ¯ä¸€ä¸ª Slice NALUï¼Œå…¶ NALU Data åˆæ˜¯ç”± Slice Header å’Œ Slice Data ç»„æˆï¼Œå¹¶ä¸” Slice Data åˆæ˜¯ç”±ä¸€ä¸ªä¸ª MB Data ç»„æˆã€‚</p>
<h4 id="nalu-header"><a class="header" href="#nalu-header">NALU Header</a></h4>
<p><img src="cs/../images/video-process/nalu-header.webp" alt="NALU Header" /></p>
<ul>
<li>F: ç¦æ­¢ä½ï¼ŒH264 ç æµå¿…é¡»ä¸º 0</li>
<li>NRIï¼š nal_ref_idcï¼Œè¡¨ç¤ºå½“å‰ NALU çš„é‡è¦æ€§ã€‚å‚è€ƒå¸§ã€SPS å’Œ PPS å¯¹åº”çš„ NALU å¿…é¡»è¦å¤§äº 0</li>
<li>Typeï¼š nal_unit_typeï¼Œè¡¨ç¤º NALU çš„ç±»å‹</li>
</ul>
<p>NALU ç±»å‹è¡¨æ ¼ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>NALU ç±»å‹</th><th>æè¿°</th></tr></thead><tbody>
<tr><td>0</td><td>æœªä½¿ç”¨</td></tr>
<tr><td>1</td><td>é IDR å›¾åƒä¸­çš„ Slice</td></tr>
<tr><td>2</td><td>ç‰‡åˆ†åŒº A</td></tr>
<tr><td>3</td><td>ç‰‡åˆ†åŒº B</td></tr>
<tr><td>4</td><td>ç‰‡åˆ†åŒº C</td></tr>
<tr><td>5</td><td>IDR å›¾åƒä¸­çš„ Slice</td></tr>
<tr><td>6</td><td>è¡¥å……å¢å¼ºä¿¡æ¯å•å…ƒ SEI</td></tr>
<tr><td>7</td><td>åºåˆ—å‚æ•°é›† SPS</td></tr>
<tr><td>8</td><td>å›¾åƒå‚æ•°é›† PPS</td></tr>
<tr><td>9</td><td>åˆ†è§£ç¬¦</td></tr>
<tr><td>10</td><td>åºåˆ—ç»“æŸ</td></tr>
<tr><td>11</td><td>ç æµç»“æŸ</td></tr>
<tr><td>12</td><td>å¡«å……</td></tr>
<tr><td>13...23</td><td>ä¿ç•™</td></tr>
<tr><td>24...31</td><td>æœªä½¿ç”¨</td></tr>
</tbody></table>
</div>
<p>NALU ç±»å‹åªåŒºåˆ†äº† IDR Slice å’Œé IDR Sliceï¼Œè‡³äºé IDR Slice æ˜¯æ™®é€š I Sliceã€P Slice è¿˜æ˜¯ B Sliceï¼Œåˆ™éœ€è¦ç»§ç»­è§£æ Slice Header ä¸­çš„ Slice Type å­—æ®µå¾—åˆ°ã€‚</p>
<h3 id="å¦‚ä½•ä»ç æµä¸­åˆ¤æ–­å“ªå‡ ä¸ª-slice-æ˜¯åŒä¸€å¸§çš„"><a class="header" href="#å¦‚ä½•ä»ç æµä¸­åˆ¤æ–­å“ªå‡ ä¸ª-slice-æ˜¯åŒä¸€å¸§çš„">å¦‚ä½•ä»ç æµä¸­åˆ¤æ–­å“ªå‡ ä¸ª Slice æ˜¯åŒä¸€å¸§çš„</a></h3>
<p>H264 ç æµä¸­æ²¡æœ‰å­—æ®µè¡¨ç¤ºä¸€å¸§åŒ…å«å‡ ä¸ª Sliceï¼Œä½†æ˜¯ Slice Header ä¸­æœ‰ä¸€ä¸ª <strong>first_mb_in_slice</strong> çš„å­—æ®µï¼Œè¡¨ç¤ºå½“å‰ Slice çš„ç¬¬ä¸€ä¸ªå®å—åœ¨å½“å‰ç¼–ç å›¾åƒä¸­çš„åºå·ã€‚å¦‚æœ first_mb_in_slice çš„å€¼ç­‰äº 0ï¼Œå°±ä»£è¡¨äº†å½“å‰ Slice çš„ç¬¬ä¸€ä¸ªå®å—æ˜¯ä¸€å¸§çš„ç¬¬ä¸€ä¸ªå®å—ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰ Slice å°±æ˜¯ä¸€å¸§çš„ç¬¬ä¸€ä¸ª Sliceã€‚first_mb_in_slice æ˜¯ä»¥<strong>æ— ç¬¦å·æŒ‡æ•°å“¥ä¼¦å¸ƒ</strong>ç¼–ç çš„ï¼Œéœ€è¦ä½¿ç”¨å¯¹åº”çš„è§£ç æ–¹å¼æ‰èƒ½è§£ç å‡ºæ¥ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå¦‚æœ <strong>slice_header[0] &amp; 0x80 == 1</strong>ï¼Œ åˆ™first_mb_in_slice ç­‰äº 0ã€‚</p>
<h3 id="å¦‚ä½•ä»ç æµä¸­è·å–-qp-å€¼"><a class="header" href="#å¦‚ä½•ä»ç æµä¸­è·å–-qp-å€¼">å¦‚ä½•ä»ç æµä¸­è·å– QP å€¼</a></h3>
<p>åœ¨ PPS ä¸­æœ‰ä¸€ä¸ªå…¨å±€åŸºç¡€ QPï¼Œå­—æ®µæ˜¯ pic_init_qp_minus26ã€‚å½“å‰åºåˆ—ä¸­æ‰€æœ‰ä¾èµ–è¯¥ PPS çš„ Slice å…±ç”¨è¿™ä¸ªåŸºç¡€ QPï¼Œä¸”æ¯ä¸€ä¸ª Slice åœ¨è¿™ä¸ªåŸºç¡€ QP çš„åŸºç¡€ä¸Šåšè°ƒæ•´ã€‚åœ¨ Slice Header ä¸­æœ‰ä¸€ä¸ª slice_qp_delta å­—æ®µæ¥æè¿°è¿™ä¸ªè°ƒæ•´åç§»å€¼ã€‚æ›´è¿›ä¸€æ­¥ï¼ŒH264 å…è®¸åœ¨å®å—çº§åˆ«å¯¹ QP åšæ›´è¿›ä¸€æ­¥çš„ç²¾ç»†åŒ–è°ƒèŠ‚ã€‚è¿™ä¸ªå­—æ®µåœ¨å®å—æ•°æ®é‡Œé¢ï¼Œå«åš mb_qp_deltaã€‚</p>
<h3 id="ä½¿ç”¨-ffmpeg-ä»è§†é¢‘æ–‡ä»¶ä¸­æå–-h264-ç æµ"><a class="header" href="#ä½¿ç”¨-ffmpeg-ä»è§†é¢‘æ–‡ä»¶ä¸­æå–-h264-ç æµ">ä½¿ç”¨ ffmpeg ä»è§†é¢‘æ–‡ä»¶ä¸­æå– H264 ç æµ</a></h3>
<pre><code class="language-bash">ffmpeg -i input.mp4 -c:v copy -bsf:v h264_mp4toannexb -an output.h264
</code></pre>
<h2 id="ä¸åŒçš„ç¼–ç å™¨æ ‡å‡†æ¯”è¾ƒ"><a class="header" href="#ä¸åŒçš„ç¼–ç å™¨æ ‡å‡†æ¯”è¾ƒ">ä¸åŒçš„ç¼–ç å™¨æ ‡å‡†æ¯”è¾ƒ</a></h2>
<p><img src="cs/../images/video-process/various-video-encoders.webp" alt="å¯¹æ¯”ä¸åŒçš„ç¼–ç å™¨æ ‡å‡†" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usb-åŸºç¡€"><a class="header" href="#usb-åŸºç¡€">USB åŸºç¡€</a></h1>
<h2 id="usb-åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#usb-åŸºæœ¬æ¦‚å¿µ">USB åŸºæœ¬æ¦‚å¿µ</a></h2>
<h3 id="usb-åè®®æ ‡å‡†"><a class="header" href="#usb-åè®®æ ‡å‡†">USB åè®®æ ‡å‡†</a></h3>
<div class="table-wrapper"><table><thead><tr><th>USB åè®®æ ‡å‡†</th><th>ä¸»è¦ç‰¹ç‚¹</th><th>é€Ÿåº¦ç­‰çº§</th></tr></thead><tbody>
<tr><td>USB 2.0 Full Speed<br />ï¼ˆæ—§ç§° USB 1.1ï¼‰</td><td>è§„èŒƒäº† USB ä½å…¨é€Ÿä¼ è¾“</td><td>1.5 Mbps~12 Mbps</td></tr>
<tr><td>USB 2.0 High Speed<br />ï¼ˆæ—§ç§° USB 2.0ï¼‰</td><td>è§„èŒƒäº† USB é«˜é€Ÿä¼ è¾“</td><td>480 Mbps</td></tr>
<tr><td>USB 3.2 gen1<br />ï¼ˆæ—§ç§° USB 3.0ï¼‰</td><td>é‡‡ç”¨ 8b/10b ç¼–ç ï¼Œå¢åŠ ä¸€å¯¹è¶…é«˜é€Ÿå·®åˆ†çº¿ï¼Œä¾›ç”µ 5V/0.9A</td><td>5 Gbps</td></tr>
<tr><td>USB 3.2 gen2<br />ï¼ˆæ—§ç§° USB 3.1ï¼‰</td><td>é‡‡ç”¨ 128b/132b ç¼–ç ï¼Œé€Ÿåº¦æé«˜ 1 å€ï¼Œä¾›ç”µ 20V/5Aï¼ŒåŒæ—¶å¢åŠ äº† A/V å½±éŸ³ä¼ è¾“æ ‡å‡†</td><td>10 Gbps</td></tr>
<tr><td>USB 3.2 gen2*2<br />ï¼ˆæ—§ç§° USB 3.2ï¼‰</td><td>å¢åŠ ä¸€å¯¹è¶…é«˜é€Ÿä¼ è¾“é€šé“ï¼Œé€Ÿåº¦å†æ¬¡ç¿»å€ï¼Œåªèƒ½åœ¨ C å‹æ¥å£ä¸Šè¿è¡Œ</td><td>20 Gbps</td></tr>
</tbody></table>
</div>
<h3 id="é€šè®¯æ¥å£"><a class="header" href="#é€šè®¯æ¥å£">é€šè®¯æ¥å£</a></h3>
<p><img src="ee/../images/usb/USB_slot_interface.png" alt="USB é€šè®¯æ¥å£" /></p>
<h3 id="ç¼–ç æ–¹å¼"><a class="header" href="#ç¼–ç æ–¹å¼">ç¼–ç æ–¹å¼</a></h3>
<p><img src="ee/../images/usb/USB_encoding.png" alt="USB ç¼–ç æ–¹å¼" /></p>
<p>è¿™ç§ç¼–ç æ–¹å¼ä¹Ÿç§°ä¸º<strong>åå‘ä¸å½’é›¶ç¼–ç ï¼ˆNRZIï¼‰</strong></p>
<p><strong>ä½å¡«å……</strong>ï¼šåœ¨æ•°æ®è¿›è¡Œ NRZI ç¼–ç å‰ï¼Œæ¯ 6 ä¸ªè¿ç»­çš„ <strong>1</strong> ä¿¡å·ä¹‹åéƒ½ä¼šæ’å…¥ 1 ä¸ª <strong>0</strong> ä¿¡å·ï¼Œä»¥é¿å…é•¿æ—¶é—´ç”µå¹³ä¿æŒä¸å˜å¸¦æ¥çš„åŒæ­¥æ¼‚ç§»ã€‚</p>
<h3 id="ä¿¡å·ä¼ è¾“çŠ¶æ€"><a class="header" href="#ä¿¡å·ä¼ è¾“çŠ¶æ€">ä¿¡å·ä¼ è¾“çŠ¶æ€</a></h3>
<p><img src="ee/../images/usb/USB_signal_state.png" alt="USB ä¿¡å·ä¼ è¾“çŠ¶æ€" /></p>
<h3 id="å¸§"><a class="header" href="#å¸§">å¸§</a></h3>
<p>å¸§æ˜¯ä¸€ä¸ªæ—¶é—´å•ä½ï¼Œå›ºå®šä¸º<strong>1ms</strong>ï¼ˆä½/å…¨é€Ÿï¼‰ï¼Œé«˜é€Ÿ-å¾®å¸§ä¸º <strong>125us</strong></p>
<h3 id="é€šè®¯è¿‡ç¨‹åˆ’åˆ†"><a class="header" href="#é€šè®¯è¿‡ç¨‹åˆ’åˆ†">é€šè®¯è¿‡ç¨‹åˆ’åˆ†</a></h3>
<p><img src="ee/../images/usb/USB_field_package_transaction_transfer.png" alt="USB é€šè®¯è¿‡ç¨‹åˆ’åˆ†" /></p>
<p><strong>äº‹åŠ¡</strong>æ˜¯æœ€åŸºæœ¬çš„ä¼ è¾“å•ä½ã€‚</p>
<h3 id="å››ç§ä¼ è¾“"><a class="header" href="#å››ç§ä¼ è¾“">å››ç§ä¼ è¾“</a></h3>
<p>::: tip æ§åˆ¶ä¼ è¾“
ä¸»æœºè·å–è®¾å¤‡ä¿¡æ¯ã€çŠ¶æ€ï¼Œé€‰æ‹©è®¾å¤‡é…ç½®ç­‰ä¸€ç³»åˆ—å‘½ä»¤å¼å·¥ä½œã€‚
:::</p>
<p>::: tip ä¸­æ–­ä¼ è¾“</p>
<p>æ”¶å‘æ•°æ®é‡å°‘ã€å‘¨æœŸæ€§ä¼ è¾“ã€‚</p>
<p>:::</p>
<p>::: tip æ‰¹é‡ä¼ è¾“</p>
<p>åˆ©ç”¨ä»»ä½•å¯è·å¾—çš„æ€»çº¿å¸¦å®½è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p>
<p>:::</p>
<p>::: tip ç­‰æ—¶ä¼ è¾“</p>
<p>æ’å®šé€Ÿç‡ã€æ²¡æœ‰å·®é”™æ§åˆ¶çš„ä¼ è¾“ã€‚</p>
<p>:::</p>
<h3 id="å…¶ä»–æœ¯è¯­"><a class="header" href="#å…¶ä»–æœ¯è¯­">å…¶ä»–æœ¯è¯­</a></h3>
<h4 id="ä¸Šä¼ ä¸‹ä¼ "><a class="header" href="#ä¸Šä¼ ä¸‹ä¼ ">ä¸Šä¼ /ä¸‹ä¼ </a></h4>
<p>USB ä¸»æœºæ¥æ”¶ USB è®¾å¤‡çš„æ•°æ®ç§°ä¸ºä¸Šä¼ ï¼ŒUSB ä¸»æœºå‘é€æ•°æ®ç»™ USB è®¾å¤‡ç§°ä¸ºä¸‹ä¼ ã€‚</p>
<h4 id="åœ°å€"><a class="header" href="#åœ°å€">åœ°å€</a></h4>
<p>ä¸»æœºç®¡ç†è®¾å¤‡ï¼Œè€Œä¸ºæ¯ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡åˆ†é…ä¸€ä¸ªåœ°å€ï¼Œä¸»æœºæœ€å¤šå¯ä»¥åˆ†é… 127 ä¸ªåœ°å€ã€‚</p>
<h4 id="ç«¯ç‚¹"><a class="header" href="#ç«¯ç‚¹">ç«¯ç‚¹</a></h4>
<p>USB è®¾å¤‡ä¸­å®é™…çš„ç‰©ç†å•å…ƒï¼Œç«¯ç‚¹å’Œåœ°å€å†³å®šäº†ä¸»æœºå’Œè®¾å¤‡ä¹‹é—´é€šè®¯çš„ç‰©ç†é€šé“ã€‚</p>
<h4 id="usb-ä¼ è¾“ç‰¹ç‚¹"><a class="header" href="#usb-ä¼ è¾“ç‰¹ç‚¹">USB ä¼ è¾“ç‰¹ç‚¹</a></h4>
<p>ç‰©ç†ä¼ è¾“åŒæ–¹è§’è‰²ä¸€å®šæ˜¯ä¸»æœºå’Œè®¾å¤‡ï¼Œä¸€é—®ä¸€ç­”ä¼ è¾“æ–¹å¼ï¼Œæ°¸è¿œæ˜¯ä¸»æœºå…ˆå‘èµ·åŒ…è¯·æ±‚ã€‚</p>
<h2 id="ä¸»è®¾å¤‡å’Œä»è®¾å¤‡"><a class="header" href="#ä¸»è®¾å¤‡å’Œä»è®¾å¤‡">ä¸»è®¾å¤‡å’Œä»è®¾å¤‡</a></h2>
<h3 id="ä¸»è®¾å¤‡"><a class="header" href="#ä¸»è®¾å¤‡">ä¸»è®¾å¤‡</a></h3>
<ul>
<li>æ£€æµ‹ USB è®¾å¤‡çš„æ’æ‹”åŠ¨ä½œ</li>
<li>ç®¡ç†ä¸»ä»é€šè®¯ä¹‹é—´çš„æ§åˆ¶æµ</li>
<li>ç®¡ç†ä¸»ä»é€šè®¯ä¹‹é—´çš„æ•°æ®æµ</li>
<li>è®°å½•ä¸»æœºçŠ¶æ€å’Œè®¾å¤‡åŠ¨ä½œä¿¡æ¯</li>
<li>æ§åˆ¶ä¸»æ§åˆ¶å™¨å’Œ USB è®¾å¤‡é—´çš„ç”µæ°”æ¥å£</li>
</ul>
<h3 id="é›†çº¿å™¨"><a class="header" href="#é›†çº¿å™¨">é›†çº¿å™¨</a></h3>
<ul>
<li>æ‰©å±• USB ä¸»æœºå’Œ USB ç«¯å£</li>
<li>ç»“æ„ä¸Šæœ‰ä¸€ä¸ªä¸Šè¡Œç«¯å£ï¼Œå¤šä¸ªä¸‹è¡Œç«¯å£</li>
<li>æ”¯æŒçº§è”ï¼Œç³»ç»Ÿä¸­æœ€å¤š 5 ä¸ªé›†çº¿å™¨ï¼ˆä¸åŒ…æ‹¬ä¸»æœºçš„æ ¹é›†çº¿å™¨ï¼‰</li>
<li>æ”¯æŒé€Ÿåº¦åˆ‡æ¢</li>
</ul>
<h3 id="åŠŸèƒ½è®¾å¤‡"><a class="header" href="#åŠŸèƒ½è®¾å¤‡">åŠŸèƒ½è®¾å¤‡</a></h3>
<ul>
<li>ä¸€ä¸ªç‹¬ç«‹çš„å¤–å›´è®¾å¤‡ï¼Œå¯ä»¥æ˜¯å•ä¸€åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šåŠŸèƒ½çš„åˆæˆè®¾å¤‡</li>
<li>å†…éƒ¨åŒ…å«æœ‰æè¿°è‡ªèº«åŠŸèƒ½å’Œèµ„æºéœ€æ±‚çš„é…ç½®ä¿¡æ¯</li>
</ul>
<p><img src="ee/../images/usb/USB_device_structure.png" alt="USB è®¾å¤‡ç»“æ„å›¾" /></p>
<h2 id="usb-ç³»ç»Ÿåˆ†å±‚"><a class="header" href="#usb-ç³»ç»Ÿåˆ†å±‚">USB ç³»ç»Ÿåˆ†å±‚</a></h2>
<p><img src="ee/../images/usb/USB_system_tier.png" alt="USB ç³»ç»Ÿåˆ†å±‚" /></p>
<h2 id="è¿æ¥ä¸æ£€æµ‹"><a class="header" href="#è¿æ¥ä¸æ£€æµ‹">è¿æ¥ä¸æ£€æµ‹</a></h2>
<p><img src="ee/../images/usb/USB_connection_detection.png" alt="USB è¿æ¥æ£€æµ‹" /></p>
<p><img src="ee/../images/usb/USB_fs_device_connection.png" alt="USB å…¨é€Ÿè®¾å¤‡è¿æ¥" /></p>
<p><img src="ee/../images/usb/USB_hs_device_connection.png" alt="USB é«˜é€Ÿè®¾å¤‡è¿æ¥" /></p>
<h3 id="æ€»çº¿çš„çŠ¶æ€"><a class="header" href="#æ€»çº¿çš„çŠ¶æ€">æ€»çº¿çš„çŠ¶æ€</a></h3>
<div class="table-wrapper"><table><thead><tr><th>å¸¸è§çš„æ€»çº¿çŠ¶æ€</th><th>æè¿°</th></tr></thead><tbody>
<tr><td>æ­£å¸¸å·¥ä½œ</td><td>æ€»çº¿ä¸Šå­˜åœ¨å‘¨æœŸæ€§ SOF åŒ…</td></tr>
<tr><td>æ€»çº¿å¤ä½</td><td>æ€»çº¿ç»´æŒ SE0 çŠ¶æ€  &gt; 10ms</td></tr>
<tr><td>æ€»çº¿æŒ‚èµ·</td><td>æ€»çº¿æ— æ´»åŠ¨ &gt; 3ms</td></tr>
</tbody></table>
</div><div class="table-wrapper"><table><thead><tr><th>å¸¸è§çš„å‡ ç§å˜åŒ–</th><th>è§¦å‘ç‚¹</th></tr></thead><tbody>
<tr><td>æ— è¿æ¥ -&gt; è¿æ¥</td><td>D+/D- ä¸Šå‡ºç°é«˜ç”µå¹³ &gt; 2ms</td></tr>
<tr><td>æ­£å¸¸ -&gt; æŒ‚èµ·</td><td>J çŠ¶æ€ä¿æŒ &gt; 3ms</td></tr>
<tr><td>æŒ‚èµ· -&gt; æ­£å¸¸ï¼ˆå”¤é†’ï¼‰</td><td>å‡ºç° K çŠ¶æ€ä¿¡å·å¹¶æŒç»­ä¸€æ®µæ—¶é—´</td></tr>
</tbody></table>
</div>
<h2 id="æšä¸¾"><a class="header" href="#æšä¸¾">æšä¸¾</a></h2>
<p>:::tip æšä¸¾çš„å®šä¹‰</p>
<p>USB ä¸»è®¾å¤‡å‘ USB ä»è®¾å¤‡é€šè¿‡è·å–å„ç§æè¿°ç¬¦ï¼Œä»è€Œäº†è§£è®¾å¤‡å±æ€§ï¼ŒçŸ¥é“æ˜¯ä»€ä¹ˆæ ·çš„è®¾å¤‡ï¼Œå¹¶åŠ è½½å¯¹åº”çš„ USB ç±»ã€åŠŸèƒ½é©±åŠ¨ç¨‹åºï¼Œç„¶åè¿›è¡Œåç»­ä¸€ç³»åˆ—çš„æ•°æ®é€šä¿¡ã€‚</p>
<p>:::</p>
<ul>
<li>ä¸»è®¾å¤‡è¿æ¥è¯†åˆ«ä»è®¾å¤‡å¿…é¡»çš„è¿‡ç¨‹</li>
<li>ç”±å¤šä¸ªæ§åˆ¶ä¼ è¾“æ„æˆ</li>
<li>ç»è¿‡åœ°å€0 ï¼ˆç¼ºçœåœ°å€ï¼‰åˆ°å…¶ä»–åœ°å€ï¼ˆä¸»è®¾å¤‡åˆ†é…åœ°å€ï¼‰çš„é€šè®¯</li>
<li>å¯¹äºæŒ‚è½½å¤šä¸ª USB ä»è®¾å¤‡çš„ç³»ç»Ÿï¼Œä¸»è®¾å¤‡æ˜¯é€ä¸€è¿›è¡Œæšä¸¾æ“ä½œ</li>
</ul>
<p><img src="ee/../images/usb/USB_enumeration.png" alt="USB æšä¸¾" /></p>
<h3 id="è®¾å¤‡æè¿°ç¬¦"><a class="header" href="#è®¾å¤‡æè¿°ç¬¦">è®¾å¤‡æè¿°ç¬¦</a></h3>
<p>ç¬¬ä¸€ä¸ªéœ€è¦è·å–çš„æè¿°ç¬¦ï¼Œé•¿åº¦å›ºå®š 18 å­—èŠ‚ã€‚</p>
<h3 id="é…ç½®æè¿°ç¬¦"><a class="header" href="#é…ç½®æè¿°ç¬¦">é…ç½®æè¿°ç¬¦</a></h3>
<p>æè¿°äº†è®¾å¤‡ç‰¹å®šçš„é…ç½®ï¼Œæä¾›äº†å½“å‰é…ç½®ä¸‹è®¾å¤‡çš„åŠŸèƒ½æ¥å£ï¼Œä¾›ç”µæ–¹å¼ï¼Œè€—ç”µç­‰ä¿¡æ¯ã€‚æ˜¯ä¸€ä¸ªé…ç½®çš„é›†åˆï¼Œé›†åˆé•¿åº¦ä¸å›ºå®šï¼ŒåŒ…å«äº†é…ç½®æè¿°ç¬¦ã€æ¥å£æè¿°ç¬¦ã€ç±»å®šä¹‰æè¿°ç¬¦ã€ç«¯ç‚¹æè¿°ç¬¦ã€‚</p>
<h2 id="æ§åˆ¶ä¼ è¾“"><a class="header" href="#æ§åˆ¶ä¼ è¾“">æ§åˆ¶ä¼ è¾“</a></h2>
<p><img src="ee/../images/usb/USB_control_transfer.png" alt="USB æ§åˆ¶ä¼ è¾“" /></p>
<p><img src="ee/../images/usb/USB_control_transfer_transactions.png" alt="USB æ§åˆ¶ä¼ è¾“æ¶‰åŠåˆ°çš„äº‹åŠ¡" /></p>
<h3 id="å»ºç«‹é˜¶æ®µ"><a class="header" href="#å»ºç«‹é˜¶æ®µ">å»ºç«‹é˜¶æ®µ</a></h3>
<p><img src="ee/../images/usb/USB_control_transfer_setup_stage.png" alt="USB æ§åˆ¶ä¼ è¾“å»ºç«‹é˜¶æ®µ" /></p>
<h2 id="usb-é”®ç›˜"><a class="header" href="#usb-é”®ç›˜">USB é”®ç›˜</a></h2>
<p><img src="ee/../images/usb/USB_keyboard_design.png" alt="USB é”®ç›˜è®¾è®¡æ€è·¯" /></p>
<p><img src="ee/../images/usb/USB_keyboard_sw.png" alt="USB è½¯ä»¶è®¾è®¡" /></p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://www.usb.org">USB åä¼šå®˜ç½‘</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="can-åŸºç¡€"><a class="header" href="#can-åŸºç¡€">CAN åŸºç¡€</a></h1>
<h2 id="æ‹“æ‰‘ç»“æ„"><a class="header" href="#æ‹“æ‰‘ç»“æ„">æ‹“æ‰‘ç»“æ„</a></h2>
<p><img src="ee/../images/can/can-topology.png" alt="CAN æ‹“æ‰‘ç»“æ„" /></p>
<p>CANæ€»çº¿æœ‰ä¸¤ä¸ª ISO å›½é™…æ ‡å‡†ï¼šISO11898 å’Œ ISO11519ã€‚</p>
<ul>
<li>ISO11898 å®šä¹‰äº†é€šä¿¡é€Ÿç‡ä¸º 125 Kbpsï½1 Mbps çš„é«˜é€Ÿ CAN é€šä¿¡æ ‡å‡†ï¼Œå±äºé—­ç¯æ€»çº¿ï¼Œæ€»çº¿é•¿åº¦ â‰¤ 40 ç±³ã€‚</li>
<li>ISO11519 å®šä¹‰äº†é€šä¿¡é€Ÿç‡ä¸º 10ï½125 Kbps çš„ä½é€Ÿ CAN é€šä¿¡æ ‡å‡†ï¼Œå±äºå¼€ç¯æ€»çº¿ï¼Œæ€»çº¿é•¿åº¦å¯è¾¾ 1000 ç±³ã€‚</li>
<li>ISO16845 å®šä¹‰äº†è®¤è¯éœ€è¦çš„æµ‹è¯•ç”¨ä¾‹</li>
<li>åœ¨åŒä¸€æ¡æ€»çº¿ä¸Šï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„é€šä¿¡é€Ÿåº¦å¿…é¡»ç›¸åŒï¼›å¦‚æœä¸¤æ¡ä¸åŒé€šä¿¡é€Ÿåº¦çš„æ€»çº¿ä¸Šçš„èŠ‚ç‚¹æƒ³è¦å®ç°ä¿¡æ¯äº¤äº’ï¼Œå¿…é¡»é€šè¿‡ç½‘å…³æˆ–è€…ä¸­ç»§å™¨è½¬å‘ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="ä¿¡å·è¡¨ç¤º"><a class="header" href="#ä¿¡å·è¡¨ç¤º">ä¿¡å·è¡¨ç¤º</a></h2>
<p><img src="ee/../images/can/can-signal.png" alt="CAN ä¿¡å·è¡¨ç¤º" /></p>
<h2 id="é€šä¿¡ç‰¹ç‚¹"><a class="header" href="#é€šä¿¡ç‰¹ç‚¹">é€šä¿¡ç‰¹ç‚¹</a></h2>
<h3 id="å¤šä¸»å¤šä»ç»“æ„"><a class="header" href="#å¤šä¸»å¤šä»ç»“æ„">å¤šä¸»å¤šä»ç»“æ„</a></h3>
<ul>
<li>CAN æ€»çº¿ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹æ²¡æœ‰ä¸»ä»ä¹‹åˆ†ï¼Œåœ¨æ€»çº¿ç©ºé—²çŠ¶æ€ï¼Œä»»æ„èŠ‚ç‚¹éƒ½å¯ä»¥å‘æ€»çº¿ä¸Šå‘é€æ¶ˆæ¯</li>
<li>å½“æ€»çº¿ä¸Šå‡ºç°è¿ç»­çš„ 11 ä½éšå½¢ç”µå¹³ï¼Œé‚£ä¹ˆæ€»çº¿å°±å¤„äºç©ºé—²çŠ¶æ€</li>
<li>æœ€å…ˆå‘æ€»çº¿å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹è·å¾—æ€»çº¿çš„å‘é€æƒï¼Œå½“å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å‘æ€»çº¿å‘é€æ¶ˆæ¯æ—¶ï¼Œæ‰€å‘é€æ¶ˆæ¯çš„ä¼˜å…ˆçº§é«˜çš„é‚£ä¸ªèŠ‚ç‚¹è·å¾—æ€»çº¿çš„å‘é€æƒ</li>
<li>ä¾èµ–äº<strong>ç¡¬ä»¶</strong>çš„éªŒæ”¶æ»¤æ³¢æŠ€æœ¯ï¼ŒCAN æ€»çº¿å¯ä»¥å®ç°ä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šä»¥åŠå¹¿æ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ã€‚</li>
</ul>
<h3 id="éç ´åæ€§ä½ä»²è£æœºåˆ¶"><a class="header" href="#éç ´åæ€§ä½ä»²è£æœºåˆ¶">éç ´åæ€§ä½ä»²è£æœºåˆ¶</a></h3>
<p>å½“å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å‘æ€»çº¿å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯¹å„ä¸ªæ¶ˆæ¯çš„æ ‡è¯†ç¬¦ï¼ˆå³IDå·ï¼‰è¿›è¡Œé€ä½ä»²è£ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹å‘é€çš„æ¶ˆæ¯ä»²è£è·èƒœï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°†è·å–æ€»çº¿çš„å‘é€æƒï¼Œä»²è£å¤±è´¥çš„èŠ‚ç‚¹åˆ™ç«‹å³åœæ­¢å‘é€å¹¶è½¬å˜ä¸ºç›‘å¬ï¼ˆæ¥æ”¶ï¼‰çŠ¶æ€ã€‚</p>
<p>è¿™ç§ä»²è£æœºåˆ¶æ—¢ä¸ä¼šé€ æˆå·²å‘é€æ•°æ®çš„å»¶è¿Ÿï¼Œä¹Ÿä¸ä¼šç ´åå·²ç»å‘é€çš„æ•°æ®ã€‚</p>
<h3 id="æŠ¥æ–‡è¿‡æ»¤"><a class="header" href="#æŠ¥æ–‡è¿‡æ»¤">æŠ¥æ–‡è¿‡æ»¤</a></h3>
<p>CAN æ€»çº¿ä¸­æ²¡æœ‰åœ°å€çš„æ¦‚å¿µï¼ŒCAN æ€»çº¿æ˜¯é€šè¿‡æŠ¥æ–‡ ID æ¥å®ç°æ”¶å‘æ•°æ®çš„ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šæœ‰ä¸€ä¸ªéªŒæ”¶æ»¤æ³¢ ID è¡¨ï¼Œå…¶ä½äº CAN èŠ‚ç‚¹çš„éªŒæ”¶æ»¤æ³¢å™¨ä¸­ï¼Œå¦‚æœæ€»çº¿ä¸Šçš„æŠ¥æ–‡çš„ ID å·åœ¨æŸä¸ªèŠ‚ç‚¹çš„éªŒæ”¶æ»¤æ³¢ ID è¡¨ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸€å¸§æŠ¥æ–‡å°±èƒ½é€šè¿‡è¯¥èŠ‚ç‚¹éªŒæ”¶æ»¤æ³¢å™¨çš„éªŒæ”¶ï¼Œè¯¥èŠ‚ç‚¹å°±ä¼šæ¥æ”¶è¿™ä¸€å¸§æŠ¥æ–‡ã€‚</p>
<h3 id="è¿œç¨‹æ•°æ®è¯·æ±‚"><a class="header" href="#è¿œç¨‹æ•°æ®è¯·æ±‚">è¿œç¨‹æ•°æ®è¯·æ±‚</a></h3>
<p>æŸä¸ªèŠ‚ç‚¹ Node_A å¯ä»¥é€šè¿‡å‘é€<code>é¥æ§å¸§</code>åˆ°æ€»çº¿ä¸Šçš„æ–¹å¼ï¼Œè¯·æ±‚æŸä¸ªèŠ‚ç‚¹ Node_B æ¥å‘é€ç”±è¯¥é¥æ§å¸§æ‰€æŒ‡å®šçš„æŠ¥æ–‡ã€‚</p>
<h3 id="å‡ºé”™å¤„ç†"><a class="header" href="#å‡ºé”™å¤„ç†">å‡ºé”™å¤„ç†</a></h3>
<ul>
<li>æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¯ä»¥æ£€æµ‹å‡ºé”™è¯¯</li>
<li>æ£€æµ‹å‡ºé”™è¯¯çš„èŠ‚ç‚¹ä¼šç«‹å³é€šçŸ¥æ€»çº¿ä¸Šå…¶å®ƒæ‰€æœ‰çš„èŠ‚ç‚¹</li>
<li>æ­£åœ¨å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°é”™è¯¯ï¼Œä¼šç«‹å³åœæ­¢å½“å‰çš„å‘é€ï¼ŒåŒæ—¶ä¸æ–­åœ°é‡å¤å‘é€æ­¤æ¶ˆæ¯ï¼Œç›´åˆ°è¯¥æ¶ˆæ¯å‘é€æˆåŠŸä¸ºæ­¢</li>
</ul>
<h3 id="æ•…éšœå°é—­"><a class="header" href="#æ•…éšœå°é—­">æ•…éšœå°é—­</a></h3>
<p>èŠ‚ç‚¹èƒ½å¤Ÿåˆ¤æ–­é”™è¯¯çš„ç±»å‹ï¼Œåˆ¤æ–­æ˜¯æš‚æ—¶æ€§çš„æ•°æ®é”™è¯¯ï¼ˆå¦‚å™ªå£°å¹²æ‰°ï¼‰è¿˜æ˜¯æŒç»­æ€§çš„æ•°æ®é”™è¯¯ï¼ˆå¦‚èŠ‚ç‚¹å†…éƒ¨æ•…éšœï¼‰ï¼Œå¦‚æœåˆ¤æ–­æ˜¯ä¸¥é‡çš„æŒç»­æ€§é”™è¯¯ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°±ä¼šåˆ‡æ–­è‡ªå·±ä¸æ€»çº¿çš„è”ç³»ï¼Œä»è€Œé¿å…å½±å“æ€»çº¿ä¸Šå…¶ä»–èŠ‚ç‚¹çš„æ­£å¸¸å·¥ä½œã€‚</p>
<h3 id="ä½å¡«å……"><a class="header" href="#ä½å¡«å……">ä½å¡«å……</a></h3>
<p><img src="ee/../images/can/can-bit-fill.png" alt="CAN ä½å¡«å……åŸåˆ™" /></p>
<p>CAN åè®®ä¸­è§„å®šï¼Œå½“ç›¸åŒææ€§çš„ç”µå¹³æŒç»­äº”ä½æ—¶ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªææ€§ç›¸åçš„ä½ã€‚</p>
<h2 id="ç½‘ç»œåˆ†å±‚æ¶æ„"><a class="header" href="#ç½‘ç»œåˆ†å±‚æ¶æ„">ç½‘ç»œåˆ†å±‚æ¶æ„</a></h2>
<p><img src="ee/../images/can/can-net-stack.jpeg" alt="CAN ç½‘ç»œå±‚æ¬¡ç»“æ„" /></p>
<h2 id="å¸§ç»“æ„"><a class="header" href="#å¸§ç»“æ„">å¸§ç»“æ„</a></h2>
<h3 id="æ•°æ®å¸§å’Œé¥æ§å¸§"><a class="header" href="#æ•°æ®å¸§å’Œé¥æ§å¸§">æ•°æ®å¸§å’Œé¥æ§å¸§</a></h3>
<p><img src="ee/../images/can/can-data-frame.png" alt="CAN æ•°æ®å¸§" /></p>
<p><img src="ee/../images/can/can-remote-frame.png" alt="CAN é¥æ§å¸§" /></p>
<ul>
<li>RTR(Remote Transmission Request) ä½ä¿è¯äº†æ•°æ®å¸§çš„ä¼˜å…ˆçº§é«˜äºé¥æ§å¸§</li>
<li>SRR(Substitutes Remote Requests) ä½ä¿è¯äº†æ ‡å‡†æ•°æ®å¸§çš„ä¼˜å…ˆçº§é«˜äºæ‰©å±•æ•°æ®å¸§</li>
<li>IDE(Identifier Extension) ä½ä¿è¯äº†æ ‡å‡†é¥æ§å¸§çš„ä¼˜å…ˆçº§é«˜äºæ‰©å±•é¥æ§å¸§</li>
<li>DLC(Data Length Code) ä½æŒ‡ç¤ºäº†æ•°æ®æ®µä¸­çš„å­—èŠ‚æ•°ï¼Œå¯¹äºé¥æ§å¸§è€Œè¨€ï¼ŒDLC è¡¨ç¤ºè¯¥é¥æ§å¸§å¯¹åº”çš„æ•°æ®å¸§çš„æ•°æ®æ®µçš„å­—èŠ‚æ•°</li>
<li>æ•°æ®æ®µä» MSB å¼€å§‹è¾“å‡º</li>
<li>CRC æ ¡éªŒåºåˆ—(15bit)çš„è®¡ç®—èŒƒå›´åŒ…æ‹¬ï¼šSOF,ä»²è£æ®µï¼Œæ§åˆ¶æ®µå’Œæ•°æ®æ®µ</li>
<li>ACK åŒ…æ‹¬ ACK æ§½å’Œ ACK åˆ†ç•Œç¬¦ï¼š
<ul>
<li>å‘é€èŠ‚ç‚¹å‘å‡ºçš„æŠ¥æ–‡ä¸­ ACK æ§½ä¸º<code>éšæ€§1</code></li>
<li>æ¥æ”¶èŠ‚ç‚¹åœ¨æ¥æ”¶åˆ°æ­£ç¡®çš„æŠ¥æ–‡ä¹‹åä¼šåœ¨ ACK æ§½å‘é€<code>æ˜¾æ€§0</code>ï¼Œé€šçŸ¥å‘é€èŠ‚ç‚¹æ­£å¸¸æ¥æ”¶ç»“æŸ</li>
</ul>
</li>
<li>EOF(End Of Frame) è¡¨ç¤ºè¯¥å¸§æŠ¥æ–‡çš„ç»“æŸï¼Œç”±7ä¸ªéšæ€§ä½æ„æˆ</li>
</ul>
<h3 id="é”™è¯¯å¸§"><a class="header" href="#é”™è¯¯å¸§">é”™è¯¯å¸§</a></h3>
<p>åœ¨ CAN æ€»çº¿é€šä¿¡ä¸­ï¼Œä¸€å…±æœ‰äº”ç§é”™è¯¯ï¼Œåˆ†åˆ«æ˜¯ï¼šä½é”™è¯¯ã€ACKé”™è¯¯ã€å¡«å……é”™è¯¯ã€CRCé”™è¯¯ã€æ ¼å¼é”™è¯¯ã€‚</p>
<p><img src="ee/../images/can/can-error-frame.png" alt="CAN é”™è¯¯å¸§" /></p>
<ul>
<li>ä¸»åŠ¨é”™è¯¯æ ‡å¿—ï¼š6ä¸ªè¿ç»­çš„æ˜¾æ€§ä½0</li>
<li>è¢«åŠ¨é”™è¯¯æ ‡å¿—ï¼š6ä¸ªè¿ç»­çš„éšæ€§ä½1</li>
<li>é”™è¯¯åˆ†ç•Œç¬¦ï¼š8ä¸ªè¿ç»­çš„éšæ€§ä½1</li>
</ul>
<h3 id="è¿‡è½½å¸§"><a class="header" href="#è¿‡è½½å¸§">è¿‡è½½å¸§</a></h3>
<p><img src="ee/../images/can/can-overload-frame.png" alt="CAN è¿‡è½½å¸§" /></p>
<ul>
<li>æ¥å—å•å…ƒä¼šå‘ä»æ­¤å¸§æ¥é€šçŸ¥æ€»çº¿è‡ªå·±è¿˜æ²¡æœ‰åšå¥½æ¥æ”¶å‡†å¤‡</li>
</ul>
<h3 id="å¸§é—´éš”"><a class="header" href="#å¸§é—´éš”">å¸§é—´éš”</a></h3>
<p><img src="ee/../images/can/can-inter-frame.png" alt="CAN å¸§é—´éš”" /></p>
<ul>
<li>æ•°æ®å¸§å’Œé¥æ§å¸§å¯é€šè¿‡æ’å…¥å¸§é—´éš”å°†æœ¬å¸§ä¸å‰é¢çš„ä»»ä½•å¸§ï¼ˆæ•°æ®å¸§ã€é¥æ§å¸§ã€é”™è¯¯å¸§ã€è¿‡è½½å¸§ï¼‰åˆ†å¼€ï¼Œè¿‡è½½å¸§å’Œé”™è¯¯å¸§å‰ä¸èƒ½æ’å…¥å¸§é—´éš”</li>
</ul>
<h2 id="é”™è¯¯é€šçŸ¥"><a class="header" href="#é”™è¯¯é€šçŸ¥">é”™è¯¯é€šçŸ¥</a></h2>
<h3 id="èŠ‚ç‚¹é”™è¯¯çŠ¶æ€"><a class="header" href="#èŠ‚ç‚¹é”™è¯¯çŠ¶æ€">èŠ‚ç‚¹é”™è¯¯çŠ¶æ€</a></h3>
<p>æŒ‰ç…§ CAN åè®®çš„è§„å®šï¼ŒCAN æ€»çº¿ä¸Šçš„èŠ‚ç‚¹å§‹ç»ˆå¤„äºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>
<p>ä¸»åŠ¨é”™è¯¯çŠ¶æ€</p>
<ul>
<li>å¯ä»¥æ­£å¸¸é€šä¿¡</li>
<li>åœ¨æ£€æµ‹å‡ºé”™è¯¯æ—¶ï¼Œå‘å‡ºä¸»åŠ¨é”™è¯¯æ ‡å¿—</li>
</ul>
</li>
<li>
<p>è¢«åŠ¨é”™è¯¯çŠ¶æ€</p>
<ul>
<li>å¯ä»¥æ­£å¸¸é€šä¿¡</li>
<li>åœ¨æ£€æµ‹å‡ºé”™è¯¯æ—¶ï¼Œå‘å‡ºè¢«åŠ¨é”™è¯¯æ ‡å¿—</li>
</ul>
</li>
<li>
<p>æ€»çº¿å…³é—­çŠ¶æ€</p>
<ul>
<li>èŠ‚ç‚¹ä¸èƒ½æ”¶å‘æŠ¥æ–‡</li>
<li>åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶çš„æ—¶å€™ï¼Œå†æ¬¡è¿›å…¥åˆ°ä¸»åŠ¨é”™è¯¯çŠ¶æ€</li>
</ul>
</li>
</ul>
<h3 id="é”™è¯¯çŠ¶æ€çš„è½¬æ¢"><a class="header" href="#é”™è¯¯çŠ¶æ€çš„è½¬æ¢">é”™è¯¯çŠ¶æ€çš„è½¬æ¢</a></h3>
<p>åœ¨ CAN èŠ‚ç‚¹å†…ï¼Œæœ‰ä¸¤ä¸ªè®¡æ•°å™¨ï¼šå‘é€é”™è¯¯è®¡æ•°å™¨ï¼ˆTECï¼‰å’Œæ¥æ”¶é”™è¯¯è®¡æ•°å™¨ï¼ˆRECï¼‰ã€‚TEC å’Œ REC è®¡æ•°å€¼çš„å˜åŒ–ï¼Œæ˜¯æ ¹æ®ä¸‹è¡¨çš„è§„å®šæ¥è¿›è¡Œçš„</p>
<p><img src="ee/../images/can/can-tec-rec.png" alt="TEC/REC" /></p>
<p>CANèŠ‚ç‚¹é”™è¯¯çŠ¶æ€çš„è½¬æ¢ï¼Œå°±æ˜¯åŸºäºè¿™ä¸¤ä¸ªè®¡æ•°å™¨æ¥è¿›è¡Œçš„</p>
<p><img src="ee/../images/can/can-error-state.png" alt="é”™è¯¯çŠ¶æ€è½¬æ¢" /></p>
<h3 id="é”™è¯¯å¸§çš„å‘é€"><a class="header" href="#é”™è¯¯å¸§çš„å‘é€">é”™è¯¯å¸§çš„å‘é€</a></h3>
<p><img src="ee/../images/can/can-error-recovery.png" alt="é”™è¯¯å¸§çš„å‘é€" /></p>
<ol>
<li>å‘é€èŠ‚ç‚¹ Node_A å‘é€ä¸€ä¸ªæ˜¾æ€§ä½ï¼Œä½†æ˜¯å´ä»æ€»çº¿ä¸Šå¬åˆ°ä¸€ä¸ªéšå½¢ä½ï¼Œäºæ˜¯ Node_A èŠ‚ç‚¹å°±ä¼šæ£€æµ‹åˆ°ä¸€ä¸ªä½é”™è¯¯</li>
<li>Node_A æ£€æµ‹åˆ°ä½é”™è¯¯ä¹‹åï¼Œç«‹å³åœ¨ä¸‹ä¸€ä½å¼€å§‹å‘é€ä¸»åŠ¨é”™è¯¯å¸§ï¼š6ä¸ªè¿ç»­æ˜¾æ€§ä½çš„ä¸»åŠ¨é”™è¯¯æ ‡å¿—+8ä¸ªè¿ç»­éšæ€§ä½çš„é”™è¯¯ç•Œå®šç¬¦</li>
<li>å¯¹åº” Node_A å‘å‡ºçš„ä¸»åŠ¨é”™è¯¯æ ‡å¿—ï¼Œæ€»çº¿ä¸Šç”µå¹³ä¸º6ä¸ªè¿ç»­æ˜¾æ€§ä½</li>
<li>æ¥æ”¶èŠ‚ç‚¹ Node_B å’Œ Node_C ä»æ€»çº¿ä¸Šå¬åˆ°è¿ç»­6ä¸ªæ˜¾æ€§ä½ï¼Œé‚£ä¹ˆå°±ä¼šæ£€æµ‹åˆ°ä¸€ä¸ª<strong>å¡«å……é”™è¯¯</strong>ï¼Œäºæ˜¯è¿™ä¸¤ä¸ªèŠ‚ç‚¹éƒ½ä¼šå‘é€ä¸»åŠ¨é”™è¯¯å¸§</li>
<li>å¯¹åº” Node_B å’Œ Node_C å‘å‡ºçš„ä¸»åŠ¨é”™è¯¯æ ‡å¿—ï¼Œæ€»çº¿ç”µå¹³åˆæœ‰6ä¸ªè¿ç»­æ˜¾æ€§ç”µå¹³ï¼Œå¯¹åº” Node_B å’Œ Node_C å‘å‡ºçš„é”™è¯¯ç•Œå®šç¬¦ï¼Œæ€»çº¿ç”µå¹³æœ‰8ä¸ªè¿ç»­çš„éšæ€§ç”µå¹³</li>
<li>åœ¨é—´æ­‡åŸŸä¹‹åï¼ŒNode_A èŠ‚ç‚¹é‡æ–°å‘é€åˆšåˆšå‡ºé”™çš„æŠ¥æ–‡</li>
</ol>
<h2 id="socket-can"><a class="header" href="#socket-can">Socket CAN</a></h2>
<h3 id="å‘½ä»¤è¡Œå·¥å…·"><a class="header" href="#å‘½ä»¤è¡Œå·¥å…·">å‘½ä»¤è¡Œå·¥å…·</a></h3>
<h4 id="ip-å‘½ä»¤"><a class="header" href="#ip-å‘½ä»¤">ip å‘½ä»¤</a></h4>
<pre><code class="language-bash">ip link set can0 type can help
</code></pre>
<h5 id="è®¾ç½®-can-è®¾å¤‡çš„æ³¢ç‰¹ç‡"><a class="header" href="#è®¾ç½®-can-è®¾å¤‡çš„æ³¢ç‰¹ç‡">è®¾ç½® CAN è®¾å¤‡çš„æ³¢ç‰¹ç‡</a></h5>
<pre><code class="language-bash">ip link set can0 type can bitrate 500000
ip link set can0 type can bitrate 500000 dbitrate 2000000 fd on
ip link set can0 type can bitrate 500000 sample-point 0.875
</code></pre>
<h5 id="å¯åŠ¨å…³é—­-can-è®¾å¤‡"><a class="header" href="#å¯åŠ¨å…³é—­-can-è®¾å¤‡">å¯åŠ¨/å…³é—­ CAN è®¾å¤‡</a></h5>
<pre><code class="language-bash">ip link set can0 up
ip link set can0 down
</code></pre>
<h5 id="è®¾ç½®-can-è®¾å¤‡çš„æ¨¡å¼"><a class="header" href="#è®¾ç½®-can-è®¾å¤‡çš„æ¨¡å¼">è®¾ç½® CAN è®¾å¤‡çš„æ¨¡å¼</a></h5>
<pre><code class="language-bash">ip link set can0 type can loopback on
ip link set can0 type can listen-only on
</code></pre>
<h5 id="æŸ¥çœ‹è¯¦ç»†çš„é…ç½®ä¿¡æ¯"><a class="header" href="#æŸ¥çœ‹è¯¦ç»†çš„é…ç½®ä¿¡æ¯">æŸ¥çœ‹è¯¦ç»†çš„é…ç½®ä¿¡æ¯</a></h5>
<pre><code class="language-bash">ip -details link show can0
</code></pre>
<h4 id="can-utils-ç¨‹åº"><a class="header" href="#can-utils-ç¨‹åº">can-utils ç¨‹åº</a></h4>
<h5 id="candump"><a class="header" href="#candump">candump</a></h5>
<pre><code class="language-bash">candump can0,0x123:0x7FF # ä»…æ˜¾ç¤ºcan0ä¸Šæ”¶åˆ°çš„IDä¸º0x123çš„æ¶ˆæ¯
</code></pre>
<h5 id="cansend"><a class="header" href="#cansend">cansend</a></h5>
<pre><code class="language-bash">cansend can0 123#1122334455667788 # å‘é€ä¸€ä¸ªIDä¸º0x123çš„æŠ¥æ–‡
</code></pre>
<h5 id="cangen"><a class="header" href="#cangen">cangen</a></h5>
<pre><code class="language-bash">cangen can0 -g 0x123 -I 1000 -L 8 -D 0x1122334455667788 # æ¯1000mså‘é€ä¸€ä¸ªIDä¸º0x123çš„æŠ¥æ–‡
</code></pre>
<h5 id="cansniffer"><a class="header" href="#cansniffer">cansniffer</a></h5>
<pre><code class="language-bash">cansniffer can0 # æŠ“å–can0ä¸Šçš„æ‰€æœ‰æŠ¥æ–‡ï¼Œå¯ä»¥è¿‡æ»¤æ‰æ•°æ®ä¸å˜çš„å¸§
</code></pre>
<h2 id="python-can"><a class="header" href="#python-can">python-can</a></h2>
<h3 id="å®‰è£…"><a class="header" href="#å®‰è£…">å®‰è£…</a></h3>
<pre><code class="language-bash">pip install python-can
</code></pre>
<h3 id="ä½¿ç”¨"><a class="header" href="#ä½¿ç”¨">ä½¿ç”¨</a></h3>
<pre><code class="language-python"># import the library
import can

# create a bus instance
# many other interfaces are supported as well (see documentation)
bus = can.Bus(interface='socketcan',
              channel='vcan0',
              receive_own_messages=True)

# send a message
message = can.Message(arbitration_id=123, is_extended_id=True,
                      data=[0x11, 0x22, 0x33])
bus.send(message, timeout=0.2)

# iterate over received messages
for msg in bus:
    print(f"{msg.arbitration_id:X}: {msg.data}")

# or use an asynchronous notifier
notifier = can.Notifier(bus, [can.Logger("recorded.log"), can.Printer()])
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mipi-dsi-åŸºç¡€"><a class="header" href="#mipi-dsi-åŸºç¡€">MIPI DSI åŸºç¡€</a></h1>
<h2 id="mipi-å±‚æ¬¡ç»“æ„"><a class="header" href="#mipi-å±‚æ¬¡ç»“æ„">MIPI å±‚æ¬¡ç»“æ„</a></h2>
<p><img src="ee/../images/mipi/mipi-hiearachy.jpeg" alt="MIPI åº”ç”¨çš„å±‚çº§ç»“æ„" /></p>
<h2 id="dsi"><a class="header" href="#dsi">DSI</a></h2>
<p>MIPI DSI æ˜¯åŸºäºå­—èŠ‚çš„åè®®ï¼Œåº”ç”¨å±‚å®Œæˆå„ç§æ“ä½œä¸‹ç›¸å…³å‘½ä»¤çš„é€‰æ‹©ã€å„åƒç´ ç‚¹å›¾åƒæ•°æ®çš„å­—èŠ‚æ˜ å°„å¤„ç†ã€‚MIPI å®šä¹‰äº†<strong>å‘½ä»¤æ¨¡å¼</strong>å’Œ<strong>è§†é¢‘æ¨¡å¼</strong>ä¸¤ç§ä¼ è¾“æ¨¡å¼ã€‚è§†é¢‘æ¨¡å¼ä»¥å®æ—¶åƒç´ æ•°æ®æµçš„æ–¹å¼ä»å¤„ç†å™¨å‘å¤–è®¾ä¼ è¾“æ•°æ®ï¼Œè€Œå‘½ä»¤æ¨¡å¼å¯ä»¥åšåˆ°æŒ‰éœ€ä¼ è¾“ï¼Œåªéœ€è¦åœ¨å›¾åƒå†…å®¹å‘ç”Ÿå˜åŒ–æ—¶å†è¿›è¡Œæ–°å›¾åƒæ•°æ®çš„ä¼ è¾“ã€‚å‘½ä»¤æ¨¡å¼éœ€è¦æ˜¾ç¤ºæ¨¡ç»„ä¸­çš„å¸§ç¼“å­˜å­˜å‚¨å™¨çš„æ”¯æŒã€‚<em>è¿™ä¸¤ç§ä¼ è¾“æ¨¡å¼çš„æ”¯æŒï¼Œç”±æ¨¡ç»„ç¡¬ä»¶ç»“æ„å†³å®š</em>ã€‚</p>
<p>MIPI DSI çš„é«˜é€Ÿæ•°æ®ä¼ è¾“é‡‡ç”¨å·®åˆ†ä¿¡å·æ¥ä¼ è¾“ï¼Œåœ¨æ—¶é’Ÿé€šé“å’Œå„ä¸ªæ•°æ®é€šé“ä¸Šéƒ½ä¼šæœ‰é«˜é€Ÿæ•°æ®ä¼ è¾“ã€‚</p>
<p>MIPI DSI çš„ä½åŠŸè€—æ•°æ®ä¼ è¾“å¹¶ä¸éœ€è¦æ—¶é’Ÿä¼ è¾“ï¼Œè¿™æ—¶ D-PHY é‡‡ç”¨<strong>å½’é›¶ç </strong>çš„æ–¹å¼æ¥è¡¨ç¤ºé€»è¾‘æ•°æ®â€œ0â€ â€œ1â€ï¼Œå¹¶ä¸”ä½åŠŸè€—æ•°æ®åªä¼šåœ¨æ•°æ®é€šé“<strong>0</strong>ä¸Šè¿›è¡Œä¼ è¾“ï¼Œå¯¹é€šé“<strong>0</strong>çš„Pç«¯å’ŒNç«¯è¿›è¡Œ<strong>å¼‚æˆ–</strong>æ“ä½œå°±å¯ä»¥æ¢å¤å‡ºæ•°æ®æ¯”ç‰¹æµçš„â€œåŒæ­¥æ—¶é’Ÿâ€ã€‚</p>
<h3 id="dsi-ç³»ç»Ÿæ¶æ„"><a class="header" href="#dsi-ç³»ç»Ÿæ¶æ„">DSI ç³»ç»Ÿæ¶æ„</a></h3>
<p><img src="ee/../images/mipi/mipi-dsi-block-diagram.png" alt="MIPI DSI ç³»ç»Ÿæ¶æ„" /></p>
<div class="table-wrapper"><table><thead><tr><th>æ—¶é’Ÿ</th><th>æœ€å°é¢‘ç‡</th><th>æœ€å¤§é¢‘ç‡</th></tr></thead><tbody>
<tr><td>rxclkesc</td><td></td><td>ç”± PHY é™åˆ¶ï¼Œé€šå¸¸ä¸è¶…è¿‡ 20MHz</td></tr>
<tr><td>txclkesc</td><td></td><td>ç”± PHY é™åˆ¶ï¼Œé€šå¸¸ä¸è¶…è¿‡ 20MHz</td></tr>
<tr><td>lanebyteclk</td><td>3 * rxclkesc</td><td>1/8 of the DPHY maximum speed</td></tr>
<tr><td>pclk</td><td>2MHz</td><td>220MHz</td></tr>
<tr><td>dpiclk</td><td></td><td>250MHz</td></tr>
<tr><td>dbiclk</td><td></td><td>41MHz</td></tr>
</tbody></table>
</div>
<h3 id="dsi-å±‚çº§ç»“æ„"><a class="header" href="#dsi-å±‚çº§ç»“æ„">DSI å±‚çº§ç»“æ„</a></h3>
<p><img src="ee/../images/mipi/mipi-dsi-flow.jpg" alt="DSI å±‚çº§ç»“æ„" /></p>
<h4 id="è§†é¢‘æ¨¡å¼"><a class="header" href="#è§†é¢‘æ¨¡å¼">è§†é¢‘æ¨¡å¼</a></h4>
<p>è§†é¢‘æ¨¡å¼ä¸‹ï¼Œå›¾åƒæ•°æ®çš„ä¼ è¾“æ˜¯ç”¨<strong>ä½é˜¶åè®®å±‚</strong>åŒ…ç»“æ„ä¸­çš„æ•°æ®ç±»å‹æ ‡è¯†ç¬¦ï¼ˆDT,Data Typeï¼‰å­—æ®µåŒºåˆ†ï¼Œç”¨ä¸åŒçš„ DT æ¥æ„é€ è§†é¢‘æ¨¡å¼ä¼ è¾“æ‰€éœ€è¦çš„å„ç§æ•°æ®åŒ…ã€‚è§†é¢‘æ¨¡å¼ä¸‹ï¼Œåº”ç”¨å±‚åªæä¾›å›¾åƒæ•°æ®çš„å‡€è·ï¼Œåˆ©ç”¨ä½é˜¶åè®®å±‚è¿›è¡Œç»„åŒ…å¤„ç†ã€‚åœ¨ MIPI DSI ä¸­ï¼ŒåŒæ­¥ä¿¡å·åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå‘½ä»¤ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>åŒæ­¥ä¿¡å·å‘½ä»¤</th><th>åŠŸèƒ½</th></tr></thead><tbody>
<tr><td>HSS</td><td>HSAå¼€å§‹å‘½ä»¤</td></tr>
<tr><td>HSE</td><td>HSAç»“æŸå‘½ä»¤</td></tr>
<tr><td>VSS</td><td>VSAå¼€å§‹å‘½ä»¤</td></tr>
<tr><td>VSE</td><td>VSAç»“æŸå‘½ä»¤</td></tr>
</tbody></table>
</div>
<h5 id="éçªå‘åŒæ­¥è„‰å†²æ¨¡å¼"><a class="header" href="#éçªå‘åŒæ­¥è„‰å†²æ¨¡å¼">éçªå‘åŒæ­¥è„‰å†²æ¨¡å¼</a></h5>
<p><img src="ee/../images/mipi/mipi-dsi-video-nonburst-sync-pulse.jpg" alt="éçªå‘åŒæ­¥è„‰å†²æ¨¡å¼" /></p>
<h5 id="éçªå‘åŒæ­¥äº‹ä»¶æ¨¡å¼"><a class="header" href="#éçªå‘åŒæ­¥äº‹ä»¶æ¨¡å¼">éçªå‘åŒæ­¥äº‹ä»¶æ¨¡å¼</a></h5>
<p><img src="ee/../images/mipi/mipi-dsi-video-nonburst-sync-event.jpg" alt="éçªå‘åŒæ­¥äº‹ä»¶æ¨¡å¼" /></p>
<p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œä¸å†å‘æ˜¾ç¤ºæ¨¡ç»„ä¼ è¾“ HSEã€VSE å‘½ä»¤ï¼Œè€Œä»…ä»…ä¼ è¾“ HSSã€VSS å‘½ä»¤ã€‚</p>
<h5 id="çªå‘æ¨¡å¼"><a class="header" href="#çªå‘æ¨¡å¼">çªå‘æ¨¡å¼</a></h5>
<p><img src="ee/../images/mipi/mipi-dsi-video-burst.jpg" alt="çªå‘æ¨¡å¼" /></p>
<p>çªå‘æ¨¡å¼æ˜¯æŒ‡ä¼ è¾“ RGB å›¾åƒæ•°æ®æ—¶ï¼Œå……åˆ†åˆ©ç”¨ MIPI æä¾›çš„å¸¦å®½ï¼Œé‡‡ç”¨çªå‘æ–¹å¼å…ˆæŠŠå›¾åƒæ•°æ®ä¼ è¾“ç»™æ˜¾ç¤ºæ¨¡ç»„è¿›è¡Œç¼“å­˜ï¼Œç„¶ååˆ‡æ¢åˆ°ä½åŠŸè€—æ¨¡å¼ã€‚<strong>è¿™ç§æ¨¡å¼éœ€è¦æ˜¾ç¤ºæ¨¡ç»„æœ‰è¡Œç¼“å­˜åŒºæˆ–ç±»ä¼¼çš„å­˜å‚¨åŒºåŸŸ</strong>ã€‚</p>
<p>å¸¸ç”¨çš„æ•°æ®å‘½ä»¤ä¼ è¾“æ–¹å¼ï¼š</p>
<p><img src="ee/../images/mipi/mipi-dsi-transfer-sequence.jpg" alt="ä¼ è¾“æ–¹å¼" /></p>
<p>åœ¨æœ‰æ•ˆæ˜¾ç¤ºè¡Œã€è¡ŒåŒæ­¥ä¿¡å·å’Œæœ‰æ•ˆæ•°æ®ä¹‹é—´ï¼Œéœ€è¦ä½¿ç”¨æ¶ˆéšåŒ…ï¼ˆblanking packet) æ¥å¡«å……ç›¸åº”çš„æ—¶é—´ï¼Œåœ¨æ¶ˆéšè¡ŒæœŸé—´ï¼Œæ²¡æœ‰å›¾åƒæ•°æ®ä¼ è¾“ï¼Œä¹Ÿç”¨æ¶ˆéšåŒ…æ¥æ›¿ä»£ã€‚é‡‡ç”¨è¿™ç§ç»“æ„ï¼Œä¸€å¸§ä¸­çš„æ¯ä¸€è¡Œï¼Œå¤„äºå‘é€çš„æ—¶é—´éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<h5 id="å›¾åƒæ•°æ®åŒ…æ ¼å¼dt0x3e"><a class="header" href="#å›¾åƒæ•°æ®åŒ…æ ¼å¼dt0x3e">å›¾åƒæ•°æ®åŒ…æ ¼å¼(DT=0x3E)</a></h5>
<p>è§†é¢‘æ¨¡å¼ä¸‹ï¼Œåœ¨åº”ç”¨å±‚ï¼Œåªæä¾›å®æ—¶å›¾åƒæ•°æ®æµï¼ŒLLPå±‚æä¾›ä¸€å®šå¼€é”€ï¼Œé€šè¿‡æ‰€ç»„æ•°æ®åŒ…ä¸­çš„DIå­—æ®µï¼Œå½¢æˆVSSã€HSSç­‰æ—¶åºå‘½ä»¤ï¼Œå‘ä»è®¾å¤‡ä¼ é€’æ—¶åºä¿¡æ¯ã€‚RGBå›¾åƒæ•°æ®ä¹Ÿé€šè¿‡ DI å­—æ®µçš„ä¸åŒå‘½ä»¤æ¥ä¼ è¾“ã€‚</p>
<p><img src="ee/../images/mipi/mipi-dsi-video-color-packet.jpg" alt="å›¾åƒæ•°æ®åŒ…æ ¼å¼" /></p>
<h4 id="ä½é˜¶åè®®å±‚-llp"><a class="header" href="#ä½é˜¶åè®®å±‚-llp">ä½é˜¶åè®®å±‚ ï¼ˆLLPï¼‰</a></h4>
<p><img src="ee/../images/mipi/mipi-dsi-llp-single-transmission.jpg" alt="å•æ¬¡ä¼ è¾“" /></p>
<p>åŸºäº MIPI DSI ç‰©ç†å±‚ D-PHY çš„ç‰¹æ®Šç»“æ„ï¼Œæ¯ä¸ªåŒ…åœ¨å¼€å§‹ä¼ è¾“å‰ï¼Œä¸€å®šå¤„äºä¸€ä¸ªè¢«ç§°ä¸ºä½åŠŸè€—æ¨¡å¼çš„çŠ¶æ€ï¼ˆLPSï¼‰ã€‚å¼€å§‹æ•°æ®ä¼ è¾“æ—¶ï¼Œæœ€å…ˆä¼ è¾“çš„æ˜¯ä¸€ç§ç‰¹æ®Šçš„åŒ…ç»“æ„â€”â€”åŒ…å¼€å§‹æŒ‡ç¤ºï¼ˆSoT, Start of Transmissionï¼‰ã€‚SOTä¹‹åæ‰ä¼ è¾“ MIPI DSI æ•°æ®åŒ…ã€‚ä¸ºäº†å¢åŠ æ¥å£å¤„ç†å¸¦å®½ï¼ŒMIPI DSI å…è®¸ä¸€æ¬¡æ•°æ®ä¼ è¾“æ”¯æŒå¤šä¸ªæ•°æ®åŒ…ï¼Œä¸”é•¿åŒ…å’ŒçŸ­åŒ…å¯ä»¥<strong>ä»»æ„é¡ºåº</strong>å‡ºç°ã€‚åœ¨åŒä¸€æ¬¡ä¼ è¾“ä¸­ï¼Œè¿™äº›æ•°æ®åŒ…è¦ä¹ˆéƒ½ç”¨é«˜é€Ÿä¼ è¾“æ¨¡å¼ï¼Œè¦ä¹ˆéƒ½ç”¨ä½åŠŸè€—ä¼ è¾“æ¨¡å¼ã€‚</p>
<h4 id="dsi-åŒ…ç»“æ„"><a class="header" href="#dsi-åŒ…ç»“æ„">DSI åŒ…ç»“æ„</a></h4>
<ul>
<li>
<p>é•¿åŒ…ç»“æ„(æœ€å¤§65535å­—èŠ‚çš„payload)
<img src="ee/../images/mipi/mipi-dsi-long-packet-structure.jpg" alt="DSI é•¿åŒ…ç»“æ„" /></p>
</li>
<li>
<p>çŸ­åŒ…ç»“æ„(å›ºå®šä¼ è¾“ä¸¤ä¸ªå­—èŠ‚)
<img src="ee/../images/mipi/mipi-dsi-short-packet-structure.jpg" alt="DSI çŸ­åŒ…ç»“æ„" /></p>
</li>
</ul>
<h4 id="dsi-æ•°æ®ä¼ è¾“å­—èŠ‚åº"><a class="header" href="#dsi-æ•°æ®ä¼ è¾“å­—èŠ‚åº">DSI æ•°æ®ä¼ è¾“å­—èŠ‚åº</a></h4>
<p><img src="ee/../images/mipi/mipi-dsi-bytes-order.jpg" alt="DSI æ•°æ®ä¼ è¾“å­—èŠ‚åº" /></p>
<p>ä¸€ä¸ªæ•°æ®åŒ…å†…çš„å„ä¸ªå­—èŠ‚æŒ‰ç…§ä½å­—èŠ‚ï¼Œä½æ¯”ç‰¹ä½å…ˆä¼ ã€‚</p>
<h4 id="æ•°æ®åŒ…ç±»å‹æ ‡è¯†ç¬¦dt"><a class="header" href="#æ•°æ®åŒ…ç±»å‹æ ‡è¯†ç¬¦dt">æ•°æ®åŒ…ç±»å‹æ ‡è¯†ç¬¦ï¼ˆDTï¼‰</a></h4>
<ul>
<li>æ­£å‘æ•°æ®ä¼ è¾“çš„ DT</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>DT ç¼–ç å€¼</th><th>DT å«ä¹‰</th><th>è¯´æ˜</th><th>é•¿çŸ­åŒ…ç±»å‹</th></tr></thead><tbody>
<tr><td>01h</td><td>VSS ( V Sync Start )</td><td>å¸§åŒæ­¥å¼€å§‹æ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>11h</td><td>VSE ( V Sync End )</td><td>å¸§åŒæ­¥ç»“æŸæ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>21h</td><td>HSS (H Sync Start )</td><td>è¡ŒåŒæ­¥å¼€å§‹æ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>31h</td><td>HSE (H Sync End )</td><td>è¡ŒåŒæ­¥ç»“æŸæ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>08h</td><td>EoTp ( EoT Packet )</td><td>ä¼ è¾“ç»“æŸæŒ‡ç¤ºæ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>02h</td><td>Color Mode Off Command</td><td>æ˜¾ç¤ºæ¨¡ç»„è¿›å…¥æµ…è‰²æ˜¾ç¤ºæ¨¡å¼</td><td>çŸ­åŒ…</td></tr>
<tr><td>12h</td><td>Color Mode On Command</td><td>æ˜¾ç¤ºæ¨¡ç»„æ¢å¤æ­£å¸¸æ˜¾ç¤ºæ¨¡å¼</td><td>çŸ­åŒ…</td></tr>
<tr><td>22h</td><td>Shutdown Peripheral Command</td><td>å…³é—­æ˜¾ç¤ºæ¨¡ç»„å‘½ä»¤</td><td>çŸ­åŒ…</td></tr>
<tr><td>32h</td><td>Turn On Peripheral Command</td><td>æ¿€æ´»æ˜¾ç¤ºæ¨¡ç»„å‘½ä»¤</td><td>çŸ­åŒ…</td></tr>
<tr><td>03h</td><td>Generic Short Write</td><td>é€šç”¨çŸ­åŒ…å†™å‘½ä»¤ï¼Œä¸å¸¦å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>13h</td><td>Generic Short Write</td><td>é€šç”¨çŸ­åŒ…å†™å‘½ä»¤ï¼Œå¸¦1å­—èŠ‚å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>23h</td><td>Generic Short Write</td><td>é€šç”¨çŸ­åŒ…å†™å‘½ä»¤ï¼Œå¸¦2å­—èŠ‚å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>04h</td><td>Generic Read</td><td>é€šç”¨è¯»å‘½ä»¤ï¼Œä¸å¸¦å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>14h</td><td>Generic Read</td><td>é€šç”¨è¯»å‘½ä»¤ï¼Œå¸¦1å­—èŠ‚å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>24h</td><td>Generic Read</td><td>é€šç”¨è¯»å‘½ä»¤ï¼Œå¸¦2å­—èŠ‚å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>05h</td><td>DCS Short Write</td><td>DCSçŸ­åŒ…å†™å‘½ä»¤ï¼Œä¸å¸¦å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>15h</td><td>DCS Short Write</td><td>DCSçŸ­åŒ…å†™å‘½ä»¤ï¼Œå¸¦1å­—èŠ‚å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>06h</td><td>DCS Read</td><td>DCSè¯»å‘½ä»¤ï¼Œä¸å¸¦å‚æ•°</td><td>çŸ­åŒ…</td></tr>
<tr><td>37h</td><td>Set Maximum Return Packet</td><td>è®¾ç½®æœ€å¤§è¿”å›åŒ…é•¿åº¦</td><td>çŸ­åŒ…</td></tr>
<tr><td>09h</td><td>Null Packet</td><td>ç©ºåŒ…ï¼Œä¸å¸¦æ•°æ®</td><td>çŸ­åŒ…</td></tr>
<tr><td>19h</td><td>Blanking Packet</td><td>æ¶ˆéšåŒ…ï¼Œä¸å¸¦æ•°æ®</td><td>é•¿åŒ…</td></tr>
<tr><td>29h</td><td>Generic Long Write</td><td>é€šç”¨é•¿åŒ…å†™å‘½ä»¤</td><td>é•¿åŒ…</td></tr>
<tr><td>39h</td><td>DCS Long Write</td><td>DCSé•¿åŒ…å†™å‘½ä»¤</td><td>é•¿åŒ…</td></tr>
<tr><td>0Ch</td><td>Loosely Packet Pixel Stream</td><td>20æ¯”ç‰¹4:2:2æ ¼å¼YUVåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>1Ch</td><td>Packed Pixel Stream</td><td>24æ¯”ç‰¹4:2:2æ ¼å¼YUVåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>2Ch</td><td>Packed Pixel Stream</td><td>16æ¯”ç‰¹4:2:2æ ¼å¼YUVåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>0Dh</td><td>Packed Pixel Stream</td><td>30æ¯”ç‰¹10:10:10æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>1Dh</td><td>Packed Pixel Stream</td><td>36æ¯”ç‰¹12:12:12æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>3Dh</td><td>Packed Pixel Stream</td><td>12æ¯”ç‰¹4:2:0æ ¼å¼YUVåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>0Eh</td><td>Packed Pixel Stream</td><td>16æ¯”ç‰¹5:6:5æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>1Eh</td><td>Packed Pixel Stream</td><td>18æ¯”ç‰¹6:6:6æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>2Eh</td><td>Loosely Packet Pixel Stream</td><td>18æ¯”ç‰¹6:6:6æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
<tr><td>3Eh</td><td>Packed Pixel Stream</td><td>24æ¯”ç‰¹8:8:8æ ¼å¼RGBåƒç´ æµ</td><td>é•¿åŒ…</td></tr>
</tbody></table>
</div>
<ul>
<li>åå‘æ•°æ®ä¼ è¾“çš„ DT</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>DT ç¼–ç å€¼</th><th>DT å«ä¹‰</th><th>è¯´æ˜</th><th>é•¿çŸ­åŒ…ç±»å‹</th></tr></thead><tbody>
<tr><td>02h</td><td>Acknowledge Error Report</td><td>é”™è¯¯åº”ç­”æŠ¥å‘Š</td><td>çŸ­åŒ…</td></tr>
<tr><td>08h</td><td>EoTp ( EoT Packet )</td><td>ä¼ è¾“ç»“æŸæŒ‡ç¤ºæ•°æ®åŒ…</td><td>çŸ­åŒ…</td></tr>
<tr><td>11h</td><td>Generic Short Read Response</td><td>é€šç”¨çŸ­åŒ…è¯»å“åº”ï¼Œè¿”å›1å­—èŠ‚æ•°æ®</td><td>çŸ­åŒ…</td></tr>
<tr><td>12h</td><td>Generic Short Read Response</td><td>é€šç”¨çŸ­åŒ…è¯»å“åº”ï¼Œè¿”å›2å­—èŠ‚æ•°æ®</td><td>çŸ­åŒ…</td></tr>
<tr><td>21h</td><td>DCS Short Read Response</td><td>DCSçŸ­åŒ…è¯»å“åº”ï¼Œè¿”å›1å­—èŠ‚æ•°æ®</td><td>çŸ­åŒ…</td></tr>
<tr><td>22h</td><td>DCS Short Read Response</td><td>DCSçŸ­åŒ…è¯»å“åº”ï¼Œè¿”å›2å­—èŠ‚æ•°æ®</td><td>çŸ­åŒ…</td></tr>
<tr><td>1Ah</td><td>Generic Long Read Response</td><td>é€šç”¨é•¿åŒ…è¯»å“åº”</td><td>é•¿åŒ…</td></tr>
<tr><td>1Ch</td><td>DCS Long Read Response</td><td>DCSé•¿åŒ…è¯»å“åº”</td><td>é•¿åŒ…</td></tr>
</tbody></table>
</div>
<p>å…¶ä¸­çš„é”™è¯¯åº”ç­”æŠ¥å‘Šæ•°æ®åŒ…çš„å„ä¸ªæ¯”ç‰¹çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>æ¯”ç‰¹ä½</th><th>å«ä¹‰</th></tr></thead><tbody>
<tr><td>0</td><td>ä¼ è¾“å¼€å§‹é”™è¯¯</td></tr>
<tr><td>1</td><td>ä¼ è¾“å¼€å§‹åŒæ­¥é”™è¯¯</td></tr>
<tr><td>2</td><td>ä¼ è¾“ç»“æŸåŒæ­¥é”™è¯¯</td></tr>
<tr><td>3</td><td>é€ƒé€¸æ¨¡å¼è¿›å…¥å‘½ä»¤é”™è¯¯</td></tr>
<tr><td>4</td><td>ä½åŠŸè€—ä¼ è¾“åŒæ­¥é”™è¯¯</td></tr>
<tr><td>5</td><td>å¤–è®¾è¶…æ—¶é”™è¯¯</td></tr>
<tr><td>6</td><td>é”™è¯¯æ§åˆ¶é”™è¯¯</td></tr>
<tr><td>7</td><td>å†²çªæ£€æµ‹é”™è¯¯</td></tr>
<tr><td>8</td><td>å•æ¯”ç‰¹ECCé”™è¯¯ ï¼ˆæ£€æµ‹åˆ°ï¼Œä¸”å·²çº æ­£ï¼‰</td></tr>
<tr><td>9</td><td>å¤šæ¯”ç‰¹ECCé”™è¯¯ ï¼ˆæ£€æµ‹åˆ°ï¼Œä½†æœªçº æ­£ï¼‰</td></tr>
<tr><td>10</td><td>CRCé”™è¯¯</td></tr>
<tr><td>11</td><td>æ— æ³•è¯†åˆ«çš„DSIæ•°æ®ç±»å‹</td></tr>
<tr><td>12</td><td>æ— æ•ˆçš„è™šæ‹Ÿé€šé“å·</td></tr>
<tr><td>13</td><td>æ— æ•ˆçš„æ•°æ®é•¿åº¦</td></tr>
<tr><td>14</td><td>ä¿ç•™ä½</td></tr>
<tr><td>15</td><td>DSIåè®®è¿ä¾‹</td></tr>
</tbody></table>
</div>
<p>ä¸ç®¡æ˜¯æ­£å‘æ•°æ®ä¼ è¾“è¿˜æ˜¯åå‘æ•°æ®ä¼ è¾“ï¼Œéƒ½æœ‰ EoTp çš„æ•°æ®ç±»å‹ï¼ŒDT å€¼ä¸º08hï¼Œè™šæ‹Ÿé€šé“å·<strong>å›ºå®šä¸º0</strong>ã€‚</p>
<p>å½“ä»è®¾å¤‡åŒæ—¶æœ‰å…¶ä»–æ•°æ®åŒ…éœ€è¦ä¼ è¾“å›ä¸»å¤„ç†å™¨æ—¶ï¼Œåº”ç­”å’Œé”™è¯¯æŠ¥å‘Šæ•°æ®åŒ…å¿…é¡»æ˜¯<strong>æœ€åä¸€ä¸ª</strong>ä¼ è¾“çš„æ•°æ®åŒ…ã€‚å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•é”™è¯¯ï¼Œåº”è¯¥å’Œé”™è¯¯æ•°æ®åŒ…ä¹Ÿå¯ä»¥ä¸ä¼ è¾“ã€‚</p>
<h4 id="é“¾è·¯ç®¡ç†å±‚"><a class="header" href="#é“¾è·¯ç®¡ç†å±‚">é“¾è·¯ç®¡ç†å±‚</a></h4>
<p>MIPI DSI æ˜¯ä¸€ä¸ªæ•°æ®é€šé“çµæ´»å¯å˜çš„æ•°æ®ä¼ è¾“ç³»ç»Ÿï¼Œå¯¹äºä¸€ä¸ªæŒ‡å®šçš„ç³»ç»Ÿï¼Œä¸€æ—¦ä¸Šç”µåï¼Œæ”¯æŒçš„é€šé“æ•°é‡ä¹Ÿå°±å›ºå®šä¸‹æ¥äº†ï¼Œä¸èƒ½åœ¨å·¥ä½œè¿‡ç¨‹ä¸­è¿›è¡Œä¿®æ”¹ã€‚MIPI DSI æ•°æ®åŒ…ä¼ è¾“ä½¿ç”¨å¤šä¸ªæ•°æ®é€šé“æ—¶ï¼Œæ¯ä¸ªé€šé“å‘èµ·å„è‡ªçš„ SoT,æ‰€ä»¥æ¯ä¸ªé€šé“çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å‘é€æ—¶é—´æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯EoTå´ä¸å°½ç„¶ã€‚æ¥æ”¶ç«¯å¿…é¡»ç­‰å…¨éƒ¨é€šé“çš„æ•°æ®æ”¶é›†å®Œæ¯•åæ‰èƒ½æŠŠæ•°æ®é€ç»™ä½é˜¶åè®®å±‚ã€‚</p>
<h4 id="mipi-d-phy"><a class="header" href="#mipi-d-phy">MIPI D-PHY</a></h4>
<p><img src="ee/../images/mipi/mipi-dphy-signal-level.jpg" alt="ä¿¡å·ç”µå¹³" /></p>
<p>ä¸€ä¸ªé€šé“ä¸¤æ ¹ä¿¡å·çš„ç”µå¹³å€¼ç¡®å®šäº† D-PHY çš„å·¥ä½œçŠ¶æ€ã€‚åˆ†åˆ«æŠŠä¸¤ä¸ªä¿¡å·çº¿ç”¨ Dpã€Dnæ¥è¡¨ç¤ºï¼ŒMIPI é€šé“çš„ç”µå¹³çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>HS-0: é«˜é€Ÿæ¨¡å¼ä¸‹çš„é€»è¾‘0ï¼ŒDp=å·®åˆ†ä½ç”µå¹³ï¼ˆ100mVï¼‰ï¼ŒDn=å·®åˆ†é«˜ç”µå¹³ï¼ˆ300mVï¼‰</li>
<li>HS-1: é«˜é€Ÿæ¨¡å¼ä¸‹çš„é€»è¾‘1ï¼ŒDp=å·®åˆ†é«˜ç”µå¹³ï¼ˆ300mVï¼‰ï¼ŒDn=å·®åˆ†ä½ç”µå¹³ï¼ˆ100mVï¼‰</li>
<li>LP-00: Dp å’Œ Dn éƒ½æ˜¯ä½åŠŸè€—ä¿¡ä»¤ä½ç”µå¹³</li>
<li>LP-11: Dp å’Œ Dn éƒ½æ˜¯ä½åŠŸè€—ä¿¡ä»¤é«˜ç”µå¹³ã€‚ä¹Ÿç§°ä¸ºåœæ­¢çŠ¶æ€ï¼ŒMIPI ä¸»æœºå’Œè®¾å¤‡ä¹‹é—´æ— æ³•è¿›è¡Œä»»ä½•æ•°æ®é€šä¿¡ã€‚</li>
<li>LP-01: Dp æ˜¯ä½åŠŸè€—ä¿¡ä»¤ä½ç”µå¹³ï¼ŒDn æ˜¯ä½åŠŸè€—ä¿¡ä»¤é«˜ç”µå¹³</li>
<li>LP-10: Dp æ˜¯ä½åŠŸè€—ä¿¡ä»¤é«˜ç”µå¹³ï¼ŒDn æ˜¯ä½åŠŸè€—ä¿¡ä»¤ä½ç”µå¹³</li>
</ul>
<p>å¤„äºåœæ­¢çŠ¶æ€æ—¶ï¼Œéœ€è¦Dpã€Dnä¸Šçš„ç‰¹å®šç”µå¹³åºåˆ—æ‰èƒ½è¿›å…¥å…è®¸æ•°æ®/å‘½ä»¤ä¼ è¾“çš„çŠ¶æ€ï¼Œè¿™äº›ç‰¹å®šçš„ç”µå¹³åºåˆ—è¢«ç§°ä¸º<strong>ä¼ è¾“è¯·æ±‚</strong>ã€‚</p>
<div class="table-wrapper"><table><thead><tr><th>Dp Dn ç”µå¹³åºåˆ—</th><th>ä¼ è¾“è¯·æ±‚ç±»å‹</th></tr></thead><tbody>
<tr><td>LP11 -&gt; LP01 -&gt; LP00</td><td>é«˜é€Ÿæ•°æ®ä¼ è¾“è¯·æ±‚</td></tr>
<tr><td>LP11 -&gt; LP10 -&gt; LP00 -&gt; LP01 -&gt; LP00</td><td>é€ƒé€¸æ¨¡å¼è¯·æ±‚</td></tr>
<tr><td>LP11 -&gt; LP10 -&gt; LP00 -&gt; LP10 -&gt; LP00</td><td>ï¼ˆæ€»çº¿æ–¹å‘ï¼‰åè½¬è¯·æ±‚</td></tr>
</tbody></table>
</div>
<h5 id="æ€»çº¿æ–¹å‘åè½¬bus-turn-around"><a class="header" href="#æ€»çº¿æ–¹å‘åè½¬bus-turn-around">æ€»çº¿æ–¹å‘åè½¬ï¼ˆBus Turn Aroundï¼‰</a></h5>
<p><img src="ee/../images/mipi/mipi-dphy-bus-turn-around.jpg" alt="æ€»çº¿åè½¬æ­¥éª¤" /></p>
<p>å›¾ä¸­1å·åŒºåŸŸä»£è¡¨<strong>ä½åŠŸè€—è¯·æ±‚</strong>ï¼Œ3å·åŒºåŸŸä»£è¡¨<strong>åè½¬è¯·æ±‚</strong>ï¼Œ6å·åŒºåŸŸä»£è¡¨<strong>åè½¬åº”ç­”</strong></p>
<h5 id="é€ƒé€¸æ¨¡å¼"><a class="header" href="#é€ƒé€¸æ¨¡å¼">é€ƒé€¸æ¨¡å¼</a></h5>
<p>é€ƒé€¸æ¨¡å¼æ˜¯ä½åŠŸè€—æ¨¡å¼ä¸‹çš„ä¸€ç§ç‰¹æ®Šåœºæ™¯ï¼Œç”¨æ¥å®ç°ä¸€äº›ç‰¹å®šåŠŸèƒ½ã€‚è¿›å…¥é€ƒé€¸æ¨¡å¼åä¼ è¾“çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¢«ç§°ä¸º<strong>Entry Command</strong>æˆ–<strong>é€ƒé€¸å‘½ä»¤</strong>ï¼Œå®ƒç¡®å®šäº†è¿›å…¥é€ƒé€¸æ¨¡å¼åå®ç°ä»€ä¹ˆæ ·çš„åŠŸèƒ½ã€‚</p>
<div class="table-wrapper"><table><thead><tr><th>å­—èŠ‚å€¼</th><th>å‘½ä»¤åç§°</th><th>å«ä¹‰</th></tr></thead><tbody>
<tr><td>87h</td><td>ä½åŠŸè€—æ•°æ®ä¼ è¾“å‘½ä»¤</td><td>æ¨¡å¼å‘½ä»¤ï¼Œè¡¨ç¤ºåé¢éœ€è¦è¿›è¡Œä½åŠŸè€—æ•°æ®ä¼ è¾“</td></tr>
<tr><td>78h</td><td>è¶…ä½åŠŸè€—çŠ¶æ€å‘½ä»¤</td><td>æ¨¡å¼å‘½ä»¤ï¼Œè¡¨ç¤ºåé¢éœ€è¦è¿›è¡Œè¶…ä½åŠŸè€—çŠ¶æ€</td></tr>
<tr><td>46h</td><td>å¤ä½è§¦å‘ï¼ˆè¿œç«¯åº”ç”¨ï¼‰å‘½ä»¤</td><td>è§¦å‘ç±»å‹å‘½ä»¤</td></tr>
</tbody></table>
</div>
<p>ä½åŠŸè€—æ•°æ®ä¼ è¾“ç¤ºä¾‹ï¼š
<img src="ee/../images/mipi/mipi-dphy-lpdt.jpg" alt="ä½åŠŸè€—æ•°æ®ä¼ è¾“" /></p>
<p>ä½åŠŸè€—æ¨¡å¼ä¸‹çš„ä¼ è¾“é€Ÿç‡ä¸Šé™æ˜¯10Mbps,ä¸”åªèƒ½åœ¨æ•°æ®é€šé“0ä¸Šè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p>
<h5 id="é«˜é€Ÿæ¨¡å¼"><a class="header" href="#é«˜é€Ÿæ¨¡å¼">é«˜é€Ÿæ¨¡å¼</a></h5>
<p>é«˜é€Ÿæ¨¡å¼ä¼ è¾“æ•°æ®æ—¶ï¼Œæ—¶é’Ÿé€šé“å¿…é¡»è¦<strong>å…ˆ</strong>è¿›å…¥é«˜é€Ÿæ¨¡å¼ï¼Œåä¹‹ï¼Œé€€å‡ºé«˜é€Ÿæ¨¡å¼æ—¶ï¼Œæ—¶é’Ÿé€šé“è¦åœ¨æ•°æ®é€šé“é€€å‡ºé«˜é€Ÿæ¨¡å¼ä¹‹åä¸€å®šæ—¶é—´æ‰èƒ½é€€å‡ºé«˜é€Ÿæ¨¡å¼ã€‚</p>
<ul>
<li>
<p>æ—¶é’Ÿé€šé“è¿›å…¥é«˜é€Ÿæ¨¡å¼ï¼š
<img src="ee/../images/mipi/mipi-dphy-hs-enter-clock.jpg" alt="æ—¶é’Ÿé€šé“è¿›å…¥é«˜é€Ÿæ¨¡å¼" /></p>
<ul>
<li>å›¾ä¸­çš„1,2,3éƒ¨åˆ†æ˜¯é«˜é€Ÿæ¨¡å¼è¯·æ±‚åºåˆ—</li>
<li>ç¬¬4æ®µè¡¨ç¤ºï¼Œæ—¶é’Ÿè¿›å…¥é«˜é€Ÿæ¨¡å¼æ—¶ï¼Œå…ˆé©±åŠ¨ä¸€å®šæ—¶é—´çš„ä¿¡å·<code>0</code></li>
<li>ç¬¬5æ®µè¡¨ç¤ºæœ€åè¾“å‡ºçš„é«˜é€Ÿå·®åˆ†æ—¶é’Ÿä¿¡å·</li>
</ul>
</li>
<li>
<p>æ•°æ®é€šé“è¿›å…¥é«˜é€Ÿæ¨¡å¼ï¼š
<img src="ee/../images/mipi/mipi-dphy-hs-enter-data.jpg" alt="æ•°æ®é€šé“è¿›å…¥é«˜é€Ÿæ¨¡å¼" /></p>
<ul>
<li>ä¸æ—¶é’Ÿé€šé“è¿›å…¥é«˜é€Ÿæ¨¡å¼ä¸åŒï¼Œæ•°æ®é€šé“éœ€è¦é¢å¤–çš„<strong>é«˜é€ŸåŒæ­¥åºåˆ—</strong>ï¼Œå›¾ä¸­çš„ç¬¬2æ®µï¼Œè¯¥åŒæ­¥åºåˆ—ä¸ºä¸€ä¸ªå­—èŠ‚ï¼š0xB8</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="yosys-åŸºç¡€"><a class="header" href="#yosys-åŸºç¡€">Yosys åŸºç¡€</a></h1>
<blockquote>
<p>å»ºè®®ä½¿ç”¨ pip å®‰è£… WebAssembly æ‰“åŒ…åçš„ Yosys å¼€æºå·¥å…·é“¾ï¼š <a href="https://yowasp.org/">https://yowasp.org/</a></p>
</blockquote>
<h2 id="æµ‹è¯•ç”¨ä¾‹ä»£ç "><a class="header" href="#æµ‹è¯•ç”¨ä¾‹ä»£ç ">æµ‹è¯•ç”¨ä¾‹ä»£ç </a></h2>
<pre><code class="language-verilog">module alu(a, b, cin, sel, y);
  input [7:0] a, b;
  input cin;
  input [3:0] sel;
  output [7:0] y;

  reg [7:0] y;
  reg [7:0] arithval;
  reg [7:0] logicval;

  // ç®—æœ¯æ‰§è¡Œå•å…ƒ
  always @(a or b or cin or sel) begin
    case (sel[2:0])
      3'b000  : arithval = a;
      3'b001  : arithval = a + 1;
      3'b010  : arithval = a - 1;
      3'b011  : arithval = b;
      3'b100  : arithval = b + 1;
      3'b101  : arithval = b - 1;
      3'b110  : arithval = a + b;
      default : arithval = a + b + cin;
    endcase
  end

  // é€»è¾‘å¤„ç†å•å…ƒ
  always @(a or b or sel) begin
    case (sel[2:0])
      3'b000  : logicval =  ~a;
      3'b001  : logicval =  ~b;
      3'b010  : logicval = a &amp; b;
      3'b011  : logicval = a | b;
      3'b100  : logicval =  ~((a &amp; b));
      3'b101  : logicval =  ~((a | b));
      3'b110  : logicval = a ^ b;
      default : logicval =  ~(a ^ b);
    endcase
  end

  // è¾“å‡ºé€‰æ‹©å•å…ƒ
  always @(arithval or logicval or sel) begin
    case (sel[3])
      1'b0    : y = arithval;
      default : y = logicval;
    endcase
  end

endmodule
</code></pre>
<h2 id="ä½¿ç”¨-yosys-è¿›è¡Œç»¼åˆ"><a class="header" href="#ä½¿ç”¨-yosys-è¿›è¡Œç»¼åˆ">ä½¿ç”¨ Yosys è¿›è¡Œç»¼åˆ</a></h2>
<ol>
<li>å¯åŠ¨ Yosysï¼š<code>yosys</code></li>
<li>è¯»å– Verilog æ–‡ä»¶ï¼š <code>read_verilog alu.v</code></li>
<li>æ£€æŸ¥æ¨¡å—ä¾‹åŒ–ç»“æ„ï¼š <code>hierarchy -check</code></li>
<li>é€»è¾‘ç»¼åˆäºä¼˜åŒ–ï¼š<code>proc; opt; opt; fsm; memory; opt</code></li>
<li>ç”Ÿæˆç½‘è¡¨æ–‡ä»¶ï¼š<code>write_verilog alu_synth.v</code></li>
<li>è¾“å‡ºç»¼åˆåçš„é€»è¾‘å›¾ï¼š<code>show -format dot -prefix ./alu</code></li>
</ol>
<p><img src="ee/../images/yosys/alu.svg" alt="alu" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tauri-åŸºç¡€"><a class="header" href="#tauri-åŸºç¡€">Tauri åŸºç¡€</a></h1>
<h2 id="åˆ›å»ºé¡¹ç›®è„šæ‰‹æ¶"><a class="header" href="#åˆ›å»ºé¡¹ç›®è„šæ‰‹æ¶">åˆ›å»ºé¡¹ç›®è„šæ‰‹æ¶</a></h2>
<h3 id="ä½¿ç”¨-create-tauri-app"><a class="header" href="#ä½¿ç”¨-create-tauri-app">ä½¿ç”¨ <a href="https://github.com/tauri-apps/create-tauri-app">create-tauri-app</a></a></h3>
<pre><code class="language-bash">pnpm create tauri-app
</code></pre>
<h3 id="æ·»åŠ -tailwindcss"><a class="header" href="#æ·»åŠ -tailwindcss">æ·»åŠ  <a href="https://tailwindcss.com/docs/guides/sveltekit">tailwindcss</a></a></h3>
<pre><code class="language-bash">pnpm add -D tailwindcss postcss autoprefixer svelte-preprocess
pnpx tailwindcss init tailwind.config.cjs -p
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-åŸºç¡€"><a class="header" href="#git-åŸºç¡€">Git åŸºç¡€</a></h1>
<h2 id="æ¼”ç¤ºæ–‡ç¨¿"><a class="header" href="#æ¼”ç¤ºæ–‡ç¨¿">æ¼”ç¤ºæ–‡ç¨¿</a></h2>
<p><a href="https://suda-morris.github.io/git_workflow_lecture/">Git å·¥ä½œæµä»‹ç»</a></p>
<h2 id="è§†é¢‘æ¼”ç¤º"><a class="header" href="#è§†é¢‘æ¼”ç¤º">è§†é¢‘æ¼”ç¤º</a></h2>
<p><a href="https://www.bilibili.com/video/BV1zv411i7ce/">Git å·¥ä½œæµä»‹ç»</a></p>
<h2 id="gitconfig-æ–‡ä»¶æ¨¡æ¿"><a class="header" href="#gitconfig-æ–‡ä»¶æ¨¡æ¿">.gitconfig æ–‡ä»¶æ¨¡æ¿</a></h2>
<pre><code class="language-bash">[user]
    name = suda-morris
    email = 362953310@qq.com
[branch]
    autosetuprebase = always

[core]
    editor = vim
    quotepath = false
    autocrlf = false
    pager = less -+$LESS -FRX

[color]
    status = auto
    branch = auto
    diff = auto
    ui = true
    pager = true

[color "branch"]
    current = green reverse
    local = white
    remote = red

[color "diff"]
    meta = yellow bold
    frag = magenta bold
    old = red bold
    new = green bold

[color "status"]
    added = yellow
    changed = red
    untracked = cyan

[diff]
    tool = git_diff_wrapper

[difftool "git_diff_wrapper"]
    cmd = vimdiff -n   +2  $LOCAL $REMOTE

[pager]
    diff =

[difftool]
    prompt = no

[alias]
    glf  = log -n 10 --name-only --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"
    gl  = log -n 30 --date-order --format=\"%Cgreen%h %Cred[%ci] %Creset &lt;%an&gt;%C(yellow)%d%Creset %Creset %Cgreen%s %Creset \"
    gll  = log -n 30  --format=\"%Cgreen%H %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"
    gl3 = log -n 20  --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \" --graph
    gl2 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"
    glc = log --format=\"%Cgreen%h %Cred[%cd] %Creset&lt;committer:%cn&gt; : %Cred[%ad] %Creset&lt;author:%cn&gt; %Creset \"
    glc2 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;committer:%cn&gt; : %Cred[%ai] %Creset&lt;author:%cn&gt; %Creset \"
    glc3 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;committer:%cn&gt; : %Cred[%ai] %Creset&lt;author:%cn&gt; %n %Cgreen%s %Creset \"
    glt = log --format=\"%Cgreen%h :: %ad :: %aD :: %ar :: %at :: %ai %Creset \"
    glw = log  -n 20  --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %n%Cgreen%s%Creset%n%b  \"
    gldetail = log --format=\"%h `[%cd] `&lt;committer:%cn&gt; `[%ad] `&lt;author:%an&gt; ` %s \"
    hist = log --pretty=format:\"%C(yellow)%h %C(red)%d %C(reset)%s %C(green)[%an] %C(blue)%ad\" --topo-order --graph
    latest = for-each-ref --sort=-committerdate --format=\"%(committername)@%(refname:short) [%(committerdate:short)] %(contents)\"
    st = status -uno -s
    st2 = status -s
    co = checkout
    bl = blame --date=short
    ci = commit
    dt = difftool
    dif = diff --word-diff
    di = diff --no-ext-diff

[log]
    date = short

[commit]
    template = /home/morris/.gitmessage
</code></pre>
<h2 id="gitmessage-æ–‡ä»¶æ¨¡æ¿"><a class="header" href="#gitmessage-æ–‡ä»¶æ¨¡æ¿">.gitmessage æ–‡ä»¶æ¨¡æ¿</a></h2>
<pre><code>vfs/fatfs: fix stat call failing when called for mount point

FATFS does not support f_stat call for drive root. When handling stat
for drive root, don't call f_stat and just return struct st with S_IFDIR
flag set.

Closes https://github.com/espressif/esp-idf/issues/xxx
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç»ˆç«¯æ¼”ç¤ºå·¥å…·"><a class="header" href="#ç»ˆç«¯æ¼”ç¤ºå·¥å…·">ç»ˆç«¯æ¼”ç¤ºå·¥å…·</a></h1>
<h2 id="slides"><a class="header" href="#slides"><a href="https://github.com/maaslalani/slides">Slides</a></a></h2>
<h3 id="å®‰è£…ä¸ä½¿ç”¨"><a class="header" href="#å®‰è£…ä¸ä½¿ç”¨">å®‰è£…ä¸ä½¿ç”¨</a></h3>
<pre><code class="language-bash"># å®‰è£… slides è½¯ä»¶
yay -S slides
# ä½¿ç”¨ slides è½¯ä»¶
slides path/to/markdown/file.md
</code></pre>
<h3 id="æ¨¡æ¿"><a class="header" href="#æ¨¡æ¿">æ¨¡æ¿</a></h3>
<pre><code class="language-markdown">---
theme: https://github.com/maaslalani/slides/raw/main/styles/theme.json
---

# Welcome to Slides

A terminal based presentation tool

---

# Code blocks

Slides allows you to execute code blocks directly inside your slides!

Just press `ctrl+e` and the result of the code block will be displayed as virtual
text in your slides.

---

### Bash

```bash
ls
```

---

### Go

```go
package main

import "fmt"

func main() {
  fmt.Println("Hello, world!")
}
```

---

### Javascript

```javascript
console.log("Hello, world!")
```

---

### Python

```python
print("Hello, world!")
```

---

# h1
## h2
### h3
#### h4
##### h5
###### h6

---

# Markdown components

You can use everything in markdown!

* Like bulleted list
* You know the deal

1. Numbered lists too

* [x] ToDo

---

# Tables

| Tables | Too    |
| ------ | ------ |
| Even   | Tables |

---

# Graphs

```
digraph {
    rankdir = LR;
    a -&gt; b;
    b -&gt; c;
}
```
```
â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”
â”‚ a â”‚ â”€â”€â–¶ â”‚ b â”‚ â”€â”€â–¶ â”‚ c â”‚
â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜
```
---

~~~uname -a
This will be replaced by command `uname -a`
~~~

---

SEE YOU!

[Blog](https://suda-mottis.github.io/blog)

![ME](/home/morris/blog/docs/.vuepress/public/author.jpg)

</code></pre>
<h2 id="mdp"><a class="header" href="#mdp"><a href="https://github.com/visit1985/mdp">mdp</a></a></h2>
<h3 id="å®‰è£…ä¸ä½¿ç”¨-1"><a class="header" href="#å®‰è£…ä¸ä½¿ç”¨-1">å®‰è£…ä¸ä½¿ç”¨</a></h3>
<pre><code class="language-bash"># å®‰è£… mdp è½¯ä»¶
sudo pacman -S mdp
# ä½¿ç”¨ mdp è½¯ä»¶
mdp path/to/markdown/file.md
</code></pre>
<h3 id="æ¨¡æ¿-1"><a class="header" href="#æ¨¡æ¿-1">æ¨¡æ¿</a></h3>
<pre><code class="language-markdown">%title: Markdown Presentation æ¼”ç¤ºæ–‡ç¨¿ ğŸ¥³
%author: suda-morris
%date: 2019-11-11

-&gt; # ä¸€çº§æ ‡é¢˜ï¼Œå±…ä¸­ &lt;-

-&gt; ## äºŒçº§æ ‡é¢˜ï¼Œå±…ä¸­ &lt;-

-&gt; æ–‡æœ¬å†…å®¹ï¼Œå±…ä¸­ &lt;-

_åŸºæœ¬æ§åˆ¶:_

ä¸‹ä¸€é¡µ      *Enter*, *Space*, *Page Down*, *j*, *l*,
            *Down Arrow*, *Right Arrow*

å‰ä¸€é¡µ      *Backspace*, *Page Up*, *h*, *k*,
            *Up Arrow*, *Left Arrow*

é€€å‡º        *q*
é‡è½½        *r*
ç¬¬ N é¡µ     *1..9*
é¦–é¡µ        *Home*, *g*
æœ«é¡µ        *End*, *G*

-------------------------------------------------


-&gt; # ä»£ç å±•ç¤º &lt;-

è¡Œå†…ä»£ç  `main()`

ä»£ç å—

â€‹```
int main(int argc, char *argv[]) {
    printf("%s\n", "Hello world!");
}
â€‹```

-------------------------------------------------

-&gt; # å¼•ç”¨ &lt;-

&gt; å¼•ç”¨
&gt;&gt; åµŒå¥—å¼•ç”¨ 1
&gt;&gt;&gt; åµŒå¥—å¼•ç”¨ 2

-------------------------------------------------

-&gt; # ä¸‹åˆ’çº¿ä¸é«˜äº® &lt;-

_ä»…ä¸‹åˆ’çº¿_ *é«˜äº®* _*ä¸‹åˆ’çº¿ä¸”é«˜äº®*_

-------------------------------------------------

-&gt; # åˆ—è¡¨ &lt;-

list
* major
    - minor
        - *important*
          detail
    - minor

-------------------------------------------------

-&gt; # é€è¡Œæ˜¾ç¤º &lt;-

Agenda
^
* major
^
    * minor
^
* major
  ^
    * minor
      ^
        * detail

-------------------------------------------------

-&gt; # URL é“¾æ¥ &lt;-

[blog](https://suda-morris.github.io/blog)

-------------------------------------------------

-&gt; # UTF-8 ç‰¹æ®Šå­—ç¬¦ &lt;-

ae = Ã¤, oe = Ã¶, ue = Ã¼, ss = ÃŸ
upsilon = Æ±, phi = É¸

â–›â–€â–€â–€â–€â–€â–€â–€â–€â–€â–œ
â–Œrectangleâ–
â–™â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Ÿ


-------------------------------------------------

-&gt; # æ¼”ç¤ºçš„æš‚åœä¸æ¢å¤ &lt;-

æŒ‰ä¸‹ *Ctrl + z* å¯ä»¥æš‚åœå½“å‰æ¼”ç¤ºï¼Œå›åˆ°ç»ˆç«¯

åœ¨ç»ˆç«¯è¾“å…¥ *fg* å¯ä»¥æ¢å¤ä¹‹å‰çš„æ¼”ç¤º

-------------------------------------------------

-&gt; # å¯¼å‡ºåˆ° PDF æ–‡ä»¶ &lt;-

éœ€è¦å®‰è£…é¢å¤–çš„å·¥å…·ï¼š

\- *markdown* å°† Markdown æ–‡ä»¶å¯¼å‡ºä¸º HTML
\- *wkhtmltopdf* å°† HTML è½¬æ¢ä¸º PDF

`$ markdown sample.md | wkhtmltopdf - sample.pdf`
</code></pre>
<h2 id="slidev"><a class="header" href="#slidev"><a href="https://sli.dev">slidev</a></a></h2>
<ul>
<li>Demo: <a href="https://suda-morris.github.io/rmt-driver-lecture">https://suda-morris.github.io/rmt-driver-lecture</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
